<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§ª ì˜¨ë¼ì¸ ë°ì´í„° ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .test-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .test-section {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            background: #f8f9fa;
        }

        .test-section.success {
            border-color: #28a745;
            background: #d4edda;
        }

        .test-section.error {
            border-color: #dc3545;
            background: #f8d7da;
        }

        .test-section.warning {
            border-color: #ffc107;
            background: #fff3cd;
        }

        h1 { color: #2c3e50; text-align: center; }
        h2 { color: #34495e; margin-top: 0; }
        h3 { color: #5a6c7d; }

        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s;
        }

        .btn:hover { background: #0056b3; transform: translateY(-2px); }
        .btn.success { background: #28a745; }
        .btn.danger { background: #dc3545; }
        .btn.warning { background: #ffc107; color: black; }

        .result {
            background: #f1f3f4;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .result.success { border-left-color: #28a745; }
        .result.error { border-left-color: #dc3545; }

        .token-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
        }

        .progress {
            background: #e9ecef;
            border-radius: 10px;
            height: 20px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-bar {
            background: #007bff;
            height: 100%;
            transition: width 0.3s;
            text-align: center;
            color: white;
            line-height: 20px;
            font-size: 12px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online { background: #28a745; }
        .status-offline { background: #dc3545; }
        .status-testing { background: #ffc107; animation: pulse 1s infinite; }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .step-counter {
            background: #007bff;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ§ª ì˜¨ë¼ì¸ ë°ì´í„° ê´€ë¦¬ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</h1>
        <p style="text-align: center; color: #666; margin-bottom: 30px;">
            GitHub API ê¸°ë°˜ ë°ì´í„° ê´€ë¦¬ ì‹œìŠ¤í…œì˜ ì—°ê²° ìƒíƒœì™€ ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.
        </p>

        <!-- 1ë‹¨ê³„: GitHub Token ì„¤ì • -->
        <div class="test-section" id="tokenSection">
            <h2><span class="step-counter">1</span>GitHub Token ì„¤ì •</h2>
            <p>GitHub Personal Access Tokenì„ ì…ë ¥í•˜ì—¬ API ì—°ê²°ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.</p>

            <div style="margin: 15px 0;">
                <label for="githubToken"><strong>GitHub Personal Access Token:</strong></label>
                <input type="password" id="githubToken" class="token-input"
                       placeholder="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
                <small style="color: #666;">
                    <a href="https://github.com/settings/tokens" target="_blank">í† í° ìƒì„±í•˜ê¸°</a> |
                    Scope: repo (Full control of repositories)
                </small>
            </div>

            <button class="btn" onclick="testGitHubConnection()">ğŸ” GitHub ì—°ê²° í…ŒìŠ¤íŠ¸</button>
            <button class="btn warning" onclick="showTokenGuide()">ğŸ“– í† í° ìƒì„± ê°€ì´ë“œ</button>

            <div id="tokenResult" class="result" style="display: none;"></div>
        </div>

        <!-- 2ë‹¨ê³„: API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸ -->
        <div class="test-section" id="apiSection">
            <h2><span class="step-counter">2</span>API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸</h2>
            <p>ì˜¨ë¼ì¸ ë°ì´í„° ê´€ë¦¬ APIì˜ ê° ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.</p>

            <button class="btn" onclick="testDataManagerAPI()">ğŸ”§ GitHub ë°ì´í„° ê´€ë¦¬ API</button>
            <button class="btn" onclick="testCharacterAPI()">ğŸ‘¤ ìºë¦­í„° API</button>
            <button class="btn" onclick="testScenarioAPI()">ğŸ“– ì‹œë‚˜ë¦¬ì˜¤ API</button>

            <div id="apiResult" class="result" style="display: none;"></div>
        </div>

        <!-- 3ë‹¨ê³„: ì‹¤ì œ ë°ì´í„° CRUD í…ŒìŠ¤íŠ¸ -->
        <div class="test-section" id="crudSection">
            <h2><span class="step-counter">3</span>ë°ì´í„° CRUD í…ŒìŠ¤íŠ¸</h2>
            <p>ì‹¤ì œ ë°ì´í„° ìƒì„±, ì½ê¸°, ìˆ˜ì •, ì‚­ì œ ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.</p>

            <button class="btn success" onclick="testCreateCharacter()">â• í…ŒìŠ¤íŠ¸ ìºë¦­í„° ìƒì„±</button>
            <button class="btn" onclick="testLoadCharacters()">ğŸ“¥ ìºë¦­í„° ëª©ë¡ ë¡œë“œ</button>
            <button class="btn danger" onclick="testDeleteCharacter()">ğŸ—‘ï¸ í…ŒìŠ¤íŠ¸ ìºë¦­í„° ì‚­ì œ</button>

            <div id="crudResult" class="result" style="display: none;"></div>
        </div>

        <!-- 4ë‹¨ê³„: ì¢…í•© í…ŒìŠ¤íŠ¸ -->
        <div class="test-section" id="integrationSection">
            <h2><span class="step-counter">4</span>ì¢…í•© ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</h2>
            <p>ì „ì²´ ì‹œìŠ¤í…œì˜ í†µí•© ë™ì‘ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.</p>

            <button class="btn success" onclick="runFullTest()">ğŸš€ ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
            <button class="btn" onclick="openAdminPage()">ğŸ® ê´€ë¦¬ í˜ì´ì§€ ì—´ê¸°</button>

            <div class="progress" id="testProgress" style="display: none;">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>

            <div id="integrationResult" class="result" style="display: none;"></div>
        </div>

        <!-- ìƒíƒœ í‘œì‹œ -->
        <div class="test-section">
            <h3>ğŸ“Š ì‹œìŠ¤í…œ ìƒíƒœ</h3>
            <p>
                <span class="status-indicator status-offline" id="statusIndicator"></span>
                <span id="statusText">ì—°ê²° í…ŒìŠ¤íŠ¸ ëŒ€ê¸° ì¤‘...</span>
            </p>
        </div>
    </div>

    <script>
        let githubToken = '';
        let testResults = {};

        // GitHub ì—°ê²° í…ŒìŠ¤íŠ¸
        async function testGitHubConnection() {
            githubToken = document.getElementById('githubToken').value.trim();

            if (!githubToken) {
                showResult('tokenResult', 'âŒ GitHub Tokenì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            updateStatus('testing', 'GitHub ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...');
            showResult('tokenResult', 'ğŸ”„ GitHub API ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...', '');

            try {
                const response = await fetch('/api/test-github-connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-github-token': githubToken
                    }
                });

                const result = await response.json();

                if (result.success) {
                    updateStatus('online', 'GitHub ì—°ê²° ì„±ê³µ');
                    document.getElementById('tokenSection').className = 'test-section success';

                    const message = `âœ… GitHub ì—°ê²° ì„±ê³µ!

ğŸ‘¤ ì‚¬ìš©ì: ${result.user.name} (@${result.user.login})
ğŸ“ ì €ì¥ì†Œ: ${result.repository.full_name}
ğŸ”’ Private: ${result.repository.private ? 'Yes' : 'No'}
ğŸ“Š API ì œí•œ: ${result.rateLimit.remaining}/${result.rateLimit.total}

ë‹¤ìŒ ë‹¨ê³„:
${result.nextSteps.join('\n')}`;

                    showResult('tokenResult', message, 'success');
                    testResults.github = true;
                } else {
                    updateStatus('offline', 'GitHub ì—°ê²° ì‹¤íŒ¨');
                    document.getElementById('tokenSection').className = 'test-section error';

                    const message = `âŒ GitHub ì—°ê²° ì‹¤íŒ¨

ì˜¤ë¥˜: ${result.error}
${result.details ? 'ìƒì„¸: ' + result.details : ''}

í•´ê²° ë°©ë²•:
${result.suggestions ? result.suggestions.join('\n') : 'í† í°ê³¼ ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”'}`;

                    showResult('tokenResult', message, 'error');
                    testResults.github = false;
                }
            } catch (error) {
                updateStatus('offline', 'GitHub ì—°ê²° ì˜¤ë¥˜');
                showResult('tokenResult', `âŒ ì—°ê²° ì˜¤ë¥˜: ${error.message}`, 'error');
                testResults.github = false;
            }
        }

        // API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
        async function testDataManagerAPI() {
            if (!githubToken) {
                showResult('apiResult', 'âŒ ë¨¼ì € GitHub Tokenì„ ì„¤ì •í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            showResult('apiResult', 'ğŸ”„ GitHub ë°ì´í„° ê´€ë¦¬ API í…ŒìŠ¤íŠ¸ ì¤‘...', '');

            try {
                // ìºë¦­í„° ëª©ë¡ ë¡œë“œ í…ŒìŠ¤íŠ¸
                const response = await fetch('/api/github-data-manager?action=load&type=characters', {
                    headers: {
                        'x-github-token': githubToken
                    }
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('apiSection').className = 'test-section success';
                    const message = `âœ… GitHub ë°ì´í„° ê´€ë¦¬ API ì •ìƒ ì‘ë™

ğŸ“Š ë¡œë“œëœ ìºë¦­í„°: ${result.count}ê°œ
ğŸ“ ë°ì´í„° ì†ŒìŠ¤: ${result.source}

API ìƒíƒœ: ì •ìƒ`;

                    showResult('apiResult', message, 'success');
                    testResults.api = true;
                } else {
                    document.getElementById('apiSection').className = 'test-section error';
                    showResult('apiResult', `âŒ API ì˜¤ë¥˜: ${result.error}`, 'error');
                    testResults.api = false;
                }
            } catch (error) {
                document.getElementById('apiSection').className = 'test-section error';
                showResult('apiResult', `âŒ API ì—°ê²° ì‹¤íŒ¨: ${error.message}`, 'error');
                testResults.api = false;
            }
        }

        // í…ŒìŠ¤íŠ¸ ìºë¦­í„° ìƒì„±
        async function testCreateCharacter() {
            if (!githubToken) {
                showResult('crudResult', 'âŒ ë¨¼ì € GitHub Tokenì„ ì„¤ì •í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            showResult('crudResult', 'ğŸ”„ í…ŒìŠ¤íŠ¸ ìºë¦­í„° ìƒì„± ì¤‘...', '');

            const testCharacter = {
                id: `test_char_${Date.now()}`,
                name: 'í…ŒìŠ¤íŠ¸ ìºë¦­í„°',
                age: '22',
                gender: 'female',
                mbti: 'INFP',
                personality_traits: ['ì¹œì ˆí•œ', 'ì°½ì˜ì ', 'ê°ì„±ì '],
                major: 'art',
                relationship: 'friend',
                speech_style: 'ë¶€ë“œëŸ½ê³  ë”°ëœ»í•œ ë§íˆ¬',
                speech_habit: 'ìì£¼ ë¯¸ì†Œë¥¼ ì§€ìœ¼ë©° ë§í•˜ê¸°',
                created_at: new Date().toISOString(),
                test_data: true
            };

            try {
                const response = await fetch('/api/github-data-manager?action=save&type=characters', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-github-token': githubToken
                    },
                    body: JSON.stringify(testCharacter)
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('crudSection').className = 'test-section success';
                    const message = `âœ… í…ŒìŠ¤íŠ¸ ìºë¦­í„° ìƒì„± ì„±ê³µ!

ğŸ‘¤ ìºë¦­í„° ID: ${result.id}
ğŸ“ ì´ë¦„: ${result.data.name}
ğŸ­ MBTI: ${result.data.mbti}
ğŸ“ ì €ì¥ ìœ„ì¹˜: GitHub (${result.source})

GitHubì—ì„œ í™•ì¸:
https://github.com/EnmanyProject/chatgame/blob/main/data/characters.json`;

                    showResult('crudResult', message, 'success');
                    testResults.crud = true;
                } else {
                    document.getElementById('crudSection').className = 'test-section error';
                    showResult('crudResult', `âŒ ìºë¦­í„° ìƒì„± ì‹¤íŒ¨: ${result.error}`, 'error');
                    testResults.crud = false;
                }
            } catch (error) {
                document.getElementById('crudSection').className = 'test-section error';
                showResult('crudResult', `âŒ ìºë¦­í„° ìƒì„± ì˜¤ë¥˜: ${error.message}`, 'error');
                testResults.crud = false;
            }
        }

        // ìºë¦­í„° ëª©ë¡ ë¡œë“œ
        async function testLoadCharacters() {
            if (!githubToken) {
                showResult('crudResult', 'âŒ ë¨¼ì € GitHub Tokenì„ ì„¤ì •í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            showResult('crudResult', 'ğŸ”„ ìºë¦­í„° ëª©ë¡ ë¡œë“œ ì¤‘...', '');

            try {
                const response = await fetch('/api/github-data-manager?action=load&type=characters', {
                    headers: {
                        'x-github-token': githubToken
                    }
                });

                const result = await response.json();

                if (result.success) {
                    const characters = result.data;
                    const characterList = Object.values(characters).map(char =>
                        `- ${char.name} (${char.mbti}) ${char.test_data ? '[í…ŒìŠ¤íŠ¸]' : ''}`
                    ).join('\n');

                    const message = `âœ… ìºë¦­í„° ëª©ë¡ ë¡œë“œ ì„±ê³µ!

ğŸ“Š ì´ ìºë¦­í„° ìˆ˜: ${result.count}ê°œ
ğŸ“ ë°ì´í„° ì†ŒìŠ¤: ${result.source}

ìºë¦­í„° ëª©ë¡:
${characterList || '(ìºë¦­í„° ì—†ìŒ)'}`;

                    showResult('crudResult', message, 'success');
                } else {
                    showResult('crudResult', `âŒ ìºë¦­í„° ë¡œë“œ ì‹¤íŒ¨: ${result.error}`, 'error');
                }
            } catch (error) {
                showResult('crudResult', `âŒ ìºë¦­í„° ë¡œë“œ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        async function runFullTest() {
            document.getElementById('testProgress').style.display = 'block';
            updateProgress(0, 'í…ŒìŠ¤íŠ¸ ì‹œì‘...');

            let results = [];

            // 1. GitHub ì—°ê²° í…ŒìŠ¤íŠ¸
            updateProgress(25, 'GitHub ì—°ê²° í…ŒìŠ¤íŠ¸...');
            await testGitHubConnection();
            results.push(`GitHub ì—°ê²°: ${testResults.github ? 'âœ…' : 'âŒ'}`);

            // 2. API í…ŒìŠ¤íŠ¸
            updateProgress(50, 'API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸...');
            await testDataManagerAPI();
            results.push(`API ì—°ê²°: ${testResults.api ? 'âœ…' : 'âŒ'}`);

            // 3. CRUD í…ŒìŠ¤íŠ¸
            updateProgress(75, 'CRUD ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸...');
            await testCreateCharacter();
            results.push(`CRUD ê¸°ëŠ¥: ${testResults.crud ? 'âœ…' : 'âŒ'}`);

            // 4. ê²°ê³¼ ì •ë¦¬
            updateProgress(100, 'í…ŒìŠ¤íŠ¸ ì™„ë£Œ');

            const allPassed = Object.values(testResults).every(result => result === true);
            const status = allPassed ? 'ğŸ‰ ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼!' : 'âš ï¸ ì¼ë¶€ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨';

            const message = `${status}

í…ŒìŠ¤íŠ¸ ê²°ê³¼:
${results.join('\n')}

${allPassed ?
'âœ… ì˜¨ë¼ì¸ ë°ì´í„° ê´€ë¦¬ ì‹œìŠ¤í…œì´ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤!' :
'âŒ ì¼ë¶€ ê¸°ëŠ¥ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ìœ„ ê°œë³„ í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.'}

ë‹¤ìŒ ë‹¨ê³„:
${allPassed ?
'1. ê´€ë¦¬ í˜ì´ì§€ì—ì„œ ì‹¤ì œ ë°ì´í„° ìƒì„± í…ŒìŠ¤íŠ¸\n2. ë‹¤ë¥¸ ì»´í“¨í„°ì—ì„œ ì ‘ê·¼ í…ŒìŠ¤íŠ¸\n3. í˜‘ì—… ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸' :
'1. ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ í•­ëª© ë¬¸ì œ í•´ê²°\n2. GitHub Tokenê³¼ ê¶Œí•œ ì¬í™•ì¸\n3. Vercel í™˜ê²½ë³€ìˆ˜ ì„¤ì • í™•ì¸'}`;

            showResult('integrationResult', message, allPassed ? 'success' : 'error');
            document.getElementById('integrationSection').className = allPassed ? 'test-section success' : 'test-section error';
        }

        // ê´€ë¦¬ í˜ì´ì§€ ì—´ê¸°
        function openAdminPage() {
            window.open('/scenario-admin.html', '_blank');
        }

        // í† í° ìƒì„± ê°€ì´ë“œ
        function showTokenGuide() {
            const guide = `ğŸ” GitHub Personal Access Token ìƒì„± ê°€ì´ë“œ

1ï¸âƒ£ GitHub ë¡œê·¸ì¸ í›„ ë‹¤ìŒ ë§í¬ ì ‘ì†:
   https://github.com/settings/tokens

2ï¸âƒ£ "Generate new token (classic)" í´ë¦­

3ï¸âƒ£ í† í° ì„¤ì •:
   - Note: ChatGame Admin
   - Expiration: No expiration (ë˜ëŠ” ì›í•˜ëŠ” ê¸°ê°„)
   - Scopes: âœ… repo (Full control of repositories)

4ï¸âƒ£ "Generate token" í´ë¦­

5ï¸âƒ£ ìƒì„±ëœ í† í° ë³µì‚¬ (âš ï¸ í•œ ë²ˆë§Œ í‘œì‹œë¨!)

6ï¸âƒ£ ìœ„ ì…ë ¥ì°½ì— ë¶™ì—¬ë„£ê¸° í›„ í…ŒìŠ¤íŠ¸`;

            showResult('tokenResult', guide, '');
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function updateStatus(status, text) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');

            indicator.className = `status-indicator status-${status}`;
            statusText.textContent = text;
        }

        function updateProgress(percent, text) {
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percent + '%';
            progressBar.textContent = text;
        }

        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.textContent = message;
            element.className = `result ${type}`;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('offline', 'ì—°ê²° í…ŒìŠ¤íŠ¸ ëŒ€ê¸° ì¤‘...');
        });
    </script>
</body>
</html>