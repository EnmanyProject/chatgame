<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🧪 온라인 데이터 시스템 테스트</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .test-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .test-section {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            background: #f8f9fa;
        }

        .test-section.success {
            border-color: #28a745;
            background: #d4edda;
        }

        .test-section.error {
            border-color: #dc3545;
            background: #f8d7da;
        }

        .test-section.warning {
            border-color: #ffc107;
            background: #fff3cd;
        }

        h1 { color: #2c3e50; text-align: center; }
        h2 { color: #34495e; margin-top: 0; }
        h3 { color: #5a6c7d; }

        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s;
        }

        .btn:hover { background: #0056b3; transform: translateY(-2px); }
        .btn.success { background: #28a745; }
        .btn.danger { background: #dc3545; }
        .btn.warning { background: #ffc107; color: black; }

        .result {
            background: #f1f3f4;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .result.success { border-left-color: #28a745; }
        .result.error { border-left-color: #dc3545; }

        .token-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
        }

        .progress {
            background: #e9ecef;
            border-radius: 10px;
            height: 20px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-bar {
            background: #007bff;
            height: 100%;
            transition: width 0.3s;
            text-align: center;
            color: white;
            line-height: 20px;
            font-size: 12px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online { background: #28a745; }
        .status-offline { background: #dc3545; }
        .status-testing { background: #ffc107; animation: pulse 1s infinite; }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .step-counter {
            background: #007bff;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🧪 온라인 데이터 관리 시스템 테스트</h1>
        <p style="text-align: center; color: #666; margin-bottom: 30px;">
            GitHub API 기반 데이터 관리 시스템의 연결 상태와 기능을 테스트합니다.
        </p>

        <!-- 1단계: GitHub Token 설정 -->
        <div class="test-section" id="tokenSection">
            <h2><span class="step-counter">1</span>GitHub Token 설정</h2>
            <p>GitHub Personal Access Token을 입력하여 API 연결을 테스트합니다.</p>

            <div style="margin: 15px 0;">
                <label for="githubToken"><strong>GitHub Personal Access Token:</strong></label>
                <input type="password" id="githubToken" class="token-input"
                       placeholder="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
                <small style="color: #666;">
                    <a href="https://github.com/settings/tokens" target="_blank">토큰 생성하기</a> |
                    Scope: repo (Full control of repositories)
                </small>
            </div>

            <button class="btn" onclick="testGitHubConnection()">🔐 GitHub 연결 테스트</button>
            <button class="btn warning" onclick="showTokenGuide()">📖 토큰 생성 가이드</button>

            <div id="tokenResult" class="result" style="display: none;"></div>
        </div>

        <!-- 2단계: API 엔드포인트 테스트 -->
        <div class="test-section" id="apiSection">
            <h2><span class="step-counter">2</span>API 엔드포인트 테스트</h2>
            <p>온라인 데이터 관리 API의 각 기능을 테스트합니다.</p>

            <button class="btn" onclick="testDataManagerAPI()">🔧 GitHub 데이터 관리 API</button>
            <button class="btn" onclick="testCharacterAPI()">👤 캐릭터 API</button>
            <button class="btn" onclick="testScenarioAPI()">📖 시나리오 API</button>

            <div id="apiResult" class="result" style="display: none;"></div>
        </div>

        <!-- 3단계: 실제 데이터 CRUD 테스트 -->
        <div class="test-section" id="crudSection">
            <h2><span class="step-counter">3</span>데이터 CRUD 테스트</h2>
            <p>실제 데이터 생성, 읽기, 수정, 삭제 기능을 테스트합니다.</p>

            <button class="btn success" onclick="testCreateCharacter()">➕ 테스트 캐릭터 생성</button>
            <button class="btn" onclick="testLoadCharacters()">📥 캐릭터 목록 로드</button>
            <button class="btn danger" onclick="testDeleteCharacter()">🗑️ 테스트 캐릭터 삭제</button>

            <div id="crudResult" class="result" style="display: none;"></div>
        </div>

        <!-- 4단계: 종합 테스트 -->
        <div class="test-section" id="integrationSection">
            <h2><span class="step-counter">4</span>종합 시스템 테스트</h2>
            <p>전체 시스템의 통합 동작을 테스트합니다.</p>

            <button class="btn success" onclick="runFullTest()">🚀 전체 테스트 실행</button>
            <button class="btn" onclick="openAdminPage()">🎮 관리 페이지 열기</button>

            <div class="progress" id="testProgress" style="display: none;">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>

            <div id="integrationResult" class="result" style="display: none;"></div>
        </div>

        <!-- 상태 표시 -->
        <div class="test-section">
            <h3>📊 시스템 상태</h3>
            <p>
                <span class="status-indicator status-offline" id="statusIndicator"></span>
                <span id="statusText">연결 테스트 대기 중...</span>
            </p>
        </div>
    </div>

    <script>
        let githubToken = '';
        let testResults = {};

        // GitHub 연결 테스트
        async function testGitHubConnection() {
            githubToken = document.getElementById('githubToken').value.trim();

            if (!githubToken) {
                showResult('tokenResult', '❌ GitHub Token을 입력해주세요.', 'error');
                return;
            }

            updateStatus('testing', 'GitHub 연결 테스트 중...');
            showResult('tokenResult', '🔄 GitHub API 연결 테스트 중...', '');

            try {
                const response = await fetch('/api/test-github-connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-github-token': githubToken
                    }
                });

                const result = await response.json();

                if (result.success) {
                    updateStatus('online', 'GitHub 연결 성공');
                    document.getElementById('tokenSection').className = 'test-section success';

                    const message = `✅ GitHub 연결 성공!

👤 사용자: ${result.user.name} (@${result.user.login})
📁 저장소: ${result.repository.full_name}
🔒 Private: ${result.repository.private ? 'Yes' : 'No'}
📊 API 제한: ${result.rateLimit.remaining}/${result.rateLimit.total}

다음 단계:
${result.nextSteps.join('\n')}`;

                    showResult('tokenResult', message, 'success');
                    testResults.github = true;
                } else {
                    updateStatus('offline', 'GitHub 연결 실패');
                    document.getElementById('tokenSection').className = 'test-section error';

                    const message = `❌ GitHub 연결 실패

오류: ${result.error}
${result.details ? '상세: ' + result.details : ''}

해결 방법:
${result.suggestions ? result.suggestions.join('\n') : '토큰과 권한을 확인하세요'}`;

                    showResult('tokenResult', message, 'error');
                    testResults.github = false;
                }
            } catch (error) {
                updateStatus('offline', 'GitHub 연결 오류');
                showResult('tokenResult', `❌ 연결 오류: ${error.message}`, 'error');
                testResults.github = false;
            }
        }

        // API 엔드포인트 테스트
        async function testDataManagerAPI() {
            if (!githubToken) {
                showResult('apiResult', '❌ 먼저 GitHub Token을 설정해주세요.', 'error');
                return;
            }

            showResult('apiResult', '🔄 GitHub 데이터 관리 API 테스트 중...', '');

            try {
                // 캐릭터 목록 로드 테스트
                const response = await fetch('/api/github-data-manager?action=load&type=characters', {
                    headers: {
                        'x-github-token': githubToken
                    }
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('apiSection').className = 'test-section success';
                    const message = `✅ GitHub 데이터 관리 API 정상 작동

📊 로드된 캐릭터: ${result.count}개
📍 데이터 소스: ${result.source}

API 상태: 정상`;

                    showResult('apiResult', message, 'success');
                    testResults.api = true;
                } else {
                    document.getElementById('apiSection').className = 'test-section error';
                    showResult('apiResult', `❌ API 오류: ${result.error}`, 'error');
                    testResults.api = false;
                }
            } catch (error) {
                document.getElementById('apiSection').className = 'test-section error';
                showResult('apiResult', `❌ API 연결 실패: ${error.message}`, 'error');
                testResults.api = false;
            }
        }

        // 테스트 캐릭터 생성
        async function testCreateCharacter() {
            if (!githubToken) {
                showResult('crudResult', '❌ 먼저 GitHub Token을 설정해주세요.', 'error');
                return;
            }

            showResult('crudResult', '🔄 테스트 캐릭터 생성 중...', '');

            const testCharacter = {
                id: `test_char_${Date.now()}`,
                name: '테스트 캐릭터',
                age: '22',
                gender: 'female',
                mbti: 'INFP',
                personality_traits: ['친절한', '창의적', '감성적'],
                major: 'art',
                relationship: 'friend',
                speech_style: '부드럽고 따뜻한 말투',
                speech_habit: '자주 미소를 지으며 말하기',
                created_at: new Date().toISOString(),
                test_data: true
            };

            try {
                const response = await fetch('/api/github-data-manager?action=save&type=characters', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-github-token': githubToken
                    },
                    body: JSON.stringify(testCharacter)
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('crudSection').className = 'test-section success';
                    const message = `✅ 테스트 캐릭터 생성 성공!

👤 캐릭터 ID: ${result.id}
📝 이름: ${result.data.name}
🎭 MBTI: ${result.data.mbti}
📍 저장 위치: GitHub (${result.source})

GitHub에서 확인:
https://github.com/EnmanyProject/chatgame/blob/main/data/characters.json`;

                    showResult('crudResult', message, 'success');
                    testResults.crud = true;
                } else {
                    document.getElementById('crudSection').className = 'test-section error';
                    showResult('crudResult', `❌ 캐릭터 생성 실패: ${result.error}`, 'error');
                    testResults.crud = false;
                }
            } catch (error) {
                document.getElementById('crudSection').className = 'test-section error';
                showResult('crudResult', `❌ 캐릭터 생성 오류: ${error.message}`, 'error');
                testResults.crud = false;
            }
        }

        // 캐릭터 목록 로드
        async function testLoadCharacters() {
            if (!githubToken) {
                showResult('crudResult', '❌ 먼저 GitHub Token을 설정해주세요.', 'error');
                return;
            }

            showResult('crudResult', '🔄 캐릭터 목록 로드 중...', '');

            try {
                const response = await fetch('/api/github-data-manager?action=load&type=characters', {
                    headers: {
                        'x-github-token': githubToken
                    }
                });

                const result = await response.json();

                if (result.success) {
                    const characters = result.data;
                    const characterList = Object.values(characters).map(char =>
                        `- ${char.name} (${char.mbti}) ${char.test_data ? '[테스트]' : ''}`
                    ).join('\n');

                    const message = `✅ 캐릭터 목록 로드 성공!

📊 총 캐릭터 수: ${result.count}개
📍 데이터 소스: ${result.source}

캐릭터 목록:
${characterList || '(캐릭터 없음)'}`;

                    showResult('crudResult', message, 'success');
                } else {
                    showResult('crudResult', `❌ 캐릭터 로드 실패: ${result.error}`, 'error');
                }
            } catch (error) {
                showResult('crudResult', `❌ 캐릭터 로드 오류: ${error.message}`, 'error');
            }
        }

        // 전체 테스트 실행
        async function runFullTest() {
            document.getElementById('testProgress').style.display = 'block';
            updateProgress(0, '테스트 시작...');

            let results = [];

            // 1. GitHub 연결 테스트
            updateProgress(25, 'GitHub 연결 테스트...');
            await testGitHubConnection();
            results.push(`GitHub 연결: ${testResults.github ? '✅' : '❌'}`);

            // 2. API 테스트
            updateProgress(50, 'API 엔드포인트 테스트...');
            await testDataManagerAPI();
            results.push(`API 연결: ${testResults.api ? '✅' : '❌'}`);

            // 3. CRUD 테스트
            updateProgress(75, 'CRUD 기능 테스트...');
            await testCreateCharacter();
            results.push(`CRUD 기능: ${testResults.crud ? '✅' : '❌'}`);

            // 4. 결과 정리
            updateProgress(100, '테스트 완료');

            const allPassed = Object.values(testResults).every(result => result === true);
            const status = allPassed ? '🎉 모든 테스트 통과!' : '⚠️ 일부 테스트 실패';

            const message = `${status}

테스트 결과:
${results.join('\n')}

${allPassed ?
'✅ 온라인 데이터 관리 시스템이 정상 작동합니다!' :
'❌ 일부 기능에 문제가 있습니다. 위 개별 테스트 결과를 확인하세요.'}

다음 단계:
${allPassed ?
'1. 관리 페이지에서 실제 데이터 생성 테스트\n2. 다른 컴퓨터에서 접근 테스트\n3. 협업 기능 테스트' :
'1. 실패한 테스트 항목 문제 해결\n2. GitHub Token과 권한 재확인\n3. Vercel 환경변수 설정 확인'}`;

            showResult('integrationResult', message, allPassed ? 'success' : 'error');
            document.getElementById('integrationSection').className = allPassed ? 'test-section success' : 'test-section error';
        }

        // 관리 페이지 열기
        function openAdminPage() {
            window.open('/scenario-admin.html', '_blank');
        }

        // 토큰 생성 가이드
        function showTokenGuide() {
            const guide = `🔐 GitHub Personal Access Token 생성 가이드

1️⃣ GitHub 로그인 후 다음 링크 접속:
   https://github.com/settings/tokens

2️⃣ "Generate new token (classic)" 클릭

3️⃣ 토큰 설정:
   - Note: ChatGame Admin
   - Expiration: No expiration (또는 원하는 기간)
   - Scopes: ✅ repo (Full control of repositories)

4️⃣ "Generate token" 클릭

5️⃣ 생성된 토큰 복사 (⚠️ 한 번만 표시됨!)

6️⃣ 위 입력창에 붙여넣기 후 테스트`;

            showResult('tokenResult', guide, '');
        }

        // 유틸리티 함수들
        function updateStatus(status, text) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');

            indicator.className = `status-indicator status-${status}`;
            statusText.textContent = text;
        }

        function updateProgress(percent, text) {
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percent + '%';
            progressBar.textContent = text;
        }

        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.textContent = message;
            element.className = `result ${type}`;
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('offline', '연결 테스트 대기 중...');
        });
    </script>
</body>
</html>