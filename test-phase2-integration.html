<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 2 í†µí•© í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        h1 { color: #333; }
        h2 {
            color: #666;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .status {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .status.success {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .status.error {
            background: #ffebee;
            color: #c62828;
        }
        .status.warning {
            background: #fff3e0;
            color: #e65100;
        }
        .icon {
            font-size: 20px;
            margin-right: 10px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            background: #f9f9f9;
            border-left: 4px solid #2196F3;
        }
        .code {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-family: 'Consolas', monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª Phase 2 í†µí•© í…ŒìŠ¤íŠ¸</h1>

    <div class="container">
        <h2>ğŸ“‹ ì‹œìŠ¤í…œ ë¡œë”© ìƒíƒœ</h2>
        <div id="loading-status"></div>
        <button onclick="checkSystemLoading()">ì‹œìŠ¤í…œ ë¡œë”© ì²´í¬</button>
    </div>

    <div class="container">
        <h2>ğŸ¨ Phase 2-A: í†¤ ë³€í™” ì‹œìŠ¤í…œ</h2>
        <div id="tone-status"></div>
        <button onclick="testToneSystem()">í†¤ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</button>
    </div>

    <div class="container">
        <h2>ğŸ“¸ Phase 2-B: ì‚¬ì§„ ì „ì†¡ ì‹œìŠ¤í…œ</h2>
        <div id="photo-status"></div>
        <button onclick="testPhotoSystem()">ì‚¬ì§„ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</button>
    </div>

    <div class="container">
        <h2>ğŸ’¬ Phase 2-C: ë¨¼ì € ì—°ë½ ì‹œìŠ¤í…œ</h2>
        <div id="proactive-status"></div>
        <button onclick="testProactiveSystem()">ë¨¼ì € ì—°ë½ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</button>
    </div>

    <div class="container">
        <h2>ğŸ”„ íŠ¸ë¦¬ê±° ì—”ì§„ í†µí•©</h2>
        <div id="trigger-status"></div>
        <button onclick="testTriggerEngine()">íŠ¸ë¦¬ê±° ì—”ì§„ í…ŒìŠ¤íŠ¸</button>
    </div>

    <div class="container">
        <h2>ğŸ“Š ì „ì²´ ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸</h2>
        <div id="workflow-status"></div>
        <button onclick="testFullWorkflow()">ì „ì²´ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰</button>
    </div>

    <!-- ì‹œìŠ¤í…œ ë¡œë“œ -->
    <script src="/js/multi-character-state.js"></script>
    <script src="/js/tone-variation-engine.js"></script>
    <script src="/js/photo-sending-system.js"></script>
    <script src="/js/proactive-contact-system.js"></script>
    <script src="/js/episode-trigger-engine.js"></script>

    <script>
        // í…ŒìŠ¤íŠ¸ ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
        function showStatus(elementId, success, message) {
            const statusClass = success ? 'success' : 'error';
            const icon = success ? 'âœ…' : 'âŒ';
            document.getElementById(elementId).innerHTML = `
                <div class="status ${statusClass}">
                    <span class="icon">${icon}</span>
                    <span>${message}</span>
                </div>
            `;
        }

        // ì‹œìŠ¤í…œ ë¡œë”© ì²´í¬
        function checkSystemLoading() {
            const systems = {
                'MultiCharacterState': typeof MultiCharacterState !== 'undefined',
                'ToneVariationEngine': typeof ToneVariationEngine !== 'undefined',
                'PhotoSendingSystem': typeof PhotoSendingSystem !== 'undefined',
                'ProactiveContactSystem': typeof ProactiveContactSystem !== 'undefined',
                'EpisodeTriggerEngine': typeof EpisodeTriggerEngine !== 'undefined'
            };

            let html = '';
            let allLoaded = true;

            for (const [name, loaded] of Object.entries(systems)) {
                const status = loaded ? 'success' : 'error';
                const icon = loaded ? 'âœ…' : 'âŒ';
                html += `<div class="status ${status}"><span class="icon">${icon}</span><span>${name}</span></div>`;
                if (!loaded) allLoaded = false;
            }

            document.getElementById('loading-status').innerHTML = html;

            if (allLoaded) {
                console.log('âœ… ëª¨ë“  ì‹œìŠ¤í…œ ë¡œë“œ ì™„ë£Œ');
            } else {
                console.error('âŒ ì¼ë¶€ ì‹œìŠ¤í…œ ë¡œë“œ ì‹¤íŒ¨');
            }
        }

        // í†¤ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸
        function testToneSystem() {
            try {
                const toneEngine = new ToneVariationEngine('test_character');

                const tests = [];

                // í˜¸ê°ë„ë³„ í†¤ ë ˆë²¨ í…ŒìŠ¤íŠ¸
                for (let affection = 1; affection <= 10; affection++) {
                    const level = toneEngine.calculateToneLevel(affection);
                    tests.push({
                        affection,
                        level,
                        expected: affection <= 2 ? 1 : affection <= 4 ? 2 : affection <= 6 ? 3 : affection <= 8 ? 4 : 5
                    });
                }

                const allPassed = tests.every(t => t.level === t.expected);

                let html = `<div class="test-result">
                    <strong>í˜¸ê°ë„ë³„ í†¤ ë ˆë²¨ ë§¤í•‘:</strong>
                    <div class="code">`;

                tests.forEach(t => {
                    const status = t.level === t.expected ? 'âœ…' : 'âŒ';
                    html += `${status} í˜¸ê°ë„ ${t.affection} â†’ ë ˆë²¨ ${t.level} (ì˜ˆìƒ: ${t.expected})\n`;
                });

                html += `</div></div>`;

                document.getElementById('tone-status').innerHTML = html;
                showStatus('tone-status', allPassed, allPassed ? 'í†¤ ì‹œìŠ¤í…œ ì •ìƒ ì‘ë™' : 'í†¤ ì‹œìŠ¤í…œ ì˜¤ë¥˜');

            } catch (error) {
                showStatus('tone-status', false, `ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // ì‚¬ì§„ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸
        async function testPhotoSystem() {
            try {
                const photoSystem = new PhotoSendingSystem();

                // ì´ˆê¸°í™” ëŒ€ê¸°
                await new Promise(resolve => setTimeout(resolve, 1000));

                const results = {
                    dbLoaded: photoSystem.photoDB !== null,
                    hasPhotos: photoSystem.photoDB && Object.keys(photoSystem.photoDB.photos || {}).length > 0
                };

                let html = `<div class="test-result">
                    <strong>ì‚¬ì§„ ì‹œìŠ¤í…œ ìƒíƒœ:</strong>
                    <div class="code">`;

                html += `${results.dbLoaded ? 'âœ…' : 'âŒ'} ì‚¬ì§„ DB ë¡œë“œ: ${results.dbLoaded}\n`;
                html += `${results.hasPhotos ? 'âœ…' : 'âŒ'} ì‚¬ì§„ ë°ì´í„° ì¡´ì¬: ${results.hasPhotos}\n`;

                if (results.hasPhotos) {
                    const photoCount = photoSystem.photoDB.metadata?.total_photos || 0;
                    const charCount = Object.keys(photoSystem.photoDB.photos).length;
                    html += `ğŸ“Š ìºë¦­í„° ìˆ˜: ${charCount}\n`;
                    html += `ğŸ“¸ ì´ ì‚¬ì§„ ìˆ˜: ${photoCount}\n`;
                }

                html += `</div></div>`;

                document.getElementById('photo-status').innerHTML = html;
                const success = results.dbLoaded && results.hasPhotos;
                showStatus('photo-status', success, success ? 'ì‚¬ì§„ ì‹œìŠ¤í…œ ì •ìƒ ì‘ë™' : 'ì‚¬ì§„ ì‹œìŠ¤í…œ ì˜¤ë¥˜');

            } catch (error) {
                showStatus('photo-status', false, `ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // ë¨¼ì € ì—°ë½ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸
        function testProactiveSystem() {
            try {
                const proactiveSystem = new ProactiveContactSystem('test_character');

                let html = `<div class="test-result">
                    <strong>í˜¸ê°ë„ë³„ ì—°ë½ ì£¼ê¸°:</strong>
                    <div class="code">`;

                for (let affection = 0; affection <= 10; affection++) {
                    const interval = proactiveSystem.getContactInterval(affection);
                    const display = interval === Infinity ? 'ì—°ë½ ì¤‘ì§€' : `${interval}ë¶„`;
                    html += `í˜¸ê°ë„ ${affection}: ${display}\n`;
                }

                html += `\n<strong>MBTIë³„ ì¸ë‚´ì‹¬ íŒ¨í„´:</strong>\n`;

                const mbtiTypes = ['INFP', 'ENFP', 'INTJ', 'ENTJ', 'INFJ', 'ENFJ',
                                   'INTP', 'ENTP', 'ISFP', 'ESFP', 'ISTP', 'ESTP',
                                   'ISFJ', 'ESFJ', 'ISTJ', 'ESTJ'];

                mbtiTypes.forEach(mbti => {
                    const pattern = proactiveSystem.getPatiencePattern(mbti);
                    if (pattern) {
                        html += `${mbti}: ${pattern.name} (${pattern.reactions.length}ë‹¨ê³„)\n`;
                    }
                });

                html += `</div></div>`;

                document.getElementById('proactive-status').innerHTML = html;
                showStatus('proactive-status', true, 'ë¨¼ì € ì—°ë½ ì‹œìŠ¤í…œ ì •ìƒ ì‘ë™');

            } catch (error) {
                showStatus('proactive-status', false, `ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // íŠ¸ë¦¬ê±° ì—”ì§„ í…ŒìŠ¤íŠ¸
        function testTriggerEngine() {
            try {
                const multiState = new MultiCharacterState();
                const testCharId = 'test_character';

                // í…ŒìŠ¤íŠ¸ ìºë¦­í„° ì´ˆê¸°í™”
                multiState.initializeCharacter(testCharId);

                const triggerEngine = new EpisodeTriggerEngine(testCharId, multiState);

                let html = `<div class="test-result">
                    <strong>íŠ¸ë¦¬ê±° ì—”ì§„ ìƒíƒœ:</strong>
                    <div class="code">`;

                html += `âœ… íŠ¸ë¦¬ê±° ì—”ì§„ ì´ˆê¸°í™” ì™„ë£Œ\n`;
                html += `âœ… ìºë¦­í„° ID: ${triggerEngine.characterId}\n`;
                html += `âœ… ì‹¤í–‰ ìƒíƒœ: ${triggerEngine.isRunning ? 'ì‹¤í–‰ ì¤‘' : 'ì¤‘ì§€'}\n`;
                html += `\n<strong>í†µí•©ëœ ì‹œìŠ¤í…œ:</strong>\n`;
                html += `âœ… ProactiveContactSystem: ${typeof ProactiveContactSystem !== 'undefined' ? 'ë¡œë“œë¨' : 'ë¯¸ë¡œë“œ'}\n`;
                html += `âœ… PhotoSendingSystem: ${typeof PhotoSendingSystem !== 'undefined' ? 'ë¡œë“œë¨' : 'ë¯¸ë¡œë“œ'}\n`;
                html += `âœ… ToneVariationEngine: ${typeof ToneVariationEngine !== 'undefined' ? 'ë¡œë“œë¨' : 'ë¯¸ë¡œë“œ'}\n`;

                html += `</div></div>`;

                document.getElementById('trigger-status').innerHTML = html;
                showStatus('trigger-status', true, 'íŠ¸ë¦¬ê±° ì—”ì§„ ì •ìƒ ì‘ë™');

            } catch (error) {
                showStatus('trigger-status', false, `ì˜¤ë¥˜: ${error.message}`);
            }
        }

        // ì „ì²´ ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸
        async function testFullWorkflow() {
            try {
                let html = `<div class="test-result">
                    <strong>ì „ì²´ ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸:</strong>
                    <div class="code">`;

                // 1. MultiCharacterState ì´ˆê¸°í™”
                html += `\n[1/6] MultiCharacterState ì´ˆê¸°í™”...\n`;
                const multiState = new MultiCharacterState();
                const testCharId = 'workflow_test';
                multiState.initializeCharacter(testCharId);
                html += `âœ… ìºë¦­í„° ì´ˆê¸°í™” ì™„ë£Œ\n`;

                // 2. í˜¸ê°ë„ ë³€ê²½ í…ŒìŠ¤íŠ¸
                html += `\n[2/6] í˜¸ê°ë„ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸...\n`;
                multiState.changeAffection(testCharId, 5);
                const state = multiState.getState(testCharId);
                html += `âœ… í˜¸ê°ë„ ë³€ê²½: ${state.affection}\n`;
                html += `âœ… ê´€ê³„ ë‹¨ê³„: ${state.relationshipStage}\n`;

                // 3. í†¤ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸
                html += `\n[3/6] í†¤ ë³€í™” ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸...\n`;
                const toneEngine = new ToneVariationEngine(testCharId);
                const toneLevel = toneEngine.calculateToneLevel(state.affection);
                html += `âœ… í˜„ì¬ í†¤ ë ˆë²¨: ${toneLevel}\n`;

                // 4. ë¨¼ì € ì—°ë½ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸
                html += `\n[4/6] ë¨¼ì € ì—°ë½ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸...\n`;
                const proactiveSystem = new ProactiveContactSystem(testCharId);
                const interval = proactiveSystem.getContactInterval(state.affection);
                html += `âœ… ì—°ë½ ì£¼ê¸°: ${interval}ë¶„\n`;

                // 5. íŠ¸ë¦¬ê±° ì—”ì§„ í…ŒìŠ¤íŠ¸
                html += `\n[5/6] íŠ¸ë¦¬ê±° ì—”ì§„ í†µí•© í…ŒìŠ¤íŠ¸...\n`;
                const triggerEngine = new EpisodeTriggerEngine(testCharId, multiState);
                html += `âœ… íŠ¸ë¦¬ê±° ì—”ì§„ ì´ˆê¸°í™”\n`;

                // 6. ìœ ì € ì‘ë‹µ ì¶”ì  í…ŒìŠ¤íŠ¸
                html += `\n[6/6] ìœ ì € ì‘ë‹µ ì¶”ì  í…ŒìŠ¤íŠ¸...\n`;
                multiState.notifyUserResponse(testCharId);
                html += `âœ… ìœ ì € ì‘ë‹µ ê¸°ë¡ ì™„ë£Œ\n`;

                html += `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
                html += `ğŸ‰ ì „ì²´ ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸ ì„±ê³µ!\n`;
                html += `</div></div>`;

                document.getElementById('workflow-status').innerHTML = html;
                showStatus('workflow-status', true, 'ì „ì²´ ì›Œí¬í”Œë¡œìš° ì •ìƒ ì‘ë™');

            } catch (error) {
                showStatus('workflow-status', false, `ì˜¤ë¥˜: ${error.message}`);
                console.error(error);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì²´í¬
        window.addEventListener('DOMContentLoaded', () => {
            checkSystemLoading();
        });
    </script>
</body>
</html>
