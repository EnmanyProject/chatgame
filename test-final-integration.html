<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>🧪 최종 통합 테스트 v2.2.0</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            margin: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
            line-height: 1.6;
        }
        
        .header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #333;
            border-radius: 8px;
            background: #2d2d2d;
        }
        
        .test-section h3 {
            color: #569cd6;
            margin: 0 0 15px 0;
        }
        
        .success {
            color: #4ec9b0;
            background: rgba(78, 201, 176, 0.1);
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #4ec9b0;
        }
        
        .error {
            color: #f44747;
            background: rgba(244, 71, 71, 0.1);
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #f44747;
        }
        
        .warning {
            color: #ffcc02;
            background: rgba(255, 204, 2, 0.1);
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #ffcc02;
        }
        
        .info {
            color: #9cdcfe;
            background: rgba(156, 220, 254, 0.1);
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #9cdcfe;
        }
        
        .test-result {
            margin: 10px 0;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: monospace;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        pre {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 12px;
            overflow-x: auto;
            font-size: 12px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-card {
            background: #333;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #4ec9b0;
        }
        
        .stat-label {
            color: #cccccc;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🧪 최종 통합 테스트 시스템</h1>
        <p>MBTI 로맨스 채팅 게임 v2.2.0 - 모든 모듈 검증</p>
    </div>
    
    <div class="test-section">
        <h3>🎮 테스트 제어판</h3>
        <button class="btn" onclick="runAllTests()">전체 테스트 실행</button>
        <button class="btn" onclick="runCoreTests()">핵심 모듈 테스트</button>
        <button class="btn" onclick="runGameTests()">게임 로직 테스트</button>
        <button class="btn" onclick="runIntegrationTests()">통합 테스트</button>
        <button class="btn" onclick="runPerformanceTests()">성능 테스트</button>
        <button class="btn" onclick="clearResults()">결과 초기화</button>
    </div>

    <div id="results-container">
        <!-- 테스트 결과가 여기에 동적으로 추가됩니다 -->
    </div>

    <script type="module">
        // 테스트 결과 컨테이너
        const resultsContainer = document.getElementById('results-container');
        
        // 테스트 통계
        let testStats = {
            total: 0,
            passed: 0,
            failed: 0,
            warnings: 0,
            startTime: null,
            endTime: null
        };

        // 전역 함수들 정의
        window.runAllTests = runAllTests;
        window.runCoreTests = runCoreTests;
        window.runGameTests = runGameTests;
        window.runIntegrationTests = runIntegrationTests;
        window.runPerformanceTests = runPerformanceTests;
        window.clearResults = clearResults;

        // 결과 초기화
        function clearResults() {
            resultsContainer.innerHTML = '';
            testStats = { total: 0, passed: 0, failed: 0, warnings: 0, startTime: null, endTime: null };
        }

        // 테스트 섹션 추가
        function addTestSection(title, icon = '🧪') {
            const section = document.createElement('div');
            section.className = 'test-section';
            section.innerHTML = `<h3>${icon} ${title}</h3><div class="test-content"></div>`;
            resultsContainer.appendChild(section);
            return section.querySelector('.test-content');
        }

        // 테스트 결과 추가
        function addTestResult(container, message, type = 'info') {
            const result = document.createElement('div');
            result.className = `test-result ${type}`;
            result.innerHTML = message;
            container.appendChild(result);
            
            // 통계 업데이트
            testStats.total++;
            if (type === 'success') testStats.passed++;
            else if (type === 'error') testStats.failed++;
            else if (type === 'warning') testStats.warnings++;
        }

        // 통계 표시
        function displayStats() {
            const duration = testStats.endTime - testStats.startTime;
            const statsSection = addTestSection('📊 테스트 통계', '📊');
            statsSection.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${testStats.total}</div>
                        <div class="stat-label">총 테스트</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: #4ec9b0;">${testStats.passed}</div>
                        <div class="stat-label">성공</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: #f44747;">${testStats.failed}</div>
                        <div class="stat-label">실패</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: #ffcc02;">${testStats.warnings}</div>
                        <div class="stat-label">경고</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${duration}ms</div>
                        <div class="stat-label">실행 시간</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${Math.round((testStats.passed / testStats.total) * 100)}%</div>
                        <div class="stat-label">성공률</div>
                    </div>
                </div>
            `;
        }

        // 전체 테스트 실행
        async function runAllTests() {
            clearResults();
            testStats.startTime = Date.now();
            
            addTestResult(addTestSection('🎯 테스트 시작'), '전체 테스트를 시작합니다...', 'info');
            
            await runCoreTests();
            await runGameTests();
            await runIntegrationTests();
            await runPerformanceTests();
            
            testStats.endTime = Date.now();
            displayStats();
            
            addTestResult(addTestSection('✅ 테스트 완료'), '모든 테스트가 완료되었습니다.', 'success');
        }

        // 핵심 모듈 테스트
        async function runCoreTests() {
            const container = addTestSection('🏗️ 핵심 모듈 테스트');
            
            // 1. 아키텍처 모듈 테스트
            try {
                const gameArch = await import('./modules/core/architecture.js');
                if (gameArch.default) {
                    addTestResult(container, '✅ architecture.js 모듈 로드 성공', 'success');
                    
                    if (gameArch.default.initialized) {
                        addTestResult(container, '✅ GameArchitecture 초기화 상태 확인', 'success');
                    } else {
                        await gameArch.default.initialize();
                        addTestResult(container, '✅ GameArchitecture 초기화 완료', 'success');
                    }
                } else {
                    throw new Error('GameArchitecture 인스턴스를 찾을 수 없습니다');
                }
            } catch (error) {
                addTestResult(container, `❌ architecture.js 테스트 실패: ${error.message}`, 'error');
            }
            
            // 2. 스키마 모듈 테스트
            try {
                const DataSchema = await import('./modules/core/schema.js');
                if (DataSchema.default) {
                    addTestResult(container, '✅ schema.js 모듈 로드 성공', 'success');
                    
                    const testSchema = DataSchema.default.createDefault('gameState');
                    if (testSchema && typeof testSchema === 'object') {
                        addTestResult(container, '✅ 기본 게임 상태 스키마 생성 성공', 'success');
                    } else {
                        throw new Error('게임 상태 스키마 생성 실패');
                    }
                } else {
                    throw new Error('DataSchema 인스턴스를 찾을 수 없습니다');
                }
            } catch (error) {
                addTestResult(container, `❌ schema.js 테스트 실패: ${error.message}`, 'error');
            }
            
            await new Promise(resolve => setTimeout(resolve, 500));
        }

        // 게임 로직 테스트
        async function runGameTests() {
            const container = addTestSection('🎮 게임 로직 테스트');
            
            // 1. 선택지 로직 테스트
            try {
                const choiceLogic = await import('./modules/game/choice-logic.js');
                if (choiceLogic.default) {
                    addTestResult(container, '✅ choice-logic.js 모듈 로드 성공', 'success');
                    
                    // 테스트 선택지 처리
                    const testChoice = {
                        choiceIndex: 0,
                        choiceText: '테스트 선택',
                        affectionImpact: 2
                    };
                    const testGameState = { affection: 50 };
                    
                    if (choiceLogic.default.processChoice) {
                        const result = await choiceLogic.default.processChoice(testChoice, testGameState);
                        if (result && result.success) {
                            addTestResult(container, '✅ 선택지 처리 로직 테스트 성공', 'success');
                        } else {
                            addTestResult(container, '⚠️ 선택지 처리 결과가 예상과 다름', 'warning');
                        }
                    } else {
                        addTestResult(container, '⚠️ processChoice 메서드를 찾을 수 없습니다', 'warning');
                    }
                } else {
                    throw new Error('ChoiceLogic 인스턴스를 찾을 수 없습니다');
                }
            } catch (error) {
                addTestResult(container, `❌ choice-logic.js 테스트 실패: ${error.message}`, 'error');
            }
            
            // 2. 자유 채팅 테스트
            try {
                const freeChat = await import('./modules/game/free-chat.js');
                if (freeChat.default) {
                    addTestResult(container, '✅ free-chat.js 모듈 로드 성공', 'success');
                    
                    if (freeChat.default.toggleFreeChatMode) {
                        freeChat.default.toggleFreeChatMode(true);
                        addTestResult(container, '✅ 자유 채팅 모드 토글 테스트 성공', 'success');
                    } else {
                        addTestResult(container, '⚠️ toggleFreeChatMode 메서드를 찾을 수 없습니다', 'warning');
                    }
                } else {
                    throw new Error('FreeChat 인스턴스를 찾을 수 없습니다');
                }
            } catch (error) {
                addTestResult(container, `❌ free-chat.js 테스트 실패: ${error.message}`, 'error');
            }
            
            // 3. 에피소드 플로우 테스트
            try {
                const episodeFlow = await import('./modules/game/episode-flow.js');
                if (episodeFlow.default) {
                    addTestResult(container, '✅ episode-flow.js 모듈 로드 성공', 'success');
                    
                    if (episodeFlow.default.getCurrentProgress) {
                        const progress = episodeFlow.default.getCurrentProgress();
                        if (progress && typeof progress.progressPercent === 'number') {
                            addTestResult(container, `✅ 에피소드 진행률 조회 성공: ${progress.progressPercent}%`, 'success');
                        } else {
                            addTestResult(container, '⚠️ 에피소드 진행률 형식이 예상과 다름', 'warning');
                        }
                    } else {
                        addTestResult(container, '⚠️ getCurrentProgress 메서드를 찾을 수 없습니다', 'warning');
                    }
                } else {
                    throw new Error('EpisodeFlow 인스턴스를 찾을 수 없습니다');
                }
            } catch (error) {
                addTestResult(container, `❌ episode-flow.js 테스트 실패: ${error.message}`, 'error');
            }
            
            await new Promise(resolve => setTimeout(resolve, 500));
        }

        // 통합 테스트
        async function runIntegrationTests() {
            const container = addTestSection('🔗 통합 테스트');
            
            // 1. 관리자 패널 테스트
            try {
                const adminPanel = await import('./modules/admin/admin-panel.js');
                if (adminPanel.default) {
                    addTestResult(container, '✅ admin-panel.js 모듈 로드 성공', 'success');
                    
                    if (adminPanel.default.getStatistics) {
                        const stats = adminPanel.default.getStatistics();
                        addTestResult(container, `✅ 관리자 통계 조회 성공 (시나리오: ${stats.totalScenarios}, 캐릭터: ${stats.totalCharacters})`, 'success');
                    } else {
                        addTestResult(container, '⚠️ getStatistics 메서드를 찾을 수 없습니다', 'warning');
                    }
                } else {
                    throw new Error('AdminPanel 인스턴스를 찾을 수 없습니다');
                }
            } catch (error) {
                addTestResult(container, `❌ admin-panel.js 테스트 실패: ${error.message}`, 'error');
            }
            
            // 2. 게임 엔진 테스트
            try {
                const gameEngine = await import('./modules/integration/game-engine.js');
                if (gameEngine.default) {
                    addTestResult(container, '✅ game-engine.js 모듈 로드 성공', 'success');
                    
                    // 초기화 상태 확인
                    const initAttempts = 10;
                    let initialized = false;
                    
                    for (let i = 0; i < initAttempts; i++) {
                        if (gameEngine.default.initialized) {
                            initialized = true;
                            break;
                        }
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                    
                    if (initialized) {
                        addTestResult(container, '✅ GameEngine 초기화 확인', 'success');
                        
                        // 엔진 상태 체크
                        if (gameEngine.default.getEngineStatus) {
                            const status = gameEngine.default.getEngineStatus();
                            const moduleCount = Object.keys(status.moduleStatus).length;
                            const activeModules = Object.values(status.moduleStatus).filter(s => s).length;
                            addTestResult(container, `✅ 엔진 상태 조회 성공 (모듈: ${activeModules}/${moduleCount} 활성)`, 'success');
                        }
                        
                        // 버전 정보 확인
                        if (gameEngine.default.getVersion) {
                            const version = gameEngine.default.getVersion();
                            addTestResult(container, `✅ 버전 정보 조회 성공: v${version.version}`, 'success');
                        }
                    } else {
                        addTestResult(container, '⚠️ GameEngine 초기화 대기 중...', 'warning');
                    }
                } else {
                    throw new Error('GameEngine 인스턴스를 찾을 수 없습니다');
                }
            } catch (error) {
                addTestResult(container, `❌ game-engine.js 테스트 실패: ${error.message}`, 'error');
            }
            
            // 3. API 연결 테스트
            try {
                const response = await fetch('/api/scenario?action=test');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        addTestResult(container, '✅ API 서버 연결 테스트 성공', 'success');
                    } else {
                        addTestResult(container, `⚠️ API 응답 확인 필요: ${data.message || 'Unknown response'}`, 'warning');
                    }
                } else {
                    addTestResult(container, `⚠️ API 서버 응답 오류: ${response.status}`, 'warning');
                }
            } catch (error) {
                addTestResult(container, `❌ API 연결 테스트 실패: ${error.message}`, 'error');
            }
            
            await new Promise(resolve => setTimeout(resolve, 500));
        }

        // 성능 테스트
        async function runPerformanceTests() {
            const container = addTestSection('⚡ 성능 테스트');
            
            // 1. 모듈 로드 시간 측정
            const startTime = performance.now();
            try {
                const modules = [
                    './modules/core/architecture.js',
                    './modules/core/schema.js',
                    './modules/game/choice-logic.js',
                    './modules/game/free-chat.js',
                    './modules/game/episode-flow.js',
                    './modules/admin/admin-panel.js',
                    './modules/integration/game-engine.js'
                ];
                
                const loadPromises = modules.map(async (modulePath) => {
                    const moduleStartTime = performance.now();
                    await import(modulePath);
                    return performance.now() - moduleStartTime;
                });
                
                const loadTimes = await Promise.all(loadPromises);
                const totalLoadTime = performance.now() - startTime;
                const avgLoadTime = loadTimes.reduce((a, b) => a + b, 0) / loadTimes.length;
                
                addTestResult(container, `✅ 전체 모듈 로드 시간: ${totalLoadTime.toFixed(2)}ms`, 'success');
                addTestResult(container, `✅ 평균 모듈 로드 시간: ${avgLoadTime.toFixed(2)}ms`, 'success');
                
                if (totalLoadTime < 1000) {
                    addTestResult(container, '✅ 로드 성능: 우수 (1초 미만)', 'success');
                } else if (totalLoadTime < 3000) {
                    addTestResult(container, '⚠️ 로드 성능: 보통 (1-3초)', 'warning');
                } else {
                    addTestResult(container, '❌ 로드 성능: 느림 (3초 초과)', 'error');
                }
                
            } catch (error) {
                addTestResult(container, `❌ 모듈 로드 성능 테스트 실패: ${error.message}`, 'error');
            }
            
            // 2. 메모리 사용량 체크
            if (performance.memory) {
                const memoryInfo = performance.memory;
                const usedMB = (memoryInfo.usedJSHeapSize / 1024 / 1024).toFixed(2);
                const limitMB = (memoryInfo.jsHeapSizeLimit / 1024 / 1024).toFixed(2);
                
                addTestResult(container, `📊 메모리 사용량: ${usedMB}MB / ${limitMB}MB`, 'info');
                
                if (memoryInfo.usedJSHeapSize < memoryInfo.jsHeapSizeLimit * 0.5) {
                    addTestResult(container, '✅ 메모리 사용률: 양호 (50% 미만)', 'success');
                } else if (memoryInfo.usedJSHeapSize < memoryInfo.jsHeapSizeLimit * 0.8) {
                    addTestResult(container, '⚠️ 메모리 사용률: 주의 (50-80%)', 'warning');
                } else {
                    addTestResult(container, '❌ 메모리 사용률: 위험 (80% 초과)', 'error');
                }
            } else {
                addTestResult(container, '⚠️ 메모리 정보를 사용할 수 없습니다', 'warning');
            }
            
            await new Promise(resolve => setTimeout(resolve, 300));
        }

        // 페이지 로드 시 초기 메시지 표시
        document.addEventListener('DOMContentLoaded', () => {
            const container = addTestSection('🚀 시스템 준비');
            addTestResult(container, '최종 통합 테스트 시스템이 준비되었습니다.', 'info');
            addTestResult(container, '위의 버튼을 클릭하여 테스트를 시작하세요.', 'info');
        });
    </script>
</body>
</html>