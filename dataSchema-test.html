<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>데이터 스키마 테스트 - Phase 1.2</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: #f9f9f9;
        }

        .test-section h3 {
            margin-top: 0;
            color: #555;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s;
        }

        .button:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .button.primary { background: #2196F3; }
        .button.primary:hover { background: #1976D2; }
        
        .button.warning { background: #ff9800; }
        .button.warning:hover { background: #f57c00; }
        
        .button.danger { background: #f44336; }
        .button.danger:hover { background: #da190b; }

        .output {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 14px;
        }

        .schema-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .schema-card {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .schema-card h4 {
            margin: 0 0 10px 0;
        }

        .schema-card .value {
            font-size: 1.5em;
            font-weight: bold;
        }

        .data-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-success { background: #4CAF50; }
        .status-warning { background: #ff9800; }
        .status-error { background: #f44336; }

        .validation-result {
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
        }

        .validation-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .validation-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .progress-bar {
            background: #e0e0e0;
            border-radius: 10px;
            height: 20px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #4CAF50, #45a049);
            height: 100%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🗃️ 데이터 스키마 모듈 테스트</h1>
        
        <div class="test-section">
            <h3>📊 스키마 상태</h3>
            <div class="schema-grid">
                <div class="schema-card">
                    <h4>등록된 스키마</h4>
                    <div class="value" id="schemaCount">-</div>
                </div>
                <div class="schema-card">
                    <h4>팩토리 함수</h4>
                    <div class="value" id="factoryCount">-</div>
                </div>
                <div class="schema-card">
                    <h4>검증기</h4>
                    <div class="value" id="validatorCount">-</div>
                </div>
                <div class="schema-card">
                    <h4>샘플 데이터</h4>
                    <div class="value" id="sampleCount">-</div>
                </div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="overallProgress" style="width: 0%">0%</div>
            </div>
        </div>

        <div class="test-section">
            <h3>🧪 스키마 테스트</h3>
            <button class="button primary" onclick="testSchemaModule()">스키마 모듈 테스트</button>
            <button class="button" onclick="testFactories()">팩토리 함수 테스트</button>
            <button class="button" onclick="testValidators()">검증기 테스트</button>
            <button class="button warning" onclick="testSampleData()">샘플 데이터 테스트</button>
            <button class="button danger" onclick="clearOutput()">출력 지우기</button>
        </div>

        <div class="test-section">
            <h3>🎮 샘플 데이터 생성</h3>
            <button class="button" onclick="createSampleCharacter()">윤아 캐릭터 생성</button>
            <button class="button" onclick="createSampleEpisode()">첫 번째 에피소드 생성</button>
            <button class="button" onclick="createSampleChoice()">선택지 생성</button>
            <button class="button" onclick="createSampleSave()">저장 데이터 생성</button>
        </div>

        <div class="test-section">
            <h3>✅ 데이터 검증 테스트</h3>
            <button class="button" onclick="validateGoodData()">올바른 데이터 검증</button>
            <button class="button warning" onclick="validateBadData()">잘못된 데이터 검증</button>
            <button class="button primary" onclick="validateAllSamples()">모든 샘플 검증</button>
        </div>

        <div class="test-section">
            <h3>📋 실시간 출력</h3>
            <div class="output" id="testOutput">데이터 스키마 테스트 출력이 여기에 표시됩니다...</div>
        </div>

        <div class="test-section">
            <h3>🗂️ 생성된 데이터 확인</h3>
            <div class="data-display" id="dataDisplay">생성된 데이터가 여기에 표시됩니다...</div>
        </div>

        <div class="test-section">
            <h3>🔍 검증 결과</h3>
            <div id="validationResults">검증 결과가 여기에 표시됩니다...</div>
        </div>
    </div>

    <!-- 먼저 architecture.js를 로드한 후 dataSchema.js 로드 -->
    <script src="architecture.js"></script>
    <script src="dataSchema.js"></script>
    <script>
        let dataSchemaModule = null;
        let testResults = [];
        
        // 출력 함수
        function output(message, type = 'info') {
            const now = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '❌' : type === 'warn' ? '⚠️' : type === 'success' ? '✅' : 'ℹ️';
            const formattedMessage = `[${now}] ${prefix} ${message}`;
            
            const outputDiv = document.getElementById('testOutput');
            outputDiv.textContent += formattedMessage + '\n';
            outputDiv.scrollTop = outputDiv.scrollHeight;
            
            console.log(formattedMessage);
        }

        // 데이터 표시 함수
        function displayData(title, data) {
            const displayDiv = document.getElementById('dataDisplay');
            displayDiv.innerHTML += `<h4>${title}</h4><pre>${JSON.stringify(data, null, 2)}</pre><hr>`;
        }

        // 검증 결과 표시 함수
        function showValidationResult(title, result) {
            const resultDiv = document.getElementById('validationResults');
            const className = result.valid ? 'validation-success' : 'validation-error';
            const status = result.valid ? '✅ 성공' : '❌ 실패';
            
            let content = `<div class="validation-result ${className}">
                <strong>${title}: ${status}</strong>`;
            
            if (!result.valid && result.errors) {
                content += `<ul>`;
                result.errors.forEach(error => {
                    content += `<li>${error}</li>`;
                });
                content += `</ul>`;
            }
            
            content += `</div>`;
            resultDiv.innerHTML += content;
        }

        // 상태 업데이트 함수
        function updateStatus() {
            if (dataSchemaModule) {
                document.getElementById('schemaCount').textContent = dataSchemaModule.schemas.size;
                document.getElementById('factoryCount').textContent = dataSchemaModule.factories.size;
                document.getElementById('validatorCount').textContent = dataSchemaModule.validators.size;
                
                // 샘플 데이터 개수
                const sampleCount = Object.keys(SAMPLE_DATA || {}).length;
                document.getElementById('sampleCount').textContent = sampleCount;
                
                // 전체 진행률 (임의로 계산)
                const totalTests = testResults.length;
                const passedTests = testResults.filter(r => r.passed).length;
                const progress = totalTests > 0 ? Math.round((passedTests / totalTests) * 100) : 0;
                
                const progressBar = document.getElementById('overallProgress');
                progressBar.style.width = `${progress}%`;
                progressBar.textContent = `${progress}%`;
            }
        }

        // 테스트 결과 기록
        function recordTest(name, passed, details = '') {
            testResults.push({ name, passed, details, timestamp: Date.now() });
            updateStatus();
        }

        // 스키마 모듈 테스트
        async function testSchemaModule() {
            output('🧪 스키마 모듈 테스트 시작...');
            
            try {
                // 아키텍처에서 데이터 스키마 모듈 가져오기
                if (!window.gameArchitecture) {
                    // 아키텍처가 없으면 새로 만들기
                    window.gameArchitecture = new GameArchitecture();
                    await window.gameArchitecture.startGame();
                }
                
                // DataSchemaModule이 정의되어 있다면 실제 구현으로 교체
                if (typeof DataSchemaModule !== 'undefined') {
                    window.gameArchitecture.modules.set('dataSchema', new DataSchemaModule());
                    window.gameArchitecture.modules.get('dataSchema').setArchitecture(window.gameArchitecture);
                    await window.gameArchitecture.modules.get('dataSchema').initialize();
                }
                
                dataSchemaModule = window.gameArchitecture.getModule('dataSchema');
                
                if (dataSchemaModule instanceof DataSchemaModule) {
                    output('✅ DataSchemaModule 인스턴스 확인됨', 'success');
                    recordTest('모듈 인스턴스', true);
                } else {
                    output('❌ DataSchemaModule이 올바르게 로드되지 않음', 'error');
                    recordTest('모듈 인스턴스', false);
                    return;
                }
                
                // 스키마 개수 확인
                const schemaCount = dataSchemaModule.schemas.size;
                output(`📊 등록된 스키마: ${schemaCount}개`);
                
                if (schemaCount >= 4) {
                    output('✅ 필요한 모든 스키마가 등록됨', 'success');
                    recordTest('스키마 등록', true);
                } else {
                    output('⚠️ 일부 스키마가 누락됨', 'warn');
                    recordTest('스키마 등록', false);
                }
                
                // 개별 스키마 확인
                const requiredSchemas = ['character', 'episode', 'choice', 'saveData'];
                for (const schemaName of requiredSchemas) {
                    try {
                        const schema = dataSchemaModule.getSchema(schemaName);
                        output(`✅ ${schemaName} 스키마 조회 성공`, 'success');
                        recordTest(`${schemaName} 스키마`, true);
                    } catch (error) {
                        output(`❌ ${schemaName} 스키마 조회 실패: ${error.message}`, 'error');
                        recordTest(`${schemaName} 스키마`, false);
                    }
                }
                
                updateStatus();
                output('🎯 스키마 모듈 테스트 완료', 'success');
                
            } catch (error) {
                output(`❌ 스키마 모듈 테스트 실패: ${error.message}`, 'error');
                recordTest('전체 모듈', false, error.message);
            }
        }

        // 팩토리 함수 테스트
        function testFactories() {
            output('🏭 팩토리 함수 테스트 시작...');
            
            if (!dataSchemaModule) {
                output('❌ 먼저 스키마 모듈 테스트를 실행하세요', 'error');
                return;
            }

            const factories = ['character', 'episode', 'choice', 'saveData'];
            
            factories.forEach(type => {
                try {
                    const data = dataSchemaModule.create(type);
                    output(`✅ ${type} 팩토리 성공 - ID: ${data.id || data.player?.name || 'N/A'}`, 'success');
                    recordTest(`${type} 팩토리`, true);
                    
                    // 첫 번째 데이터만 표시
                    if (type === 'character') {
                        displayData(`${type} 생성 결과`, data);
                    }
                } catch (error) {
                    output(`❌ ${type} 팩토리 실패: ${error.message}`, 'error');
                    recordTest(`${type} 팩토리`, false);
                }
            });
            
            output('🏭 팩토리 함수 테스트 완료', 'success');
        }

        // 검증기 테스트
        function testValidators() {
            output('✅ 검증기 테스트 시작...');
            
            if (!dataSchemaModule) {
                output('❌ 먼저 스키마 모듈 테스트를 실행하세요', 'error');
                return;
            }

            // 올바른 데이터로 테스트
            const validData = {
                character: { id: 'test', name: '테스트', mbti: 'INFP', age: 20 },
                episode: { id: 'ep001', title: '테스트 에피소드', order: 1 },
                choice: { id: 'choice001', text: '테스트 선택지' },
                saveData: { player: { name: '플레이어' } }
            };

            Object.entries(validData).forEach(([type, data]) => {
                try {
                    const result = dataSchemaModule.validate(type, data);
                    if (result.valid) {
                        output(`✅ ${type} 검증 성공`, 'success');
                        recordTest(`${type} 검증`, true);
                    } else {
                        output(`⚠️ ${type} 검증 실패: ${result.errors.join(', ')}`, 'warn');
                        recordTest(`${type} 검증`, false);
                    }
                    showValidationResult(type, result);
                } catch (error) {
                    output(`❌ ${type} 검증기 오류: ${error.message}`, 'error');
                    recordTest(`${type} 검증`, false);
                }
            });

            output('✅ 검증기 테스트 완료', 'success');
        }

        // 샘플 데이터 테스트
        function testSampleData() {
            output('🎮 샘플 데이터 테스트 시작...');
            
            if (typeof SAMPLE_DATA === 'undefined') {
                output('❌ 샘플 데이터가 정의되지 않음', 'error');
                recordTest('샘플 데이터 존재', false);
                return;
            }

            const samples = Object.keys(SAMPLE_DATA);
            output(`📊 발견된 샘플: ${samples.join(', ')}`);

            samples.forEach(type => {
                const sample = SAMPLE_DATA[type];
                output(`✅ ${type} 샘플 로드됨 - ${sample.name || sample.title || sample.id}`, 'success');
                recordTest(`${type} 샘플`, true);
            });

            displayData('모든 샘플 데이터', SAMPLE_DATA);
            output('🎮 샘플 데이터 테스트 완료', 'success');
        }

        // 개별 샘플 생성 함수들
        function createSampleCharacter() {
            try {
                const character = dataSchemaModule.create('character', {
                    name: '윤아',
                    mbti: 'INFP',
                    age: 20
                });
                output(`✅ 윤아 캐릭터 생성됨 - ID: ${character.id}`, 'success');
                displayData('생성된 윤아 캐릭터', character);
            } catch (error) {
                output(`❌ 캐릭터 생성 실패: ${error.message}`, 'error');
            }
        }

        function createSampleEpisode() {
            try {
                const episode = dataSchemaModule.create('episode', {
                    title: '어색한 아침',
                    order: 1
                });
                output(`✅ 에피소드 생성됨 - ${episode.title}`, 'success');
                displayData('생성된 에피소드', episode);
            } catch (error) {
                output(`❌ 에피소드 생성 실패: ${error.message}`, 'error');
            }
        }

        function createSampleChoice() {
            try {
                const choice = dataSchemaModule.create('choice', {
                    text: '다정하게 대답한다',
                    effects: { affection_change: 5 }
                });
                output(`✅ 선택지 생성됨 - ${choice.text}`, 'success');
                displayData('생성된 선택지', choice);
            } catch (error) {
                output(`❌ 선택지 생성 실패: ${error.message}`, 'error');
            }
        }

        function createSampleSave() {
            try {
                const saveData = dataSchemaModule.create('saveData', {
                    player: { name: '시우' }
                });
                output(`✅ 저장 데이터 생성됨 - ${saveData.player.name}`, 'success');
                displayData('생성된 저장 데이터', saveData);
            } catch (error) {
                output(`❌ 저장 데이터 생성 실패: ${error.message}`, 'error');
            }
        }

        // 검증 테스트들
        function validateGoodData() {
            output('✅ 올바른 데이터 검증 테스트...');
            
            const goodData = [
                { type: 'character', data: { id: 'yuna', name: '윤아', mbti: 'INFP', age: 20 } },
                { type: 'episode', data: { id: 'ep001', title: '첫 만남', order: 1 } },
                { type: 'choice', data: { id: 'c001', text: '좋은 선택' } },
                { type: 'saveData', data: { player: { name: '플레이어' } } }
            ];

            goodData.forEach(({ type, data }) => {
                const result = dataSchemaModule.validate(type, data);
                showValidationResult(`올바른 ${type} 데이터`, result);
            });
        }

        function validateBadData() {
            output('⚠️ 잘못된 데이터 검증 테스트...');
            
            const badData = [
                { type: 'character', data: { name: '윤아', mbti: 'WRONG', age: 'not_number' } },
                { type: 'episode', data: { title: '제목만', order: 100 } },
                { type: 'choice', data: { id: 'c001' } }, // text 없음
                { type: 'saveData', data: {} } // player 없음
            ];

            badData.forEach(({ type, data }) => {
                const result = dataSchemaModule.validate(type, data);
                showValidationResult(`잘못된 ${type} 데이터`, result);
            });
        }

        function validateAllSamples() {
            output('🎯 모든 샘플 검증 테스트...');
            
            if (typeof SAMPLE_DATA !== 'undefined') {
                Object.entries(SAMPLE_DATA).forEach(([type, data]) => {
                    const result = dataSchemaModule.validate(type, data);
                    showValidationResult(`샘플 ${type} 데이터`, result);
                });
            }
        }

        function clearOutput() {
            document.getElementById('testOutput').textContent = '출력이 지워졌습니다.\n';
            document.getElementById('dataDisplay').innerHTML = '데이터 표시가 지워졌습니다.';
            document.getElementById('validationResults').innerHTML = '검증 결과가 지워졌습니다.';
            testResults = [];
            updateStatus();
        }

        // 페이지 로드 시 자동 실행
        window.addEventListener('load', async () => {
            output('🌐 데이터 스키마 테스트 페이지 로드됨');
            
            // DataSchemaModule이 로드된 후 아키텍처 모듈 다시 등록
            if (window.gameArchitecture && typeof DataSchemaModule !== 'undefined') {
                try {
                    // 기존 임시 모듈 교체
                    window.gameArchitecture.modules.set('dataSchema', new DataSchemaModule());
                    window.gameArchitecture.modules.get('dataSchema').setArchitecture(window.gameArchitecture);
                    await window.gameArchitecture.modules.get('dataSchema').initialize();
                    output('🔄 DataSchemaModule 실제 구현으로 교체됨', 'success');
                } catch (error) {
                    output(`⚠️ 모듈 교체 실패: ${error.message}`, 'warn');
                }
            }
            
            await testSchemaModule();
        });
    </script>
</body>
</html>