<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>üåê Ïò®ÎùºÏù∏ Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú - Ï±ÑÌåÖ Í∏∞Ïà† ÌõàÎ†® v2.3-FUNCTION-RENAME</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí¨</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #FFE617 0%, #FFC000 100%);
            min-height: 100vh;
            color: #3A3A3A;
        }

        .admin-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            color: #3A3A3A;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        /* ÌÉ≠ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò */
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .nav-tab {
            flex: 1;
            padding: 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #FFE617, #FFC000);
            color: #3A3A3A;
            font-weight: bold;
        }

        .nav-tab:hover:not(.active) {
            background: #e9ecef;
        }

        .nav-tab .badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #FF6B35;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }

        /* ÏΩòÌÖêÏ∏† ÏÑπÏÖò */
        .content-section {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            animation: fadeIn 0.3s ease;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ÌÜµÍ≥Ñ Ïπ¥Îìú */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .stat-card h3 {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .stat-card .value {
            color: #2c3e50;
            font-size: 2em;
            font-weight: bold;
        }

        /* Ïï°ÏÖò Î≤ÑÌäº */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #FFE617, #FFC000);
            color: #3A3A3A;
            font-weight: bold;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.4);
        }

        .btn-secondary {
            background: white;
            color: #FFC000;
            border: 2px solid #FFC000;
        }

        .btn-secondary:hover {
            background: #FFC000;
            color: #3A3A3A;
            font-weight: bold;
        }

        /* ÏòàÏãú ÏãúÏä§ÌÖú Ïä§ÌÉÄÏùº */
        .examples-container {
            margin-top: 8px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        .examples-label {
            font-size: 12px;
            color: #6c757d;
            font-weight: 500;
            margin-bottom: 8px;
            display: block;
        }
        .examples-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .example-tag {
            display: inline-block;
            padding: 4px 8px;
            background: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 12px;
            font-size: 11px;
            color: #495057;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            line-height: 1.2;
        }
        .example-tag:hover {
            background: #FFC000;
            color: #3A3A3A;
            border-color: #FFC000;
            transform: translateY(-1px);
        }
        .example-tag.selected {
            background: #28a745;
            color: white;
            border-color: #28a745;
            transform: scale(0.95);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            font-weight: bold;
            border: none;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #229954 0%, #27ae60 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #3498db 0%, #5dade2 100%);
            color: white;
            border: none;
        }

        .btn-info:hover {
            background: linear-gradient(135deg, #2980b9 0%, #3498db 100%);
            transform: translateY(-1px);
        }

        /* AI ÏÉùÏÑ± Î≤ÑÌäº ÌäπÎ≥Ñ Ïä§ÌÉÄÏùº */
        .footer-left .btn {
            margin-right: 8px;
            font-size: 13px;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .footer-left .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .footer-left .btn:hover::before {
            left: 100%;
        }

        /* ÏãúÎÇòÎ¶¨Ïò§ Í∑∏Î¶¨Îìú */
        .scenarios-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .scenario-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            border: 2px solid transparent;
        }

        .scenario-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border-color: #667eea;
        }

        .scenario-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .scenario-card .description {
            color: #7f8c8d;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .scenario-card .metadata {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tag {
            background: #f0f2ff;
            color: #667eea;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.85em;
        }

        .scenario-card .actions {
            display: flex;
            gap: 10px;
        }

        .scenario-card .actions button {
            flex: 1;
            padding: 8px;
            font-size: 0.9em;
        }

        /* ÎåÄÌôî Í∑∏Î¶¨Îìú */
        .dialogues-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .dialogue-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 2px solid transparent;
        }

        .dialogue-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            border-color: #667eea;
        }

        .dialogue-card.empty {
            border: 2px dashed #e0e0e0;
            background: #fafafa;
        }

        .dialogue-card.empty:hover {
            border-color: #667eea;
            background: white;
        }

        .dialogue-card .dialogue-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .dialogue-card.completed {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: white;
        }

        .dialogue-card.completed .dialogue-number {
            color: white;
        }

        /* ÏóêÌîºÏÜåÎìú Ïπ¥Îìú Ïä§ÌÉÄÏùº (ÏãúÎÇòÎ¶¨Ïò§ Ïπ¥ÎìúÏôÄ Íµ¨Î∂Ñ) */
        .episode-card {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
            border: 2px solid #ff6b9d;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(255, 107, 157, 0.2);
            position: relative;
            overflow: hidden;
        }

        .episode-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 107, 157, 0.3);
            border-color: #ff4081;
        }

        .episode-card .dialogue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .episode-card .dialogue-number {
            background: rgba(255, 255, 255, 0.9);
            color: #ff4081;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.1em;
        }

        .episode-card .difficulty-badge {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
            color: white;
        }

        .episode-card .difficulty-badge.easy {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .episode-card .difficulty-badge.medium {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .episode-card .difficulty-badge.hard {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .episode-card .difficulty-badge.expert {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .episode-card .dialogue-content {
            margin-bottom: 15px;
        }

        .episode-card .character-info {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.7);
            padding: 10px;
            border-radius: 10px;
        }

        .episode-card .character-icon {
            font-size: 1.3em;
            margin-right: 8px;
        }

        .episode-card .character-name {
            font-weight: 600;
            color: #333;
        }

        .episode-card .dialogue-status {
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.8);
            padding: 8px;
            border-radius: 8px;
        }

        .episode-card .status-icon {
            margin-right: 5px;
            font-size: 1.1em;
        }

        .episode-card .status-text {
            font-weight: 500;
            color: #27ae60;
        }

        .episode-card .dialogue-actions {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }

        .episode-card .action-btn {
            background: rgba(255, 255, 255, 0.9);
            color: #ff4081;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .episode-card .action-btn:hover {
            background: white;
            border-color: #ff4081;
            transform: scale(1.05);
        }

        /* ÏóêÌîºÏÜåÎìú Í∑∏Î¶¨Îìú Î†àÏù¥ÏïÑÏõÉ */
        .episodes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        /* Í∞úÎ≥Ñ ÏóêÌîºÏÜåÎìú Ïπ¥Îìú Ïä§ÌÉÄÏùº (ÏÉàÎ°ú Ï∂îÍ∞Ä) */
        .individual-episode-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            position: relative;
            min-height: 160px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .individual-episode-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .episode-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .episode-info .episode-title {
            margin: 0 0 8px 0;
            font-size: 1.1em;
            font-weight: 600;
            color: white;
        }

        .episode-meta {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .episode-meta .scenario-name,
        .episode-meta .character-name {
            font-size: 0.85em;
            opacity: 0.9;
        }

        .episode-badges {
            display: flex;
            gap: 8px;
        }

        .individual-episode-card .difficulty-badge {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .episode-card-content {
            flex: 1;
            margin-bottom: 15px;
        }

        .dialogue-preview-text {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9em;
            line-height: 1.4;
            margin-bottom: 10px;
            opacity: 0.95;
        }

        .episode-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            opacity: 0.8;
        }

        .episode-card-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .individual-episode-card .action-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.2s ease;
        }

        .individual-episode-card .action-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .individual-episode-card .delete-episode-btn {
            background: rgba(255, 77, 77, 0.2);
            border: 1px solid rgba(255, 77, 77, 0.5);
            color: #ff6b6b;
            padding: 6px 10px;
            border-radius: 50%;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-left: 8px;
        }

        .individual-episode-card .delete-episode-btn:hover {
            background: #ff4d4d;
            color: white;
            transform: scale(1.1);
        }

        /* ÌïÑÌÑ∞ Ï†ïÎ≥¥ ÌëúÏãú */
        .filter-info {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
        }

        .filter-info .filter-label {
            font-size: 1em;
        }

        /* ÏóêÌîºÏÜåÎìú Î¶¨Ïä§Ìä∏ Ïπ¥Îìú Ïä§ÌÉÄÏùº (ÏãúÎÇòÎ¶¨Ïò§+Ï∫êÎ¶≠ÌÑ∞ Ï°∞Ìï©) */
        .episodes-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .episode-list-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 2px solid #5a67d8;
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(90, 103, 216, 0.2);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .episode-list-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(90, 103, 216, 0.3);
            border-color: #4c51bf;
        }

        .episode-list-card .episode-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .episode-list-card .episode-title {
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .episode-list-card .episode-subtitle {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .episode-list-card .episode-badge {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        .episode-list-card .episode-content {
            margin-bottom: 20px;
        }

        .episode-list-card .character-info {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            background: rgba(255, 255, 255, 0.15);
            padding: 12px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .episode-list-card .character-avatar {
            font-size: 1.5em;
            margin-right: 12px;
        }

        .episode-list-card .character-details {
            flex: 1;
        }

        .episode-list-card .character-name {
            font-weight: 600;
            font-size: 1.1em;
        }

        .episode-list-card .character-mbti {
            font-size: 0.85em;
            opacity: 0.9;
        }

        .episode-list-card .episode-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .episode-list-card .stat-item {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 8px;
            backdrop-filter: blur(5px);
        }

        .episode-list-card .stat-number {
            font-size: 1.2em;
            font-weight: 700;
            display: block;
        }

        .episode-list-card .stat-label {
            font-size: 0.75em;
            opacity: 0.8;
        }

        .episode-list-card .episode-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .episode-list-card .action-btn {
            background: rgba(255, 255, 255, 0.9);
            color: #5a67d8;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9em;
            font-weight: 600;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .episode-list-card .action-btn:hover {
            background: white;
            border-color: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .episode-list-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            transition: all 0.5s ease;
            opacity: 0;
        }

        .episode-list-card:hover::before {
            animation: shimmer 1s ease-in-out;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); opacity: 0; }
        }

        /* ÏóêÌîºÏÜåÎìú ÎåÄÌôî Ïπ¥Îìú Ïä§ÌÉÄÏùº (ÏÉùÏÑ±Îêú ÎåÄÌôî ÌëúÏãúÏö©) */
        .episode-dialogue-card {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border: 2px solid #5ee7df;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(94, 231, 223, 0.2);
            min-height: 150px;
            display: flex;
            flex-direction: column;
        }

        .episode-dialogue-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(94, 231, 223, 0.3);
            border-color: #4dd5cb;
        }

        .episode-dialogue-card .dialogue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .episode-dialogue-card .dialogue-number {
            background: rgba(255, 255, 255, 0.9);
            color: #20a39e;
            padding: 6px 12px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .episode-dialogue-card .difficulty-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            color: white;
        }

        .episode-dialogue-card .dialogue-content {
            flex: 1;
            margin-bottom: 12px;
        }

        .episode-dialogue-card .dialogue-preview {
            background: rgba(255, 255, 255, 0.8);
            padding: 12px;
            border-radius: 8px;
            font-size: 0.9em;
            line-height: 1.4;
            color: #333;
            margin-bottom: 10px;
            min-height: 60px;
        }

        .episode-dialogue-card .dialogue-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: #666;
        }

        .episode-dialogue-card .dialogue-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .episode-dialogue-card .action-btn {
            background: rgba(255, 255, 255, 0.9);
            color: #20a39e;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .episode-dialogue-card .action-btn:hover {
            background: white;
            border-color: #20a39e;
            transform: scale(1.05);
        }

        .delete-episode-btn {
            background: rgba(255, 77, 77, 0.1);
            border: 2px solid #ff4d4d;
            color: #ff4d4d;
            padding: 6px 10px;
            border-radius: 50%;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-left: 8px;
        }

        .delete-episode-btn:hover {
            background: #ff4d4d;
            color: white;
            transform: scale(1.1);
        }

        /* + Î≤ÑÌäº Ïπ¥Îìú Ïä§ÌÉÄÏùº */
        .add-dialogue-card {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            border: 3px dashed #ff6b9d;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .add-dialogue-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 107, 157, 0.3);
            border-color: #ff4081;
            background: linear-gradient(135deg, #ff8a95 0%, #ffc3ee 100%);
        }

        .add-dialogue-card .add-icon {
            font-size: 3em;
            color: white;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .add-dialogue-card .add-text {
            color: white;
            font-weight: 600;
            font-size: 1.1em;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        /* ÎÇúÏù¥ÎèÑ ÌÉ≠ */
        .difficulty-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }

        .difficulty-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .difficulty-tab:hover {
            border-color: #FFC000;
            background: #FFFACD;
        }

        .difficulty-tab.active {
            background: linear-gradient(135deg, #FFE617, #FFC000);
            color: #3A3A3A;
            border-color: transparent;
            font-weight: bold;
        }

        /* Ï∫êÎ¶≠ÌÑ∞ Í∑∏Î¶¨Îìú */
        .characters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .character-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .character-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border-color: #667eea;
        }

        .character-image {
            width: 80px;
            height: 80px;
            margin-bottom: 15px;
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .character-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .character-image .no-image {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #FFE617, #FFC000);
            color: #3A3A3A;
            display: flex;
            font-weight: bold;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            border-radius: 50%;
        }

        .profile-image-container {
            width: 100%;
            height: 100%;
            position: relative;
            border-radius: 50%;
            overflow: hidden;
        }

        .profile-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            transition: transform 0.2s ease;
        }

        .profile-image-container:hover img {
            transform: scale(1.05);
        }

        .character-info {
            text-align: center;
            width: 100%;
        }

        .character-card .mbti {
            display: inline-block;
            background: linear-gradient(135deg, #FFE617, #FFC000);
            color: #3A3A3A;
            padding: 5px 15px;
            font-weight: bold;
            border-radius: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 0.85em;
        }

        .character-card h3 {
            color: #3A3A3A;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .character-card .traits {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        /* Ï∫êÎ¶≠ÌÑ∞ Ïπ¥Îìú ÏÇ¨ÏßÑ ÎØ∏Î¶¨Î≥¥Í∏∞ */
        .photo-thumbnails {
            display: flex;
            gap: 4px;
            margin-top: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .photo-thumbnail {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: contain;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 2px;
        }

        .photo-thumbnail:hover {
            transform: scale(1.1);
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .more-photos-indicator {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid #667eea;
        }

        .more-photos-indicator:hover {
            transform: scale(1.1);
            background: linear-gradient(135deg, #764ba2, #667eea);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }

        .photo-count-badge {
            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 0.7em;
            font-weight: bold;
            margin-left: 4px;
        }

        /* Î™®Îã¨ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            overflow: hidden; /* Î™®Îã¨ ÏûêÏ≤¥ÏóêÏÑú Ïä§ÌÅ¨Î°§ Î∞©ÏßÄ */
        }

        /* Î™®Îã¨Ïù¥ ÌôúÏÑ±ÌôîÎê† Îïå body Ïä§ÌÅ¨Î°§ Î∞©ÏßÄ */
        body.modal-open {
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        .modal-content {
            background: white;
            margin: 20px auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 95vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }

        /* Ïä§ÌÅ¨Î°§Î∞î Ïä§ÌÉÄÏùº Í∞úÏÑ† */
        .modal-content::-webkit-scrollbar,
        .dialogue-container::-webkit-scrollbar,
        .choices-container::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-track,
        .dialogue-container::-webkit-scrollbar-track,
        .choices-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb,
        .dialogue-container::-webkit-scrollbar-thumb,
        .choices-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover,
        .dialogue-container::-webkit-scrollbar-thumb:hover,
        .choices-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: linear-gradient(135deg, #FFE617, #FFC000);
            color: #3A3A3A;
            padding: 25px;
            border-radius: 15px 15px 0 0;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5em;
        }

        .modal-body {
            padding: 25px 30px 35px 30px;
            max-height: calc(95vh - 140px);
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #FFC000;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .modal-footer {
            background: #f5f5f5;
            padding: 20px 30px;
            border-radius: 0 0 15px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .footer-left {
            display: flex;
            gap: 10px;
        }

        .footer-right {
            display: flex;
            gap: 15px;
        }

        .close {
            color: white;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }

        .close:hover {
            opacity: 1;
        }

        /* AI Ïª®ÌÖçÏä§Ìä∏ */
        .ai-context {
            background: #f8f9ff;
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            min-height: 100px;
        }

        /* Í∏∞Ï°¥ Ïª®ÌÖçÏä§Ìä∏ ÌëúÏãú */
        .existing-context {
            background: #f0f8ff;
            border: 2px solid #4a90e2;
            border-radius: 8px;
            padding: 0;
            overflow: hidden;
        }

        .context-header {
            background: #4a90e2;
            color: white;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }

        .context-label {
            font-size: 14px;
        }

        .context-date {
            font-size: 12px;
            opacity: 0.9;
        }

        .context-content {
            padding: 15px;
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        /* Ïª®ÌÖçÏä§Ìä∏ ÏóÜÏùå ÌëúÏãú */
        .no-context {
            background: #fff9e6;
            border: 2px dashed #f39c12;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .no-context-message {
            color: #e67e22;
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .no-context-help {
            color: #8e6a00;
            font-size: 14px;
        }

        /* ÏãúÎÇòÎ¶¨Ïò§ ÌÉ≠ Ïä§ÌÉÄÏùº */
        .scenario-tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin: 0 20px;
            gap: 5px;
        }

        .scenario-tab {
            padding: 12px 24px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .scenario-tab:hover {
            color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .scenario-tab.active {
            color: #667eea !important;
            border-bottom: 3px solid #667eea !important;
        }

        .scenario-tab-content {
            display: none;
        }

        .scenario-tab-content.active {
            display: block;
        }

        /* ========== Acts & Beats ÌÉÄÏûÑÎùºÏù∏ Ïª®Ìä∏Î°§ Ìå®ÎÑê ========== */
        .structure-editor {
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf2 100%);
            border-radius: 15px;
        }

        /* ÌÉÄÏûÑÎùºÏù∏ Ïª®ÌÖåÏù¥ÎÑà */
        .timeline-container {
            position: relative;
            padding: 20px 0;
        }

        /* ÌÉÄÏûÑÎùºÏù∏ ÎùºÏù∏ */
        .timeline-line {
            position: absolute;
            left: 40px;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        /* Act Ïπ¥Îìú */
        .act-card {
            position: relative;
            margin-left: 60px;
            margin-bottom: 30px;
            border-radius: 12px;
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border: 2px solid transparent;
            overflow: hidden;
        }

        .act-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.15);
            border-color: #667eea;
        }

        /* Act Ïπ¥Îìú ÏÉÅÌÉú Ïù∏ÎîîÏºÄÏù¥ÌÑ∞ */
        .act-card::before {
            content: '';
            position: absolute;
            left: -23px;
            top: 30px;
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
            z-index: 2;
        }

        /* Act Î≤àÌò∏ ÌëúÏãú */
        .act-card::after {
            content: attr(data-act-number);
            position: absolute;
            left: -15px;
            top: 35px;
            color: white;
            font-weight: bold;
            font-size: 11px;
            z-index: 3;
        }

        /* Act Ìó§Îçî */
        .act-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 20px 15px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .act-header input {
            flex: 1;
            font-size: 18px;
            font-weight: 700;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            margin-right: 10px;
            transition: all 0.3s;
        }

        .act-header input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .act-header input:focus {
            background: rgba(255, 255, 255, 0.3);
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.2);
        }

        /* Act Ïï°ÏÖò Î≤ÑÌäº */
        .act-actions {
            display: flex;
            gap: 8px;
        }

        .act-actions button {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            backdrop-filter: blur(10px);
        }

        .act-actions button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .act-actions .btn-danger {
            background: rgba(231, 76, 60, 0.8);
        }

        .act-actions .btn-danger:hover {
            background: rgba(231, 76, 60, 1);
        }

        /* Beats Ïª®ÌÖåÏù¥ÎÑà */
        .beats-container {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: #f8f9ff;
        }

        .beats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .beats-header h4 {
            margin: 0;
            color: #667eea;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .beats-count {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
        }

        /* Beat ÏïÑÏù¥ÌÖú */
        .beat-item {
            position: relative;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .beat-item:hover {
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
            transform: translateX(2px);
        }

        .beat-item::before {
            content: '‚ñ∂';
            position: absolute;
            left: -12px;
            top: 18px;
            color: #667eea;
            font-size: 10px;
        }

        .beat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 8px;
        }

        .beat-item input {
            flex: 1;
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            color: #333;
            transition: all 0.3s;
        }

        .beat-item input:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .beat-item textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.6;
            color: #666;
            min-height: 70px;
            resize: vertical;
            transition: all 0.3s;
        }

        .beat-item textarea:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .beat-actions {
            display: flex;
            gap: 5px;
        }

        .beat-actions button {
            padding: 6px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .beat-actions .btn-danger {
            background: #fee;
            color: #e74c3c;
        }

        .beat-actions .btn-danger:hover {
            background: #e74c3c;
            color: white;
        }

        /* Îπà ÏÉÅÌÉú */
        .empty-structure {
            text-align: center;
            padding: 60px 40px;
            background: white;
            border: 3px dashed #ddd;
            border-radius: 15px;
            color: #999;
        }

        .empty-structure-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .empty-structure-text {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .empty-structure-hint {
            font-size: 13px;
            color: #bbb;
        }

        /* Ï∂îÍ∞Ä Î≤ÑÌäº */
        .btn-add-act {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-add-act:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-add-beat {
            width: 100%;
            padding: 10px;
            background: white;
            color: #667eea;
            border: 2px dashed #667eea;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-add-beat:hover {
            background: #667eea;
            color: white;
            border-style: solid;
        }

        /* ÏßÑÌñâÎèÑ ÌëúÏãú */
        .act-progress {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .progress-bar-container {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .progress-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.9);
            margin-top: 4px;
        }

        /* ÎåÄÌôî ÎØ∏Î¶¨Î≥¥Í∏∞ */
        .dialogue-preview {
            background: #f8f9ff;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .dialogue-text {
            color: #2c3e50;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .narration-text {
            color: #7f8c8d;
            font-style: italic;
            margin-bottom: 15px;
        }

        .choices-list {
            list-style: none;
        }

        .choice-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .choice-item .impact {
            background: #FFC000;
            color: #3A3A3A;
            padding: 2px 8px;
            font-weight: bold;
            border-radius: 15px;
            font-size: 0.85em;
        }

        /* Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉùÍ∏∞ */
        .character-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .character-option {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .character-option:hover {
            border-color: #FFC000;
            background: #FFFACD;
        }

        .character-option.selected {
            border-color: #FFC000;
            background: #FFC000;
            color: #3A3A3A;
            font-weight: bold;
        }

        /* Î°úÎî© */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Îπà ÏÉÅÌÉú */
        .empty-state {
            text-align: center;
            padding: 60px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 2px dashed #e0e0e0;
        }

        .empty-state h3 {
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        .empty-state p {
            color: #95a5a6;
            margin-bottom: 30px;
        }

        /* ÏßÑÌñâÎ∞î */
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #FFE617, #FFC000);
            transition: width 0.3s ease;
        }

        /* Ï∫êÎ¶≠ÌÑ∞ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Î™®Îã¨ Ïä§ÌÉÄÏùº */
        .modal-large {
            max-width: 800px;
            width: 90%;
        }

        .detail-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .detail-section h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
        }

        .detail-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .detail-item.detail-full {
            grid-column: 1 / -1;
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }

        .detail-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9em;
        }

        .detail-value {
            color: #6c757d;
            font-size: 0.9em;
            text-align: right;
            word-break: break-word;
        }

        .detail-item.detail-full .detail-value {
            text-align: left;
            width: 100%;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }

        /* Ï∫êÎ¶≠ÌÑ∞ Ïπ¥ÎìúÏóê ÌÅ¥Î¶≠ Í∏∞Îä• Ï∂îÍ∞Ä */
        .character-card {
            cursor: pointer;
        }

        /* Î∞òÏùëÌòï */
        @media (max-width: 768px) {
            .dialogues-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .scenarios-grid {
                grid-template-columns: 1fr;
            }

            .characters-grid {
                grid-template-columns: 1fr;
            }

            .modal-large {
                width: 95%;
                margin: 20px auto;
            }

            .detail-grid {
                grid-template-columns: 1fr;
            }
        }

        /* AI Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú Ïä§ÌÉÄÏùº */
        .ai-tuning-container {
            margin-top: 30px;
        }

        .ai-tuning-container h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .tuning-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid #667eea;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }

        .tuning-section h4 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tuning-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        /* Ï†ïÎ≥¥ ÌëúÏãúÏö© Ïä§ÌÉÄÏùº */
        .info-display {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .info-title {
            font-weight: bold;
            color: #495057;
            font-size: 1.1em;
            margin-bottom: 8px;
        }

        .info-character {
            color: #6c757d;
            font-size: 0.95em;
        }

        .tuning-controls .form-group {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .tuning-controls .form-group label {
            display: block;
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .tuning-controls .form-group select {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: white;
            font-size: 0.95em;
            transition: all 0.3s ease;
        }

        .tuning-controls .form-group select:focus {
            border-color: #FFC000;
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 192, 0, 0.1);
        }

        .form-help {
            display: block;
            color: #6c757d;
            font-size: 0.85em;
            margin-top: 5px;
            line-height: 1.4;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin: 30px 0;
            justify-content: center;
            flex-wrap: wrap;
        }

        .test-results {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #28a745;
        }

        .test-results h4 {
            color: #495057;
            margin-bottom: 15px;
        }

        .ai-performance-log {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
        }

        .ai-performance-log h4 {
            color: #495057;
            margin-bottom: 15px;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
        }

        .log-entry {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.9em;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-time {
            color: #6c757d;
            font-weight: 600;
            min-width: 50px;
        }

        .log-type {
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.8em;
            font-weight: 600;
            min-width: 80px;
            text-align: center;
        }

        .log-type.success {
            background: #d1ecf1;
            color: #0c5460;
        }

        .log-type.info {
            background: #d4edda;
            color: #155724;
        }

        .log-type.warning {
            background: #fff3cd;
            color: #856404;
        }

        .log-message {
            color: #495057;
            flex: 1;
        }

        /* AI Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±Í∏∞ Ï†ÑÏö© Ïä§ÌÉÄÏùº */
        .ai-character-generator .modal-content {
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* üé≠ Ï∫êÎ¶≠ÌÑ∞ ÏöîÏïΩ ÏÑπÏÖò Ïä§ÌÉÄÏùº */
        .character-summary-section {
            margin-bottom: 25px;
            padding: 20px;
            border: 2px solid #17a2b8;
            border-radius: 15px;
            background: linear-gradient(135deg, #e8f7fa 0%, #f0f9fc 100%);
            box-shadow: 0 3px 10px rgba(23, 162, 184, 0.15);
        }

        .character-summary-section h3 {
            color: #17a2b8;
            margin-bottom: 15px;
            font-size: 1.3em;
            font-weight: bold;
            text-align: center;
        }

        .current-character-display {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .summary-item {
            display: flex;
            flex-direction: column;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid #17a2b8;
        }

        .summary-label {
            font-size: 0.85em;
            font-weight: bold;
            color: #17a2b8;
            margin-bottom: 4px;
        }

        .summary-value {
            font-size: 0.95em;
            color: #333;
            font-weight: 500;
        }

        .summary-details {
            margin-bottom: 15px;
        }

        .summary-row {
            display: flex;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .summary-row:last-child {
            border-bottom: none;
        }

        .summary-row .summary-label {
            min-width: 80px;
            color: #17a2b8;
            font-weight: bold;
            margin-right: 10px;
        }

        .summary-row .summary-value {
            flex: 1;
            color: #333;
        }

        .summary-actions {
            text-align: center;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .summary-details.collapsed {
            display: none;
        }

        .char-category {
            margin-bottom: 20px;
            padding: 25px;
            border: 2px solid #e1e5e9;
            border-radius: 20px;
            background: linear-gradient(135deg, #fdf7f9 0%, #fef9fc 100%);
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .char-category:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .char-category h3 {
            color: #d63384;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: bold;
        }

        .category-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        .appearance-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .genre-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* MBTI ÏÑ†ÌÉù Î≤ÑÌäº */
        .mbti-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .mbti-btn {
            padding: 15px 10px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .mbti-btn:hover {
            border-color: #d63384;
            background: #fdf2f8;
        }

        .mbti-btn.selected {
            border-color: #d63384;
            background: #d63384;
            color: white;
        }

        .mbti-btn small {
            display: block;
            font-size: 11px;
            font-weight: normal;
            opacity: 0.8;
        }

        /* ÏÑ±Í≤© ÌäπÏÑ± Î≤ÑÌäº */
        .trait-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .trait-btn {
            padding: 10px 8px;
            border: 1px solid #dee2e6;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            font-size: 13px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .trait-btn:hover {
            border-color: #fd7e14;
            background: #fff3cd;
        }

        .trait-btn.selected {
            border-color: #fd7e14;
            background: #fd7e14;
            color: white;
        }

        /* Í¥ÄÍ≥Ñ ÏÑ§Ï†ï Î≤ÑÌäº */
        .relationship-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .relationship-btn {
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }

        .relationship-btn:hover {
            border-color: #e83e8c;
            background: #f8d7da;
        }

        .relationship-btn.selected {
            border-color: #e83e8c;
            background: #e83e8c;
            color: white;
        }

        /* Ï∑®ÎØ∏ ÏÑ†ÌÉù Î≤ÑÌäº */
        .hobby-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .hobby-btn {
            padding: 10px 8px;
            border: 1px solid #dee2e6;
            border-radius: 15px;
            background: white;
            cursor: pointer;
            font-size: 12px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .hobby-btn:hover {
            border-color: #20c997;
            background: #d1ecf1;
        }

        .hobby-btn.selected {
            border-color: #20c997;
            background: #20c997;
            color: white;
        }

        /* ÎßêÌà¨ Ïä§ÌÉÄÏùº Î≤ÑÌäº */
        .speech-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        /* Îß§Î†• ÌîÑÎ°úÌïÑ Î≤ÑÌäºÎì§ */
        .charm-options, .desires-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .charm-btn, .desire-btn {
            padding: 12px 10px;
            border: 1px solid #dee2e6;
            border-radius: 15px;
            background: white;
            cursor: pointer;
            font-size: 13px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .charm-btn:hover, .desire-btn:hover {
            border-color: #e91e63;
            background: #fce4ec;
            transform: translateY(-2px);
        }

        .charm-btn.selected {
            border-color: #e91e63;
            background: #e91e63;
            color: white;
            box-shadow: 0 4px 8px rgba(233, 30, 99, 0.3);
        }

        .desire-btn.selected {
            border-color: #9c27b0;
            background: #9c27b0;
            color: white;
            box-shadow: 0 4px 8px rgba(156, 39, 176, 0.3);
        }

        /* üî• ÏÉàÎ°ú Ï∂îÍ∞Ä: Ïä§ÌÇ®Ïã≠ Î≤ÑÌäºÎì§Í≥º Í≥ºÍ±∞ Ïù¥Î†• Ïä§ÌÉÄÏùº */
        .skinship-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .skinship-btn {
            padding: 12px 10px;
            border: 1px solid #dee2e6;
            border-radius: 15px;
            background: #f8f9fa;
            color: #495057;
            font-size: 14px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }

        .skinship-btn:hover {
            border-color: #ff5722;
            background: #fff3e0;
            transform: translateY(-2px);
        }

        .skinship-btn.selected {
            border-color: #ff5722;
            background: #ff5722;
            color: white;
            box-shadow: 0 4px 8px rgba(255, 87, 34, 0.3);
        }

        .history-grid {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }

        /* Îß§Î†• ÌîÑÎ°úÌïÑ Í∑∏Î¶¨Îìú */
        .appeal-grid, .psychological-grid {
            display: grid;
            gap: 20px;
        }

        /* Ïä¨ÎùºÏù¥Îçî Ïä§ÌÉÄÏùº */
        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #e91e63;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #e91e63;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .speech-btn {
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-size: 13px;
        }

        .speech-btn:hover {
            border-color: #6f42c1;
            background: #f8f9fa;
        }

        .speech-btn.selected {
            border-color: #6f42c1;
            background: #6f42c1;
            color: white;
        }

        /* ÎåÄÌôîÏó≠Ìïô Î≤ÑÌäº Ïä§ÌÉÄÏùº */
        .flirting-btn, .hook-btn, .motif-btn {
            display: inline-block;
            padding: 8px 12px;
            margin: 4px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .flirting-btn:hover, .hook-btn:hover, .motif-btn:hover {
            border-color: #fd7e14;
            background: #fff3cd;
            transform: translateY(-2px);
        }

        .flirting-btn.selected, .hook-btn.selected, .motif-btn.selected {
            border-color: #fd7e14;
            background: #fd7e14;
            color: white;
        }

        /* üÜï ÏûêÏã†ÏûàÎäî Î∂ÄÏúÑÏôÄ ÏÑπÏãúÌè¨Ï¶à Î≤ÑÌäº Ïä§ÌÉÄÏùº */
        .confident-parts-grid, .seductive-poses-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #ffeef5 0%, #fff5f8 100%);
            border-radius: 15px;
            border: 1px solid #f8d7da;
        }

        .confident-part-btn, .seductive-pose-btn {
            padding: 14px 12px;
            border: 2px solid #e91e63;
            border-radius: 18px;
            background: linear-gradient(135deg, #ffffff 0%, #fef9fa 100%);
            cursor: pointer;
            text-align: center;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-size: 13px;
            font-weight: 500;
            color: #d63384;
            box-shadow: 0 2px 8px rgba(233, 30, 99, 0.1);
            position: relative;
            overflow: hidden;
        }

        .confident-part-btn::before, .seductive-pose-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
            transition: left 0.5s;
        }

        .confident-part-btn:hover, .seductive-pose-btn:hover {
            border-color: #e91e63;
            background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 6px 20px rgba(233, 30, 99, 0.25);
            color: #ad1457;
        }

        .confident-part-btn:hover::before, .seductive-pose-btn:hover::before {
            left: 100%;
        }

        .confident-part-btn.selected, .seductive-pose-btn.selected {
            border-color: #c2185b;
            background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%);
            color: white;
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 25px rgba(233, 30, 99, 0.4);
            animation: selectedPulse 2s infinite;
        }

        @keyframes selectedPulse {
            0%, 100% {
                box-shadow: 0 8px 25px rgba(233, 30, 99, 0.4);
            }
            50% {
                box-shadow: 0 8px 30px rgba(233, 30, 99, 0.6);
            }
        }

        .confident-part-btn:active, .seductive-pose-btn:active {
            transform: translateY(-1px) scale(0.98);
            transition: all 0.1s ease;
        }

        /* Î∞òÏùëÌòï ÎîîÏûêÏù∏ */
        @media (max-width: 768px) {
            .confident-parts-grid, .seductive-poses-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                padding: 12px;
            }

            .confident-part-btn, .seductive-pose-btn {
                padding: 12px 8px;
                font-size: 12px;
            }
        }

        @media (max-width: 480px) {
            .confident-parts-grid, .seductive-poses-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }
        }

        /* üéÅ Ï¢ãÏïÑÌïòÎäî ÏÑ†Î¨º CSS */
        .favorite-gifts-section {
            padding: 20px;
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-radius: 20px;
            border: 2px solid #ff9800;
            margin: 15px 0;
        }

        .favorite-gifts-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #fff8e1 0%, #fff3c4 100%);
            border-radius: 18px;
            border: 1px solid #ffb74d;
        }

        .gift-btn {
            padding: 16px 14px;
            border: 2px solid #ff9800;
            border-radius: 20px;
            background: linear-gradient(135deg, #ffffff 0%, #fffbf5 100%);
            color: #e65100;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 3px 12px rgba(255, 152, 0, 0.15);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .gift-btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 193, 7, 0.2), transparent);
            transition: left 0.6s;
        }

        .gift-btn:hover {
            border-color: #f57c00;
            background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 6px 20px rgba(255, 152, 0, 0.25);
            color: #bf360c;
        }

        .gift-btn:hover:before {
            left: 100%;
        }

        .gift-btn.selected {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            transform: translateY(-4px) scale(1.08);
            box-shadow: 0 10px 30px rgba(255, 152, 0, 0.5);
            animation: giftPulse 2s infinite;
            border-color: #e65100;
        }

        @keyframes giftPulse {
            0%, 100% {
                box-shadow: 0 10px 30px rgba(255, 152, 0, 0.5);
            }
            50% {
                box-shadow: 0 12px 35px rgba(255, 152, 0, 0.7);
            }
        }

        .gift-btn:active {
            transform: translateY(-2px) scale(0.98);
            transition: all 0.1s ease;
        }

        /* Î∞òÏùëÌòï ÎîîÏûêÏù∏ */
        @media (max-width: 768px) {
            .favorite-gifts-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 12px;
                padding: 15px;
            }

            .gift-btn {
                padding: 14px 10px;
                font-size: 12px;
            }
        }

        @media (max-width: 480px) {
            .favorite-gifts-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .gift-btn {
                padding: 12px 8px;
                font-size: 11px;
            }
        }

        /* üéÜ ÎØ∏Îûò ÏßÅÏóÖ Î≤ÑÌäº Ïä§ÌÉÄÏùº */
        .future-career-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            border: 1px solid #dee2e6;
        }

        .career-btn {
            padding: 16px 14px;
            border: 2px solid #6c5ce7;
            border-radius: 20px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f7ff 100%);
            color: #5a54d6;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 3px 12px rgba(108, 92, 231, 0.15);
            position: relative;
            overflow: hidden;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 50px;
        }

        .career-btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(116, 103, 239, 0.2), transparent);
            transition: left 0.6s;
        }

        .career-btn:hover {
            border-color: #5a54d6;
            background: linear-gradient(135deg, #f3f2ff 0%, #e8e6ff 100%);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 6px 20px rgba(108, 92, 231, 0.25);
            color: #4c43d4;
        }

        .career-btn:hover:before {
            left: 100%;
        }

        .career-btn.selected {
            background: linear-gradient(135deg, #6c5ce7 0%, #5a54d6 100%);
            color: white;
            transform: translateY(-4px) scale(1.08);
            box-shadow: 0 10px 30px rgba(108, 92, 231, 0.5);
            animation: careerPulse 2s infinite;
            border-color: #4c43d4;
        }

        @keyframes careerPulse {
            0%, 100% {
                box-shadow: 0 10px 30px rgba(108, 92, 231, 0.5);
            }
            50% {
                box-shadow: 0 12px 35px rgba(108, 92, 231, 0.7);
            }
        }

        .career-btn:active {
            transform: translateY(-2px) scale(0.98);
            transition: all 0.1s ease;
        }

        /* Î∞òÏùëÌòï ÎîîÏûêÏù∏ */
        @media (max-width: 768px) {
            .future-career-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
                padding: 15px;
            }

            .career-btn {
                padding: 14px 10px;
                font-size: 12px;
                min-height: 45px;
            }
        }

        @media (max-width: 480px) {
            .future-career-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
                padding: 12px;
            }

            .career-btn {
                padding: 12px 8px;
                font-size: 11px;
                min-height: 40px;
            }
        }

        /* üíï Ìù•Î∂ÑÏãú Î∞òÏùë CSS */
        .body-language-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #e8f5e8 0%, #d4f1d4 100%);
            border-radius: 15px;
            border: 1px solid #4caf50;
        }

        .body-language-btn {
            padding: 14px 10px;
            border: 2px solid #4caf50;
            border-radius: 15px;
            background: linear-gradient(135deg, #ffffff 0%, #f9fdf9 100%);
            color: #2e7d32;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.1);
        }

        .body-language-btn:hover {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.2);
        }

        .body-language-btn.selected {
            background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
            color: white;
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        /* üó£Ô∏è ÎßêÌà¨ ÏäµÍ¥Ä CSS */
        .speech-habits-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 15px;
            border: 1px solid #2196f3;
        }

        .speech-habit-btn {
            padding: 14px 10px;
            border: 2px solid #2196f3;
            border-radius: 15px;
            background: linear-gradient(135deg, #ffffff 0%, #f8fcff 100%);
            color: #1565c0;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.1);
        }

        .speech-habit-btn:hover {
            background: linear-gradient(135deg, #e3f2fd 0%, #90caf9 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.2);
        }

        .speech-habit-btn.selected {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
        }

        /* üö´ Í∏àÏßÄ Î∂ÑÏïº CSS */
        .forbidden-topics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border-radius: 15px;
            border: 1px solid #f44336;
        }

        .forbidden-topic-btn {
            padding: 14px 10px;
            border: 2px solid #f44336;
            border-radius: 15px;
            background: linear-gradient(135deg, #ffffff 0%, #fff8f8 100%);
            color: #c62828;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(244, 67, 54, 0.1);
        }

        .forbidden-topic-btn:hover {
            background: linear-gradient(135deg, #ffebee 0%, #ef9a9a 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.2);
        }

        .forbidden-topic-btn.selected {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
        }

        /* üë® ÎÇ®Ïûê Ïö∞ÏÑ†ÏàúÏúÑ CSS */
        .male-priority-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            border-radius: 15px;
            border: 1px solid #9c27b0;
        }

        .male-priority-btn {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 2px solid #9c27b0;
            color: #9c27b0;
            padding: 15px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 50px;
            line-height: 1.2;
        }

        .male-priority-btn:hover {
            background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(156, 39, 176, 0.3);
        }

        .male-priority-btn.selected {
            background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(156, 39, 176, 0.4);
        }

        .male-priority-btn.selected:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 20px rgba(156, 39, 176, 0.4);
        }

        /* üì∏ ÏÇ¨ÏßÑ Í¥ÄÎ¶¨ Î™®Îã¨ CSS */
        .photo-manager-modal {
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .photo-manager-container {
            padding: 20px;
        }

        .photo-status-bar {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 25px;
            border: 1px solid #2196f3;
        }

        .photo-stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            font-weight: 500;
            color: #1976d2;
        }

        .photo-categories-container {
            display: grid;
            gap: 25px;
        }

        .photo-category-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #f0f0f0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f5f5f5;
        }

        .category-header h3 {
            margin: 0;
            color: #333;
            font-size: 1.1em;
        }

        .category-limit {
            font-size: 0.9em;
            color: #666;
            background: #f8f9fa;
            padding: 4px 12px;
            border-radius: 20px;
        }

        .photo-upload-zone {
            border: 2px dashed #ddd;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .photo-upload-zone:hover {
            border-color: #2196f3;
            background: #f8f9ff;
        }

        .upload-placeholder {
            padding: 20px;
        }

        .upload-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
            opacity: 0.7;
        }

        .upload-placeholder p {
            margin: 10px 0 5px 0;
            font-weight: 500;
            color: #555;
        }

        .upload-placeholder small {
            color: #888;
            font-size: 0.85em;
        }

        .photo-preview-container {
            margin-top: 15px;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .photo-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .photo-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .photo-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        .photo-item .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(244, 67, 54, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .photo-item .delete-btn:hover {
            background: #f44336;
            transform: scale(1.1);
        }

        .photo-management-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #f5f5f5;
        }

        .photo-management-actions .btn {
            padding: 12px 24px;
            font-weight: 500;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .photo-management-actions .btn:hover {
            transform: translateY(-2px);
        }

        .photo-management-actions .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: white;
        }

        .photo-management-actions .btn-primary {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
        }

        .photo-management-actions .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            color: white;
        }

        /* Î∞òÏùëÌòï ÎîîÏûêÏù∏ */
        @media (max-width: 768px) {
            .body-language-grid, .speech-habits-grid, .forbidden-topics-grid, .male-priority-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                padding: 12px;
            }

            .body-language-btn, .speech-habit-btn, .forbidden-topic-btn, .male-priority-btn {
                padding: 12px 8px;
                font-size: 11px;
            }

            .photo-manager-modal {
                width: 98%;
                max-height: 95vh;
            }

            .photo-stats {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .photo-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .photo-management-actions {
                flex-direction: column;
                gap: 10px;
            }

            .photo-management-actions .btn {
                width: 100%;
            }
        }

        .conversation-dynamics {
            display: grid;
            gap: 20px;
            padding: 15px;
        }

        .flirting-options, .conversation-hooks, .allowed-motifs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        /* AI ÏÉùÏÑ± ÏòÅÏó≠ */
        .ai-generation {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px dashed #6c757d;
        }

        .ai-controls {
            text-align: center;
            margin-bottom: 15px;
        }

        .btn-ai {
            background: linear-gradient(45deg, #6f42c1, #e83e8c);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-ai:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(111, 66, 193, 0.3);
        }

        .generation-status {
            margin-top: 10px;
            font-style: italic;
            color: #6c757d;
        }

        .generated-preview {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid #dee2e6;
        }

        /* Î∞òÏùëÌòï Ï°∞Ï†ï */
        @media (max-width: 768px) {
            .ai-character-generator .modal-content {
                max-width: 95%;
                margin: 2% auto;
            }
            
            .category-grid {
                grid-template-columns: 1fr;
            }
            
            .mbti-options {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .trait-options {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .relationship-options {
                grid-template-columns: 1fr;
            }
            
            .hobby-options {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .speech-options {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Dialogue Preview Modal Styles */
        .preview-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #fafbfc;
            border-radius: 12px;
            border: 1px solid #e9ecef;
        }

        .preview-section h3 {
            color: #333;
            margin: -5px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
            font-size: 1.2em;
            font-weight: 600;
        }

        .preview-section:first-child {
            margin-top: 0;
        }

        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .metadata-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .metadata-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .metadata-value {
            font-weight: bold;
            color: #333;
        }

        .dialogue-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }

        .character-message {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
            font-size: 1.1em;
            line-height: 1.5;
        }

        .narration {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 8px;
            font-style: italic;
            color: #1976d2;
            border-left: 4px solid #1976d2;
        }

        .choices-container {
            display: grid;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: #ffffff;
        }

        .choice-preview {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .choice-preview:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .choice-text {
            flex: 1;
            font-weight: 500;
        }

        .choice-impact {
            margin-left: 15px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .impact-positive {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .impact-negative {
            background: #ffebee;
            color: #c62828;
        }

        .impact-neutral {
            background: #f5f5f5;
            color: #666;
        }

        /* API Settings Styles */
        .api-settings-container {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .vercel-env-guide {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .guide-description {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .setup-steps {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .step {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .step-number {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
        }

        .step-content strong {
            color: #333;
            display: block;
            margin-bottom: 5px;
        }

        .step-content p {
            margin: 0;
            color: #666;
            line-height: 1.5;
        }

        .api-key-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .api-key-input-group input {
            flex: 1;
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
        }

        .api-key-input-group button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .api-key-input-group button:hover {
            background: #5a67d8;
        }

        .form-help {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
            display: block;
        }

        .test-results {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #667eea;
        }

        .test-results.success {
            border-left-color: #28a745;
            background: #f8fff9;
        }

        .test-results.error {
            border-left-color: #dc3545;
            background: #fff8f8;
        }

        .api-info {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .api-info h4 {
            color: #333;
            margin-bottom: 15px;
        }

        .api-info ol, .api-info ul {
            padding-left: 20px;
        }

        .api-info li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .api-info a {
            color: #667eea;
            text-decoration: none;
        }

        .api-info a:hover {
            text-decoration: underline;
        }

        .api-usage-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
        }

        .api-usage-info h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .status-connected {
            color: #28a745;
            font-weight: bold;
        }

        .status-disconnected {
            color: #dc3545;
            font-weight: bold;
        }

        .status-warning {
            color: #ffc107;
            font-weight: bold;
        }

        .status-unknown {
            color: #6c757d;
            font-weight: bold;
        }

        .status-testing {
            color: #17a2b8;
            font-weight: bold;
        }

        /* API ÏÇ¨Ïö©Îüâ ÌëúÏãú Í∞úÏÑ† */
        #apiUsage {
            font-size: 0.9em;
            line-height: 1.4;
        }

        /* üîê Î°úÍ∑∏Ïù∏ Î™®Îã¨ Ïä§ÌÉÄÏùº */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .login-container {
            background: linear-gradient(135deg, #FFE617 0%, #FFC000 100%);
            border-radius: 20px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(255, 192, 0, 0.4);
            text-align: center;
            border: 3px solid #FFC000;
        }

        .login-header h2 {
            color: #3A3A3A;
            margin-bottom: 10px;
            font-size: 1.8em;
            font-weight: bold;
        }

        .login-header p {
            color: #555;
            margin-bottom: 30px;
        }

        .login-form {
            text-align: left;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
            font-weight: 600;
        }

        .input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #FFC000;
            box-shadow: 0 0 0 3px rgba(255, 192, 0, 0.2);
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #3A3A3A 0%, #2A2A2A 100%);
            color: #FFE617;
            border: 2px solid #3A3A3A;
            font-weight: bold;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-bottom: 20px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, #2A2A2A 0%, #1A1A1A 100%);
            color: #FFC000;
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .login-status {
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-weight: 500;
            text-align: center;
        }

        .login-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .login-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .login-status.loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .login-help {
            background: rgba(255, 255, 255, 0.8);
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            color: #3A3A3A;
            border: 2px solid rgba(255, 255, 255, 0.9);
        }

        .login-help code {
            background: #FFC000;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #3A3A3A;
            font-weight: bold;
        }

        /* Î≤ÑÏ†Ñ Ï†ïÎ≥¥ ÌëúÏãú (ÏôºÏ™Ω ÏÉÅÎã®) */
        .version-info {
            position: absolute;
            top: 10px;
            left: 20px;
            background: rgba(52, 73, 94, 0.1);
            padding: 4px 8px;
            border-radius: 12px;
            border: 1px solid rgba(52, 73, 94, 0.2);
            z-index: 1000;
        }

        .version-info span {
            font-size: 11px;
            color: #34495e;
            font-weight: 500;
            font-family: 'Courier New', monospace;
        }

        /* Î°úÍ∑∏Ïù∏ ÌõÑ Ìó§ÎçîÏóê ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÌëúÏãú */
        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.9);
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 14px;
            color: #2c3e50;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 12px;
        }

        /* ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉù Ïπ¥Îìú Ïä§ÌÉÄÏùº */
        .scenario-selection-container {
            margin-bottom: 25px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .section-header h4 {
            margin: 0;
            color: #333;
        }

        .scenario-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .scenario-selection-card {
            background: #fff;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .scenario-selection-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .scenario-selection-card.selected {
            border-color: #667eea;
            background: #f8f9ff;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .scenario-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .scenario-card-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .scenario-card-badge {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .scenario-card-description {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 12px;
        }

        .scenario-card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #888;
        }

        .scenario-card-character {
            background: #f0f2f5;
            padding: 4px 8px;
            border-radius: 8px;
            color: #555;
        }

        .loading-card {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            color: #6c757d;
        }

        .loading-card .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid #e9ecef;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        /* ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§ ÌëúÏãú */
        .selected-scenario-display {
            background: #f8f9ff;
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .selected-scenario-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .selected-scenario-header h5 {
            margin: 0;
            color: #667eea;
            font-weight: 600;
        }

        .selected-scenario-info {
            color: #555;
        }

        .selected-scenario-info .info-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .selected-scenario-info .info-character {
            color: #667eea;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .selected-scenario-info .info-description {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
        }

        /* Episode Step Ïä§ÌÉÄÏùº */
        .episode-step-1, .episode-step-2, .episode-step-3, .episode-step-4 {
            margin-bottom: 30px;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .episode-step-1 {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #dee2e6;
        }

        .episode-step-2 {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #ffc107;
        }

        .episode-step-3 {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 2px solid #28a745;
        }

        .episode-step-4 {
            background: linear-gradient(135deg, #cce5ff 0%, #b3d9ff 100%);
            border: 2px solid #007bff;
        }

        /* Ï†ïÎ≥¥ Î∞î Ïä§ÌÉÄÏùº */
        .selected-scenario-info-bar, .selected-episode-info-bar, .selected-dialogue-info-bar {
            background: rgba(255,255,255,0.9);
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .selected-info h5 {
            margin: 0 0 5px 0;
            color: #495057;
            font-size: 16px;
        }

        .selected-info div {
            color: #6c757d;
            font-size: 14px;
        }

        /* ÏóêÌîºÏÜåÎìú ÏÉùÏÑ± Ìèº */
        .episode-creation-form {
            background: rgba(255,255,255,0.9);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #495057;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Îπà ÏÉÅÌÉú ÌëúÏãú */
        .empty-episodes {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .empty-episodes p {
            margin-bottom: 10px;
            font-size: 16px;
        }

        .empty-episodes p:first-child {
            font-weight: bold;
        }

        /* ÏóêÌîºÏÜåÎìú Ïπ¥Îìú Ïä§ÌÉÄÏùº */
        .episode-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .episode-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
            border-color: #667eea;
        }

        .episode-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .episode-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            margin: 0;
        }

        .episode-meta {
            display: flex;
            gap: 15px;
            margin-top: 8px;
        }

        .episode-meta span {
            font-size: 13px;
            color: #6c757d;
        }

        .episode-actions {
            display: flex;
            gap: 10px;
        }

        .episode-actions .btn {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* ÎåÄÌôî Ïπ¥Îìú Í∑∏Î¶¨Îìú */
        .dialogues-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .dialogue-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .dialogue-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
            border-color: #28a745;
        }

        /* ÎåÄÌôî ÎÇ¥Ïö© ÌëúÏãú */
        .dialogue-content-display {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .dialogue-content-display .dialogue-text {
            font-size: 16px;
            line-height: 1.6;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .dialogue-choices {
            margin-top: 25px;
        }

        .choice-item {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 0 8px 8px 0;
        }

        .choice-text {
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
        }

        .choice-effect {
            font-size: 13px;
            color: #6c757d;
        }

        /* Î∞òÏùëÌòï ÎîîÏûêÏù∏ */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .dialogues-cards-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- üîê Î°úÍ∑∏Ïù∏ Î™®Îã¨ -->
    <div id="loginModal" class="login-modal" style="display: block;">
        <div class="login-container">
            <div class="login-header">
                <h2>üîê Ïñ¥ÎìúÎØº Î°úÍ∑∏Ïù∏</h2>
                <p>Í¥ÄÎ¶¨Ïûê Í≥ÑÏ†ïÏúºÎ°ú Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî</p>
            </div>
            <form id="loginForm" class="login-form">
                <div class="input-group">
                    <label for="username">ÏÇ¨Ïö©ÏûêÎ™Ö</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="input-group">
                    <label for="password">ÎπÑÎ∞ÄÎ≤àÌò∏</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit" class="login-btn">
                    üöÄ Î°úÍ∑∏Ïù∏
                </button>
                <div id="loginStatus" class="login-status"></div>
            </form>
            <div class="login-help">
                <p><strong>Í∏∞Î≥∏ Í≥ÑÏ†ï:</strong></p>
                <p>ÏÇ¨Ïö©ÏûêÎ™Ö: <code>admin</code></p>
            </div>
        </div>
    </div>

    <!-- Î©îÏù∏ Ïñ¥ÎìúÎØº Ïù∏ÌÑ∞ÌéòÏù¥Ïä§ -->
    <div id="adminInterface" class="admin-container" style="display: none;">
        <div class="header" style="position: relative;">
            <!-- Î≤ÑÏ†Ñ Ï†ïÎ≥¥ ÌëúÏãú (ÏôºÏ™Ω ÏÉÅÎã®) -->
            <div class="version-info">
                <span id="systemVersion">v1.7.2</span>
            </div>

            <!-- ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÌëúÏãú -->
            <div id="userInfo" class="user-info">
                <span id="userWelcome">üë§ admin</span>
                <button onclick="logout()" class="logout-btn">Î°úÍ∑∏ÏïÑÏõÉ</button>
            </div>

            <h1>üéÆ ÌÜµÌï© Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú</h1>
            <p>MBTI Î°úÎß®Ïä§ Í≤åÏûÑÏùò ÏãúÎÇòÎ¶¨Ïò§, ÎåÄÌôî, Ï∫êÎ¶≠ÌÑ∞Î•º Ìïú Í≥≥ÏóêÏÑú Í¥ÄÎ¶¨Ìï©ÎãàÎã§</p>

        </div>

        <!-- ÌÉ≠ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('characters')">
                üë• Ï∫êÎ¶≠ÌÑ∞ Í¥ÄÎ¶¨
                <span class="badge" id="characterCount">0</span>
            </button>
            <button class="nav-tab" onclick="switchTab('scenarios')">
                üìö ÏãúÎÇòÎ¶¨Ïò§ Í¥ÄÎ¶¨
                <span class="badge" id="scenarioCount">0</span>
            </button>
            <button class="nav-tab" onclick="switchTab('dialogues')">
                üìù ÏóêÌîºÏÜåÎìú Í¥ÄÎ¶¨
                <span class="badge" id="episodeCount">0</span>
            </button>
            <button class="nav-tab" onclick="switchTab('ai-management')">
                üß† AI Í¥ÄÎ¶¨
                <span class="badge" id="aiEngineStatus">‚úÖ</span>
            </button>
            <button class="nav-tab" onclick="switchTab('settings')">
                ‚öôÔ∏è API ÏÑ§Ï†ï
                <span class="badge" id="apiStatus">‚ùå</span>
            </button>
        </div>

        <!-- Ï∫êÎ¶≠ÌÑ∞ Í¥ÄÎ¶¨ ÏÑπÏÖò -->
        <div id="characters-section" class="content-section active">
            <div class="stats-row">
                <div class="stat-card">
                    <h3>Ï†ÑÏ≤¥ Ï∫êÎ¶≠ÌÑ∞</h3>
                    <div class="value" id="totalCharacters">0</div>
                </div>
                <div class="stat-card">
                    <h3>ÌôúÏÑ± Ï∫êÎ¶≠ÌÑ∞</h3>
                    <div class="value" id="activeCharacters">0</div>
                </div>
                <div class="stat-card">
                    <h3>AI ÏÉùÏÑ± Ï∫êÎ¶≠ÌÑ∞</h3>
                    <div class="value" id="aiGeneratedCharacters">0</div>
                </div>
                <div class="stat-card">
                    <h3>Ï∫êÎ¶≠ÌÑ∞ ÌèâÍ∑† Ìò∏Í∞êÎèÑ</h3>
                    <div class="value" id="avgCharacterAffection">0</div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openCharacterModal('create')" style="background: linear-gradient(135deg, #e91e63, #9c27b0); font-size: 16px; padding: 15px 25px;">
                    üé≠‚ú® AI Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±Í∏∞
                </button>
                <button class="btn btn-secondary" onclick="loadCharacters()">
                    üîÑ ÏÉàÎ°úÍ≥†Ïπ®
                </button>
            </div>

            <div id="charactersContainer" class="characters-grid">
                <!-- Ï∫êÎ¶≠ÌÑ∞ Ïπ¥ÎìúÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
            </div>
        </div>

        <!-- ÏóêÌîºÏÜåÎìú Í¥ÄÎ¶¨ ÏÑπÏÖò -->
        <div id="dialogues-section" class="content-section">
            <!-- 1Îã®Í≥Ñ: ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉù (Ìï≠ÏÉÅ Î≥¥Ïù¥Í∏∞) -->
            <div class="episode-step-1">
                <div class="section-header">
                    <h4>üìö 1Îã®Í≥Ñ: ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉù</h4>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="refreshEpisodeScenarioList()">
                        üîÑ ÏÉàÎ°úÍ≥†Ïπ®
                    </button>
                </div>
                <div id="episodeScenarioCardsContainer" class="scenario-cards-grid">
                    <div class="loading-card">
                        <div class="spinner"></div>
                        <p>ÏãúÎÇòÎ¶¨Ïò§ Î°úÎî© Ï§ë...</p>
                    </div>
                </div>
            </div>

            <!-- 2Îã®Í≥Ñ: ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§Ïùò ÏóêÌîºÏÜåÎìú Í¥ÄÎ¶¨ -->
            <div id="episode-step-2" class="episode-step-2" style="display: none;">
                <!-- ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§ Ï†ïÎ≥¥ -->
                <div class="selected-scenario-info-bar">
                    <div class="selected-info">
                        <h5>‚úÖ ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§</h5>
                        <div id="selectedScenarioTitle">Ï†úÎ™©</div>
                        <div id="selectedScenarioDescription">ÏÑ§Î™Ö</div>
                    </div>
                    <button type="button" class="btn btn-link btn-sm" onclick="clearEpisodeScenarioSelection()">
                        ‚Üê ÏãúÎÇòÎ¶¨Ïò§ Îã§Ïãú ÏÑ†ÌÉù
                    </button>
                </div>

                <!-- ÏóêÌîºÏÜåÎìú ÏÉùÏÑ± Î©îÎâ¥ -->
                <div class="episode-creation-menu">
                    <div class="section-header">
                        <h4>üé¨ 2Îã®Í≥Ñ: ÏóêÌîºÏÜåÎìú ÏÉùÏÑ±</h4>
                    </div>

                    <div class="episode-creation-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>ÏóêÌîºÏÜåÎìú Ï†úÎ™©</label>
                                <input type="text" id="episodeTitleInput" placeholder="Ïòà: Ï≤´ÎßåÎÇ®Ïùò ÏÑ§Î†ò" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>ÎåÄÌôî Í∞úÏàò</label>
                                <select id="dialogueCountSelect" class="form-control">
                                    <option value="3">3Í∞ú (ÏßßÏùÄ ÏóêÌîºÏÜåÎìú)</option>
                                    <option value="5" selected>5Í∞ú (ÏùºÎ∞ò ÏóêÌîºÏÜåÎìú)</option>
                                    <option value="7">7Í∞ú (Í∏¥ ÏóêÌîºÏÜåÎìú)</option>
                                    <option value="10">10Í∞ú (ÏÉÅÏÑ∏ ÏóêÌîºÏÜåÎìú)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>ÎÇúÏù¥ÎèÑ</label>
                                <select id="episodeDifficultySelect" class="form-control">
                                    <option value="Easy">Easy - Í∏∞Î≥∏ Îß§ÎÑà</option>
                                    <option value="Medium">Medium - Í∞êÏ†ï ÌëúÌòÑ</option>
                                    <option value="Hard">Hard - Í≥†Í∏â Í∏∞Ïà†</option>
                                    <option value="Expert">Expert - Ïã¨Î¶¨ Ï†ÑÎûµ</option>
                                </select>
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="createNewEpisode()" id="createEpisodeBtn">
                                ‚ú® ÏóêÌîºÏÜåÎìú ÏÉùÏÑ±
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Ïù¥ ÏãúÎÇòÎ¶¨Ïò§Ïùò Í∏∞Ï°¥ ÏóêÌîºÏÜåÎìú Î™©Î°ù -->
                <div class="scenario-episodes-list">
                    <div class="section-header">
                        <h4>üìã 3Îã®Í≥Ñ: ÏÉùÏÑ±Îêú ÏóêÌîºÏÜåÎìú Î™©Î°ù</h4>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="refreshScenarioEpisodes()">
                            üîÑ ÏÉàÎ°úÍ≥†Ïπ®
                        </button>
                    </div>
                    <div id="scenarioEpisodesContainer" class="episodes-cards-grid">
                        <div class="empty-episodes">
                            <p>ÏïÑÏßÅ ÏÉùÏÑ±Îêú ÏóêÌîºÏÜåÎìúÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>
                            <p>ÏúÑÏóêÏÑú ÏÉà ÏóêÌîºÏÜåÎìúÎ•º ÏÉùÏÑ±Ìï¥Î≥¥ÏÑ∏Ïöî! ‚¨ÜÔ∏è</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3Îã®Í≥Ñ: ÏÑ†ÌÉùÎêú ÏóêÌîºÏÜåÎìúÏùò ÎåÄÌôî Î™©Î°ù -->
            <div id="episode-step-3" class="episode-step-3" style="display: none;">
                <div class="selected-episode-info-bar">
                    <div class="selected-info">
                        <h5>üìñ ÏÑ†ÌÉùÎêú ÏóêÌîºÏÜåÎìú</h5>
                        <div id="selectedEpisodeTitle">ÏóêÌîºÏÜåÎìú Ï†úÎ™©</div>
                        <div id="selectedEpisodeDescription">ÎåÄÌôî Í∞úÏàò</div>
                    </div>
                    <button type="button" class="btn btn-link btn-sm" onclick="backToEpisodesList()">
                        ‚Üê ÏóêÌîºÏÜåÎìú Î™©Î°ùÏúºÎ°ú
                    </button>
                </div>

                <div class="episode-dialogues-section">
                    <div class="section-header">
                        <h4>üí¨ 4Îã®Í≥Ñ: ÎåÄÌôî Ïπ¥Îìú Î™©Î°ù</h4>
                    </div>
                    <div id="episodeDialoguesContainer" class="dialogues-cards-grid">
                        <!-- ÎåÄÌôî Ïπ¥ÎìúÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                    </div>
                </div>
            </div>

            <!-- 4Îã®Í≥Ñ: ÏÑ†ÌÉùÎêú ÎåÄÌôîÏùò Ïã§Ï†ú ÎÇ¥Ïö© -->
            <div id="episode-step-4" class="episode-step-4" style="display: none;">
                <div class="selected-dialogue-info-bar">
                    <div class="selected-info">
                        <h5>üí¨ ÏÑ†ÌÉùÎêú ÎåÄÌôî</h5>
                        <div id="selectedDialogueTitle">ÎåÄÌôî Ï†úÎ™©</div>
                    </div>
                    <button type="button" class="btn btn-link btn-sm" onclick="backToDialoguesList()">
                        ‚Üê ÎåÄÌôî Ïπ¥Îìú Î™©Î°ùÏúºÎ°ú
                    </button>
                </div>

                <div class="dialogue-content-section">
                    <div class="section-header">
                        <h4>üìù 5Îã®Í≥Ñ: Ïã§Ï†ú ÎåÄÏÇ¨ ÎÇ¥Ïö©</h4>
                    </div>
                    <div id="dialogueContentContainer" class="dialogue-content-display">
                        <!-- Ïã§Ï†ú ÎåÄÏÇ¨ ÎÇ¥Ïö©Ïù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- API ÏÑ§Ï†ï ÏÑπÏÖò -->
        <div id="settings-section" class="content-section">
            <div class="stats-row">
                <div class="stat-card">
                    <h3>OpenAI API ÏÉÅÌÉú</h3>
                    <div class="value" id="openaiStatus">‚ùå ÎØ∏Ïó∞Í≤∞</div>
                </div>
                <div class="stat-card">
                    <h3>API ÏÇ¨Ïö©Îüâ</h3>
                    <div class="value" id="apiUsage">ÌôïÏù∏ Ï§ë...</div>
                </div>
                <div class="stat-card">
                    <h3>ÎßàÏßÄÎßâ ÌÖåÏä§Ìä∏</h3>
                    <div class="value" id="lastTest">ÏóÜÏùå</div>
                </div>
            </div>

            <div class="api-settings-container">
                <div class="vercel-env-guide">
                    <h3>üîß Vercel ÌôòÍ≤ΩÎ≥ÄÏàò ÏÑ§Ï†ï ÏïàÎÇ¥</h3>
                    <p class="guide-description">AI ÏÉùÏÑ± Í∏∞Îä•ÏùÑ ÏÇ¨Ïö©ÌïòÎ†§Î©¥ Vercel ÎåÄÏãúÎ≥¥ÎìúÏóêÏÑú OpenAI API ÌÇ§Î•º ÌôòÍ≤ΩÎ≥ÄÏàòÎ°ú ÏÑ§Ï†ïÌï¥Ïïº Ìï©ÎãàÎã§.</p>

                    <div class="setup-steps">
                        <div class="step">
                            <span class="step-number">1</span>
                            <div class="step-content">
                                <strong>Vercel ÎåÄÏãúÎ≥¥Îìú Ï†ëÏÜç</strong>
                                <p><a href="https://vercel.com/dashboard" target="_blank" style="color: #667eea;">üîó Vercel Dashboard</a> ‚Üí ÌîÑÎ°úÏ†ùÌä∏ ÏÑ†ÌÉù</p>
                            </div>
                        </div>
                        <div class="step">
                            <span class="step-number">2</span>
                            <div class="step-content">
                                <strong>ÌôòÍ≤ΩÎ≥ÄÏàò ÌéòÏù¥ÏßÄ Ïù¥Îèô</strong>
                                <p>Settings ‚Üí Environment Variables</p>
                            </div>
                        </div>
                        <div class="step">
                            <span class="step-number">3</span>
                            <div class="step-content">
                                <strong>API ÌÇ§ Ï∂îÍ∞Ä</strong>
                                <p>Î≥ÄÏàòÎ™Ö: <code style="background: #e3f2fd; padding: 2px 6px; border-radius: 4px;">OPENAI_API_KEY</code><br>
                                Í∞í: Ïã§Ï†ú OpenAI API ÌÇ§ (sk-Î°ú ÏãúÏûë)</p>
                            </div>
                        </div>
                        <div class="step">
                            <span class="step-number">4</span>
                            <div class="step-content">
                                <strong>ÌôòÍ≤Ω ÏÑ†ÌÉù</strong>
                                <p>Production, Preview, Development Î™®Îëê Ï≤¥ÌÅ¨</p>
                            </div>
                        </div>
                        <div class="step">
                            <span class="step-number">5</span>
                            <div class="step-content">
                                <strong>Ï†ÄÏû• Î∞è Ïû¨Î∞∞Ìè¨</strong>
                                <p>Save ÌÅ¥Î¶≠ ÌõÑ ÏïΩ 1-2Î∂Ñ ÎåÄÍ∏∞</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="checkApiStatus()">
                        üîÑ API ÌÇ§ ÏÉÅÌÉú ÌôïÏù∏
                    </button>
                    <button class="btn btn-primary" onclick="openVercelDashboard()">
                        üöÄ Vercel ÎåÄÏãúÎ≥¥Îìú Ïó¥Í∏∞
                    </button>
                </div>

                <div id="apiTestResults" class="test-results" style="display: none;">
                    <!-- ÌÖåÏä§Ìä∏ Í≤∞Í≥ºÍ∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                </div>

                <div class="api-info">
                    <h4>üìã API ÌÇ§ ÏÑ§Ï†ï Î∞©Î≤ï:</h4>
                    <ol>
                        <li><a href="https://platform.openai.com/" target="_blank">OpenAI ÌîåÎû´Ìèº</a>ÏóêÏÑú Í≥ÑÏ†ïÏùÑ ÎßåÎì§Í≥† Î°úÍ∑∏Ïù∏</li>
                        <li>API ÌÇ§ ÏÑπÏÖòÏóêÏÑú ÏÉà API ÌÇ§ ÏÉùÏÑ±</li>
                        <li>ÏÉùÏÑ±Îêú ÌÇ§Î•º ÏúÑ ÏûÖÎ†•Ï∞ΩÏóê Î∂ôÏó¨ÎÑ£Í∏∞</li>
                        <li>"API ÌÇ§ Ï†ÄÏû•" Î≤ÑÌäº ÌÅ¥Î¶≠</li>
                        <li>"Ïó∞Í≤∞ ÌÖåÏä§Ìä∏" Î≤ÑÌäºÏúºÎ°ú Ï†ïÏÉÅ ÏûëÎèô ÌôïÏù∏</li>
                    </ol>
                    
                    <div class="api-usage-info">
                        <h4>üí∞ ÏÇ¨Ïö© ÏöîÍ∏à:</h4>
                        <ul>
                            <li><strong>GPT-4o-mini</strong>: Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±, ÏßàÎ¨∏ ÏÉùÏÑ± (Ï†ÄÎ†¥)</li>
                            <li><strong>GPT-4o Vision</strong>: Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù (Ï§ëÍ∞Ñ Í∞ÄÍ≤©)</li>
                            <li>ÎåÄÎ∂ÄÎ∂ÑÏùò ÏûëÏóÖÏùÄ Î™á ÏÑºÌä∏ÏóêÏÑú Î™á Îã¨Îü¨ ÏàòÏ§Ä</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Í¥ÄÎ¶¨ ÏÑπÏÖò -->
        <div id="ai-management-section" class="content-section">
            <div class="stats-row">
                <div class="stat-card">
                    <h3>üß† AI ÏóîÏßÑ ÏÉÅÌÉú</h3>
                    <div class="value" id="aiEngineCurrentStatus">Ï†ïÏÉÅ</div>
                </div>
                <div class="stat-card">
                    <h3>üìä Ïò§Îäò ÏÉùÏÑ±Îüâ</h3>
                    <div class="value" id="todayGenerationCount">0</div>
                </div>
                <div class="stat-card">
                    <h3>üéØ ÌíàÏßà Ï†êÏàò</h3>
                    <div class="value" id="aiQualityScore">85%</div>
                </div>
            </div>

            <!-- AI ÏÜåÍ∞ú ÏÉùÏÑ± ÏóîÏßÑ (ÏµúÏÉÅÎã® ÏúÑÏπò) -->
            <div class="ai-tuning-container" style="margin-top: 20px; border: 2px solid #667eea; border-radius: 15px; padding: 20px; background: linear-gradient(135deg, #f8f9ff 0%, #fff 100%); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);">
                <h3 style="color: #667eea; margin-bottom: 20px; font-size: 1.4em; border-bottom: 2px solid #667eea; padding-bottom: 10px; display: flex; align-items: center;">
                    üé≠ AI ÏÜåÍ∞ú ÏÉùÏÑ± ÏóîÏßÑ
                    <span style="margin-left: 10px; font-size: 0.7em; background: #667eea; color: white; padding: 2px 8px; border-radius: 12px;">ÏµúÏã†</span>
                </h3>

                <div class="tuning-controls">
                    <div class="form-group">
                        <label for="characterPromptTarget">üéØ ÎåÄÏÉÅ Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉù</label>
                        <select id="characterPromptTarget">
                            <option value="">Ï∫êÎ¶≠ÌÑ∞Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                        </select>
                        <small class="form-help">AI ÏÜåÍ∞úÎ•º ÏÉùÏÑ±Ìï† Ï∫êÎ¶≠ÌÑ∞Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</small>
                    </div>

                    <div class="form-group">
                        <label for="promptGenerationModel">ü§ñ AI Î™®Îç∏ ÏÑ†ÌÉù</label>
                        <select id="promptGenerationModel">
                            <option value="llama-3.1-8b-instant" selected>Llama 3.1 8B (Í∂åÏû•, Í≥†ÏÜç)</option>
                            <option value="llama-3.1-70b-versatile">Llama 3.1 70B (Í≥†ÏÑ±Îä•)</option>
                            <option value="mixtral-8x7b-32768">Mixtral 8x7B (Îã§Î™©Ï†Å)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="promptStyle">üìù ÌîÑÎ°¨ÌîÑÌä∏ Ïä§ÌÉÄÏùº</label>
                        <select id="promptStyle">
                            <option value="comprehensive" selected>Ï¢ÖÌï©Ìòï (ÏÉÅÏÑ∏Ìïú ÏÑ±Í≤© Î∂ÑÏÑù)</option>
                            <option value="roleplay">Î°§ÌîåÎ†àÏù¥Ìòï (ÎåÄÌôî Ï§ëÏã¨)</option>
                            <option value="psychological">Ïã¨Î¶¨ Î∂ÑÏÑùÌòï (ÍπäÏù¥ ÏûàÎäî Î∂ÑÏÑù)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="promptLength">üìè ÌîÑÎ°¨ÌîÑÌä∏ Í∏∏Ïù¥</label>
                        <select id="promptLength">
                            <option value="medium" selected>Ï§ëÍ∞Ñ (400-600Ïûê)</option>
                            <option value="short">ÏßßÏùå (200-400Ïûê)</option>
                            <option value="long">Í∏¥ (600-1000Ïûê)</option>
                        </select>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="generateCharacterPrompt()">
                            ‚ú® AI ÏÜåÍ∞ú ÏÉùÏÑ±
                        </button>
                        <button class="btn btn-secondary" onclick="previewCharacterData()">
                            üëÅÔ∏è Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ ÎØ∏Î¶¨Î≥¥Í∏∞
                        </button>
                        <button class="btn btn-success" onclick="testFullFieldAccuracy()" style="background: linear-gradient(135deg, #28a745, #20c997); border: none; color: white; font-weight: bold;">
                            üî¨ Ï†ïÌôïÎèÑ ÌÖåÏä§Ìä∏ (Ï†ÑÏ≤¥ ÌïÑÎìú)
                        </button>
                    </div>
                        <button class="btn btn-info" onclick="loadCharactersForPromptGeneration()" style="font-size: 0.9em;">
                            üîÑ Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                        </button>
                        <button class="btn btn-warning" onclick="debugCharacterLoading()" style="font-size: 0.8em;">
                            üîç ÎîîÎ≤ÑÍ∑∏ Î™®Îìú
                        </button>
                    </div>
                </div>

                <!-- ÏÉùÏÑ±Îêú ÌîÑÎ°¨ÌîÑÌä∏ ÎØ∏Î¶¨Î≥¥Í∏∞ -->
                <div id="promptPreviewArea" style="display: none; margin-top: 20px;">
                    <h5>üìã ÏÉùÏÑ±Îêú AI ÏÜåÍ∞ú ÎØ∏Î¶¨Î≥¥Í∏∞</h5>
                    <div id="promptPreviewContent" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto;"></div>
                    <div class="action-buttons" style="margin-top: 10px;">
                        <button class="btn btn-success" onclick="savePromptToCharacter()">
                            üíæ Ï∫êÎ¶≠ÌÑ∞Ïóê Ï†ÄÏû•
                        </button>
                        <button class="btn btn-warning" onclick="regeneratePrompt()">
                            üîÑ Îã§Ïãú ÏÉùÏÑ±
                        </button>
                        <button class="btn btn-secondary" onclick="copyPromptToClipboard()">
                            üìã ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨
                        </button>
                    </div>
                </div>

                <!-- AI ÏÜåÍ∞ú ÏÉùÏÑ± Î°úÍ∑∏ -->
                <div id="promptGenerationLog" style="margin-top: 20px; display: none;">
                    <h5>üìä ÏÉùÏÑ± Î°úÍ∑∏</h5>
                    <div id="promptLogContent" style="background: #f8f9fa; border-radius: 8px; padding: 10px; max-height: 150px; overflow-y: auto;">
                        <!-- Î°úÍ∑∏ ÎÇ¥Ïö©Ïù¥ Ïó¨Í∏∞Ïóê Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
                    </div>
                </div>

                <!-- Ï†ïÌôïÎèÑ ÌÖåÏä§Ìä∏ Í≤∞Í≥º -->
                <div id="accuracyTestResults" style="margin-top: 20px; display: none;">
                    <h5 style="color: #28a745;">üî¨ Ï†ïÌôïÎèÑ ÌÖåÏä§Ìä∏ Í≤∞Í≥º</h5>
                    <div id="accuracyMetrics" style="background: linear-gradient(135deg, #f8fff8, #e8f5e8); border: 2px solid #28a745; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                        <!-- Ï†ïÌôïÎèÑ Î©îÌä∏Î¶≠Ïù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                    </div>
                    <div id="accuracyDetails" style="background: #f8f9fa; border-radius: 8px; padding: 15px; max-height: 300px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 13px;">
                        <!-- ÏÑ∏Î∂Ä Í≤∞Í≥ºÍ∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ÏãúÎÇòÎ¶¨Ïò§ Í¥ÄÎ¶¨ ÏÑπÏÖò -->
        <div id="scenarios-section" class="content-section">
            <!-- ÏãúÎÇòÎ¶¨Ïò§ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÌëúÏãú ÏòÅÏó≠ -->
            <div id="scenario-detail-view" style="display: none; margin-bottom: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; padding: 30px; color: white; box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                    <div style="flex: 1;">
                        <h2 id="detail-scenario-title" style="margin: 0 0 10px 0; font-size: 28px;">ÏãúÎÇòÎ¶¨Ïò§ Ï†úÎ™©</h2>
                        <p id="detail-scenario-description" style="margin: 0; opacity: 0.9; font-size: 16px; line-height: 1.6;">ÏãúÎÇòÎ¶¨Ïò§ ÏÑ§Î™Ö</p>
                    </div>
                    <button onclick="closeScenarioDetail()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                        ‚úï Îã´Í∏∞
                    </button>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px; backdrop-filter: blur(10px);">
                        <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px;">AI Î™®Îç∏</div>
                        <div id="detail-ai-model" style="font-size: 18px; font-weight: 600;">-</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px; backdrop-filter: blur(10px);">
                        <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px;">Ïû•Î•¥</div>
                        <div id="detail-genre" style="font-size: 18px; font-weight: 600;">-</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px; backdrop-filter: blur(10px);">
                        <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px;">ÏÑπÏãú Î†àÎ≤®</div>
                        <div id="detail-sexy-level" style="font-size: 18px; font-weight: 600;">-</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px; backdrop-filter: blur(10px);">
                        <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px;">ÏóêÌîºÏÜåÎìú</div>
                        <div id="detail-episode-count" style="font-size: 18px; font-weight: 600;">-</div>
                    </div>
                </div>

                <div id="detail-acts-structure" style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; backdrop-filter: blur(10px);">
                    <h3 style="margin: 0 0 15px 0; font-size: 18px;">üé¨ Acts & Beats Íµ¨Ï°∞</h3>
                    <div id="detail-acts-content" style="display: flex; flex-direction: column; gap: 10px;">
                        <p style="margin: 0; opacity: 0.7;">Íµ¨Ï°∞ Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§</p>
                    </div>
                </div>
            </div>

            <div class="stats-row">
                <div class="stat-card">
                    <h3>Ï†ÑÏ≤¥ ÏãúÎÇòÎ¶¨Ïò§</h3>
                    <div class="value" id="totalScenarios">0</div>
                </div>
                <div class="stat-card">
                    <h3>ÌôúÏÑ± ÏãúÎÇòÎ¶¨Ïò§</h3>
                    <div class="value" id="activeScenarios">0</div>
                </div>
                <div class="stat-card">
                    <h3>AI ÏÉùÏÑ± ÏãúÎÇòÎ¶¨Ïò§</h3>
                    <div class="value" id="aiGeneratedScenarios">0</div>
                </div>
                <div class="stat-card">
                    <h3>ÎåÄÌôî Ïàò</h3>
                    <div class="value" id="totalDialogues">0</div>
                </div>
            </div>

            <div class="action-buttons" style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="openScenarioModal('create')" style="background: linear-gradient(135deg, #667eea, #764ba2); font-size: 16px; padding: 15px 25px;">
                    ‚ú® ÏÉà ÏãúÎÇòÎ¶¨Ïò§ ÎßåÎì§Í∏∞
                </button>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <label style="font-weight: 600; color: #3A3A3A;">ü§ñ AI Î™®Îç∏:</label>
                    <select id="scenario-ai-model-selector" style="padding: 12px 16px; border-radius: 8px; border: 2px solid #ddd; background: white; cursor: pointer; font-size: 14px; font-weight: 500;">
                        <option value="claude">Claude 3.5 Sonnet</option>
                        <option value="openai">OpenAI GPT-4</option>
                        <option value="llama">Llama 3.1 (Groq)</option>
                    </select>
                </div>
                <button class="btn btn-secondary" onclick="loadScenarios()">
                    üîÑ ÏÉàÎ°úÍ≥†Ïπ®
                </button>
            </div>

            <div id="scenariosContainer" class="scenarios-grid">
                <!-- ÏãúÎÇòÎ¶¨Ïò§ Ïπ¥ÎìúÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
            </div>
        </div>
    </div>

    <!-- ÏãúÎÇòÎ¶¨Ïò§ Î™®Îã¨ -->
    <div id="scenarioModal" class="modal">
        <div class="modal-content" style="max-width: 1000px; max-height: 90vh;">
            <div class="modal-header">
                <span class="close" onclick="closeModal('scenarioModal')">&times;</span>
                <h2 id="scenarioModalTitle">ÏÉà ÏãúÎÇòÎ¶¨Ïò§ ÎßåÎì§Í∏∞</h2>
            </div>

            <div class="modal-body">
                <form id="scenarioForm">
                    <input type="hidden" id="scenarioId" />

                    <!-- Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ -->
                    <div class="form-group">
                        <label for="scenarioTitle">üìù ÏãúÎÇòÎ¶¨Ïò§ Ï†úÎ™© *</label>
                        <input type="text" id="scenarioTitle" required placeholder="Ïòà: Ïπ¥ÌéòÏóêÏÑúÏùò Ïö∞Ïó∞Ìïú ÎßåÎÇ®" />
                        <small>ÏãúÎÇòÎ¶¨Ïò§Î•º ÎåÄÌëúÌïòÎäî Îß§Î†•Ï†ÅÏù∏ Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî</small>
                    </div>

                    <div class="form-group">
                        <label for="scenarioGenre">üé≠ Ïû•Î•¥ *</label>
                        <select id="scenarioGenre" required>
                            <option value="">Ïû•Î•¥ ÏÑ†ÌÉù</option>
                            <option value="sweet_romance">Îã¨ÏΩ§Ìïú Î°úÎß®Ïä§</option>
                            <option value="campus_romance">Ï∫†ÌçºÏä§ Î°úÎß®Ïä§</option>
                            <option value="office_romance">ÏßÅÏû• Î°úÎß®Ïä§</option>
                            <option value="childhood_friend">ÏÜåÍøâÏπúÍµ¨</option>
                            <option value="first_love">Ï≤´ÏÇ¨Îûë</option>
                            <option value="reunion">Ïû¨Ìöå</option>
                            <option value="secret_crush">ÏßùÏÇ¨Îûë</option>
                            <option value="enemies_to_lovers">ÏïôÏàôÏóêÏÑú Ïó∞Ïù∏ÏúºÎ°ú</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="scenarioSexyLevel">üî• ÏÑπÏãú Î†àÎ≤® (1-10) *</label>
                        <input type="range" id="scenarioSexyLevel" min="1" max="10" value="5"
                               oninput="document.getElementById('sexyLevelValue').textContent = this.value" />
                        <div style="text-align: center; font-weight: bold; color: #667eea; margin-top: 5px;">
                            Î†àÎ≤®: <span id="sexyLevelValue">5</span>
                        </div>
                        <small>1 = ÏàúÏàòÌïú Î°úÎß®Ïä§ / 10 = Îß§Ïö∞ Í¥ÄÎä•Ï†Å</small>
                    </div>

                    <div class="form-group">
                        <label for="scenarioTags">üè∑Ô∏è ÌÉúÍ∑∏ (ÏâºÌëúÎ°ú Íµ¨Î∂Ñ)</label>
                        <input type="text" id="scenarioTags" placeholder="Ïòà: Îã¨ÏΩ§Ìï®, ÏÑ§Î†ò, Ï≤´ÎßåÎÇ®" />
                        <small>ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÑ§Î™ÖÌïòÎäî ÌÇ§ÏõåÎìúÎì§ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî</small>
                    </div>

                    <div class="form-group">
                        <label for="scenarioDuration">‚è±Ô∏è ÏòàÏÉÅ ÌîåÎ†àÏù¥ ÏãúÍ∞Ñ</label>
                        <select id="scenarioDuration">
                            <option value="short">ÏßßÏùå (10-15Î∂Ñ)</option>
                            <option value="medium" selected>Î≥¥ÌÜµ (20-30Î∂Ñ)</option>
                            <option value="long">Í∏∏Í≤å (40Î∂Ñ Ïù¥ÏÉÅ)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="scenarioAiModel">ü§ñ AI Î™®Îç∏ ÏÑ†ÌÉù *</label>
                        <select id="scenarioAiModel" required>
                            <option value="claude" selected>Claude 3.5 Sonnet</option>
                            <option value="openai">OpenAI GPT-4</option>
                            <option value="llama">Llama 3.1 (Groq)</option>
                        </select>
                        <small>ÏãúÎÇòÎ¶¨Ïò§ ÏÉùÏÑ±Ïóê ÏÇ¨Ïö©Ìï† AI Î™®Îç∏ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</small>
                    </div>

                    <div class="form-group">
                        <label for="scenarioDescription">üìñ ÏãúÎÇòÎ¶¨Ïò§ ÏÑ§Î™Ö *</label>
                        <textarea id="scenarioDescription" required rows="4"
                                  placeholder="Ïù¥ ÏãúÎÇòÎ¶¨Ïò§Ïùò Ï†ÑÎ∞òÏ†ÅÏù∏ Î∂ÑÏúÑÍ∏∞ÏôÄ ÏßÑÌñâ Î∞©Ìñ•ÏùÑ ÏÑ§Î™ÖÌïòÏÑ∏Ïöî"></textarea>
                    </div>

                    <div class="form-group">
                        <label>üí° Îπ†Î•∏ ÏãúÏûë ÌÖúÌîåÎ¶ø</label>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            <button type="button" class="btn btn-secondary btn-sm" onclick="applyTemplate('campus')">
                                üéì Ï∫†ÌçºÏä§ Î°úÎß®Ïä§
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="applyTemplate('office')">
                                üíº ÏßÅÏû• Î°úÎß®Ïä§
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="applyTemplate('reunion')">
                                üîÑ Ïû¨Ìöå Î°úÎß®Ïä§
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="applyTemplate('firstlove')">
                                üíù Ï≤´ÏÇ¨Îûë
                            </button>
                        </div>
                    </div>

                    <!-- Acts & Beats Íµ¨Ï°∞ ÏÑπÏÖò -->
                    <div class="form-group" style="margin-top: 30px; padding-top: 30px; border-top: 2px solid #eee;">
                        <div class="structure-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div>
                                <h3 style="margin: 0; color: #333;">üé¨ ÏãúÎÇòÎ¶¨Ïò§ ÌÉÄÏûÑÎùºÏù∏</h3>
                                <p style="margin: 5px 0 0 0; font-size: 13px; color: #999;">ActsÏôÄ BeatsÎ°ú ÏãúÎÇòÎ¶¨Ïò§ ÌùêÎ¶ÑÏùÑ ÏÑ§Í≥ÑÌïòÏÑ∏Ïöî</p>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button type="button" onclick="generateAIStructure()" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 14px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); transition: all 0.3s;">
                                    ü§ñ AI ÏûêÎèô ÏÉùÏÑ±
                                </button>
                                <button type="button" class="btn-add-act" onclick="addAct()" style="width: auto; min-width: 150px;">
                                    ‚ûï Act Ï∂îÍ∞Ä
                                </button>
                            </div>
                        </div>

                        <div id="acts-container">
                            <!-- Acts will be rendered here -->
                            <div class="empty-structure">
                                <div class="empty-structure-icon">üé¨</div>
                                <div class="empty-structure-text">ÏïÑÏßÅ ActÍ∞Ä ÏóÜÏäµÎãàÎã§</div>
                                <div class="empty-structure-hint">ÏúÑÏùò "‚ûï Act Ï∂îÍ∞Ä" Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ ÏãúÏûëÌïòÏÑ∏Ïöî</div>
                                <div class="empty-structure-hint" style="margin-top: 10px;">ActÎäî ÏãúÎÇòÎ¶¨Ïò§Ïùò ÌÅ∞ Îã®Í≥ÑÎ•º ÎÇòÌÉÄÎÉÖÎãàÎã§ (Ïòà: ÎßåÎÇ®, ÏπúÎ∞ÄÌï¥Ïßê, Í≥†Î∞±)</div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('scenarioModal')">Ï∑®ÏÜå</button>
                <button type="button" class="btn btn-primary" onclick="saveScenario()">Ï†ÄÏû•</button>
            </div>
        </div>
    </div>

    <!-- ÎåÄÌôî Î™®Îã¨ -->
    <div id="dialogueModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeModal('dialogueModal')">&times;</span>
                <h2 id="dialogueModalTitle">ÏÉà ÎåÄÌôî ÏÉùÏÑ±</h2>
            </div>
            <div class="modal-body">
                <form id="dialogueForm">
                    <input type="hidden" id="dialogueId" />
                    <input type="hidden" id="dialogueScenarioId" />

                    <!-- ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§ Ï†ïÎ≥¥ ÌëúÏãú -->
                    <div class="form-group">
                        <label>üìö ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§</label>
                        <div id="selectedScenarioInfo" class="info-display">
                            <div class="info-title">ÏãúÎÇòÎ¶¨Ïò§ Ï†úÎ™©Ïù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§</div>
                            <div class="info-character">Ï∫êÎ¶≠ÌÑ∞: </div>
                        </div>
                        <small class="form-text">ÏúÑ ÏãúÎÇòÎ¶¨Ïò§ÏôÄ Ï∫êÎ¶≠ÌÑ∞Î°ú ÎåÄÌôîÍ∞Ä ÏûêÎèô ÏÉùÏÑ±Îê©ÎãàÎã§.</small>
                    </div>

                    <!-- Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉùÍ∏∞ -->
                    <div class="form-group">
                        <label>üë§ Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉù</label>
                        <div id="characterLoadingMsg" style="text-align: center; padding: 20px; color: #666;">
                            Ï∫êÎ¶≠ÌÑ∞ Î°úÎî© Ï§ë...
                        </div>
                        <div id="characterSelector" style="display: none; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                            <!-- Ï∫êÎ¶≠ÌÑ∞ ÏòµÏÖòÏù¥ ÎèôÏ†ÅÏúºÎ°ú Î°úÎìúÎê©ÎãàÎã§ -->
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="dialogueNumber">ÎåÄÌôî Î≤àÌò∏ (1-36) *</label>
                        <input type="number" id="dialogueNumber" min="1" max="36" required readonly />
                        <small class="form-text">ÏÑ†ÌÉùÌïú Îπà ÎåÄÌôî Î≤àÌò∏Í∞Ä ÏûêÎèôÏúºÎ°ú ÏÑ§Ï†ïÎê©ÎãàÎã§.</small>
                    </div>

                    <div class="form-group">
                        <label for="difficulty">ÎÇúÏù¥ÎèÑ *</label>
                        <select id="difficulty" required>
                            <option value="easy">Easy (1-9)</option>
                            <option value="medium">Medium (10-18)</option>
                            <option value="hard">Hard (19-27)</option>
                            <option value="expert">Expert (28-36)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="userPrompt">ÏÉÅÌô© ÌîÑÎ°¨ÌîÑÌä∏ *</label>
                        <textarea id="userPrompt" required placeholder="Ïòà: Ïö∞Ïó∞Ìûà ÎèÑÏÑúÍ¥ÄÏóêÏÑú ÎßåÎÇú ÏÉÅÌô©, Í∏¥Ïû•Í∞êÍ≥º ÏÑ§Î†òÏù¥ ÍµêÏ∞®ÌïòÎäî ÏàúÍ∞Ñ"></textarea>
                    </div>

                    <div class="form-group">
                        <label>AI ÎåÄÌôî ÏÉùÏÑ±</label>
                        <button type="button" class="btn btn-secondary" onclick="generateDialogue()">
                            ü§ñ AI ÎåÄÌôî ÏÉùÏÑ±
                        </button>
                    </div>

                    <div id="dialoguePreview" class="dialogue-preview" style="display: none;">
                        <h4>ÏÉùÏÑ±Îêú ÎåÄÌôî ÎØ∏Î¶¨Î≥¥Í∏∞</h4>
                        <div class="dialogue-text" id="previewDialogue"></div>
                        <div class="narration-text" id="previewNarration"></div>
                        <ul class="choices-list" id="previewChoices"></ul>
                    </div>

                    <div class="form-group">
                        <label for="customDialogue">Ïª§Ïä§ÌÖÄ ÎåÄÌôî (ÏÑ†ÌÉùÏÇ¨Ìï≠)</label>
                        <textarea id="customDialogue" placeholder="AIÍ∞Ä ÏÉùÏÑ±Ìïú ÎåÄÌôîÎ•º ÏàòÏ†ïÌïòÍ±∞ÎÇò ÏßÅÏ†ë ÏûëÏÑ±Ìï† Ïàò ÏûàÏäµÎãàÎã§"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="customNarration">Ïª§Ïä§ÌÖÄ ÎÇòÎ†àÏù¥ÏÖò (ÏÑ†ÌÉùÏÇ¨Ìï≠)</label>
                        <textarea id="customNarration" placeholder="ÏÉÅÌô© ÏÑ§Î™ÖÏù¥ÎÇò Ï∫êÎ¶≠ÌÑ∞Ïùò ÌñâÎèôÏùÑ Î¨òÏÇ¨Ìï©ÎãàÎã§"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('dialogueModal')">Ï∑®ÏÜå</button>
                <button type="button" class="btn btn-primary" onclick="saveDialogue()">Ï†ÄÏû•</button>
            </div>
        </div>
    </div>

    <!-- Ï∫êÎ¶≠ÌÑ∞ Î™®Îã¨ - AI ÌÜµÌï©Ìòï ÏÉùÏÑ± ÏãúÏä§ÌÖú -->
    <div id="characterModal" class="modal">
        <div class="modal-content ai-character-generator">
            <div class="modal-header">
                <span class="close" onclick="closeModal('characterModal')">&times;</span>
                <h2 id="characterModalTitle">üé≠‚ú® ÏÑ∏Í≥ÑÍ¥Ä ÏµúÍ∞ï AI Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±Í∏∞</h2>
                <p style="text-align: center; color: #666; margin-top: 5px;">Ïä§ÌÅ¨Î°§ÌïòÎ©∞ ÏõêÌïòÎäî ÏöîÏÜåÎì§ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî üíñ</p>
            </div>
            <div class="modal-body">
                <form id="characterForm">
                    <input type="hidden" id="characterId" />

                    <!-- üé≠ Ï∫êÎ¶≠ÌÑ∞ ÏöîÏïΩ Ï†ïÎ≥¥ (ÏàòÏ†ï Î™®ÎìúÏùº ÎïåÎßå ÌëúÏãú) -->
                    <div id="characterSummarySection" class="character-summary-section" style="display: none;">
                        <h3>üé≠ ÌòÑÏû¨ Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥</h3>
                        <div class="current-character-display">
                            <div class="summary-grid">
                                <div class="summary-item">
                                    <span class="summary-label">Ïù¥Î¶Ñ:</span>
                                    <span id="summaryName" class="summary-value">-</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">ÎÇòÏù¥:</span>
                                    <span id="summaryAge" class="summary-value">-</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">MBTI:</span>
                                    <span id="summaryMbti" class="summary-value">-</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">ÏÑ±Î≥Ñ:</span>
                                    <span id="summaryGender" class="summary-value">-</span>
                                </div>
                            </div>
                            <div class="summary-details">
                                <div class="summary-row">
                                    <span class="summary-label">ÏÑ±Í≤©ÌäπÏÑ±:</span>
                                    <span id="summaryPersonality" class="summary-value">-</span>
                                </div>
                                <div class="summary-row">
                                    <span class="summary-label">Ï∑®ÎØ∏:</span>
                                    <span id="summaryHobbies" class="summary-value">-</span>
                                </div>
                                <div class="summary-row">
                                    <span class="summary-label">Ïô∏Î™®:</span>
                                    <span id="summaryAppearance" class="summary-value">-</span>
                                </div>
                                <div class="summary-row">
                                    <span class="summary-label">Î∞∞Í≤Ω:</span>
                                    <span id="summaryBackground" class="summary-value">-</span>
                                </div>
                                <div class="summary-row">
                                    <span class="summary-label">ÎßêÌà¨:</span>
                                    <span id="summarySpeechStyle" class="summary-value">-</span>
                                </div>
                            </div>
                            <div class="summary-actions">
                                <button type="button" class="btn btn-info btn-sm" onclick="toggleCharacterSummary()">
                                    <span id="summaryToggleText">üìñ ÏûêÏÑ∏Ìûà Î≥¥Í∏∞</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- üÜî ÏµúÏÉÅÏúÑ Î©îÌÉÄ Ï†ïÎ≥¥ (Ïà®Í≤®ÏßÑ ÏûêÎèô ÏÉùÏÑ± ÌïÑÎìúÎì§) -->
                    <div class="char-category" style="display: none;">
                        <h3>üÜî Í∏∞Î≥∏ Î©îÌÉÄ Ï†ïÎ≥¥</h3>
                        <div class="category-grid">
                            <!-- ÏûêÎèô ÏÉùÏÑ±ÎêòÎäî ÌïÑÎìúÎì§ -->
                            <input type="hidden" id="characterMetaId" value="" />
                            <input type="hidden" id="characterActive" value="true" />
                            <input type="hidden" id="characterVersion" value="2.1" />
                            <input type="hidden" id="characterSource" value="manual_creation" />
                        </div>
                    </div>

                    <!-- üîß Í≥†Í∏â ÏÑ§Ï†ï (ÌïÑÏöîÏãúÎßå ÌëúÏãú) -->
                    <div class="char-category" id="advancedMetaSection" style="display: none;">
                        <h3>üîß Í≥†Í∏â Î©îÌÉÄ ÏÑ§Ï†ï</h3>
                        <div class="category-grid">
                            <div class="form-group">
                                <label>ÌôúÏÑ± Ïó¨Î∂Ä</label>
                                <select id="characterActiveVisible">
                                    <option value="true" selected>‚úÖ ÌôúÏÑ±</option>
                                    <option value="false">‚ùå ÎπÑÌôúÏÑ±</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>ÏÜåÏä§</label>
                                <select id="characterSourceVisible">
                                    <option value="manual_creation" selected>üñêÔ∏è ÏàòÎèô ÏÉùÏÑ±</option>
                                    <option value="ai_assisted">ü§ñ AI Î≥¥Ï°∞</option>
                                    <option value="template_based">üìã ÌÖúÌîåÎ¶ø Í∏∞Î∞ò</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <button type="button" class="btn btn-secondary" onclick="hideAdvancedMeta()">‚¨ÜÔ∏è Í≥†Í∏â ÏÑ§Ï†ï Ïà®Í∏∞Í∏∞</button>
                        </div>
                    </div>

                    <!-- Í≥†Í∏â ÏÑ§Ï†ï ÌÜ†Í∏Ä Î≤ÑÌäº -->
                    <div class="form-group" style="text-align: center; margin-bottom: 20px;">
                        <button type="button" class="btn btn-info btn-sm" onclick="toggleAdvancedMeta()" id="advancedToggleBtn">
                            üîß Í≥†Í∏â Î©îÌÉÄ ÏÑ§Ï†ï Î≥¥Í∏∞
                        </button>
                    </div>

                    <!-- üíñ Í∏∞Î≥∏ Ï†ïÎ≥¥ -->
                    <div class="char-category">
                        <h3>üíñ Í∏∞Î≥∏ Ï†ïÎ≥¥</h3>
                        <div class="category-grid">
                            <div class="form-group">
                                <label>Ïù¥Î¶Ñ (1-24Ïûê)</label>
                                <input type="text" id="charName" placeholder="Ïòà: Ïú§ÏïÑ, ÏàòÏßÑ, ÌòúÏõê" maxlength="24" />
                                <button type="button" class="btn-random" onclick="randomizeName()">üé≤ ÎûúÎç§</button>
                            </div>
                            <div class="form-group">
                                <label>ÎÇòÏù¥ (20-40)</label>
                                <input type="number" id="charAge" min="20" max="40" value="22" />
                                <button type="button" class="btn-random" onclick="randomizeAge()">üé≤ ÎûúÎç§</button>
                            </div>
                            <div class="form-group">
                                <label>ÏßÅÏóÖ</label>
                                <select id="charOccupation">
                                    <option value="student">üë©‚Äçüéì ÎåÄÌïôÏÉù</option>
                                    <option value="office_worker">üíº ÌöåÏÇ¨Ïõê</option>
                                    <option value="designer">üé® ÎîîÏûêÏù¥ÎÑà</option>
                                    <option value="nurse">üë©‚Äç‚öïÔ∏è Í∞ÑÌò∏ÏÇ¨</option>
                                    <option value="housewife">üè† Ï£ºÎ∂Ä</option>
                                    <option value="celebrity">‚≠ê Ïó∞ÏòàÏù∏</option>
                                    <option value="secretary">üìã ÎπÑÏÑú</option>
                                    <option value="instructor">üë©‚Äçüè´ ÍµêÏÇ¨</option>
                                    <option value="youtuber">üìπ Ïú†ÌäúÎ≤Ñ</option>
                                    <option value="artist">üé≠ ÏòàÏà†Í∞Ä</option>
                                    <option value="journalist">üì∞ Í∏∞Ïûê</option>
                                    <option value="unemployed">üè† Î∞±Ïàò</option>
                                    <option value="flight_attendant">‚úàÔ∏è ÏäπÎ¨¥Ïõê</option>
                                    <option value="pharmacist">üíä ÏïΩÏÇ¨</option>
                                    <option value="chef">üë©‚Äçüç≥ ÏöîÎ¶¨ÏÇ¨</option>
                                    <option value="banker">üè¶ ÏùÄÌñâÏõê</option>
                                    <option value="marketing">üì¢ ÎßàÏºÄÌÑ∞</option>
                                    <option value="entrepreneur">üöÄ ÏÇ¨ÏóÖÍ∞Ä</option>
                                </select>
                                <button type="button" class="btn-random" onclick="randomizeOccupation()">üé≤ ÎûúÎç§</button>
                            </div>
                            <div class="form-group">
                                <label>ÏÑ±Î≥Ñ</label>
                                <select id="charGender">
                                    <option value="female" selected>üë© Ïó¨ÏÑ±</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>ÌïôÎ†•</label>
                                <select id="charEducation">
                                    <option value="high_school">üè´ Í≥†Îì±ÌïôÍµê Ï°∏ÏóÖ</option>
                                    <option value="college_dropout">üìö ÎåÄÌïôÍµê Ï§ëÌá¥</option>
                                    <option value="college_graduate">üéì ÎåÄÌïôÍµê Ï°∏ÏóÖ</option>
                                    <option value="masters">üë©‚Äçüéì ÏÑùÏÇ¨ Ï°∏ÏóÖ</option>
                                    <option value="phd">üë©‚Äçüî¨ Î∞ïÏÇ¨ Ï°∏ÏóÖ</option>
                                    <option value="technical_school">üîß Ï†ÑÎ¨∏ÌïôÍµê Ï°∏ÏóÖ</option>
                                    <option value="art_school">üé® ÏòàÏà†ÎåÄÌïô Ï°∏ÏóÖ</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Í±∞Ï£º ÏßÄÏó≠</label>
                                <select id="charLocation">
                                    <option value="seoul">üèôÔ∏è ÏÑúÏö∏</option>
                                    <option value="busan">üåä Î∂ÄÏÇ∞</option>
                                    <option value="incheon">‚úàÔ∏è Ïù∏Ï≤ú</option>
                                    <option value="daegu">üèîÔ∏è ÎåÄÍµ¨</option>
                                    <option value="daejeon">üèõÔ∏è ÎåÄÏ†Ñ</option>
                                    <option value="gwangju">üå∏ Í¥ëÏ£º</option>
                                    <option value="ulsan">üè≠ Ïö∏ÏÇ∞</option>
                                    <option value="gyeonggi">üè° Í≤ΩÍ∏∞ÎèÑ</option>
                                    <option value="gangwon">‚õ∞Ô∏è Í∞ïÏõêÎèÑ</option>
                                    <option value="jeju">üå¥ Ï†úÏ£ºÎèÑ</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Ï∂úÏã† ÏßÄÏó≠</label>
                                <select id="charHometown">
                                    <option value="seoul">üèôÔ∏è ÏÑúÏö∏</option>
                                    <option value="busan">üåä Î∂ÄÏÇ∞</option>
                                    <option value="incheon">‚úàÔ∏è Ïù∏Ï≤ú</option>
                                    <option value="daegu">üèîÔ∏è ÎåÄÍµ¨</option>
                                    <option value="daejeon">üèõÔ∏è ÎåÄÏ†Ñ</option>
                                    <option value="gwangju">üå∏ Í¥ëÏ£º</option>
                                    <option value="ulsan">üè≠ Ïö∏ÏÇ∞</option>
                                    <option value="gyeonggi">üè° Í≤ΩÍ∏∞ÎèÑ</option>
                                    <option value="gangwon">‚õ∞Ô∏è Í∞ïÏõêÎèÑ</option>
                                    <option value="jeju">üå¥ Ï†úÏ£ºÎèÑ</option>
                                    <option value="chungbuk">üçÉ Ï∂©Ï≤≠Î∂ÅÎèÑ</option>
                                    <option value="chungnam">üåæ Ï∂©Ï≤≠ÎÇ®ÎèÑ</option>
                                    <option value="gyeongbuk">üèûÔ∏è Í≤ΩÏÉÅÎ∂ÅÎèÑ</option>
                                    <option value="gyeongnam">üå∫ Í≤ΩÏÉÅÎÇ®ÎèÑ</option>
                                    <option value="jeonbuk">üåø Ï†ÑÎùºÎ∂ÅÎèÑ</option>
                                    <option value="jeonnam">üåä Ï†ÑÎùºÎÇ®ÎèÑ</option>
                                </select>
                                <button type="button" class="btn-random" onclick="randomizeHometown()">üé≤ ÎûúÎç§</button>
                            </div>
                            <div class="form-group">
                                <label>Í∞ÄÏ°± Íµ¨ÏÑ±</label>
                                <select id="charFamilyStructure">
                                    <option value="nuclear_family">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ 4Ïù∏ Í∞ÄÏ°± (Î∂ÄÎ™®+ÏûêÎÖÄ2)</option>
                                    <option value="small_family">üë®‚Äçüë©‚Äçüëß 3Ïù∏ Í∞ÄÏ°± (Î∂ÄÎ™®+Ïô∏Îèô)</option>
                                    <option value="single_parent">üë©‚Äçüëß ÌïúÎ∂ÄÎ™® Í∞ÄÏ†ï</option>
                                    <option value="grandparents">üë¥üëµ Ï°∞Î∂ÄÎ™®ÏôÄ Ìï®Íªò</option>
                                    <option value="large_family">üë®‚Äçüë©‚Äçüëß‚Äçüë¶üë∂ ÎåÄÍ∞ÄÏ°± (5Ïù∏ Ïù¥ÏÉÅ)</option>
                                    <option value="independent">üè† ÎèÖÎ¶Ω Í±∞Ï£º</option>
                                    <option value="siblings_only">üë≠ ÌòïÏ†úÏûêÎß§ÎÅºÎ¶¨</option>
                                </select>
                                <button type="button" class="btn-random" onclick="randomizeFamilyStructure()">üé≤ ÎûúÎç§</button>
                            </div>
                            <div class="form-group">
                                <label>Î∞òÎ†§ÎèôÎ¨º</label>
                                <select id="charPets">
                                    <option value="none">‚ùå ÏóÜÏùå</option>
                                    <option value="dog">üêï Í∞ïÏïÑÏßÄ</option>
                                    <option value="cat">üê± Í≥†ÏñëÏù¥</option>
                                    <option value="dog_cat">üêïüê± Í∞ïÏïÑÏßÄ+Í≥†ÏñëÏù¥</option>
                                    <option value="bird">üê¶ ÏÉà</option>
                                    <option value="fish">üê† Î¨ºÍ≥†Í∏∞</option>
                                    <option value="hamster">üêπ ÌñÑÏä§ÌÑ∞</option>
                                    <option value="rabbit">üê∞ ÌÜ†ÎÅº</option>
                                    <option value="reptile">ü¶é ÌååÏ∂©Î•ò</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>ÌòàÏï°Ìòï</label>
                                <select id="charBloodtype">
                                    <option value="A">üÖ∞Ô∏è AÌòï</option>
                                    <option value="B">üÖ±Ô∏è BÌòï</option>
                                    <option value="AB">üÜé ABÌòï</option>
                                    <option value="O">üÖæÔ∏è OÌòï</option>
                                </select>
                                <button type="button" class="btn-random" onclick="randomizeBloodType()">üé≤ ÎûúÎç§</button>
                            </div>
                        </div>
                    </div>

                    <!-- ÏÑ±Í≤© ÏÑ§Ï†ï (MBTI Í∏∞Î∞ò) -->
                    <div class="char-category">
                        <h3>üß† ÏÑ±Í≤© ÏÑ§Ï†ï</h3>
                        <div class="mbti-selector">
                            <div class="mbti-group">
                                <label>MBTI Ïú†Ìòï (16Í∞ÄÏßÄ Ï†ÑÏ≤¥)</label>
                                <div class="mbti-options">
                                    <button type="button" class="mbti-btn" data-mbti="INFP">INFP<br><small>Í∞êÏÑ±Ï†Å Ï§ëÏû¨Ïûê</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="ENFP">ENFP<br><small>ÌôúÎ∞úÌïú ÌôúÎèôÍ∞Ä</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="INFJ">INFJ<br><small>ÏòπÌò∏Ïûê</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="ENFJ">ENFJ<br><small>Ï†ïÏùòÎ°úÏö¥ ÏÇ¨ÌöåÏö¥ÎèôÍ∞Ä</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="INTJ">INTJ<br><small>ÏôÑÎ≤ΩÌïú Ï†ÑÎûµÍ∞Ä</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="ENTJ">ENTJ<br><small>ÎåÄÎã¥Ìïú ÌÜµÏÜîÏûê</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="INTP">INTP<br><small>ÎÖºÎ¶¨Ï†Å ÏÇ¨ÏÉâÍ∞Ä</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="ENTP">ENTP<br><small>Îú®Í±∞Ïö¥ ÌÜ†Î°†Í∞Ä</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="ISFP">ISFP<br><small>Î™®ÌóòÍ∞Ä</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="ESFP">ESFP<br><small>ÏûêÏú†Î°úÏö¥ ÏòÅÌòº</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="ISTP">ISTP<br><small>ÎßåÎä• Ïû¨Ï£ºÍæº</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="ESTP">ESTP<br><small>Î™®ÌóòÏùÑ Ï¶êÍ∏∞Îäî ÏÇ¨ÏóÖÍ∞Ä</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="ISFJ">ISFJ<br><small>Ï°∞Ïö©Ìïú Î≥¥Ìò∏Ïûê</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="ESFJ">ESFJ<br><small>Îî∞ÎúªÌïú ÏÇ¨ÍµêÍ∞Ä</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="ISTJ">ISTJ<br><small>ÏóÑÍ≤©Ìïú Í¥ÄÎ¶¨Ïûê</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="ESTJ">ESTJ<br><small>ÏóÑÍ≤©Ìïú Í¥ÄÎ¶¨Ïûê</small></button>
                                </div>
                                <input type="hidden" id="charMbti" />
                            </div>
                            <div class="personality-traits">
                                <label>ÏÑ±Í≤© ÌäπÏÑ± (ÏµúÎåÄ 3Í∞ú ÏÑ†ÌÉù)</label>
                                <div class="trait-options">
                                    <button type="button" class="trait-btn" data-trait="Í∞êÏÑ±Ï†Å">üòä Í∞êÏÑ±Ï†Å</button>
                                    <button type="button" class="trait-btn" data-trait="ÌôúÎ∞úÌïú">‚ú® ÌôúÎ∞úÌïú</button>
                                    <button type="button" class="trait-btn" data-trait="Îß§ÌòπÏ†ÅÏù∏">üíã Îß§ÌòπÏ†ÅÏù∏</button>
                                    <button type="button" class="trait-btn" data-trait="ÏÑπÏãúÌïú">üî• ÏÑπÏãúÌïú</button>
                                    <button type="button" class="trait-btn" data-trait="Ï∞ΩÏùòÏ†Å">üé® Ï∞ΩÏùòÏ†Å</button>
                                    <button type="button" class="trait-btn" data-trait="Ïú†ÌòπÏ†ÅÏù∏">üòà Ïú†ÌòπÏ†ÅÏù∏</button>
                                    <button type="button" class="trait-btn" data-trait="ÏûêÏã†Í∞ê ÏûàÎäî">üí™ ÏûêÏã†Í∞ê ÏûàÎäî</button>
                                    <button type="button" class="trait-btn" data-trait="Ïó¥Ï†ïÏ†Å">üî• Ïó¥Ï†ïÏ†Å</button>
                                    <button type="button" class="trait-btn" data-trait="ÎèÑÎ∞úÏ†ÅÏù∏">üòè ÎèÑÎ∞úÏ†ÅÏù∏</button>
                                    <button type="button" class="trait-btn" data-trait="ÏÑ±ÏàôÌïú">üëë ÏÑ±ÏàôÌïú</button>
                                </div>
                                <button type="button" class="btn-random" onclick="randomizePersonalityTraits()">üé≤ ÎûúÎç§</button>
                                <input type="hidden" id="charPersonalityTraits" />
                            </div>
                        </div>
                    </div>


                    <!-- Í¥ÄÍ≥Ñ ÏÑ§Ï†ï -->
                    <div class="char-category">
                        <h3>üíù Í¥ÄÍ≥Ñ ÏÑ§Ï†ï</h3>
                        <div class="relationship-options">
                            <button type="button" class="relationship-btn" data-rel="seductive_junior">üíã Ïú†ÌòπÏ†ÅÏù∏ ÌõÑÎ∞∞</button>
                            <button type="button" class="relationship-btn" data-rel="adult_friend">üî• ÏÑ±Ïù∏ Í¥ÄÍ≥ÑÏùò ÏπúÍµ¨</button>
                            <button type="button" class="relationship-btn" data-rel="mature_senior">üòà ÏÑ±ÏàôÌïú ÏÑ†Î∞∞</button>
                            <button type="button" class="relationship-btn" data-rel="sexy_classmate">üíï ÏÑπÏãúÌïú ÎèôÍ∏∞</button>
                            <button type="button" class="relationship-btn" data-rel="sensual_clubmate">üéØ Í¥ÄÎä•Ï†ÅÏù∏ ÎèôÏïÑÎ¶¨ ÏÑ†ÌõÑÎ∞∞</button>
                            <button type="button" class="relationship-btn" data-rel="alluring_neighbor">üè† Îß§ÌòπÏ†ÅÏù∏ Ïù¥ÏõÉ</button>
                        </div>
                        <input type="hidden" id="charRelationship" />
                    </div>

                    <!-- Ïô∏Î™® ÏÑ§Ï†ï -->
                    <div class="char-category">
                        <h3>‚ú® Ïô∏Î™® ÏÑ§Ï†ï</h3>
                        <div class="appearance-grid">
                            <div class="form-group">
                                <label>Ìó§Ïñ¥ Ïä§ÌÉÄÏùº</label>
                                <select id="charHair">
                                    <option value="long_straight">üíã ÏÑπÏãúÌïú Í∏¥ ÏÉùÎ®∏Î¶¨</option>
                                    <option value="shoulder_wave">üåä Îß§ÌòπÏ†ÅÏù∏ Ïõ®Ïù¥Î∏å</option>
                                    <option value="short_bob">üíá‚Äç‚ôÄÔ∏è ÎèÑÎ∞úÏ†ÅÏù∏ Îã®Î∞ú</option>
                                    <option value="ponytail">üéÄ Ïú†ÌòπÏ†ÅÏù∏ Ìè¨ÎãàÌÖåÏùº</option>
                                    <option value="curly_volume">üî• Î≥ºÎ•® ÏûàÎäî Ïª¨</option>
                                    <option value="messy_sexy">üòà ÏÑπÏãúÌïú Î¨¥Ï°∞Í±¥ Î®∏Î¶¨</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Îàà Î™®Ïñë</label>
                                <select id="charEyes">
                                    <option value="seductive_eyes">üòà Ïú†ÌòπÏ†ÅÏù∏ ÎààÎß§</option>
                                    <option value="almond_elegant">üòå ÏïÑÎ™¨ÎìúÌòï Ïö∞ÏïÑÌïú</option>
                                    <option value="cat_like">üò∏ Í≥†ÏñëÏù¥ Í∞ôÏùÄ</option>
                                    <option value="mysterious_deep">üåô Ïã†ÎπÑÎ°úÏö¥ ÍπäÏùÄ Îàà</option>
                                    <option value="sultry_gaze">üíã Í¥ÄÎä•Ï†ÅÏù∏ ÏãúÏÑ†</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>ÌÇ§/Ï≤¥Ìòï</label>
                                <select id="charBody">
                                    <option value="petite_sexy">üíã ÏûëÏßÄÎßå ÏÑπÏãúÌïú (155-160cm)</option>
                                    <option value="average_attractive">üî• Îß§Î†•Ï†ÅÏù∏ ÌèâÍ∑† (160-165cm)</option>
                                    <option value="tall_elegant">‚ú® Ïö∞ÏïÑÌïòÍ≤å ÌÇ§ ÌÅ∞ (165-170cm)</option>
                                    <option value="model_like">üëë Î™®Îç∏ Í∞ôÏùÄ (170cm+)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Í∞ÄÏä¥ ÏÇ¨Ïù¥Ï¶à</label>
                                <select id="charBust">
                                    <option value="A">AÏªµ (ÏÜåÎã¥ÌïòÍ≥† Í∑ÄÏó¨Ïö¥)</option>
                                    <option value="B">BÏªµ (ÏûêÏó∞Ïä§ÎüΩÍ≥† ÏòàÏÅú)</option>
                                    <option value="C">CÏªµ (Ï†ÅÎãπÌïòÍ≥† Îß§Î†•Ï†ÅÏù∏)</option>
                                    <option value="D">DÏªµ (ÌíçÎßåÌïòÍ≥† Î≥ºÎ•®Í∞ê ÏûàÎäî)</option>
                                    <option value="E">EÏªµ (Í∏ÄÎûòÎ®∏Îü¨Ïä§ÌïòÍ≥† ÏÑπÏãúÌïú)</option>
                                    <option value="F">FÏªµ (ÏïïÎèÑÏ†ÅÏúºÎ°ú ÌíçÎßåÌïú)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>ÌóàÎ¶¨/ÏóâÎç©Ïù¥</label>
                                <select id="charWaistHip">
                                    <option value="Ïä¨Î¶º">Ïä¨Î¶º</option>
                                    <option value="Í∏ÄÎûòÎ®∏">Í∏ÄÎûòÎ®∏</option>
                                    <option value="Î™®ÎûòÏãúÍ≥Ñ">Î™®ÎûòÏãúÍ≥Ñ</option>
                                    <option value="Ïö¥ÎèôÏ≤¥Ìòï">Ïö¥ÎèôÏ≤¥Ìòï</option>
                                    <option value="ÌíçÎßå">ÌíçÎßå</option>
                                    <option value="Í∑†Ìòï">Í∑†Ìòï</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Ìå®ÏÖò Ïä§ÌÉÄÏùº</label>
                                <select id="charStyle">
                                    <option value="ÏÑπÏãú">ÏÑπÏãú</option>
                                    <option value="Ïö∞ÏïÑ">Ïö∞ÏïÑ</option>
                                    <option value="Ï∫êÏ£ºÏñº">Ï∫êÏ£ºÏñº</option>
                                    <option value="ÌÅêÌä∏">ÌÅêÌä∏</option>
                                    <option value="ÎèÑÎ∞úÏ†Å">ÎèÑÎ∞úÏ†Å</option>
                                    <option value="ÌÅ¥ÎûòÏãù">ÌÅ¥ÎûòÏãù</option>
                                    <option value="Ìä∏Î†åÎîî">Ìä∏Î†åÎîî</option>
                                    <option value="Î≥¥Ìó§ÎØ∏Ïïà">Î≥¥Ìó§ÎØ∏Ïïà</option>
                                </select>
                            </div>
                        </div>

                        <!-- üÜï ÏûêÏã†ÏûàÎäî Î∂ÄÏúÑ -->
                        <div class="form-group">
                            <label>‚ú® ÏûêÏã†ÏûàÎäî Î∂ÄÏúÑ (ÏµúÎåÄ 3Í∞ú ÏÑ†ÌÉù)</label>
                            <div class="confident-parts-grid">
                                <button type="button" class="confident-part-btn" data-feature="beautiful_face">üòç ÏïÑÎ¶ÑÎã§Ïö¥ ÏñºÍµ¥</button>
                                <button type="button" class="confident-part-btn" data-feature="seductive_eyes">üëÅÔ∏è Ïú†ÌòπÏ†ÅÏù∏ Îàà</button>
                                <button type="button" class="confident-part-btn" data-feature="sexy_lips">üíã ÏÑπÏãúÌïú ÏûÖÏà†</button>
                                <button type="button" class="confident-part-btn" data-feature="elegant_neck">ü¶¢ Ïö∞ÏïÑÌïú Î™©ÏÑ†</button>
                                <button type="button" class="confident-part-btn" data-feature="attractive_chest">üíó Îß§Î†•Ï†ÅÏù∏ Í∞ÄÏä¥</button>
                                <button type="button" class="confident-part-btn" data-feature="slim_waist">‚è≥ ÏûòÎ°ùÌïú ÌóàÎ¶¨</button>
                                <button type="button" class="confident-part-btn" data-feature="curvy_hips">üçë Í≥°ÏÑ†ÎØ∏ ÏûàÎäî ÏóâÎç©Ïù¥</button>
                                <button type="button" class="confident-part-btn" data-feature="long_legs">ü¶µ Í∏¥ Îã§Î¶¨</button>
                                <button type="button" class="confident-part-btn" data-feature="soft_skin">‚ú® Î∂ÄÎìúÎü¨Ïö¥ ÌîºÎ∂Ä</button>
                            </div>
                            <input type="hidden" id="charFeatureElements" />
                        </div>

                        <div class="form-group">
                            <label>üíÉ ÏÑπÏãúÌè¨Ï¶à (ÏµúÎåÄ 2Í∞ú ÏÑ†ÌÉù)</label>
                            <div class="seductive-poses-grid">
                                <button type="button" class="seductive-pose-btn" data-habit="ÏûÖÏà†Íπ®Î¨ºÍ∏∞">üíã ÏûÖÏà†Íπ®Î¨ºÍ∏∞</button>
                                <button type="button" class="seductive-pose-btn" data-habit="ÌóàÎ¶¨ÍµΩÌûàÍ∏∞">üçë ÌóàÎ¶¨ÍµΩÌûàÍ∏∞</button>
                                <button type="button" class="seductive-pose-btn" data-habit="Îã§Î¶¨Íº¨Í∏∞">ü¶µ Îã§Î¶¨Íº¨Í∏∞</button>
                                <button type="button" class="seductive-pose-btn" data-habit="Ïñ¥Íπ®ÎìúÎü¨ÎÇ¥Í∏∞">üëó Ïñ¥Íπ®ÎìúÎü¨ÎÇ¥Í∏∞</button>
                                <button type="button" class="seductive-pose-btn" data-habit="Î™∏Í∏∞Ïö∏Ïù¥Í∏∞">üíÉ Î™∏Í∏∞Ïö∏Ïù¥Í∏∞</button>
                                <button type="button" class="seductive-pose-btn" data-habit="ÏúôÌÅ¨ÌïòÍ∏∞">üòâ ÏúôÌÅ¨ÌïòÍ∏∞</button>
                                <button type="button" class="seductive-pose-btn" data-habit="Ïä§Ìä∏Î†àÏπ≠">ü§∏‚Äç‚ôÄÔ∏è Ïä§Ìä∏Î†àÏπ≠</button>
                                <button type="button" class="seductive-pose-btn" data-habit="Ìó§Ïñ¥ÌÑ∞Ïπò">üíá‚Äç‚ôÄÔ∏è Ìó§Ïñ¥ÌÑ∞Ïπò</button>
                                <button type="button" class="seductive-pose-btn" data-habit="Ïú†ÌòπÏ†ÅÏãúÏÑ†">üëÄ Ïú†ÌòπÏ†ÅÏãúÏÑ†</button>
                            </div>
                            <input type="hidden" id="charSensualHabits" />
                        </div>

                        <div class="form-group">
                            <label>üíï Ìù•Î∂ÑÏãú Î∞òÏùë (ÏµúÎåÄ 2Í∞ú ÏÑ†ÌÉù)</label>
                            <div class="body-language-grid">
                                <button type="button" class="body-language-btn" data-language="ÏñºÍµ¥Î∞úÍ∑∏Î†àÏßê">üòä ÏñºÍµ¥Î∞úÍ∑∏Î†àÏßê</button>
                                <button type="button" class="body-language-btn" data-language="Ïà®ÏÜåÎ¶¨Í±∞Ïπ†Ïñ¥Ïßê">üòÆ‚Äçüí® Ïà®ÏÜåÎ¶¨Í±∞Ïπ†Ïñ¥Ïßê</button>
                                <button type="button" class="body-language-btn" data-language="ÎààÎèôÏûêÌùîÎì§Î¶º">üëÄ ÎààÎèôÏûêÌùîÎì§Î¶º</button>
                                <button type="button" class="body-language-btn" data-language="ÏûÖÏà†Î∂ÄÎ•¥Î•¥">üíã ÏûÖÏà†Î∂ÄÎ•¥Î•¥</button>
                                <button type="button" class="body-language-btn" data-language="Î™∏Îñ®Î¶º">ü´® Î™∏Îñ®Î¶º</button>
                                <button type="button" class="body-language-btn" data-language="Î™©ÏÜåÎ¶¨Îñ®Î¶º">üó£Ô∏è Î™©ÏÜåÎ¶¨Îñ®Î¶º</button>
                                <button type="button" class="body-language-btn" data-language="Ïã¨Ïû•ÎëêÍ∑ºÍ±∞Î¶º">üíì Ïã¨Ïû•ÎëêÍ∑ºÍ±∞Î¶º</button>
                                <button type="button" class="body-language-btn" data-language="ÏÜêÎÅùÎñ®Î¶º">‚úã ÏÜêÎÅùÎñ®Î¶º</button>
                                <button type="button" class="body-language-btn" data-language="ÏãúÏÑ†ÌîºÌï®">üôà ÏãúÏÑ†ÌîºÌï®</button>
                            </div>
                            <input type="hidden" id="charBodyLanguage" />
                        </div>
                    </div>

                    <!-- üí´ Îß§Î†• ÌîÑÎ°úÌïÑ (ÏÉàÎ°ú Ï∂îÍ∞Ä) -->
                    <div class="char-category">
                        <h3>üí´ Îß§Î†• ÌîÑÎ°úÌïÑ</h3>
                        <div class="appeal-grid">
                            <div class="form-group">
                                <label>üí´ Îß§Î†• Ìè¨Ïù∏Ìä∏ (ÏµúÎåÄ 4Í∞ú ÏÑ†ÌÉù)</label>
                                <div class="charm-options">
                                    <button type="button" class="charm-btn" data-charm="infectious_smile">üòä Ï†ÑÏóºÏÑ± ÏûàÎäî ÎØ∏ÏÜå</button>
                                    <button type="button" class="charm-btn" data-charm="witty_banter">üí¨ Ïû¨ÏπòÏûàÎäî ÎåÄÌôî</button>
                                    <button type="button" class="charm-btn" data-charm="confident_touch">ü§≤ ÏûêÏã†Í∞ê ÏûàÎäî ÌÑ∞Ïπò</button>
                                    <button type="button" class="charm-btn" data-charm="mysterious_aura">üîÆ Ïã†ÎπÑÎ°úÏö¥ Î∂ÑÏúÑÍ∏∞</button>
                                    <button type="button" class="charm-btn" data-charm="graceful_movements">üíÉ Ïö∞ÏïÑÌïú ÏõÄÏßÅÏûÑ</button>
                                    <button type="button" class="charm-btn" data-charm="expressive_eyes">üëÄ ÌëúÌòÑÎ†• ÏûàÎäî ÎààÎπõ</button>
                                    <button type="button" class="charm-btn" data-charm="sweet_voice">üéµ Îã¨ÏΩ§Ìïú Î™©ÏÜåÎ¶¨</button>
                                    <button type="button" class="charm-btn" data-charm="elegant_posture">üë∏ Ïö∞ÏïÑÌïú ÏûêÏÑ∏</button>
                                    <button type="button" class="charm-btn" data-charm="cute_laugh">üòÑ Í∑ÄÏó¨Ïö¥ ÏõÉÏùåÏÜåÎ¶¨</button>
                                    <button type="button" class="charm-btn" data-charm="natural_beauty">üåø ÏûêÏó∞Ïä§Îü¨Ïö¥ ÏïÑÎ¶ÑÎã§ÏõÄ</button>
                                    <button type="button" class="charm-btn" data-charm="intelligent_eyes">ü§ì ÏßÄÏ†ÅÏù∏ ÎààÎπõ</button>
                                    <button type="button" class="charm-btn" data-charm="warm_personality">‚òÄÔ∏è Îî∞ÎúªÌïú ÏÑ±Í≤©</button>
                                    <button type="button" class="charm-btn" data-charm="playful_attitude">üé≠ Ïû•ÎÇúÏä§Îü¨Ïö¥ ÌÉúÎèÑ</button>
                                    <button type="button" class="charm-btn" data-charm="gentle_touch">ü§ó Î∂ÄÎìúÎü¨Ïö¥ ÌÑ∞Ïπò</button>
                                    <button type="button" class="charm-btn" data-charm="captivating_smile">‚ú® Îß§ÌòπÏ†ÅÏù∏ ÎØ∏ÏÜå</button>
                                </div>
                                <button type="button" class="btn-random" onclick="randomizeCharms()">üé≤ ÎûúÎç§ ÏÑ†ÌÉù</button>
                            </div>

                            <div class="form-group">
                                <label>Í∞êÏÑ± ÏßÄÎä• (1-10): <span id="eiValue">7</span></label>
                                <input type="range" id="emotionalIntelligence" min="1" max="10" value="7" oninput="document.getElementById('eiValue').textContent = this.value">
                                <button type="button" class="btn-random" onclick="randomizeEI()">üé≤</button>
                            </div>

                            <div class="form-group">
                                <label>ÏûêÏã†Í∞ê ÏàòÏ§Ä (1-10): <span id="confidenceValue">8</span></label>
                                <input type="range" id="confidenceLevel" min="1" max="10" value="8" oninput="document.getElementById('confidenceValue').textContent = this.value">
                                <button type="button" class="btn-random" onclick="randomizeConfidence()">üé≤</button>
                            </div>

                            <div class="form-group">
                                <label>Ïã†ÎπÑÎ°úÏõÄ (1-10): <span id="mysteryValue">6</span></label>
                                <input type="range" id="mysteryFactor" min="1" max="10" value="6" oninput="document.getElementById('mysteryValue').textContent = this.value">
                                <button type="button" class="btn-random" onclick="randomizeMystery()">üé≤</button>
                            </div>

                            <div class="form-group">
                                <label>ÏÑ±Ï†Å Ìò∏Í∏∞Ïã¨ (1-10): <span id="sexualCuriosityValue">5</span></label>
                                <input type="range" id="sexualCuriosity" min="1" max="10" value="5" oninput="document.getElementById('sexualCuriosityValue').textContent = this.value">
                                <button type="button" class="btn-random" onclick="randomizeSexualCuriosity()">üé≤</button>
                            </div>

                            <div class="form-group">
                                <label>ÏÑ±Ï†Å Ïø®Ï†ÅÎèÑ (1-10): <span id="sexualComfortValue">5</span></label>
                                <input type="range" id="sexualComfort" min="1" max="10" value="5" oninput="document.getElementById('sexualComfortValue').textContent = this.value">
                                <button type="button" class="btn-random" onclick="randomizeSexualComfort()">üé≤</button>
                            </div>
                        </div>
                    </div>

                    <!-- üéÅ Ï¢ãÏïÑÌïòÎäî ÏÑ†Î¨º (ÏÉàÎ°ú Ï∂îÍ∞Ä) -->
                    <div class="char-category">
                        <h3>üéÅ Ï¢ãÏïÑÌïòÎäî ÏÑ†Î¨º</h3>
                        <div class="favorite-gifts-section">
                            <div class="form-group">
                                <label>üíù ÏÑ†Ìò∏ÌïòÎäî ÏÑ†Î¨º (ÏµúÎåÄ 3Í∞ú ÏÑ†ÌÉù)</label>
                                <div class="favorite-gifts-grid">
                                    <button type="button" class="gift-btn" data-gift="luxury_lingerie">üíé Í≥†Í∏â ÏÜçÏò∑</button>
                                    <button type="button" class="gift-btn" data-gift="expensive_car">üöó Í≥†Í∏â ÏûêÎèôÏ∞®</button>
                                    <button type="button" class="gift-btn" data-gift="jewelry">üíç Î≥¥ÏÑùÎ•ò</button>
                                    <button type="button" class="gift-btn" data-gift="perfume">üåπ Ìñ•Ïàò</button>
                                    <button type="button" class="gift-btn" data-gift="designer_bag">üëú Î™ÖÌíà Í∞ÄÎ∞©</button>
                                    <button type="button" class="gift-btn" data-gift="flowers">üå∏ ÍΩÉÎã§Î∞ú</button>
                                    <button type="button" class="gift-btn" data-gift="chocolate">üç´ Í≥†Í∏â Ï¥àÏΩúÎ¶ø</button>
                                    <button type="button" class="gift-btn" data-gift="spa_voucher">üßñ‚Äç‚ôÄÔ∏è Ïä§Ìåå Ïù¥Ïö©Í∂å</button>
                                    <button type="button" class="gift-btn" data-gift="wine">üç∑ Í≥†Í∏â ÏôÄÏù∏</button>
                                    <button type="button" class="gift-btn" data-gift="books">üìö Ï¢ãÏïÑÌïòÎäî Ï±Ö</button>
                                    <button type="button" class="gift-btn" data-gift="cute_accessories">üéÄ Í∑ÄÏó¨Ïö¥ Ïï°ÏÑ∏ÏÑúÎ¶¨</button>
                                    <button type="button" class="gift-btn" data-gift="travel_package">‚úàÔ∏è Ïó¨Ìñâ Ìå®ÌÇ§ÏßÄ</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- üß† Ïã¨Î¶¨Ï†Å ÍπäÏù¥ (ÏÉàÎ°ú Ï∂îÍ∞Ä) -->
                    <div class="char-category">
                        <h3>üß† Ïã¨Î¶¨Ï†Å ÍπäÏù¥</h3>
                        <div class="psychological-grid">
                            <div class="form-group">
                                <label>ÌïµÏã¨ ÏöïÍµ¨ (ÏµúÎåÄ 3Í∞ú ÏÑ†ÌÉù)</label>
                                <div class="desires-options">
                                    <button type="button" class="desire-btn" data-desire="meaningful_connection">üíï ÏùòÎØ∏ÏûàÎäî Ïó∞Í≤∞</button>
                                    <button type="button" class="desire-btn" data-desire="creative_expression">üé® Ï∞ΩÏ°∞Ï†Å ÌëúÌòÑ</button>
                                    <button type="button" class="desire-btn" data-desire="personal_growth">üå± Í∞úÏù∏Ï†Å ÏÑ±Ïû•</button>
                                    <button type="button" class="desire-btn" data-desire="adventure_excitement">‚ö° Î™®ÌóòÍ≥º ÏûêÍ∑π</button>
                                    <button type="button" class="desire-btn" data-desire="intellectual_stimulation">üß† ÏßÄÏ†Å ÏûêÍ∑π</button>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Í≤ΩÍ≥ÑÏÑ† ÏÑ§Ï†ï</label>
                                <select id="comfortLevel">
                                    <option value="light_flirtation">üå∏ Í∞ÄÎ≤ºÏö¥ ÌîåÎü¨ÌåÖ</option>
                                    <option value="moderate_flirtation">üíã Ï†ÅÎãπÌïú ÌîåÎü¨ÌåÖ</option>
                                    <option value="intense_chemistry">üî• Í∞ïÌïú ÏºÄÎØ∏</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Í¥ÄÍ≥Ñ Î∞úÏ†Ñ ÏÜçÎèÑ</label>
                                <select id="escalationPace">
                                    <option value="very_gradual">üêå Îß§Ïö∞ Ï≤úÏ≤úÌûà</option>
                                    <option value="gradual_building">üö∂‚Äç‚ôÄÔ∏è Ï†êÏßÑÏ†ÅÏúºÎ°ú</option>
                                    <option value="moderate_pace">üèÉ‚Äç‚ôÄÔ∏è Ï†ÅÎãπÌïú ÏÜçÎèÑ</option>
                                    <option value="quick_progression">üí® Îπ†Î•∏ ÏßÑÏ†Ñ</option>
                                </select>
                            </div>

                            <!-- üë® ÎÇ®ÏûêÎ•º Î≥º Îïå ÏµúÏö∞ÏÑ†Ïãú ÌïòÎäî Í≤É (ÏÉàÎ°ú Ï∂îÍ∞Ä) -->
                            <div class="form-group">
                                <label>üë® ÎÇ®ÏûêÎ•º Î≥º Îïå ÏµúÏö∞ÏÑ†Ïãú ÌïòÎäî Í≤É (ÏµúÎåÄ 3Í∞ú ÏÑ†ÌÉù)</label>
                                <div class="male-priority-grid">
                                    <button type="button" class="male-priority-btn" data-priority="appearance">üòç Ïô∏Î™®ÏôÄ Ï≤¥Ìòï</button>
                                    <button type="button" class="male-priority-btn" data-priority="personality">üòä ÏÑ±Í≤©Í≥º Ïù∏ÏÑ±</button>
                                    <button type="button" class="male-priority-btn" data-priority="intelligence">üß† ÏßÄÏÑ±Í≥º ÍµêÏñë</button>
                                    <button type="button" class="male-priority-btn" data-priority="humor">üòÇ Ïú†Î®∏ÏôÄ Ïû¨Ïπò</button>
                                    <button type="button" class="male-priority-btn" data-priority="financial_stability">üí∞ Í≤ΩÏ†úÎ†•Í≥º ÏïàÏ†ïÏÑ±</button>
                                    <button type="button" class="male-priority-btn" data-priority="emotional_maturity">ü•∞ Í∞êÏ†ïÏ†Å ÏÑ±ÏàôÌï®</button>
                                    <button type="button" class="male-priority-btn" data-priority="ambition">üéÜ Ïó¥Ï†ïÍ≥º Î™©ÌëúÏùòÏãù</button>
                                    <button type="button" class="male-priority-btn" data-priority="communication">üí¨ ÏÜåÌÜµÎä•Î†•Í≥º Í≤ΩÏ≤≠</button>
                                    <button type="button" class="male-priority-btn" data-priority="reliability">ü§ù Ïã†Î¢∞ÏÑ±Í≥º ÏÑ±Ïã§Ìï®</button>
                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- üìã Í≥ºÍ±∞ Ïù¥Î†• (ÏÉàÎ°ú Ï∂îÍ∞Ä) -->
                    <div class="char-category">
                        <h3>üìã Í≥ºÍ±∞ Ïù¥Î†•</h3>
                        <div class="history-grid">
                            <div class="form-group">
                                <label>ÎÇ®ÏûêÏπúÍµ¨ Í≤ΩÌóò Ïàò (0-10): <span id="boyfriendCountValue">2</span></label>
                                <input type="range" id="boyfriendCount" min="0" max="10" value="2" oninput="document.getElementById('boyfriendCountValue').textContent = this.value">
                            </div>

                            <div class="form-group">
                                <label>Ï¢ãÏïÑÌïòÎäî Ïä§ÌÇ®Ïã≠ (ÏµúÎåÄ 4Í∞ú ÏÑ†ÌÉù)</label>
                                <div class="skinship-options">
                                    <button type="button" class="skinship-btn" data-skinship="hand_holding">ü§ù ÏÜê Ïû°Í∏∞</button>
                                    <button type="button" class="skinship-btn" data-skinship="light_hugs">ü§ó Í∞ÄÎ≤ºÏö¥ Ìè¨Ïòπ</button>
                                    <button type="button" class="skinship-btn" data-skinship="cheek_kiss">üòò Î≥º ÌÇ§Ïä§</button>
                                    <button type="button" class="skinship-btn" data-skinship="shoulder_massage">üíÜ‚Äç‚ôÄÔ∏è Ïñ¥Íπ® ÎßàÏÇ¨ÏßÄ</button>
                                    <button type="button" class="skinship-btn" data-skinship="head_patting">üëã Î®∏Î¶¨ Ïì∞Îã§Îì¨Í∏∞</button>
                                    <button type="button" class="skinship-btn" data-skinship="back_rubbing">üñêÔ∏è Îì± Î¨∏ÏßÄÎ•¥Í∏∞</button>
                                    <button type="button" class="skinship-btn" data-skinship="intimate_cuddling">üíï ÍπäÏùÄ Ìè¨Ïòπ</button>
                                    <button type="button" class="skinship-btn" data-skinship="passionate_kiss">üíã ÏßÑÌïú ÌÇ§Ïä§</button>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Ïó∞Ïï† Í≤ΩÌóò ÏàòÏ§Ä</label>
                                <select id="relationshipExperience">
                                    <option value="beginner">üå± Ï¥àÎ≥¥ (1-2Î≤à)</option>
                                    <option value="intermediate">üåø Î≥¥ÌÜµ (3-5Î≤à)</option>
                                    <option value="experienced">üå≥ Í≤ΩÌóò ÎßéÏùå (6-8Î≤à)</option>
                                    <option value="very_experienced">üå¥ Îß§Ïö∞ Í≤ΩÌóò ÎßéÏùå (9Î≤à Ïù¥ÏÉÅ)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Ï≤´ Í≤ΩÌóò ÎÇòÏù¥</label>
                                <select id="firstExperienceAge">
                                    <option value="early_teens">üå∏ Ï§ëÌïôÍµê (13-15ÏÑ∏)</option>
                                    <option value="late_teens">üå∫ Í≥†Îì±ÌïôÍµê (16-18ÏÑ∏)</option>
                                    <option value="early_twenties">üåª ÎåÄÌïôÍµê Ï¥àÍ∏∞ (19-21ÏÑ∏)</option>
                                    <option value="mid_twenties">üåπ ÎåÄÌïôÍµê ÌõÑÍ∏∞/ÏßÅÏû• Ï¥àÍ∏∞ (22-25ÏÑ∏)</option>
                                    <option value="late_twenties">üå∑ ÏßÅÏû•Ïù∏ (26-29ÏÑ∏)</option>
                                    <option value="no_experience">‚ùå Í≤ΩÌóò ÏóÜÏùå</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- ÎÇ¥Î©¥/ÏäµÍ¥Ä -->
                    <div class="char-category">
                        <h3>üí´ ÎÇ¥Î©¥ & Ï∑®ÎØ∏</h3>
                        <div class="hobby-interests">
                            <div class="form-group">
                                <label>Ï∑®ÎØ∏ ÌôúÎèô (ÏµúÎåÄ 3Í∞ú ÏÑ†ÌÉù)</label>
                                <div class="hobby-options">
                                    <button type="button" class="hobby-btn" data-hobby="reading">üìö ÎèÖÏÑú</button>
                                    <button type="button" class="hobby-btn" data-hobby="drawing">üé® Í∑∏Î¶º Í∑∏Î¶¨Í∏∞</button>
                                    <button type="button" class="hobby-btn" data-hobby="music">üéµ ÏùåÏïÖ Í∞êÏÉÅ</button>
                                    <button type="button" class="hobby-btn" data-hobby="photography">üì∑ ÏÇ¨ÏßÑ Ï¥¨ÏòÅ</button>
                                    <button type="button" class="hobby-btn" data-hobby="cooking">üç≥ ÏöîÎ¶¨</button>
                                    <button type="button" class="hobby-btn" data-hobby="exercise">üèÉ‚Äç‚ôÄÔ∏è Ïö¥Îèô</button>
                                    <button type="button" class="hobby-btn" data-hobby="travel">‚úàÔ∏è Ïó¨Ìñâ</button>
                                    <button type="button" class="hobby-btn" data-hobby="movies">üé¨ ÏòÅÌôî Í∞êÏÉÅ</button>
                                    <button type="button" class="hobby-btn" data-hobby="gaming">üéÆ Í≤åÏûÑ</button>
                                    <button type="button" class="hobby-btn" data-hobby="dancing">üíÉ ÎåÑÏä§</button>
                                    <button type="button" class="hobby-btn" data-hobby="shopping">üõçÔ∏è ÏáºÌïë</button>
                                    <button type="button" class="hobby-btn" data-hobby="cafe">‚òï Ïπ¥Ìéò ÌÉêÎ∞©</button>
                                </div>
                                <input type="hidden" id="charHobbies" />
                                    </div>
                            <div class="form-group">
                                <label>Í∞ÄÏπòÍ¥Ä</label>
                                <select id="charValues">
                                    <option value="love_family">Í∞ÄÏ°±Í≥º ÏÇ¨ÎûëÏùÑ Ï§ëÏãú</option>
                                    <option value="personal_growth">Í∞úÏù∏Ï†Å ÏÑ±Ïû•ÏùÑ Ï∂îÍµ¨</option>
                                    <option value="helping_others">ÌÉÄÏù∏ÏùÑ ÎèïÎäî Í≤ÉÏùÑ Ï¢ãÏïÑÌï®</option>
                                    <option value="creative_expression">Ï∞ΩÏùòÏ†Å ÌëúÌòÑÏùÑ Ï§ëÏãú</option>
                                    <option value="stability_security">ÏïàÏ†ïÍ≥º Î≥¥ÏïàÏùÑ Ï§ëÏãú</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- ÎßêÌà¨/ÎåÄÌôî Ïä§ÌÉÄÏùº -->
                    <div class="char-category">
                        <h3>üí¨ ÎßêÌà¨ & ÎåÄÌôî Ïä§ÌÉÄÏùº</h3>
                        <div class="speech-style-grid">
                            <div class="speech-options">
                                <button type="button" class="speech-btn" data-speech="sensual_whisper">üíã Í¥ÄÎä•Ï†ÅÏù¥Í≥† ÏÜçÏÇ≠Ïù¥Îäî</button>
                                <button type="button" class="speech-btn" data-speech="mature_elegant">üëë ÏÑ±ÏàôÌïòÍ≥† Ïö∞ÏïÑÌïú</button>
                                <button type="button" class="speech-btn" data-speech="playful_seductive">üé™ Ïû•ÎÇúÏä§ÎüΩÍ≥† Ïú†ÌòπÏ†ÅÏù∏</button>
                                <button type="button" class="speech-btn" data-speech="sexy_flirty">üòà ÏÑπÏãúÌïòÍ≥† ÎèÑÎ∞úÏ†ÅÏù∏</button>
                                <button type="button" class="speech-btn" data-speech="mysterious_seductive">üåô Ïã†ÎπÑÎ°≠Í≥† Îß§ÌòπÏ†ÅÏù∏</button>
                                <button type="button" class="speech-btn" data-speech="confident_alluring">üí™ ÏûêÏã†Í∞ê ÏûàÍ≥† Îß§Î†•Ï†ÅÏù∏</button>
                                <button type="button" class="speech-btn" data-speech="sultry_dominant">üî• ÎÜçÏóºÌïòÍ≥† Ï£ºÎèÑÏ†ÅÏù∏</button>
                                <button type="button" class="speech-btn" data-speech="sweet_tempting">üçØ Îã¨ÏΩ§ÌïòÍ≤å Ïú†ÌòπÌïòÎäî</button>
                                <button type="button" class="speech-btn" data-speech="bold_provocative">üòè ÎåÄÎã¥ÌïòÍ≥† ÎèÑÎ∞úÏ†ÅÏù∏</button>
                            </div>
                            <div class="form-group">
                                <label>üí¨ Ï£ºÎ°úÏì∞Îäî Ìò∏Ïπ≠</label>
                                <input type="text" id="charSpeechHabit" placeholder="ÏÉÅÎåÄÎ∞©ÏùÑ Î∂ÄÎ•¥Îäî Ìò∏Ïπ≠ (Ïòà: Ïò§Îπ†, ÏÑ†Î∞∞, Ïù¥Î¶Ñ Îì±)" value="Ïò§Îπ†" />
                            </div>
                            <input type="hidden" id="charSpeechStyle" />
                        </div>
                    </div>

                    <!-- Ïû•Î•¥/ÏãúÎÇòÎ¶¨Ïò§ ÏÑ§Ï†ï ÏÑπÏÖò Ï†úÍ±∞Îê® -->

                    <!-- üéØ ÎåÄÌôîÏó≠Ìïô (Ïã†Í∑ú Ï∂îÍ∞Ä) -->
                    <div class="char-category">
                        <h3>üí¨ ÎåÄÌôîÏó≠Ìïô</h3>
                        <div class="conversation-dynamics">
                            <div class="form-group">
                                <label>ÌîåÎü¨ÌåÖ Ìå®ÌÑ¥ (ÏµúÎåÄ 3Í∞ú ÏÑ†ÌÉù)</label>
                                <div class="flirting-options">
                                    <button type="button" class="flirting-btn" data-flirting="subtle_teasing">üòä ÏùÄÍ∑ºÌïú ÎÜÄÎ¶º</button>
                                    <button type="button" class="flirting-btn" data-flirting="direct_compliments">üíï ÏßÅÏ†ëÏ†ÅÏù∏ Ïπ≠Ï∞¨</button>
                                    <button type="button" class="flirting-btn" data-flirting="playful_banter">üé™ Ïû•ÎÇúÏä§Îü¨Ïö¥ ÎÜçÎã¥</button>
                                    <button type="button" class="flirting-btn" data-flirting="gentle_touches">ü§ó Í∞ÄÎ≤ºÏö¥ Ïä§ÌÇ®Ïã≠</button>
                                    <button type="button" class="flirting-btn" data-flirting="eye_contact">üëÄ ÍπäÏùÄ ÎààÎßûÏ∂§</button>
                                    <button type="button" class="flirting-btn" data-flirting="mysterious_hints">üîÆ Ïã†ÎπÑÎ°úÏö¥ ÏïîÏãú</button>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Ïú†Î®∏Ïóê ÎåÄÌïú Î∞òÏùë</label>
                                <select id="humorResponse">
                                    <option value="giggles_easily">üòÑ ÏâΩÍ≤å ÏõÉÏñ¥Ï§å</option>
                                    <option value="witty_comeback">üé≠ Ïû¨ÏπòÏûàÍ≤å Î∞õÏïÑÏπ®</option>
                                    <option value="shy_smile">üòä ÏàòÏ§çÍ≤å ÎØ∏ÏÜå</option>
                                    <option value="playful_tease">üòè Ïû•ÎÇúÏä§ÎüΩÍ≤å ÎÜÄÎ¶º</option>
                                    <option value="dry_humor">üôÑ Í±¥Ï°∞Ìïú Ïú†Î®∏Î°ú ÏùëÏàò</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Ïπ≠Ï∞¨Ïóê ÎåÄÌïú Î∞òÏùë</label>
                                <select id="complimentResponse">
                                    <option value="gracefully_accepts">ü•∞ Ïö∞ÏïÑÌïòÍ≤å Î∞õÏïÑÎì§ÏûÑ</option>
                                    <option value="bashfully_denies">üò≥ Î∂ÄÎÅÑÎü¨ÏõåÌïòÎ©∞ Î∂ÄÏù∏</option>
                                    <option value="confidently_agrees">üòé ÏûêÏã†ÏûàÍ≤å ÎèôÏùò</option>
                                    <option value="returns_compliment">üíñ Ïπ≠Ï∞¨ÏúºÎ°ú ÌôîÎãµ</option>
                                    <option value="changes_subject">üòÖ ÌôîÏ†úÎ•º ÎèåÎ¶º</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Í¥ÄÏã¨ ÌëúÌòÑ Î∞òÏùë</label>
                                <select id="interestResponse">
                                    <option value="enthusiastic_sharing">‚ú® Ïó¥Ï†ïÏ†ÅÏúºÎ°ú Í≥µÏú†</option>
                                    <option value="curious_questions">ü§î Ìò∏Í∏∞Ïã¨ ÎßéÏùÄ ÏßàÎ¨∏</option>
                                    <option value="gentle_encouragement">üíï Î∂ÄÎìúÎü¨Ïö¥ Í≤©Î†§</option>
                                    <option value="playful_challenge">üòè Ïû•ÎÇúÏä§Îü¨Ïö¥ ÎèÑÏ†Ñ</option>
                                    <option value="thoughtful_listening">üéß ÏÇ¨Î†§ÍπäÏùÄ Í≤ΩÏ≤≠</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>ÎåÄÌôî ÌõÖ/Í¥ÄÏã¨ÏÇ¨ (ÏµúÎåÄ 4Í∞ú ÏÑ†ÌÉù)</label>
                                <div class="conversation-hooks">
                                    <button type="button" class="hook-btn" data-hook="travel_stories">‚úàÔ∏è Ïó¨Ìñâ Ïù¥ÏïºÍ∏∞</button>
                                    <button type="button" class="hook-btn" data-hook="food_culture">üçú ÏùåÏãù Î¨∏Ìôî</button>
                                    <button type="button" class="hook-btn" data-hook="music_movies">üéµ ÏùåÏïÖ/ÏòÅÌôî</button>
                                    <button type="button" class="hook-btn" data-hook="life_philosophy">üí≠ Ïù∏ÏÉù Ï≤†Ìïô</button>
                                    <button type="button" class="hook-btn" data-hook="future_dreams">üåü ÎØ∏Îûò Íøà</button>
                                    <button type="button" class="hook-btn" data-hook="childhood_memories">üë∂ Ïñ¥Î¶∞ ÏãúÏ†à</button>
                                    <button type="button" class="hook-btn" data-hook="work_passion">üíº ÏùºÍ≥º Ïó¥Ï†ï</button>
                                    <button type="button" class="hook-btn" data-hook="relationships">üíë Ïù∏Í∞ÑÍ¥ÄÍ≥Ñ</button>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>üó£Ô∏è ÎßêÌà¨ ÏäµÍ¥Ä (ÏµúÎåÄ 3Í∞ú ÏÑ†ÌÉù)</label>
                                <div class="speech-habits-grid">
                                    <button type="button" class="speech-habit-btn" data-habit="polite_ending">üôè Ï†ïÏ§ëÌïú Ïñ¥ÎØ∏ (~ÎÑ§Ïöî, ~Ïöî)</button>
                                    <button type="button" class="speech-habit-btn" data-habit="cute_ending">üéÄ Í∑ÄÏó¨Ïö¥ Ïñ¥ÎØ∏ (~Îãπ, ~ÏßÄ)</button>
                                    <button type="button" class="speech-habit-btn" data-habit="frequent_emoji">üòä Ïù¥Î™®Ìã∞ÏΩò ÏûêÏ£º ÏÇ¨Ïö©</button>
                                    <button type="button" class="speech-habit-btn" data-habit="exclamations">‚ùó Í∞êÌÉÑÏÇ¨ ÎßéÏù¥ ÏîÄ</button>
                                    <button type="button" class="speech-habit-btn" data-habit="english_mix">üåé ÏòÅÏñ¥ Îã®Ïñ¥ ÏÑûÏñ¥ ÎßêÌï®</button>
                                    <button type="button" class="speech-habit-btn" data-habit="slow_speech">üêå Ï≤úÏ≤úÌûà ÎßêÌïòÍ∏∞</button>
                                    <button type="button" class="speech-habit-btn" data-habit="giggle_often">üòÜ ÏõÉÏùåÏÜåÎ¶¨ ÏûêÏ£º ÎÉÑ</button>
                                    <button type="button" class="speech-habit-btn" data-habit="whisper_tone">ü§´ ÏÜçÏÇ≠Ïù¥Îäî ÌÜ§</button>
                                    <button type="button" class="speech-habit-btn" data-habit="repeat_words">üîÑ Ï§ëÏöîÌïú Îßê Î∞òÎ≥µ</button>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Ïñ¥Ìúò ÏàòÏ§Ä</label>
                                <select id="vocabularyRegister">
                                    <option value="casual_friendly">üòä Ï∫êÏ£ºÏñºÌïòÍ≥† ÏπúÍ∑ºÌï®</option>
                                    <option value="polite_formal">üé≠ Ï†ïÏ§ëÌïòÍ≥† Í≤©ÏãùÏûàÏùå</option>
                                    <option value="intellectual">üß† ÏßÄÏ†ÅÏù¥Í≥† ÏÑ∏Î†®Îê®</option>
                                    <option value="trendy_modern">üì± Ìä∏Î†åÎîîÌïòÍ≥† ÌòÑÎåÄÏ†Å</option>
                                    <option value="warm_nurturing">ü§ó Îî∞ÎúªÌïòÍ≥† Ìè¨Ïö©Ï†Å</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>ÌóàÏö© ÎåÄÌôî Ï£ºÏ†ú (ÏµúÎåÄ 5Í∞ú ÏÑ†ÌÉù)</label>
                                <div class="allowed-motifs">
                                    <button type="button" class="motif-btn" data-motif="romance_love">üíï Î°úÎß®Ïä§/ÏÇ¨Îûë</button>
                                    <button type="button" class="motif-btn" data-motif="dreams_goals">üåü ÍøàÍ≥º Î™©Ìëú</button>
                                    <button type="button" class="motif-btn" data-motif="personal_growth">üå± Í∞úÏù∏Ï†Å ÏÑ±Ïû•</button>
                                    <button type="button" class="motif-btn" data-motif="art_creativity">üé® ÏòàÏà†Í≥º Ï∞ΩÏûë</button>
                                    <button type="button" class="motif-btn" data-motif="nature_travel">üå∏ ÏûêÏó∞Í≥º Ïó¨Ìñâ</button>
                                    <button type="button" class="motif-btn" data-motif="friendship">üë´ Ïö∞Ï†ïÍ≥º Ïù∏Ïó∞</button>
                                    <button type="button" class="motif-btn" data-motif="philosophy">üí≠ Ï≤†ÌïôÏ†Å ÎåÄÌôî</button>
                                    <button type="button" class="motif-btn" data-motif="daily_life">üè† ÏùºÏÉÅ Ïù¥ÏïºÍ∏∞</button>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>üö´ Í∏àÏßÄ Î∂ÑÏïº (ÏµúÎåÄ 4Í∞ú ÏÑ†ÌÉù)</label>
                                <div class="forbidden-topics-grid">
                                    <button type="button" class="forbidden-topic-btn" data-topic="politics">üèõÔ∏è Ï†ïÏπò</button>
                                    <button type="button" class="forbidden-topic-btn" data-topic="religion">‚õ™ Ï¢ÖÍµê</button>
                                    <button type="button" class="forbidden-topic-btn" data-topic="military">ü™ñ Íµ∞ÎåÄ</button>
                                    <button type="button" class="forbidden-topic-btn" data-topic="sports">‚öΩ Ïä§Ìè¨Ï∏†</button>
                                    <button type="button" class="forbidden-topic-btn" data-topic="finance">üí∞ Îèà/Ìà¨Ïûê</button>
                                    <button type="button" class="forbidden-topic-btn" data-topic="health">üè• Í±¥Í∞ï/ÏùòÎ£å</button>
                                    <button type="button" class="forbidden-topic-btn" data-topic="family">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Í∞ÄÏ°± Î¨∏Ï†ú</button>
                                    <button type="button" class="forbidden-topic-btn" data-topic="work_stress">üíº ÏßÅÏû• Ïä§Ìä∏Î†àÏä§</button>
                                    <button type="button" class="forbidden-topic-btn" data-topic="past_relationships">üíî Í≥ºÍ±∞ Ïó∞Ïï†</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- üéÜ ÎØ∏Îûò Î™©Ìëú (ÏÉàÎ°ú Ï∂îÍ∞Ä) -->
                    <div class="char-category">
                        <h3>üéÜ ÎØ∏Îûò Î™©Ìëú</h3>
                        <div class="future-goals-grid">
                            <div class="form-group">
                                <label>üí∞ ÏûêÏÇ∞ Î™©Ìëú</label>
                                <select id="assetGoal">
                                    <option value="1_billion">üèè 1Ïñµ Ïõê (Ï£ºÌÉù ÎßàÎ†®)</option>
                                    <option value="3_billion">üè† 3Ïñµ Ïõê (Ï†ÑÏÑ∏ ÏóÜÏù¥ ÎÇ¥ Ïßë)</option>
                                    <option value="5_billion">üè° 5Ïñµ Ïõê (ÎïÖ ÏûàÎäî Ïßë)</option>
                                    <option value="10_billion">üè≠ 10Ïñµ Ïõê (ÎπåÎî© Ìïú Ï∏µ)</option>
                                    <option value="30_billion">üè¢ 30Ïñµ Ïõê (Í±¥Î¨º Ï†ÑÏ≤¥)</option>
                                    <option value="50_billion">üèØ 50Ïñµ Ïõê (Ïó¨Îü¨ Í±¥Î¨º)</option>
                                    <option value="100_billion">üè∞ 100Ïñµ Ïõê (ÎåÄÍ∏∞ÏóÖ Í∑úÎ™®)</option>
                                </select>
                                <button type="button" class="btn-random" onclick="randomizeAssetGoal()">üé≤ ÎûúÎç§</button>
                            </div>

                            <div class="form-group">
                                <label>üíº ÎØ∏Îûò ÏßÅÏóÖ (ÏµúÎåÄ 2Í∞ú ÏÑ†ÌÉù)</label>
                                <div class="future-career-grid">
                                    <button type="button" class="career-btn" data-career="housewife">üè† Ï†ÑÏóÖÏ£ºÎ∂Ä</button>
                                    <button type="button" class="career-btn" data-career="freelancer">üíª ÌîÑÎ¶¨ÎûúÏÑú</button>
                                    <button type="button" class="career-btn" data-career="celebrity">‚≠ê Ïó∞ÏòàÏù∏</button>
                                    <button type="button" class="career-btn" data-career="secretary">üìã ÎπÑÏÑú</button>
                                    <button type="button" class="career-btn" data-career="instructor">üë©‚Äçüè´ ÍµêÏÇ¨</button>
                                    <button type="button" class="career-btn" data-career="youtuber">üìπ Ïú†ÌäúÎ≤Ñ</button>
                                    <button type="button" class="career-btn" data-career="cafe_owner">‚òï Ïπ¥Ìéò ÏÇ¨Ïû•</button>
                                    <button type="button" class="career-btn" data-career="restaurant_owner">üçù ÏãùÎãπ Ïö¥ÏòÅ</button>
                                    <button type="button" class="career-btn" data-career="designer">üé® ÎîîÏûêÏù¥ÎÑà</button>
                                    <button type="button" class="career-btn" data-career="influencer">üì± Ïù∏ÌîåÎ£®Ïñ∏ÏÑú</button>
                                    <button type="button" class="career-btn" data-career="entrepreneur">üöÄ Ï∞ΩÏóÖÍ∞Ä</button>
                                    <button type="button" class="career-btn" data-career="artist">üé≠ ÏòàÏà†Í∞Ä</button>
                                    <button type="button" class="career-btn" data-career="consultant">üìà Ïª®ÏÑ§ÌÑ¥Ìä∏</button>
                                    <button type="button" class="career-btn" data-career="beauty_business">üíÖ ÎØ∏Ïö© ÏÇ¨ÏóÖ</button>
                                    <button type="button" class="career-btn" data-career="unemployed">üìè Î∞±Ïàò(Ïö¥ÎèôÍ∂å)</button>
                                </div>
                                <button type="button" class="btn-random" onclick="randomizeFutureCareers()">üé≤ ÎûúÎç§ ÏÑ†ÌÉù</button>
                            </div>
                        </div>
                    </div>

                </form>
            </div>
            <div class="modal-footer">
                <!-- Î∂àÌïÑÏöîÌïú Î≤ÑÌäºÎì§ Ï†úÍ±∞Îê® - ÌÜµÌï© ÏÉùÏÑ± ÏãúÏä§ÌÖúÏúºÎ°ú ÎåÄÏ≤¥ -->
                <div class="footer-right">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('characterModal')">Ï∑®ÏÜå</button>
                    <button type="button" class="btn btn-primary" onclick="saveCharacter()">üíñ Ï∫êÎ¶≠ÌÑ∞ Ï†ÄÏû•</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Dialogue Preview Modal -->
    <div id="dialoguePreviewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeModal('dialoguePreviewModal')">&times;</span>
                <h2 id="dialoguePreviewTitle">üìñ ÎåÄÌôî ÎØ∏Î¶¨Î≥¥Í∏∞</h2>
            </div>
            <div class="modal-body">
                <div id="dialoguePreviewContent">
                    <div class="preview-section">
                        <h3>üìã ÎåÄÌôî Ï†ïÎ≥¥</h3>
                        <div id="dialogueMetadata" class="metadata-grid">
                            <!-- Dialogue metadata will be inserted here -->
                        </div>
                    </div>
                    
                    <div class="preview-section">
                        <h3>üí¨ ÎåÄÌôî ÎÇ¥Ïö©</h3>
                        <div id="dialogueDisplay" class="dialogue-container">
                            <div id="characterMessage" class="character-message">
                                <!-- Character message will be inserted here -->
                            </div>
                            <div id="narrationDisplay" class="narration">
                                <!-- Narration will be inserted here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="preview-section">
                        <h3>üîò ÏÑ†ÌÉùÏßÄ</h3>
                        <div id="choicesDisplay" class="choices-container">
                            <!-- Choices will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('dialoguePreviewModal')">Îã´Í∏∞</button>
                <button type="button" class="btn btn-primary" onclick="editDialogueFromPreview()">ÏàòÏ†ïÌïòÍ∏∞</button>
            </div>
        </div>
    </div>

    <!-- Ï∫êÎ¶≠ÌÑ∞ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Î™®Îã¨ -->
    <div id="characterDetailModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <span class="close" onclick="closeModal('characterDetailModal')">&times;</span>
                <h2 id="characterDetailTitle">üë§ Ï∫êÎ¶≠ÌÑ∞ ÏÉÅÏÑ∏ Ï†ïÎ≥¥</h2>
            </div>
            <div class="modal-body">
                <div id="characterDetailContent">
                    <!-- AI ÌîÑÎ°¨ÌîÑÌä∏ ÏÑπÏÖò (ÏµúÏÉÅÎã®) -->
                    <div id="aiPromptSection" class="detail-section" style="display: none;">
                        <h3>ü§ñ AI ÏÜåÍ∞ú</h3>
                        <div class="ai-prompt-content" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                            <div id="aiPromptText" style="line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;"></div>
                        </div>
                        <div style="text-align: center; margin-bottom: 20px;">
                            <button class="btn btn-warning" onclick="openAiPromptEditModal()" style="background: #ffc107; border: none; color: #000; font-weight: bold; padding: 8px 20px; border-radius: 6px; cursor: pointer;">
                                ‚úèÔ∏è AI ÏÜåÍ∞ú ÏàòÏ†ï
                            </button>
                        </div>
                    </div>

                    <!-- Í∏∞Î≥∏ Ï†ïÎ≥¥ ÏÑπÏÖò -->
                    <div class="detail-section">
                        <h3>üìã Í∏∞Î≥∏ Ï†ïÎ≥¥</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <span class="detail-label">Ïù¥Î¶Ñ:</span>
                                <span id="detailName" class="detail-value">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">ÎÇòÏù¥:</span>
                                <span id="detailAge" class="detail-value">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">MBTI:</span>
                                <span id="detailMbti" class="detail-value">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">ÏÑ±Î≥Ñ:</span>
                                <span id="detailGender" class="detail-value">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Ï†ÑÍ≥µ/ÏßÅÏóÖ:</span>
                                <span id="detailOccupation" class="detail-value">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Í¥ÄÍ≥Ñ:</span>
                                <span id="detailRelationship" class="detail-value">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">ÌïôÎ†•:</span>
                                <span id="detailEducation" class="detail-value">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Í±∞Ï£ºÏßÄÏó≠:</span>
                                <span id="detailLocation" class="detail-value">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Î∞òÎ†§ÎèôÎ¨º:</span>
                                <span id="detailPets" class="detail-value">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">ÌòàÏï°Ìòï:</span>
                                <span id="detailBloodtype" class="detail-value">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Í∞ÄÏ°±Íµ¨ÏÑ±:</span>
                                <span id="detailFamilyStructure" class="detail-value">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Ïô∏Î™® Ï†ïÎ≥¥ ÏÑπÏÖò -->
                    <div class="detail-section">
                        <h3>üíÑ Ïô∏Î™® ÌäπÏßï</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <span class="detail-label">Ìó§Ïñ¥Ïä§ÌÉÄÏùº:</span>
                                <span id="detailHair" class="detail-value">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Îàà:</span>
                                <span id="detailEyes" class="detail-value">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Ï≤¥Ìòï:</span>
                                <span id="detailBody" class="detail-value">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Í∞ÄÏä¥:</span>
                                <span id="detailBust" class="detail-value">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">ÌóàÎ¶¨/ÏóâÎç©Ïù¥:</span>
                                <span id="detailWaistHip" class="detail-value">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Ïä§ÌÉÄÏùº:</span>
                                <span id="detailStyle" class="detail-value">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- ÏÑ±Í≤© Î∞è ÌäπÏÑ± -->
                    <div class="detail-section">
                        <h3>üé≠ ÏÑ±Í≤© Î∞è ÌäπÏÑ±</h3>
                        <div class="detail-grid">
                            <div class="detail-item detail-full">
                                <span class="detail-label">ÏÑ±Í≤© ÌäπÏÑ±:</span>
                                <span id="detailPersonality" class="detail-value">-</span>
                            </div>
                            <div class="detail-item detail-full">
                                <span class="detail-label">Ï∑®ÎØ∏:</span>
                                <span id="detailHobbies" class="detail-value">-</span>
                            </div>
                            <div class="detail-item detail-full">
                                <span class="detail-label">Í∞ÄÏπòÍ¥Ä:</span>
                                <span id="detailValues" class="detail-value">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- ÎåÄÌôî Ïä§ÌÉÄÏùº -->
                    <div class="detail-section">
                        <h3>üí¨ ÎåÄÌôî Ïä§ÌÉÄÏùº</h3>
                        <div class="detail-grid">
                            <div class="detail-item detail-full">
                                <span class="detail-label">ÎßêÌà¨:</span>
                                <span id="detailSpeechStyle" class="detail-value">-</span>
                            </div>
                            <div class="detail-item detail-full">
                                <span class="detail-label">Ï£ºÎ°úÏì∞Îäî Ìò∏Ïπ≠:</span>
                                <span id="detailSpeechHabit" class="detail-value">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Îß§Î†• ÌîÑÎ°úÌïÑ (v2.1 Ïä§ÌÇ§Îßà ÌôïÏû•) -->
                    <div class="detail-section" id="appealProfileSection">
                        <h3>üí´ Îß§Î†• ÌîÑÎ°úÌïÑ</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <span class="detail-label">Ïú†Ìòπ Ïä§ÌÉÄÏùº:</span>
                                <span id="detailSeductionStyle" class="detail-value">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Îß§Î†• Ìè¨Ïù∏Ìä∏:</span>
                                <span id="detailCharmPoints" class="detail-value">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Í∞êÏ†ïÏßÄÎä•:</span>
                                <span id="detailEmotionalIntelligence" class="detail-value">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">ÏûêÏã†Í∞ê ÏàòÏ§Ä:</span>
                                <span id="detailConfidenceLevel" class="detail-value">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Ïã†ÎπÑÎ°úÏõÄ:</span>
                                <span id="detailMysteryFactor" class="detail-value">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">ÏÑ±Ï†Å Ìò∏Í∏∞Ïã¨:</span>
                                <span id="detailSexualCuriosity" class="detail-value">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">ÏÑ±Ï†Å Ïø®Ï†ÅÎèÑ:</span>
                                <span id="detailSexualComfort" class="detail-value">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Ïô∏Î™® Îß§Î†• (ÏÉàÎ°úÏö¥ v2.1 ÌïÑÎìúÎì§) -->
                    <div class="detail-section">
                        <h3>‚ú® Ïô∏Î™® Îß§Î†•</h3>
                        <div class="detail-grid">
                            <div class="detail-item detail-full">
                                <span class="detail-label">‚ú® ÏûêÏã†ÏûàÎäî Î∂ÄÏúÑ:</span>
                                <span id="detailFeatureElements" class="detail-value">-</span>
                            </div>
                            <div class="detail-item detail-full">
                                <span class="detail-label">üíÉ ÏÑπÏãúÌè¨Ï¶à:</span>
                                <span id="detailSensualHabits" class="detail-value">-</span>
                            </div>
                            <div class="detail-item detail-full">
                                <span class="detail-label">üíï Ìù•Î∂ÑÏãú Î∞òÏùë:</span>
                                <span id="detailBodyLanguage" class="detail-value">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Ïã¨Î¶¨Ï†Å ÍπäÏù¥ (ÌôïÏû•) -->
                    <div class="detail-section">
                        <h3>üß† Ïã¨Î¶¨Ï†Å ÍπäÏù¥</h3>
                        <div class="detail-grid">
                            <div class="detail-item detail-full">
                                <span class="detail-label">ÌïµÏã¨ ÏöïÍµ¨:</span>
                                <span id="detailCoreDesires" class="detail-value">-</span>
                            </div>
                            <div class="detail-item detail-full">
                                <span class="detail-label">Ï∑®ÏïΩÏ†ê:</span>
                                <span id="detailVulnerabilities" class="detail-value">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">ÌîåÎü¨ÌåÖ ÏàòÏúÑ:</span>
                                <span id="detailComfortLevel" class="detail-value">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Ï†ÑÍ∞ú ÏÜçÎèÑ:</span>
                                <span id="detailEscalationPace" class="detail-value">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">ÏÑ±Ï†Å ÌÜ§ Î∞¥Îìú:</span>
                                <span id="detailSexualToneBand" class="detail-value">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">ÏÑ±Ï†Å ÏûêÏú†Î∂ÑÎ∞©Ìï®:</span>
                                <span id="detailSexualFreedom" class="detail-value">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- ÎåÄÌôîÏó≠Ìïô (ÏÉàÎ°úÏö¥ v2.1 ÏÑπÏÖò) -->
                    <div class="detail-section">
                        <h3>üí¨ ÎåÄÌôîÏó≠Ìïô</h3>
                        <div class="detail-grid">
                            <div class="detail-item detail-full">
                                <span class="detail-label">ÌîåÎü¨ÌåÖ Ìå®ÌÑ¥:</span>
                                <span id="detailFlirtingPatterns" class="detail-value">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Ïú†Î®∏ Î∞òÏùë:</span>
                                <span id="detailHumorResponse" class="detail-value">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Ïπ≠Ï∞¨ Î∞òÏùë:</span>
                                <span id="detailComplimentResponse" class="detail-value">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Í¥ÄÏã¨ ÌëúÌòÑ Î∞òÏùë:</span>
                                <span id="detailInterestResponse" class="detail-value">-</span>
                            </div>
                            <div class="detail-item detail-full">
                                <span class="detail-label">ÎåÄÌôî ÌõÖ:</span>
                                <span id="detailConversationHooks" class="detail-value">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">ÎßêÌà¨ Ïä§ÌÉÄÏùº:</span>
                                <span id="detailSpeechStyleNew" class="detail-value">-</span>
                            </div>
                            <div class="detail-item detail-full">
                                <span class="detail-label">ÎßêÌà¨ ÏäµÍ¥Ä:</span>
                                <span id="detailSpeechHabits" class="detail-value">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Ïñ¥Ìúò Î†àÏßÄÏä§ÌÑ∞:</span>
                                <span id="detailVocabularyRegister" class="detail-value">-</span>
                            </div>
                            <div class="detail-item detail-full">
                                <span class="detail-label">ÌóàÏö© Î™®Ìã∞ÌîÑ:</span>
                                <span id="detailAllowedMotifs" class="detail-value">-</span>
                            </div>
                            <div class="detail-item detail-full">
                                <span class="detail-label">Í∏àÏßÄ Ïö©Ïñ¥:</span>
                                <span id="detailForbiddenTerms" class="detail-value">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Í≥ºÍ±∞ Ïù¥Î†• (ÏÉàÎ°úÏö¥ v2.1 ÏÑπÏÖò) -->
                    <div class="detail-section">
                        <h3>üìã Í≥ºÍ±∞ Ïù¥Î†•</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <span class="detail-label">ÎÇ®ÏûêÏπúÍµ¨ Ïàò:</span>
                                <span id="detailBoyfriendCount" class="detail-value">-</span>
                            </div>
                            <div class="detail-item detail-full">
                                <span class="detail-label">ÏÑ†Ìò∏ Ïä§ÌÇ®Ïã≠:</span>
                                <span id="detailPreferredSkinship" class="detail-value">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Ïó∞Ïï† Í≤ΩÌóòÏπò:</span>
                                <span id="detailRelationshipExperience" class="detail-value">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Ï≤´ Í≤ΩÌóò ÏãúÍ∏∞:</span>
                                <span id="detailFirstExperienceAge" class="detail-value">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">üë® ÎÇ®Ïûê Ïö∞ÏÑ†ÏàúÏúÑ:</span>
                                <span id="detailMalePriorities" class="detail-value">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Î∞∞Í≤Ω Ï†ïÎ≥¥ -->
                    <div class="detail-section">
                        <h3>üè† Î∞∞Í≤Ω Ï†ïÎ≥¥</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <span class="detail-label">Í∞ÄÏ°±Íµ¨ÏÑ±:</span>
                                <span id="detailFamily" class="detail-value">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Ï∂úÏã†ÏßÄ:</span>
                                <span id="detailHometown" class="detail-value">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Ïä§ÌÇ§Îßà Ï†ïÎ≥¥ -->
                    <div class="detail-section">
                        <h3>üîß ÏãúÏä§ÌÖú Ï†ïÎ≥¥</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <span class="detail-label">Îç∞Ïù¥ÌÑ∞ Î≤ÑÏ†Ñ:</span>
                                <span id="detailSchemaVersion" class="detail-value">-</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">ÏÉùÏÑ± ÎÇ†Ïßú:</span>
                                <span id="detailCreatedDate" class="detail-value">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('characterDetailModal')">Îã´Í∏∞</button>
                <button type="button" class="btn btn-primary" onclick="editCurrentCharacter()">‚úèÔ∏è Ìé∏Ïßë</button>
            </div>
        </div>
    </div>

    <script>
        // üîê Ïù∏Ï¶ù Í¥ÄÎ†® Ï†ÑÏó≠ Î≥ÄÏàò
        let currentAuthToken = null;
        let currentUser = null;
        let isAuthenticated = false;

        // Ï†ÑÏó≠ Î≥ÄÏàò
        let scenarios = {};
        let dialogues = {};
        let characters = {};
        let currentScenarioId = null;
        let currentDifficultyFilter = 'all';
        let currentMode = 'create';
        let selectedCharacters = new Set();
        let generatedDialogue = null;

        // Ï§ëÎ≥µ Ï≤òÎ¶¨ Î∞©ÏßÄÎ•º ÏúÑÌïú ÏÉÅÌÉú Í¥ÄÎ¶¨
        const processingState = {
            loadingEpisodes: false,
            loadingTotal: false,
            lastUpdate: null,
            updateInterval: 5000 // 5Ï¥à Í∞ÑÍ≤©ÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏ Ï†úÌïú
        };

        // üö® ÏóêÎü¨ Î°úÍπÖ ÏãúÏä§ÌÖú
        class ErrorLogger {
            static async logError(level, message, error, context = {}) {
                try {
                    const errorData = {
                        level: level, // 'critical', 'error', 'warning', 'info'
                        message: message,
                        stack: error?.stack || null,
                        url: window.location.href,
                        timestamp: new Date().toISOString(),
                        userId: currentUser?.id || 'anonymous',
                        sessionId: sessionStorage.getItem('sessionId') || null,
                        action: context.action || null,
                        component: context.component || null,
                        additionalData: {
                            userAgent: navigator.userAgent,
                            screenSize: `${screen.width}x${screen.height}`,
                            viewportSize: `${window.innerWidth}x${window.innerHeight}`,
                            ...context.data
                        }
                    };

                    // Î°úÏª¨ ÏΩòÏÜîÏóêÎèÑ Ï∂úÎ†•
                    const logMethod = level === 'critical' || level === 'error' ? console.error :
                                    level === 'warning' ? console.warn : console.log;
                    logMethod(`üö® ${level.toUpperCase()}:`, message, error);

                    // ÏÑúÎ≤ÑÎ°ú Ï†ÑÏÜ°
                    await fetch('/api/error-logger', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(errorData)
                    });

                } catch (logError) {
                    console.error('‚ùå Failed to log error to server:', logError);
                }
            }

            static critical(message, error, context = {}) {
                return this.logError('critical', message, error, context);
            }

            static error(message, error, context = {}) {
                return this.logError('error', message, error, context);
            }

            static warning(message, error, context = {}) {
                return this.logError('warning', message, error, context);
            }

            static info(message, error, context = {}) {
                return this.logError('info', message, error, context);
            }
        }

        // Ï†ÑÏó≠ ÏóêÎü¨ Ìï∏Îì§Îü¨ ÏÑ§Ï†ï
        window.addEventListener('error', (event) => {
            ErrorLogger.critical('Uncaught JavaScript Error', event.error, {
                action: 'global_error_handler',
                component: 'window',
                data: {
                    filename: event.filename,
                    lineno: event.lineno,
                    colno: event.colno
                }
            });
        });

        window.addEventListener('unhandledrejection', (event) => {
            ErrorLogger.critical('Unhandled Promise Rejection', event.reason, {
                action: 'promise_rejection',
                component: 'window'
            });
        });

        // üîç API ÏÉÅÌÉú ÌôïÏù∏ Ìï®Ïàò
        async function checkAPIStatus() {
            try {
                const response = await fetch('/api/error-logger');
                const data = await response.json();

                if (data.success) {
                    console.log('‚úÖ Error Logger API ÏÉÅÌÉú:', data.message);
                    ErrorLogger.info('API Status Check Successful', null, {
                        action: 'api_health_check',
                        component: 'error_logger',
                        data: { status: 'healthy' }
                    });
                }
            } catch (error) {
                console.error('‚ùå Error Logger API ÏÉÅÌÉú ÌôïÏù∏ Ïã§Ìå®:', error);
                // ÏóêÎü¨ Î°úÍ±∞ ÏûêÏ≤¥Ïóê Î¨∏Ï†úÍ∞Ä ÏûàÏúºÎØÄÎ°ú ÏùºÎ∞ò ÏΩòÏÜî Î°úÍ∑∏ ÏÇ¨Ïö©
            }
        }

        // üîÑ ÏÉàÎ°úÍ≥†Ïπ® ÏïåÎ¶º ÌëúÏãú Ìï®Ïàò
        function showRefreshNotification(message, isSuccess = false) {
            // Í∏∞Ï°¥ ÏïåÎ¶ºÏù¥ ÏûàÏúºÎ©¥ Ï†úÍ±∞
            const existingNotification = document.getElementById('refreshNotification');
            if (existingNotification) {
                existingNotification.remove();
            }

            // ÏÉà ÏïåÎ¶º ÏÉùÏÑ±
            const notification = document.createElement('div');
            notification.id = 'refreshNotification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${isSuccess ? '#28a745' : '#17a2b8'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-weight: bold;
                font-size: 14px;
                transition: all 0.3s ease;
                max-width: 300px;
            `;
            notification.textContent = message;

            document.body.appendChild(notification);

            // ÏÑ±Í≥µ Î©îÏãúÏßÄÎäî 3Ï¥à ÌõÑ ÏûêÎèô Ï†úÍ±∞, ÏßÑÌñâ Ï§ë Î©îÏãúÏßÄÎäî ÏàòÎèô Ï†úÍ±∞
            if (isSuccess) {
                setTimeout(() => {
                    if (notification && notification.parentNode) {
                        notification.style.opacity = '0';
                        setTimeout(() => notification.remove(), 300);
                    }
                }, 3000);
            }
        }

        // üé≠ ================ AI ÏÜåÍ∞ú ÏÉùÏÑ± ÏãúÏä§ÌÖú ================

        let currentGeneratedPrompt = null;
        let currentPromptCharacterId = null;

        // Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ùÏùÑ AI ÏÜåÍ∞ú ÏÉùÏÑ± ÎìúÎ°≠Îã§Ïö¥Ïóê Î°úÎìú
        async function loadCharactersForPromptGeneration() {
            try {
                console.log('üìã AI ÏÜåÍ∞ú ÏÉùÏÑ±Ïö© Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù Î°úÎìú Ï§ë...');

                const characterSelect = document.getElementById('characterPromptTarget');
                if (!characterSelect) {
                    console.error('‚ùå characterPromptTarget ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå');
                    return;
                }

                // Í∏∞Ï°¥ ÏòµÏÖò Ï†úÍ±∞ (Ï≤´ Î≤àÏß∏ Í∏∞Î≥∏ ÏòµÏÖò Ï†úÏô∏)
                characterSelect.innerHTML = '<option value="">Ï∫êÎ¶≠ÌÑ∞ Î°úÎî© Ï§ë...</option>';

                // ÏßÅÏ†ë APIÏóêÏÑú ÏµúÏã† Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
                const response = await fetch('/api/character-ai-generator?action=list_characters&_t=' + Date.now());
                if (!response.ok) {
                    throw new Error('Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù API Ìò∏Ï∂ú Ïã§Ìå®');
                }

                const result = await response.json();
                console.log('üì° API ÏùëÎãµ:', result);

                if (!result.success) {
                    throw new Error('API Ìò∏Ï∂ú Ïã§Ìå®');
                }

                // API ÏùëÎãµÏóêÏÑú Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ Ï∂îÏ∂ú (Îëê Í∞ÄÏßÄ Íµ¨Ï°∞ ÏßÄÏõê)
                let characters = null;
                if (result.characters) {
                    characters = result.characters;
                    console.log('üìä result.charactersÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î∞úÍ≤¨');
                } else if (result.data && result.data.characters) {
                    characters = result.data.characters;
                    console.log('üìä result.data.charactersÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î∞úÍ≤¨');
                } else {
                    throw new Error('ÏùëÎãµÏóêÏÑú Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§');
                }

                console.log('üìã Ï∂îÏ∂úÎêú Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞:', characters);
                const characterArray = Object.values(characters);

                if (characterArray.length === 0) {
                    characterSelect.innerHTML = '<option value="">ÏÉùÏÑ±Îêú Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</option>';
                    console.log('üì≠ ÏÉùÏÑ±Îêú Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÏóÜÏùå');
                    return;
                }

                // Í∏∞Î≥∏ ÏòµÏÖòÏúºÎ°ú Ïû¨ÏÑ§Ï†ï
                characterSelect.innerHTML = '<option value="">Ï∫êÎ¶≠ÌÑ∞Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>';

                // Ï∫êÎ¶≠ÌÑ∞ ÏòµÏÖò Ï∂îÍ∞Ä
                characterArray.forEach(character => {
                    const option = document.createElement('option');
                    option.value = character.id;

                    // v2.0 Ïä§ÌÇ§ÎßàÏôÄ v1.0 Ïä§ÌÇ§Îßà Î™®Îëê ÏßÄÏõê
                    const name = character.basic_info?.name || character.name || 'Ïù¥Î¶ÑÏóÜÏùå';
                    const mbti = character.basic_info?.mbti || character.mbti || 'MBTI';

                    option.textContent = `${name} (${mbti})`;
                    characterSelect.appendChild(option);

                    console.log(`‚úÖ Ï∫êÎ¶≠ÌÑ∞ ÏòµÏÖò Ï∂îÍ∞Ä: ${name} (${mbti})`);
                });

                console.log(`‚úÖ ${characterArray.length}Í∞ú Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú ÏôÑÎ£å`);

                // Ï†ÑÏó≠ Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
                window.characters = characters;

            } catch (error) {
                console.error('‚ùå Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù Î°úÎìú Ïã§Ìå®:', error);
                const characterSelect = document.getElementById('characterPromptTarget');
                if (characterSelect) {
                    characterSelect.innerHTML = '<option value="">Î°úÎìú Ïã§Ìå® - ÏÉàÎ°úÍ≥†Ïπ® ÌõÑ Ïû¨ÏãúÎèÑ</option>';
                }
                showNotification('Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù Î°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
            }
        }

        // Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ ÎØ∏Î¶¨Î≥¥Í∏∞
        function previewCharacterData() {
            const selectedCharacterId = document.getElementById('characterPromptTarget').value;
            if (!selectedCharacterId) {
                showNotification('Î®ºÏ†Ä Ï∫êÎ¶≠ÌÑ∞Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.', 'warning');
                return;
            }

            const character = window.characters[selectedCharacterId];
            if (!character) {
                showNotification('ÏÑ†ÌÉùÌïú Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
                return;
            }

            // ÌîÑÎ¶¨Î∑∞ ÏòÅÏó≠ ÌëúÏãú
            const previewArea = document.getElementById('promptPreviewArea');
            const previewContent = document.getElementById('promptPreviewContent');

            previewArea.style.display = 'block';
            previewContent.textContent = JSON.stringify(character, null, 2);

            // Ï†ÄÏû• Î≤ÑÌäº Ïà®Í∏∞Í∏∞ (ÎØ∏Î¶¨Î≥¥Í∏∞ Î™®Îìú)
            const saveButton = previewArea.querySelector('button[onclick="savePromptToCharacter()"]');
            if (saveButton) saveButton.style.display = 'none';

            console.log('üëÅÔ∏è Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ ÎØ∏Î¶¨Î≥¥Í∏∞:', character.basic_info.name);
        }

        // AI APIÎ•º ÌÜµÌïú Ï∫êÎ¶≠ÌÑ∞ ÏÜåÍ∞ú ÏÉùÏÑ±
        async function generateCharacterPrompt() {
            const selectedCharacterId = document.getElementById('characterPromptTarget').value;
            if (!selectedCharacterId) {
                showNotification('Î®ºÏ†Ä Ï∫êÎ¶≠ÌÑ∞Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.', 'warning');
                return;
            }

            const character = window.characters[selectedCharacterId];
            if (!character) {
                showNotification('ÏÑ†ÌÉùÌïú Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
                return;
            }

            // AI ÏÜåÍ∞ú ÏÉùÏÑ± ÏÑ§Ï†ï Í∞ÄÏ†∏Ïò§Í∏∞
            const model = document.getElementById('promptGenerationModel').value;
            const style = document.getElementById('promptStyle').value;
            const length = document.getElementById('promptLength').value;

            try {
                console.log('üöÄ Groq APIÎ•º ÌÜµÌïú ÌîÑÎ°¨ÌîÑÌä∏ ÏÉùÏÑ± ÏãúÏûë...');
                addPromptLog('ÌîÑÎ°¨ÌîÑÌä∏ ÏÉùÏÑ± ÏãúÏûë', 'info');

                // Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
                const generateButton = document.querySelector('button[onclick="generateCharacterPrompt()"]');
                if (generateButton) {
                    generateButton.disabled = true;
                    generateButton.innerHTML = '‚è≥ ÏÉùÏÑ± Ï§ë...';
                }

                // OpenAI API Ìò∏Ï∂ú
                const prompt = await callOpenAIForPromptGeneration(character, model, style, length);

                if (prompt) {
                    currentGeneratedPrompt = prompt;
                    currentPromptCharacterId = selectedCharacterId;

                    displayGeneratedPrompt(prompt);
                    addPromptLog(`${character.basic_info.name} ÌîÑÎ°¨ÌîÑÌä∏ ÏÉùÏÑ± ÏôÑÎ£å`, 'success');
                    console.log('‚úÖ ÌîÑÎ°¨ÌîÑÌä∏ ÏÉùÏÑ± ÏÑ±Í≥µ');
                } else {
                    throw new Error('ÌîÑÎ°¨ÌîÑÌä∏ ÏÉùÏÑ± Ïã§Ìå®');
                }

            } catch (error) {
                console.error('‚ùå ÌîÑÎ°¨ÌîÑÌä∏ ÏÉùÏÑ± Ïò§Î•ò:', error);
                addPromptLog(`ÌîÑÎ°¨ÌîÑÌä∏ ÏÉùÏÑ± Ïã§Ìå®: ${error.message}`, 'error');
                showNotification('ÌîÑÎ°¨ÌîÑÌä∏ ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.', 'error');
            } finally {
                // Î≤ÑÌäº Î≥µÏõê
                const generateButton = document.querySelector('button[onclick="generateCharacterPrompt()"]');
                if (generateButton) {
                    generateButton.disabled = false;
                    generateButton.innerHTML = '‚ú® ÌîÑÎ°¨ÌîÑÌä∏ ÏÉùÏÑ±';
                }
            }
        }

        // OpenAI API Ìò∏Ï∂ú Ìï®Ïàò
        async function callOpenAIForPromptGeneration(character, model, style, length) {
            const apiUrl = '/api/character-ai-generator';

            // üî• Groq APIÏö©: Î™®Îì† ÌïÑÎìú Îç∞Ïù¥ÌÑ∞Î•º ÏõêÎ≥∏ Í∑∏ÎåÄÎ°ú Ï†ÑÏÜ° (ÌïÑÌÑ∞ÎßÅ ÏóÜÏùå)
            console.log('üî• ÏõêÎ≥∏ Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞Î•º ÌïÑÌÑ∞ÎßÅ ÏóÜÏù¥ Í∑∏ÎåÄÎ°ú Ï†ÑÏÜ°');
            console.log('üìã Ï†ÑÏ≤¥ Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞:', character);
            console.log('üìä Ï†ÑÏÜ°Ìï† ÌïÑÎìú Ïàò:', Object.keys(character).length);

            // Groq APIÎäî OpenAIÎ≥¥Îã§ Í¥ÄÎåÄÌïòÎØÄÎ°ú ÏõêÎ≥∏ Îç∞Ïù¥ÌÑ∞ Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©
            const systemPrompt = 'AI Ï∫êÎ¶≠ÌÑ∞ ÌîÑÎ°¨ÌîÑÌä∏Î•º ÏÉÅÏÑ∏ÌïòÍ≤å ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî. Ï†úÍ≥µÎêú Î™®Îì† Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥Î•º ÏûêÏó∞Ïä§ÎüΩÍ≤å Ìè¨Ìï®Ìï¥Ïïº Ìï©ÎãàÎã§.';

            const requestData = {
                action: 'generate_character_prompt',
                character_data: character,  // üî• ÏõêÎ≥∏ Îç∞Ïù¥ÌÑ∞ Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö© (45Í∞ú ÌïÑÎìú Î™®Îëê Ìè¨Ìï®)
                model: model,
                style: style,
                length: length,
                system_prompt: systemPrompt
            };

            console.log('üì§ Groq API ÏöîÏ≤≠ Îç∞Ïù¥ÌÑ∞ (ÏõêÎ≥∏ Ï†ÑÏ≤¥ ÌïÑÎìú):', requestData);

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            });

            if (!response.ok) {
                throw new Error(`API ÏöîÏ≤≠ Ïã§Ìå®: ${response.status}`);
            }

            const result = await response.json();
            console.log('üì• OpenAI API ÏùëÎãµ:', result);

            if (result.success && result.prompt) {
                return result.prompt;
            } else {
                throw new Error(result.error || 'ÌîÑÎ°¨ÌîÑÌä∏ ÏÉùÏÑ± Ïã§Ìå®');
            }
        }

        // Ï∫êÎ¶≠ÌÑ∞Î≥Ñ ÏãúÏä§ÌÖú ÌîÑÎ°¨ÌîÑÌä∏ ÏÉùÏÑ±
        // ÎØºÍ∞êÌïú Í∞íÎì§ÏùÑ ÏïàÏ†ÑÌïú ÌëúÌòÑÏúºÎ°ú Î≥ÄÌôòÌïòÎäî Ìï®Ïàò
        function sanitizeValueForOpenAI(value) {
            if (!value) return value;

            const sanitizationMap = {
                // ÏùòÎ•ò/Ïï°ÏÑ∏ÏÑúÎ¶¨ Í¥ÄÎ†®
                'luxury_lingerie': 'elegant_accessories',
                'sexy_lingerie': 'elegant_clothing',
                'sensual_lingerie': 'stylish_undergarments',

                // Ïô∏Î™® Í¥ÄÎ†® - Îçî Í∞ïÌôî
                'seductive_eyes': 'expressive_eyes',
                'sultry_dominant': 'confident_charming',
                'passionate_kiss': 'warm_affection',
                'sultry_gaze': 'charming_gaze',
                'seductive_smile': 'attractive_smile',
                'playful_seductive': 'playful_charming',

                // Ïä§ÌÇ®Ïã≠ Í¥ÄÎ†® - Îçî Í∞ïÌôî
                'intimate_cuddling': 'close_bonding',
                'passionate_kiss': 'affectionate_gesture',
                'intimate_touch': 'gentle_touch',
                'sensual_massage': 'relaxing_massage',

                // Ïã†Ï≤¥ Í¥ÄÎ†® - Í∞ïÌôî
                'D': 'well_proportioned',
                'E': 'full_figured',
                'F': 'curvy',
                'petite_sexy': 'petite_elegant',
                'attractive_chest': 'elegant_posture',

                // Ïã†Ï≤¥ ÌñâÎèô - ÏÉàÎ°ú Ï∂îÍ∞Ä
                'ÏûÖÏà†Íπ®Î¨ºÍ∏∞': 'ÎØ∏ÏÜåÏßìÍ∏∞',
                'Ïú†ÌòπÏ†ÅÏãúÏÑ†': 'Îî∞ÎúªÌïúÏãúÏÑ†',
                'ÏÑπÏãú': 'Ïö∞ÏïÑ',
                'Î™∏Í∏∞Ïö∏Ïù¥Í∏∞': 'ÏûêÏó∞Ïä§ÎüΩÍ≤åÍ∏∞Ïö∏Ïù¥Í∏∞',
                'Ïà®ÏÜåÎ¶¨Í±∞Ïπ†Ïñ¥Ïßê': 'ÍπäÏùÄÌò∏Ìù°',
                'Îã§Î¶¨Íº¨Í∏∞': 'Îã®Ï†ïÌûàÏïâÍ∏∞',
                'ÏúôÌÅ¨ÌïòÍ∏∞': 'ÎØ∏ÏÜåÏßìÍ∏∞',

                // Ïä§ÌÉÄÏùº Í¥ÄÎ†®
                'sultry_dominant': 'confident_charming',
                'playful_seductive': 'playful_friendly',

                // Í∏∞ÌÉÄ ÎØºÍ∞êÌïú ÌëúÌòÑ - Í∞ïÌôî
                'sensual_habits': 'charming_habits',
                'sultry': 'charming',
                'seductive': 'attractive',
                'sensual': 'graceful',
                'erotic': 'romantic',
                'sexual': 'intimate',
                'arousing': 'captivating',
                'sexual_curiosity': 'romantic_curiosity',
                'sexual_comfort': 'emotional_comfort',
                'sexual_freedom': 'emotional_openness',
                'sexual_tone_band': 'conversation_tone',
                'early_teens': 'mature_age',
                'first_experience_age': 'maturity_level',

                // Ï∂îÍ∞Ä ÏïàÏ†Ñ Ï≤òÎ¶¨
                'mysterious_deep': 'mysterious_gaze',
                'model_like': 'elegant_figure',
                'tall_elegant': 'graceful_stature',
                'shoulder_massage': 'gentle_touch',
                'back_rubbing': 'comfort_gesture'
            };

            if (Array.isArray(value)) {
                return value.map(item => sanitizationMap[item] || item);
            } else {
                return sanitizationMap[value] || value;
            }
        }

        // üéØ OpenAI Ï†ÑÏÜ°Ïö© ÏïàÏ†ÑÌïú Íµ¨Í∞ÑÎßå Ï∂îÏ∂úÌïòÎäî Ìï®Ïàò (Íµ¨Ï°∞Ï†Å Ï†ëÍ∑ºÎ≤ï)
        function sanitizeCharacterForOpenAI(character) {
            if (!character) return character;

            console.log('üéØ Ïõπ Ïù∏ÌÑ∞ÌéòÏù¥Ïä§: ÏïàÏ†Ñ Íµ¨Í∞Ñ Ï∂îÏ∂ú ÏãúÏûë - ÎØºÍ∞êÌïú ÌïÑÎìú ÏôÑÏ†Ñ Ï†úÏô∏');

            // ‚úÖ OpenAIÏóê Ï†ÑÏÜ°Ìï† ÏïàÏ†ÑÌïú Íµ¨Í∞ÑÎßå Ï∂îÏ∂ú
            const safeData = {
                // 1. ‚úÖ Í∏∞Î≥∏ Ï†ïÎ≥¥ (ÏôÑÏ†Ñ ÏïàÏ†Ñ)
                basic_info: character.basic_info ? {
                    name: character.basic_info.name,
                    age: character.basic_info.age,
                    mbti: character.basic_info.mbti,
                    occupation: character.basic_info.occupation,
                    gender: character.basic_info.gender
                } : {},

                // 2. ‚úÖ Îß§Î†• ÌîÑÎ°úÌïÑ (ÎØºÍ∞êÌïú sexual_ ÌïÑÎìú Ï†úÏô∏)
                appeal_profile: character.appeal_profile ? {
                    seduction_style: character.appeal_profile.seduction_style,
                    charm_points: character.appeal_profile.charm_points,
                    emotional_intelligence: character.appeal_profile.emotional_intelligence,
                    confidence_level: character.appeal_profile.confidence_level,
                    mystery_factor: character.appeal_profile.mystery_factor,
                    hobbies: character.appeal_profile.hobbies
                    // ‚ùå sexual_curiosity, sexual_comfort Ï†úÏô∏
                } : {},

                // 3. ‚úÖ Ïô∏Î™® (ÎØºÍ∞êÌïú ÏÑ∏Î∂ÄÏÇ¨Ìï≠ Ï†úÏô∏)
                physical_allure: character.physical_allure ? {
                    appearance: character.physical_allure.appearance ? {
                        hair: character.physical_allure.appearance.hair,
                        eyes: character.physical_allure.appearance.eyes,
                        body: character.physical_allure.appearance.body,
                        waist_hip: character.physical_allure.appearance.waist_hip,
                        style: character.physical_allure.appearance.style
                        // ‚ùå bust Ï†úÏô∏
                    } : {}
                    // ‚ùå feature_elements, sensual_habits, body_language Ï†úÏô∏
                } : {},

                // 4. ‚úÖ ÎåÄÌôî Ïä§ÌÉÄÏùº (ÏïàÏ†ÑÌïú Î∂ÄÎ∂ÑÎßå)
                conversation_dynamics: character.conversation_dynamics ? {
                    speech_style: character.conversation_dynamics.speech_style,
                    flirting_patterns: character.conversation_dynamics.flirting_patterns,
                    conversation_hooks: character.conversation_dynamics.conversation_hooks,
                    speech_habits: character.conversation_dynamics.speech_habits,
                    vocabulary_register: character.conversation_dynamics.vocabulary_register,
                    allowed_motifs: character.conversation_dynamics.allowed_motifs
                    // ‚ùå reaction_tendencies, forbidden_terms Ï†úÏô∏ (Îçú Ï§ëÏöî)
                } : {}

                // ‚ïê‚ïê‚ïê Ïó¨Í∏∞ÍπåÏßÄÎßå OpenAI Ï†ÑÏÜ° ‚ïê‚ïê‚ïê
                // ‚ùå psychological_depth ÏôÑÏ†Ñ Ï†úÏô∏
                // ‚ùå past_history ÏôÑÏ†Ñ Ï†úÏô∏
                // ‚ùå favorite_gifts ÏôÑÏ†Ñ Ï†úÏô∏
                // ‚ùå future_goals ÏôÑÏ†Ñ Ï†úÏô∏
                // ‚ùå male_priorities ÏôÑÏ†Ñ Ï†úÏô∏
            };

            console.log('üéØ Ïõπ Ïù∏ÌÑ∞ÌéòÏù¥Ïä§: ÏïàÏ†Ñ Íµ¨Í∞Ñ Ï∂îÏ∂ú ÏôÑÎ£å');
            console.log('  ‚úÖ basic_info:', !!safeData.basic_info);
            console.log('  ‚úÖ appeal_profile:', !!safeData.appeal_profile);
            console.log('  ‚úÖ physical_allure:', !!safeData.physical_allure);
            console.log('  ‚úÖ conversation_dynamics:', !!safeData.conversation_dynamics);
            console.log('  ‚ùå ÎØºÍ∞êÌïú ÌïÑÎìúÎì§ Î™®Îëê Ï†úÏô∏Îê®');

            return safeData;
        }

        function createSystemPromptForCharacter(character, style, length) {
            const lengthGuide = {
                'short': '3000-5000Ïûê (ÌïµÏã¨ ÌïÑÎìú Ìè¨Ìï®)',
                'medium': '5000-8000Ïûê (ÏÉÅÏÑ∏Ìïú Î∂ÑÏÑù)',
                'long': '8000-12000Ïûê (ÏôÑÏ†ÑÌïú Ï∫êÎ¶≠ÌÑ∞ Í∞ÄÏù¥Îìú)'
            };

            const styleGuide = {
                'comprehensive': 'Ï∫êÎ¶≠ÌÑ∞Ïùò Î™®Îì† Ï∏°Î©¥ÏùÑ Ï¢ÖÌï©Ï†ÅÏúºÎ°ú Î∂ÑÏÑùÌïòÎäî',
                'roleplay': 'ÎåÄÌôîÏôÄ Î°§ÌîåÎ†àÏù¥Ïóê ÏµúÏ†ÅÌôîÎêú',
                'psychological': 'Ïã¨Î¶¨Ï†Å ÌäπÏÑ±Í≥º ÎÇ¥Î©¥ÏùÑ ÍπäÏù¥ ÏûàÍ≤å Î∂ÑÏÑùÌïòÎäî'
            };

            return `ÎãπÏã†ÏùÄ MBTI Í∏∞Î∞ò Ï∫êÎ¶≠ÌÑ∞ Î∂ÑÏÑù Ï†ÑÎ¨∏Í∞ÄÏûÖÎãàÎã§.
Ï£ºÏñ¥ÏßÑ Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥Ïùò Î™®Îì† ÌäπÏÑ±ÏùÑ Îπ†ÏßêÏóÜÏù¥ Î∞òÏòÅÌïòÏó¨ ${styleGuide[style]} Ï∫êÎ¶≠ÌÑ∞ ÌîÑÎ°úÌïÑÏùÑ ${lengthGuide[length]} Î∂ÑÎüâÏúºÎ°ú ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.

**Ï§ëÏöî: Ï†úÍ≥µÎêú Ï∫êÎ¶≠ÌÑ∞Ïùò Î™®Îì† ÌäπÏÑ±ÏùÑ Î∞òÎìúÏãú Ìè¨Ìï®Ìï¥Ïïº Ìï©ÎãàÎã§.**

Îã§Ïùå Î™®Îì† ÏöîÏÜåÎì§ÏùÑ Íµ¨Ï≤¥Ï†ÅÏúºÎ°ú Ïñ∏Í∏âÌïòÏó¨ ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî:

üìã Í∏∞Î≥∏Ï†ïÎ≥¥:
- Ïù¥Î¶Ñ: ${character.basic_info?.name}
- ÎÇòÏù¥: ${character.basic_info?.age}ÏÑ∏
- MBTI: ${character.basic_info?.mbti}
- ÏßÅÏóÖ: ${character.basic_info?.occupation}
- ÏÑ±Î≥Ñ: ${character.basic_info?.gender}

‚ú® ÏÑ±Í≤© ÌîÑÎ°úÌïÑ:
- Îß§Î†• Ïä§ÌÉÄÏùº: ${character.appeal_profile?.seduction_style}
- Îß§Î†• Ìè¨Ïù∏Ìä∏: ${Array.isArray(character.appeal_profile?.charm_points) ? character.appeal_profile.charm_points.join(', ') : ''}
- Í∞êÏ†ïÏßÄÎä•: ${character.appeal_profile?.emotional_intelligence}/10
- ÏûêÏã†Í∞ê: ${character.appeal_profile?.confidence_level}/10
- Ïã†ÎπÑÎ°úÏõÄ: ${character.appeal_profile?.mystery_factor}/10
- Ï∑®ÎØ∏: ${Array.isArray(character.appeal_profile?.hobbies) ? character.appeal_profile.hobbies.join(', ') : ''}

üëÑ Ïô∏Î™®Ï†Å ÌäπÏßï:
- Ìó§Ïñ¥: ${character.physical_allure?.appearance?.hair}
- Îàà: ${character.physical_allure?.appearance?.eyes}
- Ï≤¥Ìòï: ${character.physical_allure?.appearance?.body}

üß† MBTI ÏÑ±Í≤© ÌäπÏÑ±:
- MBTI Ïú†Ìòï: ${character.basic_info?.mbti}
- ÏÑ±Í≤© ÌäπÏßï: ${character.basic_info?.mbti} Ïú†ÌòïÏùò ÌäπÏÑ±ÏùÑ Í∞ÄÏßÑ Îß§Î†•Ï†ÅÏù∏ ÏÑ±Í≤©

üí¨ ÎåÄÌôî Ïó≠Ìïô:
- ÎßêÌà¨: ${character.conversation_dynamics?.speech_style}
- Îß§Î†•Ï†Å ÎåÄÌôîÎ≤ï: ${Array.isArray(character.conversation_dynamics?.flirting_patterns) ? character.conversation_dynamics.flirting_patterns.join(', ') : ''}
- ÎåÄÌôî Ï£ºÏ†ú: ${Array.isArray(character.conversation_dynamics?.conversation_hooks) ? character.conversation_dynamics.conversation_hooks.join(', ') : ''}
- Îßê ÏäµÍ¥Ä: ${Array.isArray(character.conversation_dynamics?.speech_habits) ? character.conversation_dynamics.speech_habits.join(', ') : ''}

Îã§Ïùå ÌòïÏãùÏúºÎ°ú ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî:
1. Ï∫êÎ¶≠ÌÑ∞Ïùò ÌïµÏã¨ ÏÑ±Í≤©Í≥º ÌäπÏßï (Ïô∏Î™®, ÏÑ±Í≤©, Îß§Î†• Ìè¨Ïù∏Ìä∏)
2. MBTI ÌäπÏÑ±Ïóê Îî∞Î•∏ ÌñâÎèô Ìå®ÌÑ¥
3. ÎåÄÌôî Ïä§ÌÉÄÏùºÍ≥º ÏÑ†Ìò∏ÌïòÎäî ÏÜåÌÜµ Î∞©Ïãù
4. ÌäπÎ≥ÑÌïú Ï∑®ÎØ∏ÎÇò Í¥ÄÏã¨ÏÇ¨
5. Ï†ÑÎ∞òÏ†ÅÏù∏ Îß§Î†•Í≥º ÌäπÏßï

ÏúÑÏóê Ï†úÍ≥µÎêú Î™®Îì† ÌäπÏÑ±ÏùÑ Îπ†ÏßêÏóÜÏù¥ ÏûêÏó∞Ïä§ÎüΩÍ≤å ÎÖπÏó¨ÏÑú ÌïúÍµ≠Ïñ¥Î°ú Îß§Î†•Ï†ÅÏù∏ Ï∫êÎ¶≠ÌÑ∞ ÌîÑÎ°úÌïÑÏùÑ ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.
Í∞Å ÏàòÏπòÏôÄ Íµ¨Ï≤¥Ï†ÅÏù∏ ÌäπÏßïÎì§ÏùÑ Î™®Îëê Ïñ∏Í∏âÌï¥Ïïº Ìï©ÎãàÎã§.`;
        }

        // ÏÉùÏÑ±Îêú ÌîÑÎ°¨ÌîÑÌä∏ ÌëúÏãú
        function displayGeneratedPrompt(prompt) {
            const previewArea = document.getElementById('promptPreviewArea');
            const previewContent = document.getElementById('promptPreviewContent');

            previewArea.style.display = 'block';
            previewContent.textContent = prompt;

            // Ï†ÄÏû• Î≤ÑÌäº ÌëúÏãú
            const saveButton = previewArea.querySelector('button[onclick="savePromptToCharacter()"]');
            if (saveButton) saveButton.style.display = 'inline-block';

            console.log('üìã ÌîÑÎ°¨ÌîÑÌä∏ ÌëúÏãú ÏôÑÎ£å');
        }

        // ÌîÑÎ°¨ÌîÑÌä∏Î•º Ï∫êÎ¶≠ÌÑ∞Ïóê Ï†ÄÏû•
        async function savePromptToCharacter() {
            if (!currentGeneratedPrompt || !currentPromptCharacterId) {
                showNotification('Ï†ÄÏû•Ìï† ÌîÑÎ°¨ÌîÑÌä∏Í∞Ä ÏóÜÏäµÎãàÎã§.', 'error');
                return;
            }

            try {
                console.log('üíæ Ï∫êÎ¶≠ÌÑ∞Ïóê ÌîÑÎ°¨ÌîÑÌä∏ Ï†ÄÏû• ÏãúÏûë...');

                // Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞Ïóê ÌîÑÎ°¨ÌîÑÌä∏ Ï∂îÍ∞Ä
                const character = window.characters[currentPromptCharacterId];
                if (!character) {
                    throw new Error('Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                }

                character.ai_prompt = currentGeneratedPrompt;
                character.prompt_generated_at = new Date().toISOString();

                // ÏÑúÎ≤ÑÏóê Ï†ÄÏû•
                const saveResponse = await fetch('/api/character-ai-generator', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'save_character',
                        character: character
                    })
                });

                if (!saveResponse.ok) {
                    throw new Error('ÏÑúÎ≤Ñ Ï†ÄÏû• Ïã§Ìå®');
                }

                const saveResult = await saveResponse.json();
                if (!saveResult.success) {
                    throw new Error(saveResult.error || 'Ï†ÄÏû• Ïã§Ìå®');
                }

                // Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
                window.characters[currentPromptCharacterId] = character;

                // Ï∫êÎ¶≠ÌÑ∞ Ïπ¥Îìú Îã§Ïãú Î°úÎìú
                await window.loadCharacters();
                displayCharacters();

                addPromptLog(`${character.basic_info.name}Ïóê ÌîÑÎ°¨ÌîÑÌä∏ Ï†ÄÏû• ÏôÑÎ£å`, 'success');
                showNotification('ÌîÑÎ°¨ÌîÑÌä∏Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!', 'success');

                console.log('‚úÖ ÌîÑÎ°¨ÌîÑÌä∏ Ï†ÄÏû• ÏôÑÎ£å');

            } catch (error) {
                console.error('‚ùå ÌîÑÎ°¨ÌîÑÌä∏ Ï†ÄÏû• Ïò§Î•ò:', error);
                addPromptLog(`ÌîÑÎ°¨ÌîÑÌä∏ Ï†ÄÏû• Ïã§Ìå®: ${error.message}`, 'error');
                showNotification('ÌîÑÎ°¨ÌîÑÌä∏ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
            }
        }

        // ÌîÑÎ°¨ÌîÑÌä∏ Ïû¨ÏÉùÏÑ±
        function regeneratePrompt() {
            if (currentPromptCharacterId) {
                generateCharacterPrompt();
            } else {
                showNotification('Î®ºÏ†Ä Ï∫êÎ¶≠ÌÑ∞Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.', 'warning');
            }
        }

        // ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨
        function copyPromptToClipboard() {
            if (!currentGeneratedPrompt) {
                showNotification('Î≥µÏÇ¨Ìï† ÌîÑÎ°¨ÌîÑÌä∏Í∞Ä ÏóÜÏäµÎãàÎã§.', 'warning');
                return;
            }

            navigator.clipboard.writeText(currentGeneratedPrompt).then(() => {
                showNotification('ÌîÑÎ°¨ÌîÑÌä∏Í∞Ä ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!', 'success');
                addPromptLog('ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ ÏôÑÎ£å', 'info');
            }).catch(err => {
                console.error('ÌÅ¥Î¶ΩÎ≥¥Îìú Î≥µÏÇ¨ Ïã§Ìå®:', err);
                showNotification('ÌÅ¥Î¶ΩÎ≥¥Îìú Î≥µÏÇ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
            });
        }

        // ÌîÑÎ°¨ÌîÑÌä∏ ÏÉùÏÑ± Î°úÍ∑∏ Ï∂îÍ∞Ä
        function addPromptLog(message, type = 'info') {
            const logArea = document.getElementById('promptGenerationLog');
            const logContent = document.getElementById('promptLogContent');

            if (!logContent) return;

            // Î°úÍ∑∏ ÏòÅÏó≠ ÌëúÏãú
            logArea.style.display = 'block';

            // Î°úÍ∑∏ ÏóîÌä∏Î¶¨ ÏÉùÏÑ±
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.style.cssText = 'margin-bottom: 5px; padding: 5px; border-left: 3px solid #ddd; font-size: 12px;';

            const now = new Date();
            const timeStr = now.toLocaleTimeString();

            const typeColor = {
                'info': '#17a2b8',
                'success': '#28a745',
                'error': '#dc3545',
                'warning': '#ffc107'
            };

            logEntry.style.borderLeftColor = typeColor[type] || '#ddd';
            logEntry.innerHTML = `<span style="color: #666;">[${timeStr}]</span> ${message}`;

            // ÏµúÏã† Î°úÍ∑∏Î•º ÏÉÅÎã®Ïóê Ï∂îÍ∞Ä
            logContent.insertBefore(logEntry, logContent.firstChild);

            // Î°úÍ∑∏Í∞Ä ÎÑàÎ¨¥ ÎßéÏúºÎ©¥ Ïò§ÎûòÎêú Í≤É Ï†úÍ±∞ (ÏµúÎåÄ 20Í∞ú)
            while (logContent.children.length > 20) {
                logContent.removeChild(logContent.lastChild);
            }
        }

        // AI Í¥ÄÎ¶¨ ÌÉ≠ ÌôúÏÑ±Ìôî Í∞êÏßÄÎ•º ÏúÑÌïú MutationObserver
        function setupAITabDetection() {
            // AI Í¥ÄÎ¶¨ ÌÉ≠ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Í∞êÏßÄ
            const aiTabButton = document.querySelector('[onclick*="ai-management"]');
            if (aiTabButton) {
                aiTabButton.addEventListener('click', function() {
                    console.log('üß† AI Í¥ÄÎ¶¨ ÌÉ≠ ÌÅ¥Î¶≠ Í∞êÏßÄ');
                    setTimeout(() => {
                        loadCharactersForPromptGeneration();
                    }, 200);
                });
            }

            // MutationObserverÎ°ú AI Í¥ÄÎ¶¨ ÏÑπÏÖòÏù¥ ÌëúÏãúÎê† Îïå Í∞êÏßÄ
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                        const aiSection = document.getElementById('ai-management-section');
                        if (aiSection && aiSection.style.display !== 'none' && !aiSection.style.display.includes('none')) {
                            console.log('üß† AI Í¥ÄÎ¶¨ ÏÑπÏÖò ÌôúÏÑ±Ìôî Í∞êÏßÄ');
                            setTimeout(() => {
                                loadCharactersForPromptGeneration();
                            }, 100);
                        }
                    }
                });
            });

            const aiSection = document.getElementById('ai-management-section');
            if (aiSection) {
                observer.observe(aiSection, { attributes: true, attributeFilter: ['style'] });
            }

            // ÏàòÎèô Î°úÎìú Ìï®ÏàòÎèÑ Í∏ÄÎ°úÎ≤åÎ°ú Îì±Î°ù
            window.loadCharactersForPromptGeneration = loadCharactersForPromptGeneration;

            // ÎîîÎ≤ÑÍπÖÏö© Ï†ÑÏó≠ Ìï®Ïàò Îì±Î°ù
            window.debugCharacterLoading = async function() {
                console.log('üîç === Ï∫êÎ¶≠ÌÑ∞ Î°úÎî© ÎîîÎ≤ÑÍπÖ ÏãúÏûë ===');

                // 1. ÎìúÎ°≠Îã§Ïö¥ ÏöîÏÜå ÌôïÏù∏
                const dropdown = document.getElementById('characterPromptTarget');
                console.log('ÎìúÎ°≠Îã§Ïö¥ ÏöîÏÜå:', dropdown);

                if (!dropdown) {
                    console.error('‚ùå characterPromptTarget ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå');
                    return;
                }

                // 2. API ÏßÅÏ†ë Ìò∏Ï∂ú ÌÖåÏä§Ìä∏
                try {
                    const response = await fetch('/api/character-ai-generator?action=list_characters&_t=' + Date.now());
                    const result = await response.json();
                    console.log('üîó ÏßÅÏ†ë API Ìò∏Ï∂ú Í≤∞Í≥º:', result);

                    // 3. ÏàòÎèôÏúºÎ°ú ÎìúÎ°≠Îã§Ïö¥ Ï±ÑÏö∞Í∏∞
                    await loadCharactersForPromptGeneration();

                    console.log('‚úÖ ÎîîÎ≤ÑÍπÖ ÏôÑÎ£å - ÎìúÎ°≠Îã§Ïö¥ ÏÉÅÌÉú:', dropdown.innerHTML);
                } catch (error) {
                    console.error('‚ùå ÎîîÎ≤ÑÍπÖ Ï§ë Ïò§Î•ò:', error);
                }
            };
        }

        // ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ ÌÜµÌï© Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú v2.3-FUNCTION-RENAME Ï¥àÍ∏∞Ìôî');
            console.log('üîß ÏÇ¨ÏßÑ API: character-ai-generator ÌÜµÌï© Î≤ÑÏ†Ñ ÏÇ¨Ïö©');
            console.log('‚ùå character-photo-manager API ÏôÑÏ†Ñ ÏÇ≠Ï†úÎê®');
            console.log('üîÑ Ìï®ÏàòÎ™Ö Î≥ÄÍ≤Ω: loadCharacterPhotosV2, uploadPhotoToServerV2, deletePhotoV2');
            console.log('üéØ Ïù¥Ï†ú Î™®Îì† ÏÇ¨ÏßÑ Í∏∞Îä•Ïù¥ ÌÜµÌï© APIÎ•º ÏÇ¨Ïö©Ìï©ÎãàÎã§!');
            console.log('üé≠ Ï∫êÎ¶≠ÌÑ∞ ÌîÑÎ°¨ÌîÑÌä∏ ÏÉùÏÑ± ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî');

            // üîê Î°úÍ∑∏Ïù∏ ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî
            initializeAuth();

            // üéØ ÏÑ±Í≤© ÌäπÏÑ± Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Ï¥àÍ∏∞Ìôî
            initializeTraitButtons();

            // AI ÌÉ≠ Í∞êÏßÄ ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî
            setTimeout(() => {
                setupAITabDetection();
                console.log('‚úÖ AI ÌÉ≠ Í∞êÏßÄ ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
            }, 1000);

            // Í∏∞Ï°¥ Ï¥àÍ∏∞ÌôîÎäî Î°úÍ∑∏Ïù∏ ÌõÑÏóê Ïã§Ìñâ
        });

        // üîê ================ Î°úÍ∑∏Ïù∏ Ïù∏Ï¶ù ÏãúÏä§ÌÖú ================

        // Î°úÍ∑∏Ïù∏ ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî
        function initializeAuth() {
            console.log('üîê Î°úÍ∑∏Ïù∏ ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî');

            // ÏÑ∏ÏÖò ÌôïÏù∏
            const savedToken = sessionStorage.getItem('admin_auth_token');
            if (savedToken) {
                console.log('üíæ Ï†ÄÏû•Îêú ÌÜ†ÌÅ∞ ÌôïÏù∏ Ï§ë...');
                checkAuthToken(savedToken);
            } else {
                showLoginModal();
            }

            // Î°úÍ∑∏Ïù∏ Ìèº Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
        }

        // Î°úÍ∑∏Ïù∏ Î™®Îã¨ ÌëúÏãú
        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'flex';
            document.getElementById('adminInterface').style.display = 'none';
        }

        // Î°úÍ∑∏Ïù∏ Î™®Îã¨ Ïà®Í∏∞Í∏∞
        function hideLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('adminInterface').style.display = 'block';
        }

        // Î°úÍ∑∏Ïù∏ Ï≤òÎ¶¨
        async function handleLogin(event) {
            event.preventDefault();

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const statusEl = document.getElementById('loginStatus');

            if (!username || !password) {
                showLoginStatus('ÏÇ¨Ïö©ÏûêÎ™ÖÍ≥º ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }

            showLoginStatus('Î°úÍ∑∏Ïù∏ Ï§ë...', 'loading');

            try {
                const response = await fetch('/api/admin-auth?action=login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (data.success) {
                    console.log('‚úÖ Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ:', data);

                    // ÏÑ∏ÏÖò Ï†ïÎ≥¥ Ï†ÄÏû•
                    currentAuthToken = data.authToken;
                    currentUser = data.user;
                    isAuthenticated = true;

                    sessionStorage.setItem('admin_auth_token', data.authToken);
                    sessionStorage.setItem('admin_user', JSON.stringify(data.user));

                    showLoginStatus('Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ! ÏãúÏä§ÌÖúÏùÑ Ï¥àÍ∏∞ÌôîÌïòÎäî Ï§ë...', 'success');

                    // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
                    updateUserInfo(data.user);

                    // Î°úÍ∑∏Ïù∏Îêú ÏÇ¨Ïö©ÏûêÏùò API ÌÇ§ Î°úÎìú
                    await loadUserApiKey();

                    // Î©îÏù∏ ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî
                    setTimeout(() => {
                        hideLoginModal();
                        initializeMainSystem();
                    }, 1000);

                } else {
                    showLoginStatus(data.message || 'Î°úÍ∑∏Ïù∏Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
                }

            } catch (error) {
                await ErrorLogger.error('Login API Error', error, {
                    action: 'user_login',
                    component: 'auth_system',
                    data: { username: document.getElementById('username').value }
                });
                showLoginStatus('Î°úÍ∑∏Ïù∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message, 'error');
            }
        }

        // ÌÜ†ÌÅ∞ ÌôïÏù∏
        async function checkAuthToken(authToken) {
            try {
                console.log('üîç checkAuthToken ÎîîÎ≤ÑÍπÖ:', {
                    tokenPreview: authToken ? authToken.substring(0, 20) + '...' : 'None',
                    tokenLength: authToken ? authToken.length : 0
                });

                // Authorization Ìó§ÎçîÎ°ú ÌÜ†ÌÅ∞ Ï†ÑÏÜ°
                const response = await fetch('/api/admin-auth?action=check-session', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                const data = await response.json();

                if (data.success && data.authenticated) {
                    console.log('‚úÖ ÌÜ†ÌÅ∞ Ïú†Ìö®Ìï®:', data);

                    currentAuthToken = authToken;
                    currentUser = data.user;
                    isAuthenticated = true;

                    updateUserInfo(data.user);
                    await loadUserApiKey();
                    hideLoginModal();
                    initializeMainSystem();
                } else {
                    console.log('‚ùå ÌÜ†ÌÅ∞ Î¨¥Ìö®Ìï® ÎòêÎäî ÎßåÎ£åÎê®, Î°úÍ∑∏Ïù∏ ÌïÑÏöî');
                    sessionStorage.removeItem('admin_auth_token');
                    sessionStorage.removeItem('admin_user');
                    showLoginModal();
                }
            } catch (error) {
                await ErrorLogger.error('Session Check Error', error, {
                    action: 'check_auth_token',
                    component: 'auth_system'
                });
                showLoginModal();
            }
        }

        // Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú Î©îÏãúÏßÄ ÌëúÏãú
        function showLoginStatus(message, type) {
            const statusEl = document.getElementById('loginStatus');
            statusEl.textContent = message;
            statusEl.className = `login-status ${type}`;
            statusEl.style.display = 'block';
        }

        // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
        function updateUserInfo(user) {
            const userWelcome = document.getElementById('userWelcome');
            if (userWelcome) {
                userWelcome.textContent = `üë§ ${user.username}`;
                if (user.hasApiKey) {
                    userWelcome.textContent += ' üîë';
                }
            }
        }

        // ÏÇ¨Ïö©Ïûê API ÌÇ§ Î°úÎìú
        async function loadUserApiKey() {
            if (!currentAuthToken) return;

            try {
                console.log('üîç loadUserApiKey ÎîîÎ≤ÑÍπÖ:', {
                    tokenPreview: currentAuthToken ? currentAuthToken.substring(0, 20) + '...' : 'None',
                    tokenLength: currentAuthToken ? currentAuthToken.length : 0
                });

                // Authorization Ìó§ÎçîÎ°ú ÌÜ†ÌÅ∞ Ï†ÑÏÜ°
                const response = await fetch('/api/admin-auth?action=get-api-key', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${currentAuthToken}`
                    }
                });
                const data = await response.json();

                if (data.success && data.hasApiKey) {
                    console.log('üîë ÏÇ¨Ïö©Ïûê API ÌÇ§ Î°úÎìúÎê®:', data.keyPreview);

                    // API ÌÇ§Î•º Îã§Î•∏ ÏãúÏä§ÌÖúÏóêÏÑú ÏÇ¨Ïö©Ìï† Ïàò ÏûàÎèÑÎ°ù Ï†ÑÏó≠ ÏÑ§Ï†ï
                    if (data.apiKey) {
                        sessionStorage.setItem('openai_api_key', data.apiKey);
                    }

                    // API ÏÉÅÌÉú ÌôïÏù∏ (Îçî Í∏¥ ÎåÄÍ∏∞ ÏãúÍ∞Ñ)
                    setTimeout(() => {
                        console.log('üîÑ Î°úÍ∑∏Ïù∏ ÌõÑ API ÏÉÅÌÉú ÌôïÏù∏...');
                        checkApiStatus();
                    }, 2000);
                } else {
                    console.log('üìù ÏÇ¨Ïö©Ïûê API ÌÇ§ ÏóÜÏùå');
                }
            } catch (error) {
                console.error('‚ùå API ÌÇ§ Î°úÎìú Ïò§Î•ò:', error);
            }
        }

        // Î°úÍ∑∏ÏïÑÏõÉ
        async function logout() {
            if (!currentAuthToken) return;

            try {
                await fetch('/api/admin-auth?action=logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ authToken: currentAuthToken })
                });
            } catch (error) {
                console.error('‚ùå Î°úÍ∑∏ÏïÑÏõÉ API Ïò§Î•ò:', error);
            }

            // Î°úÏª¨ Ï†ïÎ≥¥ Ï†ïÎ¶¨
            currentAuthToken = null;
            currentUser = null;
            isAuthenticated = false;

            sessionStorage.removeItem('admin_auth_token');
            sessionStorage.removeItem('admin_user');
            sessionStorage.removeItem('openai_api_key');

            // Î°úÍ∑∏Ïù∏ ÌôîÎ©¥ ÌëúÏãú
            showLoginModal();

            // Ìèº Ï¥àÍ∏∞Ìôî
            document.getElementById('loginForm').reset();
            document.getElementById('loginStatus').style.display = 'none';

            console.log('üëã Î°úÍ∑∏ÏïÑÏõÉ ÏôÑÎ£å');
        }

        // Î©îÏù∏ ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî (Î°úÍ∑∏Ïù∏ ÌõÑ Ïã§Ìñâ)
        function initializeMainSystem() {
            console.log('üöÄ Î©îÏù∏ ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî ÏãúÏûë...');

            // API ÏÉÅÌÉú ÌôïÏù∏
            checkAPIStatus();

            // Í∏∞Ï°¥ Ï¥àÍ∏∞Ìôî ÏΩîÎìúÎì§
            initializeEventListeners();

            // Ïò®ÎùºÏù∏ ÏãúÏä§ÌÖúÏúºÎ°ú Ï†ÑÌôò: Î≥ÑÎèÑ Ï¥àÍ∏∞Ìôî ÎåÄÍ∏∞
            console.log('‚è∞ Ïò®ÎùºÏù∏ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ï¥àÍ∏∞Ìôî ÎåÄÍ∏∞ Ï§ë...');

            // Î°úÍ∑∏Ïù∏ ÌõÑ Îç∞Ïù¥ÌÑ∞ Î°úÎìú (Ï∂©Î∂ÑÌïú ÎîúÎ†àÏù¥Î°ú Î™®Îì† Ï¥àÍ∏∞Ìôî ÏôÑÎ£å ÌõÑ Ïã§Ìñâ)
            setTimeout(async () => {
                if (typeof window.loadDataAfterLogin === 'function') {
                    await window.loadDataAfterLogin();
                } else {
                    console.warn('‚ö†Ô∏è loadDataAfterLogin Ìï®ÏàòÍ∞Ä ÏïÑÏßÅ Î°úÎìúÎêòÏßÄ ÏïäÏùå. Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏãúÎèÑ...');
                    // Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏãúÎèÑ
                    try {
                        await loadCharacters();
                        await loadScenarios();
                        await loadTotalEpisodeCount(); // Ï†ÑÏ≤¥ ÏóêÌîºÏÜåÎìú Ïπ¥Ïö¥Ìä∏ Î°úÎìú
                        displayAvailableScenarios(); // ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÏûêÎèô ÌëúÏãú
                    } catch (error) {
                        console.error('‚ùå Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
                    }
                }
            }, 3000);
        }

        // üîê ================ Î°úÍ∑∏Ïù∏ ÏãúÏä§ÌÖú ÎÅù ================

        // API ÌÇ§ ÏûêÎèô Î≥µÏõê Ìï®Ïàò
        function restoreApiKey() {
            try {
                const savedKeyData = localStorage.getItem('chatgame_openai_key');
                if (savedKeyData) {
                    const keyData = JSON.parse(savedKeyData);
                    const savedTime = new Date(keyData.timestamp);
                    const now = new Date();
                    const hoursDiff = (now - savedTime) / (1000 * 60 * 60);

                    // 7Ïùº Ïù¥ÎÇ¥Ïùò ÌÇ§Îßå Î≥µÏõê (Î≥¥Ïïà)
                    if (hoursDiff <= 24 * 7) {
                        console.log('üîë Ï†ÄÏû•Îêú API ÌÇ§ Î≥µÏõê:', keyData.key.substring(0, 4) + '...');

                        // ÏÑúÎ≤ÑÏóê API ÌÇ§ Ïû¨ÏÑ§Ï†ï
                        fetch('/api/save-api-key', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ apiKey: keyData.key })
                        }).then(response => {
                            if (response.ok) {
                                console.log('‚úÖ API ÌÇ§ ÏûêÎèô Î≥µÏõê ÏôÑÎ£å');
                                sessionStorage.setItem('openai_api_key', keyData.key);
                                // ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ (1Ï¥à ÌõÑ)
                                setTimeout(checkApiStatus, 1000);
                            } else {
                                console.warn('‚ö†Ô∏è API ÌÇ§ Î≥µÏõê Ïã§Ìå®');
                            }
                        }).catch(error => {
                            console.warn('‚ö†Ô∏è API ÌÇ§ Î≥µÏõê Ï§ë Ïò§Î•ò:', error);
                        });
                    } else {
                        console.log('‚è∞ Ï†ÄÏû•Îêú API ÌÇ§Í∞Ä ÎÑàÎ¨¥ Ïò§ÎûòÎê® (7Ïùº Ï¥àÍ≥º), Ï†úÍ±∞');
                        localStorage.removeItem('chatgame_openai_key');
                    }
                } else {
                    console.log('üîç Ï†ÄÏû•Îêú API ÌÇ§ ÏóÜÏùå');
                }
            } catch (error) {
                console.error('‚ùå API ÌÇ§ Î≥µÏõê Ïò§Î•ò:', error);
            }
        }

        // Î™®Îì† Îç∞Ïù¥ÌÑ∞ Î°úÎìú (LocalStorage Ïö∞ÏÑ†)
        async function loadAllData() {
            console.log('üìä ÌÜµÌï© Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏãúÏûë...');
            
            try {
                // 1Îã®Í≥Ñ: LocalStorageÏóêÏÑú Î°úÎìú ÏãúÎèÑ
                console.log('üîÑ 1Îã®Í≥Ñ: LocalStorageÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏãúÎèÑ...');
                const localChars = localStorage.getItem('characters');
                const localScenarios = localStorage.getItem('scenarios');
                
                if (localChars) {
                    const parsedChars = JSON.parse(localChars);
                    if (Object.keys(parsedChars).length > 0) {
                        console.log('‚úÖ LocalStorageÏóêÏÑú Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú ÏÑ±Í≥µ:', Object.keys(parsedChars).length, 'Í∞ú');
                        // Ï†ÑÏó≠ Î≥ÄÏàòÏôÄ window ÏÜçÏÑ± Î™®ÎëêÏóê ÏÑ§Ï†ï
                        characters = parsedChars;
                        window.characters = parsedChars;
                        
                        const parsedScenarios = localScenarios ? JSON.parse(localScenarios) : {};
                        scenarios = parsedScenarios;
                        window.scenarios = parsedScenarios;
                        
                        displayCharacters();
                        displayScenarios();
                        updateAllStats();
                        return true;
                    }
                }
                
                // 2Îã®Í≥Ñ: Í∏∞Ï°¥ APIÏóêÏÑú Î°úÎìú ÏãúÎèÑ  
                console.log('üîÑ 2Îã®Í≥Ñ: Í∏∞Ï°¥ APIÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏãúÎèÑ...');
                await loadScenarios();
                await loadCharacters();
                await loadTotalEpisodeCount(); // Ï†ÑÏ≤¥ ÏóêÌîºÏÜåÎìú Ïπ¥Ïö¥Ìä∏ Î°úÎìú
                updateAllStats();
                
                if (window.characters && Object.keys(window.characters).length > 0) {
                    console.log('‚úÖ Í∏∞Ï°¥ APIÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏÑ±Í≥µ');
                    return true;
                }
                
                // Î™®Îì† Î∞©Î≤ï Ïã§Ìå®
                console.log('‚ö†Ô∏è Î™®Îì† Îç∞Ïù¥ÌÑ∞ ÏÜåÏä§ÏóêÏÑú Î°úÎìú Ïã§Ìå® - Îπà ÏÉÅÌÉúÎ°ú ÏãúÏûë');
                window.characters = {};
                window.scenarios = {};
                updateAllStats();
                return false;
                
            } catch (error) {
                console.error('‚ùå Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ï§ë Ïò§Î•ò:', error);
                // Í∏∞Î≥∏Í∞íÏúºÎ°ú ÏÑ§Ï†ï
                window.characters = window.characters || {};
                window.scenarios = window.scenarios || {};
                updateAllStats();
                return false;
            }
        }

        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï¥àÍ∏∞Ìôî
        function initializeEventListeners() {
            // Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉùÍ∏∞Îäî ÎèôÏ†Å Î°úÎî©ÏúºÎ°ú Ï¥àÍ∏∞ÌôîÎê®
            loadCharacterSelector();

            // ÏÉàÎ°úÏö¥ AI Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ± ÏãúÏä§ÌÖú Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑàÎì§
            initializeCharacterGeneratorEvents();

            // ESC ÌÇ§Î°ú Î™®Îã¨ Îã´Í∏∞
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                }
            });

            // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ÏúºÎ°ú Îã´Í∏∞
            window.onclick = function(event) {
                if (event.target.className === 'modal') {
                    // Ï∫êÎ¶≠ÌÑ∞ Î™®Îã¨ÏùÄ Î∞±Í∑∏ÎùºÏö¥Îìú ÌÅ¥Î¶≠ÏúºÎ°ú Îã´ÌûàÏßÄ ÏïäÎèÑÎ°ù ÏòàÏô∏ Ï≤òÎ¶¨
                    if (event.target.id === 'characterModal') {
                        console.log('üö´ Ï∫êÎ¶≠ÌÑ∞ Î™®Îã¨ÏùÄ Î∞±Í∑∏ÎùºÏö¥Îìú ÌÅ¥Î¶≠ÏúºÎ°ú Îã´ÌûàÏßÄ ÏïäÏäµÎãàÎã§');
                        return;
                    }
                    event.target.style.display = 'none';
                }
            }
        }
        
        // Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉùÍ∏∞ ÎèôÏ†Å Î°úÎî©
        async function loadCharacterSelector() {
            console.log('üîÑ Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉùÍ∏∞ Î°úÎî© ÏãúÏûë...');
            
            try {
                const charactersData = window.characters || {};
                const characterKeys = Object.keys(charactersData);
                
                console.log('üìä Î°úÎìúÎêú Ï∫êÎ¶≠ÌÑ∞:', characterKeys.length, 'Í∞ú');
                
                const selector = document.getElementById('characterSelector');
                const loadingMsg = document.getElementById('characterLoadingMsg');
                
                if (characterKeys.length === 0) {
                    loadingMsg.innerHTML = '‚ùå ÏÉùÏÑ±Îêú Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.<br><small>Î®ºÏ†Ä Ï∫êÎ¶≠ÌÑ∞ ÌÉ≠ÏóêÏÑú Ï∫êÎ¶≠ÌÑ∞Î•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.</small>';
                    selector.style.display = 'none';
                    return;
                }
                
                // Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉù ÏòµÏÖò ÏÉùÏÑ±
                let html = '';
                characterKeys.forEach(charId => {
                    const char = charactersData[charId];
                    html += `
                        <div class="character-option" data-id="${charId}">
                            ${char.name} (${char.mbti})<br>
                            <small>${char.personality_traits?.primary?.slice(0, 2).join(', ') || 'ÏÉùÏÑ±Îêú Ï∫êÎ¶≠ÌÑ∞'}</small>
                        </div>
                    `;
                });
                
                selector.innerHTML = html;
                selector.style.display = 'grid';
                loadingMsg.style.display = 'none';
                
                // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä (Îã®Ïùº ÏÑ†ÌÉù)
                selector.querySelectorAll('.character-option').forEach(option => {
                    option.addEventListener('click', function() {
                        const characterId = this.dataset.id;

                        // Í∏∞Ï°¥ ÏÑ†ÌÉù Ìï¥Ï†ú (Î™®Îì† Ï∫êÎ¶≠ÌÑ∞)
                        selector.querySelectorAll('.character-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        selectedCharacters.clear();

                        // ÏÉà Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉù
                        this.classList.add('selected');
                        selectedCharacters.add(characterId);

                        console.log('‚úÖ ÏÑ†ÌÉùÎêú Ï∫êÎ¶≠ÌÑ∞ (Îã®Ïùº):', characterId);
                        console.log('‚úÖ ÏÑ†ÌÉùÎêú Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥:', charactersData[characterId]?.name, charactersData[characterId]?.mbti);
                    });
                });
                
                console.log('‚úÖ Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉùÍ∏∞ Î°úÎî© ÏôÑÎ£å');
                
            } catch (error) {
                console.error('‚ùå Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉùÍ∏∞ Î°úÎî© Ïã§Ìå®:', error);
                document.getElementById('characterLoadingMsg').innerHTML = 
                    '‚ùå Ï∫êÎ¶≠ÌÑ∞ Î°úÎî© Ïã§Ìå®<br><small>ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®ÌïòÍ±∞ÎÇò Ï∫êÎ¶≠ÌÑ∞Î•º Îã§Ïãú ÏÉùÏÑ±Ìï¥Î≥¥ÏÑ∏Ïöî.</small>';
            }
        }
        
        // ÏóêÌîºÏÜåÎìú ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉùÍ∏∞ Î°úÎî©
        async function loadDialogueScenarioSelector() {
            console.log('üîÑ ÏóêÌîºÏÜåÎìú ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉùÍ∏∞ Î°úÎî© ÏãúÏûë...');
            
            try {
                // Î™®Îì† ÏÜåÏä§ÏóêÏÑú ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ ÌÜµÌï© Î°úÎî©
                let scenariosData = {};
                
                // 1. Ï†ÑÏó≠ Î≥ÄÏàò scenarios ÌôïÏù∏
                if (window.scenarios && Object.keys(window.scenarios).length > 0) {
                    scenariosData = { ...window.scenarios };
                    console.log('‚úÖ window.scenariosÏóêÏÑú Î°úÎî©:', Object.keys(scenariosData).length, 'Í∞ú');
                }
                
                // 2. Ï†ÑÏó≠ scenarios Î≥ÄÏàò ÌôïÏù∏
                if (typeof scenarios !== 'undefined' && Object.keys(scenarios).length > 0) {
                    scenariosData = { ...scenariosData, ...scenarios };
                    console.log('‚úÖ Ï†ÑÏó≠ scenariosÏóêÏÑú Ï∂îÍ∞Ä Î°úÎî©:', Object.keys(scenariosData).length, 'Í∞ú');
                }
                
                // 3. LocalStorageÏóêÏÑú Î°úÎî©
                const localScenarios = localStorage.getItem('scenarios');
                if (localScenarios) {
                    const parsedLocal = JSON.parse(localScenarios);
                    scenariosData = { ...scenariosData, ...parsedLocal };
                    console.log('‚úÖ LocalStorageÏóêÏÑú Ï∂îÍ∞Ä Î°úÎî©:', Object.keys(scenariosData).length, 'Í∞ú');
                }
                
                // Î™®Îì† Î≥ÄÏàò ÎèôÍ∏∞Ìôî
                scenarios = scenariosData;
                window.scenarios = scenariosData;
                
                const scenarioKeys = Object.keys(scenariosData);
                console.log('üìä ÏµúÏ¢Ö Î°úÎìúÎêú ÏãúÎÇòÎ¶¨Ïò§:', scenarioKeys.length, 'Í∞ú');
                console.log('üìã ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù:', scenarioKeys.map(id => `${id}: ${scenariosData[id]?.title || 'Ï†úÎ™©ÏóÜÏùå'}`));
                
                const selector = document.getElementById('dialogueScenarioSelect');
                if (!selector) {
                    return; // Ïπ¥Îìú Í∏∞Î∞ò UI ÏÇ¨Ïö©
                }
                
                // Í∏∞Î≥∏ ÏòµÏÖò Ïú†ÏßÄ
                let html = '<option value="">ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>';
                
                if (scenarioKeys.length === 0) {
                    html += '<option value="" disabled>ÏÉùÏÑ±Îêú ÏãúÎÇòÎ¶¨Ïò§Í∞Ä ÏóÜÏäµÎãàÎã§</option>';
                } else {
                    scenarioKeys.forEach(scenarioId => {
                        const scenario = scenariosData[scenarioId];
                        if (scenario && scenario.title) {
                            html += `<option value="${scenarioId}">${scenario.title}</option>`;
                        } else {
                            console.warn('‚ö†Ô∏è ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ Î∂àÏôÑÏ†Ñ:', scenarioId, scenario);
                            html += `<option value="${scenarioId}">ÏãúÎÇòÎ¶¨Ïò§ ${scenarioId}</option>`;
                        }
                    });
                }
                
                selector.innerHTML = html;
                console.log('‚úÖ ÏóêÌîºÏÜåÎìú ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉùÍ∏∞ Î°úÎî© ÏôÑÎ£å');
                console.log('üîç ÏÉùÏÑ±Îêú HTML:', html);
                
            } catch (error) {
                console.error('‚ùå ÏóêÌîºÏÜåÎìú ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉùÍ∏∞ Î°úÎî© Ïã§Ìå®:', error);
                // ÏóêÎü¨ Î∞úÏÉù ÏãúÏóêÎèÑ Í∏∞Î≥∏ ÏÑ†ÌÉùÏßÄÎäî Ï†úÍ≥µ
                const selector = document.getElementById('dialogueScenarioSelect');
                if (selector) {
                    selector.innerHTML = '<option value="">ÏãúÎÇòÎ¶¨Ïò§ Î°úÎî© Ïò§Î•ò</option>';
                }
            }
        }
        
        // ÏãúÎÇòÎ¶¨Ïò§ Î≥ÄÍ≤Ω Ïãú Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
        function onScenarioChange() {
            const scenarioId = document.getElementById('dialogueScenarioSelect').value;
            console.log('üîÑ ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§:', scenarioId);
            
            const characterSelect = document.getElementById('characterSelect');
            
            if (!scenarioId) {
                characterSelect.innerHTML = '<option value="">Î®ºÏ†Ä ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>';
                return;
            }
            
            try {
                const scenariosData = window.scenarios || {};
                const scenario = scenariosData[scenarioId];
                
                if (!scenario) {
                    characterSelect.innerHTML = '<option value="">ÏãúÎÇòÎ¶¨Ïò§Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§</option>';
                    return;
                }
                
                console.log('üìä ÏãúÎÇòÎ¶¨Ïò§ ÏÇ¨Ïö©Í∞ÄÎä• Ï∫êÎ¶≠ÌÑ∞:', scenario.available_characters);
                
                let html = '<option value="">Ï∫êÎ¶≠ÌÑ∞Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>';
                
                if (scenario.available_characters && scenario.available_characters.length > 0) {
                    const charactersData = window.characters || {};
                    
                    scenario.available_characters.forEach(charId => {
                        const character = charactersData[charId];
                        if (character) {
                            html += `<option value="${charId}">${character.name} (${character.mbti})</option>`;
                        } else {
                            // Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥Í∞Ä ÏóÜÎäî Í≤ΩÏö∞ IDÎßå ÌëúÏãú
                            html += `<option value="${charId}">${charId}</option>`;
                        }
                    });
                } else {
                    html += '<option value="" disabled>Ïù¥ ÏãúÎÇòÎ¶¨Ïò§Ïóê ÏÇ¨Ïö©Í∞ÄÎä•Ìïú Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</option>';
                }
                
                characterSelect.innerHTML = html;
                
                // Ïà®Í≤®ÏßÑ ÌïÑÎìúÏóêÎèÑ ÏãúÎÇòÎ¶¨Ïò§ ID ÏÑ§Ï†ï
                document.getElementById('dialogueScenarioId').value = scenarioId;
                
                console.log('‚úÖ Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
                
            } catch (error) {
                console.error('‚ùå Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®:', error);
                characterSelect.innerHTML = '<option value="">Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§</option>';
            }
        }
        
        // ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ® (Î©îÏù∏ ÏãúÎÇòÎ¶¨Ïò§ ÏÑπÏÖò)
        async function refreshScenarioList() {
            console.log('üîÑ ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®...');
            try {
                await loadScenarios();
                console.log('‚úÖ ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ® ÏôÑÎ£å');
            } catch (error) {
                console.error('‚ùå ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ® Ïã§Ìå®:', error);
                throw error;
            }
        }

        // ÎåÄÌôî ÏÑπÏÖòÏùò ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
        // Íµ¨ ÏãúÏä§ÌÖú ÏÉàÎ°úÍ≥†Ïπ® Ìï®Ïàò - ÏÉà ÏãúÏä§ÌÖúÏúºÎ°ú ÎåÄÏ≤¥
        async function refreshDialogueScenarioList() {
            console.log('üîÑ [Íµ¨ ÏãúÏä§ÌÖú] ÎåÄÌôî ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ® - ÏÉà ÏãúÏä§ÌÖúÏúºÎ°ú ÎåÄÏ≤¥Îê®');

            try {
                // ÏÉà ÏãúÏä§ÌÖúÏùò ÏÉàÎ°úÍ≥†Ïπ® Ìï®Ïàò Ìò∏Ï∂ú
                if (typeof refreshEpisodeScenarioList === 'function') {
                    await refreshEpisodeScenarioList();
                } else {
                    console.warn('‚ö†Ô∏è refreshEpisodeScenarioList Ìï®ÏàòÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                }
            } catch (error) {
                console.error('‚ùå ÏóêÌîºÏÜåÎìú ÏãúÎÇòÎ¶¨Ïò§ ÏÉàÎ°úÍ≥†Ïπ® Ïã§Ìå®:', error);
            }
        }
        
        // ÏóêÌîºÏÜåÎìú ÏÑπÏÖòÏóê ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÌëúÏãú (Íµ¨ ÏãúÏä§ÌÖú - ÏÉà ÏãúÏä§ÌÖúÏúºÎ°ú ÎåÄÏ≤¥Îê®)
        function displayAvailableScenarios() {
            console.log('üìã [Íµ¨ ÏãúÏä§ÌÖú] displayAvailableScenarios Ìò∏Ï∂úÎê® - ÏÉà ÏãúÏä§ÌÖúÏúºÎ°ú ÎåÄÏ≤¥Îê®');

            // ÏÉà ÏãúÏä§ÌÖúÏùò ÏóêÌîºÏÜåÎìú ÏãúÎÇòÎ¶¨Ïò§ ÌëúÏãú Ìï®Ïàò Ìò∏Ï∂ú
            if (typeof displayEpisodeScenarios === 'function') {
                displayEpisodeScenarios();
            } else {
                console.warn('‚ö†Ô∏è displayEpisodeScenarios Ìï®ÏàòÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
            }
        }

        // Íµ¨ ÏãúÏä§ÌÖú ÏóêÌîºÏÜåÎìú ÏãúÎÇòÎ¶¨Ïò§ Ïπ¥Îìú Î°úÎî© - ÏÉà ÏãúÏä§ÌÖúÏúºÎ°ú ÎåÄÏ≤¥
        async function loadDialogueScenarioCards() {
            console.log('üîÑ [Íµ¨ ÏãúÏä§ÌÖú] ÏóêÌîºÏÜåÎìú ÏãúÎÇòÎ¶¨Ïò§ Ïπ¥Îìú Î°úÎî© - ÏÉà ÏãúÏä§ÌÖúÏúºÎ°ú ÎåÄÏ≤¥Îê®');

            try {
                // ÏÉà ÏãúÏä§ÌÖúÏùò ÏãúÎÇòÎ¶¨Ïò§ ÌëúÏãú Ìï®Ïàò Ìò∏Ï∂ú
                if (typeof displayEpisodeScenarios === 'function') {
                    await displayEpisodeScenarios();
                } else {
                    console.warn('‚ö†Ô∏è displayEpisodeScenarios Ìï®ÏàòÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                }
            } catch (error) {
                console.error('‚ùå ÏóêÌîºÏÜåÎìú ÏãúÎÇòÎ¶¨Ïò§ ÌëúÏãú Ïã§Ìå®:', error);
            }
        }

        // ÏãúÎÇòÎ¶¨Ïò§ Ïπ¥Îìú ÏÑ†ÌÉù (Íµ¨ ÏãúÏä§ÌÖú - ÏÉà ÏãúÏä§ÌÖúÏúºÎ°ú ÎåÄÏ≤¥)
        function selectScenarioCard(scenarioId) {
            console.log('üéØ [Íµ¨ ÏãúÏä§ÌÖú] ÏãúÎÇòÎ¶¨Ïò§ Ïπ¥Îìú ÏÑ†ÌÉùÎê® - ÏÉà ÏãúÏä§ÌÖúÏúºÎ°ú ÎåÄÏ≤¥:', scenarioId);

            // ÏÉà ÏãúÏä§ÌÖúÏùò ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉù Ìï®Ïàò Ìò∏Ï∂ú
            if (typeof selectEpisodeScenario === 'function') {
                selectEpisodeScenario(scenarioId);
            } else {
                console.warn('‚ö†Ô∏è selectEpisodeScenario Ìï®ÏàòÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
            }
        }

        // ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§ Ï†ïÎ≥¥ ÌëúÏãú
        function showSelectedScenarioInfo(scenarioId) {
            const scenario = window.scenarios?.[scenarioId];
            const display = document.getElementById('selectedScenarioDisplay');
            const info = document.getElementById('selectedScenarioInfo');

            if (scenario && display && info) {
                const characterId = scenario.available_characters?.[0];
                const character = window.characters?.[characterId];

                info.innerHTML = `
                    <div class="info-title">${scenario.title}</div>
                    <div class="info-character">Ï∫êÎ¶≠ÌÑ∞: ${character ? character.name : characterId || 'Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥ ÏóÜÏùå'}</div>
                    <div class="info-description">${scenario.description}</div>
                `;

                display.style.display = 'block';
            }
        }

        // ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉù Ìï¥Ï†ú
        function clearScenarioSelection() {
            currentScenarioId = null;

            // Ïπ¥Îìú ÏÑ†ÌÉù Ìï¥Ï†ú
            document.querySelectorAll('.scenario-selection-card').forEach(card => {
                card.classList.remove('selected');
            });

            // ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§ Ï†ïÎ≥¥ Ïà®Í∏∞Í∏∞
            document.getElementById('selectedScenarioDisplay').style.display = 'none';

            // ÏóêÌîºÏÜåÎìú Ï†ïÎ≥¥ Ïà®Í∏∞Í∏∞
            const dialogueInfo = document.getElementById('dialogueInfo');
            if (dialogueInfo) {
                dialogueInfo.style.display = 'none';
            }

            console.log('‚úÖ ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉù Ìï¥Ï†úÎê®');
        }

        // ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉù (ÏóêÌîºÏÜåÎìú ÏÑπÏÖòÏóêÏÑú)
        function selectScenarioForDialogue(scenarioId) {
            console.log('üéØ ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉùÎê®:', scenarioId);

            // Ï†ÑÏó≠ Î≥ÄÏàòÏóê ÌòÑÏû¨ ÏãúÎÇòÎ¶¨Ïò§ ID ÏÑ§Ï†ï
            currentScenarioId = scenarioId;
            console.log('‚úÖ currentScenarioId ÏÑ§Ï†ïÎê®:', currentScenarioId);

            const dialogueSelect = document.getElementById('dialogueScenarioSelect');
            if (dialogueSelect) {
                dialogueSelect.value = scenarioId;
            }

            // ÏóêÌîºÏÜåÎìú Î°úÎî©
            loadDialogues();

            // ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§ ÌïòÏù¥ÎùºÏù¥Ìä∏
            document.querySelectorAll('.scenario-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.closest('.scenario-item').classList.add('selected');
        }

        // ÌÉ≠ Ï†ÑÌôò (Ï†ÑÏó≠ Ìï®Ïàò)
        // ÏµúÏÉÅÎã®ÏúºÎ°ú Ïä§ÌÅ¨Î°§
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        function switchTab(tabName) {
            // Î™®Îì† ÌÉ≠Í≥º ÏÑπÏÖò ÎπÑÌôúÏÑ±Ìôî
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));

            // ÏÑ†ÌÉùÎêú ÌÉ≠Í≥º ÏÑπÏÖò ÌôúÏÑ±Ìôî
            event.target.classList.add('active');
            document.getElementById(`${tabName}-section`).classList.add('active');

            // Ï∫êÎ¶≠ÌÑ∞ ÌÉ≠ ÏÑ†ÌÉù Ïãú Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®
            if (tabName === 'characters') {
                setTimeout(() => {
                    console.log('üîÑ Ï∫êÎ¶≠ÌÑ∞ ÌÉ≠ Ï†ÑÌôò - Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®');
                    loadCharacters();
                }, 50);
            }

            // ÏãúÎÇòÎ¶¨Ïò§ ÌÉ≠ ÏÑ†ÌÉù Ïãú Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ® Î∞è CSS Ï†ÅÏö© Î≥¥Ïû•
            if (tabName === 'scenarios') {
                setTimeout(() => {
                    console.log('üîÑ ÏãúÎÇòÎ¶¨Ïò§ ÌÉ≠ Ï†ÑÌôò - Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®');
                    loadScenarios();
                }, 50);
            }

            // ÏóêÌîºÏÜåÎìú ÌÉ≠ ÏÑ†ÌÉù Ïãú ÏÉàÎ°úÏö¥ ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî
            if (tabName === 'dialogues') {
                setTimeout(async () => {
                    console.log('üîÑ ÏóêÌîºÏÜåÎìú ÌÉ≠ Ï†ÑÌôò - ÏÉàÎ°úÏö¥ ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî');

                    try {
                        // ÏÉàÎ°úÏö¥ ÏóêÌîºÏÜåÎìú Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî
                        initializeEpisodeTab();

                        console.log('‚úÖ ÏóêÌîºÏÜåÎìú ÌÉ≠ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
                    } catch (error) {
                        console.error('‚ùå ÏóêÌîºÏÜåÎìú ÌÉ≠ Ï¥àÍ∏∞Ìôî Ïã§Ìå®:', error);
                    }
                }, 50);
            }

            // API ÏÑ§Ï†ï ÌÉ≠ ÏÑ†ÌÉù Ïãú ÏÉÅÌÉú ÌôïÏù∏
            if (tabName === 'settings') {
                checkApiStatus();
            }

            // AI Í¥ÄÎ¶¨ ÌÉ≠ ÏÑ†ÌÉù Ïãú ÏÑ§Ï†ï Î°úÎìú
            if (tabName === 'ai-management') {
                loadAISettings();
            }
        }

        // === API Í¥ÄÎ¶¨ Ìï®ÏàòÎì§ ===
        
        // API ÌÇ§ ÌëúÏãú/Ïà®ÍπÄ ÌÜ†Í∏Ä
        function toggleApiKeyVisibility() {
            const input = document.getElementById('openaiApiKey');
            const button = document.getElementById('toggleApiKey');
            
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = 'üôà';
            } else {
                input.type = 'password';
                button.textContent = 'üëÅÔ∏è';
            }
        }

        // Í∞ÑÎã®Ìïú API ÌÇ§ Ï†ÄÏû• (ÏÉàÎ°úÏö¥ Î∞©Ïãù)
        // Vercel ÎåÄÏãúÎ≥¥Îìú Ïó¥Í∏∞
        function openVercelDashboard() {
            window.open('https://vercel.com/dashboard', '_blank');
            showNotification('üöÄ Vercel ÎåÄÏãúÎ≥¥ÎìúÍ∞Ä ÏÉà ÌÉ≠ÏóêÏÑú Ïó¥Î†∏ÏäµÎãàÎã§. ÌîÑÎ°úÏ†ùÌä∏Î•º ÏÑ†ÌÉùÌïòÍ≥† Environment VariablesÎ•º ÏÑ§Ï†ïÌïòÏÑ∏Ïöî.', 'info');
        }

        // API Ïó∞Í≤∞ ÌÖåÏä§Ìä∏
        async function testApiConnection() {
            const testResults = document.getElementById('apiTestResults');
            testResults.style.display = 'block';
            testResults.className = 'test-results';
            testResults.innerHTML = '<div class="loading">üß™ API Ïó∞Í≤∞ ÌÖåÏä§Ìä∏ Ï§ë...</div>';
            
            // ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('openaiStatus').textContent = 'üîÑ ÌÖåÏä§Ìä∏ Ï§ë...';
            document.getElementById('openaiStatus').className = 'status-testing';

            try {
                // ÏÑ∏ÏÖòÏóêÏÑú API ÌÇ§ Í∞ÄÏ†∏Ïò§Í∏∞
                const sessionApiKey = sessionStorage.getItem('openai_api_key');
                
                // Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ± APIÎ•º ÌÜµÌï¥ Ïó∞Í≤∞ ÌÖåÏä§Ìä∏
                const response = await fetch('/api/test-openai-connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                        // OpenAI ÌÇ§Îäî ÏÑúÎ≤ÑÏÇ¨Ïù¥ÎìúÏóêÏÑú ÌôòÍ≤ΩÎ≥ÄÏàòÎ°ú Ï≤òÎ¶¨
                    },
                    body: JSON.stringify({
                        useSessionKey: true
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    testResults.className = 'test-results success';
                    testResults.innerHTML = `
                        <h4>‚úÖ Ïó∞Í≤∞ ÌÖåÏä§Ìä∏ ÏÑ±Í≥µ!</h4>
                        <p><strong>Î™®Îç∏:</strong> ${data.model || 'GPT-4o-mini'}</p>
                        <p><strong>ÏùëÎãµ ÏãúÍ∞Ñ:</strong> ${data.responseTime || 'ÌôïÏù∏ Ï§ë'}ms</p>
                        <p><strong>ÌÜ†ÌÅ∞ ÏÇ¨Ïö©Îüâ:</strong> ${data.tokensUsed || 'ÌôïÏù∏ Ï§ë'} tokens</p>
                        <p><strong>ÌÖåÏä§Ìä∏ ÏãúÍ∞Ñ:</strong> ${new Date().toLocaleString()}</p>
                    `;
                    
                    document.getElementById('openaiStatus').textContent = '‚úÖ Ïó∞Í≤∞Îê®';
                    document.getElementById('openaiStatus').className = 'status-connected';
                    document.getElementById('lastTest').textContent = new Date().toLocaleString();
                    document.getElementById('apiStatus').textContent = '‚úÖ';
                } else {
                    throw new Error(data.message || 'ÌÖåÏä§Ìä∏ Ïã§Ìå®');
                }
                
            } catch (error) {
                console.error('API ÌÖåÏä§Ìä∏ Ïò§Î•ò:', error);
                
                testResults.className = 'test-results error';
                testResults.innerHTML = `
                    <h4>‚ùå Ïó∞Í≤∞ ÌÖåÏä§Ìä∏ Ïã§Ìå®</h4>
                    <p><strong>Ïò§Î•ò:</strong> ${error.message}</p>
                    <p><strong>Ìï¥Í≤∞ Î∞©Î≤ï:</strong></p>
                    <ul>
                        <li>API ÌÇ§Í∞Ä Ïò¨Î∞îÎ•∏ÏßÄ ÌôïÏù∏</li>
                        <li>OpenAI Í≥ÑÏ†ïÏóê Ï∂©Î∂ÑÌïú ÌÅ¨Î†àÎîßÏù¥ ÏûàÎäîÏßÄ ÌôïÏù∏</li>
                        <li>API ÌÇ§ Í∂åÌïú ÏÑ§Ï†ï ÌôïÏù∏</li>
                    </ul>
                `;
                
                document.getElementById('openaiStatus').textContent = '‚ùå Ïó∞Í≤∞ Ïã§Ìå®';
                document.getElementById('openaiStatus').className = 'status-disconnected';
                document.getElementById('apiStatus').textContent = '‚ùå';
            }
        }

        // API ÏÉÅÌÉú ÌôïÏù∏ (ÌôòÍ≤ΩÎ≥ÄÏàò Í∏∞Î∞ò)
        async function checkApiStatus() {
            try {
                console.log('üîç API ÌÇ§ ÏÉÅÌÉú ÌôïÏù∏ ÏãúÏûë...');

                // ÌôòÍ≤ΩÎ≥ÄÏàòÎäî ÏÑúÎ≤ÑÏÇ¨Ïù¥ÎìúÏóêÏÑúÎßå ÌôïÏù∏ Í∞ÄÎä•ÌïòÎØÄÎ°ú Í∞ÑÎã®Ìïú ÌÖåÏä§Ìä∏ API ÏÇ¨Ïö©
                const response = await fetch(`/api/character-ai-generator?action=list_characters&_t=${Date.now()}`);
                const data = await response.json();

                console.log('üìã API ÏÉÅÌÉú:', data.success ? 'Ï†ïÏÉÅ' : 'Ïò§Î•ò');

                const statusElement = document.getElementById('openaiStatus');

                if (data.success) {
                    console.log('‚úÖ API ÏÑúÎπÑÏä§Í∞Ä Ï†ïÏÉÅ ÏûëÎèô Ï§ë');

                    statusElement.innerHTML = `
                        <span class="status-indicator">‚úÖ</span>
                        <span class="status-text">API ÏÑúÎπÑÏä§ Ï†ïÏÉÅ ÏûëÎèô</span>
                    `;
                    statusElement.style.color = '#28a745';

                    showNotification('‚úÖ API ÏÑúÎπÑÏä§Í∞Ä Ï†ïÏÉÅÏ†ÅÏúºÎ°ú ÏûëÎèôÌï©ÎãàÎã§.', 'success');

                } else {
                    console.log('‚ùå API ÏÑúÎπÑÏä§ Ïò§Î•ò');

                    statusElement.innerHTML = `
                        <span class="status-indicator">‚ùå</span>
                        <span class="status-text">Vercel ÌôòÍ≤ΩÎ≥ÄÏàòÏóê OPENAI_API_KEYÍ∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§</span>
                    `;
                    statusElement.style.color = '#dc3545';

                    showNotification('‚ùå API ÌÇ§Í∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. Vercel ÎåÄÏãúÎ≥¥ÎìúÏóêÏÑú OPENAI_API_KEY ÌôòÍ≤ΩÎ≥ÄÏàòÎ•º ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.', 'error');
                }

            } catch (error) {
                console.error('‚ùå API ÏÉÅÌÉú ÌôïÏù∏ Ïò§Î•ò:', error);

                const statusElement = document.getElementById('openaiStatus');
                statusElement.innerHTML = `
                    <span class="status-indicator">‚ö†Ô∏è</span>
                    <span class="status-text">API Ïó∞Í≤∞ Ïã§Ìå®: ${error.message}</span>
                `;
                statusElement.style.color = '#ffc107';

                // Íµ¨Ï≤¥Ï†ÅÏù∏ ÏóêÎü¨ Î©îÏãúÏßÄÏôÄ Ìï¥Í≤∞Î∞©Î≤ï Ï†úÍ≥µ
                const errorMessage = `‚ùå API Ïó∞Í≤∞ Ïã§Ìå®\n\n${error.message}\n\nÌï¥Í≤∞Î∞©Î≤ï:\n1. Ïù∏ÌÑ∞ÎÑ∑ Ïó∞Í≤∞ ÌôïÏù∏\n2. Vercel ÎåÄÏãúÎ≥¥ÎìúÏóêÏÑú ÌôòÍ≤ΩÎ≥ÄÏàò ÌôïÏù∏\n3. GitHub API ÏÉÅÌÉú ÌôïÏù∏\n4. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑ`;

                showNotification(errorMessage, 'error');
            }
        }

        // API ÌÇ§ ÏÇ≠Ï†ú (Î°úÍ∑∏Ïù∏ Í∏∞Î∞ò + Secure Storage)
        async function clearApiKey() {
            if (!confirm('Ï†ïÎßêÎ°ú API ÌÇ§Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.\n\n(GitHub ÏïîÌò∏Ìôî Ï†ÄÏû•ÏÜåÏóêÏÑú ÏôÑÏ†ÑÌûà ÏÇ≠Ï†úÎê©ÎãàÎã§)')) {
                return;
            }

            try {
                console.log('üóëÔ∏è API ÌÇ§ ÏïàÏ†Ñ ÏÇ≠Ï†ú ÏãúÎèÑ...');

                // Î°úÍ∑∏Ïù∏Îêú ÏÇ¨Ïö©ÏûêÏùò ÌÜ†ÌÅ∞ Í∏∞Î∞ò ÏÇ≠Ï†ú
                if (currentAuthToken) {
                    const response = await fetch('/api/admin-auth?action=delete-api-key', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${currentAuthToken}`
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        console.log('‚úÖ ÌÜ†ÌÅ∞ Í∏∞Î∞ò API ÌÇ§ ÏÇ≠Ï†ú ÏÑ±Í≥µ:', data.message);

                        // ÌÜ†ÌÅ∞ Í∏∞Î∞ò: ÏùëÎãµÏóêÏÑú ÏóÖÎç∞Ïù¥Ìä∏Îêú ÌÜ†ÌÅ∞ Ï≤òÎ¶¨
                        if (data.authToken && data.authToken !== currentAuthToken) {
                            console.log('üîÑ ÌÜ†ÌÅ∞ ÏóÖÎç∞Ïù¥Ìä∏ (hasApiKey=false ÏÉÅÌÉú Î≥ÄÍ≤Ω)');
                            currentAuthToken = data.authToken;
                            sessionStorage.setItem('admin_auth_token', data.authToken);
                        }

                        showNotification('‚úÖ API ÌÇ§Í∞Ä ÏïàÏ†ÑÌïòÍ≤å ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§!\n(ÌÜ†ÌÅ∞ Í∏∞Î∞ò ÏïîÌò∏Ìôî Ï†ÄÏû•ÏÜåÏóêÏÑú ÏôÑÏ†Ñ Ï†úÍ±∞Îê®)', 'success');
                    } else {
                        const error = await response.json();
                        console.warn('‚ö†Ô∏è Î°úÍ∑∏Ïù∏ Í∏∞Î∞ò ÏÇ≠Ï†ú Ïã§Ìå®, ÏùºÎ∞ò ÏÇ≠Ï†ú ÏãúÎèÑ:', error.message);

                        // ÏùºÎ∞ò ÏÇ≠Ï†ú API ÏãúÎèÑ
                        await fallbackDeleteApiKey();
                        return;
                    }
                } else {
                    // Î°úÍ∑∏Ïù∏ÎêòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞ ÏùºÎ∞ò ÏÇ≠Ï†ú
                    await fallbackDeleteApiKey();
                    return;
                }

                // Î∏åÎùºÏö∞Ï†Ä ÏÑ∏ÏÖòÏóêÏÑúÎèÑ ÏÇ≠Ï†ú
                sessionStorage.removeItem('openai_api_key');

                // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
                if (currentUser) {
                    currentUser.hasApiKey = false;
                    updateUserInfo(currentUser);
                }

                // API ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                setTimeout(() => {
                    console.log('üîÑ API ÌÇ§ ÏÇ≠Ï†ú ÌõÑ ÏÉÅÌÉú ÌôïÏù∏...');
                    checkApiStatus();
                }, 1000);

                document.getElementById('apiTestResults').style.display = 'none';

            } catch (error) {
                console.error('‚ùå API ÌÇ§ ÏÇ≠Ï†ú Ïò§Î•ò:', error);
                showNotification('‚ùå API ÌÇ§ ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message, 'error');
            }
        }

        // ÏùºÎ∞ò API ÌÇ§ ÏÇ≠Ï†ú (fallback)
        async function fallbackDeleteApiKey() {
            console.log('üîÑ ÏùºÎ∞ò API ÌÇ§ ÏÇ≠Ï†ú ÏãúÎèÑ...');

            const response = await fetch('/api/clear-api-key', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const data = await response.json();
                console.log('‚úÖ ÏùºÎ∞ò API ÌÇ§ ÏÇ≠Ï†ú ÏÑ±Í≥µ:', data.message);
                showNotification('‚úÖ API ÌÇ§Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§!\n' + (data.note || ''), 'success');
            } else {
                const error = await response.json();
                throw new Error(error.message || 'ÏùºÎ∞ò ÏÇ≠Ï†úÎèÑ Ïã§Ìå®ÌñàÏäµÎãàÎã§');
            }
        }

        // === ÏãúÎÇòÎ¶¨Ïò§ Í¥ÄÎ¶¨ Ìï®ÏàòÎì§ ===
        
        // üöÄ GitHub API ÏãúÎÇòÎ¶¨Ïò§ Ï†ÄÏû• Ìï®Ïàò (ÌòÅÏã†Ï†Å!)
        async function saveScenarioToGitHub(scenario) {
            try {
                console.log('üêô GitHub APIÎ°ú ÏãúÎÇòÎ¶¨Ïò§ Ï†ÄÏû• ÏãúÏûë:', scenario.title);
                
                // GitHub ÌÜ†ÌÅ∞ÏùÄ ÏÑúÎ≤ÑÏÇ¨Ïù¥ÎìúÏóêÏÑú ÌôòÍ≤ΩÎ≥ÄÏàòÎ°ú Ï≤òÎ¶¨
                
                // ÏãúÎÇòÎ¶¨Ïò§ ID ÏÉùÏÑ± (ÏóÜÏúºÎ©¥)
                if (!scenario.id && !scenario.scenario_id) {
                    scenario.id = `scenario_${Date.now()}`;
                    scenario.scenario_id = scenario.id;
                    console.log('üîß ÏãúÎÇòÎ¶¨Ïò§ ID ÏÉùÏÑ±:', scenario.id);
                }
                
                // Í∏∞Ï°¥ ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù Î°úÎìú
                const existingScenarios = await loadScenariosFromGitHub();
                console.log('üìä Í∏∞Ï°¥ GitHub ÏãúÎÇòÎ¶¨Ïò§ Ïàò:', Object.keys(existingScenarios).length);
                
                // ÏÉà ÏãúÎÇòÎ¶¨Ïò§ Ï∂îÍ∞Ä
                const scenarioId = scenario.id || scenario.scenario_id;
                existingScenarios[scenarioId] = {
                    ...scenario,
                    last_modified: new Date().toISOString(),
                    source: 'github_api',
                    commit_hash: 'pending'
                };
                
                // GitHubÏóê Ïª§Î∞ãÌï† Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞ ÏÉùÏÑ±
                const scenarioData = {
                    metadata: {
                        version: "1.0.0",
                        created_date: new Date().toISOString().split('T')[0],
                        total_scenarios: Object.keys(existingScenarios).length,
                        ai_context_engine: "claude-3.5-sonnet",
                        source: "github_api"
                    },
                    scenarios: existingScenarios,
                    scenario_templates: {
                        romance_template: {
                            mood_options: ["ÏÑ§Î†ò", "Î∂ÄÎÅÑÎü¨ÏõÄ", "Í∏¥Ïû•Í∞ê", "Îã¨ÏΩ§Ìï®", "Ïï†Ï†àÌï®"],
                            setting_options: ["Ïπ¥Ìéò", "ÌïôÍµê", "Ïßë", "Í≥µÏõê", "ÎèÑÏÑúÍ¥Ä", "Í±∞Î¶¨"],
                            time_options: ["ÏïÑÏπ®", "Ï†êÏã¨", "Ï†ÄÎÖÅ", "Î∞§", "ÏÉàÎ≤Ω"]
                        }
                    }
                };
                
                // GitHub RepositoryÏóê ÏßÅÏ†ë Ïª§Î∞ã
                const commitMessage = `Add scenario: ${scenario.title}`;
                const commitResult = await commitToGitHub('data/scenarios/scenario-database.json', scenarioData, commitMessage);
                
                if (commitResult.success) {
                    // Ïª§Î∞ã Ìï¥Ïãú ÏóÖÎç∞Ïù¥Ìä∏
                    existingScenarios[scenarioId].commit_hash = commitResult.sha;
                    
                    // Î°úÏª¨ Î∞±ÏóÖÎèÑ Ï†ÄÏû•
                    localStorage.setItem('chatgame_scenarios', JSON.stringify(existingScenarios));
                    
                    console.log('‚úÖ GitHub API ÏãúÎÇòÎ¶¨Ïò§ Ï†ÄÏû• ÏôÑÎ£å! Ïª§Î∞ã SHA:', commitResult.sha);
                    console.log('üìù GitHubÏóê Ï†ÄÏû•Îêú ÏãúÎÇòÎ¶¨Ïò§ IDÎì§:', Object.keys(existingScenarios));
                    
                    return { success: true, commit_hash: commitResult.sha, url: commitResult.html_url };
                } else {
                    throw new Error('GitHub commit failed: ' + commitResult.error);
                }
                
            } catch (error) {
                console.error('‚ùå GitHub API ÏãúÎÇòÎ¶¨Ïò§ Ï†ÄÏû• Ïò§Î•ò:', error);
                
                // Ïã§Ìå® Ïãú Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÎ°ú Ìè¥Î∞±
                console.log('üíæ ÏãúÎÇòÎ¶¨Ïò§ Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÎ°ú Ìè¥Î∞±...');
                return saveScenarioToLocalStorage(scenario);
            }
        }
        
        // GitHubÏóêÏÑú ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        async function loadScenariosFromGitHub() {
            try {
                console.log('üì• GitHubÏóêÏÑú ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ Î°úÎìú...');
                const result = await getFileFromGitHub('data/scenarios/scenario-database.json');
                
                if (result.success) {
                    const scenarioData = result.content;
                    if (scenarioData.scenarios) {
                        return scenarioData.scenarios;
                    }
                    return {};
                } else {
                    console.warn('‚ö†Ô∏è GitHub ÏãúÎÇòÎ¶¨Ïò§ Î°úÎìú Ïã§Ìå®:', result.error);
                    return {};
                }
            } catch (error) {
                console.error('‚ùå GitHub ÏãúÎÇòÎ¶¨Ïò§ Î°úÎìú ÏòàÏô∏:', error);
                return {};
            }
        }
        
        // ÏãúÎÇòÎ¶¨Ïò§ Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ Ìè¥Î∞± Ìï®Ïàò
        function saveScenarioToLocalStorage(scenario) {
            try {
                const scenarioId = scenario.id || scenario.scenario_id || `scenario_${Date.now()}`;
                const existingScenarios = JSON.parse(localStorage.getItem('chatgame_scenarios') || '{}');
                
                existingScenarios[scenarioId] = {
                    ...scenario,
                    id: scenarioId,
                    scenario_id: scenarioId,
                    last_modified: new Date().toISOString(),
                    source: 'local_storage'
                };
                
                localStorage.setItem('chatgame_scenarios', JSON.stringify(existingScenarios));
                console.log('‚úÖ ÏãúÎÇòÎ¶¨Ïò§ Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ Ï†ÄÏû• ÏôÑÎ£å:', scenarioId);
                
                return { success: true, source: 'localStorage' };
            } catch (error) {
                console.error('‚ùå ÏãúÎÇòÎ¶¨Ïò§ Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ Ï†ÄÏû• Ïò§Î•ò:', error);
                return { success: false, error: error.message };
            }
        }
        async function loadScenarios() {
            console.log('üìö === ÏãúÎÇòÎ¶¨Ïò§ Î°úÎìú ÏãúÏûë ===');
            console.log('üïí Î°úÎìú ÏãúÍ∞Ñ:', new Date().toISOString());

            try {
                // üîß Í∞ïÎ†•Ìïú Ï∫êÏãú Î¨¥Ìö®Ìôî Î∞è Ïö∞ÏÑ†ÏàúÏúÑ ÏÑ§Ï†ï
                const timestamp = Date.now();
                const randomParam = Math.random().toString(36).substring(7);
                console.log('üîÑ ÏãúÎÇòÎ¶¨Ïò§ API Ìò∏Ï∂ú... (Ï∫êÏãú Î¨¥Ìö®Ìôî: ' + timestamp + ', ÎûúÎç§: ' + randomParam + ')');

                const response = await fetch(`/api/scenario-manager?action=list&_t=${timestamp}&_r=${randomParam}`, {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                console.log('üì∂ API ÏùëÎãµ ÏÉÅÌÉú:', response.status);
                
                const data = await response.json();
                console.log('üì¶ ÏõêÏãú ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞:', JSON.stringify(data, null, 2));

                if (data.success) {
                    scenarios = data.scenarios || {};
                    const scenarioCount = Object.keys(scenarios).length;
                    console.log('‚úÖ Î°úÎìúÎêú ÏãúÎÇòÎ¶¨Ïò§ Ïàò:', scenarioCount);
                    
                    if (scenarioCount > 0) {
                        console.log('‚úÖ ÏãúÎÇòÎ¶¨Ïò§ IDÎì§:', Object.keys(scenarios));
                    } else {
                        console.log('üòµ Îπà ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù');
                    }
                    
                    displayScenarios();
                    updateScenarioStats();
                    console.log('üéâ === ÏãúÎÇòÎ¶¨Ïò§ Î°úÎìú ÏôÑÎ£å ===');
                } else {
                    console.error('‚ùå ÏãúÎÇòÎ¶¨Ïò§ API Ïò§Î•ò:', data.message);
                    scenarios = {};
                    displayScenarios();
                    updateScenarioStats();
                }
            } catch (error) {
                console.error('‚ùå ÏãúÎÇòÎ¶¨Ïò§ Î°úÎìú ÏòàÏô∏:', error);
                // Ìè¥Î∞± Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©
                scenarios = {};
                displayScenarios();
                updateScenarioStats();
                console.log('üéâ === ÏãúÎÇòÎ¶¨Ïò§ Î°úÎìú ÏôÑÎ£å (Ìè¥Î∞±) ===');
            }
        }

        function displayScenarios() {
            console.log('üé® === ÏãúÎÇòÎ¶¨Ïò§ ÌëúÏãú Ìï®Ïàò ÏãúÏûë ===');
            const container = document.getElementById('scenariosContainer');

            // window.scenarios ÎòêÎäî Ï†ÑÏó≠ scenarios ÏÇ¨Ïö© (Ìò∏ÌôòÏÑ±)
            const scenariosData = window.scenarios || scenarios || {};

            // ÏãúÎÇòÎ¶¨Ïò§ Î∞∞Ïó¥ÏùÑ ÌÇ§ÏôÄ Ìï®Íªò Îß§Ìïë (ID Î¨∏Ï†ú Ìï¥Í≤∞)
            const scenarioArray = Object.entries(scenariosData).map(([key, scenario]) => ({
                ...scenario,
                // ID Ïö∞ÏÑ†ÏàúÏúÑ: scenario.id > scenario.scenario_id > key
                id: scenario.id || scenario.scenario_id || key
            }));

            console.log('üìä ÌëúÏãúÌï† ÏãúÎÇòÎ¶¨Ïò§ Ïàò:', scenarioArray.length);
            console.log('üìä ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ ÏÜåÏä§:', window.scenarios ? 'window.scenarios' : 'scenarios');

            if (scenarioArray.length > 0) {
                console.log('üìã ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù:', scenarioArray.map(s => `${s.title} (${s.id})`));
                console.log('üîç ÏãúÎÇòÎ¶¨Ïò§ ÏÉÅÏÑ∏ Ï†ïÎ≥¥:', scenarioArray.map(s => ({
                    title: s.title,
                    id: s.id,
                    originalKey: Object.keys(scenariosData).find(key => scenariosData[key] === s)
                })));
            } else {
                console.log('üì≠ ÌëúÏãúÌï† ÏãúÎÇòÎ¶¨Ïò§ ÏóÜÏùå');
            }

            if (scenarioArray.length === 0) {
                console.log('üì≠ ÏãúÎÇòÎ¶¨Ïò§ ÏóÜÏùå - Îπà ÏÉÅÌÉú ÌëúÏãú');

                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <h3>üì≠ ÏãúÎÇòÎ¶¨Ïò§Í∞Ä ÏóÜÏäµÎãàÎã§</h3>
                        <p>Ï≤´ Î≤àÏß∏ ÏãúÎÇòÎ¶¨Ïò§Î•º ÎßåÎì§Ïñ¥Î≥¥ÏÑ∏Ïöî!</p>
                        <button class="btn btn-primary" onclick="openScenarioModal('create')">
                            ‚ú® ÏÉà ÏãúÎÇòÎ¶¨Ïò§ ÎßåÎì§Í∏∞
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = scenarioArray.map(scenario => {
                const scenarioId = scenario.id;
                console.log(`üéØ ÏãúÎÇòÎ¶¨Ïò§ Ïπ¥Îìú ÏÉùÏÑ±: ${scenario.title} (ID: ${scenarioId})`);

                // AI Î™®Îç∏ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                const aiModel = scenario.metadata?.ai_model || 'claude';
                const aiModelName = {
                    'claude': 'Claude 3.5 Sonnet',
                    'openai': 'OpenAI GPT-4',
                    'llama': 'Llama 3.1 (Groq)'
                }[aiModel] || 'Claude 3.5 Sonnet';

                // Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ Ï†ïÎ≥¥
                const genre = scenario.metadata?.genre || scenario.background_setting || 'unknown';
                const sexyLevel = scenario.metadata?.sexy_level || 5;
                const tags = scenario.metadata?.tags || scenario.tags || [];

                return `
                    <div class="scenario-card" onclick="showScenarioDetail('${scenarioId}')" style="cursor: pointer;">
                        <h3>${scenario.title}</h3>
                        <p class="description">${scenario.description}</p>
                        <div class="metadata">
                            <span class="tag" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">ü§ñ ${aiModelName}</span>
                            <span class="tag">üé≠ ${genre}</span>
                            <span class="tag">üî• Î†àÎ≤® ${sexyLevel}</span>
                            ${tags.slice(0, 2).map(tag => `<span class="tag">${tag}</span>`).join('')}
                            <span class="tag">ÏóêÌîºÏÜåÎìú: ${scenario.dialogue_count || 0}Í∞ú</span>
                        </div>
                        <div class="actions" onclick="event.stopPropagation()">
                            <button class="btn btn-success" onclick="editScenario('${scenarioId}')">ÏàòÏ†ï</button>
                            <button class="btn btn-primary" onclick="manageDialogues('${scenarioId}')">ÏóêÌîºÏÜåÎìú</button>
                            <button class="btn btn-info" onclick="testScenarioWithModel('${scenarioId}')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">‚ñ∂Ô∏è ÌÖåÏä§Ìä∏</button>
                            <button class="btn btn-danger" onclick="deleteScenario('${scenarioId}')">ÏÇ≠Ï†ú</button>
                        </div>
                    </div>
                `;
            }).join('');

            console.log('üéâ ÏãúÎÇòÎ¶¨Ïò§ Ïπ¥Îìú Î†åÎçîÎßÅ ÏôÑÎ£å');
        }

        function updateScenarioStats() {
            console.log('üìä ÏãúÎÇòÎ¶¨Ïò§ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÏûë...');
            
            // window.scenarios ÎòêÎäî Ï†ÑÏó≠ scenarios ÏÇ¨Ïö© (Ìò∏ÌôòÏÑ±)
            const scenariosData = window.scenarios || scenarios || {};
            const scenarioArray = Object.values(scenariosData);
            console.log('üìä ÏãúÎÇòÎ¶¨Ïò§ Î∞∞Ïó¥:', scenarioArray.length, 'Í∞ú');
            console.log('üìä ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ ÏÜåÏä§:', window.scenarios ? 'window.scenarios' : 'scenarios');
            
            // ÏïàÏ†ÑÌïú ÏöîÏÜå ÏóÖÎç∞Ïù¥Ìä∏ (ÏöîÏÜåÍ∞Ä ÏóÜÏúºÎ©¥ Î¨¥Ïãú)
            const safeUpdateElement = (id, value) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                    console.log(`‚úÖ ${id}: ${value}`);
                } else {
                    console.warn(`‚ö†Ô∏è ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå: ${id}`);
                }
            };
            
            // ÏãúÎÇòÎ¶¨Ïò§ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
            safeUpdateElement('totalScenarios', scenarioArray.length);
            safeUpdateElement('activeScenarios', scenarioArray.filter(s => s.active_status).length);
            safeUpdateElement('scenarioCount', scenarioArray.length);
            
            // AI ÏÉùÏÑ± ÏãúÎÇòÎ¶¨Ïò§ Í∞úÏàò
            const aiGeneratedCount = scenarioArray.filter(s => s.ai_generated_context && s.ai_generated_context.length > 0).length;
            safeUpdateElement('aiGeneratedScenarios', aiGeneratedCount);
            
            // ÎåÄÌôî/ÏóêÌîºÏÜåÎìú Ïàò (ÏãúÎÇòÎ¶¨Ïò§ ÏÑπÏÖòÏóêÎäî totalDialogues ÏÇ¨Ïö©)
            const totalEpisodes = scenarioArray.reduce((sum, s) => sum + (s.dialogue_count || 0), 0);
            safeUpdateElement('totalDialogues', totalEpisodes);
            
            console.log('‚úÖ ÏãúÎÇòÎ¶¨Ïò§ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
        }

        function openScenarioModal(mode, scenarioId = null) {
            currentMode = mode;
            const modal = document.getElementById('scenarioModal');

            if (mode === 'create') {
                document.getElementById('scenarioModalTitle').textContent = 'ÏÉà ÏãúÎÇòÎ¶¨Ïò§ ÎßåÎì§Í∏∞';
                document.getElementById('scenarioForm').reset();

                // Acts & Beats Íµ¨Ï°∞ Ï¥àÍ∏∞Ìôî
                currentScenarioStructure = { acts: [] };

                // Acts Î†åÎçîÎßÅ
                renderActsStructure();
            } else if (mode === 'edit' && scenarioId) {
                editScenario(scenarioId);
                return;
            }

            modal.style.display = 'block';
        }

        function editScenario(scenarioId) {
            console.log('üîß ÏãúÎÇòÎ¶¨Ïò§ Ìé∏Ïßë ÏãúÏûë:', scenarioId);
            const scenariosData = window.scenarios || scenarios || {};
            const scenario = scenariosData[scenarioId];

            console.log('üìã ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏:', {
                scenarioId,
                hasScenario: !!scenario,
                availableIds: Object.keys(scenariosData)
            });

            if (!scenario) {
                console.error('‚ùå ÏãúÎÇòÎ¶¨Ïò§Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§:', scenarioId);
                alert('ÏãúÎÇòÎ¶¨Ïò§Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }

            currentMode = 'edit';
            document.getElementById('scenarioModalTitle').textContent = 'ÏãúÎÇòÎ¶¨Ïò§ ÏàòÏ†ï';
            document.getElementById('scenarioId').value = scenarioId;
            document.getElementById('scenarioTitle').value = scenario.title;
            document.getElementById('scenarioDescription').value = scenario.description;

            // Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ Î°úÎìú
            if (scenario.metadata) {
                document.getElementById('scenarioGenre').value = scenario.metadata.genre || 'sweet_romance';
                document.getElementById('scenarioSexyLevel').value = scenario.metadata.sexy_level || 5;
                document.getElementById('sexyLevelValue').textContent = scenario.metadata.sexy_level || 5;
                document.getElementById('scenarioTags').value = scenario.metadata.tags ? scenario.metadata.tags.join(', ') : '';
                document.getElementById('scenarioDuration').value = scenario.metadata.estimated_duration || 'medium';
            } else {
                // Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
                document.getElementById('scenarioGenre').value = 'sweet_romance';
                document.getElementById('scenarioSexyLevel').value = 5;
                document.getElementById('sexyLevelValue').textContent = 5;
                document.getElementById('scenarioTags').value = '';
                document.getElementById('scenarioDuration').value = 'medium';
            }

            // Acts & Beats Íµ¨Ï°∞ Î°úÎìú
            if (scenario.structure) {
                currentScenarioStructure = scenario.structure;
            } else {
                currentScenarioStructure = { acts: [] };
            }

            // Acts Î†åÎçîÎßÅ
            renderActsStructure();

            // Î∞±Í∑∏ÎùºÏö¥Îìú Ïä§ÌÅ¨Î°§ ÎπÑÌôúÏÑ±Ìôî
            document.body.style.overflow = 'hidden';

            document.getElementById('scenarioModal').style.display = 'block';
        }


        // ========== Acts & Beats Í¥ÄÎ¶¨ ==========
        let currentScenarioStructure = {
            acts: []
        };

        function renderActsStructure() {
            const container = document.getElementById('acts-container');

            if (!currentScenarioStructure.acts || currentScenarioStructure.acts.length === 0) {
                container.innerHTML = `
                    <div class="empty-structure">
                        <div class="empty-structure-icon">üé¨</div>
                        <div class="empty-structure-text">ÏïÑÏßÅ ActÍ∞Ä ÏóÜÏäµÎãàÎã§</div>
                        <div class="empty-structure-hint">ÏúÑÏùò "‚ûï Act Ï∂îÍ∞Ä" Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ ÏãúÏûëÌïòÏÑ∏Ïöî</div>
                        <div class="empty-structure-hint" style="margin-top: 10px;">ActÎäî ÏãúÎÇòÎ¶¨Ïò§Ïùò ÌÅ∞ Îã®Í≥ÑÎ•º ÎÇòÌÉÄÎÉÖÎãàÎã§ (Ïòà: ÎßåÎÇ®, ÏπúÎ∞ÄÌï¥Ïßê, Í≥†Î∞±)</div>
                    </div>
                `;
                return;
            }

            // ÌÉÄÏûÑÎùºÏù∏ Ïª®ÌÖåÏù¥ÎÑà ÏÉùÏÑ±
            const timelineHTML = `
                <div class="timeline-container">
                    <div class="timeline-line"></div>
                    ${currentScenarioStructure.acts.map((act, actIndex) => {
                        // Beat ÏôÑÏÑ±ÎèÑ Í≥ÑÏÇ∞
                        const totalBeats = act.beats?.length || 0;
                        const filledBeats = act.beats?.filter(b => b.name && b.description).length || 0;
                        const progressPercent = totalBeats > 0 ? Math.round((filledBeats / totalBeats) * 100) : 0;

                        return `
                            <div class="act-card" data-act-number="${actIndex + 1}">
                                <!-- Act Ìó§Îçî -->
                                <div class="act-header">
                                    <input type="text"
                                           value="${escapeHtml(act.name || `Act ${actIndex + 1}`)}"
                                           onchange="updateActName(${actIndex}, this.value)"
                                           placeholder="Act Ïù¥Î¶Ñ ÏûÖÎ†•...">

                                    <div class="act-actions">
                                        <button type="button" onclick="addBeat(${actIndex})">
                                            ‚ûï Beat
                                        </button>
                                        <button type="button" class="btn-danger" onclick="deleteAct(${actIndex})">
                                            üóëÔ∏è ÏÇ≠Ï†ú
                                        </button>
                                    </div>
                                </div>

                                <!-- Beat ÏßÑÌñâÎèÑ -->
                                ${totalBeats > 0 ? `
                                <div class="act-progress">
                                    <div class="progress-bar-container">
                                        <div class="progress-bar" style="width: ${progressPercent}%"></div>
                                    </div>
                                    <div class="progress-label">
                                        üìä ÏôÑÏÑ±ÎèÑ: ${progressPercent}% (${filledBeats}/${totalBeats} Beats)
                                    </div>
                                </div>
                                ` : ''}

                                <!-- Beats Ïª®ÌÖåÏù¥ÎÑà -->
                                <div class="beats-container">
                                    ${totalBeats > 0 ? `
                                    <div class="beats-header">
                                        <h4>
                                            üéØ Scene Beats
                                            <span class="beats-count">${totalBeats}</span>
                                        </h4>
                                    </div>
                                    ` : ''}

                                    ${act.beats && act.beats.length > 0 ?
                                        act.beats.map((beat, beatIndex) => `
                                            <div class="beat-item">
                                                <div class="beat-header">
                                                    <input type="text"
                                                           value="${escapeHtml(beat.name || `Beat ${beatIndex + 1}`)}"
                                                           onchange="updateBeatName(${actIndex}, ${beatIndex}, this.value)"
                                                           placeholder="Beat Ïù¥Î¶Ñ (Ïòà: Ï≤´ ÎßåÎÇ®, Ï†êÏã¨ Í∞ôÏù¥ Î®πÍ∏∞)">
                                                    <div class="beat-actions">
                                                        <button type="button" class="btn-danger" onclick="deleteBeat(${actIndex}, ${beatIndex})">
                                                            üóëÔ∏è
                                                        </button>
                                                    </div>
                                                </div>

                                                <!-- Beat ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÏûÖÎ†• -->
                                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                                                    <input type="text"
                                                           value="${escapeHtml(beat.location || '')}"
                                                           onchange="updateBeatField(${actIndex}, ${beatIndex}, 'location', this.value)"
                                                           placeholder="üìç Ïû•ÏÜå (Ïòà: ÌöåÏÇ¨ Î≥µÎèÑ, Ïπ¥Ìéò)"
                                                           style="padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 13px;">
                                                    <input type="text"
                                                           value="${escapeHtml(beat.time || '')}"
                                                           onchange="updateBeatField(${actIndex}, ${beatIndex}, 'time', this.value)"
                                                           placeholder="‚è∞ ÏãúÍ∞Ñ (Ïòà: Ï†êÏã¨ÏãúÍ∞Ñ, Ìá¥Í∑º ÌõÑ)"
                                                           style="padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 13px;">
                                                </div>

                                                <textarea onchange="updateBeatField(${actIndex}, ${beatIndex}, 'topic', this.value)"
                                                          placeholder="üí¨ ÎåÄÌôî Ï£ºÏ†ú: Î¨¥ÏóáÏóê ÎåÄÌï¥ Ïù¥ÏïºÍ∏∞ÌïòÎÇòÏöî? (Ïòà: Ïò§Îäò ÌöåÏùò ÎÇ¥Ïö©, Ï∑®ÎØ∏ Í≥µÏú†)"
                                                          style="width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 13px; min-height: 60px; margin-bottom: 8px;">${escapeHtml(beat.topic || '')}</textarea>

                                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                                                    <input type="text"
                                                           value="${escapeHtml(beat.emotion || '')}"
                                                           onchange="updateBeatField(${actIndex}, ${beatIndex}, 'emotion', this.value)"
                                                           placeholder="üíì Í∞êÏ†ï ÌùêÎ¶Ñ (Ïòà: Ïñ¥ÏÉâÌï® ‚Üí Ìò∏Í∏∞Ïã¨)"
                                                           style="padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 13px;">
                                                    <input type="number"
                                                           value="${beat.affection_change || 0}"
                                                           onchange="updateBeatField(${actIndex}, ${beatIndex}, 'affection_change', parseInt(this.value))"
                                                           placeholder="üéØ Î™©Ìëú Ìò∏Í∞êÎèÑ Î≥ÄÌôî"
                                                           min="-10" max="15"
                                                           style="padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 13px;">
                                                </div>

                                                <textarea onchange="updateBeatField(${actIndex}, ${beatIndex}, 'character_reaction', this.value)"
                                                          placeholder="üé≠ Ï∫êÎ¶≠ÌÑ∞ Î∞òÏùë: Ïù¥ ÏÉÅÌô©ÏóêÏÑú Ï∫êÎ¶≠ÌÑ∞Í∞Ä Ïñ¥ÎñªÍ≤å Î∞òÏùëÌïòÎÇòÏöî? (MBTI ÌäπÏÑ± ÌôúÏö©)"
                                                          style="width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 13px; min-height: 60px;">${escapeHtml(beat.character_reaction || '')}</textarea>
                                            </div>
                                        `).join('')
                                    :
                                        `<div style="text-align: center; padding: 20px; color: #999;">
                                            <p style="margin: 0; font-size: 13px;">ÏïÑÏßÅ BeatÍ∞Ä ÏóÜÏäµÎãàÎã§</p>
                                        </div>`
                                    }

                                    <!-- Beat Ï∂îÍ∞Ä Î≤ÑÌäº -->
                                    <button type="button" class="btn-add-beat" onclick="addBeat(${actIndex})">
                                        ‚ûï Beat Ï∂îÍ∞Ä
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            container.innerHTML = timelineHTML;
        }

        // HTML Ïù¥Ïä§ÏºÄÏù¥ÌîÑ Ìó¨Ìçº Ìï®Ïàò
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ÏãúÎÇòÎ¶¨Ïò§ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÌëúÏãú
        function showScenarioDetail(scenarioId) {
            console.log('üìã ÏãúÎÇòÎ¶¨Ïò§ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÌëúÏãú:', scenarioId);

            const scenariosData = window.scenarios || scenarios || {};
            const scenario = scenariosData[scenarioId];

            if (!scenario) {
                console.error('‚ùå ÏãúÎÇòÎ¶¨Ïò§Î•º Ï∞æÏùÑ Ïàò ÏóÜÏùå:', scenarioId);
                return;
            }

            // AI Î™®Îç∏ Ï†ïÎ≥¥
            const aiModel = scenario.metadata?.ai_model || 'claude';
            const aiModelName = {
                'claude': 'Claude 3.5 Sonnet',
                'openai': 'OpenAI GPT-4',
                'llama': 'Llama 3.1 (Groq)'
            }[aiModel] || 'Claude 3.5 Sonnet';

            // Î©îÌÉÄÎç∞Ïù¥ÌÑ∞
            const genre = scenario.metadata?.genre || scenario.background_setting || '-';
            const sexyLevel = scenario.metadata?.sexy_level || 5;
            const episodeCount = scenario.dialogue_count || 0;

            // Í∏∞Î≥∏ Ï†ïÎ≥¥ ÌëúÏãú
            document.getElementById('detail-scenario-title').textContent = scenario.title;
            document.getElementById('detail-scenario-description').textContent = scenario.description;
            document.getElementById('detail-ai-model').textContent = aiModelName;
            document.getElementById('detail-genre').textContent = genre;
            document.getElementById('detail-sexy-level').textContent = `üî• ${sexyLevel}`;
            document.getElementById('detail-episode-count').textContent = `${episodeCount}Í∞ú`;

            // Acts & Beats Íµ¨Ï°∞ ÌëúÏãú
            const actsContent = document.getElementById('detail-acts-content');
            if (scenario.structure && scenario.structure.acts && scenario.structure.acts.length > 0) {
                actsContent.innerHTML = scenario.structure.acts.map((act, actIndex) => `
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                        <div style="font-weight: 600; font-size: 16px; margin-bottom: 8px;">
                            ${actIndex + 1}. ${act.name || `Act ${actIndex + 1}`}
                        </div>
                        ${act.beats && act.beats.length > 0 ? `
                            <div style="margin-left: 20px; display: flex; flex-direction: column; gap: 5px;">
                                ${act.beats.map((beat, beatIndex) => `
                                    <div style="font-size: 14px; opacity: 0.9;">
                                        ‚ñ∂ ${beat.name || `Beat ${beatIndex + 1}`}
                                        ${beat.description ? `<span style="opacity: 0.7; font-size: 13px;"> - ${beat.description}</span>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<div style="margin-left: 20px; opacity: 0.6; font-size: 13px;">BeatÍ∞Ä ÏóÜÏäµÎãàÎã§</div>'}
                    </div>
                `).join('');
            } else {
                actsContent.innerHTML = '<p style="margin: 0; opacity: 0.7;">Íµ¨Ï°∞ Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§</p>';
            }

            // ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÏòÅÏó≠ ÌëúÏãú
            const detailView = document.getElementById('scenario-detail-view');
            detailView.style.display = 'block';

            // Î∂ÄÎìúÎüΩÍ≤å Ïä§ÌÅ¨Î°§
            scrollToTop();
        }

        // ÏãúÎÇòÎ¶¨Ïò§ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Îã´Í∏∞
        function closeScenarioDetail() {
            const detailView = document.getElementById('scenario-detail-view');
            detailView.style.display = 'none';
        }

        function addAct() {
            if (!currentScenarioStructure.acts) {
                currentScenarioStructure.acts = [];
            }

            const actNumber = currentScenarioStructure.acts.length + 1;
            currentScenarioStructure.acts.push({
                name: `Act ${actNumber}`,
                beats: []
            });

            renderActsStructure();
        }

        function deleteAct(actIndex) {
            if (confirm('Ïù¥ ActÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                currentScenarioStructure.acts.splice(actIndex, 1);
                renderActsStructure();
            }
        }

        function addBeat(actIndex) {
            if (!currentScenarioStructure.acts[actIndex].beats) {
                currentScenarioStructure.acts[actIndex].beats = [];
            }

            const beatNumber = currentScenarioStructure.acts[actIndex].beats.length + 1;
            currentScenarioStructure.acts[actIndex].beats.push({
                name: `Beat ${beatNumber}`,
                description: ''
            });

            renderActsStructure();
        }

        function deleteBeat(actIndex, beatIndex) {
            if (confirm('Ïù¥ BeatÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                currentScenarioStructure.acts[actIndex].beats.splice(beatIndex, 1);
                renderActsStructure();
            }
        }

        function updateActName(actIndex, value) {
            currentScenarioStructure.acts[actIndex].name = value;
        }

        function updateBeatName(actIndex, beatIndex, value) {
            currentScenarioStructure.acts[actIndex].beats[beatIndex].name = value;
        }

        function updateBeatDescription(actIndex, beatIndex, value) {
            currentScenarioStructure.acts[actIndex].beats[beatIndex].description = value;
        }

        function updateBeatField(actIndex, beatIndex, field, value) {
            currentScenarioStructure.acts[actIndex].beats[beatIndex][field] = value;
        }

        // Îπ†Î•∏ ÏãúÏûë ÌÖúÌîåÎ¶ø Ï†ÅÏö© Ìï®Ïàò
        function applyTemplate(templateType) {
            const templates = {
                campus: {
                    title: 'ÌïôÍµê ÎèÑÏÑúÍ¥ÄÏóêÏÑúÏùò Ïö¥Î™ÖÏ†Å ÎßåÎÇ®',
                    genre: 'campus_romance',
                    sexyLevel: 3,
                    tags: 'Ï∫†ÌçºÏä§, ÎèÑÏÑúÍ¥Ä, ÏÑ§Î†ò, Ï≤´ÎßåÎÇ®',
                    duration: 'medium',
                    description: 'Ï°∞Ïö©Ìïú ÎèÑÏÑúÍ¥ÄÏóêÏÑú Ïö∞Ïó∞Ìûà Í∞ôÏùÄ Ï±ÖÏùÑ ÏßëÏúºÎ†§Îã§ ÏÜêÏù¥ ÎßàÏ£ºÏπú ÏàúÍ∞Ñ, Îëê ÏÇ¨ÎûåÏùò ÌäπÎ≥ÑÌïú Ïù¥ÏïºÍ∏∞Í∞Ä ÏãúÏûëÎê©ÎãàÎã§.'
                },
                office: {
                    title: 'ÏïºÍ∑º Ï§ë ÏãúÏûëÎêú Î°úÎß®Ïä§',
                    genre: 'office_romance',
                    sexyLevel: 6,
                    tags: 'ÏßÅÏû•, ÏïºÍ∑º, Í∏¥Ïû•Í∞ê, ÏÑ§Î†ò',
                    duration: 'medium',
                    description: 'Îä¶ÏùÄ Î∞§ ÏÇ¨Î¨¥Ïã§, ÎëòÎßå ÎÇ®ÏùÄ Í≥µÍ∞ÑÏóêÏÑú Ïª§ÌîºÎ•º ÎÇòÎàÑÎ©∞ Ï°∞Í∏àÏî© Í∞ÄÍπåÏõåÏßÄÎäî Îëê ÏÇ¨Îûå.'
                },
                reunion: {
                    title: '10ÎÖÑ ÎßåÏùò Ïû¨Ìöå',
                    genre: 'reunion',
                    sexyLevel: 5,
                    tags: 'Ïû¨Ìöå, Ï∂îÏñµ, ÏÑ§Î†ò, Í∑∏Î¶¨ÏõÄ',
                    duration: 'long',
                    description: '10ÎÖÑ Ï†Ñ Ìó§Ïñ¥ÏßÑ Ï≤´ÏÇ¨ÎûëÍ≥º Ïö∞Ïó∞Ìûà ÎßàÏ£ºÏπú ÎÇ†, ÏûäÏóàÎçò Í∞êÏ†ïÎì§Ïù¥ Îã§Ïãú ÏÇ¥ÏïÑÎÇ©ÎãàÎã§.'
                },
                firstlove: {
                    title: 'ÎëêÍ∑ºÍ±∞Î¶¨Îäî Ï≤´ÏÇ¨ÎûëÏùò ÏãúÏûë',
                    genre: 'first_love',
                    sexyLevel: 2,
                    tags: 'Ï≤´ÏÇ¨Îûë, ÏàúÏàò, ÏÑ§Î†ò, Îñ®Î¶º',
                    duration: 'short',
                    description: 'ÏÉùÏï† Ï≤òÏùå ÎäêÍª¥Î≥¥Îäî Ïù¥ Îñ®Î¶º, Í∑∏ ÏÇ¨ÎûåÎßå Î≥¥Î©¥ Ïã¨Ïû•Ïù¥ ÌÑ∞Ïßà Í≤É Í∞ôÏùÄ Í∑∏ ÎäêÎÇå.'
                }
            };

            const template = templates[templateType];
            if (!template) return;

            document.getElementById('scenarioTitle').value = template.title;
            document.getElementById('scenarioGenre').value = template.genre;
            document.getElementById('scenarioSexyLevel').value = template.sexyLevel;
            document.getElementById('sexyLevelValue').textContent = template.sexyLevel;
            document.getElementById('scenarioTags').value = template.tags;
            document.getElementById('scenarioDuration').value = template.duration;
            document.getElementById('scenarioDescription').value = template.description;
        }

        // AI ÏûêÎèô Íµ¨Ï°∞ ÏÉùÏÑ±
        async function generateAIStructure() {
            const title = document.getElementById('scenarioTitle').value;
            const description = document.getElementById('scenarioDescription').value;

            if (!title || !description) {
                alert('Ï†úÎ™©Í≥º ÏÑ§Î™ÖÏùÑ Î®ºÏ†Ä ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            const button = event.target;
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = 'ü§ñ ÏÉùÏÑ± Ï§ë...';

            try {
                const response = await fetch('/api/scenario-manager', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'generate_scenario_structure',
                        title,
                        description
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // ÏÉùÏÑ±Îêú Íµ¨Ï°∞Î•º ÌòÑÏû¨ Íµ¨Ï°∞Ïóê Ï†ÅÏö©
                    currentScenarioStructure = result.structure;

                    // Acts Î†åÎçîÎßÅ
                    renderActsStructure();

                    alert('‚úÖ Acts & Beats Íµ¨Ï°∞Í∞Ä ÏûêÎèô ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!');
                } else {
                    throw new Error(result.message || 'AI ÏÉùÏÑ± Ïã§Ìå®');
                }
            } catch (error) {
                console.error('‚ùå AI Íµ¨Ï°∞ ÏÉùÏÑ± Ïò§Î•ò:', error);
                alert(`AI Íµ¨Ï°∞ ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§:\n${error.message}`);
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        async function saveScenario() {
            const title = document.getElementById('scenarioTitle').value;
            const description = document.getElementById('scenarioDescription').value;
            const genre = document.getElementById('scenarioGenre').value;
            const sexyLevel = parseInt(document.getElementById('scenarioSexyLevel').value);
            const tagsInput = document.getElementById('scenarioTags').value;
            const duration = document.getElementById('scenarioDuration').value;

            // AI Î™®Îç∏ ÏÑ†ÌÉùÍ∞í Í∞ÄÏ†∏Ïò§Í∏∞ (Î™®Îã¨ ÎÇ¥ select ÌïÑÎìú)
            const modelSelector = document.getElementById('scenarioAiModel');
            const selectedModel = modelSelector ? modelSelector.value : 'claude';

            if (!title || !description || !genre) {
                alert('Ï†úÎ™©, ÏÑ§Î™Ö, Ïû•Î•¥Îäî ÌïÑÏàò Ìï≠Î™©ÏûÖÎãàÎã§.');
                return;
            }

            const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];

            // Ï†úÎ™©ÏùÑ Í∏∞Î∞òÏúºÎ°ú Í≥†Ïú†Ìïú ID ÏÉùÏÑ±
            const titleKey = title.toLowerCase()
                .replace(/[^a-zA-ZÍ∞Ä-Ìû£0-9]/g, '_')
                .replace(/_+/g, '_')
                .replace(/^_|_$/g, '');
            const scenarioId = currentMode === 'create'
                ? `scenario_${titleKey}_${Date.now()}`
                : document.getElementById('scenarioId').value;

            const scenarioData = {
                scenario_id: scenarioId,
                title,
                description,
                metadata: {
                    genre,
                    sexy_level: sexyLevel,
                    tags,
                    estimated_duration: duration,
                    ai_model: selectedModel // AI Î™®Îç∏ Ï†ïÎ≥¥ Ï†ÄÏû•
                },
                structure: currentScenarioStructure,
                created_date: new Date().toISOString().split('T')[0],
                dialogue_count: 0,
                action: currentMode === 'create' ? 'create' : 'update'
            };

            console.log('üíæ ÏãúÎÇòÎ¶¨Ïò§ Ï†ÄÏû• ÏãúÏûë:', {
                id: scenarioId,
                title,
                model: selectedModel,
                mode: currentMode
            });

            try {
                // üåê GitHub APIÎ•º ÌÜµÌïú Ï†ÄÏû•
                console.log('üì° GitHub APIÎ°ú ÏãúÎÇòÎ¶¨Ïò§ Ï†ÄÏû• Ï§ë...');

                const response = await fetch('/api/scenario-manager', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(scenarioData)
                });

                if (!response.ok) {
                    throw new Error(`API Ìò∏Ï∂ú Ïã§Ìå®: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    console.log('‚úÖ GitHub API Ï†ÄÏû• ÏÑ±Í≥µ:', result);

                    // Î°úÏª¨ ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
                    const globalScenarios = window.scenarios || {};
                    globalScenarios[scenarioId] = {
                        id: scenarioId,
                        ...scenarioData
                    };
                    window.scenarios = globalScenarios;

                    // UI ÏóÖÎç∞Ïù¥Ìä∏
                    displayScenarios();
                    updateScenarioStats();

                    // ÏÑ±Í≥µ Î©îÏãúÏßÄ
                    const successMessage = currentMode === 'create'
                        ? `‚úÖ ÏãúÎÇòÎ¶¨Ïò§ '${title}'Í∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!\n\nü§ñ AI Î™®Îç∏: ${selectedModel}\nüìä Ïû•Î•¥: ${genre}\nüî• ÏÑπÏãú Î†àÎ≤®: ${sexyLevel}`
                        : `‚úÖ ÏãúÎÇòÎ¶¨Ïò§ '${title}'Í∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§!`;

                    alert(successMessage);
                    closeModal('scenarioModal');

                    // ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                    await loadScenarios();

                    console.log('‚úÖ ÏãúÎÇòÎ¶¨Ïò§ Ï†ÄÏû• ÏôÑÎ£å!');
                } else {
                    throw new Error(result.error || 'Ï†ÄÏû• Ïã§Ìå®');
                }
            } catch (error) {
                console.error('‚ùå ÏãúÎÇòÎ¶¨Ïò§ Ï†ÄÏû• Ïò§Î•ò:', error);
                alert('ÏãúÎÇòÎ¶¨Ïò§ Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§:\n\n' + error.message);
            }
        }

        function testScenarioWithModel(scenarioId) {
            console.log('üéÆ ÏãúÎÇòÎ¶¨Ïò§ ÌÖåÏä§Ìä∏ ÏãúÏûë:', scenarioId);

            // AI Î™®Îç∏ ÏÑ†ÌÉùÍ∞í Í∞ÄÏ†∏Ïò§Í∏∞ (Î©îÏù∏ ÌéòÏù¥ÏßÄ select ÌïÑÎìú)
            const modelSelector = document.getElementById('scenario-ai-model-selector');
            const selectedModel = modelSelector ? modelSelector.value : 'claude';

            console.log('ü§ñ ÏÑ†ÌÉùÎêú AI Î™®Îç∏:', selectedModel);

            // ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
            const scenariosData = window.scenarios || scenarios || {};
            const scenario = scenariosData[scenarioId];

            if (!scenario) {
                alert('ÏãúÎÇòÎ¶¨Ïò§Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                console.error('‚ùå ÏãúÎÇòÎ¶¨Ïò§ ÏóÜÏùå:', scenarioId);
                return;
            }

            // ÌÖåÏä§Ìä∏ Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ± (ÏãúÎÇòÎ¶¨Ïò§Ïùò Ï≤´ Î≤àÏß∏ Ï∫êÎ¶≠ÌÑ∞ ÎòêÎäî Í∏∞Î≥∏ Ï∫êÎ¶≠ÌÑ∞)
            const characterId = scenario.available_characters && scenario.available_characters.length > 0
                ? scenario.available_characters[0]
                : 'test_character';

            let testCharacter;

            // Ïã§Ï†ú Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏãúÎèÑ
            if (window.characters && window.characters[characterId]) {
                testCharacter = window.characters[characterId];
                console.log('‚úÖ Ïã§Ï†ú Ï∫êÎ¶≠ÌÑ∞ ÏÇ¨Ïö©:', characterId);
            } else {
                // Í∏∞Î≥∏ ÌÖåÏä§Ìä∏ Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±
                testCharacter = {
                    id: 'test_character',
                    basic_info: {
                        name: "ÌÖåÏä§Ìä∏ Ï∫êÎ¶≠ÌÑ∞",
                        age: 22,
                        mbti: "INFP",
                        gender: "Ïó¨ÏÑ±",
                        occupation: "ÎåÄÌïôÏÉù"
                    },
                    personality_traits: ["Í∞êÏÑ±Ï†Å", "ÎÇ¥Ìñ•Ï†Å", "Ïù¥ÏÉÅÏ£ºÏùòÏ†Å"],
                    appeal_profile: {
                        charm_points: ["ÎØ∏ÏÜå", "ÎààÎπõ"],
                        style: "ÏûêÏó∞Ïä§Îü¨Ïö¥",
                        attractive_features: ["ÏπúÍ∑ºÌï®"]
                    },
                    conversation_dynamics: {
                        speech_style: "Î∂ÄÎìúÎüΩÍ≥† Îî∞ÎúªÌïú ÎßêÌà¨",
                        emoji_usage: "ÏûêÏ£º ÏÇ¨Ïö©",
                        response_speed: "Î≥¥ÌÜµ"
                    }
                };
                console.log('‚ö†Ô∏è Í∏∞Î≥∏ ÌÖåÏä§Ìä∏ Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±');
            }

            // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóê ÌÖåÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
            localStorage.setItem('test-scenario', JSON.stringify(scenario));
            localStorage.setItem('test-character', JSON.stringify(testCharacter));

            // ÏóêÌîºÏÜåÎìú ÌîåÎ†àÏù¥Ïñ¥ URL ÏÉùÏÑ±
            const playerUrl = `episode-player-test.html?scenario=${scenarioId}&character=${characterId}&model=${selectedModel}`;

            // ÏÉà Ï∞ΩÏúºÎ°ú Ïó¥Í∏∞
            window.open(playerUrl, '_blank');

            // ÏÇ¨Ïö©Ïûê ÌîºÎìúÎ∞±
            const modelNames = {
                'claude': 'Claude 3.5 Sonnet',
                'openai': 'OpenAI GPT-4 Turbo',
                'llama': 'Llama 3.1 8B (Groq)'
            };

            console.log(`‚úÖ ÌÖåÏä§Ìä∏ Ï∞Ω Ïó¥Î¶º: ${modelNames[selectedModel] || selectedModel}`);
            alert(`üéÆ ${modelNames[selectedModel] || selectedModel} Î™®Îç∏Î°ú ÌÖåÏä§Ìä∏Î•º ÏãúÏûëÌï©ÎãàÎã§!`);
        }

        async function deleteScenario(scenarioId) {
            console.log('üéØ deleteScenario Ìï®Ïàò Ìò∏Ï∂úÎê®! (GitHub API Ïó∞Îèô Î≤ÑÏ†Ñ)');

            if (!confirm('Ï†ïÎßêÎ°ú Ïù¥ ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÍ¥ÄÎ†®Îêú Î™®Îì† ÏóêÌîºÏÜåÎìúÎèÑ Ìï®Íªò ÏÇ≠Ï†úÎê©ÎãàÎã§.')) {
                return;
            }

            try {
                console.log('üóëÔ∏è === ÏãúÎÇòÎ¶¨Ïò§ ÏÇ≠Ï†ú ÏãúÏûë ===');
                console.log('üéØ ÏÇ≠Ï†úÌï† ÏãúÎÇòÎ¶¨Ïò§ ID:', scenarioId);

                // 1. APIÎ•º ÌÜµÌïú ÏÑúÎ≤Ñ ÏÇ≠Ï†ú (GitHub ÎèôÍ∏∞Ìôî Ìè¨Ìï®)
                console.log('üì° ÏÑúÎ≤Ñ API Ìò∏Ï∂úÎ°ú ÏãúÎÇòÎ¶¨Ïò§ ÏÇ≠Ï†ú...');
                const response = await fetch('/api/scenario-manager', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'delete',
                        scenario_id: scenarioId
                    })
                });

                console.log('üì∂ API ÏùëÎãµ ÏÉÅÌÉú:', response.status);
                const result = await response.json();
                console.log('üì¶ API ÏùëÎãµ Îç∞Ïù¥ÌÑ∞:', result);

                if (!result.success) {
                    throw new Error(result.message || 'API ÏÇ≠Ï†ú Ïã§Ìå®');
                }

                console.log('‚úÖ ÏÑúÎ≤ÑÏóêÏÑú ÏãúÎÇòÎ¶¨Ïò§ ÏÇ≠Ï†ú ÏôÑÎ£å (GitHub ÎèôÍ∏∞Ìôî Ìè¨Ìï®)');

                // 2. Î°úÏª¨ Ï†ÑÏó≠ Î≥ÄÏàòÏóêÏÑúÎèÑ ÏÇ≠Ï†ú (UI Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏Ïö©)
                console.log('üîÑ Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî...');
                if (scenarios && scenarios[scenarioId]) {
                    delete scenarios[scenarioId];
                    console.log('‚úÖ scenarios Ï†ÑÏó≠ Î≥ÄÏàòÏóêÏÑú ÏÇ≠Ï†ú');
                }
                if (window.scenarios && window.scenarios[scenarioId]) {
                    delete window.scenarios[scenarioId];
                    console.log('‚úÖ window.scenariosÏóêÏÑú ÏÇ≠Ï†ú');
                }

                // 3. LocalStorage Ï†ïÎ¶¨ (ÌïÑÏöîÌïú Í≤ΩÏö∞)
                try {
                    const existingScenarios = localStorage.getItem('scenarios');
                    if (existingScenarios) {
                        const scenariosData = JSON.parse(existingScenarios);
                        if (scenariosData[scenarioId]) {
                            delete scenariosData[scenarioId];
                            localStorage.setItem('scenarios', JSON.stringify(scenariosData));
                            console.log('‚úÖ LocalStorage Ï†ïÎ¶¨ ÏôÑÎ£å');
                        }
                    }
                } catch (localError) {
                    console.warn('‚ö†Ô∏è LocalStorage Ï†ïÎ¶¨ Ïã§Ìå® (Î¨¥Ïãú):', localError.message);
                }

                // 4. UI Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏
                console.log('üé® UI ÏóÖÎç∞Ïù¥Ìä∏...');
                displayScenarios();
                updateScenarioStats();

                // 5. ÏÑ±Í≥µ Î©îÏãúÏßÄ
                alert('‚úÖ ÏãúÎÇòÎ¶¨Ïò§Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                console.log('üéâ === ÏãúÎÇòÎ¶¨Ïò§ ÏÇ≠Ï†ú ÏôÑÎ£å ===');

            } catch (error) {
                console.error('‚ùå === ÏãúÎÇòÎ¶¨Ïò§ ÏÇ≠Ï†ú Ïã§Ìå® ===');
                console.error('‚ùå Ïò§Î•ò ÏÉÅÏÑ∏:', error);
                console.error('‚ùå Ïä§ÌÉù Ìä∏Î†àÏù¥Ïä§:', error.stack);

                // ÏÇ¨Ïö©ÏûêÏóêÍ≤å Íµ¨Ï≤¥Ï†ÅÏù∏ Ïò§Î•ò Î©îÏãúÏßÄ Ï†úÍ≥µ
                let errorMessage = 'ÏãúÎÇòÎ¶¨Ïò§ ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.';
                if (error.message.includes('404')) {
                    errorMessage = 'ÏãúÎÇòÎ¶¨Ïò§Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. Ïù¥ÎØ∏ ÏÇ≠Ï†úÎêòÏóàÍ±∞ÎÇò IDÍ∞Ä ÏûòÎ™ªÎêòÏóàÏùÑ Ïàò ÏûàÏäµÎãàÎã§.';
                } else if (error.message.includes('500')) {
                    errorMessage = 'ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.';
                } else if (error.message.includes('ÎÑ§Ìä∏ÏõåÌÅ¨')) {
                    errorMessage = 'ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞ÏùÑ ÌôïÏù∏ÌïòÍ≥† Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.';
                }

                alert('‚ùå ' + errorMessage + '\n\nÍ∏∞Ïà†Ï†Å Ïò§Î•ò: ' + error.message);
            }
        }

        async function generateAIContext() {
            const title = document.getElementById('scenarioTitle').value;
            const description = document.getElementById('scenarioDescription').value;
            const mood = document.getElementById('mood').value;
            const backgroundSetting = 'Î©îÏã†Ï†Ä ÎåÄÌôî'; // Î©§Ïã†Ï†Ä Í∏∞Î∞òÏúºÎ°ú Í≥†Ï†ï

            if (!title || !description || !mood) {
                alert('Î©îÏã†Ï†Ä Ïª®ÌÖçÏä§Ìä∏ ÏÉùÏÑ±ÏùÑ ÏúÑÌï¥ Î™®Îì† ÌïÑÏàò Ìï≠Î™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            const aiContextDiv = document.getElementById('aiContext');
            aiContextDiv.innerHTML = '<div class="loading"></div> AIÍ∞Ä Ïª®ÌÖçÏä§Ìä∏Î•º ÏÉùÏÑ± Ï§ëÏûÖÎãàÎã§...';

            try {
                console.log('ü§ñ AI Ïª®ÌÖçÏä§Ìä∏ ÏÉùÏÑ± ÏöîÏ≤≠ ÏãúÏûë...');

                // Î®ºÏ†Ä ÏµúÏã† Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞Î•º Î°úÎìú
                console.log('üîÑ ÏµúÏã† Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ï§ë...');
                await window.loadCharacters();

                // ÏÑ†ÌÉùÎêú Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥ ÏàòÏßë
                console.log('üìã ÌòÑÏû¨ Ï†ÑÏó≠ characters:', Object.keys(characters || {}));
                console.log('üìã ÏÑ†ÌÉùÎêú Ï∫êÎ¶≠ÌÑ∞ IDÎì§:', selectedCharacters);

                const selectedCharacterData = [];
                for (const charId of selectedCharacters) {
                    const character = characters[charId] || window.characters?.[charId];
                    if (character) {
                        selectedCharacterData.push(character);
                        console.log('‚úÖ Ï∫êÎ¶≠ÌÑ∞ Ï∞æÏùå:', charId, character.name);
                    } else {
                        console.warn('‚ö†Ô∏è Ï∫êÎ¶≠ÌÑ∞ ÎØ∏Î∞úÍ≤¨:', charId);
                    }
                }

                console.log('üë• ÏÑ†ÌÉùÎêú Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥:', selectedCharacterData);

                if (selectedCharacterData.length === 0) {
                    throw new Error('ÏÑ†ÌÉùÎêú Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. Ï∫êÎ¶≠ÌÑ∞Î•º Î®ºÏ†Ä ÏÉùÏÑ±ÌïòÍ≥† ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                }

                const response = await fetch('/api/scenario-manager?action=regenerate_context', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title,
                        description,
                        background_setting: 'Î©§Ïã†Ï†Ä ÎåÄÌôî', // Î©§Ïã†Ï†Ä Í∏∞Î∞òÏúºÎ°ú Í≥†Ï†ï
                        mood,
                        available_characters: Array.from(selectedCharacters), // üîß SetÏùÑ Î∞∞Ïó¥Î°ú Î≥ÄÌôò
                        characters: selectedCharacterData // Ï∫êÎ¶≠ÌÑ∞ Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ÎèÑ Ï†ÑÎã¨ (Ìò∏ÌôòÏÑ±)
                    })
                });

                console.log('üì° API ÏùëÎãµ ÏÉÅÌÉú:', response.status);

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || errorData.message || `HTTP ${response.status} Ïò§Î•ò`);
                }

                const data = await response.json();

                if (data.success && data.scenario && data.scenario.ai_generated_context) {
                    console.log('‚úÖ AI Ïª®ÌÖçÏä§Ìä∏ ÏÉùÏÑ± ÏÑ±Í≥µ');

                    // UIÏóê Ïª®ÌÖçÏä§Ìä∏ ÌëúÏãú (ÏÉàÎ°úÏö¥ Ïä§ÌÉÄÏùº Ï†ÅÏö©)
                    aiContextDiv.innerHTML = `
                        <div class="existing-context">
                            <div class="context-header">
                                <span class="context-label">üìñ Î∞©Í∏à ÏÉùÏÑ±Îêú Ïª®ÌÖçÏä§Ìä∏</span>
                                <span class="context-date">${new Date().toLocaleString('ko-KR')}</span>
                            </div>
                            <div class="context-content">${data.scenario.ai_generated_context}</div>
                        </div>
                    `;

                    console.log('‚úÖ AI Ïª®ÌÖçÏä§Ìä∏ UI ÌëúÏãú ÏôÑÎ£å');
                    alert('‚úÖ AI Ïª®ÌÖçÏä§Ìä∏Í∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!\n\nÏù¥Ï†ú "Ï†ÄÏû•" Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ ÏãúÎÇòÎ¶¨Ïò§Î•º Ï†ÄÏû•Ìï¥Ï£ºÏÑ∏Ïöî.');

                } else {
                    throw new Error(data.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                }

            } catch (error) {
                console.error('‚ùå AI Ïª®ÌÖçÏä§Ìä∏ ÏÉùÏÑ± Ïã§Ìå®:', error);

                // ÏÇ¨Ïö©ÏûêÏóêÍ≤å ÏπúÌôîÏ†ÅÏù∏ ÏóêÎü¨ Î©îÏãúÏßÄ ÌëúÏãú
                let userMessage = error.message;

                if (error.message.includes('fetch')) {
                    userMessage = 'ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞Ïóê Î¨∏Ï†úÍ∞Ä ÏûàÏäµÎãàÎã§. Ïù∏ÌÑ∞ÎÑ∑ Ïó∞Í≤∞ÏùÑ ÌôïÏù∏ÌïòÍ≥† Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.';
                } else if (error.message.includes('API ÌÇ§')) {
                    userMessage = 'OpenAI API ÌÇ§Í∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÍ±∞ÎÇò Ïú†Ìö®ÌïòÏßÄ ÏïäÏäµÎãàÎã§.\nÍ¥ÄÎ¶¨Ïûê ÌéòÏù¥ÏßÄÏóêÏÑú API ÌÇ§Î•º Îã§Ïãú ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.';
                }

                // ÏóêÎü¨ ÌåùÏóÖ ÌëúÏãú
                alert(`‚ùå AI Ïª®ÌÖçÏä§Ìä∏ ÏÉùÏÑ± Ïã§Ìå®\n\n${userMessage}\n\nÎã§Ïãú ÏãúÎèÑÌïòÍ±∞ÎÇò Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Î¨∏ÏùòÌï¥Ï£ºÏÑ∏Ïöî.`);

                // UI ÏÉÅÌÉú Î≥µÏõê
                aiContextDiv.innerHTML = `
                    <div class="no-context">
                        <div class="no-context-message">
                            üí° AI Ïª®ÌÖçÏä§Ìä∏Î•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî
                        </div>
                        <div class="no-context-help">
                            ÏúÑÏùò "ü§ñ AI Ïª®ÌÖçÏä§Ìä∏ ÏÉùÏÑ±" Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ ÏÜåÏÑ§Ìíç ÏãúÎÇòÎ¶¨Ïò§ Ïª®ÌÖçÏä§Ìä∏Î•º ÏÉùÏÑ±ÌïòÏÑ∏Ïöî
                        </div>
                    </div>
                `;
            }
        }

        function generateLocalAIContext(title, description, backgroundSetting, mood) {
            const templates = {
                'Ïñ¥ÏÉâÌïú ÏÑ§Î†ò': `Î©§Ïã†Ï†Ä ÌôîÎ©¥ ÏÜçÏóêÏÑú ${description} ÏÉÅÌô©Ïù¥ Î≤åÏñ¥ÏßÄÎ©∞, ÏÑúÎ°úÏùò ÎßàÏùåÏùÑ ÌôïÏù∏Ìï¥Í∞ÄÎäî Îã¨ÏΩ§ÌïòÍ≥† Ïñ¥ÏÉâÌïú ÏàúÍ∞ÑÎì§Ïù¥ ÌÖçÏä§Ìä∏Î°ú Ï†ÑÌï¥ÏßÑÎã§.`,
                'ÏßÑÏã¨ Í≥†Î∞±': `${description} Î©§Ïã†Ï†ÄÎ•º ÌÜµÌï¥ ÏßÑÏã¨Ïñ¥Î¶∞ Í∞êÏ†ïÏù¥ Ïò§Í∞ÄÎ©∞, Îëê ÏÇ¨Îûå ÏÇ¨Ïù¥Ïùò ÏßÑÏßú ÎßàÏùåÏù¥ ÎìúÎü¨ÎÇòÎäî Ï§ëÏöîÌïú ÏàúÍ∞ÑÏù¥Îã§.`,
                'Îã¨ÏΩ§Ìïú Î∞ÄÎãπ': `${description} Î©§Ïã†Ï†Ä ÎåÄÌôîÏóêÏÑú ÏùÄÍ∑ºÌïú Î∞ÄÎãπÍ≥º ÏÑ§Î†òÏù¥ ÍµêÏ∞®ÌïòÎ©∞, ÏÑúÎ°úÏùò ÎßàÏùåÏùÑ Îñ†Î≥¥Îäî Îã¨ÏΩ§Ìïú Í≤åÏûÑÏù¥ ÌéºÏ≥êÏßÑÎã§.`,
                'ÏÉàÎ≤Ω Í∞êÏÑ±': `Îä¶ÏùÄ Î∞§ Î©§Ïã†Ï†ÄÎ°ú ${description} ÏÉÅÌô©Ïù¥ Ïù¥Ïñ¥ÏßÄÎ©∞, ÌèâÏÜå ÌïòÏßÄ Î™ªÌñàÎçò ÏÜîÏßÅÌïú Í∞êÏ†ïÎì§Ïù¥ Ï°∞Ïã¨Ïä§ÎüΩÍ≤å ÌëúÌòÑÎêúÎã§.`
            };

            return templates[mood] || templates['Îã¨ÏΩ§Ìïú Î∞ÄÎãπ'];
        }


        // === ÏòàÏãú ÏûêÎèô ÏûÖÎ†• Í∏∞Îä• ===
        function fillExample(fieldId, element) {
            const field = document.getElementById(fieldId);
            const text = element.textContent;

            if (field.tagName === 'TEXTAREA') {
                field.value = text;
                field.style.height = 'auto';
                field.style.height = field.scrollHeight + 'px';
            } else {
                field.value = text;
            }

            // ÏÉÅÌô© ÎØ∏Î¶¨Î≥¥Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏ (Ï†úÎ™© ÌïÑÎìúÏù∏ Í≤ΩÏö∞)
            if (fieldId === 'scenarioTitle') {
                updateSituationPreview();
            }

            // ÏãúÍ∞ÅÏ†Å ÌîºÎìúÎ∞±
            element.classList.add('selected');
            setTimeout(() => element.classList.remove('selected'), 300);

            // ÏûÖÎ†• Ïù¥Î≤§Ìä∏ Ìä∏Î¶¨Í±∞
            field.dispatchEvent(new Event('input', { bubbles: true }));
        }

        // === ÏÉÅÌô© ÎØ∏Î¶¨Î≥¥Í∏∞ Í∏∞Îä• ===
        function updateSituationPreview() {
            const title = document.getElementById('scenarioTitle').value;
            const previewDiv = document.getElementById('situationPreview');
            const contentDiv = document.getElementById('situationPreviewContent');

            if (!title) {
                previewDiv.style.display = 'none';
                return;
            }

            const situationExamples = {
                'Ïñ¥Ï†ú Ïà†ÏûêÎ¶¨ Ïù¥ÌõÑ': 'Ïñ¥Ï†ú Î∞§ Ïà†ÏûêÎ¶¨ÏóêÏÑú ÏßÑÏã¨Ïñ¥Î¶∞ ÎßàÏùåÏùÑ Í≥†Î∞±ÌñàÏßÄÎßå, Îëò Îã§ Ï∑®Ìï¥ÏûàÏñ¥ÏÑú Ïñ¥ÏÉâÌïú ÏÉÅÌô©. Ïò§Îäò ÏïÑÏπ®Ïóê Î©îÏã†Ï†ÄÎ°ú "Ïñ¥Ï†ú Í∏∞ÏñµÎÇò?"ÎùºÍ≥† ÏãúÏûëÌïòÎäî ÎåÄÌôî',
                'Í∞ëÏûëÏä§Îü¨Ïö¥ ÌÇ§Ïä§ Ïù¥ÌõÑ': 'ÏòàÏÉÅÏπò Î™ªÌïú ÏàúÍ∞ÑÏóê ÌÇ§Ïä§Í∞Ä ÏùºÏñ¥ÎÇ¨ÏßÄÎßå, Í∑∏ Ïù¥ÌõÑ Î©∞Ïπ†Í∞Ñ Ïó∞ÎùΩÏù¥ ÏóÜÏóàÎçò ÏÉÅÌô©. ÏÉÅÎåÄÎ∞©Ïù¥ Î®ºÏ†Ä "Í∑∏Îïå Ïùº ÎïåÎ¨∏Ïóê..."ÎùºÍ≥† Î©îÏã†Ï†ÄÎ•º Î≥¥ÎÇ¥Ïò® ÏÉÅÌô©',
                'Í≥†Î∞± ÌõÑ ÎãµÎ≥Ä Í∏∞Îã§Î¶¨Îäî Ï§ë': 'ÏßÑÏã¨ÏúºÎ°ú Í≥†Î∞±ÌñàÏßÄÎßå ÏïÑÏßÅ Î™ÖÌôïÌïú ÎãµÎ≥ÄÏùÑ Îì£ÏßÄ Î™ªÌïú ÏÉÅÌô©. ÏÉÅÎåÄÎ∞©Ïù¥ Ïã†Ï§ëÌïòÍ≤å Î©îÏã†Ï†ÄÎ°ú ÏûêÏã†Ïùò ÎßàÏùåÏùÑ Ï†ïÎ¶¨Ìï¥ÏÑú Î≥¥ÎÇ¥Îäî ÎåÄÌôî',
                'Ï≤´ Îç∞Ïù¥Ìä∏ ÏïΩÏÜç Ïû°Í∏∞': 'ÏÑúÎ°ú Ìò∏Í∞êÏù¥ ÏûàÎã§Îäî Í≤ÉÏùÑ ÌôïÏù∏ÌñàÏßÄÎßå, ÏïÑÏßÅ Í≥µÏãùÏ†ÅÏù∏ ÎßåÎÇ®ÏùÄ ÏóÜÏóàÎçò ÏÉÅÌô©. Î©îÏã†Ï†ÄÎ°ú ÏûêÏó∞Ïä§ÎüΩÍ≤å Ï≤´ Îç∞Ïù¥Ìä∏ ÏïΩÏÜçÏùÑ Ïû°ÏïÑÍ∞ÄÎäî Í≥ºÏ†ï',
                'Î∞§Îä¶ÏùÄ ÏßÑÏã¨ ÎåÄÌôî': 'ÌèâÏÜåÎ≥¥Îã§ Í∞êÏÑ±Ï†ÅÏù∏ ÏÉàÎ≤Ω ÏãúÍ∞Ñ, Ïû†Îì§Í∏∞ Ï†Ñ ÌèâÏÜå ÌïòÏßÄ Î™ªÌñàÎçò ÏßÑÏÜîÌïú ÎßàÏùåÏùÑ Î©îÏã†Ï†ÄÎ°ú ÎÇòÎàÑÎäî ÍπäÏùÄ ÎåÄÌôî',
                'Ïò§Ìï¥ ÌõÑ ÌôîÌï¥ÌïòÍ∏∞': 'ÏûëÏùÄ Ïò§Ìï¥Î°ú Ïù∏Ìï¥ ÏÇ¨Ïù¥Í∞Ä ÏÑúÎ®πÌï¥ÏßÑ ÏÉÅÌô©. Î©îÏã†Ï†ÄÎ°ú ÏßÑÏ†ïÏÑ± ÏûàÍ≤å ÏÇ¨Í≥ºÌïòÍ≥† ÏÑúÎ°úÏùò ÎßàÏùåÏùÑ ÌôïÏù∏ÌïòÎäî ÌôîÌï¥ Í≥ºÏ†ï',
                'ÏßàÌà¨ ÏÉÅÌô© Ìï¥Í≤∞ÌïòÍ∏∞': 'ÏÉÅÎåÄÎ∞©Ïù¥ Îã§Î•∏ ÏÇ¨ÎûåÍ≥º ÏπúÌïòÍ≤å ÏßÄÎÇ¥Îäî Î™®ÏäµÏùÑ Î≥∏ ÌõÑ ÏÉùÍ∏¥ ÏßàÌà¨Í∞êÏùÑ Î©îÏã†Ï†ÄÎ°ú ÏùÄÍ∑ºÌûà ÌëúÌòÑÌïòÎ©∞ Í¥ÄÍ≥ÑÎ•º ÌôïÏù∏ÌïòÎäî ÎåÄÌôî',
                'ÏÑúÏö¥Ìï® ÌëúÌòÑÌïòÍ∏∞': 'ÏÉÅÎåÄÎ∞©Ïùò Î¨¥Í¥ÄÏã¨ÌïòÍ±∞ÎÇò ÏÜåÌôÄÌïú ÌÉúÎèÑÏóê ÏÑúÏö¥Ìï®ÏùÑ ÎäêÍºàÏùÑ Îïå, Î©îÏã†Ï†ÄÎ°ú ÏÜîÏßÅÌïòÍ≤å ÏûêÏã†Ïùò Í∞êÏ†ïÏùÑ ÌëúÌòÑÌïòÎäî ÏÉÅÌô©',
                'Ïï†Íµê Î∂ÄÎ¶¨Î©∞ Îã¨ÎûòÍ∏∞': 'ÌèâÏÜåÎ≥¥Îã§ Ïï†ÍµêÏä§ÎüΩÍ≥† Í∑ÄÏó¨Ïö¥ Î©îÏãúÏßÄÎ°ú ÏÉÅÎåÄÎ∞©Ïùò ÎßàÏùåÏùÑ Îã¨ÎûòÍ±∞ÎÇò Í¥ÄÏã¨ÏùÑ ÎÅåÎ†§Í≥† ÎÖ∏Î†•ÌïòÎäî ÏÉÅÌô©',
                'ÏÉàÎ≤Ω Í∞êÏÑ± Î©îÏãúÏßÄ': 'ÏÉàÎ≤Ω Í∞êÏÑ±Ïóê Ï†ñÏñ¥ ÌèâÏÜå ÌïòÏßÄ Î™ªÌñàÎçò Î°úÎß®Ìã±Ìïú Î©îÏãúÏßÄÎÇò Í∞êÏ†ïÏùÑ ÏÜîÏßÅÌïòÍ≤å ÌëúÌòÑÌïòÎäî ÌäπÎ≥ÑÌïú ÏàúÍ∞Ñ',
                'Í∏∞ÎÖêÏùº ÍπúÏßù Ïù¥Î≤§Ìä∏': 'ÌäπÎ≥ÑÌïú ÎÇ†ÏùÑ Í∏∞ÎÖêÌïòÎ©∞ Î©îÏã†Ï†ÄÎ°ú ÍπúÏßù Ïù¥Î≤§Ìä∏ÎÇò ÏÑ†Î¨ºÏùÑ Ï§ÄÎπÑÌñàÎã§Îäî Î©îÏãúÏßÄÎ•º Î≥¥ÎÇ¥Îäî ÏÑ§Î†àÎäî ÏÉÅÌô©',
                'Ïû•Í±∞Î¶¨ Ïó∞Ïï† Í∑∏Î¶¨ÏõÄ': 'Î©ÄÎ¶¨ Îñ®Ïñ¥Ï†∏ ÏûàÏñ¥ÏÑú ÏûêÏ£º ÎßåÎÇ† Ïàò ÏóÜÎäî ÏÉÅÌô©ÏóêÏÑú Î©îÏã†Ï†ÄÎ°ú Í∑∏Î¶¨ÏõÄÍ≥º Ïï†ÌããÌïú ÎßàÏùåÏùÑ Ï†ÑÌïòÎäî ÎåÄÌôî'
            };

            const example = situationExamples[title];
            if (example) {
                contentDiv.innerHTML = `
                    <div style="margin-bottom: 10px;">
                        <strong>üì± ${title}</strong>
                    </div>
                    <div style="color: #666; font-size: 14px; line-height: 1.4;">
                        ${example}
                    </div>
                `;
                previewDiv.style.display = 'block';
            } else {
                previewDiv.style.display = 'none';
            }
        }

        // === ÏóêÌîºÏÜåÎìú Í¥ÄÎ¶¨ Ìï®ÏàòÎì§ ===
        function manageDialogues(scenarioId) {
            switchTab('dialogues');

            // select ÏöîÏÜåÍ∞Ä ÏûàÏúºÎ©¥ Í∞í ÏÑ§Ï†ï
            const dialogueSelect = document.getElementById('dialogueScenarioSelect');
            if (dialogueSelect) {
                dialogueSelect.value = scenarioId;
            }

            // currentScenarioIdÎ°úÎèÑ ÏÑ§Ï†ï (Ïπ¥Îìú Í∏∞Î∞ò UIÏóêÏÑú ÏÇ¨Ïö©)
            currentScenarioId = scenarioId;

            loadDialogues();
        }

        function populateDialogueScenarioSelect() {
            const select = document.getElementById('dialogueScenarioSelect');

            // DOM ÏöîÏÜåÍ∞Ä Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏúºÎ©¥ Ï°∞Ïö©Ìûà Î¶¨ÌÑ¥ (Ïπ¥Îìú Í∏∞Î∞ò UI ÏÇ¨Ïö©)
            if (!select) {
                return;
            }

            select.innerHTML = '<option value="">ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>';

            Object.values(scenarios).forEach(scenario => {
                const option = document.createElement('option');
                option.value = scenario.id;
                option.textContent = scenario.title;
                select.appendChild(option);
            });
        }

        async function loadDialogues() {
            // Ï§ëÎ≥µ Ìò∏Ï∂ú Î∞©ÏßÄ
            if (processingState.loadingEpisodes) {
                console.log('‚è≥ ÏóêÌîºÏÜåÎìú Î°úÎî© Ïù¥ÎØ∏ ÏßÑÌñâ Ï§ë - Í±¥ÎÑàÎúÄ');
                return;
            }

            processingState.loadingEpisodes = true;

            try {
                // Ïö∞ÏÑ†ÏàúÏúÑ: currentScenarioId ‚Üí dialogueScenarioSelect Í∞í
                let scenarioId = currentScenarioId;

            const dialogueSelect = document.getElementById('dialogueScenarioSelect');
            if (dialogueSelect && dialogueSelect.value) {
                scenarioId = dialogueSelect.value;
            }

            if (!scenarioId) {
                document.getElementById('dialogueInfo').style.display = 'none';
                console.log('‚ö†Ô∏è ÏãúÎÇòÎ¶¨Ïò§ IDÍ∞Ä ÏóÜÏñ¥ÏÑú ÏóêÌîºÏÜåÎìú Î°úÎî©ÏùÑ Í±¥ÎÑàÎúÅÎãàÎã§.');
                console.log('üîç ÎîîÎ≤ÑÍ∑∏ Ï†ïÎ≥¥:', {
                    currentScenarioId: currentScenarioId,
                    dialogueSelectValue: dialogueSelect ? dialogueSelect.value : 'element not found'
                });
                return;
            }

                currentScenarioId = scenarioId;
                document.getElementById('dialogueInfo').style.display = 'block';
                console.log('üìö ÏóêÌîºÏÜåÎìú Î°úÎî© ÏãúÏûë - ÏãúÎÇòÎ¶¨Ïò§:', scenarioId);

                // APIÏóêÏÑú ÏóêÌîºÏÜåÎìú Î°úÎî©
                console.log('üîó Dialogue Manager API Ìò∏Ï∂ú:', `/api/dialogue-manager?action=list&scenario_id=${scenarioId}`);

                const response = await fetch(`/api/dialogue-manager?action=list&scenario_id=${scenarioId}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('üìä API ÏùëÎãµ:', result);
                console.log('üîç ÏÉÅÏÑ∏ ÎîîÎ≤ÑÍπÖ:', {
                    success: result.success,
                    dialogues_count: result.dialogues ? result.dialogues.length : 0,
                    scenario_id: result.scenario_id,
                    requested_scenario_id: scenarioId,
                    first_dialogue: result.dialogues && result.dialogues[0] ? result.dialogues[0] : 'none'
                });

                let dialoguesData = {};

                if (result.success && result.dialogues) {
                    // APIÏóêÏÑú Î∞õÏùÄ ÎåÄÌôîÎ•º dialogue_numberÎ•º ÌÇ§Î°ú ÌïòÎäî Í∞ùÏ≤¥Î°ú Î≥ÄÌôò
                    result.dialogues.forEach(dialogue => {
                        dialoguesData[dialogue.dialogue_number] = dialogue;
                    });

                    console.log(`‚úÖ ÏãúÎÇòÎ¶¨Ïò§ ${scenarioId}Ïùò ÎåÄÌôî:`, Object.keys(dialoguesData).length, 'Í∞ú');
                    console.log('üìã ÎåÄÌôî Î≤àÌò∏ Î™©Î°ù:', Object.keys(dialoguesData));
                    console.log('üìÑ Ï≤´ Î≤àÏß∏ ÎåÄÌôî ÏÉÅÏÑ∏:', dialoguesData[Object.keys(dialoguesData)[0]]);
                } else {
                    console.log('üì≠ Ìï¥Îãπ ÏãúÎÇòÎ¶¨Ïò§Ïóê ÏÉùÏÑ±Îêú ÎåÄÌôîÍ∞Ä ÏóÜÏäµÎãàÎã§.');
                }

                // Ï†ÑÏó≠ Î≥ÄÏàò ÏóÖÎç∞Ïù¥Ìä∏
                dialogues = dialoguesData;
                window.dialogues = dialoguesData;

                // UI ÏóÖÎç∞Ïù¥Ìä∏
                displayDialogues();
                updateDialogueStats();

            } catch (error) {
                console.error('‚ùå ÏóêÌîºÏÜåÎìú API Î°úÎìú Ïò§Î•ò:', error);
                // API Ïã§Ìå® Ïãú Îπà Í∞ùÏ≤¥Î°ú Ï¥àÍ∏∞Ìôî
                dialogues = {};
                window.dialogues = {};
                displayDialogues();
                updateDialogueStats();

                showNotification(`ÏóêÌîºÏÜåÎìú Î°úÎìú Ïã§Ìå®: ${error.message}`, 'error');
            } finally {
                // Î°úÎî© ÏÉÅÌÉú Ìï¥Ï†ú
                processingState.loadingEpisodes = false;
                console.log('üîì ÏóêÌîºÏÜåÎìú Î°úÎî© ÏÉÅÌÉú Ìï¥Ï†ú');
            }
        }

        function displayDialogues() {
            const grid = document.getElementById('dialoguesGrid');
            grid.innerHTML = '';
            grid.className = 'episodes-grid'; // ÏóêÌîºÏÜåÎìú Ïπ¥Îìú Ï†ÑÏö© Í∑∏Î¶¨Îìú Ïä§ÌÉÄÏùº Ï†ÅÏö©

            console.log('üé® ÏóêÌîºÏÜåÎìú ÌëúÏãú ÏãúÏûë:', {
                dialogues_object: dialogues,
                dialogues_keys: Object.keys(dialogues),
                currentDifficultyFilter: currentDifficultyFilter
            });

            let displayedCount = 0;
            let completedCount = 0;

            for (let i = 1; i <= 36; i++) {
                const dialogue = dialogues[i];
                const difficulty = getDifficultyByNumber(i);

                if (currentDifficultyFilter !== 'all' && difficulty !== currentDifficultyFilter) {
                    continue;
                }

                if (dialogue) {
                    completedCount++;
                    console.log(`‚úÖ ÏóêÌîºÏÜåÎìú ${i}Î≤à ÌëúÏãú:`, dialogue.title || dialogue.id);
                }

                const card = createDialogueCard(i, dialogue, difficulty);
                grid.innerHTML += card;
                displayedCount++;
            }

            console.log(`üé® ÎåÄÌôî ÌëúÏãú ÏôÑÎ£å: ÌëúÏãúÎê® ${displayedCount}Í∞ú, ÏôÑÎ£åÎê® ${completedCount}Í∞ú`);
        }

        function createDialogueCard(number, dialogue, difficulty) {
            if (dialogue) {
                const characterName = getCharacterName(dialogue.character_id);
                return `
                    <div class="episode-card" onclick="previewDialogue(${number})" title="ÌÅ¥Î¶≠ÌïòÏó¨ ÏóêÌîºÏÜåÎìú #${number} ÎØ∏Î¶¨Î≥¥Í∏∞">
                        <div class="dialogue-header">
                            <div class="dialogue-number">#${number}</div>
                            <div class="difficulty-badge ${difficulty.toLowerCase()}">${difficulty.toUpperCase()}</div>
                        </div>
                        <div class="dialogue-content">
                            <div class="character-info">
                                <span class="character-icon">üë§</span>
                                <span class="character-name">${characterName}</span>
                            </div>
                            <div class="dialogue-status completed">
                                <span class="status-icon">‚úÖ</span>
                                <span class="status-text">ÏôÑÎ£åÎê®</span>
                            </div>
                        </div>
                        <div class="dialogue-actions">
                            <span class="action-btn preview">üìñ ÎØ∏Î¶¨Î≥¥Í∏∞</span>
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div class="episode-card" onclick="createDialogue(${number})" title="ÌÅ¥Î¶≠ÌïòÏó¨ ÏóêÌîºÏÜåÎìú #${number} ÏÉàÎ°ú ÏÉùÏÑ±">
                        <div class="dialogue-header">
                            <div class="dialogue-number">#${number}</div>
                            <div class="difficulty-badge ${difficulty.toLowerCase()}">${difficulty.toUpperCase()}</div>
                        </div>
                        <div class="dialogue-content">
                            <div class="empty-state">
                                <span class="empty-icon">üìù</span>
                                <span class="empty-text">ÏóêÌîºÏÜåÎìú ÏÉùÏÑ±</span>
                            </div>
                        </div>
                        <div class="dialogue-actions">
                            <span class="action-btn create">‚ú® ÏÉùÏÑ±ÌïòÍ∏∞</span>
                        </div>
                    </div>
                `;
            }
        }

        function getDifficultyColor(difficulty) {
            const colors = {
                'easy': '#4CAF50',
                'medium': '#FF9800',
                'hard': '#F44336',
                'expert': '#9C27B0'
            };
            return colors[difficulty.toLowerCase()] || '#666';
        }

        function getDifficultyByNumber(number) {
            if (number <= 9) return 'easy';
            if (number <= 18) return 'medium';
            if (number <= 27) return 'hard';
            return 'expert';
        }

        function getCharacterName(characterId) {
            const names = {
                'yuna_infp': 'Ïú§ÏïÑ',
                'mina_enfp': 'ÎØ∏ÎÇò',
                'seoyeon_intj': 'ÏÑúÏó∞',
                'jihye_esfj': 'ÏßÄÌòú',
                'hyejin_istp': 'ÌòúÏßÑ'
            };
            return names[characterId] || 'Ïïå Ïàò ÏóÜÏùå';
        }

        function updateDialogueStats() {
            const dialogueArray = Object.values(dialogues);

            // ÏóêÌîºÏÜåÎìú Í∞úÏàò Í≥ÑÏÇ∞: ÏãúÎÇòÎ¶¨Ïò§ + Ï∫êÎ¶≠ÌÑ∞ Ï°∞Ìï©Î≥ÑÎ°ú Í∑∏Î£πÌôî
            const episodeGroups = new Set();
            dialogueArray.forEach(dialogue => {
                if (dialogue.scenario_id && dialogue.character_id) {
                    episodeGroups.add(`${dialogue.scenario_id}_${dialogue.character_id}`);
                }
            });

            const episodeCount = episodeGroups.size;
            const totalDialogues = dialogueArray.length;

            console.log('üìä ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏:', {
                Ï¥ù_ÎåÄÌôîÏàò: totalDialogues,
                ÏóêÌîºÏÜåÎìú_Ï°∞Ìï©: Array.from(episodeGroups),
                ÏóêÌîºÏÜåÎìú_Í∞úÏàò: episodeCount
            });

            document.getElementById('totalDialogues').textContent = `${totalDialogues}/36`;
            document.getElementById('progressBar').style.width = `${(totalDialogues/36)*100}%`;
            document.getElementById('episodeCount').textContent = episodeCount;
            
            // ÎÇúÏù¥ÎèÑÎ≥Ñ Ïπ¥Ïö¥Ìä∏
            let counts = { easy: 0, medium: 0, hard: 0, expert: 0 };
            dialogueArray.forEach(ep => {
                const difficulty = getDifficultyByNumber(ep.dialogue_number);
                counts[difficulty]++;
            });
            
            document.getElementById('easyCount').textContent = `${counts.easy}/9`;
            document.getElementById('mediumCount').textContent = `${counts.medium}/9`;
            document.getElementById('hardCount').textContent = `${counts.hard}/9`;
            document.getElementById('expertCount').textContent = `${counts.expert}/9`;
            
            // ÌÉ≠ Ïπ¥Ïö¥Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('allCount').textContent = totalDialogues;
            document.getElementById('easyTabCount').textContent = counts.easy;
            document.getElementById('mediumTabCount').textContent = counts.medium;
            document.getElementById('hardTabCount').textContent = counts.hard;
            document.getElementById('expertTabCount').textContent = counts.expert;
        }

        // ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÏÉÅÌÉú ÌôïÏù∏ Î∞è Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî
        async function checkServerConnection() {
            try {
                console.log('üîó ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÏÉÅÌÉú ÌôïÏù∏ Ï§ë...');

                // API ÏóîÎìúÌè¨Ïù∏Ìä∏Î≥Ñ ÏÉÅÌÉú ÌôïÏù∏
                const checks = [
                    { name: 'Dialogue Manager', url: '/api/dialogue-manager?action=test' },
                    { name: 'Scenario Manager', url: `/api/scenario-manager?action=list&_t=${Date.now()}` },
                    { name: 'Character Manager', url: `/api/character-ai-generator?action=list_characters&_t=${Date.now()}` }
                ];

                const results = [];
                for (const check of checks) {
                    try {
                        const response = await fetch(check.url);
                        const isOk = response.ok;
                        results.push({ name: check.name, status: isOk ? '‚úÖ' : '‚ùå', code: response.status });
                        console.log(`${isOk ? '‚úÖ' : '‚ùå'} ${check.name}: ${response.status}`);
                    } catch (error) {
                        results.push({ name: check.name, status: '‚ùå', error: error.message });
                        console.error(`‚ùå ${check.name}: ${error.message}`);
                    }
                }

                // Ïó∞Í≤∞ ÏÉÅÌÉú UI ÏóÖÎç∞Ïù¥Ìä∏
                const statusElement = document.getElementById('serverStatus');
                if (statusElement) {
                    const allOk = results.every(r => r.status === '‚úÖ');
                    statusElement.innerHTML = allOk ?
                        'üü¢ ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ï†ïÏÉÅ' :
                        'üî¥ ÏùºÎ∂Ä ÏÑúÎ≤Ñ Ïó∞Í≤∞ Î∂àÏïàÏ†ï';
                    statusElement.className = allOk ? 'server-status online' : 'server-status offline';
                }

                return results;
            } catch (error) {
                console.error('‚ùå ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÌôïÏù∏ Ïã§Ìå®:', error);
                return [];
            }
        }

        // Ï†ÑÏ≤¥ ÏóêÌîºÏÜåÎìú Ïπ¥Ïö¥Ìä∏ Î°úÎìú (Ï¥àÍ∏∞ÌôîÏö©)
        async function loadTotalEpisodeCount() {
            // Ï§ëÎ≥µ Ìò∏Ï∂ú Î∞©ÏßÄ
            if (processingState.loadingTotal) {
                console.log('‚è≥ Ï†ÑÏ≤¥ ÏóêÌîºÏÜåÎìú Ïπ¥Ïö¥Ìä∏ Î°úÎî© Ïù¥ÎØ∏ ÏßÑÌñâ Ï§ë - Í±¥ÎÑàÎúÄ');
                return;
            }

            const now = Date.now();
            if (processingState.lastUpdate && (now - processingState.lastUpdate) < processingState.updateInterval) {
                console.log('‚è∞ ÏóÖÎç∞Ïù¥Ìä∏ Í∞ÑÍ≤© Ï†úÌïú - Í±¥ÎÑàÎúÄ (ÏµúÍ∑º ÏóÖÎç∞Ïù¥Ìä∏:', new Date(processingState.lastUpdate).toLocaleTimeString(), ')');
                return;
            }

            processingState.loadingTotal = true;
            processingState.lastUpdate = now;

            try {
                console.log('üìä Ï†ÑÏ≤¥ ÏóêÌîºÏÜåÎìú Ïπ¥Ïö¥Ìä∏ Î°úÎî© ÏãúÏûë...');

                // dialogue-manager APIÎ•º ÌÜµÌï¥ Ï†ÑÏ≤¥ ÏóêÌîºÏÜåÎìú Ï°∞Ìöå ÏãúÎèÑ
                const response = await fetch('/api/dialogue-manager?action=get_all_episodes');

                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.episodes) {
                        const allEpisodes = Object.values(result.episodes);

                        // ÏóêÌîºÏÜåÎìú Í∞úÏàò Í≥ÑÏÇ∞: ÏãúÎÇòÎ¶¨Ïò§ + Ï∫êÎ¶≠ÌÑ∞ Ï°∞Ìï©Î≥ÑÎ°ú Í∑∏Î£πÌôî
                        const episodeGroups = new Set();
                        allEpisodes.forEach(episode => {
                            if (episode.scenario_id && episode.character_id) {
                                episodeGroups.add(`${episode.scenario_id}_${episode.character_id}`);
                            }
                        });

                        const totalEpisodeCount = episodeGroups.size;
                        const totalDialogueCount = allEpisodes.length;

                        console.log('üìä Ï†ÑÏ≤¥ ÌÜµÍ≥Ñ:', {
                            Ï¥ù_ÏóêÌîºÏÜåÎìú_Ïàò: totalEpisodeCount,
                            Ï¥ù_ÎåÄÌôî_Ïàò: totalDialogueCount,
                            ÏóêÌîºÏÜåÎìú_Ï°∞Ìï©: Array.from(episodeGroups)
                        });

                        // ÏóêÌîºÏÜåÎìú ÌÉ≠ Ïπ¥Ïö¥Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
                        document.getElementById('episodeCount').textContent = totalEpisodeCount;

                        return totalEpisodeCount;
                    }
                }

                // API ÏùëÎãµÏù¥ Ïã§Ìå®Ìïú Í≤ΩÏö∞ ÏóêÎü¨ Ï∂úÎ†•
                const errorText = await response.text();
                throw new Error(`API Ïò§Î•ò (${response.status}): ${errorText}`);

            } catch (error) {
                console.error('‚ùå Ï†ÑÏ≤¥ ÏóêÌîºÏÜåÎìú Ïπ¥Ïö¥Ìä∏ Î°úÎî© Ïã§Ìå®:', error.message);
                showNotification(`Ï†ÑÏ≤¥ ÏóêÌîºÏÜåÎìú Ïπ¥Ïö¥Ìä∏ Î°úÎî© Ïã§Ìå®: ${error.message}`, 'error');

                // ÏóêÎü¨ Î∞úÏÉù Ïãú Í∏∞Î≥∏Í∞í ÌëúÏãú
                document.getElementById('episodeCount').textContent = 'ERROR';
            } finally {
                // Î°úÎî© ÏÉÅÌÉú Ìï¥Ï†ú
                processingState.loadingTotal = false;
                console.log('üîì Ï†ÑÏ≤¥ ÏóêÌîºÏÜåÎìú Ïπ¥Ïö¥Ìä∏ Î°úÎî© ÏÉÅÌÉú Ìï¥Ï†ú');
            }
        }

        function filterByDifficulty(difficulty) {
            currentDifficultyFilter = difficulty;
            
            // ÌÉ≠ ÌôúÏÑ±Ìôî ÏÉÅÌÉú Î≥ÄÍ≤Ω
            document.querySelectorAll('.difficulty-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.closest('.difficulty-tab').classList.add('active');
            
            displayDialogues();
        }

        function openDialogueModal(mode) {
            currentMode = mode;

            // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§Í∞Ä ÏóÜÏúºÎ©¥ Í≤ΩÍ≥†
            if (!currentScenarioId) {
                alert('Î®ºÏ†Ä ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.\n\nÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ùÏóêÏÑú ÏãúÎÇòÎ¶¨Ïò§Î•º ÌÅ¥Î¶≠ÌïòÍ±∞ÎÇò,\n"ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉù" ÎìúÎ°≠Îã§Ïö¥ÏóêÏÑú ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            document.getElementById('dialogueModalTitle').textContent = 'ÏÉà ÏóêÌîºÏÜåÎìú ÏÉùÏÑ±';
            document.getElementById('dialogueForm').reset();
            document.getElementById('dialoguePreview').style.display = 'none';
            generatedDialogue = null;

            // ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§ Ï†ïÎ≥¥ ÏûêÎèô ÌëúÏãú
            updateSelectedScenarioInfo();

            // ÏóêÌîºÏÜåÎìú Î≤àÌò∏Îäî ÏÇ¨Ïö©ÏûêÍ∞Ä ÏßÅÏ†ë ÏûÖÎ†•ÌïòÎèÑÎ°ù Ìï®
            document.getElementById('dialogueNumber').value = '';
            document.getElementById('difficulty').value = 'easy';

            // Î∞±Í∑∏ÎùºÏö¥Îìú Ïä§ÌÅ¨Î°§ ÎπÑÌôúÏÑ±Ìôî
            document.body.style.overflow = 'hidden';

            document.getElementById('dialogueModal').style.display = 'block';
        }

        function createDialogue(number) {
            // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§Í∞Ä ÏóÜÏúºÎ©¥ ÏóêÎü¨
            if (!currentScenarioId) {
                alert('Î®ºÏ†Ä ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            openDialogueModal('create');
            document.getElementById('dialogueNumber').value = number;

            // ÎÇúÏù¥ÎèÑ ÏûêÎèô ÏÑ§Ï†ï
            const difficulty = getDifficultyByNumber(number);
            document.getElementById('difficulty').value = difficulty;

            // ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§ Ï†ïÎ≥¥ ÌëúÏãú
            updateSelectedScenarioInfo();
        }

        function updateSelectedScenarioInfo() {
            // ÏãúÎÇòÎ¶¨Ïò§ Ï†ïÎ≥¥ Ï°∞Ìöå (window.scenarios ÎòêÎäî Ï†ÑÏó≠ scenarios ÏÇ¨Ïö©)
            const scenariosData = window.scenarios || scenarios || {};
            const scenario = scenariosData[currentScenarioId];
            const infoContainer = document.getElementById('selectedScenarioInfo');

            if (scenario && infoContainer) {
                // ÏãúÎÇòÎ¶¨Ïò§Ïóê Ïó∞Í≤∞Îêú Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                const characterId = scenario.available_characters?.[0];

                // Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥ Ï°∞Ìöå (window.characters ÎòêÎäî Ï†ÑÏó≠ characters ÏÇ¨Ïö©)
                const charactersData = window.characters || characters || {};
                const character = charactersData[characterId];

                infoContainer.innerHTML = `
                    <div class="info-title">${scenario.title}</div>
                    <div class="info-character">Ï∫êÎ¶≠ÌÑ∞: ${character ? character.name : characterId || 'Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥ ÏóÜÏùå'}</div>
                    <div class="info-description" style="color: #6c757d; margin-top: 5px; font-size: 0.9em;">${scenario.description}</div>
                `;

                // hidden inputÏóê ÏãúÎÇòÎ¶¨Ïò§ ID ÏÑ§Ï†ï
                document.getElementById('dialogueScenarioId').value = currentScenarioId;
            } else {
                infoContainer.innerHTML = `
                    <div class="info-title">ÏãúÎÇòÎ¶¨Ïò§ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§</div>
                    <div class="info-character">Î®ºÏ†Ä ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.</div>
                `;
            }
        }

        // Episode Preview Functions
        let currentPreviewDialogueNumber = null;

        function previewDialogue(number) {
            const episode = dialogues[number];
            if (!episode) {
                alert('ÏóêÌîºÏÜåÎìú Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }

            currentPreviewDialogueNumber = number;
            console.log('üìñ ÏóêÌîºÏÜåÎìú ÎØ∏Î¶¨Î≥¥Í∏∞:', number, episode);

            // Update modal title
            document.getElementById('dialoguePreviewTitle').textContent = `üìñ ÏóêÌîºÏÜåÎìú #${number} ÎØ∏Î¶¨Î≥¥Í∏∞`;

            // Display episode metadata
            displayDialogueMetadata(episode, number);

            // Display dialogue content
            displayDialogueContent(episode);

            // Show modal
            document.getElementById('dialoguePreviewModal').style.display = 'block';
        }

        function displayDialogueMetadata(episode, number) {
            const metadata = document.getElementById('dialogueMetadata');
            const difficulty = getDifficultyByNumber(number);
            const characterName = getCharacterName(episode.character_id);

            metadata.innerHTML = `
                <div class="metadata-item">
                    <div class="metadata-label">ÏóêÌîºÏÜåÎìú Î≤àÌò∏</div>
                    <div class="metadata-value">#${number}</div>
                </div>
                <div class="metadata-item">
                    <div class="metadata-label">ÎÇúÏù¥ÎèÑ</div>
                    <div class="metadata-value">${difficulty.toUpperCase()}</div>
                </div>
                <div class="metadata-item">
                    <div class="metadata-label">Ï∫êÎ¶≠ÌÑ∞</div>
                    <div class="metadata-value">${characterName} (${episode.character_id})</div>
                </div>
                <div class="metadata-item">
                    <div class="metadata-label">ÏãúÎÇòÎ¶¨Ïò§</div>
                    <div class="metadata-value">${episode.scenario_id}</div>
                </div>
                <div class="metadata-item">
                    <div class="metadata-label">ÏÉùÏÑ±Ïùº</div>
                    <div class="metadata-value">${episode.created_at ? new Date(episode.created_at).toLocaleString() : 'Ïïå Ïàò ÏóÜÏùå'}</div>
                </div>
                <div class="metadata-item">
                    <div class="metadata-label">ÏÉÅÌô© ÌîÑÎ°¨ÌîÑÌä∏</div>
                    <div class="metadata-value">${episode.user_input_prompt || 'ÏóÜÏùå'}</div>
                </div>
            `;
        }

        function displayDialogueContent(episode) {
            const characterMessage = document.getElementById('characterMessage');
            const narrationDisplay = document.getElementById('narrationDisplay');
            const choicesDisplay = document.getElementById('choicesDisplay');

            // Get dialogue data - check all possible field names and structures
            let dialogueData = episode.dialogue || episode.generated_dialogue || episode.ai_generated_dialogue;

            console.log('üí¨ ÏóêÌîºÏÜåÎìú Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞:', episode);
            console.log('üí¨ ÎåÄÌôî Îç∞Ïù¥ÌÑ∞:', dialogueData);

            if (dialogueData) {
                // Handle different dialogue data structures
                let characterMsg = '';
                let narrationText = '';
                let choices = [];

                // Check if it's a story_flow structure
                if (dialogueData.story_flow && Array.isArray(dialogueData.story_flow)) {
                    const dialogueFlow = dialogueData.story_flow.find(item => item.type === 'dialogue');
                    const choiceFlow = dialogueData.story_flow.find(item => item.type === 'choice_point');

                    characterMsg = dialogueFlow ? dialogueFlow.text : 'ÎåÄÌôî ÎÇ¥Ïö©Ïù¥ ÏóÜÏäµÎãàÎã§.';
                    narrationText = dialogueFlow ? dialogueFlow.narration : '';
                    choices = choiceFlow ? choiceFlow.choices : [];
                } else {
                    // Standard dialogue structure
                    characterMsg = dialogueData.dialogue || dialogueData.character_message || dialogueData.text || 'ÎåÄÌôî ÎÇ¥Ïö©Ïù¥ ÏóÜÏäµÎãàÎã§.';
                    narrationText = dialogueData.narration || dialogueData.context || '';
                    choices = dialogueData.choices || [];
                }

                // Display character message
                characterMessage.innerHTML = `<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff;">${characterMsg}</div>`;

                // Display narration
                if (narrationText) {
                    narrationDisplay.innerHTML = `<div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; font-style: italic;">${narrationText}</div>`;
                    narrationDisplay.style.display = 'block';
                } else {
                    narrationDisplay.style.display = 'none';
                }

                // Display choices
                if (choices && Array.isArray(choices) && choices.length > 0) {
                    let choicesHtml = '<div style="margin-top: 15px;"><h4 style="margin-bottom: 10px; color: #495057;">ÏÑ†ÌÉùÏßÄ:</h4>';
                    choices.forEach((choice, index) => {
                        const impact = choice.affection_impact || 0;
                        const impactClass = impact > 0 ? 'impact-positive' : impact < 0 ? 'impact-negative' : 'impact-neutral';
                        const impactText = impact > 0 ? `+${impact}` : impact < 0 ? `${impact}` : '0';

                        choicesHtml += `
                            <div class="choice-preview" style="margin-bottom: 10px; padding: 12px; border: 1px solid #dee2e6; border-radius: 6px; background: #ffffff;">
                                <div class="choice-text" style="font-weight: 500; margin-bottom: 5px;">${index + 1}. ${choice.text}</div>
                                <div class="choice-impact ${impactClass}" style="font-size: 0.85em; font-weight: bold;">Ìò∏Í∞êÎèÑ ${impactText}</div>
                            </div>
                        `;
                    });
                    choicesHtml += '</div>';
                    choicesDisplay.innerHTML = choicesHtml;
                } else {
                    choicesDisplay.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">ÏÑ†ÌÉùÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>';
                }

                // Ï∂îÍ∞Ä Ï†ïÎ≥¥ ÌëúÏãú
                if (dialogueData.generated_at || dialogueData.source) {
                    const additionalInfo = document.createElement('div');
                    additionalInfo.style.cssText = 'margin-top: 20px; padding: 10px; background: #e9ecef; border-radius: 6px; font-size: 0.85em; color: #6c757d;';
                    additionalInfo.innerHTML = `
                        ${dialogueData.generated_at ? `<div>ÏÉùÏÑ± ÏãúÍ∞Ñ: ${new Date(dialogueData.generated_at).toLocaleString()}</div>` : ''}
                        ${dialogueData.source ? `<div>ÏÉùÏÑ± ÏóîÏßÑ: ${dialogueData.source}</div>` : ''}
                        ${dialogueData.difficulty ? `<div>ÎÇúÏù¥ÎèÑ: ${dialogueData.difficulty}</div>` : ''}
                    `;
                    choicesDisplay.appendChild(additionalInfo);
                }

            } else {
                characterMessage.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 20px; background: #f8d7da; border-radius: 6px;">ÎåÄÌôî Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.</div>';
                narrationDisplay.style.display = 'none';
                choicesDisplay.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">ÎåÄÌôî Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</div>';
            }
        }

        function editDialogueFromPreview() {
            if (currentPreviewDialogueNumber !== null) {
                closeModal('dialoguePreviewModal');
                editDialogue(currentPreviewDialogueNumber);
            }
        }

        function editDialogue(number) {
            const episode = dialogues[number];
            if (!episode) return;
            
            currentMode = 'edit';
            document.getElementById('dialogueModalTitle').textContent = 'ÏóêÌîºÏÜåÎìú ÏàòÏ†ï';
            document.getElementById('dialogueId').value = dialogue.id;
            document.getElementById('dialogueScenarioId').value = dialogue.scenario_id;
            document.getElementById('dialogueNumber').value = dialogue.dialogue_number;
            document.getElementById('characterSelect').value = dialogue.character_id;
            document.getElementById('difficulty').value = dialogue.difficulty;
            document.getElementById('userPrompt').value = dialogue.user_input_prompt;
            
            // AI ÏÉùÏÑ± ÎåÄÌôî ÌëúÏãú
            if (dialogue.ai_generated_dialogue) {
                generatedDialogue = dialogue.ai_generated_dialogue;
                displayDialoguePreview(generatedDialogue);
            }
            
            if (dialogue.custom_dialogue) {
                const custom = JSON.parse(dialogue.custom_dialogue);
                document.getElementById('customDialogue').value = custom.dialogue || '';
                document.getElementById('customNarration').value = custom.narration || '';
            }

            // Î∞±Í∑∏ÎùºÏö¥Îìú Ïä§ÌÅ¨Î°§ ÎπÑÌôúÏÑ±Ìôî
            document.body.style.overflow = 'hidden';

            document.getElementById('dialogueModal').style.display = 'block';
        }

        async function generateDialogue() {
            const userPrompt = document.getElementById('userPrompt').value;
            const difficulty = document.getElementById('difficulty').value;

            // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§ÏóêÏÑú Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
            const currentScenario = window.scenarios?.[currentScenarioId];
            if (!currentScenario) {
                alert('ÏãúÎÇòÎ¶¨Ïò§ Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. ÏãúÎÇòÎ¶¨Ïò§Î•º Î®ºÏ†Ä ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            const characterId = currentScenario.available_characters?.[0] || currentScenario.character_id;
            const characterName = currentScenario.character_name || characterId;

            if (!userPrompt) {
                alert('ÏÉÅÌô© ÌîÑÎ°¨ÌîÑÌä∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            const previewDiv = document.getElementById('dialoguePreview');
            previewDiv.style.display = 'block';

            document.getElementById('previewDialogue').innerHTML = '<div class="loading"></div> AIÍ∞Ä ÎåÄÌôîÎ•º ÏÉùÏÑ± Ï§ëÏûÖÎãàÎã§...';
            document.getElementById('previewNarration').textContent = '';
            document.getElementById('previewChoices').innerHTML = '';

            try {
                console.log('ü§ñ AI ÎåÄÌôî ÏÉùÏÑ± ÏãúÏûë...');
                console.log(`üéØ Ï∫êÎ¶≠ÌÑ∞: ${characterName} (${characterId})`);
                console.log(`üìù ÌîÑÎ°¨ÌîÑÌä∏: ${userPrompt}`);
                console.log(`‚ö° ÎÇúÏù¥ÎèÑ: ${difficulty}`);

                // Ï±ÑÌåÖ ÌõàÎ†® APIÎ•º ÏÇ¨Ïö©Ìïú ÎåÄÌôî ÏÉùÏÑ± (ÏãúÎÇòÎ¶¨Ïò§ Ïª®ÌÖçÏä§Ìä∏ Ìè¨Ìï®)
                generatedDialogue = await generateLocalDialogue(characterId, characterName, userPrompt, difficulty, currentScenario);

                // ÏßßÏùÄ ÏßÄÏó∞ÏúºÎ°ú Î°úÎî© Ìö®Í≥º Ï†úÍ≥µ
                setTimeout(() => {
                    displayDialoguePreview(generatedDialogue);
                    console.log('‚úÖ AI ÎåÄÌôî ÏÉùÏÑ± ÏôÑÎ£å');
                }, 1000);

            } catch (error) {
                console.error('‚ùå ÎåÄÌôî ÏÉùÏÑ± Ïò§Î•ò:', error);

                // ÏóêÎü¨ Î©îÏãúÏßÄ ÌëúÏãú (Ìè¥Î∞± ÎåÄÏã†)
                const errorMessage = `‚ùå AI ÎåÄÌôî ÏÉùÏÑ± Ïã§Ìå®\n\n${error.message}\n\n‚Ä¢ API Ïó∞Í≤∞ ÏÉÅÌÉúÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî\n‚Ä¢ Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî\n‚Ä¢ Î¨∏Ï†úÍ∞Ä ÏßÄÏÜçÎêòÎ©¥ Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Î¨∏ÏùòÌïòÏÑ∏Ïöî`;

                document.getElementById('previewDialogue').innerHTML = `
                    <div class="error-message">
                        <p><strong>‚ùå AI ÎåÄÌôî ÏÉùÏÑ± Ïã§Ìå®</strong></p>
                        <p>${error.message}</p>
                        <ul>
                            <li>API Ïó∞Í≤∞ ÏÉÅÌÉúÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî</li>
                            <li>Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî</li>
                            <li>Î¨∏Ï†úÍ∞Ä ÏßÄÏÜçÎêòÎ©¥ Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Î¨∏ÏùòÌïòÏÑ∏Ïöî</li>
                        </ul>
                    </div>
                `;

                document.getElementById('previewNarration').textContent = '';
                document.getElementById('previewChoices').innerHTML = '';

                // ÌåùÏóÖÏúºÎ°úÎèÑ ÏóêÎü¨ ÏïåÎ¶º
                setTimeout(() => {
                    alert(errorMessage);
                }, 1500);
            }
        }

        function displayDialoguePreview(dialogue) {
            if (!dialogue) return;
            
            document.getElementById('dialoguePreview').style.display = 'block';
            document.getElementById('previewDialogue').textContent = dialogue.dialogue;
            document.getElementById('previewNarration').textContent = dialogue.narration;
            
            const choicesList = document.getElementById('previewChoices');
            choicesList.innerHTML = '';
            
            dialogue.choices.forEach(choice => {
                const li = document.createElement('li');
                li.className = 'choice-item';
                li.innerHTML = `
                    <span>${choice.text}</span>
                    <span class="impact">Ìò∏Í∞êÎèÑ ${choice.affection_impact > 0 ? '+' : ''}${choice.affection_impact}</span>
                `;
                choicesList.appendChild(li);
            });
        }

        async function saveDialogue() {
            // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§ Ï†ïÎ≥¥ ÏÇ¨Ïö©
            const scenarioId = currentScenarioId;
            const dialogueNumber = parseInt(document.getElementById('dialogueNumber').value);
            const difficulty = document.getElementById('difficulty').value;
            const userPrompt = document.getElementById('userPrompt').value;

            if (!scenarioId || !dialogueNumber || !userPrompt) {
                alert('Î™®Îì† ÌïÑÏàò Ìï≠Î™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.\n\n- ÎåÄÌôî Î≤àÌò∏\n- ÎÇúÏù¥ÎèÑ ÏÑ§Ï†ï\n- ÏÉÅÌô© ÌîÑÎ°¨ÌîÑÌä∏');
                return;
            }

            // ÌòÑÏû¨ ÏãúÎÇòÎ¶¨Ïò§ÏóêÏÑú Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
            const currentScenario = window.scenarios?.[scenarioId];
            if (!currentScenario) {
                alert('ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§ Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }

            // ÏãúÎÇòÎ¶¨Ïò§Ïùò Ï≤´ Î≤àÏß∏ Ï∫êÎ¶≠ÌÑ∞ ÏûêÎèô ÏÇ¨Ïö©
            const characterId = currentScenario.available_characters?.[0] || currentScenario.character_id;
            const characterName = currentScenario.character_name || characterId;
            
            const dialogueData = {
                scenario_id: scenarioId,
                dialogue_number: dialogueNumber,
                character_id: characterId,
                character_name: characterName,
                difficulty: difficulty,
                user_input_prompt: userPrompt,
                created_at: new Date().toISOString(),
                id: currentMode === 'create' ? `dialogue_${scenarioId}_${dialogueNumber}_${Date.now()}` : document.getElementById('dialogueId').value
            };
            
            if (currentMode === 'create') {
                dialogueData.action = 'create';
            } else {
                dialogueData.action = 'update';
                dialogueData.id = document.getElementById('dialogueId').value;
            }
            
            // Ïª§Ïä§ÌÖÄ ÎåÄÌôîÍ∞Ä ÏûàÏúºÎ©¥ Ï∂îÍ∞Ä
            const customDialogue = document.getElementById('customDialogue').value;
            const customNarration = document.getElementById('customNarration').value;
            if (customDialogue || customNarration) {
                dialogueData.custom_dialogue = {
                    dialogue: customDialogue,
                    narration: customNarration
                };
            }
            
            // ÏÉùÏÑ±Îêú ÎåÄÌôîÍ∞Ä ÏûàÏúºÎ©¥ Ï∂îÍ∞Ä
            if (generatedDialogue) {
                dialogueData.generated_dialogue = generatedDialogue;
            }
            
            try {
                console.log('üíæ === ÏóêÌîºÏÜåÎìú Ï†ÄÏû• ÏãúÏûë ===');
                console.log('üìä ÏóêÌîºÏÜåÎìú Îç∞Ïù¥ÌÑ∞:', dialogueData);

                // Dialogue Manager API Ìò∏Ï∂ú
                console.log('üîó Dialogue Manager API Ìò∏Ï∂ú...');

                const apiUrl = '/api/dialogue-manager';
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dialogueData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('üìä API ÏùëÎãµ:', result);

                if (result.success) {
                    console.log('‚úÖ Dialogue Manager API Ï†ÄÏû• ÏÑ±Í≥µ!');

                    // ÏÑ±Í≥µ Î©îÏãúÏßÄ
                    const successMessage = currentMode === 'create' ?
                        `üíñ ÏÉàÎ°úÏö¥ ÎåÄÌôî ${dialogueNumber}Î≤àÏù¥ ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!\nÏãúÎÇòÎ¶¨Ïò§: ${window.scenarios?.[scenarioId]?.title || scenarioId}\nÏ∫êÎ¶≠ÌÑ∞: ${characterName}` :
                        `‚ú®ÎåÄÌôî ${dialogueNumber}Î≤àÏù¥ ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§!`;

                    showNotification(successMessage, 'success');
                    closeModal('dialogueModal');

                    // UI ÏµúÏ¢Ö ÏóÖÎç∞Ïù¥Ìä∏
                    console.log('üîÑ Ï†ÄÏû• ÌõÑ ÏµúÏ¢Ö UI ÎèôÍ∏∞Ìôî...');
                    await loadDialogues(); // ÏóêÌîºÏÜåÎìú Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                    await loadTotalEpisodeCount(); // Ï†ÑÏ≤¥ ÏóêÌîºÏÜåÎìú Ïπ¥Ïö¥Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
                    updateScenarioStats();
                } else {
                    throw new Error(result.message || 'API ÏùëÎãµÏóêÏÑú success: false');
                }

                console.log('‚úÖ ÏóêÌîºÏÜåÎìú Ï†ÄÏû• ÌîÑÎ°úÏÑ∏Ïä§ ÏôÑÎ£å!');

            } catch (error) {
                await ErrorLogger.error('Episode Save Failed', error, {
                    action: 'save_episode',
                    component: 'dialogue_manager',
                    data: {
                        scenarioId: currentScenarioId,
                        dialogueNumber: document.getElementById('dialogueNumber').value,
                        difficulty: document.getElementById('difficulty').value
                    }
                });
                alert('ÎåÄÌôî Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
            }
        }

        async function generateBulkDialogues() {
            console.log('üöÄ ÎåÄÌôî ÏùºÍ¥Ñ ÏÉùÏÑ± ÏãúÏûë...');

            // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§ ÌôïÏù∏
            if (!currentScenarioId) {
                alert('Î®ºÏ†Ä ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.\n\nÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ùÏóêÏÑú ÏãúÎÇòÎ¶¨Ïò§Î•º ÌÅ¥Î¶≠ÌïòÍ±∞ÎÇò,\n"ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉù" ÎìúÎ°≠Îã§Ïö¥ÏóêÏÑú ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            // ÏãúÎÇòÎ¶¨Ïò§ Ï†ïÎ≥¥ Ï°∞Ìöå (window.scenarios ÎòêÎäî Ï†ÑÏó≠ scenarios ÏÇ¨Ïö©)
            const scenariosData = window.scenarios || scenarios || {};
            const selectedScenario = scenariosData[currentScenarioId];

            console.log('üîç ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ ÏÜåÏä§:', window.scenarios ? 'window.scenarios' : 'scenarios');
            console.log('üîç Ï†ÑÏ≤¥ ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù:', Object.keys(scenariosData));
            console.log('üîç Ï∞æÎäî ÏãúÎÇòÎ¶¨Ïò§ ID:', currentScenarioId);
            console.log('üîç Ï∞æÏùÄ ÏãúÎÇòÎ¶¨Ïò§:', selectedScenario);

            if (!selectedScenario) {
                alert(`ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§ Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.\n\nÏãúÎÇòÎ¶¨Ïò§ ID: ${currentScenarioId}\nÏÇ¨Ïö© Í∞ÄÎä•Ìïú ÏãúÎÇòÎ¶¨Ïò§: ${Object.keys(scenariosData).join(', ')}`);
                return;
            }

            console.log('‚úÖ ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§:', selectedScenario.title);

            // ÏãúÎÇòÎ¶¨Ïò§Ïóê Ïó∞Í≤∞Îêú Ï∫êÎ¶≠ÌÑ∞ ÏûêÎèô ÏÇ¨Ïö©
            const characterId = selectedScenario.available_characters?.[0] || selectedScenario.character_id;

            // Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥ Ï°∞Ìöå (window.characters ÎòêÎäî Ï†ÑÏó≠ characters ÏÇ¨Ïö©)
            const charactersData = window.characters || characters || {};
            const character = charactersData[characterId];

            console.log('üîç Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ ÏÜåÏä§:', window.characters ? 'window.characters' : 'characters');
            console.log('üîç Ï∞æÎäî Ï∫êÎ¶≠ÌÑ∞ ID:', characterId);
            console.log('üîç Ï†ÑÏ≤¥ Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù:', Object.keys(charactersData));
            console.log('üîç Ï∞æÏùÄ Ï∫êÎ¶≠ÌÑ∞:', character);

            if (!character) {
                alert(`ÏãúÎÇòÎ¶¨Ïò§Ïóê Ïó∞Í≤∞Îêú Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.\n\nÏ∫êÎ¶≠ÌÑ∞ ID: ${characterId}\nÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ï∫êÎ¶≠ÌÑ∞: ${Object.keys(charactersData).join(', ')}`);
                return;
            }

            console.log('‚úÖ ÏûêÎèô ÏÑ†ÌÉùÎêú Ï∫êÎ¶≠ÌÑ∞:', character.name);
            
            // 3. ÏóêÌîºÏÜåÎìú Î≤îÏúÑ ÏÑ†ÌÉù
            const startNum = parseInt(prompt('ÏãúÏûë ÎåÄÌôî Î≤àÌò∏ (1-36):'));
            const endNum = parseInt(prompt('Ï¢ÖÎ£å ÎåÄÌôî Î≤àÌò∏ (1-36):'));
            
            if (!startNum || !endNum || startNum < 1 || endNum > 36 || startNum > endNum) {
                alert('Ïò¨Î∞îÎ•∏ Î≤îÏúÑÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî. (1-36, ÏãúÏûëÎ≤àÌò∏ ‚â§ Ï¢ÖÎ£åÎ≤àÌò∏)');
                return;
            }
            
            const dialogueCount = endNum - startNum + 1;
            
            // 4. ÌôïÏù∏ Î∞è ÏÉùÏÑ±
            if (confirm(`üìã ÏùºÍ¥Ñ ÏÉùÏÑ± ÏÑ§Ï†ï:\n\nÏãúÎÇòÎ¶¨Ïò§: ${selectedScenario.title}\nÏ∫êÎ¶≠ÌÑ∞: ${character.name} (${character.mbti})\nÎ≤îÏúÑ: ${startNum}Î≤à ~ ${endNum}Î≤à (Ï¥ù ${dialogueCount}Í∞ú)\n\n‚ö†Ô∏è Ï£ºÏùò: AI API Ïó∞Í≤∞Ïù¥ Ïã§Ìå®ÌïòÎ©¥ Ï†ÑÏ≤¥ ÏÉùÏÑ±Ïù¥ Ï§ëÎã®Îê©ÎãàÎã§.\n\nÏÉùÏÑ±ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                
                console.log('üîÑ ÎåÄÌôî ÏùºÍ¥Ñ ÏÉùÏÑ± ÏßÑÌñâ...');
                let successCount = 0;
                let failCount = 0;
                
                for (let dialogueNum = startNum; dialogueNum <= endNum; dialogueNum++) {
                    try {
                        // Í∞Å ÏóêÌîºÏÜåÎìúÎ≥Ñ ÏÉÅÌô© ÌîÑÎ°¨ÌîÑÌä∏ ÏûêÎèô ÏÉùÏÑ±
                        const situationPrompts = [
                            "Ïö∞Ïó∞Ìûà ÎßàÏ£ºÏπú ÏÉÅÌô©ÏóêÏÑú ÏÑúÎ°úÎ•º ÏùòÏãùÌïòÎ©∞",
                            "Ìï®Íªò Í≥ºÏ†úÎ•º ÌïòÎ©¥ÏÑú Í∞ÄÍπåÏõåÏßÄÎäî ÏàúÍ∞Ñ",
                            "ÎπÑ ÎÇ¥Î¶¨Îäî ÎÇ† Í∞ôÏùÄ Ïö∞ÏÇ∞ÏùÑ Ïì∞Í≤å ÎêòÏñ¥",
                            "Ï∂ïÏ†úÏóêÏÑú Ìï®Íªò Ï¶êÍ±∞Ïö¥ ÏãúÍ∞ÑÏùÑ Î≥¥ÎÇ¥Î©∞",
                            "Ï°∞Ïö©Ìïú ÎèÑÏÑúÍ¥ÄÏóêÏÑú ÎààÏù¥ ÎßàÏ£ºÏ≥ê",
                            "Ïπ¥ÌéòÏóêÏÑú Ïö∞Ïó∞Ìûà ÎßåÎÇò ÎåÄÌôîÌïòÎ©∞",
                            "Î∞©Í≥ºÌõÑ ÍµêÏã§ÏóêÏÑú ÎëòÎßå ÎÇ®Í≤å ÎêòÏñ¥",
                            "ÏÇ∞Ï±ÖÌïòÎ©∞ ÏßÑÏÜîÌïú ÎåÄÌôîÎ•º ÎÇòÎàÑÎäî",
                            "ÌïôÍµê Ïò•ÏÉÅÏóêÏÑú Î∞îÎùºÎ≥∏ ÌïòÎäòÏ≤òÎüº Ï≤≠ÎüâÌïú",
                            "Ï∂îÏö¥ Í≤®Ïö∏ Îî∞ÎúªÌïú ÎßàÏùåÏùÑ ÎÇòÎàÑÎäî"
                        ];
                        
                        const promptIndex = (dialogueNum - 1) % situationPrompts.length;
                        const userPrompt = situationPrompts[promptIndex];
                        
                        // ÎÇúÏù¥ÎèÑ ÏÑ§Ï†ï (1-9: Easy, 10-18: Medium, 19-27: Hard, 28-36: Expert)
                        let difficulty = 'Easy';
                        if (dialogueNum >= 10 && dialogueNum <= 18) difficulty = 'Medium';
                        else if (dialogueNum >= 19 && dialogueNum <= 27) difficulty = 'Hard';
                        else if (dialogueNum >= 28 && dialogueNum <= 36) difficulty = 'Expert';
                        
                        // OpenAI API Rate Limiting Î∞©ÏßÄÎ•º ÏúÑÌïú ÏßÄÏó∞ (2Î≤àÏß∏ ÏöîÏ≤≠Î∂ÄÌÑ∞)
                        if (dialogueNum > startNum) {
                            console.log(`‚è≥ Rate Limiting Î∞©ÏßÄ ÎåÄÍ∏∞ Ï§ë... (${dialogueNum}Î≤àÏß∏ ÏöîÏ≤≠)`);
                            await new Promise(resolve => setTimeout(resolve, 2000)); // 2Ï¥à ÎåÄÍ∏∞
                        }

                        // Ï±ÑÌåÖ ÌõàÎ†® APIÎ•º ÏÇ¨Ïö©Ìïú ÎåÄÌôî ÏÉùÏÑ± (Ìè¥Î∞± ÏóÜÏùå)
                        console.log(`üéØ ÎåÄÌôî ${dialogueNum}Î≤à ÏÉùÏÑ± ÏãúÏûë...`);
                        const generatedDialogue = await generateLocalDialogue(characterId, character.name, userPrompt, difficulty);
                        
                        // ÏóêÌîºÏÜåÎìú Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
                        const dialogueData = {
                            dialogue_number: dialogueNum,
                            scenario_id: currentScenarioId,
                            character_id: characterId,
                            character_name: character.name,
                            user_input_prompt: userPrompt,
                            difficulty: difficulty,
                            ai_generated_dialogue: generatedDialogue,
                            generated_dialogue: generatedDialogue,
                            created_at: new Date().toISOString()
                        };
                        
                        // Dialogue Manager API Ìò∏Ï∂ú
                        const response = await fetch('/api/dialogue-manager', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                ...dialogueData,
                                action: 'create'
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`API Ìò∏Ï∂ú Ïã§Ìå®: ${response.status}`);
                        }

                        const result = await response.json();
                        if (!result.success) {
                            throw new Error(result.message || 'API Ï†ÄÏû• Ïã§Ìå®');
                        }
                        
                        successCount++;
                        console.log(`‚úÖ ÎåÄÌôî ${dialogueNum}Î≤à ÏÉùÏÑ± ÏôÑÎ£å`);
                        
                    } catch (error) {
                        console.error(`‚ùå ÎåÄÌôî ${dialogueNum}Î≤à ÏÉùÏÑ± Ïã§Ìå®:`, error);

                        // AI API ÏóêÎü¨ Ïãú Ï¶âÏãú Ï§ëÎã®ÌïòÍ≥† ÏÇ¨Ïö©ÏûêÏóêÍ≤å ÏïåÎ¶º
                        const errorMessage = `‚ùå AI ÎåÄÌôî ÏÉùÏÑ± Ïã§Ìå®\n\nÎåÄÌôî ${dialogueNum}Î≤àÏóêÏÑú Ïò§Î•ò Î∞úÏÉù:\n${error.message}\n\nÏÑ±Í≥µ: ${successCount}Í∞ú\nÏã§Ìå®: ${dialogueNum - startNum + 1}Î≤àÎ∂ÄÌÑ∞ Ï§ëÎã®\n\nÌï¥Í≤∞ Î∞©Î≤ï:\n1. OpenAI API ÌÇ§ ÌôòÍ≤ΩÎ≥ÄÏàò ÌôïÏù∏\n2. Vercel ÎåÄÏãúÎ≥¥ÎìúÏóêÏÑú ÌôòÍ≤ΩÎ≥ÄÏàò ÏÑ§Ï†ï\n3. API ÌÅ¨Î†àÎîß ÏûîÏï° ÌôïÏù∏\n4. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑ`;

                        alert(errorMessage);

                        // Ï¶âÏãú Ï§ëÎã®
                        return;
                    }
                }

                // Î™®Îì† ÏóêÌîºÏÜåÎìú ÏÑ±Í≥µ ÏãúÏóêÎßå ÌëúÏãú
                alert(`üéâ ÏùºÍ¥Ñ ÏÉùÏÑ± ÏôÑÎ£å!\n\n‚úÖ ÏÑ±Í≥µ: ${successCount}Í∞ú ÎåÄÌôî ÏÉùÏÑ±\n\nÎåÄÌôî Î™©Î°ùÏùÑ ÏÉàÎ°úÍ≥†Ïπ®Ìï©ÎãàÎã§.`);
                
                // UI ÏóÖÎç∞Ïù¥Ìä∏ (currentScenarioIdÎäî Ïù¥ÎØ∏ ÏÑ§Ï†ïÎêòÏñ¥ ÏûàÏùå)
                loadDialogues();
                loadTotalEpisodeCount(); // Ï†ÑÏ≤¥ ÏóêÌîºÏÜåÎìú Ïπ¥Ïö¥Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
            }
        }

        // === Ï∫êÎ¶≠ÌÑ∞ Í¥ÄÎ¶¨ Ìï®ÏàòÎì§ ===
        // üöÄ GitHub API Ïö∞ÏÑ† Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú (ÌòÅÏã†Ï†Å Ìï¥Í≤∞Ï±Ö!)
        async function loadCharacters() {
            console.log('üì• === Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú ÏãúÏûë (GitHub API Ïö∞ÏÑ†) ===');
            console.log('üïí Î°úÎìú ÏãúÍ∞Ñ:', new Date().toISOString());
            
            // 1ÏàúÏúÑ: GitHub APIÏóêÏÑú Î°úÎìú (ÏµúÏã† ÏòÅÍµ¨ Îç∞Ïù¥ÌÑ∞)
            try {
                console.log('üêô GitHub APIÏóêÏÑú Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú...');
                
                // GitHub ÌÜ†ÌÅ∞ÏùÄ ÏÑúÎ≤ÑÏÇ¨Ïù¥ÎìúÏóêÏÑú ÌôòÍ≤ΩÎ≥ÄÏàòÎ°ú Ï≤òÎ¶¨
                console.log('üîê GitHub ÌÜ†ÌÅ∞ÏùÄ ÏÑúÎ≤ÑÏóêÏÑú ÏûêÎèô Í¥ÄÎ¶¨Îê®');
                
                // APIÎ•º ÌÜµÌï¥ GitHub Îç∞Ïù¥ÌÑ∞ Î°úÎìú (ÌÜ†ÌÅ∞ÏùÄ ÏÑúÎ≤ÑÏóêÏÑú Ï≤òÎ¶¨)
                const apiResponse = await fetch(`/api/character-ai-generator?action=list_characters&_t=${Date.now()}`);
                if (apiResponse.ok) {
                    const apiData = await apiResponse.json();
                    const gitHubCharacters = apiData.characters || {};
                    const characterCount = Object.keys(gitHubCharacters).length;
                    console.log('üìä GitHub Ï∫êÎ¶≠ÌÑ∞ Ïàò:', characterCount);
                    
                    if (characterCount > 0) {
                        characters = gitHubCharacters;
                        
                        // GitHub Îç∞Ïù¥ÌÑ∞Î•º Î°úÏª¨ÏóêÎèÑ Î∞±ÏóÖ
                        localStorage.setItem('chatgame_characters', JSON.stringify(characters));
                        
                        console.log('‚úÖ GitHub APIÏóêÏÑú Î°úÎìú ÏôÑÎ£å. Ï∫êÎ¶≠ÌÑ∞ IDÎì§:', Object.keys(characters));
                        displayCharacters();
                        updateCharacterStats();
                        console.log('üéâ === Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú ÏôÑÎ£å (GitHub API) ===');
                        return;
                    } else {
                        console.log('üì≠ GitHubÏóê Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå');
                    }
                } else {
                    console.log('üîê GitHub ÌÜ†ÌÅ∞ ÏóÜÏùå, Îã§Î•∏ Î∞©Î≤ï ÏãúÎèÑ...');
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è GitHub API Î°úÎìú Ïã§Ìå®:', error);
            }
            
            // 2ÏàúÏúÑ: Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú Î°úÎìú (Î∞±ÏóÖ)
            try {
                console.log('üíæ Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú Ï∫êÎ¶≠ÌÑ∞ Î∞±ÏóÖ Î°úÎìú...');
                const localData = localStorage.getItem('chatgame_characters');
                
                if (localData) {
                    const localCharacters = JSON.parse(localData);
                    const characterCount = Object.keys(localCharacters).length;
                    console.log('üìä Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ Î∞±ÏóÖ Ï∫êÎ¶≠ÌÑ∞ Ïàò:', characterCount);
                    
                    if (characterCount > 0) {
                        characters = localCharacters;
                        console.log('‚úÖ Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ Î∞±ÏóÖÏóêÏÑú Î°úÎìú ÏôÑÎ£å. Ï∫êÎ¶≠ÌÑ∞ IDÎì§:', Object.keys(characters));
                        displayCharacters();
                        updateCharacterStats();
                        console.log('üéâ === Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú ÏôÑÎ£å (Î°úÏª¨ Î∞±ÏóÖ) ===');
                        return;
                    }
                }
            } catch (error) {
                console.error('‚ùå Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ Î°úÎìú ÏòàÏô∏:', error);
            }
            
            // 3ÏàúÏúÑ: AI APIÏóêÏÑú Î°úÎìú
            try {
                console.log('ü§ñ AI Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±Í∏∞ API Î°úÎìú...');
                console.log('ü§ñ AI Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±Í∏∞ API Ìò∏Ï∂ú...');
                const aiResponse = await fetch('/api/character-ai-generator?action=list_characters&_t=' + Date.now());
                
                console.log('üì∂ AI API ÏùëÎãµ ÏÉÅÌÉú:', aiResponse.status);
                
                if (aiResponse.ok) {
                    const aiData = await aiResponse.json();
                    console.log('ü§ñ AI API ÏõêÏãú ÏùëÎãµ:', JSON.stringify(aiData, null, 2));
                    
                    if (aiData.success && aiData.characters) {
                        const characterCount = Object.keys(aiData.characters).length;
                        console.log('üìä AI API Ï∫êÎ¶≠ÌÑ∞ Ïàò:', characterCount);
                        
                        if (characterCount > 0) {
                            characters = aiData.characters;
                            console.log('‚úÖ AI APIÏóêÏÑú Î°úÎìú ÏôÑÎ£å. Ï∫êÎ¶≠ÌÑ∞ IDÎì§:', Object.keys(characters));
                            displayCharacters();
                            updateCharacterStats();
                            console.log('üéâ === Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú ÏôÑÎ£å (AI API) ===');
                            return;
                        } else {
                            console.log('üòµ AI APIÏóêÏÑú Îπà Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù Î∞òÌôò');
                        }
                    } else {
                        console.log('üòµ AI API ÏùëÎãµÏù¥ ÎπÑÏ†ïÏÉÅ:', aiData);
                    }
                } else {
                    console.log('‚ùå AI API HTTP Ïò§Î•ò:', aiResponse.status);
                }
            } catch (error) {
                console.error('‚ùå AI API ÏòàÏô∏:', error);
            }
            
            try {
                // Í∏∞Î≥∏ characters.json ÏãúÎèÑ
                console.log('üìÅ Í∏∞Î≥∏ characters.json ÌååÏùº Î°úÎìú...');
                const response = await fetch('/data/characters.json?_t=' + Date.now());
                
                console.log('üì∂ Í∏∞Î≥∏ ÌååÏùº ÏùëÎãµ ÏÉÅÌÉú:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('üìÅ Í∏∞Î≥∏ ÌååÏùº ÏõêÏãú Îç∞Ïù¥ÌÑ∞:', JSON.stringify(data, null, 2));
                    
                    if (data.characters && Array.isArray(data.characters)) {
                        // Array ÌòïÌÉúÎ•º Object ÌòïÌÉúÎ°ú Î≥ÄÌôò
                        characters = {};
                        data.characters.forEach(char => {
                            characters[char.id] = char;
                        });
                        const characterCount = Object.keys(characters).length;
                        console.log('‚úÖ Í∏∞Î≥∏ ÌååÏùºÏóêÏÑú Î°úÎìúÎêú Ï∫êÎ¶≠ÌÑ∞ Ïàò:', characterCount);
                        
                        if (characterCount > 0) {
                            console.log('‚úÖ Ï∫êÎ¶≠ÌÑ∞ IDÎì§:', Object.keys(characters));
                        }
                        
                        displayCharacters();
                        updateCharacterStats();
                        console.log('üéâ === Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú ÏôÑÎ£å (Í∏∞Î≥∏ ÌååÏùº) ===');
                        return;
                    } else {
                        console.log('üòµ Í∏∞Î≥∏ ÌååÏùºÏùò characters ÌïÑÎìúÍ∞Ä ÎπÑÏñ¥ÏûàÍ±∞ÎÇò ÎπÑÏ†ïÏÉÅ');
                    }
                } else {
                    console.log('‚ùå Í∏∞Î≥∏ ÌååÏùº HTTP Ïò§Î•ò:', response.status);
                }
            } catch (error) {
                console.error('‚ùå Í∏∞Î≥∏ ÌååÏùº ÏòàÏô∏:', error);
            }
            
            // Î™®Îì† Î∞©Î≤ïÏù¥ Ïã§Ìå®ÌïòÎ©¥ Îπà Îç∞Ïù¥ÌÑ∞Î°ú Ï¥àÍ∏∞Ìôî
            console.log('‚ö†Ô∏è === Î™®Îì† Î°úÎìú Î∞©Î≤ï Ïã§Ìå®, Îπà Îç∞Ïù¥ÌÑ∞Î°ú Ï¥àÍ∏∞Ìôî ===');
            characters = {};
            displayCharacters();
            updateCharacterStats();
            console.log('üéâ === Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú ÏôÑÎ£å (Îπà Îç∞Ïù¥ÌÑ∞) ===');
        }

        // Í∏∞Î≥∏ Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú (fallback)
        // ÏÇ¨Ïö©ÌïòÏßÄ ÏïäÏùÑ ÏòàÏ†ïÏù¥ÎØÄÎ°ú Ï£ºÏÑù Ï≤òÎ¶¨
        // function loadDefaultCharacters() { ... }







        window.displayCharacters = function displayCharacters() {
            console.log('üé® === Ï∫êÎ¶≠ÌÑ∞ ÌëúÏãú Ìï®Ïàò ÏãúÏûë ===');
            console.log('üîç Ï†ÑÏó≠ characters Î≥ÄÏàò ÌôïÏù∏:', typeof characters, characters);
            console.log('üîç window.characters ÌôïÏù∏:', typeof window.characters, window.characters);

            const container = document.getElementById('charactersContainer');
            if (!container) {
                console.error('‚ùå charactersContainer ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå!');
                return;
            }

            const characterArray = Object.values(characters || {});
            console.log('üìä ÌëúÏãúÌï† Ï∫êÎ¶≠ÌÑ∞ Ïàò:', characterArray.length);
            console.log('üìã Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù:', characterArray.map(c => `${c?.name || 'NO_NAME'} (${c?.id || 'NO_ID'})`));
            
            if (characterArray.length === 0) {
                console.log('üì≠ Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÏóÜÏùå - Îπà ÏÉÅÌÉú Î©îÏãúÏßÄ ÌëúÏãú');
                container.innerHTML = `
                    <div class="empty-state">
                        <p>üé≠ ÏÉùÏÑ±Îêú Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</p>
                        <p><small>ÏúÑÏùò "üé≠‚ú® AI Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±Í∏∞" Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ ÏÉàÎ°úÏö¥ Ï∫êÎ¶≠ÌÑ∞Î•º ÎßåÎì§Ïñ¥Î≥¥ÏÑ∏Ïöî!</small></p>
                        <button class="btn btn-primary" onclick="openCharacterModal('create')" style="margin-top: 10px;">
                            ‚ú® ÏßÄÍ∏à Ï∫êÎ¶≠ÌÑ∞ ÎßåÎì§Í∏∞
                        </button>
                    </div>
                `;
                return;
            }

            console.log('üé® Ï∫êÎ¶≠ÌÑ∞ Ïπ¥Îìú HTML ÏÉùÏÑ± Ï§ë...');
            container.innerHTML = characterArray.map(character => `
                <div class="character-card" onclick="showCharacterDetail('${character.id}')">
                    <div class="character-image">
                        <div id="profile-image-${character.id}" class="profile-image-container">
                            ${character.image ?
                                `<img src="${character.image}" alt="${getCharacterName(character)}" onerror="this.src='data:image/svg+xml,<svg xmlns=\\"http://www.w3.org/2000/svg\\" viewBox=\\"0 0 100 100\\"><rect width=\\"100\\" height=\\"100\\" fill=\\"%23f0f0f0\\"/><text x=\\"50\\" y=\\"50\\" text-anchor=\\"middle\\" dy=\\".3em\\" fill=\\"%23999\\">${getCharacterName(character).charAt(0)}</text></svg>'"/>` :
                                `<div class="no-image">${getCharacterName(character).charAt(0)}</div>`
                            }
                        </div>
                    </div>
                    <div class="character-info">
                        <!-- AI ÌîÑÎ°¨ÌîÑÌä∏ ÌëúÏãú ÏòÅÏó≠ -->
                        ${character.ai_prompt ? `
                        <div class="character-prompt-indicator" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4px 8px; border-radius: 15px; margin-bottom: 8px; font-size: 0.75em; display: inline-block; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <span style="margin-right: 3px;">ü§ñ</span>
                            <strong>AI ÏÜåÍ∞úÏûàÏùå</strong>
                        </div>
                        ` : ''}

                        <div class="mbti">${getCharacterMBTI(character)}</div>
                        <h3>${getCharacterName(character)} (${getCharacterAge(character)})</h3>
                        <p style="font-size: 0.9em; color: #34495e; margin-bottom: 8px;"><strong>Ïä§ÌÉÄÏùº:</strong> ${getCharacterSeductionStyle(character)}</p>
                        <p style="font-size: 0.9em; color: #34495e; margin-bottom: 8px;"><strong>Ï≤¥Ìòï:</strong> ${getCharacterBody(character)}</p>
                        <div style="font-size: 0.85em; color: #7f8c8d; margin-bottom: 8px;">
                            <strong>Ïô∏Î™®:</strong> ${getCharacterStyle(character)} ‚Ä¢ ${getCharacterBust(character)}
                        </div>
                        <div style="font-size: 0.85em; color: #27ae60; margin-bottom: 10px;">
                            <strong>ÏöïÍµ¨:</strong> ${getCharacterCoreDesires(character)}
                        </div>
                        <!-- ÏÇ¨ÏßÑ ÎØ∏Î¶¨Î≥¥Í∏∞ -->
                        <div class="photo-thumbnails" id="photo-preview-${character.id}">
                            <!-- ÏÇ¨ÏßÑ Ïç∏ÎÑ§ÏùºÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
                        </div>

                        <div class="actions" onclick="event.stopPropagation()">
                            <button class="btn btn-success" onclick="editCharacter('${character.id}')">‚öôÔ∏è</button>
                            <button class="btn btn-primary" onclick="openPhotoManager('${character.id}', '${getCharacterName(character)}')">üì∑</button>
                            <button class="btn btn-danger" onclick="deleteCharacter('${character.id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `).join('');
            console.log('‚úÖ Ï∫êÎ¶≠ÌÑ∞ Ïπ¥Îìú HTML ÏÉùÏÑ± ÏôÑÎ£å');

            // Í∞Å Ï∫êÎ¶≠ÌÑ∞Ïùò ÏÇ¨ÏßÑ ÎØ∏Î¶¨Î≥¥Í∏∞ Î°úÎìú (Î≥µÍµ¨ ÌõÑ Ïû¨ÌôúÏÑ±Ìôî)
            console.log('üîÑ Í∞Å Ï∫êÎ¶≠ÌÑ∞Ïùò ÏÇ¨ÏßÑ Î°úÎìú ÏãúÏûë... (Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Î≥µÍµ¨Îê®)');
            characterArray.forEach((character, index) => {
                console.log(`üì∏ ${index + 1}/${characterArray.length} Ï∫êÎ¶≠ÌÑ∞ ÏÇ¨ÏßÑ Î°úÎìú: ${character.id}`);
                loadCharacterPhotoPreview(character.id);

                // Í∞úÏÑ†Îêú ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ Î°úÎìú (ÎîîÎ∞îÏö¥Ïä§ Ï†ÅÏö©)
                setTimeout(() => {
                    loadCharacterProfileImageEnhanced(character.id);
                }, index * 200); // 200ms Í∞ÑÍ≤©ÏúºÎ°ú ÏàúÏ∞® Î°úÎìú
            });
            console.log('‚úÖ Î™®Îì† Ï∫êÎ¶≠ÌÑ∞ ÏÇ¨ÏßÑ Î°úÎìú Ìï®Ïàò Ìò∏Ï∂ú ÏôÑÎ£å');
        }

        // üîÑ Ïä§ÌÇ§Îßà Ìò∏ÌôòÏÑ±ÏùÑ ÏúÑÌïú Ìó¨Ìçº Ìï®ÏàòÎì§ (v2.0 ÏóÖÍ∑∏Î†àÏù¥Îìú)

        // ÏïàÏ†ÑÌïú ÏöîÏÜå ÏÑ§Ï†ï Ìï®Ïàò (Ï†ÑÏó≠ Ïä§ÏΩîÌîÑ)
        function safeSetValue(id, value) {
            const element = document.getElementById(id);
            if (element && value !== null && value !== undefined) {
                element.value = value;
                console.log(`‚úÖ ${id} ÏÑ§Ï†ï ÏôÑÎ£å:`, value);
                return true;
            } else if (!element) {
                console.warn(`‚ö†Ô∏è ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå: ${id}`);
            } else {
                console.log(`‚ÑπÔ∏è ${id} Í∞íÏù¥ ÎπÑÏñ¥ÏûàÏùå:`, value);
            }
            return false;
        }

        function getCharacterName(character) {
            return character.basic_info?.name || character.name || 'Ïù¥Î¶Ñ ÏóÜÏùå';
        }

        function getCharacterMBTI(character) {
            return character.basic_info?.mbti || character.mbti || 'MBTI ÏóÜÏùå';
        }

        function getCharacterTraits(character) {
            // ÏÉùÏÑ±Ìèº Í∏∞Ï§Ä: personality_traits Î∞∞Ïó¥ÏùÑ Ïö∞ÏÑ†Ï†ÅÏúºÎ°ú ÌëúÏãú
            if (character.personality_traits) {
                return Array.isArray(character.personality_traits)
                    ? character.personality_traits.join(', ')
                    : character.personality_traits;
            }

            // Î∞±ÏóÖ: v2.0 Ïä§ÌÇ§ÎßàÏùò charm_points
            if (character.appeal_profile?.charm_points && Array.isArray(character.appeal_profile.charm_points)) {
                return character.appeal_profile.charm_points
                    .map(point => translateToKorean(point, 'charm_points'))
                    .join(', ');
            }

            // Í∏∞ÌÉÄ Ìò∏ÌôòÏÑ±
            return character.personality || 'ÌäπÏÑ± Ï†ïÎ≥¥ ÏóÜÏùå';
        }

        function getCharacterSpeechStyle(character) {
            const style = character.conversation_dynamics?.speech_style ||
                         character.speech_style ||
                         'ÎßêÌà¨ Ï†ïÎ≥¥ ÏóÜÏùå';

            if (style === 'ÎßêÌà¨ Ï†ïÎ≥¥ ÏóÜÏùå') {
                return style;
            }

            return translateToKorean(style, 'speech_style');
        }

        // üîç Ï∫êÎ¶≠ÌÑ∞ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Î™®Îã¨ ÌëúÏãú Ìï®Ïàò
        function showCharacterDetail(characterId) {
            console.log('üë§ Ï∫êÎ¶≠ÌÑ∞ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Î™®Îã¨ Ïó¥Í∏∞:', characterId);

            // Î™®Îã¨Ïóê ÌòÑÏû¨ Ï∫êÎ¶≠ÌÑ∞ ID Ï†ÄÏû• (AI ÏÜåÍ∞ú ÏàòÏ†ï Í∏∞Îä•ÏùÑ ÏúÑÌï¥)
            const modal = document.getElementById('characterDetailModal');
            if (modal) {
                modal.dataset.characterId = characterId;
            }

            // üîß Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞Ïóê Îî∞Î•∏ Ï∫êÎ¶≠ÌÑ∞ Ï°∞Ìöå (v4.1.0 Íµ¨Ï°∞ ÏßÄÏõê)
            let character = null;
            if (characters && characters.characters) {
                character = characters.characters[characterId];
            } else if (characters && characters[characterId]) {
                character = characters[characterId];
            }

            if (!character) {
                console.error('‚ùå Ï∫êÎ¶≠ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§:', characterId);
                console.log('üîç Ï†ÑÏ≤¥ Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞:', characters);
                alert('Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }

            console.log('üìã Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞:', character);
            console.log('üîß Ïä§ÌÇ§Îßà Î≤ÑÏ†Ñ:', character.basic_info ? 'v2.0' : 'v1.0');

            // Î™®Îã¨ Ï†úÎ™© ÏÑ§Ï†ï
            const modalTitle = document.getElementById('characterDetailTitle');
            if (modalTitle) {
                modalTitle.textContent = `üë§ ${getCharacterName(character)} ÏÉÅÏÑ∏ Ï†ïÎ≥¥`;
            }

            // Í∏∞Î≥∏ Ï†ïÎ≥¥ Ï±ÑÏö∞Í∏∞
            fillCharacterDetailInfo(character);

            // ÌòÑÏû¨ Ìé∏Ïßë Ï§ëÏù∏ Ï∫êÎ¶≠ÌÑ∞ ID Ï†ÄÏû•
            window.currentDetailCharacterId = characterId;

            // Î™®Îã¨ ÌëúÏãú
            document.getElementById('characterDetailModal').style.display = 'block';
            console.log('‚úÖ Ï∫êÎ¶≠ÌÑ∞ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Î™®Îã¨ ÌëúÏãú ÏôÑÎ£å');
        }

        // üìù Ï∫êÎ¶≠ÌÑ∞ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Ï±ÑÏö∞Í∏∞ Ìï®Ïàò
        function fillCharacterDetailInfo(character) {
            console.log('üìù Ï∫êÎ¶≠ÌÑ∞ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Ï±ÑÏö∞Îäî Ï§ë...');

            // AI ÌîÑÎ°¨ÌîÑÌä∏ ÏÑπÏÖò (ÏµúÏÉÅÎã®)
            displayAIPromptInDetail(character);

            // Í∏∞Î≥∏ Ï†ïÎ≥¥ ÏÑπÏÖò
            safeSetTextContent('detailName', getCharacterName(character));
            safeSetTextContent('detailAge', getCharacterAge(character));
            safeSetTextContent('detailMbti', getCharacterMBTI(character));
            safeSetTextContent('detailGender', getCharacterGender(character));
            safeSetTextContent('detailOccupation', getCharacterOccupation(character));
            safeSetTextContent('detailRelationship', getCharacterRelationship(character));
            safeSetTextContent('detailEducation', getCharacterEducation(character));
            safeSetTextContent('detailLocation', getCharacterLocation(character));
            safeSetTextContent('detailPets', getCharacterPets(character));
            safeSetTextContent('detailBloodtype', getCharacterBloodtype(character));
            safeSetTextContent('detailFamilyStructure', getCharacterFamilyStructure(character));

            // Ïô∏Î™® Ï†ïÎ≥¥ ÏÑπÏÖò
            safeSetTextContent('detailHair', getCharacterHair(character));
            safeSetTextContent('detailEyes', getCharacterEyes(character));
            safeSetTextContent('detailBody', getCharacterBody(character));
            safeSetTextContent('detailBust', getCharacterBust(character));
            safeSetTextContent('detailWaistHip', getCharacterWaistHip(character));
            safeSetTextContent('detailStyle', getCharacterStyle(character));

            // ÏÑ±Í≤© Î∞è ÌäπÏÑ±
            safeSetTextContent('detailPersonality', getCharacterTraits(character));
            safeSetTextContent('detailHobbies', getCharacterHobbies(character));
            safeSetTextContent('detailValues', getCharacterValues(character));

            // ÎåÄÌôî Ïä§ÌÉÄÏùº
            safeSetTextContent('detailSpeechStyle', getCharacterSpeechStyle(character));
            safeSetTextContent('detailSpeechHabit', getCharacterSpeechHabit(character));

            // Î∞∞Í≤Ω Ï†ïÎ≥¥
            safeSetTextContent('detailFamily', getCharacterFamily(character));
            safeSetTextContent('detailHometown', getCharacterHometown(character));

            // Îß§Î†• ÌîÑÎ°úÌïÑ (v2.0+ Ïä§ÌÇ§Îßà ÌëúÏãú)
            const isV2Schema = character.basic_info || character.appeal_profile;
            const appealSection = document.getElementById('appealProfileSection');
            if (appealSection && isV2Schema) {
                // Í∏∞Î≥∏ Îß§Î†• ÌîÑÎ°úÌïÑ
                safeSetTextContent('detailSeductionStyle', getCharacterSeductionStyle(character));
                safeSetTextContent('detailCharmPoints', getCharacterCharmPoints(character));
                safeSetTextContent('detailEmotionalIntelligence', getCharacterEmotionalIntelligence(character));
                safeSetTextContent('detailConfidenceLevel', getCharacterConfidenceLevel(character));
                safeSetTextContent('detailMysteryFactor', getCharacterMysteryFactor(character));

                // v2.1 ÏÉà ÌïÑÎìúÎì§
                safeSetTextContent('detailSexualCuriosity', getCharacterSexualCuriosity(character));
                safeSetTextContent('detailSexualComfort', getCharacterSexualComfort(character));

                // Ïô∏Î™® Îß§Î†• v2.1
                safeSetTextContent('detailFeatureElements', getCharacterFeatureElements(character));
                safeSetTextContent('detailSensualHabits', getCharacterSensualHabits(character));
                safeSetTextContent('detailBodyLanguage', getCharacterBodyLanguage(character));

                // Ïã¨Î¶¨Ï†Å ÍπäÏù¥ v2.1
                safeSetTextContent('detailCoreDesires', getCharacterCoreDesires(character));
                safeSetTextContent('detailVulnerabilities', getCharacterVulnerabilities(character));
                safeSetTextContent('detailComfortLevel', getCharacterComfortLevel(character));
                safeSetTextContent('detailEscalationPace', getCharacterEscalationPace(character));
                safeSetTextContent('detailSexualToneBand', getCharacterSexualToneBand(character));
                safeSetTextContent('detailSexualFreedom', getCharacterSexualFreedom(character));

                // ÎåÄÌôîÏó≠Ìïô v2.1
                safeSetTextContent('detailFlirtingPatterns', getCharacterFlirtingPatterns(character));
                safeSetTextContent('detailHumorResponse', getCharacterHumorResponse(character));
                safeSetTextContent('detailComplimentResponse', getCharacterComplimentResponse(character));
                safeSetTextContent('detailInterestResponse', getCharacterInterestResponse(character));
                safeSetTextContent('detailConversationHooks', getCharacterConversationHooks(character));
                safeSetTextContent('detailSpeechStyleNew', getCharacterSpeechStyleNew(character));
                safeSetTextContent('detailSpeechHabits', getCharacterSpeechHabits(character));
                safeSetTextContent('detailVocabularyRegister', getCharacterVocabularyRegister(character));
                safeSetTextContent('detailAllowedMotifs', getCharacterAllowedMotifs(character));
                safeSetTextContent('detailForbiddenTerms', getCharacterForbiddenTerms(character));

                // Í≥ºÍ±∞ Ïù¥Î†• v2.1
                safeSetTextContent('detailBoyfriendCount', getCharacterBoyfriendCount(character));
                safeSetTextContent('detailPreferredSkinship', getCharacterPreferredSkinship(character));
                safeSetTextContent('detailRelationshipExperience', getCharacterRelationshipExperience(character));
                safeSetTextContent('detailFirstExperienceAge', getCharacterFirstExperienceAge(character));

                // üë® ÎÇ®Ïûê Ïö∞ÏÑ†ÏàúÏúÑ v2.1+
                safeSetTextContent('detailMalePriorities', getCharacterMalePriorities(character));
            }

            // ÏãúÏä§ÌÖú Ï†ïÎ≥¥
            safeSetTextContent('detailSchemaVersion', isV2Schema ? 'v2.0 (Í≥†Í∏â Ïä§ÌÇ§Îßà)' : 'v1.0 (Í∏∞Î≥∏ Ïä§ÌÇ§Îßà)');
            safeSetTextContent('detailCreatedDate', getCharacterCreatedDate(character));

            console.log('‚úÖ Ï∫êÎ¶≠ÌÑ∞ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Ï±ÑÏö∞Í∏∞ ÏôÑÎ£å');
        }

        // üîß ÏÉÅÏÑ∏ Ï†ïÎ≥¥Ïö© Ìó¨Ìçº Ìï®ÏàòÎì§
        function getCharacterAge(character) {
            const age = character.basic_info?.age || character.age;
            return age ? `${age}ÏÑ∏` : '-';
        }

        function getCharacterGender(character) {
            const gender = character.basic_info?.gender || character.gender;
            return gender === 'female' ? 'Ïó¨ÏÑ±' : gender === 'male' ? 'ÎÇ®ÏÑ±' : '-';
        }

        function getCharacterOccupation(character) {
            const occupation = character.basic_info?.occupation || character.occupation || character.major || '-';
            return occupation === '-' ? '-' : translateToKorean(occupation, 'occupation');
        }

        function getCharacterRelationship(character) {
            return character.relationship || '-';
        }

        function getCharacterHair(character) {
            const hair = character.physical_allure?.appearance?.hair || character.physical_allure?.hair || character.appearance?.hair || '-';
            return hair === '-' || hair === '' ? 'ÎØ∏ÏÑ§Ï†ï' : translateToKorean(hair, 'hair');
        }

        function getCharacterEyes(character) {
            const eyes = character.physical_allure?.appearance?.eyes || character.physical_allure?.eyes || character.appearance?.eyes || '-';
            return eyes === '-' || eyes === '' ? 'ÎØ∏ÏÑ§Ï†ï' : translateToKorean(eyes, 'eyes');
        }

        function getCharacterBody(character) {
            const body = character.physical_allure?.appearance?.body || character.physical_allure?.body || character.appearance?.body || '-';
            return body === '-' ? body : translateToKorean(body, 'body');
        }

        function getCharacterBust(character) {
            const bust = character.physical_allure?.appearance?.bust || character.physical_allure?.bust || character.appearance?.bust || '-';
            return bust === '-' ? bust : translateToKorean(bust, 'bust');
        }

        function getCharacterWaistHip(character) {
            const waistHip = character.physical_allure?.appearance?.waist_hip || character.physical_allure?.waist_hip || character.appearance?.waist_hip || '-';
            return waistHip === '-' ? waistHip : translateToKorean(waistHip, 'waist_hip');
        }

        function getCharacterStyle(character) {
            const style = character.physical_allure?.appearance?.style || character.physical_allure?.style || character.appearance?.style || '-';
            return style === '-' ? style : translateToKorean(style, 'style');
        }

        function getCharacterHobbies(character) {
            // ÏÉùÏÑ±Ìèº Í∏∞Ï§Ä: appeal_profile.hobbiesÎ•º Ïö∞ÏÑ†ÏúºÎ°ú ÌïòÎêò ÌïúÍµ≠Ïñ¥ Î≤àÏó≠ Ï†ÅÏö©
            const hobbies = character.appeal_profile?.hobbies || character.hobbies;
            if (Array.isArray(hobbies) && hobbies.length > 0) {
                return hobbies.map(hobby => translateToKorean(hobby, 'hobbies')).join(', ');
            }
            return '-';
        }

        function getCharacterValues(character) {
            return character.psychological_traits?.values || character.values || '-';
        }

        function getCharacterSpeechHabit(character) {
            return character.conversation_dynamics?.speech_habit || character.speech_habit || '-';
        }

        function getCharacterFamily(character) {
            return character.basic_info?.family_structure || character.family_structure || '-';
        }

        function getCharacterHometown(character) {
            const hometown = character.basic_info?.hometown || character.hometown;
            return hometown ? translateToKorean(hometown, 'location') : '-';
        }

        function getCharacterEducation(character) {
            const education = character.basic_info?.education || character.education;
            return education ? translateToKorean(education, 'education') : '-';
        }

        function getCharacterLocation(character) {
            const location = character.basic_info?.location || character.location;
            return location ? translateToKorean(location, 'location') : '-';
        }

        function getCharacterPets(character) {
            const pets = character.basic_info?.pets || character.pets;
            return pets ? translateToKorean(pets, 'pets') : '-';
        }

        function getCharacterBloodtype(character) {
            const bloodtype = character.basic_info?.bloodtype || character.bloodtype;
            return bloodtype ? translateToKorean(bloodtype, 'bloodtype') : '-';
        }

        function getCharacterFamilyStructure(character) {
            const familyStructure = character.basic_info?.family_structure || character.family_structure;
            return familyStructure ? translateToKorean(familyStructure, 'family_structure') : '-';
        }

        // üá∞üá∑ ÌïúÍ∏Ä Î≤àÏó≠ Îß§Ìïë Ìï®ÏàòÎì§
        function translateToKorean(value, category) {
            const translations = {
                seduction_style: {
                    'playful_confident': 'Ïû•ÎÇúÏä§ÎüΩÍ≥† ÏûêÏã†Í∞ê ÏûàÎäî',
                    'mysterious_elegant': 'Ïã†ÎπÑÎ°≠Í≥† Ïö∞ÏïÑÌïú',
                    'warm_nurturing': 'Îî∞ÎúªÌïòÍ≥† Ìè¨Ïö©Ï†ÅÏù∏',
                    'intellectually_stimulating': 'ÏßÄÏ†ÅÏúºÎ°ú ÏûêÍ∑πÏ†ÅÏù∏',
                    'innocent_charming': 'ÏàúÏàòÌïòÍ≥† Îß§Î†•Ï†ÅÏù∏',
                    'direct_passionate': 'ÏßÅÏÑ§Ï†ÅÏù¥Í≥† Ïó¥Ï†ïÏ†ÅÏù∏'
                },
                hair: {
                    'long_straight': 'ÏÑπÏãúÌïú Í∏¥ ÏÉùÎ®∏Î¶¨',
                    'shoulder_wave': 'Îß§ÌòπÏ†ÅÏù∏ Ïõ®Ïù¥Î∏å',
                    'short_bob': 'ÎèÑÎ∞úÏ†ÅÏù∏ Îã®Î∞ú',
                    'ponytail': 'Ïú†ÌòπÏ†ÅÏù∏ Ìè¨ÎãàÌÖåÏùº',
                    'curly_volume': 'Î≥ºÎ•® ÏûàÎäî Ïª¨',
                    'messy_sexy': 'ÏÑπÏãúÌïú Î¨¥Ï°∞Í±¥ Î®∏Î¶¨'
                },
                eyes: {
                    'seductive_eyes': 'Ïú†ÌòπÏ†ÅÏù∏ ÎààÎß§',
                    'almond_elegant': 'ÏïÑÎ™¨ÎìúÌòï Ïö∞ÏïÑÌïú',
                    'cat_like': 'Í≥†ÏñëÏù¥ Í∞ôÏùÄ',
                    'mysterious_deep': 'Ïã†ÎπÑÎ°úÏö¥ ÍπäÏùÄ Îàà',
                    'sultry_gaze': 'Í¥ÄÎä•Ï†ÅÏù∏ ÏãúÏÑ†'
                },
                body: {
                    'petite': 'ÏÜåÎÖÄ Í∞ôÏùÄ',
                    'petite_sexy': 'ÏÜåÎÖÄ Í∞ôÏßÄÎßå ÏÑπÏãúÌïú',
                    'average_height': 'Ï†ÅÎãπÌïú ÌÇ§Ïùò',
                    'average_attractive': 'Î≥¥ÌÜµ Îß§Î†•Ï†ÅÏù∏',
                    'tall_elegant': 'ÌÇ§ ÌÅ¨Í≥† Ïö∞ÏïÑÌïú',
                    'model_like': 'Î™®Îç∏ Í∞ôÏùÄ'
                },
                bust: {
                    'A': 'AÏªµ',
                    'B': 'BÏªµ',
                    'C': 'CÏªµ',
                    'D': 'DÏªµ',
                    'E': 'EÏªµ',
                    'F': 'FÏªµ',
                    // Í∏∞Ï°¥ Í∞íÎì§ÎèÑ Ìò∏ÌôòÏÑ±ÏùÑ ÏúÑÌï¥ Ïú†ÏßÄ
                    'small_cute': 'AÏªµ',
                    'medium_natural': 'BÏªµ',
                    'medium_balanced': 'BÏªµ',
                    'large_attractive': 'CÏªµ',
                    'full_attractive': 'CÏªµ',
                    'voluptuous': 'DÏªµ',
                    'glamorous': 'EÏªµ'
                },
                waist_hip: {
                    'Ïä¨Î¶º': 'Ïä¨Î¶º',
                    'Í∏ÄÎûòÎ®∏': 'Í∏ÄÎûòÎ®∏',
                    'Î™®ÎûòÏãúÍ≥Ñ': 'Î™®ÎûòÏãúÍ≥Ñ',
                    'Ïö¥ÎèôÏ≤¥Ìòï': 'Ïö¥ÎèôÏ≤¥Ìòï',
                    'ÌíçÎßå': 'ÌíçÎßå',
                    'Í∑†Ìòï': 'Í∑†Ìòï',
                    // Í∏∞Ï°¥ Í∞íÎì§ÎèÑ Ìò∏ÌôòÏÑ±ÏùÑ ÏúÑÌï¥ Ïú†ÏßÄ
                    'slim_tight': 'Ïä¨Î¶º',
                    'natural_curves': 'Í∑†Ìòï',
                    'soft_feminine': 'ÌíçÎßå',
                    'curvy_sexy': 'Í∏ÄÎûòÎ®∏',
                    'hourglass': 'Î™®ÎûòÏãúÍ≥Ñ',
                    'athletic': 'Ïö¥ÎèôÏ≤¥Ìòï',
                    'athletic_toned': 'Ïö¥ÎèôÏ≤¥Ìòï'
                },
                style: {
                    'ÏÑπÏãú': 'ÏÑπÏãú',
                    'Ïö∞ÏïÑ': 'Ïö∞ÏïÑ',
                    'Ï∫êÏ£ºÏñº': 'Ï∫êÏ£ºÏñº',
                    'ÌÅêÌä∏': 'ÌÅêÌä∏',
                    'ÎèÑÎ∞úÏ†Å': 'ÎèÑÎ∞úÏ†Å',
                    'ÌÅ¥ÎûòÏãù': 'ÌÅ¥ÎûòÏãù',
                    'Ìä∏Î†åÎîî': 'Ìä∏Î†åÎîî',
                    'Î≥¥Ìó§ÎØ∏Ïïà': 'Î≥¥Ìó§ÎØ∏Ïïà',
                    // Í∏∞Ï°¥ Í∞íÎì§ÎèÑ Ìò∏ÌôòÏÑ±ÏùÑ ÏúÑÌï¥ Ïú†ÏßÄ
                    'cute_casual': 'ÌÅêÌä∏',
                    'sexy_chic': 'ÏÑπÏãú',
                    'innocent_style': 'ÌÅêÌä∏',
                    'elegant_fashion': 'Ïö∞ÏïÑ',
                    'seductive_elegant': 'Ïö∞ÏïÑ',
                    'provocative_fashion': 'ÎèÑÎ∞úÏ†Å',
                    'casual_alluring': 'Ï∫êÏ£ºÏñº',
                    'sporty_style': 'Ï∫êÏ£ºÏñº',
                    'mature_sophisticated': 'ÌÅ¥ÎûòÏãù'
                },
                charm_points: {
                    'infectious_smile': 'Ï†ÑÏóºÏÑ± ÏûàÎäî ÎØ∏ÏÜå',
                    'gentle_touch': 'Î∂ÄÎìúÎü¨Ïö¥ ÌÑ∞Ïπò',
                    'confident_touch': 'ÏûêÏã†Í∞ê ÏûàÎäî ÌÑ∞Ïπò',
                    'expressive_eyes': 'ÌëúÌòÑÎ†• ÏûàÎäî ÎààÎπõ',
                    'witty_banter': 'Ïû¨Ïπò ÏûàÎäî ÎåÄÌôî',
                    'graceful_movements': 'Ïö∞ÏïÑÌïú Î™∏Ïßì',
                    'mysterious_aura': 'Ïã†ÎπÑÎ°úÏö¥ ÏïÑÏö∞Îùº',
                    'confident_gaze': 'ÏûêÏã†Í∞ê ÏûàÎäî ÏãúÏÑ†',
                    'intelligent_conversation': 'ÏßÄÏ†ÅÏù∏ ÎåÄÌôî',
                    'caring_gestures': 'Î∞∞Î†§Ïã¨ ÏûàÎäî Ï†úÏä§Ï≤ò',
                    'warm_smile': 'Îî∞ÎúªÌïú ÎØ∏ÏÜå',
                    'attentive_listening': 'ÏÑ∏Ïã¨Ìïú Í≤ΩÏ≤≠',
                    'confident_independence': 'ÏûêÏã†Í∞ê ÏûàÎäî ÎèÖÎ¶ΩÏÑ±',
                    'subtle_touches': 'ÏùÄÏùÄÌïú ÌÑ∞Ïπò',
                    'cool_demeanor': 'Ïø®Ìïú ÌÉúÎèÑ'
                },
                core_desires: {
                    'meaningful_connection': 'ÏùòÎØ∏ ÏûàÎäî Ïó∞Í≤∞',
                    'creative_expression': 'Ï∞ΩÏùòÏ†Å ÌëúÌòÑ',
                    'adventure_excitement': 'Î™®ÌóòÍ≥º Ìù•ÎØ∏',
                    'intellectual_stimulation': 'ÏßÄÏ†Å ÏûêÍ∑π',
                    'personal_growth': 'Í∞úÏù∏Ï†Å ÏÑ±Ïû•',
                    'helping_others': 'ÌÉÄÏù∏ ÎèïÍ∏∞',
                    'personal_freedom': 'Í∞úÏù∏Ï†Å ÏûêÏú†',
                    'practical_achievements': 'Ïã§Ïö©Ï†Å ÏÑ±Ï∑®'
                },
                speech_style: {
                    'sensual_whisper': 'Í¥ÄÎä•Ï†ÅÏù∏ ÏÜçÏÇ≠ÏûÑ',
                    'mature_elegant': 'ÏÑ±ÏàôÌïòÍ≥† Ïö∞ÏïÑÌïú',
                    'cute_innocent': 'Í∑ÄÏóΩÍ≥† ÏàúÏàòÌïú',
                    'sultry_dominant': 'ÏöîÏóºÌïòÍ≥† ÏßÄÎ∞∞Ï†ÅÏù∏',
                    'warm_friendly': 'Îî∞ÎúªÌïòÍ≥† ÏπúÍ∑ºÌïú',
                    'mysterious_seductive': 'Ïã†ÎπÑÎ°ùÍ≥† Ïú†ÌòπÏ†ÅÏù∏',
                    // üÜï 8Í∞ÄÏßÄ Ïú†ÌòπÏ†ÅÏù∏ ÎßêÌà¨ Ï∂îÍ∞Ä
                    'seductive_teasing': 'Ïú†ÌòπÏ†ÅÏù¥Í≥† Ïû•ÎÇúÏä§Îü¨Ïö¥',
                    'mysterious_alluring': 'Ïã†ÎπÑÎ°≠Í≥† Îß§ÌòπÏ†ÅÏù∏',
                    'playful_flirty': 'Î∞úÎûÑÌïòÍ≥† ÌîåÎü¨ÌåÖÌïòÎäî',
                    'intense_passionate': 'Í∞ïÎ†¨ÌïòÍ≥† Ïó¥Ï†ïÏ†ÅÏù∏',
                    'gentle_seductive': 'Î∂ÄÎìúÎüΩÍ≥† Ïú†ÌòπÏ†ÅÏù∏',
                    'confident_provocative': 'ÏûêÏã†Í∞ê ÏûàÍ≥† ÎèÑÎ∞úÏ†ÅÏù∏',
                    'sweet_tempting': 'Îã¨ÏΩ§ÌïòÍ≥† Ïú†ÌòπÏ†ÅÏù∏',
                    'bold_captivating': 'ÎåÄÎã¥ÌïòÍ≥† Îß§ÌòπÏ†ÅÏù∏'
                },
                comfort_level: {
                    'light_flirtation': 'Í∞ÄÎ≤ºÏö¥ ÌîåÎü¨ÌåÖ',
                    'moderate_flirtation': 'Ï†ÅÎãπÌïú ÌîåÎü¨ÌåÖ',
                    'intense_chemistry': 'Í∞ïÎ†¨Ìïú ÏºÄÎØ∏'
                },
                escalation_pace: {
                    'very_gradual': 'Îß§Ïö∞ Ï†êÏßÑÏ†Å',
                    'gradual_building': 'Ï†êÏßÑÏ†Å Î∞úÏ†Ñ',
                    'moderate_pace': 'Ï†ÅÎãπÌïú ÏÜçÎèÑ',
                    'quick_progression': 'Îπ†Î•∏ ÏßÑÏ†Ñ'
                },
                // üÜï Ï∑®ÎØ∏ Î≤àÏó≠
                hobbies: {
                    'reading': 'ÎèÖÏÑú',
                    'drawing': 'Í∑∏Î¶º Í∑∏Î¶¨Í∏∞',
                    'music': 'ÏùåÏïÖ Í∞êÏÉÅ',
                    'photography': 'ÏÇ¨ÏßÑ Ï¥¨ÏòÅ',
                    'cooking': 'ÏöîÎ¶¨',
                    'exercise': 'Ïö¥Îèô',
                    'travel': 'Ïó¨Ìñâ',
                    'movies': 'ÏòÅÌôî Í∞êÏÉÅ',
                    'gaming': 'Í≤åÏûÑ',
                    'dancing': 'ÎåÑÏä§',
                    'shopping': 'ÏáºÌïë',
                    'cafe': 'Ïπ¥Ìéò ÌÉêÎ∞©'
                },
                // üÜï Í∞ÄÏπòÍ¥Ä Î≤àÏó≠
                values: {
                    'love_family': 'Í∞ÄÏ°±Í≥º ÏÇ¨ÎûëÏùÑ Ï§ëÏãú',
                    'personal_growth': 'Í∞úÏù∏Ï†Å ÏÑ±Ïû•ÏùÑ Ï∂îÍµ¨',
                    'helping_others': 'ÌÉÄÏù∏ÏùÑ ÎèïÎäî Í≤ÉÏùÑ Ï¢ãÏïÑÌï®',
                    'creative_expression': 'Ï∞ΩÏùòÏ†Å ÌëúÌòÑÏùÑ Ï§ëÏãú',
                    'stability_security': 'ÏïàÏ†ïÍ≥º Î≥¥ÏïàÏùÑ Ï§ëÏãú'
                },
                // üÜï ÎåÄÌôîÏó≠Ìïô Î≤àÏó≠
                flirting_patterns: {
                    'subtle_teasing': 'ÏùÄÍ∑ºÌïú ÎÜÄÎ¶º',
                    'direct_compliments': 'ÏßÅÏ†ëÏ†ÅÏù∏ Ïπ≠Ï∞¨',
                    'playful_banter': 'Ïû•ÎÇúÏä§Îü¨Ïö¥ ÎÜçÎã¥',
                    'gentle_touches': 'Í∞ÄÎ≤ºÏö¥ Ïä§ÌÇ®Ïã≠',
                    'eye_contact': 'ÍπäÏùÄ ÎààÎßûÏ∂§',
                    'mysterious_hints': 'Ïã†ÎπÑÎ°úÏö¥ ÏïîÏãú'
                },
                humor_response: {
                    'giggles_easily': 'ÏâΩÍ≤å ÏõÉÏñ¥Ï§å',
                    'witty_comeback': 'Ïû¨ÏπòÏûàÍ≤å Î∞õÏïÑÏπ®',
                    'shy_smile': 'ÏàòÏ§çÍ≤å ÎØ∏ÏÜå',
                    'playful_tease': 'Ïû•ÎÇúÏä§ÎüΩÍ≤å ÎÜÄÎ¶º',
                    'dry_humor': 'Í±¥Ï°∞Ìïú Ïú†Î®∏Î°ú ÏùëÏàò'
                },
                compliment_response: {
                    'gracefully_accepts': 'Ïö∞ÏïÑÌïòÍ≤å Î∞õÏïÑÎì§ÏûÑ',
                    'bashfully_denies': 'Î∂ÄÎÅÑÎü¨ÏõåÌïòÎ©∞ Î∂ÄÏù∏',
                    'confidently_agrees': 'ÏûêÏã†ÏûàÍ≤å ÎèôÏùò',
                    'returns_compliment': 'Ïπ≠Ï∞¨ÏúºÎ°ú ÌôîÎãµ',
                    'changes_subject': 'ÌôîÏ†úÎ•º ÎèåÎ¶º'
                },
                interest_response: {
                    'enthusiastic_sharing': 'Ïó¥Ï†ïÏ†ÅÏúºÎ°ú Í≥µÏú†',
                    'curious_questions': 'Ìò∏Í∏∞Ïã¨ ÎßéÏùÄ ÏßàÎ¨∏',
                    'gentle_encouragement': 'Î∂ÄÎìúÎü¨Ïö¥ Í≤©Î†§',
                    'playful_challenge': 'Ïû•ÎÇúÏä§Îü¨Ïö¥ ÎèÑÏ†Ñ',
                    'thoughtful_listening': 'ÏÇ¨Î†§ÍπäÏùÄ Í≤ΩÏ≤≠'
                },
                conversation_hooks: {
                    'travel_stories': 'Ïó¨Ìñâ Ïù¥ÏïºÍ∏∞',
                    'food_culture': 'ÏùåÏãù Î¨∏Ìôî',
                    'music_movies': 'ÏùåÏïÖ/ÏòÅÌôî',
                    'life_philosophy': 'Ïù∏ÏÉù Ï≤†Ìïô',
                    'future_dreams': 'ÎØ∏Îûò Íøà',
                    'childhood_memories': 'Ïñ¥Î¶∞ ÏãúÏ†à',
                    'work_passion': 'ÏùºÍ≥º Ïó¥Ï†ï',
                    'relationships': 'Ïù∏Í∞ÑÍ¥ÄÍ≥Ñ'
                },
                vocabulary_register: {
                    'casual_friendly': 'Ï∫êÏ£ºÏñºÌïòÍ≥† ÏπúÍ∑ºÌï®',
                    'polite_formal': 'Ï†ïÏ§ëÌïòÍ≥† Í≤©ÏãùÏûàÏùå',
                    'intellectual': 'ÏßÄÏ†ÅÏù¥Í≥† ÏÑ∏Î†®Îê®',
                    'trendy_modern': 'Ìä∏Î†åÎîîÌïòÍ≥† ÌòÑÎåÄÏ†Å',
                    'warm_nurturing': 'Îî∞ÎúªÌïòÍ≥† Ìè¨Ïö©Ï†Å'
                },
                allowed_motifs: {
                    'romance_love': 'Î°úÎß®Ïä§/ÏÇ¨Îûë',
                    'dreams_goals': 'ÍøàÍ≥º Î™©Ìëú',
                    'personal_growth': 'Í∞úÏù∏Ï†Å ÏÑ±Ïû•',
                    'art_creativity': 'ÏòàÏà†Í≥º Ï∞ΩÏûë',
                    'nature_travel': 'ÏûêÏó∞Í≥º Ïó¨Ìñâ',
                    'friendship': 'Ïö∞Ï†ïÍ≥º Ïù∏Ïó∞',
                    'philosophy': 'Ï≤†ÌïôÏ†Å ÎåÄÌôî',
                    'daily_life': 'ÏùºÏÉÅ Ïù¥ÏïºÍ∏∞'
                },
                feature_elements: {
                    'beautiful_face': 'ÏïÑÎ¶ÑÎã§Ïö¥ ÏñºÍµ¥',
                    'seductive_eyes': 'Ïú†ÌòπÏ†ÅÏù∏ Îàà',
                    'sexy_lips': 'ÏÑπÏãúÌïú ÏûÖÏà†',
                    'elegant_neck': 'Ïö∞ÏïÑÌïú Î™©ÏÑ†',
                    'attractive_chest': 'Îß§Î†•Ï†ÅÏù∏ Í∞ÄÏä¥',
                    'slim_waist': 'ÏûòÎ°ùÌïú ÌóàÎ¶¨',
                    'curvy_hips': 'Í≥°ÏÑ†ÎØ∏ ÏûàÎäî ÏóâÎç©Ïù¥',
                    'long_legs': 'Í∏¥ Îã§Î¶¨',
                    'soft_skin': 'Î∂ÄÎìúÎü¨Ïö¥ ÌîºÎ∂Ä'
                },
                sensual_habits: {
                    'lip_biting': 'ÏûÖÏà† ÏÇ¥Ïßù Íπ®Î¨ºÍ∏∞',
                    'hair_touch': 'Î®∏Î¶¨Ïπ¥ÎùΩ ÎßåÏßÄÏûëÍ±∞Î¶¨Í∏∞',
                    'deep_gaze': 'ÍπäÏùÄ ÏãúÏÑ†ÏúºÎ°ú Î∞îÎùºÎ≥¥Í∏∞',
                    'shoulder_expose': 'Ïñ¥Íπ® ÏÇ¥Ïßù ÎìúÎü¨ÎÇ¥Í∏∞',
                    'crossed_legs': 'Îã§Î¶¨ Íº¨Í≥† ÏïâÍ∏∞',
                    'leaning_forward': 'Î™∏ ÏïûÏúºÎ°ú Í∏∞Ïö∏Ïù¥Í∏∞',
                    'subtle_wink': 'ÏùÄÍ∑ºÌïú ÏúôÌÅ¨',
                    'gentle_stretch': 'Î∂ÄÎìúÎü¨Ïö¥ Ïä§Ìä∏Î†àÏπ≠',
                    'playful_smile': 'Ïû•ÎÇúÏä§Îü¨Ïö¥ ÎØ∏ÏÜå'
                },
                // üéÅ Ï¢ãÏïÑÌïòÎäî ÏÑ†Î¨º Î≤àÏó≠
                favorite_gifts: {
                    'luxury_lingerie': 'üíé Í≥†Í∏â ÏÜçÏò∑ (50ÎßåÏõê~)',
                    'expensive_car': 'üöó Í≥†Í∏â ÏûêÎèôÏ∞® (5Ï≤úÎßåÏõê~)',
                    'jewelry': 'üíç Î≥¥ÏÑùÎ•ò (100ÎßåÏõê~)',
                    'perfume': 'üåπ Ìñ•Ïàò (10ÎßåÏõê~)',
                    'designer_bag': 'üëú Î™ÖÌíà Í∞ÄÎ∞© (200ÎßåÏõê~)',
                    'flowers': 'üå∏ ÍΩÉÎã§Î∞ú (3ÎßåÏõê~)',
                    'chocolate': 'üç´ Í≥†Í∏â Ï¥àÏΩúÎ¶ø (5ÎßåÏõê~)',
                    'spa_voucher': 'üßñ‚Äç‚ôÄÔ∏è Ïä§Ìåå Ïù¥Ïö©Í∂å (20ÎßåÏõê~)',
                    'wine': 'üç∑ Í≥†Í∏â ÏôÄÏù∏ (15ÎßåÏõê~)',
                    'books': 'üìö Ï¢ãÏïÑÌïòÎäî Ï±Ö (2ÎßåÏõê~)',
                    'cute_accessories': 'üéÄ Í∑ÄÏó¨Ïö¥ Ïï°ÏÑ∏ÏÑúÎ¶¨ (5ÎßåÏõê~)',
                    'travel_package': '‚úàÔ∏è Ïó¨Ìñâ Ìå®ÌÇ§ÏßÄ (500ÎßåÏõê~)'
                },
                // üéà Ï∑®ÎØ∏ Î≤àÏó≠
                hobbies: {
                    'music': 'ÏùåÏïÖ',
                    'dancing': 'ÎåìÏä§',
                    'reading': 'ÎèÖÏÑú',
                    'movies': 'ÏòÅÌôî Í∞êÏÉÅ',
                    'cooking': 'ÏöîÎ¶¨',
                    'travel': 'Ïó¨Ìñâ',
                    'art': 'ÏòàÏà†',
                    'fitness': 'ÌîºÌä∏ÎãàÏä§',
                    'photography': 'ÏÇ¨ÏßÑÏ¥¨ÏòÅ',
                    'shopping': 'ÏáºÌïë',
                    'yoga': 'ÏöîÍ∞Ä',
                    'swimming': 'ÏàòÏòÅ',
                    'gaming': 'Í≤åÏûÑ'
                },
                // üíº ÏßÅÏóÖ Î≤àÏó≠
                occupation: {
                    'student': 'ÎåÄÌïôÏÉù',
                    'office_worker': 'ÌöåÏÇ¨Ïõê',
                    'designer': 'ÎîîÏûêÏù¥ÎÑà',
                    'nurse': 'Í∞ÑÌò∏ÏÇ¨',
                    'housewife': 'Ï£ºÎ∂Ä',
                    'celebrity': 'Ïó∞ÏòàÏù∏',
                    'secretary': 'ÎπÑÏÑú',
                    'instructor': 'ÍµêÏÇ¨',
                    'youtuber': 'Ïú†ÌäúÎ≤Ñ',
                    'artist': 'ÏòàÏà†Í∞Ä',
                    'journalist': 'Í∏∞Ïûê',
                    'unemployed': 'Î∞±Ïàò',
                    'flight_attendant': 'ÏäπÎ¨¥Ïõê',
                    'pharmacist': 'ÏïΩÏÇ¨',
                    'chef': 'ÏöîÎ¶¨ÏÇ¨',
                    'banker': 'ÏùÄÌñâÏõê',
                    'marketing': 'ÎßàÏºÄÌÑ∞',
                    'entrepreneur': 'ÏÇ¨ÏóÖÍ∞Ä'
                },
                // üí¨ ÎåÄÌôî ÌõÖ Î≤àÏó≠
                conversation_hooks: {
                    'work_passion': 'ÏùºÏóê ÎåÄÌïú Ïó¥Ï†ï',
                    'relationships': 'Ïù∏Í∞ÑÍ¥ÄÍ≥Ñ',
                    'dreams_goals': 'ÍøàÍ≥º Î™©Ìëú',
                    'personal_stories': 'Í∞úÏù∏Ï†ÅÏù∏ Ïù¥ÏïºÍ∏∞',
                    'hobbies_interests': 'Ï∑®ÎØ∏ÏôÄ Í¥ÄÏã¨ÏÇ¨',
                    'life_philosophy': 'Ïù∏ÏÉù Ï≤†Ìïô',
                    'food_culture': 'ÏùåÏãùÍ≥º Î¨∏Ìôî',
                    'future_dreams': 'ÎØ∏Îûò Íøà'
                },
                // üíñ ÌîåÎü¨ÌåÖ Ìå®ÌÑ¥ Î≤àÏó≠
                flirting_patterns: {
                    'subtle_teasing': 'ÏùÄÍ∑ºÌïú Ïû•ÎÇú',
                    'compliment_giving': 'Ïπ≠Ï∞¨ÌïòÍ∏∞',
                    'physical_proximity': 'Î¨ºÎ¶¨Ï†Å Í∑ºÏ†ë',
                    'playful_banter': 'Ïû•ÎÇúÏä§Îü¨Ïö¥ ÎåÄÌôî',
                    'eye_contact': 'ÏïÑÏù¥ Ïª®ÌÉùÌä∏',
                    'gentle_touch': 'Î∂ÄÎìúÎü¨Ïö¥ ÌÑ∞Ïπò',
                    'gentle_touches': 'Î∂ÄÎìúÎü¨Ïö¥ ÌÑ∞ÏπòÎì§'
                },
                // üòä Î∞òÏùë ÏÑ±Ìñ• Î≤àÏó≠
                humor: {
                    'giggles_easily': 'Ïûò ÏõÉÎäî',
                    'witty_responses': 'Ïû¨Ïπò ÏûàÎäî ÎåÄÎãµ',
                    'playful_teasing': 'Ïû•ÎÇúÏä§Îü¨Ïö¥ ÎÜìÏûÑ'
                },
                compliment: {
                    'gracefully_accepts': 'Ïö∞ÏïÑÌïòÍ≤å Î∞õÏïÑÎì§Ïù¥Îäî',
                    'shy_response': 'ÏàòÏ§ÑÏñ¥ÌïòÎäî',
                    'confident_response': 'ÏûêÏã†Í∞ê ÏûàÍ≤å Î∞õÎäî'
                },
                interest_expression: {
                    'enthusiastic_sharing': 'Ïó¥Ï†ïÏ†ÅÏù∏ Í≥µÏú†',
                    'curious_questioning': 'Ìò∏Í∏∞Ïã¨ ÎßéÏùÄ ÏßàÎ¨∏',
                    'attentive_listening': 'Ï£ºÏùò ÍπäÏùÄ Í≤ΩÏ≤≠'
                },
                // üë§ Í¥ÄÍ≥Ñ Í≤ΩÌóò Î≤àÏó≠
                relationship_experience: {
                    'beginner': 'Ï¥àÎ≥¥Ïûê',
                    'intermediate': 'Ï§ëÍ∏âÏûê',
                    'experienced': 'Í≤ΩÌóòÏûê',
                    'expert': 'Ï†ÑÎ¨∏Í∞Ä'
                },
                // üë∂ Ï≤´ Í≤ΩÌóò Ïó∞Î†π Î≤àÏó≠
                first_experience_age: {
                    'early_teens': 'Ïñ¥Î¶∞ ÏãúÏ†à',
                    'mid_teens': 'Ï§ëÍ≥†Îì±ÌïôÍµê ÏãúÏ†à',
                    'late_teens': 'Í≥†Îì±ÌïôÍµê Îßê',
                    'early_twenties': 'ÎåÄÌïôÍµê Ï¥àÎ∞ò',
                    'mid_twenties': 'ÎåÄÌïôÍµê ÌõÑÎ∞ò',
                    'late_twenties': 'Ïù¥Ïã≠ÎåÄ ÌõÑÎ∞ò'
                },
                // ü§ó ÏÑ†Ìò∏ÌïòÎäî Ïä§ÌÇ®Ïã≠ Î≤àÏó≠
                preferred_skinship: {
                    'light_hugs': 'Í∞ÄÎ≤ºÏö¥ Ìè¨Ïòπ',
                    'hand_holding': 'ÏÜê Ïû°Í∏∞',
                    'shoulder_massage': 'Ïñ¥Íπ® ÎßàÏÇ¨ÏßÄ',
                    'passionate_kiss': 'Ïó¥Ï†ïÏ†ÅÏù∏ ÌÇ§Ïä§',
                    'gentle_touch': 'Î∂ÄÎìúÎü¨Ïö¥ ÌÑ∞Ïπò',
                    'warm_embrace': 'Îî∞ÎúªÌïú Ìè¨Ïòπ',
                    'playful_tickling': 'Ïû•ÎÇúÏä§Îü¨Ïö¥ Í∞ÑÏßÄÎüΩÌûàÍ∏∞',
                    'cuddling': 'Î™®ÎìúÍ∏∞',
                    'head_patting': 'Î®∏Î¶¨ Ïì∞Îã§Îì¨Í∏∞',
                    'intimate_cuddling': 'ÏπúÎ∞ÄÌïú Î™®ÎìúÍ∏∞'
                },
                // üó£Ô∏è Ïñ¥Ìúò ÏàòÏ§Ä Î≤àÏó≠
                vocabulary_register: {
                    'casual_friendly': 'Ï∫êÏ£ºÏñºÌïòÍ≥† ÏπúÍ∑ºÌïú',
                    'polite_formal': 'Ï†ïÏ§ëÌïòÍ≥† Í≤©ÏãùÏ†ÅÏù∏',
                    'intimate_personal': 'ÏπúÎ∞ÄÌïòÍ≥† Í∞úÏù∏Ï†ÅÏù∏',
                    'playful_casual': 'Ïû•ÎÇúÏä§ÎüΩÍ≥† ÏûêÏó∞Ïä§Îü¨Ïö¥'
                },
                // üí™ Í∞ÄÏπòÍ¥Ä Î≤àÏó≠
                values: {
                    'love_family': 'ÏÇ¨ÎûëÍ≥º Í∞ÄÏ°±',
                    'career_success': 'Í≤ΩÎ†•Í≥º ÏÑ±Í≥µ',
                    'personal_growth': 'Í∞úÏù∏Ï†Å ÏÑ±Ïû•',
                    'adventure_freedom': 'Î™®ÌóòÍ≥º ÏûêÏú†',
                    'stability_security': 'ÏïàÏ†ïÍ≥º Î≥¥Ïïà'
                },
                // üó£Ô∏è ÎßêÌà¨ ÏäµÍ¥Ä Î≤àÏó≠ ÏÉàÎ°ú Ï∂îÍ∞Ä
                speech_habits: {
                    'slow_speech': 'ÎäêÎ¶∞ ÎßêÌà¨',
                    'giggle_often': 'ÏûêÏ£º ÏõÉÎäî',
                    'polite_ending': 'Ï†ïÏ§ëÌïú Ïñ¥ÎØ∏ (~ÎÑ§Ïöî, ~Ïöî)',
                    'cute_ending': 'Í∑ÄÏó¨Ïö¥ Ïñ¥ÎØ∏ (~Îãπ, ~ÏßÄ)',
                    'question_ending': 'ÏßàÎ¨∏Ìòï Ïñ¥ÎØ∏ (~Ï£†?, ~ÎÑ§Ïöî?)',
                    'soft_tone': 'Î∂ÄÎìúÎü¨Ïö¥ ÏñµÏñë',
                    'playful_tone': 'Ïû•ÎÇúÏä§Îü¨Ïö¥ ÏñµÏñë',
                    'emotional_expression': 'Í∞êÏ†ïÏ†Å ÌëúÌòÑ',
                    'detailed_description': 'ÏÉÅÏÑ∏Ìïú Î¨òÏÇ¨'
                },
                // üíï Ìù•Î∂ÑÏãú Î∞òÏùë Î≤àÏó≠ ÏÉàÎ°ú Ï∂îÍ∞Ä
                body_language: {
                    'ÏñºÍµ¥Î∞úÍ∑∏Î†àÏßê': 'ÏñºÍµ¥Î∞úÍ∑∏Î†àÏßê',
                    'Ïà®ÏÜåÎ¶¨Í±∞Ïπ†Ïñ¥Ïßê': 'Ïà®ÏÜåÎ¶¨Í±∞Ïπ†Ïñ¥Ïßê',
                    'ÎààÎèôÏûêÌùîÎì§Î¶º': 'ÎààÎèôÏûêÌùîÎì§Î¶º',
                    'ÏûÖÏà†Î∂ÄÎ•¥Î•¥': 'ÏûÖÏà†Î∂ÄÎ•¥Î•¥',
                    'Î™∏Îñ®Î¶º': 'Î™∏Îñ®Î¶º',
                    'Î™©ÏÜåÎ¶¨Îñ®Î¶º': 'Î™©ÏÜåÎ¶¨Îñ®Î¶º',
                    'Ïã¨Ïû•ÎëêÍ∑ºÍ±∞Î¶º': 'Ïã¨Ïû•ÎëêÍ∑ºÍ±∞Î¶º',
                    'ÏÜêÎÅùÎñ®Î¶º': 'ÏÜêÎÅùÎñ®Î¶º',
                    'ÏãúÏÑ†ÌîºÌï®': 'ÏãúÏÑ†ÌîºÌï®',
                    // Í∏∞Ï°¥ Í∞íÎì§ÎèÑ Ìò∏ÌôòÏÑ±ÏùÑ ÏúÑÌï¥ Ïú†ÏßÄ
                    'playful_movements': 'ÏñºÍµ¥Î∞úÍ∑∏Î†àÏßê',
                    'gentle_gestures': 'Ïà®ÏÜåÎ¶¨Í±∞Ïπ†Ïñ¥Ïßê',
                    'expressive_hands': 'ÎààÎèôÏûêÌùîÎì§Î¶º',
                    'graceful_posture': 'Î™∏Îñ®Î¶º',
                    'confident_stance': 'Î™©ÏÜåÎ¶¨Îñ®Î¶º',
                    'seductive_lean': 'Ïã¨Ïû•ÎëêÍ∑ºÍ±∞Î¶º',
                    'nervous_fidget': 'ÏÜêÎÅùÎñ®Î¶º',
                    'animated_talking': 'ÏãúÏÑ†ÌîºÌï®',
                    'subtle_mirroring': 'ÏñºÍµ¥Î∞úÍ∑∏Î†àÏßê'
                },
                // üíÉ ÏÑπÏãúÌè¨Ï¶à Î≤àÏó≠ ÏÉàÎ°ú Ï∂îÍ∞Ä
                sensual_habits: {
                    'ÏûÖÏà†Íπ®Î¨ºÍ∏∞': 'ÏûÖÏà†Íπ®Î¨ºÍ∏∞',
                    'ÌóàÎ¶¨ÍµΩÌûàÍ∏∞': 'ÌóàÎ¶¨ÍµΩÌûàÍ∏∞',
                    'Îã§Î¶¨Íº¨Í∏∞': 'Îã§Î¶¨Íº¨Í∏∞',
                    'Ïñ¥Íπ®ÎìúÎü¨ÎÇ¥Í∏∞': 'Ïñ¥Íπ®ÎìúÎü¨ÎÇ¥Í∏∞',
                    'Î™∏Í∏∞Ïö∏Ïù¥Í∏∞': 'Î™∏Í∏∞Ïö∏Ïù¥Í∏∞',
                    'ÏúôÌÅ¨ÌïòÍ∏∞': 'ÏúôÌÅ¨ÌïòÍ∏∞',
                    'Ïä§Ìä∏Î†àÏπ≠': 'Ïä§Ìä∏Î†àÏπ≠',
                    'Ìó§Ïñ¥ÌÑ∞Ïπò': 'Ìó§Ïñ¥ÌÑ∞Ïπò',
                    'Ïú†ÌòπÏ†ÅÏãúÏÑ†': 'Ïú†ÌòπÏ†ÅÏãúÏÑ†',
                    // Í∏∞Ï°¥ Í∞íÎì§ÎèÑ Ìò∏ÌôòÏÑ±ÏùÑ ÏúÑÌï¥ Ïú†ÏßÄ
                    'lip_biting': 'ÏûÖÏà†Íπ®Î¨ºÍ∏∞',
                    'hair_touch': 'Ìó§Ïñ¥ÌÑ∞Ïπò',
                    'deep_gaze': 'Ïú†ÌòπÏ†ÅÏãúÏÑ†',
                    'shoulder_expose': 'Ïñ¥Íπ®ÎìúÎü¨ÎÇ¥Í∏∞',
                    'crossed_legs': 'Îã§Î¶¨Íº¨Í∏∞',
                    'leaning_forward': 'Î™∏Í∏∞Ïö∏Ïù¥Í∏∞',
                    'subtle_wink': 'ÏúôÌÅ¨ÌïòÍ∏∞',
                    'gentle_stretch': 'Ïä§Ìä∏Î†àÏπ≠',
                    'playful_smile': 'ÏûÖÏà†Íπ®Î¨ºÍ∏∞'
                },
                // üö´ Í∏àÏßÄ Ïö©Ïñ¥ Î≤àÏó≠ ÏÉàÎ°ú Ï∂îÍ∞Ä
                forbidden_terms: {
                    'religion': 'Ï¢ÖÍµê',
                    'work_stress': 'ÏóÖÎ¨¥ Ïä§Ìä∏Î†àÏä§',
                    'politics': 'Ï†ïÏπò',
                    'military': 'Íµ∞ÎåÄ',
                    'sports': 'Ïä§Ìè¨Ï∏†',
                    'business_investment': 'ÏÇ¨ÏóÖ/Ìà¨Ïûê',
                    'health_medical': 'Í±¥Í∞ï/ÏùòÎ£å',
                    'personal_past': 'Í∞úÏù∏Ï†Å Í≥ºÍ±∞',
                    'family_issues': 'Í∞ÄÏ°± Î¨∏Ï†ú'
                },
                // üë® ÎÇ®ÏûêÎ•º Î≥º Îïå ÏµúÏö∞ÏÑ†ÏãúÌïòÎäî Í≤É Î≤àÏó≠
                male_priorities: {
                    'appearance': 'üòç Ïô∏Î™®ÏôÄ Ï≤¥Ìòï',
                    'personality': 'üòä ÏÑ±Í≤©Í≥º Ïù∏ÏÑ±',
                    'intelligence': 'üß† ÏßÄÏÑ±Í≥º ÍµêÏñë',
                    'humor': 'üòÇ Ïú†Î®∏ÏôÄ Ïû¨Ïπò',
                    'financial_stability': 'üí∞ Í≤ΩÏ†úÎ†•Í≥º ÏïàÏ†ïÏÑ±',
                    'emotional_maturity': 'ü•∞ Í∞êÏ†ïÏ†Å ÏÑ±ÏàôÌï®',
                    'ambition': 'üéÜ Ïó¥Ï†ïÍ≥º Î™©ÌëúÏùòÏãù',
                    'communication': 'üí¨ ÏÜåÌÜµÎä•Î†•Í≥º Í≤ΩÏ≤≠',
                    'reliability': 'ü§ù Ïã†Î¢∞ÏÑ±Í≥º ÏÑ±Ïã§Ìï®'
                },
                // üß† Ïã¨Î¶¨Ï†Å Ï∑®ÏïΩÏ†ê Î≤àÏó≠
                vulnerabilities: {
                    'perfectionism': 'ÏôÑÎ≤ΩÏ£ºÏùò',
                    'commitment_fear': 'ÌóåÏã†Ïóê ÎåÄÌïú ÎëêÎ†§ÏõÄ',
                    'abandonment_fear': 'Î≤ÑÎ¶ºÎ∞õÏùÑ ÎëêÎ†§ÏõÄ',
                    'intimacy_anxiety': 'ÏπúÎ∞ÄÍ∞êÏóê ÎåÄÌïú Î∂àÏïà',
                    'self_doubt': 'ÏûêÍ∏∞ ÏùòÏã¨',
                    'emotional_walls': 'Í∞êÏ†ïÏ†Å Î≤Ω',
                    'trust_issues': 'Ïã†Î¢∞ Î¨∏Ï†ú',
                    'validation_seeking': 'Ïù∏Ï†ïÎ∞õÍ≥† Ïã∂ÏùÄ ÏöïÍµ¨'
                },
                // üî• ÏÑ±Ï†Å ÌÜ§ Î∞¥Îìú Î≤àÏó≠
                sexual_tone_band: {
                    'conservative': 'Î≥¥ÏàòÏ†Å',
                    'moderate': 'Ï§ëÍ∞Ñ Ï†ïÎèÑ',
                    'open': 'Í∞úÎ∞©Ï†Å',
                    'adventurous': 'Î™®ÌóòÏ†Å'
                },
                // üéÜ ÏûêÏÇ∞ Î™©Ìëú Î≤àÏó≠
                asset_goal: {
                    '1_billion': '1Ïñµ Ïõê (Ï£ºÌÉù ÎßàÎ†®)',
                    '3_billion': '3Ïñµ Ïõê (Ï†ÑÏÑ∏ ÏóÜÏù¥ ÎÇ¥ Ïßë)',
                    '5_billion': '5Ïñµ Ïõê (ÎïÖ ÏûàÎäî Ïßë)',
                    '10_billion': '10Ïñµ Ïõê (ÎπåÎî© Ìïú Ï∏µ)',
                    '30_billion': '30Ïñµ Ïõê (Í±¥Î¨º Ï†ÑÏ≤¥)',
                    '50_billion': '50Ïñµ Ïõê (Ïó¨Îü¨ Í±¥Î¨º)',
                    '100_billion': '100Ïñµ Ïõê (ÎåÄÍ∏∞ÏóÖ Í∑úÎ™®)'
                },
                // üè¢ ÌòÑÏû¨ ÏßÅÏóÖ Î≤àÏó≠
                occupation: {
                    'student': 'ÎåÄÌïôÏÉù',
                    'office_worker': 'ÌöåÏÇ¨Ïõê',
                    'designer': 'ÎîîÏûêÏù¥ÎÑà',
                    'nurse': 'Í∞ÑÌò∏ÏÇ¨',
                    'housewife': 'Ï£ºÎ∂Ä',
                    'celebrity': 'Ïó∞ÏòàÏù∏',
                    'secretary': 'ÎπÑÏÑú',
                    'instructor': 'ÍµêÏÇ¨',
                    'youtuber': 'Ïú†ÌäúÎ≤Ñ',
                    'artist': 'ÏòàÏà†Í∞Ä',
                    'journalist': 'Í∏∞Ïûê',
                    'unemployed': 'Î∞±Ïàò',
                    'flight_attendant': 'ÏäπÎ¨¥Ïõê',
                    'pharmacist': 'ÏïΩÏÇ¨',
                    'chef': 'ÏöîÎ¶¨ÏÇ¨',
                    'banker': 'ÏùÄÌñâÏõê',
                    'marketing': 'ÎßàÏºÄÌÑ∞',
                    'entrepreneur': 'ÏÇ¨ÏóÖÍ∞Ä'
                },

                // üéÜ ÎØ∏Îûò ÏßÅÏóÖ Î≤àÏó≠
                future_careers: {
                    'housewife': 'Ï†ÑÏóÖÏ£ºÎ∂Ä',
                    'freelancer': 'ÌîÑÎ¶¨ÎûúÏÑú',
                    'celebrity': 'Ïó∞ÏòàÏù∏',
                    'secretary': 'ÎπÑÏÑú',
                    'instructor': 'ÍµêÏÇ¨',
                    'youtuber': 'Ïú†ÌäúÎ≤Ñ',
                    'cafe_owner': 'Ïπ¥Ìéò ÏÇ¨Ïû•',
                    'restaurant_owner': 'ÏãùÎãπ Ïö¥ÏòÅ',
                    'designer': 'ÎîîÏûêÏù¥ÎÑà',
                    'influencer': 'Ïù∏ÌîåÎ£®Ïñ∏ÏÑú',
                    'entrepreneur': 'Ï∞ΩÏóÖÍ∞Ä',
                    'artist': 'ÏòàÏà†Í∞Ä',
                    'consultant': 'Ïª®ÏÑ§ÌÑ¥Ìä∏',
                    'beauty_business': 'ÎØ∏Ïö© ÏÇ¨ÏóÖ',
                    'unemployed': 'Î∞±Ïàò(Ïö¥ÎèôÍ∂å)'
                },
                // üéì ÌïôÎ†• Î≤àÏó≠
                education: {
                    'high_school': 'Í≥†Îì±ÌïôÍµê Ï°∏ÏóÖ',
                    'college_dropout': 'ÎåÄÌïôÍµê Ï§ëÌá¥',
                    'college_graduate': 'ÎåÄÌïôÍµê Ï°∏ÏóÖ',
                    'masters': 'ÏÑùÏÇ¨ Ï°∏ÏóÖ',
                    'phd': 'Î∞ïÏÇ¨ Ï°∏ÏóÖ',
                    'technical_school': 'Ï†ÑÎ¨∏ÌïôÍµê Ï°∏ÏóÖ',
                    'art_school': 'ÏòàÏà†ÎåÄÌïô Ï°∏ÏóÖ'
                },
                // üèôÔ∏è Í±∞Ï£ºÏßÄÏó≠ Î≤àÏó≠
                location: {
                    'seoul': 'ÏÑúÏö∏',
                    'busan': 'Î∂ÄÏÇ∞',
                    'daegu': 'ÎåÄÍµ¨',
                    'incheon': 'Ïù∏Ï≤ú',
                    'gwangju': 'Í¥ëÏ£º',
                    'daejeon': 'ÎåÄÏ†Ñ',
                    'ulsan': 'Ïö∏ÏÇ∞',
                    'gyeonggi': 'Í≤ΩÍ∏∞ÎèÑ',
                    'gangwon': 'Í∞ïÏõêÎèÑ',
                    'jeju': 'Ï†úÏ£ºÎèÑ',
                    'gangnam': 'Í∞ïÎÇ®Íµ¨',
                    'hongdae': 'ÌôçÎåÄ',
                    'itaewon': 'Ïù¥ÌÉúÏõê'
                },
                // üêæ Î∞òÎ†§ÎèôÎ¨º Î≤àÏó≠
                pets: {
                    'none': 'ÏóÜÏùå',
                    'dog': 'Í∞ïÏïÑÏßÄ',
                    'cat': 'Í≥†ÏñëÏù¥',
                    'bird': 'ÏÉà',
                    'fish': 'Î¨ºÍ≥†Í∏∞',
                    'hamster': 'ÌñÑÏä§ÌÑ∞',
                    'rabbit': 'ÌÜ†ÎÅº',
                    'reptile': 'ÌååÏ∂©Î•ò'
                },
                // üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Í∞ÄÏ°±Íµ¨ÏÑ± Î≤àÏó≠
                family_structure: {
                    'nuclear_family': 'ÌïµÍ∞ÄÏ°±',
                    'extended_family': 'ÎåÄÍ∞ÄÏ°±',
                    'single_parent': 'ÌïúÎ∂ÄÎ™® Í∞ÄÏ†ï',
                    'single_child': 'Ïô∏Îèô',
                    'large_family': 'ÎåÄÍ∞ÄÏ°±',
                    'adoptive_family': 'ÏûÖÏñë Í∞ÄÏ†ï'
                },
                // ü©∏ ÌòàÏï°Ìòï Î≤àÏó≠
                bloodtype: {
                    'A': 'AÌòï',
                    'B': 'BÌòï',
                    'AB': 'ABÌòï',
                    'O': 'OÌòï'
                }
            };

            if (translations[category] && translations[category][value]) {
                return translations[category][value];
            }

            // unknown Í∞íÏóê ÎåÄÌïú Ï≤òÎ¶¨
            if (value === 'unknown' || value === '' || !value) {
                return 'Ï†ïÎ≥¥ ÏóÜÏùå';
            }

            // Î≤àÏó≠Ïù¥ ÏóÜÎäî Í≤ΩÏö∞ ÏòÅÏñ¥Î•º ÌïúÍ∏ÄÎ°ú Î≥ÄÌôò ÏãúÎèÑ
            return convertEnglishToKorean(value);
        }

        // üîÑ ÏòÅÏñ¥Î•º ÌïúÍ∏ÄÎ°ú Î≥ÄÌôòÌïòÎäî Î≥¥Ï°∞ Ìï®Ïàò
        function convertEnglishToKorean(englishValue) {
            if (!englishValue || typeof englishValue !== 'string') {
                return 'Ï†ïÎ≥¥ ÏóÜÏùå';
            }

            // Ïñ∏ÎçîÏä§ÏΩîÏñ¥Î•º Í≥µÎ∞±ÏúºÎ°ú Î≥ÄÌôòÌïòÍ≥† Í∞Å Îã®Ïñ¥Ïùò Ï≤´ Í∏ÄÏûê ÎåÄÎ¨∏ÏûêÌôî
            const formatted = englishValue
                .replace(/_/g, ' ')
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ');

            // ÏùºÎ∞òÏ†ÅÏù∏ ÏòÅÏñ¥ Îã®Ïñ¥ Î≤àÏó≠
            const commonTranslations = {
                'High': 'ÎÜíÏùå',
                'Medium': 'Î≥¥ÌÜµ',
                'Low': 'ÎÇÆÏùå',
                'Very High': 'Îß§Ïö∞ ÎÜíÏùå',
                'Very Low': 'Îß§Ïö∞ ÎÇÆÏùå',
                'Strong': 'Í∞ïÌï®',
                'Weak': 'ÏïΩÌï®',
                'Average': 'ÌèâÍ∑†',
                'Excellent': 'Ïö∞Ïàò',
                'Good': 'Ï¢ãÏùå',
                'Poor': 'Î∂ÄÏ°±',
                'Active': 'ÌôúÎ∞úÌï®',
                'Passive': 'ÏÜåÍ∑πÏ†Å',
                'Confident': 'ÏûêÏã†Í∞ê',
                'Shy': 'ÏàòÏ§çÏùå',
                'Outgoing': 'Ïô∏Ìñ•Ï†Å',
                'Introverted': 'ÎÇ¥Ìñ•Ï†Å',
                'Creative': 'Ï∞ΩÏùòÏ†Å',
                'Logical': 'ÎÖºÎ¶¨Ï†Å',
                'Emotional': 'Í∞êÏ†ïÏ†Å',
                'Practical': 'Ïã§Ïö©Ï†Å',
                'Artistic': 'ÏòàÏà†Ï†Å',
                'Academic': 'ÌïôÎ¨∏Ï†Å',
                'Social': 'ÏÇ¨ÍµêÏ†Å',
                'Independent': 'ÎèÖÎ¶ΩÏ†Å',
                'Caring': 'Î∞∞Î†§Ïã¨',
                'Adventurous': 'Î™®ÌóòÏã¨',
                'Conservative': 'Î≥¥ÏàòÏ†Å',
                'Liberal': 'ÏßÑÎ≥¥Ï†Å',
                'Optimistic': 'ÎÇôÍ¥ÄÏ†Å',
                'Pessimistic': 'ÎπÑÍ¥ÄÏ†Å',
                'Friendly': 'ÏπúÍ∑ºÌï®',
                'Serious': 'ÏßÑÏßÄÌï®',
                'Playful': 'Ïû•ÎÇúÍ∏∞',
                'Mature': 'ÏÑ±ÏàôÌï®',
                'Youthful': 'Ï†äÏùå',
                'Elegant': 'Ïö∞ÏïÑÌï®',
                'Casual': 'Ï∫êÏ£ºÏñº',
                'Formal': 'Í≤©Ïãù',
                'Natural': 'ÏûêÏó∞Ïä§Îü¨ÏõÄ',
                'Sophisticated': 'ÏÑ∏Î†®Îê®'
            };

            // Î≤àÏó≠Ïù¥ ÏûàÏúºÎ©¥ Î∞òÌôò
            if (commonTranslations[formatted]) {
                return commonTranslations[formatted];
            }

            // Î≤àÏó≠Ïù¥ ÏóÜÏúºÎ©¥ Ìè¨Îß∑Îêú ÌòïÌÉúÎ°ú Î∞òÌôò (ÌïúÍ∏Ä ÌëúÏãúÏö©)
            return `${formatted} (Î≤àÏó≠ ÌïÑÏöî)`;
        }

        function getCharacterSeductionStyle(character) {
            const style = character.appeal_profile?.seduction_style || '-';
            return style === '-' ? style : translateToKorean(style, 'seduction_style');
        }

        function getCharacterEmotionalIntelligence(character) {
            const ei = character.appeal_profile?.emotional_intelligence;
            return ei ? `${ei}/10` : '-';
        }

        function getCharacterConfidenceLevel(character) {
            const cl = character.appeal_profile?.confidence_level;
            return cl ? `${cl}/10` : '-';
        }

        function getCharacterMysteryFactor(character) {
            const mf = character.appeal_profile?.mystery_factor;
            return mf ? `${mf}/10` : '-';
        }

        function getCharacterCreatedDate(character) {
            if (character.created_at) {
                return new Date(character.created_at).toLocaleString('ko-KR');
            }
            return '-';
        }

        // ü§ñ AI ÌîÑÎ°¨ÌîÑÌä∏ ÏÉÅÏÑ∏ ÌëúÏãú Ìï®Ïàò
        function displayAIPromptInDetail(character) {
            console.log('ü§ñ AI ÌîÑÎ°¨ÌîÑÌä∏ ÏÉÅÏÑ∏ ÌëúÏãú Ï§ë...');

            const aiPromptSection = document.getElementById('aiPromptSection');
            const aiPromptText = document.getElementById('aiPromptText');

            if (!aiPromptSection || !aiPromptText) {
                console.warn('‚ö†Ô∏è AI ÌîÑÎ°¨ÌîÑÌä∏ ÏÑπÏÖò ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§');
                return;
            }

            // AI ÌîÑÎ°¨ÌîÑÌä∏Í∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏
            if (character && character.ai_prompt && character.ai_prompt.trim()) {
                // AI ÌîÑÎ°¨ÌîÑÌä∏ ÎÇ¥Ïö© ÌëúÏãú
                aiPromptText.textContent = character.ai_prompt;
                aiPromptSection.style.display = 'block';
                console.log('‚úÖ AI ÌîÑÎ°¨ÌîÑÌä∏ ÌëúÏãú ÏôÑÎ£å');
            } else {
                // AI ÌîÑÎ°¨ÌîÑÌä∏Í∞Ä ÏóÜÏúºÎ©¥ ÏÑπÏÖò Ïà®ÍπÄ
                aiPromptSection.style.display = 'none';
                console.log('‚ÑπÔ∏è AI ÌîÑÎ°¨ÌîÑÌä∏Í∞Ä ÏóÜÏñ¥ ÏÑπÏÖòÏùÑ Ïà®ÍπÅÎãàÎã§');
            }
        }

        // üõ†Ô∏è ÏïàÏ†ÑÌïú ÌÖçÏä§Ìä∏ ÏÑ§Ï†ï Ìï®Ïàò
        function safeSetTextContent(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = value || '-';
            } else {
                console.warn(`‚ö†Ô∏è ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§: ${elementId}`);
            }
        }

        // ‚úèÔ∏è ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Î™®Îã¨ÏóêÏÑú Ìé∏Ïßë Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú
        function editCurrentCharacter() {
            if (window.currentDetailCharacterId) {
                console.log('‚úèÔ∏è ÏÉÅÏÑ∏ Ï†ïÎ≥¥ÏóêÏÑú Ìé∏Ïßë Î™®ÎìúÎ°ú Ï†ÑÌôò:', window.currentDetailCharacterId);

                // ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Î™®Îã¨ Îã´Í∏∞
                closeModal('characterDetailModal');

                // Ìé∏Ïßë Î™®Îã¨ Ïó¥Í∏∞
                editCharacter(window.currentDetailCharacterId);
            } else {
                console.error('‚ùå Ìé∏ÏßëÌï† Ï∫êÎ¶≠ÌÑ∞ IDÍ∞Ä ÏóÜÏäµÎãàÎã§');
                alert('Ìé∏ÏßëÌï† Ï∫êÎ¶≠ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
            }
        }

        function updateCharacterStats() {
            console.log('üìä Ï∫êÎ¶≠ÌÑ∞ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÏûë...');
            
            const characterArray = Object.values(characters);
            console.log('üìä Ï∫êÎ¶≠ÌÑ∞ Î∞∞Ïó¥:', characterArray.length, 'Í∞ú');
            
            // ÏïàÏ†ÑÌïú ÏöîÏÜå ÏóÖÎç∞Ïù¥Ìä∏ (ÏöîÏÜåÍ∞Ä ÏóÜÏúºÎ©¥ Î¨¥Ïãú)
            const safeUpdateElement = (id, value) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                    console.log(`‚úÖ ${id}: ${value}`);
                } else {
                    console.warn(`‚ö†Ô∏è ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå: ${id}`);
                }
            };
            
            // Ï∫êÎ¶≠ÌÑ∞ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
            safeUpdateElement('totalCharacters', characterArray.length);
            safeUpdateElement('activeCharacters', characterArray.filter(c => c.active !== false).length);
            safeUpdateElement('characterCount', characterArray.length);
            
            // AI ÏÉùÏÑ± Ï∫êÎ¶≠ÌÑ∞ Í∞úÏàò
            const aiGeneratedCharacters = characterArray.filter(c => c.source === 'ai_generator' || c.created_by === 'ai').length;
            safeUpdateElement('aiGeneratedCharacters', aiGeneratedCharacters);
            
            // ÌèâÍ∑† Ìò∏Í∞êÎèÑ (ÏòàÏãúÏö©)
            const avgAffection = characterArray.length > 0 
                ? Math.round(characterArray.reduce((sum, c) => sum + (c.initial_affection || 0), 0) / characterArray.length)
                : 0;
            safeUpdateElement('avgCharacterAffection', avgAffection);
            
            console.log('‚úÖ Ï∫êÎ¶≠ÌÑ∞ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£º');
        }

        function openCharacterModal(mode) {
            currentMode = mode;

            // üé≠ ÏÉà Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ± ÏãúÏóêÎäî ÏöîÏïΩ ÏÑπÏÖò Ïà®Í∏∞Í∏∞
            const summarySection = document.getElementById('characterSummarySection');
            if (summarySection) {
                summarySection.style.display = 'none';
                console.log('‚úÖ ÏöîÏïΩ ÏÑπÏÖò Ïà®ÍπÄ (ÏÉà Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ± Î™®Îìú)');
            }

            // Î™®Îã¨ Ï†úÎ™© ÏõêÎûòÎåÄÎ°ú Î≥µÏõê
            document.getElementById('characterModalTitle').textContent = 'üé≠‚ú® ÏÑ∏Í≥ÑÍ¥Ä ÏµúÍ∞ï AI Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±Í∏∞';

            document.getElementById('characterForm').reset();

            // üÜî Ïã†Í∑ú ÏÉùÏÑ± Î™®ÎìúÏóêÏÑúÎäî Ï∫êÎ¶≠ÌÑ∞ ID ÌïÑÎìú Ï¥àÍ∏∞Ìôî
            const characterIdInput = document.getElementById('characterId');
            if (characterIdInput && mode === 'create') {
                characterIdInput.value = '';
                console.log('üÜï Ïã†Í∑ú ÏÉùÏÑ± Î™®Îìú: Ï∫êÎ¶≠ÌÑ∞ ID ÌïÑÎìú Ï¥àÍ∏∞Ìôî');
            }

            // Î™®Îì† ÏÑ†ÌÉù Î≤ÑÌäºÎì§ Ï¥àÍ∏∞Ìôî
            document.querySelectorAll('.mbti-btn.selected, .trait-btn.selected, .relationship-btn.selected, .hobby-btn.selected, .speech-btn.selected, .charm-btn.selected, .desire-btn.selected, .skinship-btn.selected, .motif-btn.selected, .flirting-btn.selected, .hook-btn.selected, .confident-part-btn.selected, .seductive-pose-btn.selected, .gift-btn.selected').forEach(btn => {
                btn.classList.remove('selected');
            });

            // üé≤ Ìèº Ïó¥ Îïå ÏûêÎèôÏúºÎ°ú ÎûúÎç§ ÏÑ†ÌÉùÎêú ÏÉÅÌÉúÎ°ú ÎßåÎì§Í∏∞
            setTimeout(() => {
                autoFillRandomCharacterData();
                console.log('‚ú® Ï∫êÎ¶≠ÌÑ∞ ÌèºÏóê ÎûúÎç§ Îç∞Ïù¥ÌÑ∞ ÏûêÎèô Ï±ÑÏö∞Í∏∞ ÏôÑÎ£å');
            }, 100);

            // Ïà®Í≤®ÏßÑ ÌïÑÎìúÎì§ Ï¥àÍ∏∞Ìôî
            document.getElementById('charMbti').value = '';
            document.getElementById('charRelationship').value = '';
            document.getElementById('charSpeechStyle').value = '';

            // ÎûúÎç§ ÏÉùÏÑ± ÏòÅÏó≠ Ï¥àÍ∏∞Ìôî
            const randomStatusEl = document.getElementById('randomStatus');
            if (randomStatusEl) {
                randomStatusEl.innerHTML = '';
            }

            // Î∞±Í∑∏ÎùºÏö¥Îìú Ïä§ÌÅ¨Î°§ ÎπÑÌôúÏÑ±Ìôî
            document.body.style.overflow = 'hidden';

            document.getElementById('characterModal').style.display = 'block';
        }

        // üîÑ Ï∫êÎ¶≠ÌÑ∞ Ìé∏Ïßë Ìï®Ïàò v2.0 (ÏÉàÎ°úÏö¥ Ïä§ÌÇ§Îßà ÏßÄÏõê)
        function editCharacter(characterId) {
            // üîß Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞Ïóê Îî∞Î•∏ Ï∫êÎ¶≠ÌÑ∞ Ï°∞Ìöå (v4.1.0 Íµ¨Ï°∞ ÏßÄÏõê)
            let character = null;
            if (characters && characters.characters) {
                character = characters.characters[characterId];
            } else if (characters && characters[characterId]) {
                character = characters[characterId];
            }

            if (!character) {
                console.error('Ï∫êÎ¶≠ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§:', characterId);
                console.log('üîç Ï†ÑÏ≤¥ Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞:', characters);
                return;
            }

            const characterName = getCharacterName(character);
            console.log('‚úèÔ∏è Ï∫êÎ¶≠ÌÑ∞ Ìé∏Ïßë v2.0 ÏãúÏûë:', characterName);
            console.log('üîç Ï∫êÎ¶≠ÌÑ∞ Ïä§ÌÇ§Îßà ÌÉÄÏûÖ:', character.basic_info ? 'v2.0 (Î≥µÏû°Ìïú Ïä§ÌÇ§Îßà)' : 'v1.0 (Í∏∞Ï°¥ Ïä§ÌÇ§Îßà)');

            currentMode = 'edit';

            // üéØ ÏÉàÎ°úÏö¥ fillCharacterForm Ìï®Ïàò ÏÇ¨Ïö© (v2.0 Ìò∏Ìôò)
            fillCharacterForm(character);

            // üÜî Ìé∏Ïßë Î™®ÎìúÎ•º ÏúÑÌïú Ï∫êÎ¶≠ÌÑ∞ ID ÏÑ§Ï†ï
            const characterIdInput = document.getElementById('characterId');
            if (characterIdInput) {
                characterIdInput.value = characterId;
                console.log('‚úÖ Ï∫êÎ¶≠ÌÑ∞ ID ÏÑ§Ï†ï:', characterId);
            }

            // üé≠ Ï∫êÎ¶≠ÌÑ∞ ÏöîÏïΩ ÏÑπÏÖò ÌëúÏãú Î∞è Îç∞Ïù¥ÌÑ∞ Ï±ÑÏö∞Í∏∞ (v2.0 Ìò∏Ìôò)
            const summarySection = document.getElementById('characterSummarySection');
            if (summarySection) {
                summarySection.style.display = 'block';

                // v2.0 Ïä§ÌÇ§Îßà Ìò∏Ìôò ÏöîÏïΩ Ï†ïÎ≥¥ Ï±ÑÏö∞Í∏∞
                document.getElementById('summaryName').textContent = getCharacterName(character);
                document.getElementById('summaryAge').textContent = (character.basic_info?.age || character.age) ? `${character.basic_info?.age || character.age}ÏÑ∏` : '-';
                document.getElementById('summaryMbti').textContent = getCharacterMBTI(character);
                document.getElementById('summaryGender').textContent = (character.basic_info?.gender || character.gender) === 'female' ? 'Ïó¨ÏÑ±' :
                                                                     (character.basic_info?.gender || character.gender) === 'male' ? 'ÎÇ®ÏÑ±' : '-';

                // ÌäπÏÑ± Ï†ïÎ≥¥ (v2.0 Ìò∏Ìôò)
                document.getElementById('summaryPersonality').textContent = getCharacterTraits(character);

                // Ï∑®ÎØ∏ Ï†ïÎ≥¥ (v2.0 Ìò∏Ìôò)
                const hobbies = character.hobbies || [];
                const hobbiesText = Array.isArray(hobbies) && hobbies.length > 0 ? hobbies.join(', ') : '-';
                document.getElementById('summaryHobbies').textContent = hobbiesText;

                // Ïô∏Î™® Ï†ïÎ≥¥ (v2.0 Ìò∏Ìôò)
                const appearanceText = character.appearance
                    ? `${character.appearance.hair || ''} / ${character.appearance.eyes || ''} / ${character.appearance.style || ''}`.replace(/\s*\/\s*$/g, '').replace(/^\s*\/\s*/g, '')
                    : '-';
                document.getElementById('summaryAppearance').textContent = appearanceText || '-';

                // Î∞∞Í≤Ω (family, hometown)
                const backgroundText = `${character.basic_info?.family_structure || character.family_structure || ''} / ${character.basic_info?.hometown || character.hometown || ''}`.replace(/\s*\/\s*$/g, '').replace(/^\s*\/\s*/g, '');
                document.getElementById('summaryBackground').textContent = backgroundText || '-';

                // ÎßêÌà¨
                document.getElementById('summarySpeechStyle').textContent = character.speech_style || '-';

                console.log('‚úÖ Ï∫êÎ¶≠ÌÑ∞ ÏöîÏïΩ Ï†ïÎ≥¥ ÌëúÏãú ÏôÑÎ£å');
            }

            // Î™®Îã¨ Ï†úÎ™© ÏÑ§Ï†ï (v2.0 Ìò∏Ìôò)
            const modalTitle = document.getElementById('characterModalTitle');
            if (modalTitle) {
                modalTitle.textContent = `üé≠ Ï∫êÎ¶≠ÌÑ∞ ÏàòÏ†ï: ${getCharacterName(character)}`;
            }

            // üÜî Ìé∏ÏßëÏö© Ï∫êÎ¶≠ÌÑ∞ IDÎßå Î≥ÑÎèÑ ÏÑ§Ï†ï (fillCharacterFormÏóêÏÑú Ï≤òÎ¶¨ÌïòÏßÄ ÏïäÎäî Ìï≠Î™©)
            safeSetValue('characterId', characterId);

            // ‚úÖ Î™®Îì† Ìèº ÌïÑÎìúÎäî ÏúÑÏùò fillCharacterForm(character) Ìò∏Ï∂úÎ°ú Ïù¥ÎØ∏ Ï≤òÎ¶¨Îê®
            // (Ï≤¥ÌÅ¨Î∞ïÏä§, ÎùºÎîîÏò§ Î≤ÑÌäº, ÏÖÄÎ†âÌä∏Î∞ïÏä§ Ìè¨Ìï®)
            console.log('‚úÖ Ìé∏Ïßë Î™®Îìú: fillCharacterForm v2.0ÏúºÎ°ú Î™®Îì† Îç∞Ïù¥ÌÑ∞ Ï±ÑÏõÄ ÏôÑÎ£å');

            // Î∞±Í∑∏ÎùºÏö¥Îìú Ïä§ÌÅ¨Î°§ ÎπÑÌôúÏÑ±Ìôî
            document.body.style.overflow = 'hidden';

            // Î™®Îã¨ ÌëúÏãú
            document.getElementById('characterModal').style.display = 'block';
            console.log('‚úÖ Ï∫êÎ¶≠ÌÑ∞ Ìé∏Ïßë Î™®Îã¨ ÌëúÏãú ÏôÑÎ£å (ÏöîÏïΩ + Ìèº Îç∞Ïù¥ÌÑ∞)');
        }

        // ‚ö†Ô∏è Í∏∞Ï°¥ saveCharacter Ìï®Ïàò Ï†úÍ±∞Îê® - ÏÉàÎ°úÏö¥ Ïò®ÎùºÏù∏ Ï†ÑÏö© Ìï®ÏàòÎ°ú ÍµêÏ≤¥


        // Ï±ÑÌåÖ ÌõàÎ†® APIÎ•º ÏÇ¨Ïö©Ìïú ÎåÄÌôî ÏÉùÏÑ± Ìï®Ïàò (Í∞úÏÑ†Îêú Î≤ÑÏ†Ñ)
        async function generateLocalDialogue(characterId, characterName, userPrompt, difficulty, scenario) {
            console.log(`üéØ ${characterName}Ïùò ${difficulty} ÎÇúÏù¥ÎèÑ Ï±ÑÌåÖ ÌõàÎ†® ÎåÄÌôî ÏÉùÏÑ±:`, userPrompt);
            console.log(`üìö ÏãúÎÇòÎ¶¨Ïò§ Ïª®ÌÖçÏä§Ìä∏:`, scenario?.title || 'ÏóÜÏùå');

            try {
                // Ï±ÑÌåÖ ÌõàÎ†® API Ìò∏Ï∂ú (ÏãúÎÇòÎ¶¨Ïò§ Ï†ïÎ≥¥ Ìè¨Ìï®)
                const response = await fetch('/api/episode-test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'generate',
                        character_id: characterId,
                        user_prompt: userPrompt,
                        difficulty: difficulty,
                        scenario_id: scenario?.id || scenario?.scenario_id,
                        scenario_title: scenario?.title,
                        scenario_description: scenario?.description,
                        scenario_context: scenario?.ai_generated_context || scenario?.custom_context,
                        scenario_mood: scenario?.mood,
                        scenario_setting: scenario?.background_setting
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå API ÏùëÎãµ Ïã§Ìå®:', response.status, errorText);
                    throw new Error(`API Ìò∏Ï∂ú Ïã§Ìå® (${response.status}): ${errorText}`);
                }

                const data = await response.json();
                console.log('‚úÖ Ï±ÑÌåÖ ÌõàÎ†® API ÏùëÎãµ Î∞õÏùå:', data);

                // APIÍ∞Ä ÎπÑÌôúÏÑ±ÌôîÎêú Í≤ΩÏö∞ ÎòêÎäî ÏÑ±Í≥µÌïòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞ Ï≤òÎ¶¨
                if (!data.success) {
                    const errorMessage = data.message || 'AI ÎåÄÌôî ÏÉùÏÑ± APIÏóêÏÑú Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
                    console.error('‚ö†Ô∏è API Ïò§Î•ò:', errorMessage);
                    throw new Error(errorMessage);
                }

                // ÏÑ±Í≥µÌïú Í≤ΩÏö∞ Îç∞Ïù¥ÌÑ∞ Î∞òÌôò (ÏÉàÎ°úÏö¥ story_flow Íµ¨Ï°∞ ÏßÄÏõê)
                if (data.data) {
                    console.log('üéØ AI ÏùëÎãµ Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞ ÌôïÏù∏:', data.data);

                    // story_flow Íµ¨Ï°∞Ïù∏ÏßÄ ÌôïÏù∏
                    if (data.data.story_flow && Array.isArray(data.data.story_flow)) {
                        console.log('‚úÖ Story Flow Íµ¨Ï°∞Î°ú AI ÎåÄÌôî ÏÉùÏÑ±Îê®');
                        return {
                            story_flow: data.data.story_flow,
                            dialogue_summary: data.data.dialogue_summary,
                            difficulty: difficulty,
                            generated_at: new Date().toISOString(),
                            source: 'openai_gpt4o_mini'
                        };
                    }
                    // Í∏∞Ï°¥ Íµ¨Ï°∞ ÏßÄÏõê (ÌïòÏúÑ Ìò∏ÌôòÏÑ±)
                    else if (data.data.character_message || data.data.dialogue) {
                        console.log('üìù Í∏∞Ï°¥ Íµ¨Ï°∞Î°ú AI ÎåÄÌôî ÏÉùÏÑ±Îê®');
                        return {
                            dialogue: data.data.character_message || data.data.dialogue,
                            narration: data.data.context || data.data.narration,
                            choices: data.data.choices || [],
                            difficulty: difficulty,
                            generated_at: new Date().toISOString(),
                            source: 'legacy_api'
                        };
                    } else {
                        throw new Error('AI ÏùëÎãµ Îç∞Ïù¥ÌÑ∞ ÌòïÏãùÏùÑ Ïù∏ÏãùÌï† Ïàò ÏóÜÏäµÎãàÎã§.');
                    }
                } else {
                    throw new Error('API ÏùëÎãµÏóê Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
                }

            } catch (error) {
                // Íµ¨Ï≤¥Ï†ÅÏù∏ ÏóêÎü¨ Î©îÏãúÏßÄ Î°úÍπÖ
                const errorMessage = error.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
                console.error('‚ùå Ï±ÑÌåÖ ÌõàÎ†® API Ìò∏Ï∂ú Ïò§Î•ò:', errorMessage);
                console.error('‚ùå Ï†ÑÏ≤¥ ÏóêÎü¨ Í∞ùÏ≤¥:', error);

                // ÏóêÎü¨ Î©îÏãúÏßÄÎ•º Î™ÖÌôïÌïòÍ≤å Ï†ÑÎã¨
                throw new Error(errorMessage);
            }
        }

        // üöÄ GitHub API ÌïµÏã¨ Ìï®ÏàòÎì§ (ÌòÅÏã†Ï†Å Ìï¥Í≤∞Ï±Ö!)
        
        // GitHub Repository ÏÑ§Ï†ï
        const GITHUB_CONFIG = {
            owner: 'EnmanyProject',  // GitHub ÏÇ¨Ïö©ÏûêÎ™Ö
            repo: 'chatgame',        // Repository Ïù¥Î¶Ñ  
            token: null,             // Personal Access Token (ÌôòÍ≤ΩÎ≥ÄÏàòÏóêÏÑú Î°úÎìú)
            branch: 'main'           // Î∏åÎûúÏπòÎ™Ö
        };
        
        // GitHub ÌÜ†ÌÅ∞ÏùÄ Ïù¥Ï†ú ÏÑúÎ≤ÑÏÇ¨Ïù¥ÎìúÏóêÏÑú ÌôòÍ≤ΩÎ≥ÄÏàòÎ°ú Í¥ÄÎ¶¨Îê®
        
        // GitHub APIÎ°ú ÌååÏùº ÎÇ¥Ïö© Í∞ÄÏ†∏Ïò§Í∏∞
        async function getFileFromGitHub(filePath) {
            try {
                const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${filePath}`;
                console.log('üì• GitHubÏóêÏÑú ÌååÏùº Î°úÎìú:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const content = JSON.parse(atob(data.content));
                    console.log('‚úÖ GitHub ÌååÏùº Î°úÎìú ÏÑ±Í≥µ:', filePath);
                    return { success: true, content, sha: data.sha };
                } else if (response.status === 404) {
                    console.log('üì≠ GitHub ÌååÏùº ÏóÜÏùå, ÏÉà ÌååÏùº ÏÉùÏÑ±:', filePath);
                    return { success: true, content: { characters: {} }, sha: null };
                } else {
                    throw new Error(`GitHub API Error: ${response.status}`);
                }
            } catch (error) {
                console.error('‚ùå GitHub ÌååÏùº Î°úÎìú Ïã§Ìå®:', error);
                return { success: false, error: error.message };
            }
        }
        
        // GitHub APIÎ°ú ÌååÏùº ÏóÖÎç∞Ïù¥Ìä∏/ÏÉùÏÑ±
        async function commitToGitHub(filePath, content, commitMessage) {
            try {
                // ÌòÑÏû¨ ÌååÏùº SHA Í∞ÄÏ†∏Ïò§Í∏∞ (ÏóÖÎç∞Ïù¥Ìä∏Ïö©)
                const currentFile = await getFileFromGitHub(filePath);
                
                const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${filePath}`;
                console.log('üì§ GitHubÏóê Ïª§Î∞ã:', url);
                
                const body = {
                    message: commitMessage + ` ü§ñ Generated by ChatGame Admin`,
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2)))),
                    branch: GITHUB_CONFIG.branch
                };
                
                // ÌååÏùºÏù¥ Ï°¥Ïû¨ÌïòÎ©¥ SHA Ìè¨Ìï® (ÏóÖÎç∞Ïù¥Ìä∏)
                if (currentFile.sha) {
                    body.sha = currentFile.sha;
                }
                
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ GitHub Ïª§Î∞ã ÏÑ±Í≥µ! SHA:', data.commit.sha);
                    return { 
                        success: true, 
                        sha: data.commit.sha,
                        html_url: data.commit.html_url 
                    };
                } else {
                    const errorData = await response.json();
                    throw new Error(`GitHub Commit Error: ${response.status} - ${errorData.message}`);
                }
            } catch (error) {
                console.error('‚ùå GitHub Ïª§Î∞ã Ïã§Ìå®:', error);
                return { success: false, error: error.message };
            }
        }
        
        // GitHubÏóêÏÑú Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        async function loadCharactersFromGitHub() {
            try {
                console.log('üì• GitHubÏóêÏÑú Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú...');
                const result = await getFileFromGitHub('data/characters.json');
                
                if (result.success) {
                    // characters.json Ìè¨Îß∑ÏùÑ ID Í∏∞Î∞ò Í∞ùÏ≤¥Î°ú Î≥ÄÌôò
                    const charactersData = result.content;
                    if (charactersData.characters) {
                        if (Array.isArray(charactersData.characters)) {
                            // Array ÌòïÌÉúÎ•º Object ÌòïÌÉúÎ°ú Î≥ÄÌôò
                            const convertedCharacters = {};
                            charactersData.characters.forEach(char => {
                                convertedCharacters[char.id] = char;
                            });
                            return convertedCharacters;
                        } else {
                            return charactersData.characters;
                        }
                    }
                    return {};
                } else {
                    console.warn('‚ö†Ô∏è GitHub Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú Ïã§Ìå®:', result.error);
                    return {};
                }
            } catch (error) {
                console.error('‚ùå GitHub Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú ÏòàÏô∏:', error);
                return {};
            }
        }
        
        // üöÄ GitHub API Ï∫êÎ¶≠ÌÑ∞ Ï†ÄÏû• Ìï®Ïàò (ÌòÅÏã†Ï†Å!)
        async function saveCharacterToGitHub(character) {
            try {
                console.log('üêô GitHub APIÎ°ú Ï∫êÎ¶≠ÌÑ∞ Ï†ÄÏû• ÏãúÏûë:', character.name);
                
                // GitHub ÌÜ†ÌÅ∞ÏùÄ ÏÑúÎ≤ÑÏÇ¨Ïù¥ÎìúÏóêÏÑú ÌôòÍ≤ΩÎ≥ÄÏàòÎ°ú Ï≤òÎ¶¨
                
                // Ï∫êÎ¶≠ÌÑ∞ ID ÏÉùÏÑ± (ÏóÜÏúºÎ©¥)
                if (!character.id) {
                    character.id = `${character.name.toLowerCase().replace(/\s/g, '_')}_${character.mbti.toLowerCase()}_${Date.now()}`;
                    console.log('üîß Ï∫êÎ¶≠ÌÑ∞ ID ÏÉùÏÑ±:', character.id);
                }
                
                // Í∏∞Ï°¥ Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù Î°úÎìú
                const existingCharacters = await loadCharactersFromGitHub();
                console.log('üìä Í∏∞Ï°¥ GitHub Ï∫êÎ¶≠ÌÑ∞ Ïàò:', Object.keys(existingCharacters).length);
                
                // ÏÉà Ï∫êÎ¶≠ÌÑ∞ Ï∂îÍ∞Ä
                existingCharacters[character.id] = {
                    ...character,
                    updated_at: new Date().toISOString(),
                    source: 'github_api',
                    commit_hash: 'pending'
                };
                
                // GitHubÏóê Ïª§Î∞ãÌï† Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞ ÏÉùÏÑ±
                const charactersArrayData = {
                    characters: Object.values(existingCharacters)
                };
                
                // GitHub RepositoryÏóê ÏßÅÏ†ë Ïª§Î∞ã
                const commitMessage = `Add new character: ${character.name} (${character.mbti})`;
                const commitResult = await commitToGitHub('data/characters.json', charactersArrayData, commitMessage);
                
                if (commitResult.success) {
                    // Ïª§Î∞ã Ìï¥Ïãú ÏóÖÎç∞Ïù¥Ìä∏
                    existingCharacters[character.id].commit_hash = commitResult.sha;
                    
                    // Î°úÏª¨ Î∞±ÏóÖÎèÑ Ï†ÄÏû•
                    localStorage.setItem('chatgame_characters', JSON.stringify(existingCharacters));
                    
                    console.log('‚úÖ GitHub API Ï†ÄÏû• ÏôÑÎ£å! Ïª§Î∞ã SHA:', commitResult.sha);
                    console.log('üìù GitHubÏóê Ï†ÄÏû•Îêú Ï∫êÎ¶≠ÌÑ∞ IDÎì§:', Object.keys(existingCharacters));
                    console.log('üîó Ïª§Î∞ã URL:', commitResult.html_url);
                    
                    return { success: true, commit_hash: commitResult.sha, url: commitResult.html_url };
                } else {
                    throw new Error('GitHub commit failed: ' + commitResult.error);
                }
                
            } catch (error) {
                console.error('‚ùå GitHub API Ï†ÄÏû• Ïò§Î•ò:', error);
                
                // Ïã§Ìå® Ïãú Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÎ°ú Ìè¥Î∞±
                console.log('üíæ Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÎ°ú Ìè¥Î∞±...');
                return saveCharacterToLocalStorage(character);
            }
        }
        
        // Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ Ìè¥Î∞± Ìï®Ïàò
        function saveCharacterToLocalStorage(character) {
            try {
                console.log('üíæ Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóê Ï∫êÎ¶≠ÌÑ∞ Ï†ÄÏû• ÏãúÏûë:', character.name);
                
                // Ï∫êÎ¶≠ÌÑ∞ ID ÏÉùÏÑ± (ÏóÜÏúºÎ©¥)
                if (!character.id) {
                    character.id = `${character.name.toLowerCase()}_${character.mbti.toLowerCase()}_${Date.now()}`;
                    console.log('üîß Ï∫êÎ¶≠ÌÑ∞ ID ÏÉùÏÑ±:', character.id);
                }
                
                // Í∏∞Ï°¥ Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù Î°úÎìú
                const existingCharacters = JSON.parse(localStorage.getItem('chatgame_characters') || '{}');
                console.log('üìä Í∏∞Ï°¥ Ï∫êÎ¶≠ÌÑ∞ Ïàò:', Object.keys(existingCharacters).length);
                
                // ÏÉà Ï∫êÎ¶≠ÌÑ∞ Ï∂îÍ∞Ä
                existingCharacters[character.id] = {
                    ...character,
                    updated_at: new Date().toISOString(),
                    source: 'local_storage'
                };
                
                // Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóê Ï†ÄÏû•
                localStorage.setItem('chatgame_characters', JSON.stringify(existingCharacters));
                
                console.log('‚úÖ Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ Ï†ÄÏû• ÏôÑÎ£å. Ï¥ù Ï∫êÎ¶≠ÌÑ∞ Ïàò:', Object.keys(existingCharacters).length);
                console.log('üìù Ï†ÄÏû•Îêú Ï∫êÎ¶≠ÌÑ∞ IDÎì§:', Object.keys(existingCharacters));
                
                return true;
            } catch (error) {
                console.error('‚ùå Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ Ï†ÄÏû• Ïò§Î•ò:', error);
                return false;
            }
        }
        
        // API Î∞±ÏóÖ Ï†ÄÏû• Ìï®Ïàò (Ïã§Ìå®Ìï¥ÎèÑ Î¨¥Ïãú)
        async function saveCharacterToAPI(character) {
            try {
                console.log('üåê APIÎ°ú Ï∫êÎ¶≠ÌÑ∞ Î∞±ÏóÖ ÏãúÏûë:', character.name);
                
                const response = await fetch('/api/character-ai-generator', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'save_character',
                        character: character
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Ï∫êÎ¶≠ÌÑ∞ Ï†ÄÏû• ÏÑ±Í≥µ:', result);
                    return result.success;
                } else {
                    console.error('‚ùå API Ï†ÄÏû• Ïã§Ìå®:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Ï∫êÎ¶≠ÌÑ∞ Ï†ÄÏû• Ïò§Î•ò:', error);
                return false;
            }
        }

        // ÏÉàÎ°úÏö¥ Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ ÏàòÏßë Ìï®Ïàò
        function collectCharacterData() {
            console.log('üìã Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ ÏàòÏßë ÏãúÏûë...');

            const data = {
                // Í∏∞Î≥∏ Ï†ïÎ≥¥
                name: document.getElementById('charName').value || 'ÎØ∏ÏßÄÏùò ÏÜåÎÖÄ',
                age: document.getElementById('charAge').value || '20',
                mbti: document.getElementById('charMbti').value,
                character_type: document.getElementById('charType').value || 'romance_junior',
                personality_traits: getSelectedTraits(),
                occupation: document.getElementById('charOccupation').value || 'student',

                // üÜï ÏÉàÎ°úÏö¥ Í∏∞Î≥∏ Ï†ïÎ≥¥ ÌïÑÎìúÎì§
                education: document.getElementById('charEducation').value || 'college_graduate',
                location: document.getElementById('charLocation').value || 'gangnam',
                hometown: document.getElementById('charHometown').value || 'seoul',
                family_structure: document.getElementById('charFamilyStructure').value || 'nuclear_family',
                pets: document.getElementById('charPets').value || 'none',
                bloodtype: document.getElementById('charBloodtype').value || 'A',

                relationship: document.getElementById('charRelationship').value,

                // Ïô∏Î™® Ï†ïÎ≥¥
                image: null,
                hair: document.getElementById('charHair').value || 'long_straight',
                eyes: document.getElementById('charEyes').value || 'round_cute',
                body: document.getElementById('charBody').value || 'petite',
                bust: document.getElementById('charBust')?.value || 'B',
                waist_hip: document.getElementById('charWaistHip')?.value || 'Í∑†Ìòï',
                style: document.getElementById('charStyle').value || 'Ï∫êÏ£ºÏñº',

                // ÎÇ¥Î©¥/Ï∑®ÎØ∏
                hobbies: getSelectedHobbies(),
                values: document.getElementById('charValues').value || 'love_family',
                speech_style: document.getElementById('charSpeechStyle').value || null, // üö® Îπà Î¨∏ÏûêÏó¥Ïù¥Î©¥ null
                speech_habit: document.getElementById('charSpeechHabit').value || 'Ïò§Îπ†',

                // üÜï Button-based hidden input Îç∞Ïù¥ÌÑ∞ (JSON ÌååÏã±)
                personality_traits_extended: parseHiddenInput('charPersonalityTraits'),
                hobbies_extended: parseHiddenInput('charHobbies'),
                feature_elements: parseHiddenInput('charFeatureElements'),
                sensual_habits: parseHiddenInput('charSensualHabits'),
                body_language: parseHiddenInput('charBodyLanguage'),

                // üí´ ÏÉàÎ°úÏö¥ Îß§Î†• ÌîÑÎ°úÌïÑ ÌïÑÎìúÎì§
                seduction_style: document.getElementById('seductionStyle')?.value || 'playful_confident',
                charm_points: getSelectedCharms(),
                emotional_intelligence: parseInt(document.getElementById('emotionalIntelligence')?.value) || 7,
                confidence_level: parseInt(document.getElementById('confidenceLevel')?.value) || 8,
                mystery_factor: parseInt(document.getElementById('mysteryFactor')?.value) || 6,
                sexual_curiosity: parseInt(document.getElementById('sexualCuriosity')?.value) || 5, // üî• ÏÉàÎ°ú Ï∂îÍ∞Ä

                // üß† ÏÉàÎ°úÏö¥ Ïã¨Î¶¨Ï†Å ÍπäÏù¥ ÌïÑÎìúÎì§
                core_desires: getSelectedDesires(),
                comfort_level: document.getElementById('comfortLevel')?.value || 'moderate_flirtation',
                escalation_pace: document.getElementById('escalationPace')?.value || 'gradual_building',

                // üìã ÏÉàÎ°úÏö¥ Í≥ºÍ±∞ Ïù¥Î†• ÌïÑÎìúÎì§
                boyfriend_count: parseInt(document.getElementById('boyfriendCount')?.value) || 2,
                preferred_skinship: getSelectedSkinships(),
                relationship_experience: document.getElementById('relationshipExperience')?.value || 'intermediate',
                first_experience_age: document.getElementById('firstExperienceAge')?.value || 'late_teens'
            };

            console.log('üìã ÏàòÏßëÎêú Îç∞Ïù¥ÌÑ∞:', data);
            console.log('  - ÏÑ†ÌÉùÎêú ÏÑ±Í≤©ÌäπÏÑ±:', data.personality_traits);
            console.log('  - ÏÑ†ÌÉùÎêú Ï∑®ÎØ∏:', data.hobbies);
            console.log('  - üí´ Îß§Î†• Ìè¨Ïù∏Ìä∏:', data.charm_points);
            console.log('  - üß† ÌïµÏã¨ ÏöïÍµ¨:', data.core_desires);
            console.log('  - Ïú†Ìòπ Ïä§ÌÉÄÏùº:', data.seduction_style);
            console.log('  - Í∞êÏÑ±ÏßÄÎä•/ÏûêÏã†Í∞ê/Ïã†ÎπÑ:', data.emotional_intelligence, data.confidence_level, data.mystery_factor);
            console.log('  - Í≤ΩÍ≥ÑÏÑ†/Î∞úÏ†ÑÏÜçÎèÑ:', data.comfort_level, data.escalation_pace);

            return data;
        }

        // ÏÑ†ÌÉùÎêú ÏÑ±Í≤© ÌäπÏÑ±Îì§ Í∞ÄÏ†∏Ïò§Í∏∞
        function getSelectedTraits() {
            const selectedTraits = [];
            // ÏÑ†ÌÉùÎêú ÏÑ±Í≤© ÌäπÏÑ± Î≤ÑÌäºÏóêÏÑú ÏàòÏßë (trait-btn.selected)
            const selectedButtons = document.querySelectorAll('.trait-btn.selected');
            console.log('üîç ÏÑ±Í≤©ÌäπÏÑ± ÎîîÎ≤ÑÍπÖ:');
            console.log('  - Ï†ÑÏ≤¥ trait-btn Î≤ÑÌäº Ïàò:', document.querySelectorAll('.trait-btn').length);
            console.log('  - ÏÑ†ÌÉùÎêú trait-btn Î≤ÑÌäº Ïàò:', selectedButtons.length);

            selectedButtons.forEach(button => {
                const trait = button.getAttribute('data-trait');
                selectedTraits.push(trait);
                console.log('  - ÏÑ†ÌÉùÎêú ÌäπÏÑ±:', trait);
            });

            console.log('üéØ ÏµúÏ¢Ö ÏÑ†ÌÉùÎêú ÏÑ±Í≤© ÌäπÏÑ±:', selectedTraits);

            // ÎßåÏïΩ ÏïÑÎ¨¥Í≤ÉÎèÑ ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏïòÎã§Î©¥ Í∏∞Î≥∏Í∞í Ï†úÍ≥µ
            if (selectedTraits.length === 0) {
                console.log('‚ö†Ô∏è ÏÑ±Í≤©ÌäπÏÑ±Ïù¥ ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏùå - Í∏∞Î≥∏Í∞í ÏÇ¨Ïö©');
                return ['Í∞êÏÑ±Ï†Å', 'ÌôúÎ∞úÌïú']; // Í∏∞Î≥∏ ÌäπÏÑ± 2Í∞ú
            }

            return selectedTraits.slice(0, 5); // ÏµúÎåÄ 5Í∞úÎ°ú Ï¶ùÍ∞Ä
        }

        // ÏÑ†ÌÉùÎêú Ï∑®ÎØ∏Îì§ Í∞ÄÏ†∏Ïò§Í∏∞
        function getSelectedHobbies() {
            const selectedHobbies = [];
            // Ïã§Ï†ú Ï≤¥ÌÅ¨Î∞ïÏä§ÏóêÏÑú ÏÑ†ÌÉùÎêú Ï∑®ÎØ∏ ÏàòÏßë
            document.querySelectorAll('input[name="hobbies"]:checked').forEach(input => {
                selectedHobbies.push(input.value);
            });
            console.log('üéØ ÏÑ†ÌÉùÎêú Ï∑®ÎØ∏:', selectedHobbies);
            return selectedHobbies.slice(0, 5); // ÏµúÎåÄ 5Í∞úÎ°ú Ï¶ùÍ∞Ä
        }

        // ÏÑ†ÌÉùÎêú Îß§Î†• Ìè¨Ïù∏Ìä∏Îì§ Í∞ÄÏ†∏Ïò§Í∏∞ (Îπà Î∞∞Ïó¥Ïù¥Î©¥ null Î∞òÌôò)
        function getSelectedCharms() {
            console.log('üîç getSelectedCharms Ïã§Ìñâ Ï§ë...');

            // 1. Î™®Îì† .charm-btn ÏöîÏÜå ÌôïÏù∏
            const allCharmBtns = document.querySelectorAll('.charm-btn');
            console.log('üìä Ï†ÑÏ≤¥ charm-btn ÏöîÏÜå Ïàò:', allCharmBtns.length);

            // 2. .selected ÌÅ¥ÎûòÏä§Í∞Ä ÏûàÎäî ÏöîÏÜåÎì§ ÌôïÏù∏
            const selectedCharmBtns = document.querySelectorAll('.charm-btn.selected');
            console.log('üìä ÏÑ†ÌÉùÎêú charm-btn ÏöîÏÜå Ïàò:', selectedCharmBtns.length);

            // 3. Í∞Å ÏÑ†ÌÉùÎêú ÏöîÏÜåÏùò Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏
            const selectedCharms = [];
            selectedCharmBtns.forEach((btn, index) => {
                const charmValue = btn.dataset.charm;
                console.log(`üìã ÏÑ†ÌÉùÎêú charm ${index + 1}:`, charmValue, '(ÏöîÏÜå:', btn, ')');
                selectedCharms.push(charmValue);
            });

            console.log('üéØ ÏµúÏ¢Ö ÏÑ†ÌÉùÎêú Îß§Î†• Ìè¨Ïù∏Ìä∏:', selectedCharms);
            const result = selectedCharms.slice(0, 3); // ÏµúÎåÄ 3Í∞ú
            console.log('üéØ Î∞òÌôòÌï† Í≤∞Í≥º:', result.length === 0 ? 'null' : result);
            return result.length === 0 ? null : result; // üö® Îπà Î∞∞Ïó¥Ïù¥Î©¥ null Î∞òÌôò
        }

        // ÏÑ†ÌÉùÎêú ÌïµÏã¨ ÏöïÍµ¨Îì§ Í∞ÄÏ†∏Ïò§Í∏∞ (Îπà Î∞∞Ïó¥Ïù¥Î©¥ null Î∞òÌôò)
        function getSelectedDesires() {
            console.log('üîç getSelectedDesires Ïã§Ìñâ Ï§ë...');

            // 1. Î™®Îì† .desire-btn ÏöîÏÜå ÌôïÏù∏
            const allDesireBtns = document.querySelectorAll('.desire-btn');
            console.log('üìä Ï†ÑÏ≤¥ desire-btn ÏöîÏÜå Ïàò:', allDesireBtns.length);

            // 2. .selected ÌÅ¥ÎûòÏä§Í∞Ä ÏûàÎäî ÏöîÏÜåÎì§ ÌôïÏù∏
            const selectedDesireBtns = document.querySelectorAll('.desire-btn.selected');
            console.log('üìä ÏÑ†ÌÉùÎêú desire-btn ÏöîÏÜå Ïàò:', selectedDesireBtns.length);

            // 3. Í∞Å ÏÑ†ÌÉùÎêú ÏöîÏÜåÏùò Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏
            const selectedDesires = [];
            selectedDesireBtns.forEach((btn, index) => {
                const desireValue = btn.dataset.desire;
                console.log(`üìã ÏÑ†ÌÉùÎêú desire ${index + 1}:`, desireValue, '(ÏöîÏÜå:', btn, ')');
                selectedDesires.push(desireValue);
            });

            console.log('üéØ ÏµúÏ¢Ö ÏÑ†ÌÉùÎêú ÌïµÏã¨ ÏöïÍµ¨:', selectedDesires);
            const result = selectedDesires.slice(0, 3); // ÏµúÎåÄ 3Í∞ú
            console.log('üéØ Î∞òÌôòÌï† Í≤∞Í≥º:', result.length === 0 ? 'null' : result);
            return result.length === 0 ? null : result; // üö® Îπà Î∞∞Ïó¥Ïù¥Î©¥ null Î∞òÌôò
        }

        // üî• ÏÉàÎ°ú Ï∂îÍ∞Ä: ÏÑ†ÌÉùÎêú Ïä§ÌÇ®Ïã≠Îì§ Í∞ÄÏ†∏Ïò§Í∏∞ (Îπà Î∞∞Ïó¥Ïù¥Î©¥ null Î∞òÌôò)
        function getSelectedSkinships() {
            const selectedSkinships = [];
            document.querySelectorAll('.skinship-btn.selected').forEach(btn => {
                selectedSkinships.push(btn.dataset.skinship);
            });
            console.log('üéØ ÏÑ†ÌÉùÎêú Ïä§ÌÇ®Ïã≠:', selectedSkinships);
            const result = selectedSkinships.slice(0, 4); // ÏµúÎåÄ 4Í∞ú
            return result.length === 0 ? null : result; // üö® Îπà Î∞∞Ïó¥Ïù¥Î©¥ null Î∞òÌôò
        }

        // === AI Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±Í∏∞ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï¥àÍ∏∞Ìôî ===
        function initializeCharacterGeneratorEvents() {
            // MBTI Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('mbti-btn')) {
                    if (e.target.classList.contains('selected')) {
                        // Ïù¥ÎØ∏ ÏÑ†ÌÉùÎêú Í≤ÉÏùÑ Îã§Ïãú ÌÅ¥Î¶≠ ‚Üí Ìï¥Ï†ú
                        e.target.classList.remove('selected');
                        document.getElementById('charMbti').value = '';
                        console.log('‚úÖ MBTI ÏÑ†ÌÉù Ìï¥Ï†úÎê®');
                    } else {
                        // ÏÉàÎ°úÏö¥ ÏÑ†ÌÉù
                        document.querySelectorAll('.mbti-btn').forEach(btn => btn.classList.remove('selected'));
                        e.target.classList.add('selected');
                        const selectedMbti = e.target.dataset.mbti;
                        document.getElementById('charMbti').value = selectedMbti;
                        console.log('‚úÖ MBTI ÏÑ†ÌÉùÎê®:', selectedMbti);
                    }
                }

                // ÏÑ±Í≤© ÌäπÏÑ± Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ (ÏµúÎåÄ 3Í∞ú ÏÑ†ÌÉù)
                if (e.target.classList.contains('trait-btn')) {
                    console.log('üéØüéØüéØ ÏÑ±Í≤©ÌäπÏÑ± Î≤ÑÌäº ÌÅ¥Î¶≠Îê®:', e.target.getAttribute('data-trait'));
                    console.log('üéØ ÌòÑÏû¨ Î≤ÑÌäº ÌÅ¥ÎûòÏä§:', e.target.className);
                    console.log('üéØ ÌòÑÏû¨ Î≤ÑÌäº selected Ïó¨Î∂Ä:', e.target.classList.contains('selected'));

                    const selectedTraits = document.querySelectorAll('.trait-btn.selected').length;
                    console.log('üéØ Ï†ÑÏ≤¥ ÏÑ†ÌÉùÎêú Í∞úÏàò:', selectedTraits);

                    // üîÑ Ïù¥Î≤§Ìä∏ Ï†ÑÌåå Î®ºÏ†Ä Î∞©ÏßÄ (Îã§Î•∏ Ìï∏Îì§Îü¨ Í∞ÑÏÑ≠ Î∞©ÏßÄ)
                    e.preventDefault();
                    e.stopPropagation();

                    if (e.target.classList.contains('selected')) {
                        console.log('üî¥ ÏÑ†ÌÉù Ìï¥Ï†ú Î∂ÑÍ∏∞ ÏßÑÏûÖ');
                        e.target.classList.remove('selected');
                        console.log('‚ùå ÏÑ±Í≤©ÌäπÏÑ± Ìï¥Ï†ú ÏôÑÎ£å:', e.target.getAttribute('data-trait'));
                        console.log('üî¥ Ìï¥Ï†ú ÌõÑ ÌÅ¥ÎûòÏä§:', e.target.className);
                        console.log('üî¥ Ìï¥Ï†ú ÌõÑ selected ÏÉÅÌÉú:', e.target.classList.contains('selected'));
                    } else if (selectedTraits < 3) {
                        console.log('üü¢ ÏÉà ÏÑ†ÌÉù Î∂ÑÍ∏∞ ÏßÑÏûÖ');
                        e.target.classList.add('selected');
                        console.log('‚úÖ ÏÑ±Í≤©ÌäπÏÑ± ÏÑ†ÌÉù ÏôÑÎ£å:', e.target.getAttribute('data-trait'));
                        console.log('üü¢ ÏÑ†ÌÉù ÌõÑ ÌÅ¥ÎûòÏä§:', e.target.className);
                        console.log('üü¢ ÏÑ†ÌÉù ÌõÑ selected ÏÉÅÌÉú:', e.target.classList.contains('selected'));
                    } else {
                        console.log('üü° ÌïúÎèÑ Ï¥àÍ≥º Î∂ÑÍ∏∞ ÏßÑÏûÖ');
                        alert('ÏÑ±Í≤© ÌäπÏÑ±ÏùÄ ÏµúÎåÄ 3Í∞úÍπåÏßÄÎßå ÏÑ†ÌÉù Í∞ÄÎä•Ìï©ÎãàÎã§.');
                        console.log('‚ö†Ô∏è ÏÑ±Í≤©ÌäπÏÑ± ÏÑ†ÌÉù ÌïúÎèÑ Ï¥àÍ≥º');
                    }

                    // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÌäπÏÑ±Îì§ ÌëúÏãú
                    const currentSelected = [];
                    document.querySelectorAll('.trait-btn.selected').forEach(btn => {
                        currentSelected.push(btn.getAttribute('data-trait'));
                    });
                    console.log('üìã ÏµúÏ¢Ö ÏÑ†ÌÉùÎêú ÏÑ±Í≤©ÌäπÏÑ±Îì§:', currentSelected);

                    // Hidden input ÏóÖÎç∞Ïù¥Ìä∏
                    updatePersonalityTraitsHiddenInput();

                    return false; // Ï∂îÍ∞Ä Ïù¥Î≤§Ìä∏ Ï†ÑÌåå Î∞©ÏßÄ
                }

                // Í¥ÄÍ≥Ñ ÏÑ§Ï†ï Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
                if (e.target.classList.contains('relationship-btn')) {
                    if (e.target.classList.contains('selected')) {
                        // Ïù¥ÎØ∏ ÏÑ†ÌÉùÎêú Í≤ÉÏùÑ Îã§Ïãú ÌÅ¥Î¶≠ ‚Üí Ìï¥Ï†ú
                        e.target.classList.remove('selected');
                        document.getElementById('charRelationship').value = '';
                        console.log('‚úÖ Í¥ÄÍ≥Ñ ÏÑ§Ï†ï Ìï¥Ï†úÎê®');
                    } else {
                        // ÏÉàÎ°úÏö¥ ÏÑ†ÌÉù
                        document.querySelectorAll('.relationship-btn').forEach(btn => btn.classList.remove('selected'));
                        e.target.classList.add('selected');
                        document.getElementById('charRelationship').value = e.target.dataset.rel;
                        console.log('‚úÖ Í¥ÄÍ≥Ñ ÏÑ§Ï†ï ÏÑ†ÌÉùÎê®:', e.target.dataset.rel);
                    }
                }

                // Ï∑®ÎØ∏ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ (ÏµúÎåÄ 3Í∞ú ÏÑ†ÌÉù)
                if (e.target.classList.contains('hobby-btn')) {
                    const selectedHobbies = document.querySelectorAll('.hobby-btn.selected').length;

                    if (e.target.classList.contains('selected')) {
                        e.target.classList.remove('selected');
                    } else if (selectedHobbies < 3) {
                        e.target.classList.add('selected');
                    } else {
                        alert('Ï∑®ÎØ∏Îäî ÏµúÎåÄ 3Í∞úÍπåÏßÄÎßå ÏÑ†ÌÉù Í∞ÄÎä•Ìï©ÎãàÎã§.');
                    }

                    // Hidden input ÏóÖÎç∞Ïù¥Ìä∏
                    updateHobbiesHiddenInput();
                }

                // ÎßêÌà¨ Ïä§ÌÉÄÏùº Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
                if (e.target.classList.contains('speech-btn')) {
                    if (e.target.classList.contains('selected')) {
                        // Ïù¥ÎØ∏ ÏÑ†ÌÉùÎêú Í≤ÉÏùÑ Îã§Ïãú ÌÅ¥Î¶≠ ‚Üí Ìï¥Ï†ú
                        e.target.classList.remove('selected');
                        document.getElementById('charSpeechStyle').value = '';
                        console.log('‚úÖ ÎßêÌà¨ Ïä§ÌÉÄÏùº Ìï¥Ï†úÎê®');
                    } else {
                        // ÏÉàÎ°úÏö¥ ÏÑ†ÌÉù
                        document.querySelectorAll('.speech-btn').forEach(btn => btn.classList.remove('selected'));
                        e.target.classList.add('selected');
                        document.getElementById('charSpeechStyle').value = e.target.dataset.speech;
                        console.log('‚úÖ ÎßêÌà¨ Ïä§ÌÉÄÏùº ÏÑ†ÌÉùÎê®:', e.target.dataset.speech);
                    }
                }

                // üí´ Îß§Î†• Ìè¨Ïù∏Ìä∏ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ (ÏµúÎåÄ 4Í∞ú ÏÑ†ÌÉù)
                if (e.target.classList.contains('charm-btn')) {
                    const selectedCharms = document.querySelectorAll('.charm-btn.selected').length;

                    if (e.target.classList.contains('selected')) {
                        e.target.classList.remove('selected');
                    } else if (selectedCharms < 4) {
                        e.target.classList.add('selected');
                    } else {
                        alert('Îß§Î†• Ìè¨Ïù∏Ìä∏Îäî ÏµúÎåÄ 4Í∞úÍπåÏßÄÎßå ÏÑ†ÌÉù Í∞ÄÎä•Ìï©ÎãàÎã§.');
                    }
                    console.log('‚úÖ Îß§Î†• Ìè¨Ïù∏Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏:', getSelectedCharms());
                }

                // üß† ÌïµÏã¨ ÏöïÍµ¨ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ (ÏµúÎåÄ 3Í∞ú ÏÑ†ÌÉù)
                if (e.target.classList.contains('desire-btn')) {
                    const selectedDesires = document.querySelectorAll('.desire-btn.selected').length;

                    if (e.target.classList.contains('selected')) {
                        e.target.classList.remove('selected');
                    } else if (selectedDesires < 3) {
                        e.target.classList.add('selected');
                    } else {
                        alert('ÌïµÏã¨ ÏöïÍµ¨Îäî ÏµúÎåÄ 3Í∞úÍπåÏßÄÎßå ÏÑ†ÌÉù Í∞ÄÎä•Ìï©ÎãàÎã§.');
                    }
                    console.log('‚úÖ ÌïµÏã¨ ÏöïÍµ¨ ÏóÖÎç∞Ïù¥Ìä∏:', getSelectedDesires());
                }

                // üî• ÏÉàÎ°ú Ï∂îÍ∞Ä: Ïä§ÌÇ®Ïã≠ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ (ÏµúÎåÄ 4Í∞ú ÏÑ†ÌÉù)
                if (e.target.classList.contains('skinship-btn')) {
                    const selectedSkinships = document.querySelectorAll('.skinship-btn.selected').length;

                    if (e.target.classList.contains('selected')) {
                        e.target.classList.remove('selected');
                    } else if (selectedSkinships < 4) {
                        e.target.classList.add('selected');
                    } else {
                        alert('Ï¢ãÏïÑÌïòÎäî Ïä§ÌÇ®Ïã≠ÏùÄ ÏµúÎåÄ 4Í∞úÍπåÏßÄÎßå ÏÑ†ÌÉù Í∞ÄÎä•Ìï©ÎãàÎã§.');
                    }
                    console.log('‚úÖ ÏÑ†ÌÉùÎêú Ïä§ÌÇ®Ïã≠:', getSelectedSkinships());
                }

                // üÜï ÎåÄÌôîÏó≠Ìïô: ÌîåÎü¨ÌåÖ Ìå®ÌÑ¥ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ (ÏµúÎåÄ 3Í∞ú ÏÑ†ÌÉù)
                if (e.target.classList.contains('flirting-btn')) {
                    const selectedFlirting = document.querySelectorAll('.flirting-btn.selected').length;

                    if (e.target.classList.contains('selected')) {
                        e.target.classList.remove('selected');
                    } else if (selectedFlirting < 3) {
                        e.target.classList.add('selected');
                    } else {
                        alert('ÌîåÎü¨ÌåÖ Ìå®ÌÑ¥ÏùÄ ÏµúÎåÄ 3Í∞úÍπåÏßÄÎßå ÏÑ†ÌÉù Í∞ÄÎä•Ìï©ÎãàÎã§.');
                    }
                    console.log('‚úÖ ÏÑ†ÌÉùÎêú ÌîåÎü¨ÌåÖ Ìå®ÌÑ¥:', getSelectedFlirtingPatterns());
                }

                // üÜï ÎåÄÌôîÏó≠Ìïô: ÎåÄÌôî ÌõÖ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ (ÏµúÎåÄ 4Í∞ú ÏÑ†ÌÉù)
                if (e.target.classList.contains('hook-btn')) {
                    const selectedHooks = document.querySelectorAll('.hook-btn.selected').length;

                    if (e.target.classList.contains('selected')) {
                        e.target.classList.remove('selected');
                    } else if (selectedHooks < 4) {
                        e.target.classList.add('selected');
                    } else {
                        alert('ÎåÄÌôî ÌõÖÏùÄ ÏµúÎåÄ 4Í∞úÍπåÏßÄÎßå ÏÑ†ÌÉù Í∞ÄÎä•Ìï©ÎãàÎã§.');
                    }
                    console.log('‚úÖ ÏÑ†ÌÉùÎêú ÎåÄÌôî ÌõÖ:', getSelectedConversationHooks());
                }

                // üÜï ÎåÄÌôîÏó≠Ìïô: ÌóàÏö© Î™®Ìã∞ÌîÑ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ (ÏµúÎåÄ 5Í∞ú ÏÑ†ÌÉù)
                if (e.target.classList.contains('motif-btn')) {
                    const selectedMotifs = document.querySelectorAll('.motif-btn.selected').length;

                    if (e.target.classList.contains('selected')) {
                        e.target.classList.remove('selected');
                    } else if (selectedMotifs < 5) {
                        e.target.classList.add('selected');
                    } else {
                        alert('ÌóàÏö© ÎåÄÌôî Ï£ºÏ†úÎäî ÏµúÎåÄ 5Í∞úÍπåÏßÄÎßå ÏÑ†ÌÉù Í∞ÄÎä•Ìï©ÎãàÎã§.');
                    }
                    console.log('‚úÖ ÏÑ†ÌÉùÎêú ÌóàÏö© Î™®Ìã∞ÌîÑ:', getSelectedAllowedMotifs());
                }

                // üÜï ÏûêÏã†ÏûàÎäî Î∂ÄÏúÑ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ (ÏµúÎåÄ 3Í∞ú ÏÑ†ÌÉù)
                if (e.target.classList.contains('confident-part-btn')) {
                    const selectedParts = document.querySelectorAll('.confident-part-btn.selected').length;

                    if (e.target.classList.contains('selected')) {
                        e.target.classList.remove('selected');
                    } else if (selectedParts < 3) {
                        e.target.classList.add('selected');
                    } else {
                        alert('ÏûêÏã†ÏûàÎäî Î∂ÄÏúÑÎäî ÏµúÎåÄ 3Í∞úÍπåÏßÄÎßå ÏÑ†ÌÉù Í∞ÄÎä•Ìï©ÎãàÎã§.');
                    }

                    // Hidden input ÏóÖÎç∞Ïù¥Ìä∏
                    updateFeatureElementsHiddenInput();
                    console.log('‚úÖ ÏÑ†ÌÉùÎêú ÏûêÏã†ÏûàÎäî Î∂ÄÏúÑ:', getSelectedFeatureElements());
                }

                // üÜï ÏÑπÏãúÌè¨Ï¶à Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ (ÏµúÎåÄ 2Í∞ú ÏÑ†ÌÉù)
                if (e.target.classList.contains('seductive-pose-btn')) {
                    const selectedPoses = document.querySelectorAll('.seductive-pose-btn.selected').length;

                    if (e.target.classList.contains('selected')) {
                        e.target.classList.remove('selected');
                    } else if (selectedPoses < 2) {
                        e.target.classList.add('selected');
                    } else {
                        alert('ÏÑπÏãúÌè¨Ï¶àÎäî ÏµúÎåÄ 2Í∞úÍπåÏßÄÎßå ÏÑ†ÌÉù Í∞ÄÎä•Ìï©ÎãàÎã§.');
                    }

                    // Hidden input ÏóÖÎç∞Ïù¥Ìä∏
                    updateSensualHabitsHiddenInput();
                    console.log('‚úÖ ÏÑ†ÌÉùÎêú ÏÑπÏãúÌè¨Ï¶à:', getSelectedSensualHabits());
                }

                // üéÅ Ï¢ãÏïÑÌïòÎäî ÏÑ†Î¨º Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ (ÏµúÎåÄ 3Í∞ú ÏÑ†ÌÉù)
                if (e.target.classList.contains('gift-btn')) {
                    const selectedGifts = document.querySelectorAll('.gift-btn.selected').length;

                    if (e.target.classList.contains('selected')) {
                        e.target.classList.remove('selected');
                    } else if (selectedGifts < 3) {
                        e.target.classList.add('selected');
                    } else {
                        alert('Ï¢ãÏïÑÌïòÎäî ÏÑ†Î¨ºÏùÄ ÏµúÎåÄ 3Í∞úÍπåÏßÄÎßå ÏÑ†ÌÉù Í∞ÄÎä•Ìï©ÎãàÎã§.');
                    }
                    console.log('‚úÖ ÏÑ†ÌÉùÎêú Ï¢ãÏïÑÌïòÎäî ÏÑ†Î¨º:', getSelectedFavoriteGifts());
                }

                // üíï Ìù•Î∂ÑÏãú Î∞òÏùë Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ (ÏµúÎåÄ 2Í∞ú ÏÑ†ÌÉù)
                if (e.target.classList.contains('body-language-btn')) {
                    const selectedLanguages = document.querySelectorAll('.body-language-btn.selected').length;

                    if (e.target.classList.contains('selected')) {
                        e.target.classList.remove('selected');
                    } else if (selectedLanguages < 2) {
                        e.target.classList.add('selected');
                    } else {
                        alert('Ìù•Î∂ÑÏãú Î∞òÏùëÏùÄ ÏµúÎåÄ 2Í∞úÍπåÏßÄÎßå ÏÑ†ÌÉù Í∞ÄÎä•Ìï©ÎãàÎã§.');
                    }

                    // Hidden input ÏóÖÎç∞Ïù¥Ìä∏
                    updateBodyLanguageHiddenInput();
                    console.log('‚úÖ ÏÑ†ÌÉùÎêú Ìù•Î∂ÑÏãú Î∞òÏùë:', getSelectedBodyLanguage());
                }

                // üó£Ô∏è ÎßêÌà¨ ÏäµÍ¥Ä Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ (ÏµúÎåÄ 3Í∞ú ÏÑ†ÌÉù)
                if (e.target.classList.contains('speech-habit-btn')) {
                    const selectedHabits = document.querySelectorAll('.speech-habit-btn.selected').length;

                    if (e.target.classList.contains('selected')) {
                        e.target.classList.remove('selected');
                    } else if (selectedHabits < 3) {
                        e.target.classList.add('selected');
                    } else {
                        alert('ÎßêÌà¨ ÏäµÍ¥ÄÏùÄ ÏµúÎåÄ 3Í∞úÍπåÏßÄÎßå ÏÑ†ÌÉù Í∞ÄÎä•Ìï©ÎãàÎã§.');
                    }
                    console.log('‚úÖ ÏÑ†ÌÉùÎêú ÎßêÌà¨ ÏäµÍ¥Ä:', getSelectedSpeechHabits());
                }

                // üö´ Í∏àÏßÄ Î∂ÑÏïº Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ (ÏµúÎåÄ 4Í∞ú ÏÑ†ÌÉù)
                if (e.target.classList.contains('forbidden-topic-btn')) {
                    const selectedTopics = document.querySelectorAll('.forbidden-topic-btn.selected').length;

                    if (e.target.classList.contains('selected')) {
                        e.target.classList.remove('selected');
                    } else if (selectedTopics < 4) {
                        e.target.classList.add('selected');
                    } else {
                        alert('Í∏àÏßÄ Î∂ÑÏïºÎäî ÏµúÎåÄ 4Í∞úÍπåÏßÄÎßå ÏÑ†ÌÉù Í∞ÄÎä•Ìï©ÎãàÎã§.');
                    }
                    console.log('‚úÖ ÏÑ†ÌÉùÎêú Í∏àÏßÄ Î∂ÑÏïº:', getSelectedForbiddenTopics());
                }

                // üë® ÎÇ®Ïûê Ïö∞ÏÑ†ÏàúÏúÑ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ (ÏµúÎåÄ 3Í∞ú ÏÑ†ÌÉù)
                if (e.target.classList.contains('male-priority-btn')) {
                    const selectedPriorities = document.querySelectorAll('.male-priority-btn.selected').length;

                    if (e.target.classList.contains('selected')) {
                        e.target.classList.remove('selected');
                    } else if (selectedPriorities < 3) {
                        e.target.classList.add('selected');
                    } else {
                        alert('ÎÇ®ÏûêÎ•º Î≥º Îïå ÏµúÏö∞ÏÑ†Ïãú ÌïòÎäî Í≤ÉÏùÄ ÏµúÎåÄ 3Í∞úÍπåÏßÄÎßå ÏÑ†ÌÉù Í∞ÄÎä•Ìï©ÎãàÎã§.');
                    }
                    console.log('‚úÖ ÏÑ†ÌÉùÎêú ÎÇ®Ïûê Ïö∞ÏÑ†ÏàúÏúÑ:', getSelectedMalePriorities());
                }

                // üéÜ ÎØ∏Îûò ÏßÅÏóÖ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ (ÏµúÎåÄ 2Í∞ú ÏÑ†ÌÉù)
                if (e.target.classList.contains('career-btn')) {
                    const selectedCareers = document.querySelectorAll('.career-btn.selected').length;

                    if (e.target.classList.contains('selected')) {
                        e.target.classList.remove('selected');
                    } else if (selectedCareers < 2) {
                        e.target.classList.add('selected');
                    } else {
                        alert('ÎØ∏Îûò ÏßÅÏóÖÏùÄ ÏµúÎåÄ 2Í∞úÍπåÏßÄÎßå ÏÑ†ÌÉù Í∞ÄÎä•Ìï©ÎãàÎã§.');
                    }
                    console.log('‚úÖ ÏÑ†ÌÉùÎêú ÎØ∏Îûò ÏßÅÏóÖ:', getSelectedFutureCareers());
                }
            });
        }

        // === AI Ï∫êÎ¶≠ÌÑ∞ ÏûêÎèô ÏÉùÏÑ± Ìï®Ïàò (DEPRECATED) ===
        async function generateAICharacter() {
            console.warn('‚ö†Ô∏è AI ÏÉùÏÑ± Í∏∞Îä•Ïù¥ ÎπÑÌôúÏÑ±ÌôîÎêòÏóàÏäµÎãàÎã§. ÎûúÎç§ ÏÑ†ÌÉù Í∏∞Îä•ÏùÑ ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî.');
            return;
            // Ïù¥Ìïò ÏΩîÎìú ÎπÑÌôúÏÑ±Ìôî
            const statusDiv = null; // document.getElementById('aiGenerationStatus');
            const previewDiv = null; // document.getElementById('characterPreview');
            
            statusDiv.innerHTML = 'ü§ñ AIÍ∞Ä Ï∫êÎ¶≠ÌÑ∞Î•º ÏÉùÏÑ±ÌïòÍ≥† ÏûàÏäµÎãàÎã§...';
            
            try {
                // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Îç∞Ïù¥ÌÑ∞ ÏàòÏßë
                const currentData = collectCharacterData();
                
                // ÏÑ∏ÏÖòÏóêÏÑú API ÌÇ§ Í∞ÄÏ†∏Ïò§Í∏∞
                const sessionApiKey = sessionStorage.getItem('openai_api_key');
                
                // AI API Ìò∏Ï∂ú (character-ai-generator.js ÏÇ¨Ïö©)
                const response = await fetch('/api/character-ai-generator', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                        // OpenAI ÌÇ§Îäî ÏÑúÎ≤ÑÏÇ¨Ïù¥ÎìúÏóêÏÑú ÌôòÍ≤ΩÎ≥ÄÏàòÎ°ú Ï≤òÎ¶¨
                    },
                    body: JSON.stringify({
                        action: 'generate_complete_character_with_profile',
                        ...currentData  // ÌÜµÌï© API ÏÇ¨Ïö©: answers Í∞ùÏ≤¥Î•º Î≤óÍ≤∞Í≥† ÏßÅÏ†ë Ï†ÑÏÜ°
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        statusDiv.innerHTML = '‚ú® AI ÏÉùÏÑ± ÏôÑÎ£å!';
                        displayAIGeneratedCharacter(result.character);
                        previewDiv.style.display = 'block';
                    } else {
                        throw new Error(result.message || 'AI ÏÉùÏÑ± Ïã§Ìå®');
                    }
                } else {
                    // ÏÑúÎ≤ÑÏóêÏÑú ÏÉÅÏÑ∏Ìïú Ïò§Î•ò Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                    let errorMessage = `API Ïò§Î•ò: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        console.error('üî• ÏÑúÎ≤Ñ Ïò§Î•ò ÏÉÅÏÑ∏:', errorData);
                        errorMessage = errorData.message || errorMessage;
                    } catch (parseError) {
                        console.error('‚ö†Ô∏è Ïò§Î•ò ÏùëÎãµ ÌååÏã± Ïã§Ìå®:', parseError);
                    }
                    throw new Error(errorMessage);
                }
            } catch (error) {
                console.error('‚ùå AI Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ± Ïã§Ìå®:', error);
                statusDiv.innerHTML = `‚ùå AI ÏÉùÏÑ± Ïã§Ìå®: ${error.message}`;

                // ÏÇ¨Ïö©ÏûêÏóêÍ≤å Î™ÖÌôïÌïú Ïò§Î•ò Î©îÏãúÏßÄ ÌëúÏãú
                alert(`Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ± Ïã§Ìå®\n\n${error.message}\n\nÎã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.`);
            }
        }

        // ÏÉùÏÑ±Îêú Ï∫êÎ¶≠ÌÑ∞Î•º Ï†ÄÏû•Ìï† Í∏ÄÎ°úÎ≤å Î≥ÄÏàò
        let generatedCharacter = null;

        // AI ÏÉùÏÑ± Í≤∞Í≥º ÌëúÏãú (ÏÉàÎ°úÏö¥ Ïä§ÌÇ§Îßà ÎåÄÏùë)
        function displayAIGeneratedCharacter(character) {
            // Í∏ÄÎ°úÎ≤å Î≥ÄÏàòÏóê Ï†ÄÏû•
            generatedCharacter = character;

            console.log('üé≠ ÏÉùÏÑ±Îêú Ï∫êÎ¶≠ÌÑ∞ Ï†ÑÏ≤¥ Ï†ïÎ≥¥:', character);

            const previewDiv = document.getElementById('characterPreview');
            previewDiv.innerHTML = `
                <h4>üé≠ AI ÏÉùÏÑ±Í≤∞Í≥ºÎ≥¥Í∏∞</h4>
                <div class="character-preview-content">
                    <div class="preview-section">
                        <h5>üë§ Í∏∞Î≥∏ Ï†ïÎ≥¥</h5>
                        <p><strong>Ïù¥Î¶Ñ:</strong> ${character.basic_info?.name || character.name || 'Ïù¥Î¶Ñ ÏóÜÏùå'}</p>
                        <p><strong>ÎÇòÏù¥:</strong> ${character.basic_info?.age || character.age || 'ÎÇòÏù¥ Ï†ïÎ≥¥ ÏóÜÏùå'}ÏÑ∏</p>
                        <p><strong>MBTI:</strong> ${character.basic_info?.mbti || character.mbti || 'MBTI Ï†ïÎ≥¥ ÏóÜÏùå'}</p>
                        <p><strong>ÏßÅÏóÖ/Ï†ÑÍ≥µ:</strong> ${translateToKorean(character.basic_info?.occupation || character.major || 'unknown', 'occupation')}</p>
                    </div>

                    <div class="preview-section">
                        <h5>üí´ Îß§Î†• ÌîÑÎ°úÌïÑ</h5>
                        <p><strong>Ïú†Ìòπ Ïä§ÌÉÄÏùº:</strong> ${translateToKorean(character.appeal_profile?.seduction_style || 'unknown', 'seduction_style')}</p>
                        <p><strong>Îß§Î†• Ìè¨Ïù∏Ìä∏:</strong> ${Array.isArray(character.appeal_profile?.charm_points) ? character.appeal_profile.charm_points.map(charm => translateToKorean(charm, 'charm_points')).join(', ') : 'Ï†ïÎ≥¥ ÏóÜÏùå'}</p>
                        <p><strong>Í∞êÏÑ± ÏßÄÎä•:</strong> ${character.appeal_profile?.emotional_intelligence || 'Ï†ïÎ≥¥ ÏóÜÏùå'}/10</p>
                        <p><strong>ÏûêÏã†Í∞ê:</strong> ${character.appeal_profile?.confidence_level || 'Ï†ïÎ≥¥ ÏóÜÏùå'}/10</p>
                        <p><strong>Ïã†ÎπÑÎ°úÏõÄ:</strong> ${character.appeal_profile?.mystery_factor || 'Ï†ïÎ≥¥ ÏóÜÏùå'}/10</p>
                    </div>

                    <div class="preview-section">
                        <h5>üëÄ Ïô∏Î™® & Ïä§ÌÉÄÏùº</h5>
                        <p><strong>ÌäπÏßïÏ†Å Ïô∏Î™®:</strong> ${Array.isArray(character.physical_allure?.signature_features) ? character.physical_allure.signature_features.join(', ') : 'Ï†ïÎ≥¥ ÏóÜÏùå'}</p>
                        <p><strong>Ìó§Ïñ¥Ïä§ÌÉÄÏùº:</strong> ${translateToKorean(character.physical_allure?.appearance?.hair || character.appearance?.hair || character.hair || 'unknown', 'hair')}</p>
                        <p><strong>Îàà:</strong> ${translateToKorean(character.physical_allure?.appearance?.eyes || character.appearance?.eyes || character.eyes || 'unknown', 'eyes')}</p>
                        <p><strong>Ï≤¥Ìòï:</strong> ${translateToKorean(character.physical_allure?.appearance?.body || character.appearance?.body || character.body || 'unknown', 'body')}</p>
                        <p><strong>Í∞ÄÏä¥:</strong> ${translateToKorean(character.physical_allure?.appearance?.bust || character.appearance?.bust || character.bust || 'unknown', 'bust')}</p>
                        <p><strong>ÌóàÎ¶¨/ÏóâÎç©Ïù¥:</strong> ${translateToKorean(character.physical_allure?.appearance?.waist_hip || character.appearance?.waist_hip || character.waist_hip || 'unknown', 'waist_hip')}</p>
                        <p><strong>Ìå®ÏÖò:</strong> ${translateToKorean(character.physical_allure?.appearance?.style || character.appearance?.style || character.style || 'unknown', 'style')}</p>
                        <p><strong>Îß§Î†•Ï†Å ÏäµÍ¥Ä:</strong> ${Array.isArray(character.physical_allure?.sensual_habits) ? character.physical_allure.sensual_habits.map(habit => translateToKorean(habit, 'sensual_habits')).join(', ') : 'Ï†ïÎ≥¥ ÏóÜÏùå'}</p>
                    </div>

                    <div class="preview-section">
                        <h5>üß† Ïã¨Î¶¨Ï†Å ÍπäÏù¥</h5>
                        <p><strong>ÌïµÏã¨ ÏöïÍµ¨:</strong> ${Array.isArray(character.psychological_depth?.core_desires) ? character.psychological_depth.core_desires.map(desire => translateToKorean(desire, 'core_desires')).join(', ') : 'Ï†ïÎ≥¥ ÏóÜÏùå'}</p>
                        <p><strong>Ï∑®ÏïΩÏ†ê:</strong> ${Array.isArray(character.psychological_depth?.vulnerabilities) ? character.psychological_depth.vulnerabilities.map(vul => translateToKorean(vul, 'vulnerabilities')).join(', ') : 'Ï†ïÎ≥¥ ÏóÜÏùå'}</p>
                        <p><strong>Í≤ΩÍ≥ÑÏÑ†:</strong> ${translateToKorean(character.psychological_depth?.boundaries?.comfort_level || 'unknown', 'comfort_level')}</p>
                        <p><strong>Î∞úÏ†Ñ ÏÜçÎèÑ:</strong> ${translateToKorean(character.psychological_depth?.boundaries?.escalation_pace || 'unknown', 'escalation_pace')}</p>
                        <p><strong>ÏÑ±Ï†Å ÌÜ§ Î∞¥Îìú:</strong> ${translateToKorean(character.psychological_depth?.boundaries?.sexual_tone_band || 'unknown', 'sexual_tone_band')}</p>
                        <p><strong>ÏÑ±Ï†Å ÏûêÏú†Î∂ÑÎ∞©Ìï®:</strong> ${character.psychological_depth?.sexual_freedom ? character.psychological_depth.sexual_freedom + '/10' : 'Ï†ïÎ≥¥ ÏóÜÏùå'}</p>
                    </div>

                    <div class="preview-section">
                        <h5>üí¨ ÎåÄÌôî ÌäπÏÑ±</h5>
                        <p><strong>ÌîåÎü¨ÌåÖ Ìå®ÌÑ¥:</strong> ${Array.isArray(character.conversation_dynamics?.flirtation_patterns) ? character.conversation_dynamics.flirtation_patterns.map(pattern => translateToKorean(pattern, 'flirting_patterns')).join(', ') : 'Ï†ïÎ≥¥ ÏóÜÏùå'}</p>
                        <p><strong>ÎåÄÌôî ÌõÖ:</strong> ${Array.isArray(character.conversation_dynamics?.conversation_hooks) ? character.conversation_dynamics.conversation_hooks.map(hook => translateToKorean(hook, 'conversation_hooks')).join(', ') : 'Ï†ïÎ≥¥ ÏóÜÏùå'}</p>
                        <p><strong>ÎßêÌà¨:</strong> ${translateToKorean(character.conversation_dynamics?.speech_style || character.speech_style || 'unknown', 'speech_style')}</p>
                        <p><strong>Ï£ºÎ°úÏì∞Îäî Ìò∏Ïπ≠:</strong> ${character.speech_habit || 'Ïò§Îπ†'}</p>
                    </div>

                    <div class="preview-section">
                        <h5>üè† Î∞∞Í≤Ω & Ï∑®ÎØ∏</h5>
                        <p><strong>Í∞ÄÏ°±:</strong> ${character.basic_info?.family_structure || character.family_structure || 'Í∞ÄÏ°± Ï†ïÎ≥¥ ÏóÜÏùå'}</p>
                        <p><strong>Í≥†Ìñ•:</strong> ${character.basic_info?.hometown || character.hometown || 'Í≥†Ìñ• Ï†ïÎ≥¥ ÏóÜÏùå'}</p>
                        <p><strong>Í¥ÄÍ≥Ñ:</strong> ${character.relationship || 'Í¥ÄÍ≥Ñ Ï†ïÎ≥¥ ÏóÜÏùå'}</p>
                        <p><strong>Ï∑®ÎØ∏:</strong> ${Array.isArray(character.hobbies) ? character.hobbies.map(hobby => translateToKorean(hobby, 'hobbies')).join(', ') : translateToKorean(character.hobbies || 'unknown', 'hobbies')}</p>
                        <p><strong>Í∞ÄÏπòÍ¥Ä:</strong> ${translateToKorean(character.values || 'unknown', 'values')}</p>
                    </div>

                    <div class="preview-section">
                        <h5>üé≠ Í¥ÄÍ≥Ñ ÏßÑÌñâ Îã®Í≥Ñ</h5>
                        <p><strong>Ï¥àÍ∏∞ Îß§Î†•:</strong> ${Array.isArray(character.relationship_progression?.stages?.initial_attraction?.behaviors) ? character.relationship_progression.stages.initial_attraction.behaviors.join(', ') : 'Ï†ïÎ≥¥ ÏóÜÏùå'}</p>
                        <p><strong>Í∏¥Ïû•Í∞ê ÌòïÏÑ±:</strong> ${Array.isArray(character.relationship_progression?.stages?.building_tension?.behaviors) ? character.relationship_progression.stages.building_tension.behaviors.join(', ') : 'Ï†ïÎ≥¥ ÏóÜÏùå'}</p>
                        <p><strong>ÏπúÎ∞ÄÌïú Ïó∞Í≤∞:</strong> ${Array.isArray(character.relationship_progression?.stages?.intimate_connection?.behaviors) ? character.relationship_progression.stages.intimate_connection.behaviors.join(', ') : 'Ï†ïÎ≥¥ ÏóÜÏùå'}</p>
                    </div>

                    <div class="preview-actions">
                        <button class="btn btn-primary" onclick="applyAIGeneratedData()">
                            üíñ Ïù¥ Ï∫êÎ¶≠ÌÑ∞ Ï†ÅÏö©ÌïòÍ∏∞
                        </button>
                        <button class="btn btn-secondary" onclick="generateAICharacter()" style="margin-left: 10px;">
                            üé≤ Îã§Ïãú ÏÉùÏÑ±ÌïòÍ∏∞
                        </button>
                    </div>
                </div>
            `;
        }

        // AI ÏÉùÏÑ± Îç∞Ïù¥ÌÑ∞Î•º ÌèºÏóê Ï†ÅÏö©
        async function applyAIGeneratedData() {
            if (!generatedCharacter) {
                alert('‚ö†Ô∏è Î®ºÏ†Ä AIÎ°ú Ï∫êÎ¶≠ÌÑ∞Î•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            try {
                const character = generatedCharacter;
                console.log('üé≠ AI Ï∫êÎ¶≠ÌÑ∞ Ìèº Ï†ÅÏö© ÏãúÏûë:', character);

                // Í∏∞Î≥∏ Ï†ïÎ≥¥ Ï†ÅÏö© (Ï†ÑÏó≠ safeSetValue Ìï®Ïàò ÏÇ¨Ïö©)
                safeSetValue('charName', character.name);
                safeSetValue('charAge', character.age || '22');
                safeSetValue('charMbti', character.mbti);

                // MBTI Î≤ÑÌäºÎèÑ ÏãúÍ∞ÅÏ†ÅÏúºÎ°ú ÏÑ†ÌÉù
                if (character.mbti) {
                    document.querySelectorAll('.mbti-btn').forEach(btn => {
                        if (btn.dataset && btn.dataset.mbti) {
                            btn.classList.toggle('selected', btn.dataset.mbti === character.mbti);
                        }
                    });
                }

                // ÏïàÏ†ÑÌïú Î≤ÑÌäº ÏÑ†ÌÉù Ìï®Ïàò
                function safeSelectButtons(selector, items, dataAttr) {
                    try {
                        // Í∏∞Ï°¥ ÏÑ†ÌÉù Ï¥àÍ∏∞Ìôî
                        document.querySelectorAll(`${selector}.selected`).forEach(btn => {
                            btn.classList.remove('selected');
                        });

                        // ÏÉà Ìï≠Î™© ÏÑ†ÌÉù
                        if (items && Array.isArray(items)) {
                            items.forEach(item => {
                                const btn = document.querySelector(`${selector}[${dataAttr}="${item}"]`);
                                if (btn) {
                                    btn.classList.add('selected');
                                    console.log(`‚úÖ ${selector} ÏÑ†ÌÉùÎê®:`, item);
                                }
                            });
                        }
                    } catch (error) {
                        console.warn(`‚ö†Ô∏è ${selector} ÏÑ†ÌÉù Ï§ë Ïò§Î•ò:`, error);
                    }
                }

                // ÏÑ±Í≤© ÌäπÏÑ±Í≥º Ï∑®ÎØ∏ ÏïàÏ†ÑÌïòÍ≤å Ï†ÅÏö©
                safeSelectButtons('.trait-btn', character.personality_traits, 'data-trait');
                safeSelectButtons('.hobby-btn', character.personality?.hobbies, 'data-hobby');

                console.log('üéâ AI Ï∫êÎ¶≠ÌÑ∞ Í∏∞Î≥∏ Ï†ïÎ≥¥ Ï†ÅÏö© ÏôÑÎ£å!');

                // Ï∂îÍ∞Ä Ìèº ÏöîÏÜåÎì§ÎèÑ ÏïàÏ†ÑÌïòÍ≤å Ï†ÅÏö©
                safeSetValue('charOccupation', character.occupation || character.major);
                safeSetValue('charRelationship', character.relationship);
                safeSetValue('charHair', character.appearance?.hair);
                safeSetValue('charEyes', character.appearance?.eyes);
                safeSetValue('charStyle', character.appearance?.style);
                safeSetValue('charSpeechStyle', character.speech_style);
                safeSetValue('charSpeechHabit', character.speech_habit);
                safeSetValue('charValues', character.personality?.values);
                // charGenre ÌïÑÎìú Ï†úÍ±∞Îê®
                // charMainSituation ÌïÑÎìú Ï†úÍ±∞Îê®

                console.log('‚úÖ Î™®Îì† Ìèº ÏöîÏÜå Ï†ÅÏö© ÏôÑÎ£å!');

                // ÎûúÎç§ ÏÉùÏÑ± ÏòÅÏó≠ Ïà®Í∏∞Í∏∞
                const randomStatusElement = document.getElementById('randomStatus');
                if (randomStatusElement) {
                    randomStatusElement.innerHTML = '‚úÖ Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÌèºÏóê Ï†ÅÏö©ÎêòÏóàÏäµÎãàÎã§!';
                }

                // ÏÑ±Í≥µ Î©îÏãúÏßÄÏôÄ ÏûêÎèô Ï†ÄÏû• Ïó¨Î∂Ä ÌôïÏù∏
                const autoSave = confirm('üíñ AI ÏÉùÏÑ± Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÌèºÏóê Ï†ÅÏö©ÎêòÏóàÏäµÎãàÎã§!\n\nÎ∞îÎ°ú Ï†ÄÏû•ÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\n‚Ä¢ ÌôïÏù∏: Î∞îÎ°ú Ï†ÄÏû•\n‚Ä¢ Ï∑®ÏÜå: ÏàòÏ†ï ÌõÑ Ï†ÄÏû•');

                if (autoSave) {
                    console.log('üöÄ ÏûêÎèô Ï†ÄÏû• ÏãúÏûë...');
                    await window.saveCharacter();
                } else {
                    alert('‚úÖ Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥Í∞Ä ÌèºÏóê Ï†ÅÏö©ÎêòÏóàÏäµÎãàÎã§.\nÏàòÏ†ïÏù¥ ÌïÑÏöîÌïòÎ©¥ ÌèºÏùÑ Ìé∏ÏßëÌïú ÌõÑ "Ï†ÄÏû•" Î≤ÑÌäºÏùÑ ÎàåÎü¨Ï£ºÏÑ∏Ïöî.');
                }

            } catch (error) {
                console.error('‚ùå AI Îç∞Ïù¥ÌÑ∞ Ï†ÅÏö© Ïò§Î•ò:', error);
                console.error('Ïò§Î•ò ÏÉÅÏÑ∏:', error.stack);

                // Íµ¨Ï≤¥Ï†ÅÏù∏ Ïò§Î•ò Î©îÏãúÏßÄ Ï†úÍ≥µ
                let errorMessage = 'Îç∞Ïù¥ÌÑ∞ Ï†ÅÏö© Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§:\n\n';
                errorMessage += `Ïò§Î•ò: ${error.message}\n\n`;
                errorMessage += 'Ìï¥Í≤∞Ï±Ö:\n';
                errorMessage += '1. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Î≥¥ÏÑ∏Ïöî\n';
                errorMessage += '2. AI Ï∫êÎ¶≠ÌÑ∞Î•º Îã§Ïãú ÏÉùÏÑ±Ìï¥Î≥¥ÏÑ∏Ïöî\n';
                errorMessage += '3. ÏàòÎèôÏúºÎ°ú Ï†ïÎ≥¥Î•º ÏûÖÎ†•Ìï¥Î≥¥ÏÑ∏Ïöî';

                alert(errorMessage);
            }
        }

        // Fallback Ïó¨ÏÑ± Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±
        // generateFallbackFemaleCharacter Ìï®Ïàò Ï†úÍ±∞Îê® - fallback Ï≤òÎ¶¨ ÏïàÌï®

        // Í¥ÄÍ≥Ñ Î≤àÏó≠ Ìï®Ïàò
        function translateRelationship(rel) {
            const translations = {
                'secret_crush': 'Î™∞Îûò Ï¢ãÏïÑÌïòÎäî ÌõÑÎ∞∞',
                'childhood_friend': 'Ïñ¥Î¶¥ ÎïåÎ∂ÄÌÑ∞ ÏπúÌïú ÏπúÍµ¨', 
                'senior_friend': 'Îã§Ï†ïÌïú ÏÑ†Î∞∞',
                'classmate': 'Í∞ôÏùÄ Í≥º ÎèôÍ∏∞',
                'club_mate': 'ÎèôÏïÑÎ¶¨ ÏÑ†ÌõÑÎ∞∞',
                'neighbor': 'ÏòÜÏßë Ïù¥ÏõÉ'
            };
            return translations[rel] || rel;
        }

        // ÎßêÌà¨ Î≤àÏó≠ Ìï®Ïàò
        function translateSpeechStyle(style) {
            const translations = {
                'soft_warm': 'Î∂ÄÎìúÎüΩÍ≥† Îî∞ÎúªÌïú',
                'bright_cheerful': 'Î∞ùÍ≥† Í≤ΩÏæåÌïú',
                'gentle_caring': 'Îã§Ï†ïÌïòÍ≥† Î∞∞Î†§ÍπäÏùÄ',
                'shy_cute': 'ÏàòÏ§çÍ≥† Í∑ÄÏó¨Ïö¥',
                'mature_elegant': 'ÏÑ±ÏàôÌïòÍ≥† Ïö∞ÏïÑÌïú',
                'playful_fun': 'Ïû•ÎÇúÏä§ÎüΩÍ≥† Ïû¨ÎØ∏ÏûàÎäî',
                'sexy_flirty': 'ÏÑπÏãúÌïòÍ≥† Ïú†ÌòπÏ†ÅÏù∏',
                'mysterious_seductive': 'Ïã†ÎπÑÎ°≠Í≥† Îß§ÌòπÏ†ÅÏù∏',
                'cute_naughty': 'Í∑ÄÏóΩÍ≤å ÏùëÌÅºÌïú'
            };
            return translations[style] || style;
        }

        async function deleteCharacter(characterId) {
            if (!confirm('Ï†ïÎßêÎ°ú Ïù¥ Ï∫êÎ¶≠ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                return;
            }

            try {
                console.log('üóëÔ∏è Ï∫êÎ¶≠ÌÑ∞ ÏÇ≠Ï†ú ÏãúÏûë (LocalStorage):', characterId);
                
                // LocalStorageÏóêÏÑú Ï∫êÎ¶≠ÌÑ∞ ÏÇ≠Ï†ú
                const existingChars = localStorage.getItem('characters');
                const charactersData = existingChars ? JSON.parse(existingChars) : {};
                
                if (charactersData[characterId]) {
                    // Ï∫êÎ¶≠ÌÑ∞ ÏÇ≠Ï†ú
                    delete charactersData[characterId];
                    
                    // LocalStorageÏóê Ï†ÄÏû•
                    localStorage.setItem('characters', JSON.stringify(charactersData));
                    
                    // Ï†ÑÏó≠ Î≥ÄÏàòÏóêÏÑúÎèÑ ÏÇ≠Ï†ú
                    if (characters[characterId]) {
                        delete characters[characterId];
                    }
                    if (window.characters && window.characters[characterId]) {
                        delete window.characters[characterId];
                    }
                    
                    console.log('‚úÖ LocalStorageÏóêÏÑú Ï∫êÎ¶≠ÌÑ∞ ÏÇ≠Ï†ú ÏôÑÎ£å');
                    alert('‚úÖ Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                    
                    // UI Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏
                    displayCharacters();
                    updateCharacterStats();
                    
                } else {
                    alert('‚ùå ÏÇ≠Ï†úÌï† Ï∫êÎ¶≠ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                }
                
            } catch (error) {
                console.error('‚ùå Ï∫êÎ¶≠ÌÑ∞ ÏÇ≠Ï†ú Ïò§Î•ò:', error);
                alert('‚ùå Ï∫êÎ¶≠ÌÑ∞ ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
            }
        }

        // === Í≥µÌÜµ Ìï®ÏàòÎì§ ===
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';

            // Î∞±Í∑∏ÎùºÏö¥Îìú Ïä§ÌÅ¨Î°§ ÌôúÏÑ±Ìôî
            document.body.style.overflow = 'auto';

            if (modalId === 'scenarioModal') {
                document.getElementById('scenarioForm').reset();
                selectedCharacters.clear();
                document.querySelectorAll('.character-option').forEach(opt => opt.classList.remove('selected'));
            } else if (modalId === 'dialogueModal') {
                document.getElementById('dialogueForm').reset();
                document.getElementById('dialoguePreview').style.display = 'none';
                generatedDialogue = null;
            } else if (modalId === 'characterModal') {
                document.getElementById('characterForm').reset();
            } else if (modalId === 'photoManagerModal') {
                clearPhotoUploads();
            }
        }

        // üì∏ ÏÇ¨ÏßÑ Í¥ÄÎ¶¨ Ï†ÑÏó≠ Î≥ÄÏàòÎì§
        let currentCharacterId = null;
        let currentCharacterName = '';
        let characterPhotos = {
            profile: null,
            casual: [],
            romantic: [],
            emotional: [],
            special: []
        };

        // üì∏ ÏÇ¨ÏßÑ Í¥ÄÎ¶¨ Î™®Îã¨ Ïó¥Í∏∞
        async function openPhotoManager(characterId, characterName) {
            console.log('üì∏ ÏÇ¨ÏßÑ Í¥ÄÎ¶¨ Î™®Îã¨ Ïó¥Í∏∞:', characterId, characterName);

            currentCharacterId = characterId;
            currentCharacterName = characterName;

            // Î™®Îã¨ Ï†úÎ™© ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('characterPhotoName').textContent = characterName;

            // Í∏∞Ï°¥ ÏÇ¨ÏßÑ Îç∞Ïù¥ÌÑ∞ Î°úÎìú (V2.3)
            await loadCharacterPhotosV2(characterId);

            // Î∞±Í∑∏ÎùºÏö¥Îìú Ïä§ÌÅ¨Î°§ ÎπÑÌôúÏÑ±Ìôî
            document.body.style.overflow = 'hidden';

            // Î™®Îã¨ ÌëúÏãú
            document.getElementById('photoManagerModal').style.display = 'block';

            // ÌååÏùº ÏûÖÎ†• Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
            setupPhotoInputListeners();

            // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
            updatePhotoStats();
        }

        // üì∏ Ï∫êÎ¶≠ÌÑ∞ ÏÇ¨ÏßÑ Îç∞Ïù¥ÌÑ∞ Î°úÎìú (ÌÜµÌï© API v2.3 - RENAMED FUNCTION)
        async function loadCharacterPhotosV2(characterId) {
            try {
                console.log('üìÇ [V2.3] Ï∫êÎ¶≠ÌÑ∞ ÏÇ¨ÏßÑ Î°úÎìú Ï§ë (ÌÜµÌï© API):', characterId);
                console.log('üîß [V2.3] API ÏóîÎìúÌè¨Ïù∏Ìä∏: /api/character-ai-generator');
                console.log('‚ùå [V2.3] character-photo-managerÎäî ÏÇ≠Ï†úÎê®!');

                const apiUrl = `/api/character-ai-generator?action=get_character_photos&character_id=${characterId}&_t=${Date.now()}`;
                console.log('üåê [V2.3] Ìò∏Ï∂ú URL:', apiUrl);

                const response = await fetch(apiUrl);
                const result = await response.json();

                if (result.success) {
                    characterPhotos = result.data.photos || {
                        profile: null,
                        casual: [],
                        romantic: [],
                        emotional: [],
                        special: []
                    };
                    console.log('‚úÖ ÏÇ¨ÏßÑ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å:', characterPhotos);

                    // UIÏóê ÏÇ¨ÏßÑÎì§ ÌëúÏãú
                    displayPhotosInUI();
                } else {
                    console.warn('‚ö†Ô∏è ÏÇ¨ÏßÑ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', result.message);
                    // Îπà Îç∞Ïù¥ÌÑ∞Î°ú Ï¥àÍ∏∞Ìôî
                    characterPhotos = {
                        profile: null,
                        casual: [],
                        romantic: [],
                        emotional: [],
                        special: []
                    };
                }
            } catch (error) {
                console.error('‚ùå ÏÇ¨ÏßÑ Î°úÎìú Ïò§Î•ò:', error);
                characterPhotos = {
                    profile: null,
                    casual: [],
                    romantic: [],
                    emotional: [],
                    special: []
                };
            }
        }

        // üì∏ UIÏóê ÏÇ¨ÏßÑÎì§ ÌëúÏãú
        function displayPhotosInUI() {
            // ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ ÌëúÏãú
            const profileContainer = document.getElementById('profilePhotoContainer');
            profileContainer.innerHTML = '';

            if (characterPhotos.profile) {
                const photoItem = createPhotoItemElement(characterPhotos.profile, 'profile');
                profileContainer.appendChild(photoItem);
            }

            // Í∞Å Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ ÏÇ¨ÏßÑÎì§ ÌëúÏãú
            ['casual', 'romantic', 'emotional', 'special'].forEach(category => {
                const grid = document.getElementById(`${category}PhotoGrid`);
                grid.innerHTML = '';

                if (characterPhotos[category] && characterPhotos[category].length > 0) {
                    characterPhotos[category].forEach(photo => {
                        const photoItem = createPhotoItemElement(photo, category);
                        grid.appendChild(photoItem);
                    });
                }
            });
        }

        // üì∏ ÏÇ¨ÏßÑ ÏïÑÏù¥ÌÖú HTML ÏöîÏÜå ÏÉùÏÑ±
        function createPhotoItemElement(photo, category) {
            const photoDiv = document.createElement('div');
            photoDiv.className = 'photo-item';
            photoDiv.innerHTML = `
                <img src="${photo.data}" alt="${category} ÏÇ¨ÏßÑ" />
                <button class="delete-btn" onclick="deletePhotoV2('${photo.id}', '${category}')" title="ÏÇ¨ÏßÑ ÏÇ≠Ï†ú">
                    üóëÔ∏è
                </button>
            `;
            return photoDiv;
        }

        // üì∏ ÌååÏùº ÏûÖÎ†• Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
        function setupPhotoInputListeners() {
            // ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ ÏûÖÎ†•
            document.getElementById('profilePhotoInput').onchange = function(e) {
                handlePhotoUpload(e, 'profile');
            };

            // ÏùºÎ∞ò ÏÇ¨ÏßÑÎì§ ÏûÖÎ†•
            ['casual', 'romantic', 'emotional', 'special'].forEach(category => {
                document.getElementById(`${category}PhotoInput`).onchange = function(e) {
                    handlePhotoUpload(e, category);
                };
            });
        }

        // üì∏ ÏÇ¨ÏßÑ ÏóÖÎ°úÎìú Ï≤òÎ¶¨
        async function handlePhotoUpload(event, category) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            console.log(`üì∑ ${category} Ïπ¥ÌÖåÍ≥†Î¶¨Ïóê ${files.length}Í∞ú ÌååÏùº ÏóÖÎ°úÎìú Ï§ë...`);

            for (let i = 0; i < files.length; i++) {
                const file = files[i];

                // ÌååÏùº Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
                if (!validatePhotoFile(file, category)) {
                    continue;
                }

                try {
                    // ÌååÏùºÏùÑ Base64Î°ú Î≥ÄÌôò
                    const base64Data = await fileToBase64(file);

                    // ÏÑúÎ≤ÑÏóê ÏóÖÎ°úÎìú (V2.3)
                    await uploadPhotoToServerV2(base64Data, category);

                } catch (error) {
                    console.error(`‚ùå ${file.name} ÏóÖÎ°úÎìú Ïã§Ìå®:`, error);
                    alert(`${file.name} ÏóÖÎ°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ${error.message}`);
                }
            }

            // ÏûÖÎ†• ÌïÑÎìú Î¶¨ÏÖã
            event.target.value = '';
        }

        // üì∏ ÌååÏùº Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
        function validatePhotoFile(file, category) {
            // ÌååÏùº ÌÉÄÏûÖ Í≤ÄÏÇ¨
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                alert(`ÏßÄÏõêÌïòÏßÄ ÏïäÎäî ÌååÏùº ÌòïÏãùÏûÖÎãàÎã§: ${file.name}\nÏßÄÏõê ÌòïÏãù: JPG, PNG, WEBP`);
                return false;
            }

            // ÌååÏùº ÌÅ¨Í∏∞ Í≤ÄÏÇ¨ - Vercel 4.5MB ÌéòÏù¥Î°úÎìú Ï†úÌïúÏùÑ Í≥†Î†§ÌïòÏó¨ 3MBÎ°ú Ï†úÌïú
            const maxSize = 3 * 1024 * 1024; // 3MB (Base64Î°ú ÏïΩ 4MBÍ∞Ä ÎêòÏñ¥ ÏïàÏ†ÑÌïú Î≤îÏúÑ)
            if (file.size > maxSize) {
                const currentSizeMB = Math.round(file.size / (1024 * 1024) * 10) / 10;
                alert(`ÌååÏùº ÌÅ¨Í∏∞Í∞Ä ÎÑàÎ¨¥ ÌÅΩÎãàÎã§: ${file.name}\nÏµúÎåÄ ÌÅ¨Í∏∞: 3MB (ÌòÑÏû¨: ${currentSizeMB}MB)\n\nÌåÅ: Ïù¥ÎØ∏ÏßÄ Ìé∏Ïßë ÌîÑÎ°úÍ∑∏Îû®ÏúºÎ°ú ÏïïÏ∂ïÌïòÍ±∞ÎÇò ÌÅ¨Í∏∞Î•º Ï§ÑÏó¨Ï£ºÏÑ∏Ïöî.`);
                return false;
            }

            // Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Í∞úÏàò Ï†úÌïú Í≤ÄÏÇ¨
            const limits = { profile: 1, casual: 5, romantic: 5, emotional: 5, special: 4 };
            const currentCount = category === 'profile' ?
                (characterPhotos.profile ? 1 : 0) :
                characterPhotos[category].length;

            if (currentCount >= limits[category]) {
                const categoryNames = {
                    profile: 'ÌîÑÎ°úÌïÑ',
                    casual: 'ÏùºÏÉÅ',
                    romantic: 'Î°úÎß®Ìã±',
                    emotional: 'Í∞êÏ†ï ÌëúÌòÑ',
                    special: 'ÌäπÎ≥ÑÌïú ÏàúÍ∞Ñ'
                };
                alert(`${categoryNames[category]} Ïπ¥ÌÖåÍ≥†Î¶¨Îäî ÏµúÎåÄ ${limits[category]}Ïû•ÍπåÏßÄÎßå ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§.`);
                return false;
            }

            return true;
        }

        // üì∏ ÌååÏùºÏùÑ Base64Î°ú Î≥ÄÌôò
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // üì∏ ÏÑúÎ≤ÑÏóê ÏÇ¨ÏßÑ ÏóÖÎ°úÎìú (V2.3 renamed)
        async function uploadPhotoToServerV2(photoData, category) {
            try {
                console.log(`üì° [V3.0-SAFE] ÏïàÏ†ÑÌïú Í∞úÎ≥Ñ ÌååÏùº ÏóÖÎ°úÎìú: ${category}`);
                console.log('üîß [V3.0] ÏÉàÎ°úÏö¥ API: upload_single_photo');
                console.log('üìè ÏÇ¨ÏßÑ ÌÅ¨Í∏∞:', Math.round(photoData.length / 1024), 'KB');

                const apiUrl = '/api/character-ai-generator';
                console.log('üåê [V2.3] ÏóÖÎ°úÎìú URL:', apiUrl);

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'upload_single_photo',
                        character_id: currentCharacterId,
                        category: category,
                        photo_data: photoData
                    })
                });

                // ÌäπÎ≥Ñ Ïò§Î•ò ÏÉÅÌÉú Ï≤òÎ¶¨
                if (response.status === 413) {
                    throw new Error('ÌååÏùº ÌÅ¨Í∏∞Í∞Ä ÎÑàÎ¨¥ ÌÅΩÎãàÎã§. 1MB Ïù¥ÌïòÎ°ú ÏïïÏ∂ïÌï¥Ï£ºÏÑ∏Ïöî.');
                }

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('ÏÑúÎ≤Ñ Ïò§Î•ò ÏùëÎãµ:', errorText);
                    throw new Error(`ÏÑúÎ≤Ñ Ïò§Î•ò: ${response.status} ${response.statusText}`);
                }

                let result;
                try {
                    result = await response.json();
                } catch (parseError) {
                    console.error('JSON ÌååÏã± Ïò§Î•ò:', parseError);
                    const textResponse = await response.text();
                    console.error('ÏùëÎãµ ÎÇ¥Ïö©:', textResponse);
                    throw new Error('ÏÑúÎ≤Ñ ÏùëÎãµ ÌòïÏãù Ïò§Î•ò');
                }

                if (result.success) {
                    console.log('‚úÖ ÏÇ¨ÏßÑ ÏóÖÎ°úÎìú ÏÑ±Í≥µ');

                    // Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
                    if (category === 'profile') {
                        characterPhotos.profile = {
                            id: `${currentCharacterId}_profile_${Date.now()}`,
                            data: photoData,
                            uploaded_at: new Date().toISOString()
                        };
                    } else {
                        characterPhotos[category].push({
                            id: `${currentCharacterId}_${category}_${Date.now()}`,
                            data: photoData,
                            uploaded_at: new Date().toISOString()
                        });
                    }

                    // UI ÏóÖÎç∞Ïù¥Ìä∏
                    displayPhotosInUI();
                    updatePhotoStats();

                    // ÏÑ±Í≥µ Î©îÏãúÏßÄ
                    showNotification('‚úÖ ÏÇ¨ÏßÑÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏóÖÎ°úÎìúÎêòÏóàÏäµÎãàÎã§!', 'success');

                } else {
                    throw new Error(result.message || 'ÏóÖÎ°úÎìú Ïã§Ìå®');
                }

            } catch (error) {
                console.error('‚ùå ÏÇ¨ÏßÑ ÏóÖÎ°úÎìú Ïò§Î•ò:', error);
                throw error;
            }
        }

        // üì∏ ÏÇ¨ÏßÑ ÏÇ≠Ï†ú
        async function deletePhotoV2(photoId, category) {
            if (!confirm('Ï†ïÎßêÎ°ú Ïù¥ ÏÇ¨ÏßÑÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                return;
            }

            try {
                console.log(`üóëÔ∏è [V2.3] ÏÇ¨ÏßÑ ÏÇ≠Ï†ú Ï§ë: ${photoId} (${category})`);
                console.log('üîß [V2.3] ÏÇ≠Ï†ú API: character-ai-generator');

                const response = await fetch('/api/character-ai-generator', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'delete_photo',
                        character_id: currentCharacterId,
                        category: category,
                        photo_id: photoId
                    })
                });

                const result = await response.json();

                if (result.success) {
                    console.log('‚úÖ ÏÇ¨ÏßÑ ÏÇ≠Ï†ú ÏÑ±Í≥µ');

                    // Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
                    if (category === 'profile') {
                        characterPhotos.profile = null;
                    } else {
                        const index = characterPhotos[category].findIndex(photo => photo.id === photoId);
                        if (index !== -1) {
                            characterPhotos[category].splice(index, 1);
                        }
                    }

                    // UI ÏóÖÎç∞Ïù¥Ìä∏
                    displayPhotosInUI();
                    updatePhotoStats();

                    showNotification('‚úÖ ÏÇ¨ÏßÑÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.', 'success');

                } else {
                    throw new Error(result.message || 'ÏÇ≠Ï†ú Ïã§Ìå®');
                }

            } catch (error) {
                console.error('‚ùå ÏÇ¨ÏßÑ ÏÇ≠Ï†ú Ïò§Î•ò:', error);
                alert('ÏÇ¨ÏßÑ ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message);
            }
        }

        // üñºÔ∏è Ï∫êÎ¶≠ÌÑ∞ Ïπ¥ÎìúÏö© ÏÇ¨ÏßÑ ÎØ∏Î¶¨Î≥¥Í∏∞ Î°úÎìú
        async function loadCharacterPhotoPreview(characterId) {
            try {
                const encodedCharacterId = encodeURIComponent(characterId);
                // Í∞ïÎ†•Ìïú Ï∫êÏãú Î≤ÑÏä§ÌåÖÏùÑ ÏúÑÌïú Îçî Î≥µÏû°Ìïú ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ
                const cacheBreaker = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                const apiUrl = `/api/character-ai-generator?action=get_character_photos_v2&character_id=${encodedCharacterId}&_t=${cacheBreaker}`;
                console.log('üì∑ ÏÇ¨ÏßÑ ÎØ∏Î¶¨Î≥¥Í∏∞ Î°úÎìú ÏãúÏûë:', characterId);
                console.log('üåê API URL:', apiUrl);

                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                const result = await response.json();

                console.log('üì∏ ÏÇ¨ÏßÑ API ÏùëÎãµ:', result);

                if (result.success && result.photos) {
                    const previewContainer = document.getElementById(`photo-preview-${characterId}`);
                    if (!previewContainer) return;

                    let thumbnailsHtml = '';
                    let photoCount = 0;

                    // ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ (Ïö∞ÏÑ†ÏàúÏúÑ)
                    if (result.photos.profile) {
                        thumbnailsHtml += `<img src="${result.photos.profile.data}" class="photo-thumbnail"
                                           onclick="showPhotoModal('${result.photos.profile.data}', 'profile')"
                                           title="ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ" alt="ÌîÑÎ°úÌïÑ"/>`;
                        photoCount++;
                    }

                    // Îã§Î•∏ Ïπ¥ÌÖåÍ≥†Î¶¨Îì§ÏóêÏÑú ÏµúÎåÄ 4Í∞úÍπåÏßÄ Îçî Í∞ÄÏ†∏Ïò§Í∏∞
                    const categories = ['casual', 'romantic', 'emotional', 'special'];
                    for (const category of categories) {
                        if (photoCount >= 5) break; // ÏµúÎåÄ 5Í∞úÍπåÏßÄÎßå ÌëúÏãú
                        if (result.photos[category] && Array.isArray(result.photos[category])) {
                            for (const photo of result.photos[category]) {
                                if (photoCount >= 5) break;
                                thumbnailsHtml += `<img src="${photo.data}" class="photo-thumbnail"
                                                   onclick="showPhotoModal('${photo.data}', '${category}')"
                                                   title="${category} ÏÇ¨ÏßÑ" alt="${category}"/>`;
                                photoCount++;
                            }
                        }
                    }

                    // Ï∂îÍ∞Ä ÏÇ¨ÏßÑÏù¥ ÏûàÎäî Í≤ΩÏö∞ +N ÌëúÏãú
                    const totalPhotos = getTotalPhotoCount(result.photos);
                    if (totalPhotos > 5) {
                        thumbnailsHtml += `<div class="more-photos-indicator" onclick="openPhotoManager('${characterId}', '')"
                                           title="${totalPhotos - 5}Í∞ú Îçî Î≥¥Í∏∞">+${totalPhotos - 5}</div>`;
                    }

                    previewContainer.innerHTML = thumbnailsHtml;
                }
            } catch (error) {
                console.log(`üì∑ Ï∫êÎ¶≠ÌÑ∞ ${characterId} ÏÇ¨ÏßÑ ÎØ∏Î¶¨Î≥¥Í∏∞ Î°úÎìú Ïã§Ìå®:`, error);
                // ÏóêÎü¨ ÏãúÏóêÎäî Ï°∞Ïö©Ìûà Ï≤òÎ¶¨ (Îπà ÏÉÅÌÉú Ïú†ÏßÄ)
            }
        }

        // üñºÔ∏è Ï∫êÎ¶≠ÌÑ∞ Ïπ¥Îìú ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ Î°úÎìú
        async function loadCharacterProfileImage(characterId) {
            console.log(`üîç ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ Î°úÎìú ÏãúÏûë: ${characterId}`);

            try {
                const encodedCharacterId = encodeURIComponent(characterId);
                const apiUrl = `/api/character-ai-generator?action=get_character_photos_v2&character_id=${encodedCharacterId}&_t=${Date.now()}`;
                console.log(`üì° API Ìò∏Ï∂ú: ${apiUrl}`);

                const response = await fetch(apiUrl);
                console.log(`üì• API ÏùëÎãµ ÏÉÅÌÉú: ${response.status}`);

                const result = await response.json();
                console.log(`üìä API ÏùëÎãµ Îç∞Ïù¥ÌÑ∞:`, result);
                console.log(`üîç API ÏùëÎãµ Íµ¨Ï°∞ Î∂ÑÏÑù:`, {
                    success: result.success,
                    hasData: !!result.data,
                    hasPhotos: !!result.photos,
                    hasCategories: !!result.categories,
                    dataKeys: result.data ? Object.keys(result.data) : null,
                    categoriesKeys: result.categories ? Object.keys(result.categories) : null
                });

                if (result.success) {
                    console.log(`‚úÖ API ÏÑ±Í≥µ, ÏÇ¨ÏßÑ Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏:`, result.photos);
                    console.log(`üîç result.data ÎÇ¥Ïö©:`, result.data);
                    console.log(`üîç result.categories ÎÇ¥Ïö©:`, result.categories);

                    // Ïò¨Î∞îÎ•∏ ÏúÑÏπòÏóêÏÑú ÏÇ¨ÏßÑ Îç∞Ïù¥ÌÑ∞ Ï∞æÍ∏∞: result.data.photos
                    const photosData = result.data?.photos;
                    console.log(`üîç Ïã§Ï†ú ÏÇ¨ÏßÑ Îç∞Ïù¥ÌÑ∞ ÏúÑÏπò ÌôïÏù∏:`, photosData);

                    if (photosData && photosData.profile) {
                        console.log(`üì∑ ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ Îç∞Ïù¥ÌÑ∞ Ï°¥Ïû¨: ${photosData.profile.data ? 'ÏûàÏùå' : 'ÏóÜÏùå'}`);

                        const profileContainer = document.getElementById(`profile-image-${characterId}`);
                        console.log(`üéØ ÌîÑÎ°úÌïÑ Ïª®ÌÖåÏù¥ÎÑà Ï∞æÍ∏∞: ${profileContainer ? 'Ï∞æÏùå' : 'ÏóÜÏùå'}`);

                        if (profileContainer) {
                            profileContainer.innerHTML = `
                                <img src="${photosData.profile.data}"
                                     alt="ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ"
                                     style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;"
                                     onload="console.log('‚úÖ ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ Î°úÎìú ÏÑ±Í≥µ: ${characterId}')"
                                     onerror="console.log('‚ùå ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ïã§Ìå®: ${characterId}'); this.parentElement.innerHTML='<div class=\\"no-image\\">${characterId.split('_')[0].charAt(0)}</div>'"/>
                            `;
                            console.log(`üé® ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ HTML ÏÑ§Ï†ï ÏôÑÎ£å: ${characterId}`);
                        }
                    } else {
                        console.log(`‚ùå ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå: ${characterId}`);
                        console.log(`üîç ÏÇ¨ÏßÑ Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞:`, photosData);
                    }
                } else {
                    console.log(`‚ùå API Ïã§Ìå®: ${result.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'}`);
                }
            } catch (error) {
                console.log(`üí• ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ïò§Î•ò - Ï∫êÎ¶≠ÌÑ∞: ${characterId}`, error);
                // ÏóêÎü¨ ÏãúÏóêÎäî Í∏∞Î≥∏ Ïù¥ÎØ∏ÏßÄ Ïú†ÏßÄ
            }
        }

        // üì∏ Í∞úÏÑ†Îêú ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ìï®Ïàò (FIXED)
        async function loadCharacterProfileImageEnhanced(characterId) {
            console.log(`üîç [FIXED] ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ Î°úÎìú ÏãúÏûë: ${characterId}`);

            try {
                const encodedCharacterId = encodeURIComponent(characterId);
                const apiUrl = `/api/character-ai-generator?action=get_character_photos_v2&character_id=${encodedCharacterId}&_t=${Date.now()}`;
                console.log(`üì° [FIXED] API Ìò∏Ï∂ú: ${apiUrl}`);

                const response = await fetch(apiUrl);
                console.log(`üì• [FIXED] API ÏùëÎãµ ÏÉÅÌÉú: ${response.status}`);

                if (!response.ok) {
                    console.error(`‚ùå [FIXED] API ÏùëÎãµ Ïò§Î•ò: ${response.status}`);
                    return false;
                }

                const result = await response.json();
                console.log(`üìä [FIXED] API ÏùëÎãµ Îç∞Ïù¥ÌÑ∞:`, result);

                // ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ Ï°¥Ïû¨ Ïó¨Î∂Ä Ï†ïÌôïÌïú Ï≤¥ÌÅ¨
                const hasProfileData = result.success &&
                                       result.data &&
                                       result.data.photos &&
                                       result.data.photos.profile &&
                                       result.data.photos.profile !== null &&
                                       result.data.photos.profile.data;

                if (hasProfileData) {
                    const profileData = result.data.photos.profile;
                    console.log(`üì∑ [FIXED] ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏:`, {
                        hasId: !!profileData.id,
                        hasData: !!profileData.data,
                        dataSize: profileData.data ? profileData.data.length : 0,
                        dataPrefix: profileData.data ? profileData.data.substring(0, 50) : 'none'
                    });

                    const profileContainer = document.getElementById(`profile-image-${characterId}`);
                    console.log(`üéØ [FIXED] ÌîÑÎ°úÌïÑ Ïª®ÌÖåÏù¥ÎÑà ÌôïÏù∏:`, {
                        found: !!profileContainer,
                        id: `profile-image-${characterId}`,
                        currentHTML: profileContainer ? profileContainer.innerHTML.substring(0, 100) : 'not found'
                    });

                    if (profileContainer && profileData.data) {
                        profileContainer.innerHTML = `
                            <img src="${profileData.data}"
                                 alt="ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ"
                                 style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;"
                                 onload="console.log('‚úÖ [FIXED] ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ Î°úÎìú ÏÑ±Í≥µ: ${characterId}')"
                                 onerror="console.log('‚ùå [FIXED] ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ïã§Ìå®: ${characterId}'); this.parentElement.innerHTML='<div class=\\\"no-image\\\">${characterId.split('_')[0].charAt(0)}</div>'"/>
                        `;
                        console.log(`‚úÖ [FIXED] ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ HTML ÏÑ§Ï†ï ÏôÑÎ£å: ${characterId}`);
                        return true;
                    } else {
                        console.log(`‚ùå [FIXED] Ïª®ÌÖåÏù¥ÎÑà ÎòêÎäî Ïù¥ÎØ∏ÏßÄ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå`);
                        return false;
                    }
                } else {
                    console.log(`‚ùå [FIXED] ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå ÎòêÎäî Íµ¨Ï°∞ Î¨∏Ï†ú:`, {
                        characterId,
                        success: result.success,
                        hasData: !!result.data,
                        hasPhotos: !!(result.data && result.data.photos),
                        profileExists: !!(result.data && result.data.photos && result.data.photos.profile),
                        profileIsNull: result.data && result.data.photos ? result.data.photos.profile === null : 'unknown',
                        profileValue: result.data && result.data.photos ? result.data.photos.profile : 'none',
                        allPhotosData: result.data && result.data.photos ? Object.keys(result.data.photos) : 'none'
                    });

                    // Ïª®ÌÖåÏù¥ÎÑàÎ•º Í∏∞Î≥∏ ÏÉÅÌÉúÎ°ú ÏÑ§Ï†ï
                    const profileContainer = document.getElementById(`profile-image-${characterId}`);
                    if (profileContainer) {
                        profileContainer.innerHTML = `<div class="no-image">${characterId.split('_')[0].charAt(0)}</div>`;
                    }
                    return false;
                }
            } catch (error) {
                console.error(`‚ùå [FIXED] ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ïò§Î•ò:`, error);
                return false;
            }
        }

        // üì∏ Î™®Îì† Ï∫êÎ¶≠ÌÑ∞ ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ Î°úÎìú (ÏùºÍ¥Ñ Ï≤òÎ¶¨)
        function loadAllCharacterPhotos() {
            console.log('üîÑ [FIXED] Î™®Îì† Ï∫êÎ¶≠ÌÑ∞ ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ Î°úÎìú ÏãúÏûë');

            const characterCards = document.querySelectorAll('.character-card');
            console.log(`üìä [FIXED] Ï∞æÏùÄ Ï∫êÎ¶≠ÌÑ∞ Ïπ¥Îìú Ïàò: ${characterCards.length}`);

            characterCards.forEach((card, index) => {
                const profileImageContainer = card.querySelector('[id^="profile-image-"]');
                if (profileImageContainer) {
                    const characterId = profileImageContainer.id.replace('profile-image-', '');
                    console.log(`üì∏ [FIXED] ${index + 1}/${characterCards.length} Ï∫êÎ¶≠ÌÑ∞ Ïù¥ÎØ∏ÏßÄ Î°úÎìú: ${characterId}`);

                    setTimeout(() => {
                        loadCharacterProfileImageEnhanced(characterId);
                    }, index * 100); // 100ms Í∞ÑÍ≤©ÏúºÎ°ú ÏàúÏ∞® Î°úÎìú
                }
            });
        }

        // üî¢ Ï†ÑÏ≤¥ ÏÇ¨ÏßÑ Í∞úÏàò Í≥ÑÏÇ∞
        function getTotalPhotoCount(photos) {
            let total = 0;
            if (photos.profile) total += 1;
            ['casual', 'romantic', 'emotional', 'special'].forEach(category => {
                if (photos[category] && Array.isArray(photos[category])) {
                    total += photos[category].length;
                }
            });
            return total;
        }

        // üñºÔ∏è ÏÇ¨ÏßÑ ÌôïÎåÄ Î™®Îã¨ ÌëúÏãú
        function showPhotoModal(photoData, category) {
            // Í∞úÏÑ†Îêú ÏÇ¨ÏßÑ ÌôïÎåÄ Î™®Îã¨
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.9); display: flex; align-items: center;
                justify-content: center; z-index: 10000; cursor: pointer;
                padding: 20px; box-sizing: border-box;
            `;

            // Ïù¥ÎØ∏ÏßÄ Ïª®ÌÖåÏù¥ÎÑà ÏÉùÏÑ±
            const imageContainer = document.createElement('div');
            imageContainer.style.cssText = `
                max-width: 80vw; max-height: 80vh;
                display: flex; align-items: center; justify-content: center;
                background: white; border-radius: 15px; padding: 15px;
                box-shadow: 0 8px 30px rgba(0,0,0,0.5);
                position: relative;
            `;

            const img = document.createElement('img');
            img.src = photoData;
            img.alt = category;
            img.style.cssText = `
                max-width: 100%; max-height: 100%;
                object-fit: contain; border-radius: 10px;
                display: block; min-height: 200px;
            `;

            // Ïπ¥ÌÖåÍ≥†Î¶¨ ÎùºÎ≤® Ï∂îÍ∞Ä
            const label = document.createElement('div');
            label.textContent = `${category} ÏÇ¨ÏßÑ`;
            label.style.cssText = `
                position: absolute; top: 30px; left: 50%; transform: translateX(-50%);
                background: rgba(255,255,255,0.95); padding: 8px 16px;
                border-radius: 20px; color: #333; font-weight: bold;
                font-size: 14px; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                z-index: 10001;
            `;

            // Îã´Í∏∞ Î≤ÑÌäº Ï∂îÍ∞Ä
            const closeBtn = document.createElement('div');
            closeBtn.innerHTML = '‚úï';
            closeBtn.style.cssText = `
                position: absolute; top: 40px; right: 40px;
                width: 40px; height: 40px; border-radius: 50%;
                background: rgba(255,255,255,0.9); color: #333;
                display: flex; align-items: center; justify-content: center;
                font-size: 20px; font-weight: bold; cursor: pointer;
                box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                z-index: 10001; transition: all 0.2s ease;
            `;
            closeBtn.onmouseover = () => closeBtn.style.background = 'rgba(255,255,255,1)';
            closeBtn.onmouseout = () => closeBtn.style.background = 'rgba(255,255,255,0.9)';

            imageContainer.appendChild(img);
            modal.appendChild(imageContainer);
            modal.appendChild(label);
            modal.appendChild(closeBtn);

            // ÌÅ¥Î¶≠ÌïòÎ©¥ Î™®Îã¨ Îã´Í∏∞
            modal.onclick = (e) => {
                if (e.target === modal || e.target === label || e.target === closeBtn) {
                    document.body.removeChild(modal);
                }
            };

            // ESC ÌÇ§Î°ú Îã´Í∏∞
            const closeOnEsc = (e) => {
                if (e.key === 'Escape') {
                    document.body.removeChild(modal);
                    document.removeEventListener('keydown', closeOnEsc);
                }
            };
            document.addEventListener('keydown', closeOnEsc);

            document.body.appendChild(modal);
        }

        // üì∏ ÏÇ¨ÏßÑ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
        function updatePhotoStats() {
            let totalCount = 0;
            let totalSize = 0;

            // ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ
            if (characterPhotos.profile) {
                totalCount += 1;
                totalSize += estimateBase64Size(characterPhotos.profile.data);
            }

            // Í∏∞ÌÉÄ Ïπ¥ÌÖåÍ≥†Î¶¨Îì§
            ['casual', 'romantic', 'emotional', 'special'].forEach(category => {
                if (characterPhotos[category]) {
                    totalCount += characterPhotos[category].length;
                    characterPhotos[category].forEach(photo => {
                        totalSize += estimateBase64Size(photo.data);
                    });
                }
            });

            const maxSlots = 20; // Ï¥ù ÏµúÎåÄ Ïä¨Î°Ø Ïàò
            const remainingSlots = maxSlots - totalCount;

            // UI ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('totalPhotoCount').textContent = `Ï¥ù ${totalCount}Ïû•`;
            document.getElementById('totalPhotoSize').textContent = `Ïö©Îüâ: ${formatFileSize(totalSize)}`;
            document.getElementById('remainingSlots').textContent = `ÎÇ®ÏùÄ Ïä¨Î°Ø: ${remainingSlots}Í∞ú`;
        }

        // üì∏ Base64 ÌÅ¨Í∏∞ Ï∂îÏ†ï
        function estimateBase64Size(base64Data) {
            // Base64Îäî ÏõêÎ≥∏Ïùò ÏïΩ 133% ÌÅ¨Í∏∞
            return Math.round((base64Data.length * 3) / 4);
        }

        // üì∏ ÌååÏùº ÌÅ¨Í∏∞ Ìè¨Îß∑ÌåÖ
        function formatFileSize(bytes) {
            if (bytes === 0) return '0KB';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + sizes[i];
        }

        // üì∏ Î™®Îì† ÏÇ¨ÏßÑ ÏÇ≠Ï†ú
        async function clearAllCharacterPhotos() {
            if (!confirm('Ï†ïÎßêÎ°ú Ïù¥ Ï∫êÎ¶≠ÌÑ∞Ïùò Î™®Îì† ÏÇ¨ÏßÑÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                return;
            }

            try {
                // Í∞Å Ïπ¥ÌÖåÍ≥†Î¶¨Î≥ÑÎ°ú ÏÇ≠Ï†ú
                const deletePromises = [];

                if (characterPhotos.profile) {
                    deletePromises.push(deletePhotoV2(characterPhotos.profile.id, 'profile'));
                }

                ['casual', 'romantic', 'emotional', 'special'].forEach(category => {
                    characterPhotos[category].forEach(photo => {
                        deletePromises.push(deletePhotoV2(photo.id, category));
                    });
                });

                await Promise.all(deletePromises);

                showNotification('‚úÖ Î™®Îì† ÏÇ¨ÏßÑÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.', 'success');

            } catch (error) {
                console.error('‚ùå Ï†ÑÏ≤¥ ÏÇ¨ÏßÑ ÏÇ≠Ï†ú Ïò§Î•ò:', error);
                alert('ÏùºÎ∂Ä ÏÇ¨ÏßÑ ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }

        // üì∏ ÏÇ¨ÏßÑ ÎØ∏Î¶¨Î≥¥Í∏∞
        function previewCharacterPhotos() {
            // Î™®Îì† ÏÇ¨ÏßÑÏùÑ ÏÉà Ï∞ΩÏóêÏÑú ÎØ∏Î¶¨Î≥¥Í∏∞
            const previewWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');

            let previewHTML = `
                <html>
                    <head>
                        <title>${currentCharacterName} - ÏÇ¨ÏßÑ ÎØ∏Î¶¨Î≥¥Í∏∞</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
                            .category { margin-bottom: 30px; background: white; padding: 20px; border-radius: 10px; }
                            .photo-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
                            .photo { border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
                            .photo img { width: 100%; height: 200px; object-fit: cover; }
                            h2 { color: #333; margin-top: 0; }
                            h3 { color: #666; border-bottom: 2px solid #eee; padding-bottom: 10px; }
                        </style>
                    </head>
                    <body>
                        <h2>üì∏ ${currentCharacterName} ÏÇ¨ÏßÑ ÎØ∏Î¶¨Î≥¥Í∏∞</h2>
            `;

            // ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ
            if (characterPhotos.profile) {
                previewHTML += `
                    <div class="category">
                        <h3>üìã ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ</h3>
                        <div class="photo-grid">
                            <div class="photo">
                                <img src="${characterPhotos.profile.data}" alt="ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ" />
                            </div>
                        </div>
                    </div>
                `;
            }

            // Í∏∞ÌÉÄ Ïπ¥ÌÖåÍ≥†Î¶¨Îì§
            const categoryNames = {
                casual: 'üòä ÏùºÏÉÅ ÏÇ¨ÏßÑ',
                romantic: 'üíï Î°úÎß®Ìã± ÏÇ¨ÏßÑ',
                emotional: 'üòç Í∞êÏ†ï ÌëúÌòÑ ÏÇ¨ÏßÑ',
                special: '‚ú® ÌäπÎ≥ÑÌïú ÏàúÍ∞Ñ'
            };

            Object.keys(categoryNames).forEach(category => {
                if (characterPhotos[category] && characterPhotos[category].length > 0) {
                    previewHTML += `
                        <div class="category">
                            <h3>${categoryNames[category]}</h3>
                            <div class="photo-grid">
                    `;

                    characterPhotos[category].forEach(photo => {
                        previewHTML += `
                            <div class="photo">
                                <img src="${photo.data}" alt="${category} ÏÇ¨ÏßÑ" />
                            </div>
                        `;
                    });

                    previewHTML += `
                            </div>
                        </div>
                    `;
                }
            });

            previewHTML += `
                    </body>
                </html>
            `;

            previewWindow.document.write(previewHTML);
            previewWindow.document.close();
        }

        // üì∏ ÏóÖÎ°úÎìú Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
        function clearPhotoUploads() {
            // ÌååÏùº ÏûÖÎ†• ÌïÑÎìúÎì§ Î¶¨ÏÖã
            ['profile', 'casual', 'romantic', 'emotional', 'special'].forEach(category => {
                const input = document.getElementById(`${category}PhotoInput`);
                if (input) input.value = '';
            });
        }

        // üì∏ Î≥ÄÍ≤ΩÏÇ¨Ìï≠ Ï†ÄÏû• (ÌòÑÏû¨Îäî ÏûêÎèô Ï†ÄÏû•Ïù¥ÎØÄÎ°ú ÏÑ±Í≥µ Î©îÏãúÏßÄÎßå)
        function savePhotoChanges() {
            showNotification('‚úÖ Î™®Îì† ÏÇ¨ÏßÑÏù¥ ÏûêÎèôÏúºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!', 'success');
        }

        function updateAllStats() {
            updateScenarioStats();
            updateCharacterStats();
        }


        // üîß Ï†ÑÏó≠ Ìï®Ïàò Î∞îÏù∏Îî© (onclick Ïù¥Î≤§Ìä∏ Ï†ëÍ∑ºÏÑ± Î≥¥Ïû•)
        window.switchTab = switchTab;
        window.openCharacterModal = openCharacterModal;
        window.loadCharacters = loadCharacters;
        window.loadScenarios = loadScenarios;
        window.openScenarioModal = openScenarioModal;
        // saveCharacterÎäî ÎÇòÏ§ëÏóê Ïò®ÎùºÏù∏ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏Î°ú Ï†ïÏùòÎê® (6211Î≤à Ï§Ñ)
        window.saveScenario = saveScenario;
        window.editCharacter = editCharacter;
        window.editScenario = editScenario;
        window.deleteCharacter = deleteCharacter;
        window.deleteScenario = deleteScenario;
        console.log('‚úÖ deleteScenario Ìï®Ïàò Ï†ÑÏó≠ Ìï†Îãπ ÏôÑÎ£å:', typeof window.deleteScenario);
        window.onScenarioChange = onScenarioChange;
        window.applyAISettings = applyAISettings;
        window.testAIGeneration = testAIGeneration;
        window.resetAISettings = resetAISettings;

        // üîç Ï∫êÎ¶≠ÌÑ∞ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Í¥ÄÎ†® Ìï®ÏàòÎì§ Ï†ÑÏó≠ Ìï†Îãπ
        window.showCharacterDetail = showCharacterDetail;
        window.editCurrentCharacter = editCurrentCharacter;
        console.log('‚úÖ Ï∫êÎ¶≠ÌÑ∞ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Ìï®Ïàò Ï†ÑÏó≠ Ìï†Îãπ ÏôÑÎ£å:', typeof window.showCharacterDetail);

        // AI Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú Ìï®ÏàòÎì§
        function applyAISettings() {
            try {
                console.log('üöÄ AI ÏÑ§Ï†ï Ï†ÅÏö© ÏãúÏûë...');

                // ÌòÑÏû¨ ÏÑ§Ï†ïÍ∞í ÏàòÏßë
                const settings = {
                    scenarioContentLength: document.getElementById('scenarioContentLength').value,
                    scenarioDepth: document.getElementById('scenarioDepth').value,
                    scenarioVariety: document.getElementById('scenarioVariety').value,
                    dialogueLength: document.getElementById('dialogueLength').value,
                    conversationStyle: document.getElementById('conversationStyle').value,
                    emotionalRange: document.getElementById('emotionalRange').value,
                    mbtiAccuracy: document.getElementById('mbtiAccuracy').value,
                    personalityConsistency: document.getElementById('personalityConsistency').value,
                    responseIntelligence: document.getElementById('responseIntelligence').value,
                    repetitionAvoidance: document.getElementById('repetitionAvoidance').value,
                    memoryDepth: document.getElementById('memoryDepth').value,
                    creativityBoost: document.getElementById('creativityBoost').value
                };

                // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóê ÏÑ§Ï†ï Ï†ÄÏû•
                localStorage.setItem('chatgame_ai_settings', JSON.stringify(settings));

                // ÏÑ§Ï†ï Ï†ÅÏö© ÏãúÎÆ¨Î†àÏù¥ÏÖò
                updateAIEngineStatus('Ï†ÅÏö© Ï§ë...', 'warning');

                setTimeout(() => {
                    updateAIEngineStatus('ÏµúÏ†ÅÌôîÎê®', 'success');
                    addPerformanceLog('ÏÑ§Ï†ï Ï†ÅÏö©', `AI ÏóîÏßÑ ÏÑ§Ï†ïÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÅÏö©ÎêòÏóàÏäµÎãàÎã§`, 'success');

                    // ÌíàÏßà Ï†êÏàò ÏóÖÎç∞Ïù¥Ìä∏ (ÏÑ§Ï†ïÏóê Îî∞Îùº ÎèôÏ†Å Í≥ÑÏÇ∞)
                    const qualityScore = calculateQualityScore(settings);
                    document.getElementById('aiQualityScore').textContent = qualityScore + '%';

                    showNotification('‚úÖ AI ÏÑ§Ï†ïÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÅÏö©ÎêòÏóàÏäµÎãàÎã§!', 'success');
                }, 2000);

            } catch (error) {
                console.error('‚ùå AI ÏÑ§Ï†ï Ï†ÅÏö© Ïã§Ìå®:', error);
                showNotification('‚ùå AI ÏÑ§Ï†ï Ï†ÅÏö©Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message, 'error');
            }
        }

        function testAIGeneration() {
            try {
                console.log('üß™ AI ÏÉùÏÑ± ÌÖåÏä§Ìä∏ ÏãúÏûë...');

                const testResults = document.getElementById('aiTestResults');
                const testContent = document.getElementById('testResultContent');

                testResults.style.display = 'block';
                testContent.innerHTML = '<div class="loading">üîÑ AI ÏÉùÏÑ± ÌÖåÏä§Ìä∏ Ï§ë...</div>';

                setTimeout(() => {
                    const settings = getAISettings();
                    const testScenario = generateTestScenario(settings);
                    const testDialogue = generateTestDialogue(settings);

                    testContent.innerHTML = `
                        <div class="test-section">
                            <h5>üìö ÌÖåÏä§Ìä∏ ÏãúÎÇòÎ¶¨Ïò§ ÏÉùÏÑ±</h5>
                            <div class="test-result-item">
                                <strong>Ï†úÎ™©:</strong> ${testScenario.title}<br>
                                <strong>Í∏∏Ïù¥:</strong> ${testScenario.content.length}Ïûê (${settings.scenarioContentLength} Î™®Îìú)<br>
                                <strong>ÎÇ¥Ïö©:</strong> ${testScenario.content.substring(0, 200)}...
                            </div>
                        </div>

                        <div class="test-section">
                            <h5>üí¨ ÌÖåÏä§Ìä∏ ÎåÄÌôî ÏÉùÏÑ±</h5>
                            <div class="test-result-item">
                                <strong>ÎåÄÌôîÎüâ:</strong> ${testDialogue.length}ÌÑ¥ (${settings.dialogueLength} Î™®Îìú)<br>
                                <strong>MBTI Î∞òÏòÅ:</strong> ${settings.mbtiAccuracy} ÏàòÏ§Ä<br>
                                <strong>ÏÉòÌîå:</strong> "${testDialogue[0]}"
                            </div>
                        </div>

                        <div class="test-section">
                            <h5>üéØ ÏÑ±Îä• Î∂ÑÏÑù</h5>
                            <div class="test-result-item">
                                <strong>ÏÉùÏÑ± ÏÜçÎèÑ:</strong> 1.2Ï¥à<br>
                                <strong>ÌíàÏßà Ï†êÏàò:</strong> ${calculateQualityScore(settings)}%<br>
                                <strong>Î∞òÎ≥µ Î∞©ÏßÄ:</strong> ${settings.repetitionAvoidance} ÌôúÏÑ±Ìôî
                            </div>
                        </div>
                    `;

                    addPerformanceLog('ÏÉùÏÑ± ÌÖåÏä§Ìä∏', `AI ÏÉùÏÑ± ÌÖåÏä§Ìä∏ ÏôÑÎ£å, ÌíàÏßà: ${calculateQualityScore(settings)}%`, 'info');
                    updateTodayGenerationCount();

                }, 3000);

            } catch (error) {
                console.error('‚ùå AI ÌÖåÏä§Ìä∏ Ïã§Ìå®:', error);
                showNotification('‚ùå AI ÌÖåÏä§Ìä∏Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message, 'error');
            }
        }

        function resetAISettings() {
            try {
                if (confirm('üîÑ AI ÏÑ§Ï†ïÏùÑ Í∏∞Î≥∏Í∞íÏúºÎ°ú Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                    console.log('üîÑ AI ÏÑ§Ï†ï Ï¥àÍ∏∞Ìôî...');

                    // Í∏∞Î≥∏Í∞íÏúºÎ°ú Î¶¨ÏÖã
                    document.getElementById('scenarioContentLength').value = 'basic';
                    document.getElementById('scenarioDepth').value = 'moderate';
                    document.getElementById('scenarioVariety').value = 'balanced';
                    document.getElementById('dialogueLength').value = 'basic';
                    document.getElementById('conversationStyle').value = 'natural';
                    document.getElementById('emotionalRange').value = 'balanced';
                    document.getElementById('mbtiAccuracy').value = 'basic';
                    document.getElementById('personalityConsistency').value = 'consistent';
                    document.getElementById('responseIntelligence').value = 'smart';
                    document.getElementById('repetitionAvoidance').value = 'moderate';
                    document.getElementById('memoryDepth').value = 'medium';
                    document.getElementById('creativityBoost').value = 'balanced';

                    // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú ÏÑ§Ï†ï ÏÇ≠Ï†ú
                    localStorage.removeItem('chatgame_ai_settings');

                    updateAIEngineStatus('Í∏∞Î≥∏ ÏÑ§Ï†ï', 'info');
                    document.getElementById('aiQualityScore').textContent = '75%';

                    addPerformanceLog('ÏÑ§Ï†ï Ï¥àÍ∏∞Ìôî', 'AI ÏÑ§Ï†ïÏù¥ Í∏∞Î≥∏Í∞íÏúºÎ°ú Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§', 'info');
                    showNotification('‚úÖ AI ÏÑ§Ï†ïÏù¥ Í∏∞Î≥∏Í∞íÏúºÎ°ú Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§!', 'success');
                }
            } catch (error) {
                console.error('‚ùå AI ÏÑ§Ï†ï Ï¥àÍ∏∞Ìôî Ïã§Ìå®:', error);
                showNotification('‚ùå AI ÏÑ§Ï†ï Ï¥àÍ∏∞ÌôîÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message, 'error');
            }
        }

        // ÏïåÎ¶º Î©îÏãúÏßÄ ÌëúÏãú Ìï®Ïàò
        function showNotification(message, type = 'info') {
            // Í∏∞Ï°¥ ÏïåÎ¶ºÏù¥ ÏûàÏúºÎ©¥ Ï†úÍ±∞
            const existingNotification = document.querySelector('.notification-popup');
            if (existingNotification) {
                existingNotification.remove();
            }

            // ÏïåÎ¶º ÏöîÏÜå ÏÉùÏÑ±
            const notification = document.createElement('div');
            notification.className = 'notification-popup';

            // ÌÉÄÏûÖÎ≥Ñ Ïä§ÌÉÄÏùº ÏÑ§Ï†ï
            let backgroundColor = '#f8f9fa';
            let borderColor = '#dee2e6';
            let textColor = '#495057';

            switch (type) {
                case 'success':
                    backgroundColor = '#d4edda';
                    borderColor = '#c3e6cb';
                    textColor = '#155724';
                    break;
                case 'error':
                    backgroundColor = '#f8d7da';
                    borderColor = '#f5c6cb';
                    textColor = '#721c24';
                    break;
                case 'warning':
                    backgroundColor = '#fff3cd';
                    borderColor = '#ffeaa7';
                    textColor = '#856404';
                    break;
            }

            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                background: ${backgroundColor};
                border: 1px solid ${borderColor};
                color: ${textColor};
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                max-width: 400px;
                font-size: 14px;
                font-weight: 500;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
            `;

            notification.textContent = message;
            document.body.appendChild(notification);

            // Ïï†ÎãàÎ©îÏù¥ÏÖò Ìö®Í≥º
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 10);

            // 3Ï¥à ÌõÑ ÏûêÎèô Ï†úÍ±∞
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 3000);
        }

        // Î≥¥Ï°∞ Ìï®ÏàòÎì§
        function getAISettings() {
            const saved = localStorage.getItem('chatgame_ai_settings');
            if (saved) {
                return JSON.parse(saved);
            }

            return {
                scenarioContentLength: 'basic',
                scenarioDepth: 'moderate',
                scenarioVariety: 'balanced',
                dialogueLength: 'basic',
                conversationStyle: 'natural',
                emotionalRange: 'balanced',
                mbtiAccuracy: 'basic',
                personalityConsistency: 'consistent',
                responseIntelligence: 'smart',
                repetitionAvoidance: 'moderate',
                memoryDepth: 'medium',
                creativityBoost: 'balanced'
            };
        }

        function calculateQualityScore(settings) {
            let score = 75; // Í∏∞Î≥∏ Ï†êÏàò

            // ÏÑ§Ï†ïÎ≥Ñ Ï†êÏàò Í∞ÄÏÇ∞
            if (settings.scenarioContentLength === 'extended') score += 5;
            if (settings.scenarioContentLength === 'detailed') score += 10;
            if (settings.dialogueLength === 'extended') score += 5;
            if (settings.dialogueLength === 'verbose') score += 10;
            if (settings.mbtiAccuracy === 'enhanced') score += 3;
            if (settings.mbtiAccuracy === 'expert') score += 7;
            if (settings.repetitionAvoidance !== 'off') score += 3;

            return Math.min(score, 98); // ÏµúÎåÄ 98Ï†ê
        }

        function generateTestScenario(settings) {
            const titles = [
                'Ïπ¥ÌéòÏóêÏÑúÏùò Ïö∞Ïó∞Ìïú ÎßåÎÇ®',
                'ÎèÑÏÑúÍ¥ÄÏóêÏÑúÏùò Ï°∞Ïö©Ìïú ÎåÄÌôî',
                'ÎπÑ Ïò§Îäî ÎÇ†Ïùò ÏÑ§Î†ò',
                'Ï∂ïÏ†úÏóêÏÑúÏùò ÌäπÎ≥ÑÌïú ÏàúÍ∞Ñ'
            ];

            const baseContent = 'Îî∞ÎúªÌïú Ïò§ÌõÑ, Ï£ºÏù∏Í≥µÏùÄ ÌèâÏÜåÎ≥¥Îã§ ÏùºÏ∞ç ÎßàÏπú Í∞ïÏùòÎ•º Ïù¥Ïú†Î°ú Ï∫†ÌçºÏä§ Ïπ¥ÌéòÏóê Îì§Î†ÄÎã§.';
            let content = baseContent;

            // ÏÑ§Ï†ïÏóê Îî∞Î•∏ ÎÇ¥Ïö© ÌôïÏû•
            if (settings.scenarioContentLength === 'extended') {
                content += ' Ï∞ΩÍ∞Ä ÏûêÎ¶¨Ïóê ÏïâÏïÑ Ïª§ÌîºÎ•º ÎßàÏãúÎ©∞ Ï±ÖÏùÑ ÏùΩÍ≥† ÏûàÎäîÎç∞, Í∞ëÏûêÍ∏∞ ÎàÑÍµ∞Í∞Ä Ï°∞Ïã¨Ïä§ÎüΩÍ≤å Îã§Í∞ÄÏôîÎã§. ÏßÄÎÇú ÌïôÍ∏∞Ïóê Í∞ôÏùÄ ÏàòÏóÖÏùÑ Îì§ÏóàÎçò Í∑∏ ÏÇ¨ÎûåÏù¥ÏóàÎã§. ÏÑúÎ°ú ÎààÏù¥ ÎßàÏ£ºÏ≥§ÏùÑ ÎïåÏùò Í∑∏ ÏàúÍ∞Ñ, ÏãúÍ∞ÑÏù¥ Î©àÏ∂ò Í≤É Í∞ôÏïòÎã§.';
            } else if (settings.scenarioContentLength === 'detailed') {
                content += ' Ï∞ΩÍ∞Ä ÏûêÎ¶¨Ïóê ÏïâÏïÑ Ïª§ÌîºÎ•º ÎßàÏãúÎ©∞ Ï±ÖÏùÑ ÏùΩÍ≥† ÏûàÎäîÎç∞, Í∞ëÏûêÍ∏∞ ÎàÑÍµ∞Í∞Ä Ï°∞Ïã¨Ïä§ÎüΩÍ≤å Îã§Í∞ÄÏôîÎã§. ÏßÄÎÇú ÌïôÍ∏∞Ïóê Í∞ôÏùÄ ÏàòÏóÖÏùÑ Îì§ÏóàÎçò Í∑∏ ÏÇ¨ÎûåÏù¥ÏóàÎã§. ÏÑúÎ°ú ÎààÏù¥ ÎßàÏ£ºÏ≥§ÏùÑ ÎïåÏùò Í∑∏ ÏàúÍ∞Ñ, ÏãúÍ∞ÑÏù¥ Î©àÏ∂ò Í≤É Í∞ôÏïòÎã§. Ïπ¥Ìéò ÏïàÏùò ÏÜåÎûÄÏä§Îü¨Ïö¥ ÏÜåÏùåÎì§Ïù¥ ÏÇ¨ÎùºÏßÄÍ≥†, Ïò§ÏßÅ Îëê ÏÇ¨ÎûåÎßåÏù¥ Ï°¥Ïû¨ÌïòÎäî Í≤É Í∞ôÏùÄ Í≥†ÏöîÌï®Ïù¥ ÌùòÎ†ÄÎã§. Í∑∏Îäî Ï±ÖÏÉÅ ÏòÜÏùò Îπà ÏùòÏûêÎ•º Í∞ÄÎ¶¨ÌÇ§Î©∞ Ï°∞Ïã¨Ïä§ÎüΩÍ≤å Î¨ºÏóàÎã§.';
            }

            return {
                title: titles[Math.floor(Math.random() * titles.length)],
                content: content
            };
        }

        function generateTestDialogue(settings) {
            const baseDialogues = [
                'ÏïàÎÖïÌïòÏÑ∏Ïöî... ÌòπÏãú ÏûêÎ¶¨Í∞Ä ÎπÑÏñ¥ÏûàÎÇòÏöî?',
                'ÏïÑ, ÎÑ§! Î¨ºÎ°†Ïù¥Ï£†. ÏïâÏúºÏÑ∏Ïöî.',
                'Í∞êÏÇ¨Ìï©ÎãàÎã§. ÏßÄÎÇú ÌïôÍ∏∞Ïóê Í∞ôÏùÄ ÏàòÏóÖ Îì§ÏóàÎçò...'
            ];

            let dialogues = [...baseDialogues];

            // ÏÑ§Ï†ïÏóê Îî∞Î•∏ ÎåÄÌôî ÌôïÏû•
            if (settings.dialogueLength === 'extended') {
                dialogues.push(
                    'ÏïÑ, ÎßûÎã§! Ïã¨Î¶¨Ìïô ÏàòÏóÖÏù¥ÏóàÏ£†. Í∏∞ÏñµÎÇòÏöî.',
                    'ÎÑ§, Í∑∏Îïå Î∞úÌëú Ï†ïÎßê Ïù∏ÏÉÅÍπäÏóàÏñ¥Ïöî.',
                    'ÏïÑ... Í∞êÏÇ¨Ìï¥Ïöî. Îñ®Î†∏ÎäîÎç∞ Îã§ÌñâÏù¥ÎÑ§Ïöî.',
                    'Ï†ÑÌòÄÏöî, Ï†ïÎßê ÏûêÏã†Í∞ê ÏûàÏñ¥ Î≥¥ÏòÄÎäîÎç∞.',
                    'Í∑∏Î†áÍ≤å ÎßêÏîÄÌï¥Ï£ºÏãúÎãà Í∏∞Î∂ÑÏù¥ Ï¢ãÎÑ§Ïöî.'
                );
            } else if (settings.dialogueLength === 'verbose') {
                dialogues.push(
                    'ÏïÑ, ÎßûÎã§! Ïã¨Î¶¨Ìïô ÏàòÏóÖÏù¥ÏóàÏ£†. Í∏∞ÏñµÎÇòÏöî.',
                    'ÎÑ§, Í∑∏Îïå Î∞úÌëú Ï†ïÎßê Ïù∏ÏÉÅÍπäÏóàÏñ¥Ïöî.',
                    'ÏïÑ... Í∞êÏÇ¨Ìï¥Ïöî. Îñ®Î†∏ÎäîÎç∞ Îã§ÌñâÏù¥ÎÑ§Ïöî.',
                    'Ï†ÑÌòÄÏöî, Ï†ïÎßê ÏûêÏã†Í∞ê ÏûàÏñ¥ Î≥¥ÏòÄÎäîÎç∞.',
                    'Í∑∏Î†áÍ≤å ÎßêÏîÄÌï¥Ï£ºÏãúÎãà Í∏∞Î∂ÑÏù¥ Ï¢ãÎÑ§Ïöî.',
                    'Ï†ÄÎèÑ Í∑∏ÎïåÎ∂ÄÌÑ∞ Í≥ÑÏÜç Îßê Í±∏Ïñ¥Î≥¥Í≥† Ïã∂ÏóàÏñ¥Ïöî.',
                    'Ï†ïÎßêÏöî? Ï†ÄÎèÑ ÎßàÏ∞¨Í∞ÄÏßÄÏòÄÎäîÎç∞...',
                    'Ïù¥Î†áÍ≤å Ïö∞Ïó∞Ìûà ÎßåÎÇòÍ≤å ÎêòÎã§Îãà, Ïö¥Î™ÖÏù∏Í∞ÄÏöî?',
                    'ÌïòÌïò, Ïö¥Î™ÖÏù¥Îùº... Í∑∏Îü¥ÏßÄÎèÑ Î™®Î•¥Ï£†.',
                    'Ïª§Ìîº Ìïú Ïûî Îçî Ïñ¥ÎïåÏöî? Ï†úÍ∞Ä ÏÇ¨ÎìúÎ¶¥Í≤åÏöî.'
                );
            }

            return dialogues;
        }

        function updateAIEngineStatus(status, type = 'info') {
            const statusElement = document.getElementById('aiEngineCurrentStatus');
            statusElement.textContent = status;
            statusElement.className = 'value ' + type;
        }

        function updateTodayGenerationCount() {
            const countElement = document.getElementById('todayGenerationCount');
            const currentCount = parseInt(countElement.textContent) || 0;
            countElement.textContent = currentCount + 1;
        }

        function addPerformanceLog(type, message, level = 'info') {
            const logContainer = document.getElementById('performanceLogContent');
            const now = new Date();
            const timeStr = now.getHours().toString().padStart(2, '0') + ':' +
                           now.getMinutes().toString().padStart(2, '0');

            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-time">${timeStr}</span>
                <span class="log-type ${level}">${type}</span>
                <span class="log-message">${message}</span>
            `;

            logContainer.insertBefore(logEntry, logContainer.firstChild);

            // Î°úÍ∑∏ ÏµúÎåÄ 10Í∞úÎ°ú Ï†úÌïú
            const entries = logContainer.children;
            if (entries.length > 10) {
                logContainer.removeChild(entries[entries.length - 1]);
            }
        }

        // AI Í¥ÄÎ¶¨ ÌÉ≠ ÌôúÏÑ±Ìôî Ïãú ÏÑ§Ï†ï Î°úÎìú
        function loadAISettings() {
            const settings = getAISettings();

            Object.keys(settings).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.value = settings[key];
                }
            });

            // ÌíàÏßà Ï†êÏàò ÏóÖÎç∞Ïù¥Ìä∏
            const qualityScore = calculateQualityScore(settings);
            document.getElementById('aiQualityScore').textContent = qualityScore + '%';
        }

        // Ï§ëÎ≥µ Ï¥àÍ∏∞Ìôî Ï†úÍ±∞Îê® - loadAllData()ÏóêÏÑú ÌÜµÌï© Ï≤òÎ¶¨
    </script>

    <script>
        // üåê Ïò®ÎùºÏù∏ Ï†ÑÏö© Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨Î°ú Ï†ÑÌôò
        console.log('üöÄ Ïò®ÎùºÏù∏ Ï†ÑÏö© Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú ÏãúÏûë...');

        // Í∞ÑÏÜåÌôîÎêú ÏßÅÏ†ë API Ìò∏Ï∂ú Î∞©Ïãù ÏÇ¨Ïö©
        console.log('‚úÖ Ïò®ÎùºÏù∏ Îç∞Ïù¥ÌÑ∞ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å (JWT Ïù∏Ï¶ù Ï†ïÏÉÅÌôî)');

        // Î°úÍ∑∏Ïù∏ ÌõÑ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ìï®Ïàò Ï†ïÏùò
        window.loadDataAfterLogin = async function() {
            try {
                console.log('üöÄ Î°úÍ∑∏Ïù∏ ÌõÑ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏãúÏûë...');

                // displayCharacters Ìï®ÏàòÍ∞Ä Ï†ïÏùòÎêòÏñ¥ ÏûàÎäîÏßÄ ÌôïÏù∏
                if (typeof displayCharacters !== 'function') {
                    console.error('‚ùå displayCharacters Ìï®ÏàòÍ∞Ä Ï†ïÏùòÎêòÏßÄ ÏïäÏùå');
                    return;
                }

                // CSS Î°úÎìú ÏôÑÎ£åÎ•º Î≥¥Ïû•ÌïòÍ∏∞ ÏúÑÌïú ÏßÄÏó∞
                await new Promise(resolve => {
                    if (document.readyState === 'complete') {
                        setTimeout(resolve, 100); // CSSÍ∞Ä ÏôÑÏ†ÑÌûà Ï†ÅÏö©Îê† ÏãúÍ∞ÑÏùÑ Ï§å
                    } else {
                        window.addEventListener('load', () => {
                            setTimeout(resolve, 100);
                        });
                    }
                });

                await window.loadCharacters();
                await window.loadScenarios();
                await loadTotalEpisodeCount(); // Ï†ÑÏ≤¥ ÏóêÌîºÏÜåÎìú Ïπ¥Ïö¥Ìä∏ Î°úÎìú
                displayAvailableScenarios(); // ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÏûêÎèô ÌëúÏãú

                // Ï∂îÍ∞ÄÏ†ÅÏù∏ ÏßÄÏó∞ ÌõÑ Îã§Ïãú Ìïú Î≤à ÏãúÎÇòÎ¶¨Ïò§ ÌëúÏãú (CSS Ï†ÅÏö© Î≥¥Ïû•)
                setTimeout(() => {
                    if (window.scenarios && Object.keys(window.scenarios).length > 0) {
                        console.log('üîÑ CSS Ï†ÅÏö© ÏôÑÎ£å ÌõÑ ÏãúÎÇòÎ¶¨Ïò§ Ïû¨ÌëúÏãú');
                        displayScenarios();
                    }
                }, 200);

                console.log('‚úÖ Î°úÍ∑∏Ïù∏ ÌõÑ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å');
            } catch (error) {
                console.error('‚ùå Î°úÍ∑∏Ïù∏ ÌõÑ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
                console.log('üí° ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®ÌïòÍ±∞ÎÇò ÏàòÎèôÏúºÎ°ú Îç∞Ïù¥ÌÑ∞Î•º Î°úÎìúÌï¥Ï£ºÏÑ∏Ïöî');
            }
        };

        // Ï∫êÎ¶≠ÌÑ∞ ÏÇ≠Ï†ú Ìï®Ïàò - GitHub API ÏßÅÏ†ë Ïó∞Îèô
        window.deleteCharacter = async function(characterId) {
            console.log('üéØ deleteCharacter Ìï®Ïàò Ìò∏Ï∂úÎê®! (GitHub API Ïó∞Îèô Î≤ÑÏ†Ñ)');

            if (!confirm('Ï†ïÎßêÎ°ú Ïù¥ Ï∫êÎ¶≠ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                return;
            }

            try {
                console.log('üóëÔ∏è === Ï∫êÎ¶≠ÌÑ∞ ÏÇ≠Ï†ú ÏãúÏûë ===');
                console.log('üéØ ÏÇ≠Ï†úÌï† Ï∫êÎ¶≠ÌÑ∞ ID:', characterId);

                // 1. APIÎ•º ÌÜµÌïú ÏÑúÎ≤Ñ ÏÇ≠Ï†ú (GitHub ÎèôÍ∏∞Ìôî Ìè¨Ìï®)
                console.log('üì° ÏÑúÎ≤Ñ API Ìò∏Ï∂úÎ°ú Ï∫êÎ¶≠ÌÑ∞ ÏÇ≠Ï†ú...');
                const response = await fetch('/api/character-ai-generator', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'delete_character',
                        character_id: characterId
                    })
                });

                console.log('üì∂ API ÏùëÎãµ ÏÉÅÌÉú:', response.status);
                const result = await response.json();
                console.log('üì¶ API ÏùëÎãµ Îç∞Ïù¥ÌÑ∞:', result);

                if (!result.success) {
                    throw new Error(result.message || 'API ÏÇ≠Ï†ú Ïã§Ìå®');
                }

                console.log('‚úÖ ÏÑúÎ≤ÑÏóêÏÑú Ï∫êÎ¶≠ÌÑ∞ ÏÇ≠Ï†ú ÏôÑÎ£å (GitHub ÎèôÍ∏∞Ìôî Ìè¨Ìï®)');

                // 2. Î°úÏª¨ Ï†ÑÏó≠ Î≥ÄÏàòÏóêÏÑúÎèÑ ÏÇ≠Ï†ú (UI Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏Ïö©)
                console.log('üîÑ Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî...');
                if (characters && characters[characterId]) {
                    delete characters[characterId];
                    console.log('‚úÖ characters Ï†ÑÏó≠ Î≥ÄÏàòÏóêÏÑú ÏÇ≠Ï†ú');
                }
                if (window.characters && window.characters[characterId]) {
                    delete window.characters[characterId];
                    console.log('‚úÖ window.charactersÏóêÏÑú ÏÇ≠Ï†ú');
                }

                // 3. Ï†ÑÏ≤¥ Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                console.log('üîÑ Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®...');
                await window.loadCharacters();

                // 4. Ï∫êÎ¶≠ÌÑ∞ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
                if (typeof updateCharacterStats === 'function') {
                    updateCharacterStats();
                    console.log('‚úÖ Ï∫êÎ¶≠ÌÑ∞ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏');
                }

                // 5. ÏÑ±Í≥µ Î©îÏãúÏßÄ
                alert('‚úÖ Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                console.log('üéâ === Ï∫êÎ¶≠ÌÑ∞ ÏÇ≠Ï†ú ÏôÑÎ£å ===');

            } catch (error) {
                console.error('‚ùå === Ï∫êÎ¶≠ÌÑ∞ ÏÇ≠Ï†ú Ïã§Ìå® ===');
                console.error('‚ùå Ïò§Î•ò ÏÉÅÏÑ∏:', error);
                console.error('‚ùå Ïä§ÌÉù Ìä∏Î†àÏù¥Ïä§:', error.stack);

                // ÏÇ¨Ïö©ÏûêÏóêÍ≤å Íµ¨Ï≤¥Ï†ÅÏù∏ Ïò§Î•ò Î©îÏãúÏßÄ Ï†úÍ≥µ
                let errorMessage = 'Ï∫êÎ¶≠ÌÑ∞ ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.';
                if (error.message.includes('404')) {
                    errorMessage = 'Ï∫êÎ¶≠ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. Ïù¥ÎØ∏ ÏÇ≠Ï†úÎêòÏóàÍ±∞ÎÇò IDÍ∞Ä ÏûòÎ™ªÎêòÏóàÏùÑ Ïàò ÏûàÏäµÎãàÎã§.';
                } else if (error.message.includes('500')) {
                    errorMessage = 'ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.';
                } else if (error.message.includes('ÎÑ§Ìä∏ÏõåÌÅ¨')) {
                    errorMessage = 'ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞ÏùÑ ÌôïÏù∏ÌïòÍ≥† Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.';
                }

                alert('‚ùå ' + errorMessage + '\n\nÍ∏∞Ïà†Ï†Å Ïò§Î•ò: ' + error.message);
            }
        };

        // ÏãúÎÇòÎ¶¨Ïò§ ÏÇ≠Ï†ú Ìï®ÏàòÎäî ÏúÑÏóêÏÑú Ïù¥ÎØ∏ Íµ¨ÌòÑÎê® (GitHub API Ïó∞Îèô)

        // Ï†ÑÏó≠ Ìï®Ïàò ÍµêÏ≤¥: Ïò®ÎùºÏù∏ Îç∞Ïù¥ÌÑ∞ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÏÇ¨Ïö©
        window.loadCharacters = async function() {
            console.log('üåê === APIÎ•º ÌÜµÌïú Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú ÏãúÏûë ===');
            try {
                // ÏßÅÏ†ë API Ìò∏Ï∂úÎ°ú Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
                const response = await fetch(`/api/character-ai-generator?action=list_characters&_t=${Date.now()}`);
                if (!response.ok) {
                    throw new Error(`API Ìò∏Ï∂ú Ïã§Ìå®: ${response.status}`);
                }
                const apiData = await response.json();
                const charactersData = apiData.characters || {};
                console.log('üìä APIÏóêÏÑú Î°úÎìúÎêú ÏõêÏãú Îç∞Ïù¥ÌÑ∞:', charactersData);
                console.log('üìä Îç∞Ïù¥ÌÑ∞ ÌÉÄÏûÖ:', typeof charactersData);
                console.log('üìä Îç∞Ïù¥ÌÑ∞ ÌÇ§Îì§:', Object.keys(charactersData || {}));

                // Ï†ÑÏó≠ characters Î≥ÄÏàòÏôÄ window.characters Î™®Îëê ÏóÖÎç∞Ïù¥Ìä∏
                characters = charactersData || {};
                window.characters = characters;

                console.log('üìã Ï†ÑÏó≠ Î≥ÄÏàò ÏÑ§Ï†ï ÌõÑ ÌôïÏù∏:', typeof characters, Object.keys(characters).length, 'Í∞ú Ï∫êÎ¶≠ÌÑ∞');
                console.log('üìã window.characters ÌôïÏù∏:', typeof window.characters, Object.keys(window.characters || {}).length, 'Í∞ú Ï∫êÎ¶≠ÌÑ∞');

                displayCharacters();
                updateCharacterStats();
                console.log('‚úÖ === Ï∫êÎ¶≠ÌÑ∞ Ïò®ÎùºÏù∏ Î°úÎìú ÏôÑÎ£å ===');
            } catch (error) {
                console.error('‚ùå Ï∫êÎ¶≠ÌÑ∞ Ïò®ÎùºÏù∏ Î°úÎìú Ïã§Ìå®:', error);
                console.error('‚ùå ÏóêÎü¨ ÏÉÅÏÑ∏:', error.stack);
                alert('Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§:\n' + error.message);

                // Ïò§Î•ò Î∞úÏÉù Ïãú Îπà Îç∞Ïù¥ÌÑ∞Î°ú Ï¥àÍ∏∞Ìôî
                characters = {};
                window.characters = characters;
                console.log('üîÑ Îπà Îç∞Ïù¥ÌÑ∞Î°ú Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
                displayCharacters();
                updateCharacterStats();
            }
        };

        // üîÑ Ï∫êÎ¶≠ÌÑ∞ Ï†ÄÏû• Ìï®Ïàò v2.0 (ÏÉàÎ°úÏö¥ Ïä§ÌÇ§Îßà ÏßÄÏõê)
        // üöÄ ÎÇôÍ¥ÄÏ†Å UI ÏóÖÎç∞Ïù¥Ìä∏ + Î∞±Í∑∏ÎùºÏö¥Îìú Ï†ÄÏû• ÏãúÏä§ÌÖú
        window.saveCharacter = async function() {
            console.log('‚ö° === ÎÇôÍ¥ÄÏ†Å Ï∫êÎ¶≠ÌÑ∞ Ï†ÄÏû• v3.0 ÏãúÏûë ===');

            // üéØ ÏÉàÎ°úÏö¥ collectCharacterFormData Ìï®Ïàò ÏÇ¨Ïö©
            const characterData = collectCharacterFormData();

            // üîç ÌïÑÏàò ÌïÑÎìú Í≤ÄÏ¶ù
            const name = characterData.basic_info?.name;
            const mbti = characterData.basic_info?.mbti;

            console.log('üìù ÏûÖÎ†•Í∞í ÌôïÏù∏:');
            console.log('  - Ïù¥Î¶Ñ:', name || '(ÎπÑÏñ¥ÏûàÏùå)');
            console.log('  - MBTI:', mbti || '(ÎπÑÏñ¥ÏûàÏùå)');

            if (!name || !mbti) {
                console.error('‚ùå ÌïÑÏàò ÏûÖÎ†•Í∞í ÎàÑÎùΩ');
                alert(`Ïù¥Î¶ÑÍ≥º MBTIÎäî ÌïÑÏàò ÏûÖÎ†• Ìï≠Î™©ÏûÖÎãàÎã§.\n\nÌòÑÏû¨ ÏûÖÎ†•Í∞í:\nÏù¥Î¶Ñ: ${name || 'ÎØ∏ÏûÖÎ†•'}\nMBTI: ${mbti || 'ÎØ∏ÏûÖÎ†•'}`);
                return;
            }

            // üÜî Ìé∏Ïßë Î™®ÎìúÏôÄ Ïã†Í∑ú ÏÉùÏÑ± Î™®Îìú Íµ¨Î∂Ñ
            const isEditMode = currentMode === 'edit' && characterData.id;

            if (isEditMode) {
                console.log('‚úèÔ∏è Ìé∏Ïßë Î™®Îìú: Í∏∞Ï°¥ ID Ïú†ÏßÄ -', characterData.id);
            } else {
                // Ïã†Í∑ú ÏÉùÏÑ±: Ìï≠ÏÉÅ ÏÉàÎ°úÏö¥ ID ÏÉùÏÑ±
                characterData.id = `${name.toLowerCase().replace(/\s+/g, '_')}_${mbti.toLowerCase()}_${Date.now()}`;
                console.log('üÜï Ïã†Í∑ú ÏÉùÏÑ±: ÏÉàÎ°úÏö¥ ID ÏÉùÏÑ± -', characterData.id);
            }

            // üìÖ Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä
            characterData.created_at = new Date().toISOString();
            characterData.updated_at = new Date().toISOString();
            characterData.source = 'scenario_admin_v2';
            characterData.active = true;
            characterData.version = '2.0';

            console.log('üíæ ÏµúÏ¢Ö Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ v3.0:', characterData);

            // ‚ö° 1Îã®Í≥Ñ: Ï¶âÏãú UI ÏÑ±Í≥µ Ï≤òÎ¶¨ (ÎÇôÍ¥ÄÏ†Å ÏóÖÎç∞Ïù¥Ìä∏)
            console.log('üéØ 1Îã®Í≥Ñ: Ï¶âÏãú UI ÏÑ±Í≥µ Ï≤òÎ¶¨ ÏãúÏûë...');

            // Ï∫êÎ¶≠ÌÑ∞Î•º Î©îÎ™®Î¶¨Ïóê Ï¶âÏãú Ï∂îÍ∞Ä
            if (!window.characters) window.characters = {};
            window.characters[characterData.id] = characterData;

            // UI Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏
            displayCharacters();

            // Ï¶âÏãú ÏÑ±Í≥µ Î©îÏãúÏßÄ ÌëúÏãú
            const successMessage = `üíñ Ï∫êÎ¶≠ÌÑ∞ '${name}' Ï†ÄÏû• ÏôÑÎ£å!\n‚ö° Ï¶âÏãú ÏÇ¨Ïö© Í∞ÄÎä•Ìï©ÎãàÎã§!`;
            alert(successMessage);

            // Î™®Îã¨ Ï¶âÏãú Îã´Í∏∞
            if (typeof closeModal === 'function') {
                closeModal('characterModal');
            } else {
                const modal = document.getElementById('characterModal');
                if (modal) modal.style.display = 'none';
            }

            console.log('‚úÖ 1Îã®Í≥Ñ ÏôÑÎ£å: ÏÇ¨Ïö©ÏûêÏóêÍ≤å Ï¶âÏãú ÏÑ±Í≥µ ÌîºÎìúÎ∞± Ï†úÍ≥µ');

            // ‚ö° 2Îã®Í≥Ñ: Î∞±Í∑∏ÎùºÏö¥ÎìúÏóêÏÑú GitHub Ï†ÄÏû• (Ïã§Ìå®Ìï¥ÎèÑ ÏÉÅÍ¥ÄÏóÜÏùå)
            console.log('üåê 2Îã®Í≥Ñ: Î∞±Í∑∏ÎùºÏö¥Îìú GitHub Ï†ÄÏû• ÏãúÏûë...');

            saveToGitHubBackground(characterData, name).catch(error => {
                console.log('üìù GitHub Ï†ÄÏû• Ïã§Ìå® - Ïû¨ÏãúÎèÑ ÌÅêÏóê Ï∂îÍ∞Ä:', error.message);
                addToRetryQueue(characterData);
            });
        };

        // üåê Î∞±Í∑∏ÎùºÏö¥Îìú GitHub Ï†ÄÏû• Ìï®Ïàò
        async function saveToGitHubBackground(characterData, name) {
            try {
                console.log('üêô Î∞±Í∑∏ÎùºÏö¥Îìú GitHub Ï†ÄÏû• ÏãúÏûë:', name);

                const response = await fetch('/api/character-ai-generator', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'save_character',
                        character: characterData
                    })
                });

                if (!response.ok) {
                    throw new Error(`GitHub API Ïã§Ìå®: ${response.status}`);
                }

                const result = await response.json();

                if (result && result.success) {
                    console.log('‚úÖ Î∞±Í∑∏ÎùºÏö¥Îìú GitHub Ï†ÄÏû• ÏÑ±Í≥µ:', name);
                    showQuietNotification(`üì° ${name} GitHub Î∞±ÏóÖ ÏôÑÎ£å`);
                } else {
                    throw new Error(result?.error || 'GitHub Ï†ÄÏû• Í≤∞Í≥º ÏóÜÏùå');
                }

            } catch (error) {
                console.error('‚ùå Î∞±Í∑∏ÎùºÏö¥Îìú GitHub Ï†ÄÏû• Ïã§Ìå®:', error);
                throw error; // Ïû¨ÏãúÎèÑ ÌÅêÎ•º ÏúÑÌï¥ ÏóêÎü¨Î•º Îã§Ïãú ÎçòÏßê
            }
        }

        // üîÑ Ïû¨ÏãúÎèÑ ÌÅê ÏãúÏä§ÌÖú
        let retryQueue = [];
        let retryTimer = null;

        function addToRetryQueue(characterData) {
            retryQueue.push(characterData);
            console.log(`üìã Ïû¨ÏãúÎèÑ ÌÅêÏóê Ï∂îÍ∞Ä: ${characterData.basic_info?.name} (ÌÅê ÌÅ¨Í∏∞: ${retryQueue.length})`);

            // 30Ï¥à ÌõÑ Ïû¨ÏãúÎèÑ ÏãúÏûë
            if (!retryTimer) {
                retryTimer = setTimeout(() => {
                    processRetryQueue();
                }, 30000);
            }
        }

        async function processRetryQueue() {
            if (retryQueue.length === 0) {
                retryTimer = null;
                return;
            }

            console.log(`üîÑ Ïû¨ÏãúÎèÑ ÌÅê Ï≤òÎ¶¨ ÏãúÏûë (${retryQueue.length}Í∞ú Ìï≠Î™©)`);

            const itemsToRetry = [...retryQueue];
            retryQueue = [];

            for (const characterData of itemsToRetry) {
                try {
                    await saveToGitHubBackground(characterData, characterData.basic_info?.name);
                } catch (error) {
                    console.log(`‚ùå Ïû¨ÏãúÎèÑ Ïã§Ìå®: ${characterData.basic_info?.name}`);
                    // 3Î≤àÍπåÏßÄ Ïû¨ÏãúÎèÑ (Í∞ÑÎã®Ìïú Ïπ¥Ïö¥ÌÑ∞ Ï∂îÍ∞Ä Í∞ÄÎä•)
                    retryQueue.push(characterData);
                }
            }

            // ÏïÑÏßÅ Ïã§Ìå®Ìïú Ìï≠Î™©Ïù¥ ÏûàÏúºÎ©¥ 5Î∂Ñ ÌõÑ Îã§Ïãú ÏãúÎèÑ
            if (retryQueue.length > 0) {
                retryTimer = setTimeout(() => {
                    processRetryQueue();
                }, 300000); // 5Î∂Ñ
            } else {
                retryTimer = null;
            }
        }

        // üîî Ï°∞Ïö©Ìïú ÏïåÎ¶º ÌëúÏãú Ìï®Ïàò
        function showQuietNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 10px 15px;
                border-radius: 5px;
                font-size: 14px;
                z-index: 10000;
                opacity: 0;
                transition: opacity 0.3s;
            `;
            notification.textContent = message;

            document.body.appendChild(notification);

            // ÌéòÏù¥Îìú Ïù∏
            setTimeout(() => notification.style.opacity = '1', 100);

            // 3Ï¥à ÌõÑ ÌéòÏù¥Îìú ÏïÑÏõÉ Î∞è Ï†úÍ±∞
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        window.loadScenarios = async function() {
            console.log('üåê APIÎ•º ÌÜµÌïú ÏãúÎÇòÎ¶¨Ïò§ Î°úÎìú...');
            try {
                // ÏßÅÏ†ë API Ìò∏Ï∂úÎ°ú ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
                const response = await fetch(`/api/scenario-manager?action=list&_t=${Date.now()}`);
                if (!response.ok) {
                    throw new Error(`API Ìò∏Ï∂ú Ïã§Ìå®: ${response.status}`);
                }
                const apiData = await response.json();
                const scenariosData = apiData.scenarios || {};
                window.scenarios = scenariosData;
                displayScenarios();
                updateScenarioStats();
                console.log('‚úÖ ÏãúÎÇòÎ¶¨Ïò§ API Î°úÎìú ÏôÑÎ£å');
            } catch (error) {
                console.error('‚ùå ÏãúÎÇòÎ¶¨Ïò§ API Î°úÎìú Ïã§Ìå®:', error);
                // Ïò§Î•ò Ïãú Îπà Í∞ùÏ≤¥Î°ú Ï¥àÍ∏∞Ìôî
                window.scenarios = {};
                displayScenarios();
                updateScenarioStats();
            }
        };

        // Ïò®ÎùºÏù∏ ÏÉÅÌÉú ÌëúÏãú (Îã®ÏàúÌôîÎê®)
        setInterval(() => {
            const statusIndicator = document.getElementById('onlineStatus') || createStatusIndicator();
            statusIndicator.textContent = 'üåê Ïò®ÎùºÏù∏';
            statusIndicator.style.color = '#28a745';
        }, 30000); // 30Ï¥àÎßàÎã§ Ï≤¥ÌÅ¨

        // Ïò®ÎùºÏù∏ ÏÉÅÌÉú ÌëúÏãúÍ∏∞ ÏÉùÏÑ±
        function createStatusIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'onlineStatus';
            indicator.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: white;
                padding: 8px 12px;
                border-radius: 20px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                font-size: 14px;
                font-weight: bold;
                z-index: 1000;
            `;
            document.body.appendChild(indicator);
            return indicator;
        }

        console.log('‚úÖ Ïò®ÎùºÏù∏ Ï†ÑÏö© ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');

        // üé≠ Ï∫êÎ¶≠ÌÑ∞ ÏöîÏïΩ ÏÑπÏÖò Ï†ëÍ∏∞/ÌéºÏπòÍ∏∞ Ìï®Ïàò
        window.toggleCharacterSummary = function() {
            const detailsSection = document.querySelector('.summary-details');
            const toggleText = document.getElementById('summaryToggleText');

            if (detailsSection && toggleText) {
                if (detailsSection.classList.contains('collapsed')) {
                    detailsSection.classList.remove('collapsed');
                    toggleText.textContent = 'üìñ Í∞ÑÎã®Ìûà Î≥¥Í∏∞';
                } else {
                    detailsSection.classList.add('collapsed');
                    toggleText.textContent = 'üìñ ÏûêÏÑ∏Ìûà Î≥¥Í∏∞';
                }
            }
        };

        // ‚ú® ÏóêÌîºÏÜåÎìú Î™©Î°ù Í¥ÄÎ¶¨ Ìï®ÏàòÎì§ (ÏÉàÎ°ú Ï∂îÍ∞Ä)

        // ÏóêÌîºÏÜåÎìú Î™©Î°ù Î°úÎìú
        async function loadEpisodesList(filterScenarioId = null) {
            console.log('üìö ÏóêÌîºÏÜåÎìú Î™©Î°ù Î°úÎìú ÏãúÏûë...');
            console.log('üîç ÌïÑÌÑ∞ ÏãúÎÇòÎ¶¨Ïò§ ID:', filterScenarioId || 'Ï†ÑÏ≤¥ ÌëúÏãú');
            const container = document.getElementById('episodesListContainer');

            try {
                // dialogue-manager APIÎ•º ÌÜµÌï¥ Ï†ÑÏ≤¥ ÏóêÌîºÏÜåÎìú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
                const response = await fetch('/api/dialogue-manager?action=get_all_episodes');
                if (!response.ok) {
                    throw new Error(`API Ìò∏Ï∂ú Ïã§Ìå®: ${response.status}`);
                }

                const data = await response.json();
                console.log('üìä ÏóêÌîºÏÜåÎìú API ÏùëÎãµ:', data);

                if (!data.success) {
                    throw new Error(data.message || 'ÏóêÌîºÏÜåÎìú Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®');
                }

                // ÏóêÌîºÏÜåÎìú Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
                const episodes = Object.values(data.episodes || {});

                // ÌïÑÌÑ∞ÎßÅ (ÏãúÎÇòÎ¶¨Ïò§ IDÍ∞Ä Ï†úÍ≥µÎêú Í≤ΩÏö∞)
                const filteredEpisodes = filterScenarioId
                    ? episodes.filter(episode => episode.scenario_id === filterScenarioId)
                    : episodes;

                console.log('üìä Î°úÎìúÎêú ÏóêÌîºÏÜåÎìú:', filteredEpisodes.length, 'Í∞ú');

                displayEpisodesAsCards(filteredEpisodes, filterScenarioId);

            } catch (error) {
                console.error('‚ùå ÏóêÌîºÏÜåÎìú Î™©Î°ù Î°úÎìú Ïã§Ìå®:', error);
                container.innerHTML = `
                    <div class="error-card">
                        <h4>‚ùå ÏóêÌîºÏÜåÎìú Î°úÎìú Ïã§Ìå®</h4>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="loadEpisodesList()">üîÑ Îã§Ïãú ÏãúÎèÑ</button>
                    </div>
                `;
            }
        }

        // ÏóêÌîºÏÜåÎìúÎ•º Í∞úÎ≥Ñ Ïπ¥ÎìúÎ°ú ÌëúÏãúÌïòÎäî Ìï®Ïàò (ÏÉàÎ°ú Ï∂îÍ∞Ä)
        function displayEpisodesAsCards(episodes, filterScenarioId = null) {
            const container = document.getElementById('episodesListContainer');

            if (episodes.length === 0) {
                const message = filterScenarioId
                    ? 'ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§Ïóê ÏÉùÏÑ±Îêú ÏóêÌîºÏÜåÎìúÍ∞Ä ÏóÜÏäµÎãàÎã§'
                    : 'ÏÉùÏÑ±Îêú ÏóêÌîºÏÜåÎìúÍ∞Ä ÏóÜÏäµÎãàÎã§';

                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                        <h3>üì≠ ${message}</h3>
                        <p>ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÑ†ÌÉùÌïòÍ≥† ÏÉàÎ°úÏö¥ ÏóêÌîºÏÜåÎìúÎ•º ÏÉùÏÑ±Ìï¥Î≥¥ÏÑ∏Ïöî!</p>
                        ${filterScenarioId ? `<button class="btn btn-secondary" onclick="loadEpisodesList()">üîÑ Ï†ÑÏ≤¥ ÏóêÌîºÏÜåÎìú Î≥¥Í∏∞</button>` : ''}
                    </div>
                `;
                return;
            }

            // ÏóêÌîºÏÜåÎìúÎ•º ÏµúÏã†ÏàúÏúºÎ°ú Ï†ïÎ†¨
            const sortedEpisodes = episodes.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            // ÏãúÎÇòÎ¶¨Ïò§ÏôÄ Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
            const scenariosData = window.scenarios || {};
            const charactersData = window.characters || {};

            const episodeCards = sortedEpisodes.map(episode => {
                // ÏãúÎÇòÎ¶¨Ïò§ Ï†ïÎ≥¥
                const scenario = scenariosData[episode.scenario_id];
                const scenarioTitle = scenario ? scenario.title : episode.scenario_id;

                // Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥
                const character = charactersData[episode.character_id];
                const characterName = episode.character_name || (character ? character.name : episode.character_id);

                // ÎÇ†Ïßú Ìè¨Îß∑
                const createdDate = new Date(episode.created_at).toLocaleDateString('ko-KR');

                // ÎåÄÌôî ÎÇ¥Ïö© ÎØ∏Î¶¨Î≥¥Í∏∞
                const dialoguePreview = episode.dialogue?.dialogue
                    ? episode.dialogue.dialogue.substring(0, 80) + '...'
                    : episode.dialogue?.story_flow?.[0]?.text?.substring(0, 80) + '...'
                    || 'ÎåÄÌôî ÎÇ¥Ïö© ÏóÜÏùå';

                // ÏÑ†ÌÉùÏßÄ Í∞úÏàò
                const choiceCount = episode.dialogue?.choices?.length
                    || episode.dialogue?.story_flow?.filter(item => item.type === 'choice_point')?.[0]?.choices?.length
                    || 0;

                return `
                    <div class="individual-episode-card" onclick="previewEpisodeDialogue('${episode.id}')">
                        <div class="episode-card-header">
                            <div class="episode-info">
                                <h6 class="episode-title">${episode.title || `ÎåÄÌôî ${episode.dialogue_number || 1}Î≤à`}</h6>
                                <div class="episode-meta">
                                    <span class="scenario-name">üìö ${scenarioTitle}</span>
                                    <span class="character-name">üë§ ${characterName}</span>
                                </div>
                            </div>
                            <div class="episode-badges">
                                <span class="difficulty-badge ${(episode.difficulty || 'Easy').toLowerCase()}">${(episode.difficulty || 'Easy').toUpperCase()}</span>
                            </div>
                        </div>

                        <div class="episode-card-content">
                            <div class="dialogue-preview-text">
                                ${dialoguePreview}
                            </div>
                            <div class="episode-stats">
                                <span class="stat-item">üí¨ ÏÑ†ÌÉùÏßÄ ${choiceCount}Í∞ú</span>
                                <span class="stat-item">üìÖ ${createdDate}</span>
                            </div>
                        </div>

                        <div class="episode-card-actions">
                            <span class="action-btn">üìñ ÎåÄÌôî Î≥¥Í∏∞</span>
                            <button class="delete-episode-btn" onclick="event.stopPropagation(); deleteIndividualEpisode('${episode.id}')" title="ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            // ÌïÑÌÑ∞ÎßÅ ÏÉÅÌÉú ÌëúÏãú
            const filterInfo = filterScenarioId
                ? `<div class="filter-info" style="grid-column: 1 / -1; text-align: center; margin-bottom: 20px;">
                     <span class="filter-label">üîç "${scenariosData[filterScenarioId]?.title || filterScenarioId}" ÏãúÎÇòÎ¶¨Ïò§Ïùò ÏóêÌîºÏÜåÎìú ÌëúÏãú Ï§ë</span>
                     <button class="btn btn-sm btn-secondary" onclick="loadEpisodesList()" style="margin-left: 10px;">Ï†ÑÏ≤¥ Î≥¥Í∏∞</button>
                   </div>`
                : '';

            container.innerHTML = filterInfo + episodeCards;
        }

        // Í∞úÎ≥Ñ ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú Ìï®Ïàò (ÏÉàÎ°ú Ï∂îÍ∞Ä)
        async function deleteIndividualEpisode(episodeId) {
            console.log('üóëÔ∏è Í∞úÎ≥Ñ ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú:', episodeId);

            // ÏÇ¨Ïö©Ïûê ÌôïÏù∏
            if (!confirm(`Ï†ïÎßêÎ°ú Ïù¥ ÏóêÌîºÏÜåÎìúÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÏóêÌîºÏÜåÎìú ID: ${episodeId}\n\n‚ö†Ô∏è Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.`)) {
                return;
            }

            try {
                // APIÎ°ú ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú ÏöîÏ≤≠
                const response = await fetch('/api/dialogue-manager', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'delete_episode',
                        episode_id: episodeId
                    })
                });

                const result = await response.json();
                console.log('üóëÔ∏è ÏÇ≠Ï†ú API ÏùëÎãµ:', result);

                if (result.success) {
                    alert('‚úÖ ÏóêÌîºÏÜåÎìúÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');

                    // ÌòÑÏû¨ ÌïÑÌÑ∞ ÏÉÅÌÉú Ïú†ÏßÄÌïòÎ©¥ÏÑú Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                    const currentFilter = getCurrentScenarioFilter();
                    await loadEpisodesList(currentFilter);

                    // ÏóêÌîºÏÜåÎìú Ïπ¥Ïö¥Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
                    await loadTotalEpisodeCount();

                } else {
                    throw new Error(result.message || 'ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú Ïã§Ìå®');
                }

            } catch (error) {
                console.error('‚ùå ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú Ïã§Ìå®:', error);
                alert(`‚ùå ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú Ïã§Ìå®:\n${error.message}`);
            }
        }

        // ÌòÑÏû¨ ÏãúÎÇòÎ¶¨Ïò§ ÌïÑÌÑ∞ ÏÉÅÌÉú Í∞ÄÏ†∏Ïò§Í∏∞
        function getCurrentScenarioFilter() {
            const filterInfo = document.querySelector('.filter-info .filter-label');
            if (filterInfo && filterInfo.textContent.includes('ÏãúÎÇòÎ¶¨Ïò§Ïùò ÏóêÌîºÏÜåÎìú ÌëúÏãú Ï§ë')) {
                // ÌòÑÏû¨ ÌïÑÌÑ∞Í∞Ä Ï†ÅÏö©Îêú ÏÉÅÌÉúÎùºÎ©¥ Ìï¥Îãπ ÏãúÎÇòÎ¶¨Ïò§ ID Î∞òÌôò
                // Ïù¥ Î∂ÄÎ∂ÑÏùÄ Ï†ÑÏó≠ Î≥ÄÏàòÎ°ú Í¥ÄÎ¶¨ÌïòÎäî Í≤ÉÏù¥ Îçî Ï¢ãÏßÄÎßå, ÏùºÎã® Í∞ÑÎã®ÌïòÍ≤å Íµ¨ÌòÑ
                return window.currentScenarioFilter || null;
            }
            return null;
        }

        // ÏóêÌîºÏÜåÎìúÎ•º ÏãúÎÇòÎ¶¨Ïò§+Ï∫êÎ¶≠ÌÑ∞ Ï°∞Ìï©ÏúºÎ°ú Í∑∏Î£πÌôî
        function groupEpisodesByScenarioCharacter(episodes) {
            const groups = {};

            Object.values(episodes).forEach(episode => {
                if (episode.scenario_id && episode.character_id) {
                    const groupKey = `${episode.scenario_id}_${episode.character_id}`;

                    if (!groups[groupKey]) {
                        groups[groupKey] = {
                            scenario_id: episode.scenario_id,
                            character_id: episode.character_id,
                            character_name: episode.character_name,
                            episodes: [],
                            total_dialogues: 0,
                            created_at: episode.created_at
                        };
                    }

                    groups[groupKey].episodes.push(episode);
                    groups[groupKey].total_dialogues++;

                    // Í∞ÄÏû• ÏµúÍ∑º ÏÉùÏÑ± ÏãúÍ∞ÑÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏
                    if (episode.created_at > groups[groupKey].created_at) {
                        groups[groupKey].created_at = episode.created_at;
                    }
                }
            });

            return groups;
        }

        // ÏóêÌîºÏÜåÎìú Î™©Î°ù ÌëúÏãú
        function displayEpisodesList(episodeGroups) {
            const container = document.getElementById('episodesListContainer');

            if (Object.keys(episodeGroups).length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                        <h3>üì≠ ÏÉùÏÑ±Îêú ÏóêÌîºÏÜåÎìúÍ∞Ä ÏóÜÏäµÎãàÎã§</h3>
                        <p>ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÑ†ÌÉùÌïòÍ≥† AIÎ°ú ÏóêÌîºÏÜåÎìúÎ•º ÏÉùÏÑ±Ìï¥Î≥¥ÏÑ∏Ïöî!</p>
                    </div>
                `;
                return;
            }

            const episodeCards = Object.entries(episodeGroups).map(([groupKey, group]) => {
                // ÏãúÎÇòÎ¶¨Ïò§ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                const scenariosData = window.scenarios || scenarios || {};
                const scenario = scenariosData[group.scenario_id];
                const scenarioTitle = scenario ? scenario.title : group.scenario_id;

                // Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                const charactersData = window.characters || characters || {};
                const character = charactersData[group.character_id];
                const characterMbti = character ? character.mbti : 'Unknown';

                // ÎÇúÏù¥ÎèÑÎ≥Ñ ÌÜµÍ≥Ñ Í≥ÑÏÇ∞
                const difficultyStats = calculateDifficultyStats(group.episodes);

                return `
                    <div class="episode-list-card" onclick="viewEpisodeDialogues('${groupKey}', '${scenarioTitle}', '${group.character_name}')">
                        <div class="episode-header">
                            <div>
                                <div class="episode-title">${scenarioTitle}</div>
                                <div class="episode-subtitle">with ${group.character_name}</div>
                            </div>
                            <div class="episode-badge">${group.total_dialogues}Í∞ú ÎåÄÌôî</div>
                        </div>

                        <div class="episode-content">
                            <div class="character-info">
                                <div class="character-avatar">üë§</div>
                                <div class="character-details">
                                    <div class="character-name">${group.character_name}</div>
                                    <div class="character-mbti">MBTI: ${characterMbti}</div>
                                </div>
                            </div>

                            <div class="episode-stats">
                                <div class="stat-item">
                                    <span class="stat-number">${difficultyStats.easy}</span>
                                    <span class="stat-label">Easy</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-number">${difficultyStats.medium}</span>
                                    <span class="stat-label">Medium</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-number">${difficultyStats.hard}</span>
                                    <span class="stat-label">Hard</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-number">${difficultyStats.expert}</span>
                                    <span class="stat-label">Expert</span>
                                </div>
                            </div>
                        </div>

                        <div class="episode-actions">
                            <span class="action-btn">üìñ ÎåÄÌôî Î≥¥Í∏∞</span>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = episodeCards;
        }

        // ÎÇúÏù¥ÎèÑÎ≥Ñ ÌÜµÍ≥Ñ Í≥ÑÏÇ∞
        function calculateDifficultyStats(episodes) {
            const stats = { easy: 0, medium: 0, hard: 0, expert: 0 };

            episodes.forEach(episode => {
                const difficulty = episode.difficulty ? episode.difficulty.toLowerCase() : 'easy';
                if (stats.hasOwnProperty(difficulty)) {
                    stats[difficulty]++;
                }
            });

            return stats;
        }

        // ÏóêÌîºÏÜåÎìú ÎåÄÌôî Î≥¥Í∏∞
        function viewEpisodeDialogues(groupKey, scenarioTitle, characterName) {
            console.log('üìñ ÏóêÌîºÏÜåÎìú ÎåÄÌôî Î≥¥Í∏∞:', groupKey, scenarioTitle, characterName);

            // Ï†úÎ™© ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('selectedEpisodeTitle').textContent =
                `üìñ ${scenarioTitle} - ${characterName}Ïùò ÎåÄÌôî Î™©Î°ù`;

            // ÏóêÌîºÏÜåÎìú Î™©Î°ù Ïà®Í∏∞Í≥† ÎåÄÌôî Î™©Î°ù ÌëúÏãú
            document.querySelector('.episodes-list-section').style.display = 'none';
            document.getElementById('selectedEpisodeDialogues').style.display = 'block';

            // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Í∑∏Î£πÏùò ÏãúÎÇòÎ¶¨Ïò§ IDÎ•º episodeGroupsÏóêÏÑú Í∞ÄÏ†∏Ïò§Í∏∞
            // groupKeyÎäî "scenario_id_character_id" ÌòïÏãùÏù¥ÎØÄÎ°ú ÏßÅÏ†ë ÌååÏã±ÌïòÍ∏∞ Ïñ¥Î†§ÏõÄ
            // Îî∞ÎùºÏÑú APIÏóêÏÑú ÏóêÌîºÏÜåÎìú Îç∞Ïù¥ÌÑ∞Î•º Î°úÎìúÌï¥ÏÑú scenario_idÎ•º Ï∞æÎäî Í≤ÉÏù¥ Îçî ÏïàÏ†ÑÌï®
            console.log('üîë GroupKeyÎ°ú scenario_id Ï∞æÍ∏∞:', groupKey);

            // Ìï¥Îãπ ÏóêÌîºÏÜåÎìúÏùò Ïã§Ï†ú ÎåÄÌôîÎì§Îßå ÌëúÏãú (Îπà Ïπ¥Îìú ÎåÄÏã†)
            displayEpisodeSpecificDialogues(groupKey, scenarioTitle, characterName);
        }

        // ÌäπÏ†ï ÏóêÌîºÏÜåÎìúÏùò ÎåÄÌôîÎßå ÌëúÏãú (ÏÉàÎ°ú Ï∂îÍ∞Ä)
        async function displayEpisodeSpecificDialogues(groupKey, scenarioTitle, characterName) {
            console.log('üéØ ÌäπÏ†ï ÏóêÌîºÏÜåÎìú ÎåÄÌôî ÌëúÏãú:', groupKey);
            const grid = document.getElementById('dialoguesGrid');

            try {
                // Î°úÎî© ÌëúÏãú
                grid.innerHTML = `
                    <div class="loading-card" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                        <div class="spinner"></div>
                        <h4>üìñ ÎåÄÌôî Î°úÎî© Ï§ë...</h4>
                    </div>
                `;

                // dialogue-manager APIÎ•º ÌÜµÌï¥ Ï†ÑÏ≤¥ ÏóêÌîºÏÜåÎìú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
                const response = await fetch('/api/dialogue-manager?action=get_all_episodes');
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message || 'ÏóêÌîºÏÜåÎìú Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®');
                }

                // groupKeyÏóêÏÑú scenario_idÏôÄ character_idÎ•º Ïò¨Î∞îÎ•¥Í≤å Ï∂îÏ∂ú
                // groupKey ÌòïÏãù: "scenario_id_character_id"ÏóêÏÑú Ïã§Ï†ú Í∞íÎì§ÏùÑ Ï∞æÏïÑÏïº Ìï®
                console.log('üîë GroupKey Î∂ÑÏÑù:', groupKey);

                // Î™®Îì† ÏóêÌîºÏÜåÎìúÎ•º ÌôïÏù∏Ìï¥ÏÑú Ìï¥Îãπ groupKeyÏôÄ Îß§ÏπòÎêòÎäî Í≤ÉÎì§ÏùÑ Ï∞æÍ∏∞
                const episodeDialogues = Object.values(data.episodes || {}).filter(episode => {
                    if (!episode.scenario_id || !episode.character_id) return false;

                    const episodeGroupKey = `${episode.scenario_id}_${episode.character_id}`;
                    const isMatch = episodeGroupKey === groupKey;

                    if (isMatch) {
                        console.log('‚úÖ Îß§ÏπòÎêú ÏóêÌîºÏÜåÎìú:', {
                            episode_id: episode.id,
                            scenario_id: episode.scenario_id,
                            character_id: episode.character_id,
                            character_name: episode.character_name
                        });
                    }

                    return isMatch;
                });

                console.log('üîç ÌïÑÌÑ∞ÎßÅÎêú ÏóêÌîºÏÜåÎìú ÎåÄÌôî:', episodeDialogues.length, 'Í∞ú');

                if (episodeDialogues.length === 0) {
                    // ÎåÄÌôîÍ∞Ä ÏóÜÎäî Í≤ΩÏö∞
                    grid.innerHTML = `
                        <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                            <h3>üì≠ ÏÉùÏÑ±Îêú ÎåÄÌôîÍ∞Ä ÏóÜÏäµÎãàÎã§</h3>
                            <p>+ Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠Ìï¥ÏÑú ÏÉàÎ°úÏö¥ ÎåÄÌôîÎ•º Ï∂îÍ∞ÄÌï¥Î≥¥ÏÑ∏Ïöî!</p>
                            <button class="btn btn-primary" onclick="addNewDialogueToEpisode('${groupKey}', '${scenarioTitle}', '${characterName}')" style="margin-top: 20px;">
                                ‚ú® Ï≤´ Î≤àÏß∏ ÎåÄÌôî ÎßåÎì§Í∏∞
                            </button>
                        </div>
                    `;
                    return;
                }

                // Ïã§Ï†ú ÎåÄÌôîÎì§ÏùÑ Ïπ¥ÎìúÎ°ú ÌëúÏãú + Ï∂îÍ∞Ä Î≤ÑÌäº
                const dialogueCards = episodeDialogues.map((episode, index) => `
                    <div class="episode-dialogue-card" onclick="previewEpisodeDialogue('${episode.id}')">
                        <div class="dialogue-header">
                            <div class="dialogue-number">#${episode.episode_number || index + 1}</div>
                            <div class="difficulty-badge ${(episode.difficulty || 'Easy').toLowerCase()}">${(episode.difficulty || 'Easy').toUpperCase()}</div>
                        </div>
                        <div class="dialogue-content">
                            <div class="dialogue-preview">
                                ${episode.dialogue?.dialogue ? episode.dialogue.dialogue.substring(0, 100) + '...' : 'ÎåÄÌôî ÎÇ¥Ïö© ÏóÜÏùå'}
                            </div>
                            <div class="dialogue-info">
                                <span class="dialogue-choices">ÏÑ†ÌÉùÏßÄ ${episode.dialogue?.choices?.length || 0}Í∞ú</span>
                                <span class="dialogue-date">${new Date(episode.created_at).toLocaleDateString()}</span>
                            </div>
                        </div>
                        <div class="dialogue-actions">
                            <span class="action-btn">üìñ Î≥¥Í∏∞</span>
                            <button class="delete-episode-btn" onclick="event.stopPropagation(); deleteEpisodeDialogue('${episode.id}', '${groupKey}', '${scenarioTitle}', '${characterName}')" title="ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `).join('');

                // + Î≤ÑÌäº Ïπ¥Îìú Ï∂îÍ∞Ä
                const addButtonCard = `
                    <div class="add-dialogue-card" onclick="addNewDialogueToEpisode('${groupKey}', '${scenarioTitle}', '${characterName}')">
                        <div class="add-icon">+</div>
                        <div class="add-text">ÏÉà ÎåÄÌôî Ï∂îÍ∞Ä</div>
                    </div>
                `;

                grid.innerHTML = dialogueCards + addButtonCard;

            } catch (error) {
                console.error('‚ùå ÏóêÌîºÏÜåÎìú ÎåÄÌôî ÌëúÏãú Ïã§Ìå®:', error);
                grid.innerHTML = `
                    <div class="error-card" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                        <h4>‚ùå ÎåÄÌôî Î°úÎìú Ïã§Ìå®</h4>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="displayEpisodeSpecificDialogues('${groupKey}', '${scenarioTitle}', '${characterName}')">üîÑ Îã§Ïãú ÏãúÎèÑ</button>
                    </div>
                `;
            }
        }

        // ÏóêÌîºÏÜåÎìúÏóê ÏÉà ÎåÄÌôî Ï∂îÍ∞Ä (ÏÉàÎ°ú Ï∂îÍ∞Ä)
        async function addNewDialogueToEpisode(groupKey, scenarioTitle, characterName) {
            console.log('‚ú® ÏÉà ÎåÄÌôî Ï∂îÍ∞Ä:', groupKey, scenarioTitle, characterName);

            try {
                // APIÏóêÏÑú ÏóêÌîºÏÜåÎìú Îç∞Ïù¥ÌÑ∞ Î°úÎìúÌï¥ÏÑú Ïã§Ï†ú scenario_id Ï∞æÍ∏∞
                const response = await fetch('/api/dialogue-manager?action=get_all_episodes');
                const data = await response.json();

                if (data.success && data.episodes) {
                    // Ìï¥Îãπ groupKeyÏôÄ Îß§ÏπòÎêòÎäî ÏóêÌîºÏÜåÎìú Ï∞æÍ∏∞
                    const matchingEpisode = Object.values(data.episodes).find(episode => {
                        if (!episode.scenario_id || !episode.character_id) return false;
                        const episodeGroupKey = `${episode.scenario_id}_${episode.character_id}`;
                        return episodeGroupKey === groupKey;
                    });

                    if (matchingEpisode) {
                        currentScenarioId = matchingEpisode.scenario_id;
                        console.log('‚úÖ Scenario ID ÏÑ§Ï†ï:', currentScenarioId);
                    } else {
                        console.warn('‚ö†Ô∏è Îß§ÏπòÎêòÎäî ÏóêÌîºÏÜåÎìúÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§');
                        // Fallback: groupKeyÏóêÏÑú Ï∂îÏ∏°Ìï¥Î≥¥Í∏∞
                        const lastUnderscoreIndex = groupKey.lastIndexOf('_');
                        if (lastUnderscoreIndex > 0) {
                            currentScenarioId = groupKey.substring(0, lastUnderscoreIndex);
                        }
                    }
                }

                // ÎåÄÌôî ÏÉùÏÑ± Î™®Îã¨ Ïó¥Í∏∞
                openDialogueModal('create');

                // ÏûêÎèôÏúºÎ°ú Îã§Ïùå ÏóêÌîºÏÜåÎìú Î≤àÌò∏ ÏÑ§Ï†ï (Ìñ•ÌõÑ Íµ¨ÌòÑ)
                // ÌòÑÏû¨Îäî ÏÇ¨Ïö©ÏûêÍ∞Ä ÏßÅÏ†ë Î≤àÌò∏ ÏûÖÎ†•

            } catch (error) {
                console.error('‚ùå Scenario ID Ï∞æÍ∏∞ Ïã§Ìå®:', error);
                // ÎåÄÌôî ÏÉùÏÑ± Î™®Îã¨ÏùÄ Ïó¨Ï†ÑÌûà Ïó¥Í∏∞
                openDialogueModal('create');
            }
        }

        // ÏóêÌîºÏÜåÎìú ÎåÄÌôî ÎØ∏Î¶¨Î≥¥Í∏∞ (ÏÉàÎ°ú Ï∂îÍ∞Ä)
        function previewEpisodeDialogue(episodeId) {
            console.log('üìñ ÏóêÌîºÏÜåÎìú ÎåÄÌôî ÎØ∏Î¶¨Î≥¥Í∏∞:', episodeId);
            // Í∏∞Ï°¥ previewDialogue Ìï®Ïàò ÌôúÏö©ÌïòÍ±∞ÎÇò ÏÉàÎ°úÏö¥ ÎØ∏Î¶¨Î≥¥Í∏∞ Íµ¨ÌòÑ
            // ÏùºÎã® Í∏∞Ï°¥ Ìï®Ïàò ÏÇ¨Ïö©
            previewDialogue(episodeId);
        }

        // ÏóêÌîºÏÜåÎìú ÎåÄÌôî ÏÇ≠Ï†ú (ÏÉàÎ°ú Ï∂îÍ∞Ä)
        async function deleteEpisodeDialogue(episodeId, groupKey, scenarioTitle, characterName) {
            console.log('üóëÔ∏è ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú:', episodeId);

            // ÏÇ¨Ïö©Ïûê ÌôïÏù∏
            if (!confirm(`Ï†ïÎßêÎ°ú Ïù¥ ÏóêÌîºÏÜåÎìúÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÏóêÌîºÏÜåÎìú ID: ${episodeId}\n\n‚ö†Ô∏è Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.`)) {
                return;
            }

            try {
                // APIÎ°ú ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú ÏöîÏ≤≠
                const response = await fetch('/api/dialogue-manager', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'delete_episode',
                        episode_id: episodeId
                    })
                });

                const result = await response.json();
                console.log('üóëÔ∏è ÏÇ≠Ï†ú API ÏùëÎãµ:', result);

                if (result.success) {
                    alert('‚úÖ ÏóêÌîºÏÜåÎìúÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');

                    // ÌòÑÏû¨ ÌôîÎ©¥ÏùÑ ÏÉàÎ°úÍ≥†Ïπ®ÌïòÏó¨ ÏÇ≠Ï†úÎêú ÏóêÌîºÏÜåÎìú Ï†úÍ±∞
                    displayEpisodeSpecificDialogues(groupKey, scenarioTitle, characterName);

                    // ÏóêÌîºÏÜåÎìú Î™©Î°ùÎèÑ ÏÉàÎ°úÍ≥†Ïπ®
                    loadEpisodesList();

                    // Ï¥ù ÏóêÌîºÏÜåÎìú Ïπ¥Ïö¥Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
                    loadTotalEpisodeCount();

                } else {
                    throw new Error(result.message || 'ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú Ïã§Ìå®');
                }

            } catch (error) {
                console.error('‚ùå ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú Ïã§Ìå®:', error);
                alert(`‚ùå ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú Ïã§Ìå®:\n${error.message}`);
            }
        }

        // ÏóêÌîºÏÜåÎìú ÎåÄÌôî Î≥¥Í∏∞ Îã´Í∏∞
        function closeEpisodeDialogues() {
            document.querySelector('.episodes-list-section').style.display = 'block';
            document.getElementById('selectedEpisodeDialogues').style.display = 'none';
            currentScenarioId = null;
        }

        // Ï†ÑÏó≠ Ìï®ÏàòÎ°ú Îì±Î°ù
        window.loadEpisodesList = loadEpisodesList;
        window.viewEpisodeDialogues = viewEpisodeDialogues;
        window.closeEpisodeDialogues = closeEpisodeDialogues;

        // ‚ú® Î™®Îì† ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú Í∏∞Îä• (ÏÉàÎ°ú Ï∂îÍ∞Ä)
        async function resetAllEpisodes() {
            console.log('üóëÔ∏è Î™®Îì† ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú ÏöîÏ≤≠...');

            // 2Îã®Í≥Ñ ÌôïÏù∏ (Ï∫êÎ¶≠ÌÑ∞ ÏÇ≠Ï†úÏôÄ ÎèôÏùºÌïú Î∞©Ïãù)
            const firstConfirm = confirm(
                '‚ö†Ô∏è Í≤ΩÍ≥†: Î™®Îì† ÏóêÌîºÏÜåÎìúÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\n' +
                'Ïù¥ ÏûëÏóÖÏùÄ Îã§ÏùåÏùÑ ÏÇ≠Ï†úÌï©ÎãàÎã§:\n' +
                '‚Ä¢ Î™®Îì† ÏãúÎÇòÎ¶¨Ïò§+Ï∫êÎ¶≠ÌÑ∞ Ï°∞Ìï©Ïùò ÏóêÌîºÏÜåÎìú\n' +
                '‚Ä¢ Í∞Å ÏóêÌîºÏÜåÎìúÏùò 1~36Î≤à ÎåÄÌôî ÎÇ¥Ïö©\n' +
                '‚Ä¢ ÏÉùÏÑ±Îêú Î™®Îì† AI ÎåÄÌôî Îç∞Ïù¥ÌÑ∞\n\n' +
                '‚ö†Ô∏è Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§!'
            );

            if (!firstConfirm) {
                console.log('‚úÖ ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú Ï∑®ÏÜåÎê®');
                return;
            }

            const secondConfirm = confirm(
                'üö® ÏµúÏ¢Ö ÌôïÏù∏\n\n' +
                'Ï†ïÎßêÎ°ú Î™®Îì† ÏóêÌîºÏÜåÎìú Îç∞Ïù¥ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\n' +
                'ÏÇ≠Ï†úÌï† Í≤ΩÏö∞:\n' +
                '‚Ä¢ Î™®Îì† AI ÏÉùÏÑ± ÎåÄÌôîÍ∞Ä ÏÇ¨ÎùºÏßëÎãàÎã§\n' +
                '‚Ä¢ ÏóêÌîºÏÜåÎìú Î™©Î°ùÏù¥ ÎπÑÏõåÏßëÎãàÎã§\n' +
                '‚Ä¢ GitHubÏóêÏÑúÎèÑ ÏôÑÏ†ÑÌûà ÏÇ≠Ï†úÎê©ÎãàÎã§\n\n' +
                'Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?'
            );

            if (!secondConfirm) {
                console.log('‚úÖ ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú ÏµúÏ¢Ö Ï∑®ÏÜåÎê®');
                return;
            }

            try {
                // Î°úÎî© ÌëúÏãú
                const container = document.getElementById('episodesListContainer');
                container.innerHTML = `
                    <div class="loading-card" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                        <div class="spinner"></div>
                        <h4>üóëÔ∏è Î™®Îì† ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú Ï§ë...</h4>
                        <p>Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî...</p>
                    </div>
                `;

                console.log('üîÑ dialogue-manager API Ìò∏Ï∂ú: Î™®Îì† ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú');

                // dialogue-manager APIÎ•º ÌÜµÌï¥ Î™®Îì† ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú
                const response = await fetch('/api/dialogue-manager', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'reset_all_episodes'
                    })
                });

                console.log('üì∂ API ÏùëÎãµ ÏÉÅÌÉú:', response.status);

                if (!response.ok) {
                    throw new Error(`API Ìò∏Ï∂ú Ïã§Ìå®: ${response.status}`);
                }

                const result = await response.json();
                console.log('üìä ÏÇ≠Ï†ú Í≤∞Í≥º:', result);

                if (result.success) {
                    // ÏÑ±Í≥µ Î©îÏãúÏßÄ (ÏÇ≠Ï†úÎêú Í∞úÏàò Ìè¨Ìï®)
                    const deletedCount = result.deleted_count || 0;
                    alert(
                        `‚úÖ Î™®Îì† ÏóêÌîºÏÜåÎìúÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§!\n\n` +
                        `üìä ÏÇ≠Ï†úÎêú ÏóêÌîºÏÜåÎìú: ${deletedCount}Í∞ú\n` +
                        '‚Ä¢ GitHubÏóêÏÑú ÏôÑÏ†ÑÌûà Ï†úÍ±∞Îê®\n' +
                        '‚Ä¢ Î™®Îì† AI ÎåÄÌôî Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†úÎê®\n' +
                        '‚Ä¢ Íπ®ÎÅóÌïú ÏÉÅÌÉúÎ°ú Ï¥àÍ∏∞ÌôîÎê®\n\n' +
                        'Ïù¥Ï†ú ÏÉàÎ°úÏö¥ ÏóêÌîºÏÜåÎìúÎ•º ÏÉùÏÑ±Ìï† Ïàò ÏûàÏäµÎãàÎã§!'
                    );

                    console.log('üìä ÏÇ≠Ï†ú ÏÑ±Í≥µ ÏÉÅÏÑ∏:', {
                        ÏÇ≠Ï†úÎêú_Í∞úÏàò: deletedCount,
                        Ïù¥Ï†Ñ_Í∞úÏàò: result.previous_count,
                        ÌòÑÏû¨_Í∞úÏàò: result.current_count,
                        ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ: result.timestamp
                    });

                    // ÏóêÌîºÏÜåÎìú Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                    await loadEpisodesList();

                    // Ï†ÑÏ≤¥ ÏóêÌîºÏÜåÎìú Ïπ¥Ïö¥Ìä∏ ÏÉàÎ°úÍ≥†Ïπ® (Í∞ÄÏû• Ï§ëÏöî!)
                    await loadTotalEpisodeCount();

                    // ÎåÄÌôî Î™©Î°ùÎèÑ ÏÉàÎ°úÍ≥†Ïπ® (Îπà ÏÉÅÌÉú)
                    displayDialogues();

                    // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
                    updateDialogueStats();

                    // Ï†ÑÏó≠ Î≥ÄÏàòÎèÑ Ï¥àÍ∏∞Ìôî
                    dialogues = {};
                    currentScenarioId = null;

                    console.log('‚úÖ ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú Î∞è ÏÉàÎ°úÍ≥†Ïπ® ÏôÑÎ£å');

                } else {
                    throw new Error(result.message || 'ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú Ïã§Ìå®');
                }

            } catch (error) {
                console.error('‚ùå ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú Ïã§Ìå®:', error);

                // Ïò§Î•ò ÌëúÏãú
                const container = document.getElementById('episodesListContainer');
                container.innerHTML = `
                    <div class="error-card" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                        <h4>‚ùå ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú Ïã§Ìå®</h4>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="loadEpisodesList()">üîÑ Îã§Ïãú Î°úÎìú</button>
                    </div>
                `;

                alert(
                    '‚ùå ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\n\n' +
                    `Ïò§Î•ò: ${error.message}\n\n` +
                    'Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.'
                );
            }
        }

        // === ÏÉàÎ°úÏö¥ ÏóêÌîºÏÜåÎìú Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú Ìï®ÏàòÎì§ ===

        // ÏóêÌîºÏÜåÎìú ÌÉ≠Ïö© ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
        async function refreshEpisodeScenarioList() {
            console.log('üîÑ ÏóêÌîºÏÜåÎìúÏö© ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®...');

            try {
                const container = document.getElementById('episodeScenarioCardsContainer');
                if (container) {
                    container.innerHTML = `
                        <div class="loading-card">
                            <div class="spinner"></div>
                            <p>ÏãúÎÇòÎ¶¨Ïò§ Î°úÎî© Ï§ë...</p>
                        </div>
                    `;
                }

                await displayEpisodeScenarios();
                console.log('‚úÖ ÏóêÌîºÏÜåÎìúÏö© ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ® ÏôÑÎ£å');
            } catch (error) {
                console.error('‚ùå ÏóêÌîºÏÜåÎìúÏö© ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ® Ïã§Ìå®:', error);
            }
        }

        // ÏóêÌîºÏÜåÎìú ÌÉ≠Ïóê ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÌëúÏãú
        async function displayEpisodeScenarios() {
            console.log('üìã ÏóêÌîºÏÜåÎìú ÌÉ≠Ïóê ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÌëúÏãú...');

            try {
                let scenariosData = window.scenarios || {};

                if (Object.keys(scenariosData).length === 0) {
                    const localScenarios = localStorage.getItem('scenarios');
                    if (localScenarios) {
                        scenariosData = JSON.parse(localScenarios);
                        window.scenarios = scenariosData;
                    }
                }

                const scenarioKeys = Object.keys(scenariosData);
                const container = document.getElementById('episodeScenarioCardsContainer');

                if (!container) {
                    console.warn('‚ö†Ô∏è episodeScenarioCardsContainer ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                    return;
                }

                if (scenarioKeys.length === 0) {
                    container.innerHTML = `
                        <div class="loading-card">
                            <p>‚ùå ÏÉùÏÑ±Îêú ÏãúÎÇòÎ¶¨Ïò§Í∞Ä ÏóÜÏäµÎãàÎã§.</p>
                            <p><small>Î®ºÏ†Ä ÏãúÎÇòÎ¶¨Ïò§ ÌÉ≠ÏóêÏÑú ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.</small></p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                scenarioKeys.forEach(scenarioId => {
                    const scenario = scenariosData[scenarioId];
                    if (scenario) {
                        html += `
                            <div class="scenario-selection-card" onclick="selectEpisodeScenario('${scenarioId}')" data-scenario-id="${scenarioId}">
                                <div class="scenario-header">
                                    <h5>${scenario.title || 'Ï†úÎ™© ÏóÜÏùå'}</h5>
                                    <span class="scenario-mood">${scenario.mood || 'ÏùºÎ∞ò'}</span>
                                </div>
                                <p class="scenario-description">${(scenario.description || '').substring(0, 100)}${scenario.description && scenario.description.length > 100 ? '...' : ''}</p>
                                <div class="scenario-stats">
                                    <span class="stat-item">üé≠ Ï∫êÎ¶≠ÌÑ∞: ${scenario.available_characters ? scenario.available_characters[0] : 'ÏóÜÏùå'}</span>
                                    <span class="stat-item">üìÖ ${scenario.created_at ? new Date(scenario.created_at).toLocaleDateString('ko-KR') : 'ÎÇ†Ïßú ÏóÜÏùå'}</span>
                                </div>
                            </div>
                        `;
                    }
                });

                container.innerHTML = html;
                console.log('‚úÖ ÏóêÌîºÏÜåÎìúÏö© ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÌëúÏãú ÏôÑÎ£å:', scenarioKeys.length, 'Í∞ú');

            } catch (error) {
                console.error('‚ùå ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÌëúÏãú Ïã§Ìå®:', error);
                const errorContainer = document.getElementById('episodeScenarioCardsContainer');
                if (errorContainer) {
                    errorContainer.innerHTML = `
                        <div class="loading-card">
                            <p>‚ùå ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù Î°úÎî© Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.</p>
                            <p><small>ÏΩòÏÜîÏùÑ ÌôïÏù∏ÌïòÍ±∞ÎÇò ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Î≥¥ÏÑ∏Ïöî.</small></p>
                        </div>
                    `;
                }
            }
        }

        // ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉù (ÏóêÌîºÏÜåÎìú ÌÉ≠Ïö©)
        function selectEpisodeScenario(scenarioId) {
            console.log('üéØ ÏóêÌîºÏÜåÎìúÏö© ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉùÎê®:', scenarioId);

            // Í∏∞Ï°¥ ÏÑ†ÌÉù Ìï¥Ï†ú
            document.querySelectorAll('#episodeScenarioCardsContainer .scenario-selection-card').forEach(card => {
                card.classList.remove('selected');
            });

            // ÏÉàÎ°úÏö¥ Ïπ¥Îìú ÏÑ†ÌÉù
            const selectedCard = document.querySelector(`#episodeScenarioCardsContainer [data-scenario-id="${scenarioId}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }

            // Ï†ÑÏó≠ Î≥ÄÏàòÏóê ÌòÑÏû¨ ÏãúÎÇòÎ¶¨Ïò§ ID ÏÑ§Ï†ï
            window.currentSelectedScenarioId = scenarioId;
            console.log('‚úÖ ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§:', scenarioId);

            // 2Îã®Í≥Ñ ÌëúÏãú
            showEpisodeStep2(scenarioId);
        }

        // 2Îã®Í≥Ñ: ÏóêÌîºÏÜåÎìú ÏÉùÏÑ± Î©îÎâ¥ ÌëúÏãú
        function showEpisodeStep2(scenarioId) {
            console.log('üé¨ 2Îã®Í≥Ñ ÌëúÏãú:', scenarioId);

            const scenario = window.scenarios?.[scenarioId];
            if (!scenario) {
                console.error('ÏãúÎÇòÎ¶¨Ïò§ Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§:', scenarioId);
                return;
            }

            // 2Îã®Í≥Ñ Î≥¥Ïù¥Í∏∞
            document.getElementById('episode-step-2').style.display = 'block';

            // ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§ Ï†ïÎ≥¥ ÌëúÏãú
            document.getElementById('selectedScenarioTitle').textContent = scenario.title || 'Ï†úÎ™© ÏóÜÏùå';
            document.getElementById('selectedScenarioDescription').textContent = scenario.description || 'ÏÑ§Î™Ö ÏóÜÏùå';

            // Ìï¥Îãπ ÏãúÎÇòÎ¶¨Ïò§Ïùò Í∏∞Ï°¥ ÏóêÌîºÏÜåÎìú Î°úÎìú
            loadScenarioEpisodes(scenarioId);
        }

        // ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉù Ìï¥Ï†ú
        function clearEpisodeScenarioSelection() {
            console.log('üîÑ ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉù Ìï¥Ï†ú');

            // ÏÑ†ÌÉù Ìï¥Ï†ú
            document.querySelectorAll('#episodeScenarioCardsContainer .scenario-selection-card').forEach(card => {
                card.classList.remove('selected');
            });

            // 2Îã®Í≥Ñ Ïà®Í∏∞Í∏∞
            document.getElementById('episode-step-2').style.display = 'none';

            // Ï†ÑÏó≠ Î≥ÄÏàò Ï¥àÍ∏∞Ìôî
            window.currentSelectedScenarioId = null;
        }

        // ÏÉà ÏóêÌîºÏÜåÎìú ÏÉùÏÑ±
        async function createNewEpisode() {
            console.log('‚ú® ÏÉà ÏóêÌîºÏÜåÎìú ÏÉùÏÑ± ÏãúÏûë');

            const scenarioId = window.currentSelectedScenarioId;
            if (!scenarioId) {
                alert('Î®ºÏ†Ä ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            const title = document.getElementById('episodeTitleInput').value.trim();
            const dialogueCount = parseInt(document.getElementById('dialogueCountSelect').value);
            const difficulty = document.getElementById('episodeDifficultySelect').value;

            if (!title) {
                alert('ÏóêÌîºÏÜåÎìú Ï†úÎ™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            const button = document.getElementById('createEpisodeBtn');
            const originalText = button.innerHTML;
            button.innerHTML = '‚è≥ ÏÉùÏÑ± Ï§ë...';
            button.disabled = true;

            try {
                // APIÎ°ú ÏóêÌîºÏÜåÎìú ÏÉùÏÑ± ÏöîÏ≤≠
                const response = await fetch('/api/dialogue-manager', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'create_episode',
                        scenario_id: scenarioId,
                        episode_title: title,
                        dialogue_count: dialogueCount,
                        difficulty: difficulty
                    })
                });

                const result = await response.json();
                console.log('‚ú® ÏóêÌîºÏÜåÎìú ÏÉùÏÑ± Í≤∞Í≥º:', result);

                if (result.success) {
                    alert('‚úÖ ÏóêÌîºÏÜåÎìúÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!');

                    // Ìèº Ï¥àÍ∏∞Ìôî
                    document.getElementById('episodeTitleInput').value = '';

                    // ÏóêÌîºÏÜåÎìú Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                    loadScenarioEpisodes(scenarioId);
                } else {
                    throw new Error(result.message || 'ÏóêÌîºÏÜåÎìú ÏÉùÏÑ± Ïã§Ìå®');
                }

            } catch (error) {
                console.error('‚ùå ÏóêÌîºÏÜåÎìú ÏÉùÏÑ± Ïã§Ìå®:', error);
                alert(`‚ùå ÏóêÌîºÏÜåÎìú ÏÉùÏÑ± Ïã§Ìå®:\n${error.message}`);
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // ÏãúÎÇòÎ¶¨Ïò§Ïùò ÏóêÌîºÏÜåÎìú Î™©Î°ù Î°úÎìú
        async function loadScenarioEpisodes(scenarioId) {
            console.log('üìã ÏãúÎÇòÎ¶¨Ïò§ ÏóêÌîºÏÜåÎìú Î™©Î°ù Î°úÎìú:', scenarioId);

            try {
                const response = await fetch(`/api/dialogue-manager?action=list_episodes&scenario_id=${scenarioId}`);
                const result = await response.json();
                console.log('üìã ÏóêÌîºÏÜåÎìú Î™©Î°ù ÏùëÎãµ:', result);

                const container = document.getElementById('scenarioEpisodesContainer');
                if (!container) {
                    console.warn('scenarioEpisodesContainerÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                    return;
                }

                if (result.success && result.episodes && result.episodes.length > 0) {
                    displayScenarioEpisodes(result.episodes);
                } else {
                    container.innerHTML = `
                        <div class="empty-episodes">
                            <p>ÏïÑÏßÅ ÏÉùÏÑ±Îêú ÏóêÌîºÏÜåÎìúÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>
                            <p>ÏúÑÏóêÏÑú ÏÉà ÏóêÌîºÏÜåÎìúÎ•º ÏÉùÏÑ±Ìï¥Î≥¥ÏÑ∏Ïöî! ‚¨ÜÔ∏è</p>
                        </div>
                    `;
                }

            } catch (error) {
                console.error('‚ùå ÏóêÌîºÏÜåÎìú Î™©Î°ù Î°úÎìú Ïã§Ìå®:', error);
                const container = document.getElementById('scenarioEpisodesContainer');
                if (container) {
                    container.innerHTML = `
                        <div class="empty-episodes">
                            <p>‚ùå ÏóêÌîºÏÜåÎìú Î™©Î°ùÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</p>
                            <p>Ïò§Î•ò: ${error.message}</p>
                        </div>
                    `;
                }
            }
        }

        // ÏãúÎÇòÎ¶¨Ïò§ ÏóêÌîºÏÜåÎìú Î™©Î°ù ÌëúÏãú
        function displayScenarioEpisodes(episodes) {
            console.log('üé¨ ÏãúÎÇòÎ¶¨Ïò§ ÏóêÌîºÏÜåÎìú ÌëúÏãú:', episodes.length, 'Í∞ú');

            const container = document.getElementById('scenarioEpisodesContainer');
            if (!container) return;

            const sortedEpisodes = episodes.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            const episodeCards = sortedEpisodes.map(episode => {
                const createdDate = episode.created_at ? new Date(episode.created_at).toLocaleDateString('ko-KR') : 'ÎÇ†Ïßú ÏóÜÏùå';
                const dialogueCount = episode.dialogue_count || episode.dialogues?.length || 0;

                return `
                    <div class="episode-card" onclick="selectEpisode('${episode.id}')">
                        <div class="episode-card-header">
                            <div>
                                <h6 class="episode-title">${episode.title || `ÏóêÌîºÏÜåÎìú ${episode.id.substring(0, 8)}`}</h6>
                                <div class="episode-meta">
                                    <span>üí¨ ÎåÄÌôî ${dialogueCount}Í∞ú</span>
                                    <span>üìÖ ${createdDate}</span>
                                </div>
                            </div>
                            <div class="episode-actions">
                                <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); selectEpisode('${episode.id}')">
                                    üìñ Î≥¥Í∏∞
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteEpisode('${episode.id}')" title="ÏÇ≠Ï†ú">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        <div class="episode-difficulty">
                            <span class="difficulty-badge ${(episode.difficulty || 'Easy').toLowerCase()}">${episode.difficulty || 'Easy'}</span>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = episodeCards;
        }

        // ÏóêÌîºÏÜåÎìú ÏÑ†ÌÉù (3Îã®Í≥ÑÎ°ú Ïù¥Îèô)
        function selectEpisode(episodeId) {
            console.log('üìñ ÏóêÌîºÏÜåÎìú ÏÑ†ÌÉùÎê®:', episodeId);
            showEpisodeStep3(episodeId);
        }

        // 3Îã®Í≥Ñ: ÏÑ†ÌÉùÎêú ÏóêÌîºÏÜåÎìúÏùò ÎåÄÌôî Î™©Î°ù ÌëúÏãú
        function showEpisodeStep3(episodeId) {
            console.log('üí¨ 3Îã®Í≥Ñ ÌëúÏãú - ÎåÄÌôî Î™©Î°ù:', episodeId);

            document.getElementById('episode-step-2').style.display = 'none';
            document.getElementById('episode-step-3').style.display = 'block';

            window.currentSelectedEpisodeId = episodeId;
            document.getElementById('selectedEpisodeTitle').textContent = `ÏóêÌîºÏÜåÎìú ${episodeId.substring(0, 8)}`;

            loadEpisodeDialogues(episodeId);
        }

        // ÏóêÌîºÏÜåÎìú Î™©Î°ùÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
        function backToEpisodesList() {
            console.log('‚Üê ÏóêÌîºÏÜåÎìú Î™©Î°ùÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞');

            document.getElementById('episode-step-3').style.display = 'none';
            document.getElementById('episode-step-2').style.display = 'block';

            window.currentSelectedEpisodeId = null;
        }

        // ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú
        async function deleteEpisode(episodeId) {
            console.log('üóëÔ∏è ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú:', episodeId);

            if (!confirm(`Ï†ïÎßêÎ°ú Ïù¥ ÏóêÌîºÏÜåÎìúÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÏóêÌîºÏÜåÎìú ID: ${episodeId}\n\n‚ö†Ô∏è Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.`)) {
                return;
            }

            try {
                const response = await fetch('/api/dialogue-manager', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'delete_episode',
                        episode_id: episodeId
                    })
                });

                const result = await response.json();
                console.log('üóëÔ∏è ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú ÏùëÎãµ:', result);

                if (result.success) {
                    alert('‚úÖ ÏóêÌîºÏÜåÎìúÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');

                    const scenarioId = window.currentSelectedScenarioId;
                    if (scenarioId) {
                        loadScenarioEpisodes(scenarioId);
                    }
                } else {
                    throw new Error(result.message || 'ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú Ïã§Ìå®');
                }

            } catch (error) {
                console.error('‚ùå ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú Ïã§Ìå®:', error);
                alert(`‚ùå ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú Ïã§Ìå®:\n${error.message}`);
            }
        }

        // ÏãúÎÇòÎ¶¨Ïò§ ÏóêÌîºÏÜåÎìú ÏÉàÎ°úÍ≥†Ïπ®
        function refreshScenarioEpisodes() {
            console.log('üîÑ ÏãúÎÇòÎ¶¨Ïò§ ÏóêÌîºÏÜåÎìú ÏÉàÎ°úÍ≥†Ïπ®');

            const scenarioId = window.currentSelectedScenarioId;
            if (scenarioId) {
                loadScenarioEpisodes(scenarioId);
            }
        }

        // ÏóêÌîºÏÜåÎìú ÌÉ≠Ïù¥ ÌôúÏÑ±ÌôîÎê† Îïå Ìò∏Ï∂ú (switchTab Ìï®ÏàòÏóêÏÑú Ìò∏Ï∂ú)
        function initializeEpisodeTab() {
            console.log('üé¨ ÏóêÌîºÏÜåÎìú ÌÉ≠ Ï¥àÍ∏∞Ìôî');

            // Î™®Îì† Îã®Í≥Ñ Ïà®Í∏∞Í∏∞
            document.getElementById('episode-step-2').style.display = 'none';
            document.getElementById('episode-step-3').style.display = 'none';
            document.getElementById('episode-step-4').style.display = 'none';

            // 1Îã®Í≥Ñ ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÌëúÏãú
            displayEpisodeScenarios();

            // Ï†ÑÏó≠ Î≥ÄÏàò Ï¥àÍ∏∞Ìôî
            window.currentSelectedScenarioId = null;
            window.currentSelectedEpisodeId = null;
            window.currentSelectedDialogueId = null;
        }

        // Ï†ÑÏó≠ Ìï®ÏàòÎ°ú Îì±Î°ù
        window.resetAllEpisodes = resetAllEpisodes;
        window.displayEpisodeSpecificDialogues = displayEpisodeSpecificDialogues;
        window.addNewDialogueToEpisode = addNewDialogueToEpisode;
        window.previewEpisodeDialogue = previewEpisodeDialogue;

        // ÏÉàÎ°úÏö¥ ÏóêÌîºÏÜåÎìú Í¥ÄÎ¶¨ Ìï®ÏàòÎì§ÏùÑ Ï†ÑÏó≠ÏúºÎ°ú Îì±Î°ù
        window.refreshEpisodeScenarioList = refreshEpisodeScenarioList;
        window.displayEpisodeScenarios = displayEpisodeScenarios;
        window.selectEpisodeScenario = selectEpisodeScenario;
        window.clearEpisodeScenarioSelection = clearEpisodeScenarioSelection;
        window.createNewEpisode = createNewEpisode;
        window.refreshScenarioEpisodes = refreshScenarioEpisodes;
        window.selectEpisode = selectEpisode;
        window.backToEpisodesList = backToEpisodesList;
        window.deleteEpisode = deleteEpisode;
        window.initializeEpisodeTab = initializeEpisodeTab;

        // üéØ Ï∫êÎ¶≠ÌÑ∞ ÏûêÎèô ÏôÑÏÑ± Ìï®Ïàò (ÏÉàÎ°ú Ï∂îÍ∞Ä)
        async function autoCompleteCharacter(event) {
            console.log('üéØ Ï∫êÎ¶≠ÌÑ∞ ÏûêÎèô ÏôÑÏÑ± ÏãúÏûë');

            try {
                // Î≤ÑÌäº ÏÉÅÌÉú Î≥ÄÍ≤Ω
                const button = event.target;
                const originalText = button.textContent;
                button.disabled = true;
                button.textContent = 'üéØ ÏôÑÏÑ± Ï§ë...';

                // ÌòÑÏû¨ Ìèº Îç∞Ïù¥ÌÑ∞ ÏàòÏßë
                const formData = collectCharacterFormData();
                console.log('üìã ÌòÑÏû¨ Ìèº Îç∞Ïù¥ÌÑ∞:', formData);

                // API Ìò∏Ï∂ú
                const response = await fetch('/api/character-ai-generator', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'auto_complete_character',
                        ...formData
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Ìò∏Ï∂ú Ïã§Ìå®: ${response.status}`);
                }

                const result = await response.json();
                console.log('‚úÖ ÏûêÎèô ÏôÑÏÑ± Í≤∞Í≥º:', result);

                if (result.success) {
                    // üîç ÎîîÎ≤ÑÍπÖ: ÏûêÎèôÏôÑÏÑ± Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞ Î∂ÑÏÑù
                    console.log('üîç ÏûêÎèôÏôÑÏÑ± Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑù:');
                    console.log('- Îç∞Ïù¥ÌÑ∞ ÌÉÄÏûÖ:', typeof result.character);
                    console.log('- ÏµúÏÉÅÏúÑ ÌÇ§Îì§:', Object.keys(result.character || {}));
                    console.log('- basic_info Ï°¥Ïû¨:', !!result.character?.basic_info);
                    console.log('- appeal_profile Ï°¥Ïû¨:', !!result.character?.appeal_profile);
                    console.log('- physical_allure Ï°¥Ïû¨:', !!result.character?.physical_allure);

                    if (result.character?.basic_info) {
                        console.log('- basic_info ÎÇ¥Ïö©:', result.character.basic_info);
                    }

                    // ÏôÑÏÑ±Îêú Îç∞Ïù¥ÌÑ∞Î°ú Ìèº Ï±ÑÏö∞Í∏∞
                    fillCharacterForm(result.character);
                    alert('üéâ Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥Í∞Ä ÏûêÎèôÏúºÎ°ú ÏôÑÏÑ±ÎêòÏóàÏäµÎãàÎã§!\n\nÎàÑÎùΩÎêú ÌïÑÎìúÎì§Ïù¥ AIÏóê ÏùòÌï¥ Ï±ÑÏõåÏ°åÏäµÎãàÎã§.');
                } else {
                    throw new Error(result.message || 'ÏûêÎèô ÏôÑÏÑ± Ïã§Ìå®');
                }

            } catch (error) {
                console.error('‚ùå Ï∫êÎ¶≠ÌÑ∞ ÏûêÎèô ÏôÑÏÑ± Ïã§Ìå®:', error);
                alert(`‚ùå ÏûêÎèô ÏôÑÏÑ± Ïã§Ìå®:\n${error.message}\n\nÎã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.`);
            } finally {
                // Î≤ÑÌäº ÏÉÅÌÉú Î≥µÏõê
                if (event && event.target) {
                    const button = event.target;
                    button.disabled = false;
                    button.textContent = originalText;
                }
            }
        }

        // üìù Ïù∏Î¨º ÏÜåÍ∞ú ÏÉùÏÑ± Ìï®Ïàò (ÏÉàÎ°ú Ï∂îÍ∞Ä)
        async function generateCharacterProfile(event) {
            console.log('üìù Ïù∏Î¨º ÏÜåÍ∞ú ÏÉùÏÑ± ÏãúÏûë');

            try {
                // Î≤ÑÌäº ÏÉÅÌÉú Î≥ÄÍ≤Ω
                const button = event.target;
                const originalText = button.textContent;
                button.disabled = true;
                button.textContent = 'üìù ÏÉùÏÑ± Ï§ë...';

                // ÌòÑÏû¨ Ìèº Îç∞Ïù¥ÌÑ∞ ÏàòÏßë
                const formData = collectCharacterFormData();
                console.log('üìã Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞:', formData);

                if (!formData.basic_info?.name && !formData.name) {
                    alert('‚ùå ÏµúÏÜåÌïú Ï∫êÎ¶≠ÌÑ∞ Ïù¥Î¶ÑÏùÄ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
                    return;
                }

                // API Ìò∏Ï∂ú
                const response = await fetch('/api/character-ai-generator', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'generate_character_profile',
                        ...formData
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Ìò∏Ï∂ú Ïã§Ìå®: ${response.status}`);
                }

                const result = await response.json();
                console.log('‚úÖ Ïù∏Î¨º ÏÜåÍ∞ú ÏÉùÏÑ± Í≤∞Í≥º:', result);

                if (result.success) {
                    // Ïù∏Î¨º ÏÜåÍ∞ú Î™®Îã¨ ÌëúÏãú
                    showCharacterProfileModal(result.profile);
                } else {
                    throw new Error(result.message || 'Ïù∏Î¨º ÏÜåÍ∞ú ÏÉùÏÑ± Ïã§Ìå®');
                }

            } catch (error) {
                console.error('‚ùå Ïù∏Î¨º ÏÜåÍ∞ú ÏÉùÏÑ± Ïã§Ìå®:', error);
                alert(`‚ùå Ïù∏Î¨º ÏÜåÍ∞ú ÏÉùÏÑ± Ïã§Ìå®:\n${error.message}\n\nÎã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.`);
            } finally {
                // Î≤ÑÌäº ÏÉÅÌÉú Î≥µÏõê
                if (event && event.target) {
                    const button = event.target;
                    button.disabled = false;
                    button.textContent = originalText;
                }
            }
        }

        // ü§ñ ÌÜµÌï© AI Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ± Ìï®Ïàò (ÏûêÎèôÏôÑÏÑ± + Ïù∏Î¨ºÏÜåÍ∞ú)
        // üéØ ÏÉàÎ°úÏö¥ ÌÜµÌï© AI Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±Í∏∞ (ÌïúÎ≤àÏóê ÏôÑÏ†Ñ ÏÉùÏÑ±)
        async function generateCompleteCharacter(event) {
            console.log('üéØ ÏÉàÎ°úÏö¥ ÌÜµÌï© AI Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±Í∏∞ ÏãúÏûë');

            // Î≤ÑÌäº ÏÉÅÌÉú Í¥ÄÎ¶¨
            let button = null;
            let originalText = '';

            try {
                // Î≤ÑÌäº ÏÉÅÌÉú Î≥ÄÍ≤Ω
                button = event.target;
                originalText = button.textContent;
                button.disabled = true;
                button.textContent = 'üéØ AI Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ± Ï§ë...';

                // 1Ô∏è‚É£ ÌïÑÏàò ÌïÑÎìú Í≤ÄÏ¶ù
                const name = document.getElementById('charName')?.value?.trim();
                const age = document.getElementById('charAge')?.value;
                const mbti = document.getElementById('charMbti')?.value;

                if (!name || !age || !mbti) {
                    alert('‚ö†Ô∏è ÌïÑÏàò Ï†ïÎ≥¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!\n\n‚úÖ Ïù¥Î¶Ñ: ' + (name || '‚ùå ÌïÑÏàò') + '\n‚úÖ ÎÇòÏù¥: ' + (age || '‚ùå ÌïÑÏàò') + '\n‚úÖ MBTI: ' + (mbti || '‚ùå ÌïÑÏàò'));
                    return;
                }

                console.log('‚úÖ ÌïÑÏàò ÌïÑÎìú Í≤ÄÏ¶ù ÏôÑÎ£å:', { name, age, mbti });

                // 2Ô∏è‚É£ ÏûÖÎ†•Îêú ÏÑ†ÌÉùÏ†Å ÌïÑÎìú ÏàòÏßë
                const inputData = collectInputData();
                console.log('üìã ÏûÖÎ†•Îêú Îç∞Ïù¥ÌÑ∞:', inputData);

                // 3Ô∏è‚É£ Îπà ÌïÑÎìúÎì§ÏùÑ ÎûúÎç§ÏúºÎ°ú Ï±ÑÏö∞Í∏∞
                const completeData = fillMissingFieldsRandomly(inputData);
                console.log('üé≤ ÎûúÎç§ ÏôÑÏÑ±Îêú Îç∞Ïù¥ÌÑ∞:', completeData);

                // 4Ô∏è‚É£ AI API Ìò∏Ï∂úÌïòÏó¨ ÏµúÏ¢Ö Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ± (Ïù∏Î¨ºÏÜåÍ∞ú Ìè¨Ìï®)
                console.log('ü§ñ AI API Ìò∏Ï∂ú: Ï∫êÎ¶≠ÌÑ∞ ÏôÑÏ†Ñ ÏÉùÏÑ±');
                button.textContent = 'ü§ñ AIÍ∞Ä Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ± Ï§ë...';

                const response = await fetch('/api/character-ai-generator', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'generate_complete_character_with_profile',
                        ...completeData  // Îç∞Ïù¥ÌÑ∞Î•º ÏßÅÏ†ë Ï†ÑÏÜ° (character_data Í∞ùÏ≤¥Î°ú Í∞êÏã∏ÏßÄ ÏïäÏùå)
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Ïò§Î•ò: ${response.status}`);
                }

                const result = await response.json();
                console.log('‚úÖ AI Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ± ÏôÑÎ£å:', result);

                if (!result.success) {
                    throw new Error(result.message || 'Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ± Ïã§Ìå®');
                }

                // 5Ô∏è‚É£ ÏÉùÏÑ±Îêú Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞Î•º ÌèºÏóê Ï†ÅÏö©
                if (result.character) {
                    console.log('üìù ÏÉùÏÑ±Îêú Ï∫êÎ¶≠ÌÑ∞Î•º ÌèºÏóê Ï†ÅÏö© Ï§ë...');
                    fillCharacterForm(result.character);
                    console.log('‚úÖ Ìèº Ï†ÅÏö© ÏôÑÎ£å');
                }

                // 6Ô∏è‚É£ Ïù∏Î¨ºÏÜåÍ∞úÎ•º ÌîÑÎ°¨ÌîÑÌä∏Î°ú ÌëúÏãú (Î≥ÑÎèÑ ÌîÑÎ°úÌïÑ ÏÉùÏÑ± ÏóÜÏùå)
                if (result.character_profile) {
                    console.log('üìú Ïù∏Î¨ºÏÜåÍ∞ú(ÌîÑÎ°¨ÌîÑÌä∏) ÌëúÏãú');
                    showCharacterPromptModal(result.character_profile, result.character);
                }

                // 7Ô∏è‚É£ ÏÑ±Í≥µ Î©îÏãúÏßÄ Î∞è ÏûêÎèô Ï†ÄÏû• Ïó¨Î∂Ä ÌôïÏù∏
                const characterName = result.character?.basic_info?.name || result.character?.name || name;
                const autoSave = confirm(`üéâ ${characterName} Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÏôÑÏ†ÑÌûà ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!\n\nÎ∞îÎ°ú Ï†ÄÏû•ÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\n‚Ä¢ ÌôïÏù∏: Î∞îÎ°ú Ï†ÄÏû•\n‚Ä¢ Ï∑®ÏÜå: ÏàòÏ†ï ÌõÑ Ï†ÄÏû•`);

                if (autoSave) {
                    console.log('üöÄ ÏûêÎèô Ï†ÄÏû• ÏãúÏûë...');
                    await window.saveCharacter();
                } else {
                    alert(`‚úÖ ${characterName} Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±Ïù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!\nÌïÑÏöîÏãú ÏàòÏ†ïÌïú ÌõÑ "Ï†ÄÏû•" Î≤ÑÌäºÏùÑ ÎàåÎü¨Ï£ºÏÑ∏Ïöî.`);
                }

                console.log('üéä ÏÉàÎ°úÏö¥ ÌÜµÌï© AI Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±Í∏∞ ÏôÑÎ£å!');

            } catch (error) {
                console.error('‚ùå AI Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ± Ïã§Ìå®:', error);
                alert(`‚ùå AI Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ± Ïã§Ìå®:\n${error.message}\n\nÎã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.`);
            } finally {
                // Î≤ÑÌäº ÏÉÅÌÉú Î≥µÏõê
                if (button && originalText) {
                    button.disabled = false;
                    button.textContent = originalText;
                }
            }
        }

        // üîç ÏûÖÎ†•Îêú Îç∞Ïù¥ÌÑ∞Îßå ÏàòÏßëÌïòÎäî Ìï®Ïàò (ÏÉàÎ°úÏö¥ Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±Í∏∞Ïö©)
        function collectInputData() {
            const inputData = {
                // ÌïÑÏàò ÌïÑÎìúÎì§
                name: document.getElementById('charName')?.value?.trim(),
                age: parseInt(document.getElementById('charAge')?.value) || null,
                mbti: document.getElementById('charMbti')?.value,

                // ÏÑ†ÌÉùÏ†Å ÌïÑÎìúÎì§ (ÏûÖÎ†•Îêú Í≤ÉÎßå ÏàòÏßë)
                character_type: document.getElementById('charType')?.value || null,
                occupation: document.getElementById('charOccupation')?.value || null,
                relationship: document.getElementById('charRelationship')?.value || null,

                // Ïô∏Î™® Ï†ïÎ≥¥
                appearance: {
                    hair: document.getElementById('charHair')?.value || null,
                    eyes: document.getElementById('charEyes')?.value || null,
                    body: document.getElementById('charBody')?.value || null,
                    bust: document.getElementById('charBust')?.value || null,
                    waist_hip: document.getElementById('charWaistHip')?.value || null,
                    style: document.getElementById('charStyle')?.value || null
                },

                // ÎåÄÌôî Ïä§ÌÉÄÏùº
                speech_style: document.getElementById('charSpeechStyle')?.value || null, // üö® Îπà Î¨∏ÏûêÏó¥Ïù¥Î©¥ null
                speech_habit: document.getElementById('charSpeechHabit')?.value || 'Ïò§Îπ†',
                values: document.getElementById('charValues')?.value || null,

                // ÏÑ†ÌÉùÎêú ÏÑ±Í≤©ÌäπÏÑ±Í≥º Ï∑®ÎØ∏
                personality_traits: getSelectedPersonalityTraits(),
                hobbies: getSelectedHobbies(),

                // Îß§Î†• ÌîÑÎ°úÌïÑ
                seduction_style: document.getElementById('seductionStyle')?.value || null,
                emotional_intelligence: parseInt(document.getElementById('emotionalIntelligence')?.value) || null,
                confidence_level: parseInt(document.getElementById('confidenceLevel')?.value) || null,
                mystery_factor: parseInt(document.getElementById('mysteryFactor')?.value) || null,
                comfort_level: document.getElementById('comfortLevel')?.value || null,
                escalation_pace: document.getElementById('escalationPace')?.value || null
            };

            console.log('üìã ÏûÖÎ†• Îç∞Ïù¥ÌÑ∞ ÏàòÏßë ÏôÑÎ£å:', inputData);
            return inputData;
        }

        // üé≤ Îπà ÌïÑÎìúÎì§ÏùÑ ÎûúÎç§ÏúºÎ°ú Ï±ÑÏö∞Îäî Ìï®Ïàò
        function fillMissingFieldsRandomly(inputData) {
            const randomSelections = {
                character_type: ['romance_junior', 'seductive_junior', 'cute_junior', 'elegant_senior'],
                occupation: ['student', 'office_worker', 'designer', 'nurse', 'teacher', 'developer', 'artist', 'photographer', 'journalist', 'unemployed', 'flight_attendant', 'doctor', 'singer', 'actress', 'pharmacist', 'lawyer', 'chef', 'banker', 'marketing', 'entrepreneur'],
                family: ['only_child', 'older_sister', 'younger_sister', 'middle_child'],
                hometown: ['seoul', 'busan', 'incheon', 'daegu', 'gwangju'],
                relationship: ['secret_crush', 'childhood_friend', 'senior_friend', 'classmate'],

                hair: ['long_straight', 'long_wavy', 'medium_bob', 'short_cute'],
                eyes: ['round_cute', 'seductive_eyes', 'innocent_eyes', 'mysterious_eyes'],
                body: ['petite', 'petite_sexy', 'average_height', 'tall_elegant'],
                bust: ['A', 'B', 'C', 'D', 'E', 'F'],
                waist_hip: ['Ïä¨Î¶º', 'Í∏ÄÎûòÎ®∏', 'Î™®ÎûòÏãúÍ≥Ñ', 'Ïö¥ÎèôÏ≤¥Ìòï', 'ÌíçÎßå', 'Í∑†Ìòï'],
                style: ['ÏÑπÏãú', 'Ïö∞ÏïÑ', 'Ï∫êÏ£ºÏñº', 'ÌÅêÌä∏', 'ÎèÑÎ∞úÏ†Å', 'ÌÅ¥ÎûòÏãù', 'Ìä∏Î†åÎîî', 'Î≥¥Ìó§ÎØ∏Ïïà'],

                values: ['love_family', 'pursue_dreams', 'value_friendship', 'seek_stability'],

                seduction_style: ['playful_confident', 'innocent_charming', 'mysterious_alluring', 'direct_passionate'],
                comfort_level: ['light_flirtation', 'moderate_flirtation', 'intimate_conversation'],
                escalation_pace: ['very_gradual', 'gradual_building', 'moderate_pace', 'quick_escalation'],

                personality_traits: [
                    ['ÏπúÌôîÏ†Å', 'ÌôúÎ∞úÌïú', 'ÎÇôÍ¥ÄÏ†Å'],
                    ['ÎÇ¥Ìñ•Ï†Å', 'Ïã†Ï§ëÌïú', 'ÏòàÏà†Ï†Å'],
                    ['ÎÖºÎ¶¨Ï†Å', 'ÎèÖÎ¶ΩÏ†Å', 'ÏïºÏã¨Ï∞¨'],
                    ['Î∞∞Î†§Ïã¨ ÎßéÏùÄ', 'ÌòëÎ†•Ï†Å', 'Îî∞ÎúªÌïú'],
                    ['Ïã§Ïö©Ï†Å', 'ÏúµÌÜµÏÑ± ÏûàÎäî', 'Î™®ÌóòÏ†Å']
                ],

                hobbies: [
                    ['ÎèÖÏÑú', 'ÏòÅÌôîÍ∞êÏÉÅ', 'Ïπ¥ÌéòÌà¨Ïñ¥'],
                    ['ÏöîÎ¶¨', 'Î≤†Ïù¥ÌÇπ', 'ÎßõÏßëÌÉêÎ∞©'],
                    ['Ïö¥Îèô', 'ÏöîÍ∞Ä', 'ÏÇ∞Ï±Ö'],
                    ['ÏáºÌïë', 'Ìå®ÏÖò', 'Î∑∞Ìã∞'],
                    ['Ïó¨Ìñâ', 'ÏÇ¨ÏßÑ', 'ÎìúÎùºÏù¥Î∏å']
                ],

                // ÎÇ®ÏÑ± Ïö∞ÏÑ†ÏàúÏúÑ ÏòµÏÖòÎì§
                male_priorities: [
                    ['humor', 'communication'],
                    ['intelligence', 'emotional_maturity'],
                    ['appearance', 'financial_stability'],
                    ['reliability', 'personality'],
                    ['creativity', 'adventure_spirit'],
                    ['family_oriented', 'career_focused']
                ],

                // ÎØ∏Îûò ÏßÅÏóÖ Î™©ÌëúÎì§
                future_careers: [
                    ['entrepreneur', 'business_owner'],
                    ['creative_director', 'freelancer'],
                    ['teacher', 'counselor'],
                    ['researcher', 'professor'],
                    ['artist', 'designer'],
                    ['manager', 'executive']
                ],

                // ÏÑ†Ìò∏ÌïòÎäî ÏÑ†Î¨ºÎì§
                favorite_gifts: [
                    ['flowers', 'chocolate'],
                    ['jewelry', 'perfume'],
                    ['books', 'music'],
                    ['spa_voucher', 'luxury_lingerie'],
                    ['cute_accessories', 'expensive_car'],
                    ['art_supplies', 'tech_gadgets']
                ]
            };

            // ÎûúÎç§ÏúºÎ°ú Îπà ÌïÑÎìú Ï±ÑÏö∞Í∏∞
            const completeData = { ...inputData };

            // Í∏∞Î≥∏ Ï†ïÎ≥¥
            if (!completeData.character_type) completeData.character_type = randomChoice(randomSelections.character_type);
            if (!completeData.occupation) completeData.occupation = randomChoice(randomSelections.occupation);
            if (!completeData.relationship) completeData.relationship = randomChoice(randomSelections.relationship);


            // Ïô∏Î™® Ï†ïÎ≥¥
            if (!completeData.appearance.hair) completeData.appearance.hair = randomChoice(randomSelections.hair);
            if (!completeData.appearance.eyes) completeData.appearance.eyes = randomChoice(randomSelections.eyes);
            if (!completeData.appearance.body) completeData.appearance.body = randomChoice(randomSelections.body);
            if (!completeData.appearance.bust) completeData.appearance.bust = randomChoice(randomSelections.bust);
            if (!completeData.appearance.waist_hip) completeData.appearance.waist_hip = randomChoice(randomSelections.waist_hip);
            if (!completeData.appearance.style) completeData.appearance.style = randomChoice(randomSelections.style);

            // Í∏∞ÌÉÄ Ï†ïÎ≥¥
            if (!completeData.values) completeData.values = randomChoice(randomSelections.values);
            if (!completeData.seduction_style) completeData.seduction_style = randomChoice(randomSelections.seduction_style);
            if (!completeData.comfort_level) completeData.comfort_level = randomChoice(randomSelections.comfort_level);
            if (!completeData.escalation_pace) completeData.escalation_pace = randomChoice(randomSelections.escalation_pace);

            // ÎßêÌà¨ Í¥ÄÎ†® (ÏÉàÎ°ú Ï∂îÍ∞Ä)
            if (!completeData.speech_style) {
                const speechStyles = ['ÏπúÍ∑ºÌïú ÎßêÌà¨', 'Î∂ÄÎìúÎü¨Ïö¥ ÎßêÌà¨', 'Î™ÖÎûëÌïú ÎßêÌà¨', 'Ï∞®Î∂ÑÌïú ÎßêÌà¨', 'Ïï†Íµê ÎßéÏùÄ ÎßêÌà¨'];
                completeData.speech_style = randomChoice(speechStyles);
            }
            if (!completeData.speech_habit) {
                const speechHabits = ['Ïò§Îπ†', 'ÏÑ†Î∞∞', 'Ïù¥Î¶ÑÏúºÎ°ú', 'Îãò', 'Ïñ∏Îãà'];
                completeData.speech_habit = randomChoice(speechHabits);
            }

            // Ïä¨ÎùºÏù¥Îçî Í∞íÎì§ (Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï)
            if (!completeData.emotional_intelligence) completeData.emotional_intelligence = randomRange(6, 9);
            if (!completeData.confidence_level) completeData.confidence_level = randomRange(6, 9);
            if (!completeData.mystery_factor) completeData.mystery_factor = randomRange(4, 8);

            // ÏÑ±Í≤©ÌäπÏÑ±Í≥º Ï∑®ÎØ∏ (Îπà Î∞∞Ïó¥Ïù¥Î©¥ ÎûúÎç§ ÏÑ†ÌÉù)
            if (!completeData.personality_traits || completeData.personality_traits.length === 0) {
                completeData.personality_traits = randomChoice(randomSelections.personality_traits);
            }
            if (!completeData.hobbies || completeData.hobbies.length === 0) {
                completeData.hobbies = randomChoice(randomSelections.hobbies);
            }

            // ÎÇ®ÏÑ± Ïö∞ÏÑ†ÏàúÏúÑ (Îπà Î∞∞Ïó¥Ïù¥Î©¥ ÎûúÎç§ ÏÑ†ÌÉù)
            if (!completeData.male_priorities || completeData.male_priorities.length === 0) {
                completeData.male_priorities = randomChoice(randomSelections.male_priorities);
            }

            // ÎØ∏Îûò ÏßÅÏóÖ Î™©Ìëú (Îπà Î∞∞Ïó¥Ïù¥Î©¥ ÎûúÎç§ ÏÑ†ÌÉù)
            if (!completeData.future_careers || completeData.future_careers.length === 0) {
                completeData.future_careers = randomChoice(randomSelections.future_careers);
            }

            // ÏÑ†Ìò∏ÌïòÎäî ÏÑ†Î¨º (Îπà Î∞∞Ïó¥Ïù¥Î©¥ ÎûúÎç§ ÏÑ†ÌÉù)
            if (!completeData.favorite_gifts || completeData.favorite_gifts.length === 0) {
                completeData.favorite_gifts = randomChoice(randomSelections.favorite_gifts);
            }

            console.log('üé≤ ÎûúÎç§ ÏôÑÏÑ± Í≤∞Í≥º:', completeData);
            return completeData;
        }

        // ÎûúÎç§ ÏÑ†ÌÉù Ìó¨Ìçº Ìï®Ïàò
        function randomChoice(array) {
            return array[Math.floor(Math.random() * array.length)];
        }

        // ÎûúÎç§ Î≤îÏúÑ Ìó¨Ìçº Ìï®Ïàò
        function randomRange(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // ÏÑ†ÌÉùÎêú ÏÑ±Í≤©ÌäπÏÑ± ÏàòÏßë Ìï®Ïàò
        function getSelectedPersonalityTraits() {
            const selected = [];
            document.querySelectorAll('input[name="personality"]:checked').forEach(checkbox => {
                selected.push(checkbox.value);
            });
            return selected;
        }

        // ÏÑ†ÌÉùÎêú Ï∑®ÎØ∏ ÏàòÏßë Ìï®Ïàò
        function getSelectedHobbies() {
            const selected = [];
            document.querySelectorAll('input[name="hobbies"]:checked').forEach(checkbox => {
                selected.push(checkbox.value);
            });
            return selected;
        }

        // üìú Ïù∏Î¨ºÏÜåÍ∞úÎ•º ÌîÑÎ°¨ÌîÑÌä∏Î°ú ÌëúÏãúÌïòÎäî Î™®Îã¨ Ìï®Ïàò
        function showCharacterPromptModal(profile, character) {
            console.log('üìú Ïù∏Î¨ºÏÜåÍ∞ú(ÌîÑÎ°¨ÌîÑÌä∏) Î™®Îã¨ ÌëúÏãú');

            const characterName = character?.basic_info?.name || character?.name || 'Ï∫êÎ¶≠ÌÑ∞';

            // Í∏∞Ï°¥ ÌîÑÎ°úÌïÑ Î™®Îã¨Ïù¥ ÏûàÎã§Î©¥ Ï†úÎ™©Í≥º ÎÇ¥Ïö©Îßå Î≥ÄÍ≤Ω
            let modal = document.getElementById('characterProfileModal');
            if (!modal) {
                // Î™®Îã¨Ïù¥ ÏóÜÏúºÎ©¥ ÎèôÏ†Å ÏÉùÏÑ±
                modal = document.createElement('div');
                modal.id = 'characterProfileModal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <span class="close" onclick="closeModal('characterProfileModal')">&times;</span>
                            <h2 id="profileCharacterName">${characterName} Ïù∏Î¨ºÏÜåÍ∞ú</h2>
                        </div>
                        <div class="modal-body">
                            <div id="profileContent" style="white-space: pre-wrap; line-height: 1.6;"></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('characterProfileModal')">Îã´Í∏∞</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            // ÎÇ¥Ïö© ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('profileCharacterName').textContent = `${characterName} Ïù∏Î¨ºÏÜåÍ∞ú`;
            document.getElementById('profileContent').textContent = profile.profile_text || profile.text || profile;

            // Î™®Îã¨ ÌëúÏãú
            modal.style.display = 'block';
        }

        // ÌòÑÏû¨ Ìèº Îç∞Ïù¥ÌÑ∞ ÏàòÏßë Ìï®Ïàò (ÌôïÏû•Îêú Î≤ÑÏ†Ñ)
        function collectCharacterFormData() {
            const formData = {
                id: document.getElementById('characterId')?.value || null,
                basic_info: {
                    name: document.getElementById('charName')?.value || 'ÎØ∏ÏßÄÏùò ÏÜåÎÖÄ',
                    age: parseInt(document.getElementById('charAge')?.value) || 22,
                    mbti: document.getElementById('charMbti')?.value || 'INFP',
                    occupation: document.getElementById('charOccupation')?.value || 'student',
                    gender: 'female'
                },
                // üÜï ÏÑ±Í≤© ÌäπÏÑ± Ï∂îÍ∞Ä (ÎàÑÎùΩÎêòÏóàÎçò ÌïÑÎìú)
                personality_traits: getSelectedTraits(),
                appeal_profile: {
                    seduction_style: document.getElementById('seductionStyle')?.value || 'warm_nurturing',
                    charm_points: getSelectedCharmPoints(),
                    emotional_intelligence: parseInt(document.getElementById('emotionalIntelligence')?.value) || 7,
                    confidence_level: parseInt(document.getElementById('confidenceLevel')?.value) || 6,
                    mystery_factor: parseInt(document.getElementById('mysteryFactor')?.value) || 5,
                    sexual_curiosity: parseInt(document.getElementById('sexualCuriosity')?.value) || 5, // üÜï ÏÑ±Ï†Å Ìò∏Í∏∞Ïã¨
                    sexual_comfort: parseInt(document.getElementById('sexualComfort')?.value) || 4, // üÜï ÏÑ±Ï†Å Ïø®Ï†ÅÎèÑ
                    hobbies: getSelectedHobbies() // üÜï Ï∑®ÎØ∏
                },
                physical_allure: {
                    appearance: {
                        hair: document.getElementById('charHair')?.value || 'long_straight',
                        eyes: document.getElementById('charEyes')?.value || 'seductive_eyes',
                        body: document.getElementById('charBody')?.value || 'average_attractive',
                        bust: document.getElementById('charBust')?.value || 'C',
                        waist_hip: document.getElementById('charWaistHip')?.value || 'Í∏ÄÎûòÎ®∏',
                        style: document.getElementById('charStyle')?.value || 'ÏÑπÏãú'
                    },
                    feature_elements: getSelectedFeatureElements(), // üÜï Ïô∏Î™® Îß§Î†•Ïùò ÌäπÏßïÏöîÏÜå
                    sensual_habits: getSelectedSensualHabits(), // üÜï Í¥ÄÎä•Ï†Å ÏäµÍ¥Ä
                    body_language: getSelectedBodyLanguage() // üÜï Î™∏Ïßì Ïñ∏Ïñ¥ (Î≤ÑÌäº ÏãúÏä§ÌÖú)
                },
                psychological_depth: {
                    core_desires: getSelectedCoreDesires(),
                    vulnerabilities: ['perfectionism', 'commitment_fear'], // üÜï Í∏∞Î≥∏ Ï∑®ÏïΩÏ†ê Ï∂îÍ∞Ä
                    values: document.getElementById('charValues')?.value || 'love_family', // üÜï Í∞ÄÏπòÍ¥Ä
                    boundaries: {
                        comfort_level: document.getElementById('comfortLevel')?.value || 'light_flirtation',
                        escalation_pace: document.getElementById('escalationPace')?.value || 'very_gradual',
                        sexual_tone_band: 'moderate', // üÜï ÏÑ±Ï†Å ÌÜ§ Î∞¥Îìú Ï∂îÍ∞Ä
                    },
                    sexual_freedom: Math.floor(Math.random() * 5) + 3 // üÜï ÏÑ±Ï†Å ÏûêÏú†Î∂ÑÎ∞©Ìï® (3-7 ÎûúÎç§)
                },
                conversation_dynamics: {
                    speech_style: getSelectedSpeechStyle(), // üö® Î≤ÑÌäº ÏãúÏä§ÌÖúÏúºÎ°ú Î≥ÄÍ≤Ω
                    flirting_patterns: getSelectedFlirtingPatterns(), // üÜï ÌîåÎü¨ÌåÖ Ìå®ÌÑ¥
                    reaction_tendencies: {
                        humor: document.getElementById('humorResponse')?.value || 'giggles_easily', // üÜï Ïú†Î®∏ Î∞òÏùë
                        compliment: document.getElementById('complimentResponse')?.value || 'gracefully_accepts', // üÜï Ïπ≠Ï∞¨ Î∞òÏùë
                        interest_expression: document.getElementById('interestResponse')?.value || 'enthusiastic_sharing' // üÜï Í¥ÄÏã¨ ÌëúÌòÑ Î∞òÏùë
                    },
                    conversation_hooks: getSelectedConversationHooks(), // üÜï ÎåÄÌôî ÌõÖ
                    speech_habits: getSelectedSpeechHabits(), // üÜï ÎßêÌà¨ ÏäµÍ¥Ä (Î≤ÑÌäº ÏãúÏä§ÌÖú)
                    vocabulary_register: document.getElementById('vocabularyRegister')?.value || 'casual_friendly', // üÜï Ïñ¥Ìúò ÏàòÏ§Ä
                    allowed_motifs: getSelectedAllowedMotifs(), // üÜï ÌóàÏö© Ï£ºÏ†ú
                    forbidden_terms: getSelectedForbiddenTopics() // üÜï Í∏àÏßÄ Î∂ÑÏïº (Î≤ÑÌäº ÏãúÏä§ÌÖú)
                },
                // üÜï Í≥ºÍ±∞ Ïù¥Î†• Ï†ïÎ≥¥
                past_history: {
                    boyfriend_count: parseInt(document.getElementById('boyfriendCount')?.value) || 2,
                    preferred_skinship: getSelectedSkinship(),
                    relationship_experience: document.getElementById('relationshipExperience')?.value || 'beginner',
                    first_experience_age: document.getElementById('firstExperienceAge')?.value || 'early_twenties'
                },
                // üéÅ Ï¢ãÏïÑÌïòÎäî ÏÑ†Î¨º Ï†ïÎ≥¥
                favorite_gifts: getSelectedFavoriteGifts(),
                // üë® ÎÇ®ÏûêÎ•º Î≥º Îïå ÏµúÏö∞ÏÑ†ÏãúÌïòÎäî Í≤É
                male_priorities: getSelectedMalePriorities(),
                // üéÜ ÎØ∏Îûò Î™©Ìëú Ï†ïÎ≥¥
                future_goals: {
                    asset_goal: document.getElementById('assetGoal')?.value || '5_billion',
                    future_careers: getSelectedFutureCareers()
                }
            };

            console.log('üìã ÏàòÏßëÎêú Ìèº Îç∞Ïù¥ÌÑ∞ (ÌôïÏû•):', formData);
            return formData;
        }

        // ÏÑ†ÌÉùÎêú Îß§Î†• Ìè¨Ïù∏Ìä∏ ÏàòÏßë (Îπà Î∞∞Ïó¥Ïù¥Î©¥ null Î∞òÌôò)
        function getSelectedCharmPoints() {
            console.log('üîç getSelectedCharmPoints Ïã§Ìñâ Ï§ë...');
            const selected = [];

            // Î≤ÑÌäº ÏãúÏä§ÌÖúÏúºÎ°ú Î≥ÄÍ≤Ω - .charm-btn.selected ÌÅ¥ÎûòÏä§Î°ú Ï∞æÍ∏∞
            const selectedCharmBtns = document.querySelectorAll('.charm-btn.selected');
            console.log('üìä ÏÑ†ÌÉùÎêú charm-btn ÏöîÏÜå Ïàò:', selectedCharmBtns.length);

            selectedCharmBtns.forEach(btn => {
                const value = btn.getAttribute('data-charm');
                if (value) {
                    selected.push(value);
                    console.log('‚úÖ Îß§Î†•Ìè¨Ïù∏Ìä∏ ÏàòÏßëÎê®:', value);
                }
            });

            // Í∏∞Ï°¥ Ï≤¥ÌÅ¨Î∞ïÏä§ ÏãúÏä§ÌÖúÎèÑ Ï≤¥ÌÅ¨ (Ìò∏ÌôòÏÑ±)
            const checkboxes = document.querySelectorAll('input[name="charm_points"]:checked');
            console.log('üìä Ï≤¥ÌÅ¨Îêú Ï≤¥ÌÅ¨Î∞ïÏä§ Ïàò:', checkboxes.length);
            checkboxes.forEach(cb => {
                selected.push(cb.value);
                console.log('‚úÖ Ï≤¥ÌÅ¨Î∞ïÏä§ Îß§Î†•Ìè¨Ïù∏Ìä∏ ÏàòÏßëÎê®:', cb.value);
            });

            console.log('üéØ ÏµúÏ¢Ö Îß§Î†•Ìè¨Ïù∏Ìä∏ Î∞∞Ïó¥:', selected);
            return selected.length === 0 ? ['infectious_smile', 'witty_banter'] : selected; // üö® Îπà Î∞∞Ïó¥Ïù¥Î©¥ Í∏∞Î≥∏Í∞í Î∞òÌôò
        }

        // ÏÑ†ÌÉùÎêú ÌïµÏã¨ ÏöïÍµ¨ ÏàòÏßë (Îπà Î∞∞Ïó¥Ïù¥Î©¥ null Î∞òÌôò)
        function getSelectedCoreDesires() {
            console.log('üîç getSelectedCoreDesires Ïã§Ìñâ Ï§ë...');
            const selected = [];

            // Î≤ÑÌäº ÏãúÏä§ÌÖúÏúºÎ°ú Î≥ÄÍ≤Ω - .desire-btn.selected ÌÅ¥ÎûòÏä§Î°ú Ï∞æÍ∏∞
            const selectedDesireBtns = document.querySelectorAll('.desire-btn.selected');
            console.log('üìä ÏÑ†ÌÉùÎêú desire-btn ÏöîÏÜå Ïàò:', selectedDesireBtns.length);

            selectedDesireBtns.forEach(btn => {
                const value = btn.getAttribute('data-desire');
                if (value) {
                    selected.push(value);
                    console.log('‚úÖ ÌïµÏã¨ÏöïÍµ¨ ÏàòÏßëÎê®:', value);
                }
            });

            // Í∏∞Ï°¥ select ÏãúÏä§ÌÖúÎèÑ Ï≤¥ÌÅ¨ (Ìò∏ÌôòÏÑ±)
            const select = document.getElementById('coreDesires');
            if (select) {
                console.log('üìä select ÏöîÏÜå Î∞úÍ≤¨, selectedOptions Ïàò:', select.selectedOptions.length);
                for (let option of select.selectedOptions) {
                    selected.push(option.value);
                    console.log('‚úÖ select ÌïµÏã¨ÏöïÍµ¨ ÏàòÏßëÎê®:', option.value);
                }
            } else {
                console.log('‚ö†Ô∏è coreDesires select ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå');
            }

            console.log('üéØ ÏµúÏ¢Ö ÌïµÏã¨ÏöïÍµ¨ Î∞∞Ïó¥:', selected);
            return selected.length === 0 ? ['meaningful_connection', 'personal_growth'] : selected; // üö® Îπà Î∞∞Ïó¥Ïù¥Î©¥ Í∏∞Î≥∏Í∞í Î∞òÌôò
        }

        // ÏÑ†ÌÉùÎêú ÎßêÌà¨ Ïä§ÌÉÄÏùº ÏàòÏßë (Î≤ÑÌäº ÏãúÏä§ÌÖú)
        function getSelectedSpeechStyle() {
            console.log('üîç getSelectedSpeechStyle Ïã§Ìñâ Ï§ë...');

            // Î≤ÑÌäº ÏãúÏä§ÌÖúÏúºÎ°ú Ï∞æÍ∏∞ - .speech-btn.selected ÌÅ¥ÎûòÏä§Î°ú Ï∞æÍ∏∞
            const selectedSpeechBtn = document.querySelector('.speech-btn.selected');
            if (selectedSpeechBtn) {
                const value = selectedSpeechBtn.getAttribute('data-speech');
                console.log('‚úÖ ÎßêÌà¨Ïä§ÌÉÄÏùº ÏàòÏßëÎê®:', value);
                return value;
            }

            // Í∏∞Ï°¥ select ÏãúÏä§ÌÖúÎèÑ Ï≤¥ÌÅ¨ (Ìò∏ÌôòÏÑ±)
            const select = document.getElementById('charSpeechStyle');
            if (select && select.value) {
                console.log('‚úÖ select ÎßêÌà¨Ïä§ÌÉÄÏùº ÏàòÏßëÎê®:', select.value);
                return select.value;
            }

            console.log('‚ö†Ô∏è ÏÑ†ÌÉùÎêú ÎßêÌà¨Ïä§ÌÉÄÏùºÏù¥ ÏóÜÏùå');
            return 'confident_alluring';
        }

        // üÜï ÏÑ†ÌÉùÎêú Ï∑®ÎØ∏ ÏàòÏßë
        function getSelectedHobbies() {
            console.log('üîç getSelectedHobbies Ïã§Ìñâ Ï§ë...');
            const selected = [];
            const selectedHobbyBtns = document.querySelectorAll('.hobby-btn.selected');
            console.log('üìä ÏÑ†ÌÉùÎêú hobby-btn ÏöîÏÜå Ïàò:', selectedHobbyBtns.length);

            selectedHobbyBtns.forEach(btn => {
                const value = btn.getAttribute('data-hobby');
                if (value) {
                    selected.push(value);
                    console.log('‚úÖ Ï∑®ÎØ∏ ÏàòÏßëÎê®:', value);
                }
            });

            console.log('üéØ ÏµúÏ¢Ö Ï∑®ÎØ∏ Î∞∞Ïó¥:', selected);
            return selected.length === 0 ? ['reading', 'music', 'movies'] : selected;
        }

        // üÜï ÏÑ†ÌÉùÎêú ÏûêÏã†ÏûàÎäî Î∂ÄÏúÑ ÏàòÏßë
        function getSelectedFeatureElements() {
            console.log('üîç getSelectedFeatureElements Ïã§Ìñâ Ï§ë...');
            const selected = [];
            const selectedPartBtns = document.querySelectorAll('.confident-part-btn.selected');
            console.log('üìä ÏÑ†ÌÉùÎêú confident-part-btn ÏöîÏÜå Ïàò:', selectedPartBtns.length);

            selectedPartBtns.forEach(btn => {
                const value = btn.getAttribute('data-feature');
                if (value) {
                    selected.push(value);
                    console.log('‚úÖ ÏûêÏã†ÏûàÎäî Î∂ÄÏúÑ ÏàòÏßëÎê®:', value);
                }
            });

            console.log('üéØ ÏµúÏ¢Ö ÏûêÏã†ÏûàÎäî Î∂ÄÏúÑ Î∞∞Ïó¥:', selected);
            return selected.length === 0 ? ['seductive_eyes', 'slim_waist'] : selected;
        }

        // üÜï ÏÑ†ÌÉùÎêú ÏÑπÏãúÌè¨Ï¶à ÏàòÏßë
        function getSelectedSensualHabits() {
            console.log('üîç getSelectedSensualHabits Ïã§Ìñâ Ï§ë...');
            const selected = [];
            const selectedPoseBtns = document.querySelectorAll('.seductive-pose-btn.selected');
            console.log('üìä ÏÑ†ÌÉùÎêú seductive-pose-btn ÏöîÏÜå Ïàò:', selectedPoseBtns.length);

            selectedPoseBtns.forEach(btn => {
                const value = btn.getAttribute('data-habit');
                if (value) {
                    selected.push(value);
                    console.log('‚úÖ ÏÑπÏãúÌè¨Ï¶à ÏàòÏßëÎê®:', value);
                }
            });

            console.log('üéØ ÏµúÏ¢Ö ÏÑπÏãúÌè¨Ï¶à Î∞∞Ïó¥:', selected);
            return selected.length === 0 ? ['ÏûÖÏà†Íπ®Î¨ºÍ∏∞', 'Ïú†ÌòπÏ†ÅÏãúÏÑ†'] : selected;
        }

        // üéÅ Ï¢ãÏïÑÌïòÎäî ÏÑ†Î¨º ÏÑ†ÌÉùÎêú Ìï≠Î™© Í∞ÄÏ†∏Ïò§Í∏∞
        function getSelectedFavoriteGifts() {
            console.log('üîç getSelectedFavoriteGifts Ïã§Ìñâ Ï§ë...');
            const selected = [];
            const selectedGiftBtns = document.querySelectorAll('.gift-btn.selected');
            console.log('üìä ÏÑ†ÌÉùÎêú gift-btn ÏöîÏÜå Ïàò:', selectedGiftBtns.length);

            selectedGiftBtns.forEach(btn => {
                const value = btn.getAttribute('data-gift');
                if (value) {
                    selected.push(value);
                    console.log('‚úÖ Ï¢ãÏïÑÌïòÎäî ÏÑ†Î¨º ÏàòÏßëÎê®:', value);
                }
            });

            console.log('üéØ ÏµúÏ¢Ö Ï¢ãÏïÑÌïòÎäî ÏÑ†Î¨º Î∞∞Ïó¥:', selected);
            return selected.length === 0 ? ['flowers', 'chocolate', 'perfume'] : selected;
        }

        // üíï Ìù•Î∂ÑÏãú Î∞òÏùë ÏÑ†ÌÉùÎêú Ìï≠Î™© Í∞ÄÏ†∏Ïò§Í∏∞
        function getSelectedBodyLanguage() {
            console.log('üîç getSelectedBodyLanguage Ïã§Ìñâ Ï§ë...');
            const selected = [];
            const selectedLanguageBtns = document.querySelectorAll('.body-language-btn.selected');
            console.log('üìä ÏÑ†ÌÉùÎêú body-language-btn ÏöîÏÜå Ïàò:', selectedLanguageBtns.length);

            selectedLanguageBtns.forEach(btn => {
                const value = btn.getAttribute('data-language');
                if (value) {
                    selected.push(value);
                    console.log('‚úÖ Ìù•Î∂ÑÏãú Î∞òÏùë ÏàòÏßëÎê®:', value);
                }
            });

            console.log('üéØ ÏµúÏ¢Ö Ìù•Î∂ÑÏãú Î∞òÏùë Î∞∞Ïó¥:', selected);
            return selected.length === 0 ? ['ÏñºÍµ¥Î∞úÍ∑∏Î†àÏßê', 'Ïã¨Ïû•ÎëêÍ∑ºÍ±∞Î¶º'] : selected;
        }

        // === Hidden Input ÏóÖÎç∞Ïù¥Ìä∏ Ìï®ÏàòÎì§ ===

        // ÏÑ±Í≤© ÌäπÏÑ± hidden input ÏóÖÎç∞Ïù¥Ìä∏
        function updatePersonalityTraitsHiddenInput() {
            const selected = [];
            document.querySelectorAll('.trait-btn.selected').forEach(btn => {
                const trait = btn.getAttribute('data-trait');
                if (trait) selected.push(trait);
            });
            const hiddenInput = document.getElementById('charPersonalityTraits');
            if (hiddenInput) {
                hiddenInput.value = JSON.stringify(selected);
                console.log('üîÑ ÏÑ±Í≤©ÌäπÏÑ± hidden input ÏóÖÎç∞Ïù¥Ìä∏:', hiddenInput.value);
            }
        }

        // Ï∑®ÎØ∏ hidden input ÏóÖÎç∞Ïù¥Ìä∏
        function updateHobbiesHiddenInput() {
            const selected = [];
            document.querySelectorAll('.hobby-btn.selected').forEach(btn => {
                const hobby = btn.getAttribute('data-hobby');
                if (hobby) selected.push(hobby);
            });
            const hiddenInput = document.getElementById('charHobbies');
            if (hiddenInput) {
                hiddenInput.value = JSON.stringify(selected);
                console.log('üîÑ Ï∑®ÎØ∏ hidden input ÏóÖÎç∞Ïù¥Ìä∏:', hiddenInput.value);
            }
        }

        // ÏûêÏã†ÏûàÎäî Î∂ÄÏúÑ hidden input ÏóÖÎç∞Ïù¥Ìä∏
        function updateFeatureElementsHiddenInput() {
            const selected = [];
            document.querySelectorAll('.confident-part-btn.selected').forEach(btn => {
                const feature = btn.getAttribute('data-feature');
                if (feature) selected.push(feature);
            });
            const hiddenInput = document.getElementById('charFeatureElements');
            if (hiddenInput) {
                hiddenInput.value = JSON.stringify(selected);
                console.log('üîÑ ÏûêÏã†ÏûàÎäî Î∂ÄÏúÑ hidden input ÏóÖÎç∞Ïù¥Ìä∏:', hiddenInput.value);
            }
        }

        // ÏÑπÏãúÌè¨Ï¶à hidden input ÏóÖÎç∞Ïù¥Ìä∏
        function updateSensualHabitsHiddenInput() {
            const selected = [];
            document.querySelectorAll('.seductive-pose-btn.selected').forEach(btn => {
                const habit = btn.getAttribute('data-habit');
                if (habit) selected.push(habit);
            });
            const hiddenInput = document.getElementById('charSensualHabits');
            if (hiddenInput) {
                hiddenInput.value = JSON.stringify(selected);
                console.log('üîÑ ÏÑπÏãúÌè¨Ï¶à hidden input ÏóÖÎç∞Ïù¥Ìä∏:', hiddenInput.value);
            }
        }

        // Ìù•Î∂ÑÏãú Î∞òÏùë hidden input ÏóÖÎç∞Ïù¥Ìä∏
        function updateBodyLanguageHiddenInput() {
            const selected = [];
            document.querySelectorAll('.body-language-btn.selected').forEach(btn => {
                const language = btn.getAttribute('data-language');
                if (language) selected.push(language);
            });
            const hiddenInput = document.getElementById('charBodyLanguage');
            if (hiddenInput) {
                hiddenInput.value = JSON.stringify(selected);
                console.log('üîÑ Ìù•Î∂ÑÏãú Î∞òÏùë hidden input ÏóÖÎç∞Ïù¥Ìä∏:', hiddenInput.value);
            }
        }

        // Hidden input ÌååÏã± Ìó¨Ìçº Ìï®Ïàò
        function parseHiddenInput(inputId) {
            try {
                const input = document.getElementById(inputId);
                if (!input || !input.value) {
                    console.log(`‚ö†Ô∏è Hidden input ${inputId} is empty or missing`);
                    return [];
                }
                const parsed = JSON.parse(input.value);
                console.log(`‚úÖ Parsed ${inputId}:`, parsed);
                return Array.isArray(parsed) ? parsed : [];
            } catch (error) {
                console.error(`‚ùå Failed to parse ${inputId}:`, error);
                return [];
            }
        }

        // üó£Ô∏è ÎßêÌà¨ ÏäµÍ¥Ä ÏÑ†ÌÉùÎêú Ìï≠Î™© Í∞ÄÏ†∏Ïò§Í∏∞
        function getSelectedSpeechHabits() {
            console.log('üîç getSelectedSpeechHabits Ïã§Ìñâ Ï§ë...');
            const selected = [];
            const selectedHabitBtns = document.querySelectorAll('.speech-habit-btn.selected');
            console.log('üìä ÏÑ†ÌÉùÎêú speech-habit-btn ÏöîÏÜå Ïàò:', selectedHabitBtns.length);

            selectedHabitBtns.forEach(btn => {
                const value = btn.getAttribute('data-habit');
                if (value) {
                    selected.push(value);
                    console.log('‚úÖ ÎßêÌà¨ ÏäµÍ¥Ä ÏàòÏßëÎê®:', value);
                }
            });

            console.log('üéØ ÏµúÏ¢Ö ÎßêÌà¨ ÏäµÍ¥Ä Î∞∞Ïó¥:', selected);
            return selected.length === 0 ? ['polite_ending', 'frequent_emoji'] : selected;
        }

        // üö´ Í∏àÏßÄ Î∂ÑÏïº ÏÑ†ÌÉùÎêú Ìï≠Î™© Í∞ÄÏ†∏Ïò§Í∏∞
        function getSelectedForbiddenTopics() {
            console.log('üîç getSelectedForbiddenTopics Ïã§Ìñâ Ï§ë...');
            const selected = [];
            const selectedTopicBtns = document.querySelectorAll('.forbidden-topic-btn.selected');
            console.log('üìä ÏÑ†ÌÉùÎêú forbidden-topic-btn ÏöîÏÜå Ïàò:', selectedTopicBtns.length);

            selectedTopicBtns.forEach(btn => {
                const value = btn.getAttribute('data-topic');
                if (value) {
                    selected.push(value);
                    console.log('‚úÖ Í∏àÏßÄ Î∂ÑÏïº ÏàòÏßëÎê®:', value);
                }
            });

            console.log('üéØ ÏµúÏ¢Ö Í∏àÏßÄ Î∂ÑÏïº Î∞∞Ïó¥:', selected);
            return selected.length === 0 ? [] : selected; // Í∏∞Î≥∏Í∞í ÏóÜÏùå
        }

        // üë® ÏÑ†ÌÉùÎêú ÎÇ®Ïûê Ïö∞ÏÑ†ÏàúÏúÑ ÏàòÏßë
        function getSelectedMalePriorities() {
            console.log('üîç getSelectedMalePriorities Ïã§Ìñâ Ï§ë...');
            const selected = [];
            const selectedPriorityBtns = document.querySelectorAll('.male-priority-btn.selected');
            console.log('üìä ÏÑ†ÌÉùÎêú male-priority-btn ÏöîÏÜå Ïàò:', selectedPriorityBtns.length);

            selectedPriorityBtns.forEach(btn => {
                const value = btn.getAttribute('data-priority');
                if (value) {
                    selected.push(value);
                    console.log('‚úÖ ÎÇ®Ïûê Ïö∞ÏÑ†ÏàúÏúÑ ÏàòÏßëÎê®:', value);
                }
            });

            console.log('üéØ ÏµúÏ¢Ö ÎÇ®Ïûê Ïö∞ÏÑ†ÏàúÏúÑ Î∞∞Ïó¥:', selected);
            return selected.length === 0 ? ['humor', 'communication'] : selected;
        }

        // üÜï ÏÑ†ÌÉùÎêú Ïä§ÌÇ®Ïã≠ ÏàòÏßë
        function getSelectedSkinship() {
            console.log('üîç getSelectedSkinship Ïã§Ìñâ Ï§ë...');
            const selected = [];
            const selectedSkinshipBtns = document.querySelectorAll('.skinship-btn.selected');
            console.log('üìä ÏÑ†ÌÉùÎêú skinship-btn ÏöîÏÜå Ïàò:', selectedSkinshipBtns.length);

            selectedSkinshipBtns.forEach(btn => {
                const value = btn.getAttribute('data-skinship');
                if (value) {
                    selected.push(value);
                    console.log('‚úÖ Ïä§ÌÇ®Ïã≠ ÏàòÏßëÎê®:', value);
                }
            });

            console.log('üéØ ÏµúÏ¢Ö Ïä§ÌÇ®Ïã≠ Î∞∞Ïó¥:', selected);
            return selected.length === 0 ? ['hand_holding', 'cheek_kiss'] : selected;
        }

        // üÜï ÎåÄÌôîÏó≠Ìïô Í¥ÄÎ†® ÏÉà Îç∞Ïù¥ÌÑ∞ ÏàòÏßë Ìï®ÏàòÎì§

        // ÏÑ†ÌÉùÎêú ÌîåÎü¨ÌåÖ Ìå®ÌÑ¥ ÏàòÏßë
        function getSelectedFlirtingPatterns() {
            console.log('üîç getSelectedFlirtingPatterns Ïã§Ìñâ Ï§ë...');
            const selected = [];
            const selectedFlirtingBtns = document.querySelectorAll('.flirting-btn.selected');
            console.log('üìä ÏÑ†ÌÉùÎêú flirting-btn ÏöîÏÜå Ïàò:', selectedFlirtingBtns.length);

            selectedFlirtingBtns.forEach(btn => {
                const value = btn.getAttribute('data-flirting');
                if (value) {
                    selected.push(value);
                    console.log('‚úÖ ÌîåÎü¨ÌåÖÌå®ÌÑ¥ ÏàòÏßëÎê®:', value);
                }
            });

            console.log('üéØ ÏµúÏ¢Ö ÌîåÎü¨ÌåÖÌå®ÌÑ¥ Î∞∞Ïó¥:', selected);
            return selected.length === 0 ? ['subtle_teasing', 'playful_banter'] : selected;
        }

        // ÏÑ†ÌÉùÎêú ÎåÄÌôî ÌõÖ ÏàòÏßë
        function getSelectedConversationHooks() {
            console.log('üîç getSelectedConversationHooks Ïã§Ìñâ Ï§ë...');
            const selected = [];
            const selectedHookBtns = document.querySelectorAll('.hook-btn.selected');
            console.log('üìä ÏÑ†ÌÉùÎêú hook-btn ÏöîÏÜå Ïàò:', selectedHookBtns.length);

            selectedHookBtns.forEach(btn => {
                const value = btn.getAttribute('data-hook');
                if (value) {
                    selected.push(value);
                    console.log('‚úÖ ÎåÄÌôîÌõÖ ÏàòÏßëÎê®:', value);
                }
            });

            console.log('üéØ ÏµúÏ¢Ö ÎåÄÌôîÌõÖ Î∞∞Ïó¥:', selected);
            return selected.length === 0 ? ['travel_stories', 'music_movies'] : selected;
        }

        // ÏÑ†ÌÉùÎêú ÌóàÏö© Î™®Ìã∞ÌîÑ ÏàòÏßë
        function getSelectedAllowedMotifs() {
            console.log('üîç getSelectedAllowedMotifs Ïã§Ìñâ Ï§ë...');
            const selected = [];
            const selectedMotifBtns = document.querySelectorAll('.motif-btn.selected');
            console.log('üìä ÏÑ†ÌÉùÎêú motif-btn ÏöîÏÜå Ïàò:', selectedMotifBtns.length);

            selectedMotifBtns.forEach(btn => {
                const value = btn.getAttribute('data-motif');
                if (value) {
                    selected.push(value);
                    console.log('‚úÖ ÌóàÏö©Î™®Ìã∞ÌîÑ ÏàòÏßëÎê®:', value);
                }
            });

            console.log('üéØ ÏµúÏ¢Ö ÌóàÏö©Î™®Ìã∞ÌîÑ Î∞∞Ïó¥:', selected);
            return selected.length === 0 ? ['romance_love', 'daily_life'] : selected;
        }

        // üîÑ ÏóÖÍ∑∏Î†àÏù¥ÎìúÎêú Ï∫êÎ¶≠ÌÑ∞ Ìèº Îç∞Ïù¥ÌÑ∞ Ï±ÑÏö∞Í∏∞ Ìï®Ïàò (v2.0)
        function fillCharacterForm(character) {
            console.log('üìù Ìèº Îç∞Ïù¥ÌÑ∞ Ï±ÑÏö∞Í∏∞ ÏãúÏûë:', character);
            console.log('üîç Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞ Î∂ÑÏÑù:', Object.keys(character));

            // üîÑ 0Îã®Í≥Ñ: Î™®Îì† ÌÅ¥Î¶≠Ìòï ÌïÑÎìú Ï¥àÍ∏∞Ìôî
            resetAllClickableFields();

            // üéØ 1Îã®Í≥Ñ: Í∏∞Î≥∏ Ï†ïÎ≥¥ Ï≤òÎ¶¨ (ÏÉàÎ°úÏö¥ Ïä§ÌÇ§Îßà + Í∏∞Ï°¥ Ïä§ÌÇ§Îßà Ìò∏Ìôò)
            fillBasicInfo(character);

            // üéØ 2Îã®Í≥Ñ: Îß§Î†• ÌîÑÎ°úÌïÑ Ï≤òÎ¶¨
            fillAppealProfile(character);

            // üéØ 3Îã®Í≥Ñ: Ïô∏Î™® Ï†ïÎ≥¥ Ï≤òÎ¶¨
            fillPhysicalAppearance(character);

            // üéØ 4Îã®Í≥Ñ: Ïã¨Î¶¨Ï†Å ÌäπÏÑ± Ï≤òÎ¶¨
            fillPsychologicalTraits(character);

            // üéØ 5Îã®Í≥Ñ: ÎåÄÌôî Ïä§ÌÉÄÏùº Ï≤òÎ¶¨
            fillConversationStyle(character);

            // üéØ 6Îã®Í≥Ñ: ÌÅ¥Î¶≠Ìòï ÌïÑÎìúÎì§ Î≥µÏõê
            restoreClickableFields(character);

            console.log('‚úÖ Ìèº Îç∞Ïù¥ÌÑ∞ Ï±ÑÏö∞Í∏∞ ÏôÑÎ£å');
        }

        // üîÑ Î™®Îì† ÌÅ¥Î¶≠Ìòï ÌïÑÎìú Ï¥àÍ∏∞Ìôî Ìï®Ïàò
        function resetAllClickableFields() {
            console.log('üîÑ Î™®Îì† ÌÅ¥Î¶≠Ìòï ÌïÑÎìú Ï¥àÍ∏∞Ìôî ÏãúÏûë...');

            // Ï≤¥ÌÅ¨Î∞ïÏä§ Ï¥àÍ∏∞Ìôî
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => checkbox.checked = false);

            // ÌäπÏ†ï Ïù¥Î¶ÑÏùò Ï≤¥ÌÅ¨Î∞ïÏä§Îì§ Ï¥àÍ∏∞Ìôî
            document.querySelectorAll('input[name="charm_points"]').forEach(checkbox => checkbox.checked = false);
            document.querySelectorAll('input[name="hobbies"]').forEach(checkbox => checkbox.checked = false);
            document.querySelectorAll('input[name="personality"]').forEach(checkbox => checkbox.checked = false);

            // MBTI Î≤ÑÌäº Ï¥àÍ∏∞Ìôî
            document.querySelectorAll('.mbti-btn').forEach(btn => btn.classList.remove('selected'));

            // ÏÑ±Í≤© ÌäπÏÑ± Î≤ÑÌäº Ï¥àÍ∏∞Ìôî
            document.querySelectorAll('.trait-btn').forEach(btn => btn.classList.remove('selected'));

            // Í¥ÄÍ≥Ñ ÏÑ§Ï†ï Î≤ÑÌäº Ï¥àÍ∏∞Ìôî
            document.querySelectorAll('.relationship-btn').forEach(btn => btn.classList.remove('selected'));

            // Í∏∞ÌÉÄ ÏÑ†ÌÉù Î≤ÑÌäºÎì§ Ï¥àÍ∏∞Ìôî
            document.querySelectorAll('.btn.selected').forEach(btn => btn.classList.remove('selected'));

            console.log('‚úÖ Î™®Îì† ÌÅ¥Î¶≠Ìòï ÌïÑÎìú Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
        }

        // üéØ ÌÅ¥Î¶≠Ìòï ÌïÑÎìúÎì§ Î≥µÏõê Ìï®Ïàò
        function restoreClickableFields(character) {
            console.log('üéØ ÌÅ¥Î¶≠Ìòï ÌïÑÎìúÎì§ Î≥µÏõê ÏãúÏûë...');

            // 1. MBTI Î≤ÑÌäº Î≥µÏõê
            const mbti = character.basic_info?.mbti || character.mbti;
            if (mbti) {
                const mbtiBtn = document.querySelector(`.mbti-btn[data-mbti="${mbti}"]`);
                if (mbtiBtn) {
                    mbtiBtn.classList.add('selected');
                    document.getElementById('charMbti').value = mbti;
                    console.log('‚úÖ MBTI Î≤ÑÌäº ÏÑ†ÌÉù:', mbti);
                }
            }

            // 2. Í¥ÄÍ≥Ñ ÏÑ§Ï†ï Î≤ÑÌäº Î≥µÏõê
            const relationship = character.relationship;
            if (relationship) {
                const relBtn = document.querySelector(`.relationship-btn[data-rel="${relationship}"]`);
                if (relBtn) {
                    relBtn.classList.add('selected');
                    document.getElementById('charRelationship').value = relationship;
                    console.log('‚úÖ Í¥ÄÍ≥Ñ ÏÑ§Ï†ï Î≤ÑÌäº ÏÑ†ÌÉù:', relationship);
                }
            }

            // 3. ÏÑ±Í≤© ÌäπÏÑ± Î≤ÑÌäº Î≥µÏõê (Ïó¨Îü¨ Í∞ú ÏÑ†ÌÉù Í∞ÄÎä•)
            const personalityTraits = character.personality_traits ||
                                   character.psychological_traits?.personality ||
                                   character.appeal_profile?.personality_traits || [];

            if (Array.isArray(personalityTraits) && personalityTraits.length > 0) {
                personalityTraits.forEach(trait => {
                    const traitBtn = document.querySelector(`.trait-btn[data-trait="${trait}"]`);
                    if (traitBtn) {
                        traitBtn.classList.add('selected');
                        console.log('‚úÖ ÏÑ±Í≤© ÌäπÏÑ± Î≤ÑÌäº ÏÑ†ÌÉù:', trait);
                    }
                });
            }

            // 4. Ï≤¥ÌÅ¨Î∞ïÏä§ Î≥µÏõê (Îß§Î†• Ìè¨Ïù∏Ìä∏, Ï∑®ÎØ∏)
            const charmPoints = character.appeal_profile?.charm_points || [];
            if (Array.isArray(charmPoints)) {
                charmPoints.forEach(point => {
                    const checkbox = document.querySelector(`input[name="charm_points"][value="${point}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        console.log('‚úÖ Îß§Î†• Ìè¨Ïù∏Ìä∏ Ï≤¥ÌÅ¨Î∞ïÏä§ ÏÑ†ÌÉù:', point);
                    }
                });
            }

            const hobbies = character.hobbies || character.appeal_profile?.hobbies || [];
            if (Array.isArray(hobbies)) {
                hobbies.forEach(hobby => {
                    const checkbox = document.querySelector(`input[name="hobbies"][value="${hobby}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        console.log('‚úÖ Ï∑®ÎØ∏ Ï≤¥ÌÅ¨Î∞ïÏä§ ÏÑ†ÌÉù:', hobby);
                    }
                });
            }

            // 5. ÎØ∏ÎûòÏßÅÏóÖ Î≤ÑÌäº Î≥µÏõê (ÏµúÎåÄ 2Í∞ú ÏÑ†ÌÉù Í∞ÄÎä•)
            const futureCareers = character.future_goals?.future_careers || character.future_careers || [];
            if (Array.isArray(futureCareers) && futureCareers.length > 0) {
                futureCareers.forEach(career => {
                    const careerBtn = document.querySelector(`.career-btn[data-career="${career}"]`);
                    if (careerBtn) {
                        careerBtn.classList.add('selected');
                        console.log('‚úÖ ÎØ∏ÎûòÏßÅÏóÖ Î≤ÑÌäº ÏÑ†ÌÉù:', career);
                    } else {
                        console.warn('‚ö†Ô∏è ÎØ∏ÎûòÏßÅÏóÖ Î≤ÑÌäºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå:', career);
                    }
                });
                console.log('üéØ ÎØ∏ÎûòÏßÅÏóÖ Î≥µÏõê ÏôÑÎ£å - Ï¥ù', futureCareers.length, 'Í∞ú');
            } else {
                console.log('‚ÑπÔ∏è Î≥µÏõêÌï† ÎØ∏ÎûòÏßÅÏóÖ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå');
            }

            // üÜï 6. ÏûêÏã†ÏûàÎäî Î∂ÄÏúÑ Î≤ÑÌäº Î≥µÏõê (ÏµúÎåÄ 3Í∞ú ÏÑ†ÌÉù Í∞ÄÎä•)
            const featureElements = character.physical_allure?.feature_elements || character.feature_elements || [];
            if (Array.isArray(featureElements) && featureElements.length > 0) {
                featureElements.forEach(feature => {
                    const featureBtn = document.querySelector(`.feature-btn[data-feature="${feature}"]`);
                    if (featureBtn) {
                        featureBtn.classList.add('selected');
                        console.log('‚úÖ ÏûêÏã†ÏûàÎäî Î∂ÄÏúÑ Î≤ÑÌäº ÏÑ†ÌÉù:', feature);
                    } else {
                        console.warn('‚ö†Ô∏è ÏûêÏã†ÏûàÎäî Î∂ÄÏúÑ Î≤ÑÌäºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå:', feature);
                    }
                });
                console.log('üéØ ÏûêÏã†ÏûàÎäî Î∂ÄÏúÑ Î≥µÏõê ÏôÑÎ£å - Ï¥ù', featureElements.length, 'Í∞ú');
            } else {
                console.log('‚ÑπÔ∏è Î≥µÏõêÌï† ÏûêÏã†ÏûàÎäî Î∂ÄÏúÑ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå');
            }

            // üÜï 7. ÏÑπÏãúÌè¨Ï¶à Î≤ÑÌäº Î≥µÏõê (ÏµúÎåÄ 3Í∞ú ÏÑ†ÌÉù Í∞ÄÎä•)
            const sensualHabits = character.physical_allure?.sensual_habits || character.sensual_habits || [];
            if (Array.isArray(sensualHabits) && sensualHabits.length > 0) {
                sensualHabits.forEach(pose => {
                    const poseBtn = document.querySelector(`.pose-btn[data-pose="${pose}"]`);
                    if (poseBtn) {
                        poseBtn.classList.add('selected');
                        console.log('‚úÖ ÏÑπÏãúÌè¨Ï¶à Î≤ÑÌäº ÏÑ†ÌÉù:', pose);
                    } else {
                        console.warn('‚ö†Ô∏è ÏÑπÏãúÌè¨Ï¶à Î≤ÑÌäºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå:', pose);
                    }
                });
                console.log('üéØ ÏÑπÏãúÌè¨Ï¶à Î≥µÏõê ÏôÑÎ£å - Ï¥ù', sensualHabits.length, 'Í∞ú');
            } else {
                console.log('‚ÑπÔ∏è Î≥µÏõêÌï† ÏÑπÏãúÌè¨Ï¶à Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå');
            }

            console.log('‚úÖ ÌÅ¥Î¶≠Ìòï ÌïÑÎìúÎì§ Î≥µÏõê ÏôÑÎ£å');
        }

        // üéØ ÏÑ±Í≤© ÌäπÏÑ± Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Ï¥àÍ∏∞Ìôî
        function initializeTraitButtons() {
            console.log('üéØ ÏÑ±Í≤© ÌäπÏÑ± Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Ï¥àÍ∏∞Ìôî...');

            // ÏÑ±Í≤© ÌäπÏÑ± Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
            document.querySelectorAll('.trait-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const maxSelection = 3; // ÏµúÎåÄ 3Í∞ú ÏÑ†ÌÉù
                    const currentSelected = document.querySelectorAll('.trait-btn.selected').length;

                    if (this.classList.contains('selected')) {
                        // Ïù¥ÎØ∏ ÏÑ†ÌÉùÎêú Î≤ÑÌäºÏùÄ Ìï¥Ï†ú
                        this.classList.remove('selected');
                        console.log('‚ùå ÏÑ±Í≤© ÌäπÏÑ± Ìï¥Ï†ú:', this.getAttribute('data-trait'));
                    } else if (currentSelected < maxSelection) {
                        // ÏµúÎåÄ Í∞úÏàò ÎØ∏ÎßåÏù¥Î©¥ ÏÑ†ÌÉù
                        this.classList.add('selected');
                        console.log('‚úÖ ÏÑ±Í≤© ÌäπÏÑ± ÏÑ†ÌÉù:', this.getAttribute('data-trait'));
                    } else {
                        // ÏµúÎåÄ Í∞úÏàò Ï¥àÍ≥º Ïãú Í≤ΩÍ≥†
                        alert(`ÏÑ±Í≤© ÌäπÏÑ±ÏùÄ ÏµúÎåÄ ${maxSelection}Í∞úÍπåÏßÄÎßå ÏÑ†ÌÉùÌï† Ïàò ÏûàÏäµÎãàÎã§.`);
                    }
                });
            });

            console.log('‚úÖ ÏÑ±Í≤© ÌäπÏÑ± Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
        }

        // üîπ Í∏∞Î≥∏ Ï†ïÎ≥¥ Ï±ÑÏö∞Í∏∞ (ÏÉàÎ°úÏö¥ basic_info Ïä§ÌÇ§Îßà + Í∏∞Ï°¥ ÏßÅÏ†ë ÌïÑÎìú)
        function fillBasicInfo(character) {
            console.log('üìã Í∏∞Î≥∏ Ï†ïÎ≥¥ Ï≤òÎ¶¨ Ï§ë...');

            // Ïù¥Î¶Ñ Ï≤òÎ¶¨ (basic_info.name ÎòêÎäî ÏßÅÏ†ë name)
            const name = character.basic_info?.name || character.name;
            const charNameEl = document.getElementById('charName');
            if (name && charNameEl) {
                charNameEl.value = name;
                console.log('‚úÖ Ïù¥Î¶Ñ ÏÑ§Ï†ï:', name);
            }

            // ÎÇòÏù¥ Ï≤òÎ¶¨
            const age = character.basic_info?.age || character.age;
            const charAgeEl = document.getElementById('charAge');
            if (age && charAgeEl) {
                charAgeEl.value = age;
                console.log('‚úÖ ÎÇòÏù¥ ÏÑ§Ï†ï:', age);
            }

            // MBTI Ï≤òÎ¶¨
            const mbti = character.basic_info?.mbti || character.mbti;
            const charMbtiEl = document.getElementById('charMbti');
            if (mbti && charMbtiEl) {
                charMbtiEl.value = mbti;
                console.log('‚úÖ MBTI ÏÑ§Ï†ï:', mbti);
            }

            // ÏßÅÏóÖ Ï≤òÎ¶¨ (charOccupation ÌïÑÎìú ÏÇ¨Ïö©)
            const occupation = character.basic_info?.occupation || character.occupation || character.major;
            const charOccupationEl = document.getElementById('charOccupation');
            if (occupation && charOccupationEl) {
                charOccupationEl.value = occupation;
                console.log('‚úÖ ÏßÅÏóÖ ÏÑ§Ï†ï:', occupation);
            }

            // üÜï ÏÉàÎ°úÏö¥ Í∏∞Î≥∏ Ï†ïÎ≥¥ ÌïÑÎìúÎì§ Ï≤òÎ¶¨
            const education = character.basic_info?.education || character.education;
            const charEducationEl = document.getElementById('charEducation');
            if (education && charEducationEl) {
                charEducationEl.value = education;
                console.log('‚úÖ ÌïôÎ†• ÏÑ§Ï†ï:', education);
            }

            const location = character.basic_info?.location || character.location;
            const charLocationEl = document.getElementById('charLocation');
            if (location && charLocationEl) {
                charLocationEl.value = location;
                console.log('‚úÖ Í±∞Ï£ºÏßÄÏó≠ ÏÑ§Ï†ï:', location);
            }

            const hometown = character.basic_info?.hometown || character.hometown;
            const charHometownEl = document.getElementById('charHometown');
            if (hometown && charHometownEl) {
                charHometownEl.value = hometown;
                console.log('‚úÖ Ï∂úÏã†ÏßÄÏó≠ ÏÑ§Ï†ï:', hometown);
            }

            const familyStructure = character.basic_info?.family_structure || character.family_structure;
            const charFamilyStructureEl = document.getElementById('charFamilyStructure');
            if (familyStructure && charFamilyStructureEl) {
                charFamilyStructureEl.value = familyStructure;
                console.log('‚úÖ Í∞ÄÏ°±Íµ¨ÏÑ± ÏÑ§Ï†ï:', familyStructure);
            }

            const pets = character.basic_info?.pets || character.pets;
            const charPetsEl = document.getElementById('charPets');
            if (pets && charPetsEl) {
                charPetsEl.value = pets;
                console.log('‚úÖ Î∞òÎ†§ÎèôÎ¨º ÏÑ§Ï†ï:', pets);
            }

            const bloodtype = character.basic_info?.bloodtype || character.bloodtype;
            const charBloodtypeEl = document.getElementById('charBloodtype');
            if (bloodtype && charBloodtypeEl) {
                charBloodtypeEl.value = bloodtype;
                console.log('‚úÖ ÌòàÏï°Ìòï ÏÑ§Ï†ï:', bloodtype);
            }

            // Í¥ÄÍ≥Ñ Ï≤òÎ¶¨
            const relationship = character.relationship;
            const charRelationshipEl = document.getElementById('charRelationship');
            if (relationship && charRelationshipEl) {
                charRelationshipEl.value = relationship;
                console.log('‚úÖ Í¥ÄÍ≥Ñ ÏÑ§Ï†ï:', relationship);
            }

            // ÏÑ±Î≥Ñ Ï≤òÎ¶¨
            const gender = character.basic_info?.gender || character.gender;
            const charGenderEl = document.getElementById('charGender');
            if (gender && charGenderEl) {
                charGenderEl.value = gender;
                console.log('‚úÖ ÏÑ±Î≥Ñ ÏÑ§Ï†ï:', gender);
            }

            // Ï∫êÎ¶≠ÌÑ∞ ÌÉÄÏûÖ Ï≤òÎ¶¨
            const characterType = character.character_type;
            const charTypeEl = document.getElementById('charType');
            if (characterType && charTypeEl) {
                charTypeEl.value = characterType;
                console.log('‚úÖ Ï∫êÎ¶≠ÌÑ∞ ÌÉÄÏûÖ ÏÑ§Ï†ï:', characterType);
            }
        }

        // üîπ Îß§Î†• ÌîÑÎ°úÌïÑ Ï±ÑÏö∞Í∏∞
        function fillAppealProfile(character) {
            console.log('üí´ Îß§Î†• ÌîÑÎ°úÌïÑ Ï≤òÎ¶¨ Ï§ë...');

            // Ïú†Ìòπ Ïä§ÌÉÄÏùº
            const seductionStyle = character.appeal_profile?.seduction_style;
            const seductionSelect = document.getElementById('seductionStyle');
            if (seductionStyle && seductionSelect) {
                seductionSelect.value = seductionStyle;
                console.log('‚úÖ Ïú†Ìòπ Ïä§ÌÉÄÏùº ÏÑ§Ï†ï:', seductionStyle);
            }

            // Í∞êÏÑ± ÏßÄÎä•
            const emotionalIntelligence = character.appeal_profile?.emotional_intelligence;
            const eiSlider = document.getElementById('emotionalIntelligence');
            if (emotionalIntelligence && eiSlider) {
                eiSlider.value = emotionalIntelligence;
                const eiValue = document.getElementById('eiValue');
                if (eiValue) eiValue.textContent = emotionalIntelligence;
                console.log('‚úÖ Í∞êÏÑ± ÏßÄÎä• ÏÑ§Ï†ï:', emotionalIntelligence);
            }

            // ÏûêÏã†Í∞ê ÏàòÏ§Ä
            const confidenceLevel = character.appeal_profile?.confidence_level;
            const clSlider = document.getElementById('confidenceLevel');
            if (confidenceLevel && clSlider) {
                clSlider.value = confidenceLevel;
                const clValue = document.getElementById('clValue');
                if (clValue) clValue.textContent = confidenceLevel;
                console.log('‚úÖ ÏûêÏã†Í∞ê ÏàòÏ§Ä ÏÑ§Ï†ï:', confidenceLevel);
            }

            // Ïã†ÎπÑÎ°úÏõÄ
            const mysteryFactor = character.appeal_profile?.mystery_factor;
            const mfSlider = document.getElementById('mysteryFactor');
            if (mysteryFactor && mfSlider) {
                mfSlider.value = mysteryFactor;
                const mfValue = document.getElementById('mfValue');
                if (mfValue) mfValue.textContent = mysteryFactor;
                console.log('‚úÖ Ïã†ÎπÑÎ°úÏõÄ ÏÑ§Ï†ï:', mysteryFactor);
            }

            // Îß§Î†• Ìè¨Ïù∏Ìä∏ Ï≤òÎ¶¨
            const charmPoints = character.appeal_profile?.charm_points;
            if (charmPoints && Array.isArray(charmPoints)) {
                // Ï≤¥ÌÅ¨Î∞ïÏä§Îì§ Ï¥àÍ∏∞Ìôî
                const charmCheckboxes = document.querySelectorAll('input[name="charm_points"]');
                charmCheckboxes.forEach(checkbox => checkbox.checked = false);

                // Ìï¥ÎãπÌïòÎäî Ï≤¥ÌÅ¨Î∞ïÏä§Îì§ Ï≤¥ÌÅ¨
                charmPoints.forEach(point => {
                    const checkbox = document.querySelector(`input[name="charm_points"][value="${point}"]`);
                    if (checkbox) checkbox.checked = true;
                });
                console.log('‚úÖ Îß§Î†• Ìè¨Ïù∏Ìä∏ ÏÑ§Ï†ï:', charmPoints);
            }

            // v2.1+ Ï∂îÍ∞Ä ÌïÑÎìúÎì§
            // ÏÑ±Ï†Å Ìò∏Í∏∞Ïã¨
            const sexualCuriosity = character.appeal_profile?.sexual_curiosity;
            const scSlider = document.getElementById('sexualCuriosity');
            if (sexualCuriosity !== undefined && scSlider) {
                scSlider.value = sexualCuriosity;
                const scValue = document.getElementById('scValue');
                if (scValue) scValue.textContent = sexualCuriosity;
                console.log('‚úÖ ÏÑ±Ï†Å Ìò∏Í∏∞Ïã¨ ÏÑ§Ï†ï:', sexualCuriosity);
            }

            // ÏÑ±Ï†Å Ìé∏ÏïàÌï®
            const sexualComfort = character.appeal_profile?.sexual_comfort;
            const comfortSlider = document.getElementById('sexualComfort');
            if (sexualComfort !== undefined && comfortSlider) {
                comfortSlider.value = sexualComfort;
                const comfortValue = document.getElementById('comfortValue');
                if (comfortValue) comfortValue.textContent = sexualComfort;
                console.log('‚úÖ ÏÑ±Ï†Å Ìé∏ÏïàÌï® ÏÑ§Ï†ï:', sexualComfort);
            }
        }

        // üîπ Ïô∏Î™® Ï†ïÎ≥¥ Ï±ÑÏö∞Í∏∞
        function fillPhysicalAppearance(character) {
            console.log('üëÄ Ïô∏Î™® Ï†ïÎ≥¥ Ï≤òÎ¶¨ Ï§ë...');

            // ÏÉàÎ°úÏö¥ Ïä§ÌÇ§ÎßàÏùò physical_allure.appearance ÎòêÎäî Í∏∞Ï°¥ appearance
            const appearance = character.physical_allure?.appearance || character.appearance;

            if (appearance) {
                // Î®∏Î¶¨ Ïä§ÌÉÄÏùº
                const hair = appearance.hair;
                const charHairEl = document.getElementById('charHair');
                if (hair && charHairEl) {
                    charHairEl.value = hair;
                    console.log('‚úÖ Î®∏Î¶¨ Ïä§ÌÉÄÏùº ÏÑ§Ï†ï:', hair);
                }

                // Îàà ÌäπÏßï
                const eyes = appearance.eyes;
                const charEyesEl = document.getElementById('charEyes');
                if (eyes && charEyesEl) {
                    charEyesEl.value = eyes;
                    console.log('‚úÖ Îàà ÌäπÏßï ÏÑ§Ï†ï:', eyes);
                }

                // Ï≤¥Ìòï
                const body = appearance.body;
                const charBodyEl = document.getElementById('charBody');
                if (body && charBodyEl) {
                    charBodyEl.value = body;
                    console.log('‚úÖ Ï≤¥Ìòï ÏÑ§Ï†ï:', body);
                }

                // Í∞ÄÏä¥ - Í∏∞Ï°¥ Í∞íÏùÑ ÏÉà Ïªµ ÏÇ¨Ïù¥Ï¶àÎ°ú Î≥ÄÌôò
                const bust = appearance.bust;
                const charBustEl = document.getElementById('charBust');
                if (bust && charBustEl) {
                    // Í∏∞Ï°¥ Í∞íÏùÑ ÏÉà Ïªµ ÏÇ¨Ïù¥Ï¶àÎ°ú Î≥ÄÌôò
                    let newBustValue = bust;
                    const bustConversion = {
                        'small_cute': 'A',
                        'medium_natural': 'B',
                        'medium_balanced': 'B',
                        'large_attractive': 'C',
                        'full_attractive': 'C',
                        'voluptuous': 'D',
                        'glamorous': 'E'
                    };
                    if (bustConversion[bust]) {
                        newBustValue = bustConversion[bust];
                    }
                    charBustEl.value = newBustValue;
                    console.log('‚úÖ Í∞ÄÏä¥ ÏÑ§Ï†ï:', bust, '->', newBustValue);
                }

                // ÌóàÎ¶¨/ÏóâÎç©Ïù¥ - Í∏∞Ï°¥ Í∞íÏùÑ ÏÉà ÏßÅÍ¥ÄÏ†Å ÌëúÌòÑÏúºÎ°ú Î≥ÄÌôò
                const waistHip = appearance.waist_hip;
                const charWaistHipEl = document.getElementById('charWaistHip');
                if (waistHip && charWaistHipEl) {
                    // Í∏∞Ï°¥ Í∞íÏùÑ ÏÉà ÏßÅÍ¥ÄÏ†Å ÌëúÌòÑÏúºÎ°ú Î≥ÄÌôò
                    let newWaistHipValue = waistHip;
                    const waistHipConversion = {
                        'slim_tight': 'Ïä¨Î¶º',
                        'natural_curves': 'Í∑†Ìòï',
                        'soft_feminine': 'ÌíçÎßå',
                        'curvy_sexy': 'Í∏ÄÎûòÎ®∏',
                        'hourglass': 'Î™®ÎûòÏãúÍ≥Ñ',
                        'athletic': 'Ïö¥ÎèôÏ≤¥Ìòï',
                        'athletic_toned': 'Ïö¥ÎèôÏ≤¥Ìòï',
                        'balanced_healthy': 'Í∑†Ìòï'
                    };
                    if (waistHipConversion[waistHip]) {
                        newWaistHipValue = waistHipConversion[waistHip];
                    }
                    charWaistHipEl.value = newWaistHipValue;
                    console.log('‚úÖ ÌóàÎ¶¨/ÏóâÎç©Ïù¥ ÏÑ§Ï†ï:', waistHip, '->', newWaistHipValue);
                }

                // Ïä§ÌÉÄÏùº - Í∏∞Ï°¥ Í∞íÏùÑ ÏÉà Ìïú Îã®Ïñ¥ ÌëúÌòÑÏúºÎ°ú Î≥ÄÌôò
                const style = appearance.style;
                const charStyleEl = document.getElementById('charStyle');
                if (style && charStyleEl) {
                    // Í∏∞Ï°¥ Í∞íÏùÑ ÏÉà Ìïú Îã®Ïñ¥ ÌëúÌòÑÏúºÎ°ú Î≥ÄÌôò
                    let newStyleValue = style;
                    const styleConversion = {
                        'cute_casual': 'ÌÅêÌä∏',
                        'sexy_chic': 'ÏÑπÏãú',
                        'innocent_style': 'ÌÅêÌä∏',
                        'elegant_fashion': 'Ïö∞ÏïÑ',
                        'seductive_elegant': 'Ïö∞ÏïÑ',
                        'provocative_fashion': 'ÎèÑÎ∞úÏ†Å',
                        'casual_alluring': 'Ï∫êÏ£ºÏñº',
                        'sporty_style': 'Ï∫êÏ£ºÏñº',
                        'mature_sophisticated': 'ÌÅ¥ÎûòÏãù'
                    };
                    if (styleConversion[style]) {
                        newStyleValue = styleConversion[style];
                    }
                    charStyleEl.value = newStyleValue;
                    console.log('‚úÖ Ïä§ÌÉÄÏùº ÏÑ§Ï†ï:', style, '->', newStyleValue);
                }
            }
        }

        // üîπ Ïã¨Î¶¨Ï†Å ÌäπÏÑ± Ï±ÑÏö∞Í∏∞
        function fillPsychologicalTraits(character) {
            console.log('üß† Ïã¨Î¶¨Ï†Å ÌäπÏÑ± Ï≤òÎ¶¨ Ï§ë...');

            const psychological = character.psychological_depth;
            if (psychological) {
                // Í≤ΩÍ≥ÑÏÑ† ÏÑ§Ï†ï
                const boundaries = psychological.boundaries;
                if (boundaries) {
                    // Ìé∏ÏïàÌï® ÏàòÏ§Ä
                    const comfortLevel = boundaries.comfort_level;
                    const comfortSelect = document.getElementById('comfortLevel');
                    if (comfortLevel && comfortSelect) {
                        comfortSelect.value = comfortLevel;
                        console.log('‚úÖ Ìé∏ÏïàÌï® ÏàòÏ§Ä ÏÑ§Ï†ï:', comfortLevel);
                    }

                    // Í¥ÄÍ≥Ñ Î∞úÏ†Ñ ÏÜçÎèÑ
                    const escalationPace = boundaries.escalation_pace;
                    const paceSelect = document.getElementById('escalationPace');
                    if (escalationPace && paceSelect) {
                        paceSelect.value = escalationPace;
                        console.log('‚úÖ Í¥ÄÍ≥Ñ Î∞úÏ†Ñ ÏÜçÎèÑ ÏÑ§Ï†ï:', escalationPace);
                    }

                    // ÏÑ±Ï†Å ÏûêÏú†ÎèÑ
                    const sexualFreedom = psychological.sexual_freedom;
                    const freedomSlider = document.getElementById('sexualFreedom');
                    if (sexualFreedom !== undefined && freedomSlider) {
                        freedomSlider.value = sexualFreedom;
                        const freedomValue = document.getElementById('freedomValue');
                        if (freedomValue) freedomValue.textContent = sexualFreedom;
                        console.log('‚úÖ ÏÑ±Ï†Å ÏûêÏú†ÎèÑ ÏÑ§Ï†ï:', sexualFreedom);
                    }
                }
            }
        }

        // üîπ ÎåÄÌôî Ïä§ÌÉÄÏùº Ï±ÑÏö∞Í∏∞
        function fillConversationStyle(character) {
            console.log('üí¨ ÎåÄÌôî Ïä§ÌÉÄÏùº Ï≤òÎ¶¨ Ï§ë...');

            // ÏÉàÎ°úÏö¥ Ïä§ÌÇ§ÎßàÏùò conversation_dynamics.speech_style ÎòêÎäî Í∏∞Ï°¥ speech_style
            const speechStyle = character.conversation_dynamics?.speech_style || character.speech_style;
            const speechInput = document.getElementById('charSpeechStyle');
            if (speechStyle && speechInput) {
                speechInput.value = speechStyle;
                console.log('‚úÖ ÎßêÌà¨ Ïä§ÌÉÄÏùº ÏÑ§Ï†ï:', speechStyle);
            }

            // ÎßêÌà¨ ÏäµÍ¥Ä Ï≤òÎ¶¨
            const speechHabit = character.speech_habit;
            const speechHabitInput = document.getElementById('charSpeechHabit');
            if (speechHabit && speechHabitInput) {
                speechHabitInput.value = speechHabit;
                console.log('‚úÖ ÎßêÌà¨ ÏäµÍ¥Ä ÏÑ§Ï†ï:', speechHabit);
            }

            // Í∞ÄÏπòÍ¥Ä Ï≤òÎ¶¨
            const values = character.psychological_depth?.values || character.values;
            const valuesSelect = document.getElementById('charValues');
            if (values && valuesSelect) {
                valuesSelect.value = values;
                console.log('‚úÖ Í∞ÄÏπòÍ¥Ä ÏÑ§Ï†ï:', values);
            }
        }

        // Ïù∏Î¨º ÏÜåÍ∞ú Î™®Îã¨ ÌëúÏãú
        function showCharacterProfileModal(profile) {
            console.log('üìù Ïù∏Î¨º ÏÜåÍ∞ú Î™®Îã¨ ÌëúÏãú:', profile);

            // Î™®Îã¨ HTMLÏù¥ ÏóÜÏúºÎ©¥ ÏÉùÏÑ±
            let modal = document.getElementById('characterProfileModal');
            if (!modal) {
                modal = createCharacterProfileModal();
                document.body.appendChild(modal);
            }

            // ÎÇ¥Ïö© Ï±ÑÏö∞Í∏∞
            document.getElementById('profileCharacterName').textContent = profile.character_name;
            document.getElementById('profileText').textContent = profile.profile_text;

            // ÌîÑÎ°¨ÌîÑÌä∏ ÏÇ¨Ïö© Í∞ÄÏù¥Îìú
            document.getElementById('scenarioPrompt').textContent = profile.usage_guide.scenario_prompt;
            document.getElementById('dialoguePrompt').textContent = profile.usage_guide.dialogue_prompt;

            // Î™®Îã¨ ÌëúÏãú
            modal.style.display = 'block';
        }

        // Ïù∏Î¨º ÏÜåÍ∞ú Î™®Îã¨ HTML ÏÉùÏÑ±
        function createCharacterProfileModal() {
            const modalHTML = `
                <div id="characterProfileModal" class="modal">
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="modal-header">
                            <span class="close" onclick="closeModal('characterProfileModal')">&times;</span>
                            <h2>üìù <span id="profileCharacterName">Ï∫êÎ¶≠ÌÑ∞</span> Ïù∏Î¨º ÏÜåÍ∞ú</h2>
                        </div>
                        <div class="modal-body">
                            <div class="profile-section">
                                <h3>üé≠ Ï∫êÎ¶≠ÌÑ∞ ÌîÑÎ°úÌïÑ</h3>
                                <div class="profile-content">
                                    <pre id="profileText" style="white-space: pre-wrap; line-height: 1.6; font-family: inherit;"></pre>
                                </div>
                            </div>

                            <div class="profile-section">
                                <h3>üéÆ ÌîÑÎ°¨ÌîÑÌä∏ ÌôúÏö© Í∞ÄÏù¥Îìú</h3>
                                <div class="prompt-tabs">
                                    <button class="prompt-tab active" onclick="showPromptTab('scenario')">ÏãúÎÇòÎ¶¨Ïò§ Ï†úÏûëÏö©</button>
                                    <button class="prompt-tab" onclick="showPromptTab('dialogue')">ÎåÄÌôî ÏÉùÏÑ±Ïö©</button>
                                </div>

                                <div id="scenarioPromptTab" class="prompt-tab-content active">
                                    <h4>üìñ ÏãúÎÇòÎ¶¨Ïò§ Ï†úÏûë Ïãú ÏÇ¨Ïö©Ìï† ÌîÑÎ°¨ÌîÑÌä∏:</h4>
                                    <textarea id="scenarioPrompt" readonly style="width: 100%; height: 120px; font-size: 14px;"></textarea>
                                    <button class="btn btn-info" onclick="copyToClipboard('scenarioPrompt')">üìã Î≥µÏÇ¨</button>
                                </div>

                                <div id="dialoguePromptTab" class="prompt-tab-content">
                                    <h4>üí¨ ÎåÄÌôî ÏÉùÏÑ± Ïãú ÏÇ¨Ïö©Ìï† ÌîÑÎ°¨ÌîÑÌä∏:</h4>
                                    <textarea id="dialoguePrompt" readonly style="width: 100%; height: 120px; font-size: 14px;"></textarea>
                                    <button class="btn btn-info" onclick="copyToClipboard('dialoguePrompt')">üìã Î≥µÏÇ¨</button>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('characterProfileModal')">Îã´Í∏∞</button>
                        </div>
                    </div>
                </div>

                <style>
                .profile-section {
                    margin-bottom: 30px;
                }

                .profile-content {
                    background: #f8f9fa;
                    border: 1px solid #e9ecef;
                    border-radius: 8px;
                    padding: 20px;
                    max-height: 400px;
                    overflow-y: auto;
                }

                .prompt-tabs {
                    display: flex;
                    margin-bottom: 15px;
                }

                .prompt-tab {
                    padding: 10px 20px;
                    border: 1px solid #ddd;
                    background: #f8f9fa;
                    cursor: pointer;
                    border-radius: 5px 5px 0 0;
                }

                .prompt-tab.active {
                    background: #007bff;
                    color: white;
                }

                .prompt-tab-content {
                    display: none;
                    padding: 15px;
                    border: 1px solid #ddd;
                    border-radius: 0 5px 5px 5px;
                }

                .prompt-tab-content.active {
                    display: block;
                }
                </style>
            `;

            const div = document.createElement('div');
            div.innerHTML = modalHTML;
            return div.firstElementChild;
        }

        // ÌîÑÎ°¨ÌîÑÌä∏ ÌÉ≠ Ï†ÑÌôò
        function showPromptTab(tabName) {
            // Î™®Îì† ÌÉ≠ ÎπÑÌôúÏÑ±Ìôî
            document.querySelectorAll('.prompt-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.prompt-tab-content').forEach(content => content.classList.remove('active'));

            // ÏÑ†ÌÉùÎêú ÌÉ≠ ÌôúÏÑ±Ìôî
            event.target.classList.add('active');
            document.getElementById(tabName + 'PromptTab').classList.add('active');
        }

        // ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            element.select();
            document.execCommand('copy');

            // Î≤ÑÌäº ÌÖçÏä§Ìä∏ ÏûÑÏãú Î≥ÄÍ≤Ω
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '‚úÖ Î≥µÏÇ¨Îê®!';
            setTimeout(() => {
                button.textContent = originalText;
            }, 2000);
        }

        // Ï†ÑÏó≠ Ìï®Ïàò Îì±Î°ù
        window.autoCompleteCharacter = autoCompleteCharacter;
        window.generateCharacterProfile = generateCharacterProfile;
        window.showPromptTab = showPromptTab;
        window.copyToClipboard = copyToClipboard;

        // ‚ö° Í∞úÎ∞úÏûê Î™®Îìú Îπ†Î•∏ Ï†ëÏÜç ÏãúÏä§ÌÖú (ÏÉàÎ°ú Ï∂îÍ∞Ä)
        function initializeDeveloperMode() {
            const urlParams = new URLSearchParams(window.location.search);
            const devMode = urlParams.get('dev');
            const savedDevMode = localStorage.getItem('chatgame_dev_mode');

            // URL ÌååÎùºÎØ∏ÌÑ∞Î°ú Í∞úÎ∞úÏûê Î™®Îìú ÌôúÏÑ±Ìôî
            if (devMode === 'true') {
                localStorage.setItem('chatgame_dev_mode', 'true');
                enableDeveloperMode();
                console.log('üîß Í∞úÎ∞úÏûê Î™®Îìú ÌôúÏÑ±ÌôîÎê® (URL ÌååÎùºÎØ∏ÌÑ∞)');
            }
            // Ï†ÄÏû•Îêú Í∞úÎ∞úÏûê Î™®Îìú ÏÉÅÌÉú ÌôïÏù∏
            else if (savedDevMode === 'true') {
                enableDeveloperMode();
                console.log('üîß Í∞úÎ∞úÏûê Î™®Îìú ÌôúÏÑ±ÌôîÎê® (Ï†ÄÏû•Îêú ÏÑ§Ï†ï)');
            }
        }

        function enableDeveloperMode() {
            // Í∞úÎ∞úÏûê Î™®Îìú ÌëúÏãú
            addDeveloperModeIndicator();

            // Îπ†Î•∏ Ïï°ÏÖò Ìå®ÎÑê Ï∂îÍ∞Ä
            addQuickActionPanel();

            // ÏΩòÏÜîÏóê Í∞úÎ∞úÏûê Ï†ïÎ≥¥ ÌëúÏãú
            showDeveloperInfo();
        }

        function addDeveloperModeIndicator() {
            // ÌéòÏù¥ÏßÄ ÏÉÅÎã®Ïóê Í∞úÎ∞úÏûê Î™®Îìú ÌëúÏãú
            const indicator = document.createElement('div');
            indicator.id = 'devModeIndicator';
            indicator.innerHTML = `
                <div style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    background: linear-gradient(45deg, #ff6b6b, #feca57);
                    color: white;
                    text-align: center;
                    padding: 5px;
                    font-weight: bold;
                    z-index: 10000;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                ">
                    ‚ö° Í∞úÎ∞úÏûê Î™®Îìú ÌôúÏÑ±Ìôî ‚ö°
                    <button onclick="disableDeveloperMode()" style="
                        background: rgba(255,255,255,0.2);
                        border: none;
                        color: white;
                        padding: 2px 8px;
                        margin-left: 10px;
                        border-radius: 3px;
                        cursor: pointer;
                    ">ÎπÑÌôúÏÑ±Ìôî</button>
                </div>
            `;

            document.body.appendChild(indicator);

            // ÌéòÏù¥ÏßÄ Ïª®ÌÖêÏ∏†Î•º ÏïÑÎûòÎ°ú Î∞ÄÏñ¥ÎÉÑ
            document.body.style.paddingTop = '35px';
        }

        function addQuickActionPanel() {
            // Îπ†Î•∏ Ïï°ÏÖò ÌîåÎ°úÌåÖ Ìå®ÎÑê Ï∂îÍ∞Ä
            const panel = document.createElement('div');
            panel.id = 'quickActionPanel';
            panel.innerHTML = `
                <div style="
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    background: #2c3e50;
                    color: white;
                    padding: 15px;
                    border-radius: 10px;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                    z-index: 9999;
                    min-width: 200px;
                ">
                    <h4 style="margin: 0 0 10px 0; color: #ecf0f1;">‚ö° Îπ†Î•∏ Ïï°ÏÖò</h4>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <button onclick="quickCreateTestCharacter()" class="dev-quick-btn">
                            üé≠ ÌÖåÏä§Ìä∏ Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±
                        </button>
                        <button onclick="quickCreateTestScenario()" class="dev-quick-btn">
                            üìñ ÌÖåÏä§Ìä∏ ÏãúÎÇòÎ¶¨Ïò§ ÏÉùÏÑ±
                        </button>
                        <button onclick="toggleQuickPanel()" class="dev-quick-btn">
                            üìå Ìå®ÎÑê Ïà®Í∏∞Í∏∞
                        </button>
                    </div>
                </div>

                <style>
                .dev-quick-btn {
                    background: #3498db;
                    color: white;
                    border: none;
                    padding: 8px 12px;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 14px;
                    transition: background 0.3s;
                }

                .dev-quick-btn:hover {
                    background: #2980b9;
                }

                .dev-danger {
                    background: #e74c3c !important;
                }

                .dev-danger:hover {
                    background: #c0392b !important;
                }
                </style>
            `;

            document.body.appendChild(panel);
        }

        function showDeveloperInfo() {
            console.log(`
üîß === Í∞úÎ∞úÏûê Î™®Îìú ÌôúÏÑ±Ìôî ===
üìù Îπ†Î•∏ Î™ÖÎ†πÏñ¥:
- quickCreateTestCharacter() : ÌÖåÏä§Ìä∏ Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±
- quickCreateTestScenario() : ÌÖåÏä§Ìä∏ ÏãúÎÇòÎ¶¨Ïò§ ÏÉùÏÑ±
- disableDeveloperMode() : Í∞úÎ∞úÏûê Î™®Îìú ÎπÑÌôúÏÑ±Ìôî

üéØ URL Ï†ëÏÜç:
- ${window.location.origin}/scenario-admin.html?dev=true

‚ö° Îπ†Î•∏ Ïï°ÏÖò Ìå®ÎÑêÏù¥ Ïö∞ÌïòÎã®Ïóê Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.
            `);
        }

        // Í∞úÎ∞úÏûê Î™®Îìú ÎπÑÌôúÏÑ±Ìôî
        function disableDeveloperMode() {
            localStorage.removeItem('chatgame_dev_mode');

            // Í∞úÎ∞úÏûê Î™®Îìú ÏöîÏÜåÎì§ Ï†úÍ±∞
            const indicator = document.getElementById('devModeIndicator');
            const panel = document.getElementById('quickActionPanel');

            if (indicator) indicator.remove();
            if (panel) panel.remove();

            // ÌéòÏù¥ÏßÄ Ìå®Îî© Î≥µÏõê
            document.body.style.paddingTop = '';

            console.log('üîß Í∞úÎ∞úÏûê Î™®ÎìúÍ∞Ä ÎπÑÌôúÏÑ±ÌôîÎêòÏóàÏäµÎãàÎã§.');
            alert('üîß Í∞úÎ∞úÏûê Î™®ÎìúÍ∞Ä ÎπÑÌôúÏÑ±ÌôîÎêòÏóàÏäµÎãàÎã§.\nÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï©ÎãàÎã§.');

            // URLÏóêÏÑú dev ÌååÎùºÎØ∏ÌÑ∞ Ï†úÍ±∞ÌïòÍ≥† ÏÉàÎ°úÍ≥†Ïπ®
            const url = new URL(window.location);
            url.searchParams.delete('dev');
            window.location.href = url.toString();
        }

        // Îπ†Î•∏ Ïï°ÏÖò Ìï®ÏàòÎì§
        async function quickCreateTestCharacter() {
            console.log('üé≠ ÌÖåÏä§Ìä∏ Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ± Ï§ë...');

            try {
                const testCharacterData = {
                    basic_info: {
                        name: `ÌÖåÏä§Ìä∏${Date.now().toString().slice(-4)}`,
                        age: 23,
                        mbti: 'ENFP',
                        occupation: 'ÎåÄÌïôÏÉù',
                        gender: 'female'
                    }
                };

                const response = await fetch('/api/character-ai-generator', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'auto_complete_character',
                        ...testCharacterData
                    })
                });

                const result = await response.json();

                if (result.success) {
                    console.log('‚úÖ ÌÖåÏä§Ìä∏ Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ± ÏôÑÎ£å:', result.character.basic_info.name);

                    // Ï∫êÎ¶≠ÌÑ∞ ÌÉ≠ÏúºÎ°ú Ïù¥ÎèôÌïòÍ≥† ÌèºÏóê Ï±ÑÏö∞Í∏∞
                    showTab('characters');
                    openCharacterModal();
                    setTimeout(() => {
                        fillCharacterForm(result.character);
                    }, 500);

                    alert(`‚úÖ ÌÖåÏä§Ìä∏ Ï∫êÎ¶≠ÌÑ∞ "${result.character.basic_info.name}" ÏÉùÏÑ± ÏôÑÎ£å!\nÏ∫êÎ¶≠ÌÑ∞ ÌèºÏóê ÏûêÎèôÏúºÎ°ú Ï±ÑÏõåÏ°åÏäµÎãàÎã§.`);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('‚ùå ÌÖåÏä§Ìä∏ Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ± Ïã§Ìå®:', error);
                alert(`‚ùå ÌÖåÏä§Ìä∏ Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ± Ïã§Ìå®:\n${error.message}`);
            }
        }

        async function quickCreateTestScenario() {
            console.log('üìñ ÌÖåÏä§Ìä∏ ÏãúÎÇòÎ¶¨Ïò§ ÏÉùÏÑ± Ï§ë...');

            try {
                // ÏãúÎÇòÎ¶¨Ïò§ ÌÉ≠ÏúºÎ°ú Ïù¥Îèô
                showTab('scenarios');

                // ÏÉà ÏãúÎÇòÎ¶¨Ïò§ Î™®Îã¨ Ïó¥Í∏∞
                openScenarioModal();

                // ÌÖåÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ Ï±ÑÏö∞Í∏∞
                setTimeout(() => {
                    document.getElementById('scenarioTitle').value = `ÌÖåÏä§Ìä∏ ÏãúÎÇòÎ¶¨Ïò§ ${Date.now().toString().slice(-4)}`;
                    document.getElementById('scenarioDescription').value = 'Í∞úÎ∞úÏûê Î™®ÎìúÏóêÏÑú ÏÉùÏÑ±Îêú ÌÖåÏä§Ìä∏ ÏãúÎÇòÎ¶¨Ïò§ÏûÖÎãàÎã§.';
                    document.getElementById('scenarioSetting').value = 'ÌÖåÏä§Ìä∏ ÌôòÍ≤Ω';

                    console.log('‚úÖ ÌÖåÏä§Ìä∏ ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ Ï±ÑÏõÄ ÏôÑÎ£å');
                    alert('‚úÖ ÌÖåÏä§Ìä∏ ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞Í∞Ä Ï±ÑÏõåÏ°åÏäµÎãàÎã§!\n"ÏãúÎÇòÎ¶¨Ïò§ Ï†ÄÏû•" Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî.');
                }, 500);

            } catch (error) {
                console.error('‚ùå ÌÖåÏä§Ìä∏ ÏãúÎÇòÎ¶¨Ïò§ ÏÉùÏÑ± Ïã§Ìå®:', error);
                alert(`‚ùå ÌÖåÏä§Ìä∏ ÏãúÎÇòÎ¶¨Ïò§ ÏÉùÏÑ± Ïã§Ìå®:\n${error.message}`);
            }
        }


        function toggleQuickPanel() {
            const panel = document.getElementById('quickActionPanel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
        }

        // Ï†ÑÏó≠ Ìï®Ïàò Îì±Î°ù
        window.disableDeveloperMode = disableDeveloperMode;
        window.quickCreateTestCharacter = quickCreateTestCharacter;
        window.quickCreateTestScenario = quickCreateTestScenario;
        window.toggleQuickPanel = toggleQuickPanel;

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Í∞úÎ∞úÏûê Î™®Îìú Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', initializeDeveloperMode);

        // üé≤ ÎûúÎç§ ÏÑ†ÌÉù Ìï®ÏàòÎì§ (Í∏∞Ï°¥ ÏòµÏÖòÏóêÏÑú Î¨¥ÏûëÏúÑ ÏÑ†ÌÉù)
        function randomizeName() {
            const names = ['ÏàòÏßÑ', 'ÎØ∏Ìôî', 'ÏòàÎ¶∞', 'ÎÇòÏó∞', 'ÏßÄÏùÄ', 'ÏÜåÏòÅ', 'ÌòúÏßÑ', 'Ïú†Î¶¨', 'Îã§ÏùÄ', 'ÎØºÏßÄ'];
            document.getElementById('charName').value = names[Math.floor(Math.random() * names.length)];
        }

        function randomizeAge() {
            const age = Math.floor(Math.random() * 21) + 20; // 20-40
            document.getElementById('charAge').value = age;
        }

        function randomizeOccupation() {
            const occupationElement = document.getElementById('charOccupation');
            if (!occupationElement) {
                console.error('‚ùå charOccupation ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§!');
                return;
            }
            const options = Array.from(occupationElement.options);
            if (options.length === 0) {
                console.error('‚ùå ÏßÅÏóÖ ÏòµÏÖòÏù¥ ÏóÜÏäµÎãàÎã§!');
                return;
            }
            const randomIndex = Math.floor(Math.random() * options.length);
            occupationElement.selectedIndex = randomIndex;
            console.log('‚úÖ ÏßÅÏóÖ ÎûúÎç§ ÏÑ†ÌÉù:', options[randomIndex].text, '(index:', randomIndex, ')');
        }

        function randomizeEducation() {
            const educationElement = document.getElementById('charEducation');
            if (!educationElement) {
                console.error('‚ùå charEducation ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§!');
                return;
            }
            const options = Array.from(educationElement.options);
            if (options.length === 0) {
                console.error('‚ùå ÌïôÎ†• ÏòµÏÖòÏù¥ ÏóÜÏäµÎãàÎã§!');
                return;
            }
            const randomIndex = Math.floor(Math.random() * options.length);
            educationElement.selectedIndex = randomIndex;
            console.log('‚úÖ ÌïôÎ†• ÎûúÎç§ ÏÑ†ÌÉù:', options[randomIndex].text, '(index:', randomIndex, ')');
        }

        function randomizeLocation() {
            const locationElement = document.getElementById('charLocation');
            if (!locationElement) {
                console.error('‚ùå charLocation ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§!');
                return;
            }
            const options = Array.from(locationElement.options);
            if (options.length === 0) {
                console.error('‚ùå Í±∞Ï£ºÏßÄÏó≠ ÏòµÏÖòÏù¥ ÏóÜÏäµÎãàÎã§!');
                return;
            }
            const randomIndex = Math.floor(Math.random() * options.length);
            locationElement.selectedIndex = randomIndex;
            console.log('‚úÖ Í±∞Ï£ºÏßÄÏó≠ ÎûúÎç§ ÏÑ†ÌÉù:', options[randomIndex].text, '(index:', randomIndex, ')');
        }

        function randomizeHometown() {
            const hometownElement = document.getElementById('charHometown');
            if (!hometownElement) {
                console.error('‚ùå charHometown ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§!');
                return;
            }
            const options = Array.from(hometownElement.options);
            if (options.length === 0) {
                console.error('‚ùå Ï∂úÏã†ÏßÄÏó≠ ÏòµÏÖòÏù¥ ÏóÜÏäµÎãàÎã§!');
                return;
            }
            const randomIndex = Math.floor(Math.random() * options.length);
            hometownElement.selectedIndex = randomIndex;
            console.log('‚úÖ Ï∂úÏã†ÏßÄÏó≠ ÎûúÎç§ ÏÑ†ÌÉù:', options[randomIndex].text, '(index:', randomIndex, ')');
        }

        function randomizeFamilyStructure() {
            const familyElement = document.getElementById('charFamilyStructure');
            if (!familyElement) {
                console.error('‚ùå charFamilyStructure ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§!');
                return;
            }
            const options = Array.from(familyElement.options);
            if (options.length === 0) {
                console.error('‚ùå Í∞ÄÏ°±Íµ¨ÏÑ± ÏòµÏÖòÏù¥ ÏóÜÏäµÎãàÎã§!');
                return;
            }
            const randomIndex = Math.floor(Math.random() * options.length);
            familyElement.selectedIndex = randomIndex;
            console.log('‚úÖ Í∞ÄÏ°±Íµ¨ÏÑ± ÎûúÎç§ ÏÑ†ÌÉù:', options[randomIndex].text, '(index:', randomIndex, ')');
        }

        function randomizePets() {
            const petsElement = document.getElementById('charPets');
            if (!petsElement) {
                console.error('‚ùå charPets ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§!');
                return;
            }
            const options = Array.from(petsElement.options);
            if (options.length === 0) {
                console.error('‚ùå Î∞òÎ†§ÎèôÎ¨º ÏòµÏÖòÏù¥ ÏóÜÏäµÎãàÎã§!');
                return;
            }
            const randomIndex = Math.floor(Math.random() * options.length);
            petsElement.selectedIndex = randomIndex;
            console.log('‚úÖ Î∞òÎ†§ÎèôÎ¨º ÎûúÎç§ ÏÑ†ÌÉù:', options[randomIndex].text, '(index:', randomIndex, ')');
        }

        function randomizeBloodType() {
            const bloodTypeElement = document.getElementById('charBloodtype');
            if (!bloodTypeElement) {
                console.error('‚ùå charBloodType ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§!');
                return;
            }
            const options = Array.from(bloodTypeElement.options);
            if (options.length === 0) {
                console.error('‚ùå ÌòàÏï°Ìòï ÏòµÏÖòÏù¥ ÏóÜÏäµÎãàÎã§!');
                return;
            }
            const randomIndex = Math.floor(Math.random() * options.length);
            bloodTypeElement.selectedIndex = randomIndex;
            console.log('‚úÖ ÌòàÏï°Ìòï ÎûúÎç§ ÏÑ†ÌÉù:', options[randomIndex].text, '(index:', randomIndex, ')');
        }


        function randomizeSeduction() {
            const select = document.getElementById('seductionStyle');
            const options = select.options;
            const randomIndex = Math.floor(Math.random() * options.length);
            select.selectedIndex = randomIndex;
        }

        function randomizeMbti() {
            const mbtiOptions = ['ENFP', 'INFP', 'ENFJ', 'INFJ', 'ENTP', 'INTP', 'ENTJ', 'INTJ', 'ESFP', 'ISFP', 'ESFJ', 'ISFJ', 'ESTP', 'ISTP', 'ESTJ', 'ISTJ'];
            const randomMbti = mbtiOptions[Math.floor(Math.random() * mbtiOptions.length)];
            console.log('üß† MBTI ÎûúÎç§ ÏÑ†ÌÉù:', randomMbti);
            document.querySelectorAll('.mbti-btn').forEach(btn => btn.classList.remove('selected'));
            const mbtiBtn = document.querySelector(`[data-mbti="${randomMbti}"]`);
            if (mbtiBtn) {
                mbtiBtn.classList.add('selected');
                document.getElementById('charMbti').value = randomMbti;
                console.log('‚úÖ MBTI Î≤ÑÌäº ÏÑ†ÌÉùÎê®:', randomMbti);
            } else {
                console.log('‚ùå MBTI Î≤ÑÌäºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå:', randomMbti);
            }
        }

        function randomizeTraits() {
            const traitBtns = document.querySelectorAll('.trait-btn');
            // Î™®Îì† ÏÑ†ÌÉù Ìï¥Ï†ú
            traitBtns.forEach(btn => btn.classList.remove('selected'));

            // ÎûúÎç§ÏúºÎ°ú 2-3Í∞ú ÏÑ†ÌÉù (Í∏∞Ï°¥ 1-3Í∞úÏóêÏÑú 2-3Í∞úÎ°ú Î≥ÄÍ≤Ω)
            const numTraits = Math.floor(Math.random() * 2) + 2; // 2~3Í∞ú
            const availableTraits = Array.from(traitBtns);

            for (let i = 0; i < numTraits; i++) {
                if (availableTraits.length === 0) break;

                const randomIndex = Math.floor(Math.random() * availableTraits.length);
                const selectedBtn = availableTraits[randomIndex];
                selectedBtn.classList.add('selected');

                // ÏÑ†ÌÉùÎêú Î≤ÑÌäºÏùÄ Î™©Î°ùÏóêÏÑú Ï†úÍ±∞
                availableTraits.splice(randomIndex, 1);
            }

            console.log('‚úÖ ÏÑ±Í≤©ÌäπÏÑ± ÎûúÎç§ ÏÑ†ÌÉù:', numTraits + 'Í∞ú ÌäπÏÑ± ÏÑ†ÌÉùÎê®');

            // üîÑ Hidden input ÏóÖÎç∞Ïù¥Ìä∏ Ï∂îÍ∞Ä
            updatePersonalityTraitsHiddenInput();
        }


        function randomizeCharms() {
            const charmBtns = document.querySelectorAll('.charm-btn');
            // Î™®Îì† ÏÑ†ÌÉù Ìï¥Ï†ú
            charmBtns.forEach(btn => btn.classList.remove('selected'));

            // ÎûúÎç§ÌïòÍ≤å 3Í∞ú ÏÑ†ÌÉù
            const indices = [];
            while (indices.length < 3) {
                const randomIndex = Math.floor(Math.random() * charmBtns.length);
                if (!indices.includes(randomIndex)) {
                    indices.push(randomIndex);
                    charmBtns[randomIndex].classList.add('selected');
                }
            }
        }

        function randomizeEI() {
            const value = Math.floor(Math.random() * 10) + 1;
            document.getElementById('emotionalIntelligence').value = value;
            document.getElementById('eiValue').textContent = value;
        }

        function randomizeConfidence() {
            const value = Math.floor(Math.random() * 10) + 1;
            document.getElementById('confidenceLevel').value = value;
            document.getElementById('confidenceValue').textContent = value;
        }

        function randomizeMystery() {
            const value = Math.floor(Math.random() * 10) + 1;
            document.getElementById('mysteryFactor').value = value;
            document.getElementById('mysteryValue').textContent = value;
        }

        function randomizeSexualCuriosity() {
            const value = Math.floor(Math.random() * 10) + 1;
            document.getElementById('sexualCuriosity').value = value;
            document.getElementById('sexualCuriosityValue').textContent = value;
        }

        function randomizeSexualComfort() {
            const value = Math.floor(Math.random() * 10) + 1;
            document.getElementById('sexualComfort').value = value;
            document.getElementById('sexualComfortValue').textContent = value;
        }

        function randomizeHair() {
            const options = ['long_straight', 'shoulder_wave', 'short_bob', 'ponytail', 'curly_volume', 'messy_sexy'];
            const element = document.getElementById('charHair');
            if (!element) {
                console.log('‚ùå charHair ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå');
                return;
            }
            const selectedOption = options[Math.floor(Math.random() * options.length)];
            element.value = selectedOption;
            console.log('‚úÖ Î®∏Î¶¨Ïπ¥ÎùΩ ÎûúÎç§ ÏÑ†ÌÉù:', selectedOption);
        }

        function randomizeEyes() {
            const options = ['seductive_eyes', 'almond_elegant', 'cat_like', 'mysterious_deep', 'sultry_gaze'];
            const element = document.getElementById('charEyes');
            if (!element) {
                console.log('‚ùå charEyes ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå');
                return;
            }
            const selectedOption = options[Math.floor(Math.random() * options.length)];
            element.value = selectedOption;
            console.log('‚úÖ Îàà ÎûúÎç§ ÏÑ†ÌÉù:', selectedOption);
        }

        function randomizeBody() {
            const select = document.getElementById('charBody');
            if (!select) {
                console.log('‚ùå charBody ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå');
                return;
            }
            const options = select.options;
            if (options.length === 0) {
                console.log('‚ùå charBody ÏòµÏÖòÏù¥ ÏóÜÏùå');
                return;
            }
            const randomIndex = Math.floor(Math.random() * options.length);
            select.selectedIndex = randomIndex;
            console.log('‚úÖ Ï≤¥Ìòï ÎûúÎç§ ÏÑ†ÌÉù:', options[randomIndex].text, '(index:', randomIndex, ')');
        }

        function randomizeBust() {
            const select = document.getElementById('charBust');
            if (!select) {
                console.log('‚ùå charBust ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå');
                return;
            }
            const options = select.options;
            if (options.length === 0) {
                console.log('‚ùå charBust ÏòµÏÖòÏù¥ ÏóÜÏùå');
                return;
            }
            const randomIndex = Math.floor(Math.random() * options.length);
            select.selectedIndex = randomIndex;
            console.log('‚úÖ Í∞ÄÏä¥ ÎûúÎç§ ÏÑ†ÌÉù:', options[randomIndex].text, '(index:', randomIndex, ')');
        }

        function randomizeWaistHip() {
            const select = document.getElementById('charWaistHip');
            if (!select) {
                console.log('‚ùå charWaistHip ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå');
                return;
            }
            const options = select.options;
            if (options.length === 0) {
                console.log('‚ùå charWaistHip ÏòµÏÖòÏù¥ ÏóÜÏùå');
                return;
            }
            const randomIndex = Math.floor(Math.random() * options.length);
            select.selectedIndex = randomIndex;
            console.log('‚úÖ ÌóàÎ¶¨/ÏóâÎç©Ïù¥ ÎûúÎç§ ÏÑ†ÌÉù:', options[randomIndex].text, '(index:', randomIndex, ')');
        }

        function randomizeStyle() {
            const select = document.getElementById('charStyle');
            if (!select) {
                console.log('‚ùå charStyle ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå');
                return;
            }
            const options = select.options;
            if (options.length === 0) {
                console.log('‚ùå charStyle ÏòµÏÖòÏù¥ ÏóÜÏùå');
                return;
            }
            const randomIndex = Math.floor(Math.random() * options.length);
            select.selectedIndex = randomIndex;
            console.log('‚úÖ Ïä§ÌÉÄÏùº ÎûúÎç§ ÏÑ†ÌÉù:', options[randomIndex].text, '(index:', randomIndex, ')');
        }

        // üéÅ Ï¢ãÏïÑÌïòÎäî ÏÑ†Î¨º ÎûúÎç§ ÏÑ†ÌÉù (3Í∞ú Ï§ë 2-3Í∞ú ÏÑ†ÌÉù)
        function randomizeGifts() {
            console.log('üé≤ Ï¢ãÏïÑÌïòÎäî ÏÑ†Î¨º ÎûúÎç§ ÏÑ†ÌÉù ÏãúÏûë...');

            // Í∏∞Ï°¥ ÏÑ†ÌÉù Î™®Îëê Ìï¥Ï†ú
            document.querySelectorAll('.gift-btn.selected').forEach(btn => {
                btn.classList.remove('selected');
            });

            const giftBtns = document.querySelectorAll('.gift-btn');
            if (giftBtns.length === 0) {
                console.log('‚ùå gift-btn ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå');
                return;
            }

            // 2-3Í∞ú ÏÇ¨Ïù¥ ÎûúÎç§ ÏÑ†ÌÉù
            const selectCount = Math.floor(Math.random() * 2) + 2; // 2-3Í∞ú
            const giftArray = Array.from(giftBtns);

            // Î∞∞Ïó¥ ÏÑûÍ∏∞
            for (let i = giftArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [giftArray[i], giftArray[j]] = [giftArray[j], giftArray[i]];
            }

            // Ï≤òÏùå selectCountÍ∞ú ÏÑ†ÌÉù
            for (let i = 0; i < selectCount && i < giftArray.length; i++) {
                giftArray[i].classList.add('selected');
            }

            console.log(`‚úÖ Ï¢ãÏïÑÌïòÎäî ÏÑ†Î¨º ${selectCount}Í∞ú ÎûúÎç§ ÏÑ†ÌÉù ÏôÑÎ£å`);
        }

        // üéÜ ÏÑ†ÌÉùÎêú ÎØ∏Îûò ÏßÅÏóÖ ÏàòÏßë (ÏµúÎåÄ 2Í∞ú)
        function getSelectedFutureCareers() {
            console.log('üîç getSelectedFutureCareers Ïã§Ìñâ Ï§ë...');
            const selected = [];
            const selectedCareerBtns = document.querySelectorAll('.career-btn.selected');
            console.log('üìä ÏÑ†ÌÉùÎêú career-btn ÏöîÏÜå Ïàò:', selectedCareerBtns.length);

            selectedCareerBtns.forEach(btn => {
                const value = btn.getAttribute('data-career');
                if (value) {
                    selected.push(value);
                    console.log('‚úÖ ÎØ∏Îûò ÏßÅÏóÖ ÏàòÏßëÎê®:', value);
                }
            });

            console.log('üéØ ÏµúÏ¢Ö ÎØ∏Îûò ÏßÅÏóÖ Î∞∞Ïó¥:', selected);
            return selected.length === 0 ? ['freelancer'] : selected;
        }

        // üéÜ ÏûêÏÇ∞ Î™©Ìëú ÎûúÎç§ ÏÑ†ÌÉù
        function randomizeAssetGoal() {
            console.log('üîÑ randomizeAssetGoal Ìï®Ïàò Ïã§Ìñâ ÏãúÏûë...');

            const assetGoals = ['1_billion', '3_billion', '5_billion', '10_billion', '30_billion', '50_billion', '100_billion'];
            const randomGoal = assetGoals[Math.floor(Math.random() * assetGoals.length)];

            const assetGoalElement = document.getElementById('assetGoal');
            if (assetGoalElement) {
                assetGoalElement.value = randomGoal;
                console.log('üé≤ ÎûúÎç§ ÏûêÏÇ∞ Î™©Ìëú ÏÑ†ÌÉù:', randomGoal);
            } else {
                console.error('‚ùå assetGoal ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§!');
            }
        }

        // üéÜ ÎØ∏Îûò ÏßÅÏóÖ ÎûúÎç§ ÏÑ†ÌÉù (1-2Í∞ú)
        function randomizeFutureCareers() {
            console.log('üîÑ randomizeFutureCareers Ìï®Ïàò Ïã§Ìñâ ÏãúÏûë...');

            // Í∏∞Ï°¥ ÏÑ†ÌÉù Ìï¥Ï†ú
            const existingSelected = document.querySelectorAll('.career-btn.selected');
            console.log('üóëÔ∏è Í∏∞Ï°¥ ÏÑ†ÌÉù Ìï¥Ï†ú - ÏÑ†ÌÉùÎêú Í∞úÏàò:', existingSelected.length);
            existingSelected.forEach(btn => {
                btn.classList.remove('selected');
            });

            const careerBtns = document.querySelectorAll('.career-btn');
            console.log('üîç Î∞úÍ≤¨Îêú .career-btn ÏöîÏÜå Ïàò:', careerBtns.length);

            if (careerBtns.length === 0) {
                console.error('‚ùå .career-btn ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§!');
                return;
            }

            const numCareers = Math.floor(Math.random() * 2) + 1; // 1-2Í∞ú ÎûúÎç§
            console.log('üéØ ÏÑ†ÌÉùÌï† ÏßÅÏóÖ Ïàò:', numCareers);

            const shuffled = Array.from(careerBtns).sort(() => 0.5 - Math.random());
            console.log('üîÄ Î∞∞Ïó¥ ÏÑπÌå© ÏôÑÎ£å, Ï≤òÏùå 3Í∞ú ÏöîÏÜå:', shuffled.slice(0, 3).map(btn => btn.getAttribute('data-career')));

            for (let i = 0; i < numCareers && i < shuffled.length; i++) {
                shuffled[i].classList.add('selected');
                const career = shuffled[i].getAttribute('data-career');
                console.log(`üé≤ ${i+1}Î≤àÏß∏ ÎûúÎç§ ÎØ∏Îûò ÏßÅÏóÖ ÏÑ†ÌÉù:`, career);
            }

            // ÏµúÏ¢Ö Í≤ÄÏ¶ù
            const finalSelected = document.querySelectorAll('.career-btn.selected');
            console.log('‚úÖ ÎØ∏Îûò ÏßÅÏóÖ ÎûúÎç§ ÏÑ†ÌÉù ÏôÑÎ£å - ÏµúÏ¢Ö ÏÑ†ÌÉùÎêú Í∞úÏàò:', finalSelected.length);
        }

        function randomizeAllFields() {
            randomizeName();
            randomizeAge();
            randomizeOccupation();
            randomizeCharms();
            randomizeEI();
            randomizeConfidence();
            randomizeMystery();
            randomizeSexualCuriosity();
            randomizeSexualComfort();
            randomizeHair();
            randomizeEyes();
            randomizeBody();
            randomizeBust();
            randomizeWaistHip();
            randomizeStyle();
            randomizeGifts(); // üéÅ Ï¢ãÏïÑÌïòÎäî ÏÑ†Î¨º ÎûúÎç§ ÏÑ†ÌÉù
            randomizeBodyLanguage(); // üíï Ìù•Î∂ÑÏãú Î∞òÏùë ÎûúÎç§ ÏÑ†ÌÉù
            randomizeSpeechHabits(); // üó£Ô∏è ÎßêÌà¨ ÏäµÍ¥Ä ÎûúÎç§ ÏÑ†ÌÉù
            randomizeForbiddenTopics(); // üö´ Í∏àÏßÄ Î∂ÑÏïº ÎûúÎç§ ÏÑ†ÌÉù
            randomizeAssetGoal(); // üéÜ ÏûêÏÇ∞ Î™©Ìëú ÎûúÎç§ ÏÑ†ÌÉù
            randomizeFutureCareers(); // üéÜ ÎØ∏Îûò ÏßÅÏóÖ ÎûúÎç§ ÏÑ†ÌÉù

            const statusEl = document.getElementById('randomStatus');
            if (statusEl) {
                statusEl.innerHTML = '‚ú® Î™®Îì† ÌïÑÎìúÍ∞Ä ÎûúÎç§ÏúºÎ°ú ÏÑ†ÌÉùÎêòÏóàÏäµÎãàÎã§!';
            }

            // üîÑ ÏûÑÏùò ÏÑ†ÌÉù ÌõÑ hidden inputÎì§ ÏóÖÎç∞Ïù¥Ìä∏
            console.log('üîÑ ÎûúÎç§ ÏÑ†ÌÉù ÌõÑ hidden input ÎèôÍ∏∞Ìôî Ï§ë...');
            setTimeout(() => {
                updatePersonalityTraitsHiddenInput();
                updateHobbiesHiddenInput();
                updateFeatureElementsHiddenInput();
                updateSensualHabitsHiddenInput();
                updateBodyLanguageHiddenInput();
                console.log('‚úÖ Î™®Îì† hidden input ÎèôÍ∏∞Ìôî ÏôÑÎ£å');
            }, 100);
        }

        // üéØ ÏÑ±Í≤©ÌäπÏÑ± ÎûúÎç§ ÏÑ†ÌÉù Ìï®Ïàò
        function randomizePersonalityTraits() {
            console.log('üéØ ÏÑ±Í≤©ÌäπÏÑ± ÎûúÎç§ ÏÑ†ÌÉù Ï§ë...');

            // Í∏∞Ï°¥ ÏÑ†ÌÉù Ìï¥Ï†ú
            document.querySelectorAll('.trait-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            const traitButtons = Array.from(document.querySelectorAll('.trait-btn'));
            if (traitButtons.length === 0) {
                console.log('‚ùå ÏÑ±Í≤©ÌäπÏÑ± Î≤ÑÌäºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå');
                return;
            }

            // 2-3Í∞ú ÎûúÎç§ ÏÑ†ÌÉù
            const selectCount = Math.floor(Math.random() * 2) + 2; // 2 ÎòêÎäî 3

            // Fisher-Yates ÏÖîÌîå
            for (let i = traitButtons.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [traitButtons[i], traitButtons[j]] = [traitButtons[j], traitButtons[i]];
            }

            // Ï≤òÏùå selectCountÍ∞ú ÏÑ†ÌÉù
            for (let i = 0; i < selectCount && i < traitButtons.length; i++) {
                traitButtons[i].classList.add('selected');
            }

            console.log(`‚úÖ ÏÑ±Í≤©ÌäπÏÑ± ${selectCount}Í∞ú ÎûúÎç§ ÏÑ†ÌÉù ÏôÑÎ£å`);
        }

        // üé® Ï∑®ÎØ∏ ÎûúÎç§ ÏÑ†ÌÉù Ìï®Ïàò
        function randomizeHobbies() {
            console.log('üé® Ï∑®ÎØ∏ ÎûúÎç§ ÏÑ†ÌÉù Ï§ë...');

            // Í∏∞Ï°¥ ÏÑ†ÌÉù Ìï¥Ï†ú
            document.querySelectorAll('.hobby-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            const hobbyButtons = Array.from(document.querySelectorAll('.hobby-btn'));
            if (hobbyButtons.length === 0) {
                console.log('‚ùå Ï∑®ÎØ∏ Î≤ÑÌäºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå');
                return;
            }

            // 2-3Í∞ú ÎûúÎç§ ÏÑ†ÌÉù
            const selectCount = Math.floor(Math.random() * 2) + 2; // 2 ÎòêÎäî 3

            // Fisher-Yates ÏÖîÌîå
            for (let i = hobbyButtons.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [hobbyButtons[i], hobbyButtons[j]] = [hobbyButtons[j], hobbyButtons[i]];
            }

            // Ï≤òÏùå selectCountÍ∞ú ÏÑ†ÌÉù
            for (let i = 0; i < selectCount && i < hobbyButtons.length; i++) {
                hobbyButtons[i].classList.add('selected');
            }

            console.log(`‚úÖ Ï∑®ÎØ∏ ${selectCount}Í∞ú ÎûúÎç§ ÏÑ†ÌÉù ÏôÑÎ£å`);
        }

        // ‚ú® ÏûêÏã†ÏûàÎäî Î∂ÄÏúÑ ÎûúÎç§ ÏÑ†ÌÉù Ìï®Ïàò
        function randomizeFeatureElements() {
            console.log('‚ú® ÏûêÏã†ÏûàÎäî Î∂ÄÏúÑ ÎûúÎç§ ÏÑ†ÌÉù Ï§ë...');

            // Í∏∞Ï°¥ ÏÑ†ÌÉù Ìï¥Ï†ú
            document.querySelectorAll('.confident-part-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            const featureButtons = Array.from(document.querySelectorAll('.confident-part-btn'));
            if (featureButtons.length === 0) {
                console.log('‚ùå ÏûêÏã†ÏûàÎäî Î∂ÄÏúÑ Î≤ÑÌäºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå');
                return;
            }

            // 2-3Í∞ú ÎûúÎç§ ÏÑ†ÌÉù
            const selectCount = Math.floor(Math.random() * 2) + 2; // 2 ÎòêÎäî 3

            // Fisher-Yates ÏÖîÌîå
            for (let i = featureButtons.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [featureButtons[i], featureButtons[j]] = [featureButtons[j], featureButtons[i]];
            }

            // Ï≤òÏùå selectCountÍ∞ú ÏÑ†ÌÉù
            for (let i = 0; i < selectCount && i < featureButtons.length; i++) {
                featureButtons[i].classList.add('selected');
            }

            console.log(`‚úÖ ÏûêÏã†ÏûàÎäî Î∂ÄÏúÑ ${selectCount}Í∞ú ÎûúÎç§ ÏÑ†ÌÉù ÏôÑÎ£å`);
        }

        // üíÉ ÏÑπÏãúÌè¨Ï¶à ÎûúÎç§ ÏÑ†ÌÉù Ìï®Ïàò
        function randomizeSensualHabits() {
            console.log('üíÉ ÏÑπÏãúÌè¨Ï¶à ÎûúÎç§ ÏÑ†ÌÉù Ï§ë...');

            // Í∏∞Ï°¥ ÏÑ†ÌÉù Ìï¥Ï†ú
            document.querySelectorAll('.seductive-pose-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            const poseButtons = Array.from(document.querySelectorAll('.seductive-pose-btn'));
            if (poseButtons.length === 0) {
                console.log('‚ùå ÏÑπÏãúÌè¨Ï¶à Î≤ÑÌäºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå');
                return;
            }

            // 1-2Í∞ú ÎûúÎç§ ÏÑ†ÌÉù
            const selectCount = Math.floor(Math.random() * 2) + 1; // 1 ÎòêÎäî 2

            // Fisher-Yates ÏÖîÌîå
            for (let i = poseButtons.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [poseButtons[i], poseButtons[j]] = [poseButtons[j], poseButtons[i]];
            }

            // Ï≤òÏùå selectCountÍ∞ú ÏÑ†ÌÉù
            for (let i = 0; i < selectCount && i < poseButtons.length; i++) {
                poseButtons[i].classList.add('selected');
            }

            console.log(`‚úÖ ÏÑπÏãúÌè¨Ï¶à ${selectCount}Í∞ú ÎûúÎç§ ÏÑ†ÌÉù ÏôÑÎ£å`);
        }

        // üíï Ìù•Î∂ÑÏãú Î∞òÏùë ÎûúÎç§ ÏÑ†ÌÉù Ìï®Ïàò
        function randomizeBodyLanguage() {
            console.log('üíï Ìù•Î∂ÑÏãú Î∞òÏùë ÎûúÎç§ ÏÑ†ÌÉù Ï§ë...');

            // Í∏∞Ï°¥ ÏÑ†ÌÉù Ìï¥Ï†ú
            document.querySelectorAll('.body-language-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            const bodyLanguageButtons = Array.from(document.querySelectorAll('.body-language-btn'));
            if (bodyLanguageButtons.length === 0) {
                console.log('‚ùå Ìù•Î∂ÑÏãú Î∞òÏùë Î≤ÑÌäºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå');
                return;
            }

            // 1-2Í∞ú ÎûúÎç§ ÏÑ†ÌÉù
            const selectCount = Math.floor(Math.random() * 2) + 1; // 1 ÎòêÎäî 2

            // Fisher-Yates ÏÖîÌîå
            for (let i = bodyLanguageButtons.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [bodyLanguageButtons[i], bodyLanguageButtons[j]] = [bodyLanguageButtons[j], bodyLanguageButtons[i]];
            }

            // Ï≤òÏùå selectCountÍ∞ú ÏÑ†ÌÉù
            for (let i = 0; i < selectCount && i < bodyLanguageButtons.length; i++) {
                bodyLanguageButtons[i].classList.add('selected');
            }

            console.log(`‚úÖ Ìù•Î∂ÑÏãú Î∞òÏùë ${selectCount}Í∞ú ÎûúÎç§ ÏÑ†ÌÉù ÏôÑÎ£å`);
        }

        // üó£Ô∏è ÎßêÌà¨ ÏäµÍ¥Ä ÎûúÎç§ ÏÑ†ÌÉù Ìï®Ïàò
        function randomizeSpeechHabits() {
            console.log('üó£Ô∏è ÎßêÌà¨ ÏäµÍ¥Ä ÎûúÎç§ ÏÑ†ÌÉù Ï§ë...');

            // Í∏∞Ï°¥ ÏÑ†ÌÉù Ìï¥Ï†ú
            document.querySelectorAll('.speech-habit-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            const speechHabitButtons = Array.from(document.querySelectorAll('.speech-habit-btn'));
            if (speechHabitButtons.length === 0) {
                console.log('‚ùå ÎßêÌà¨ ÏäµÍ¥Ä Î≤ÑÌäºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå');
                return;
            }

            // 1-3Í∞ú ÎûúÎç§ ÏÑ†ÌÉù
            const selectCount = Math.floor(Math.random() * 3) + 1; // 1, 2, ÎòêÎäî 3

            // Fisher-Yates ÏÖîÌîå
            for (let i = speechHabitButtons.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [speechHabitButtons[i], speechHabitButtons[j]] = [speechHabitButtons[j], speechHabitButtons[i]];
            }

            // Ï≤òÏùå selectCountÍ∞ú ÏÑ†ÌÉù
            for (let i = 0; i < selectCount && i < speechHabitButtons.length; i++) {
                speechHabitButtons[i].classList.add('selected');
            }

            console.log(`‚úÖ ÎßêÌà¨ ÏäµÍ¥Ä ${selectCount}Í∞ú ÎûúÎç§ ÏÑ†ÌÉù ÏôÑÎ£å`);
        }

        // üö´ Í∏àÏßÄ Î∂ÑÏïº ÎûúÎç§ ÏÑ†ÌÉù Ìï®Ïàò
        function randomizeForbiddenTopics() {
            console.log('üö´ Í∏àÏßÄ Î∂ÑÏïº ÎûúÎç§ ÏÑ†ÌÉù Ï§ë...');

            // Í∏∞Ï°¥ ÏÑ†ÌÉù Ìï¥Ï†ú
            document.querySelectorAll('.forbidden-topic-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            const forbiddenTopicButtons = Array.from(document.querySelectorAll('.forbidden-topic-btn'));
            if (forbiddenTopicButtons.length === 0) {
                console.log('‚ùå Í∏àÏßÄ Î∂ÑÏïº Î≤ÑÌäºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå');
                return;
            }

            // 1-4Í∞ú ÎûúÎç§ ÏÑ†ÌÉù
            const selectCount = Math.floor(Math.random() * 4) + 1; // 1, 2, 3, ÎòêÎäî 4

            // Fisher-Yates ÏÖîÌîå
            for (let i = forbiddenTopicButtons.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [forbiddenTopicButtons[i], forbiddenTopicButtons[j]] = [forbiddenTopicButtons[j], forbiddenTopicButtons[i]];
            }

            // Ï≤òÏùå selectCountÍ∞ú ÏÑ†ÌÉù
            for (let i = 0; i < selectCount && i < forbiddenTopicButtons.length; i++) {
                forbiddenTopicButtons[i].classList.add('selected');
            }

            console.log(`‚úÖ Í∏àÏßÄ Î∂ÑÏïº ${selectCount}Í∞ú ÎûúÎç§ ÏÑ†ÌÉù ÏôÑÎ£å`);
        }

        // üë® ÎÇ®Ïûê Ïö∞ÏÑ†ÏàúÏúÑ ÎûúÎç§ ÏÑ†ÌÉù Ìï®Ïàò
        function randomizeMalePriorities() {
            console.log('üë® ÎÇ®Ïûê Ïö∞ÏÑ†ÏàúÏúÑ ÎûúÎç§ ÏÑ†ÌÉù Ï§ë...');

            // Í∏∞Ï°¥ ÏÑ†ÌÉù Ìï¥Ï†ú
            document.querySelectorAll('.male-priority-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            const malePriorityButtons = Array.from(document.querySelectorAll('.male-priority-btn'));
            if (malePriorityButtons.length === 0) {
                console.log('‚ùå ÎÇ®Ïûê Ïö∞ÏÑ†ÏàúÏúÑ Î≤ÑÌäºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå');
                return;
            }

            // 2-3Í∞ú ÎûúÎç§ ÏÑ†ÌÉù
            const selectCount = Math.floor(Math.random() * 2) + 2; // 2 ÎòêÎäî 3

            // Fisher-Yates ÏÖîÌîå
            for (let i = malePriorityButtons.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [malePriorityButtons[i], malePriorityButtons[j]] = [malePriorityButtons[j], malePriorityButtons[i]];
            }

            // Ï≤òÏùå selectCountÍ∞ú ÏÑ†ÌÉù
            for (let i = 0; i < selectCount && i < malePriorityButtons.length; i++) {
                malePriorityButtons[i].classList.add('selected');
            }

            console.log(`‚úÖ ÎÇ®Ïûê Ïö∞ÏÑ†ÏàúÏúÑ ${selectCount}Í∞ú ÎûúÎç§ ÏÑ†ÌÉù ÏôÑÎ£å`);
        }

        // üéØ Ï∫êÎ¶≠ÌÑ∞ Ìèº ÏûêÎèô Ï±ÑÏö∞Í∏∞ Ìï®Ïàò (Ìèº Ïó¥ Îïå ÏûêÎèô Ïã§Ìñâ)
        function autoFillRandomCharacterData() {
            console.log('üé≤ === autoFillRandomCharacterData ÏãúÏûë ===');

            // Í∏∞Î≥∏ Ï†ïÎ≥¥ ÎûúÎç§ ÏÑ†ÌÉù
            console.log('üìù Í∏∞Î≥∏ Ï†ïÎ≥¥ ÎûúÎç§ ÏÑ†ÌÉù Ï§ë...');
            randomizeName();
            randomizeAge();
            randomizeOccupation();
            randomizeEducation();
            randomizeLocation();
            randomizeHometown();
            randomizeFamilyStructure();
            randomizePets();
            randomizeBloodType();

            // üí´ Îß§Î†• ÌîÑÎ°úÌïÑ ÎûúÎç§ ÏÑ†ÌÉù
            console.log('üí´ Îß§Î†• ÌîÑÎ°úÌïÑ ÎûúÎç§ ÏÑ†ÌÉù Ï§ë...');
            randomizeCharms();
            randomizeEI();
            randomizeConfidence();
            randomizeMystery();

            // üéØ ÏÑ±Í≤©/Ï∑®ÎØ∏ Î≤ÑÌäº ÎûúÎç§ ÏÑ†ÌÉù
            console.log('üéØ ÏÑ±Í≤©/Ï∑®ÎØ∏ Î≤ÑÌäº ÎûúÎç§ ÏÑ†ÌÉù Ï§ë...');
            randomizePersonalityTraits();
            randomizeHobbies();
            randomizeFeatureElements();
            randomizeSensualHabits();

            // Ïô∏Î™® Ï†ïÎ≥¥ ÎûúÎç§ ÏÑ†ÌÉù
            console.log('üé® Ïô∏Î™® Ï†ïÎ≥¥ ÎûúÎç§ ÏÑ†ÌÉù Ï§ë...');
            randomizeHair();
            randomizeEyes();
            randomizeBody();
            randomizeBust();
            randomizeWaistHip();
            randomizeStyle();

            // Ïã¨Î¶¨Ï†Å ÌäπÏÑ± ÎûúÎç§ ÏÑ†ÌÉù
            randomizeSexualCuriosity();
            randomizeSexualComfort();

            // MBTI ÎûúÎç§ ÏÑ†ÌÉù - ÎåÄÎ¨∏Ïûê ÏÇ¨Ïö©
            const mbtiOptions = ['ENFP', 'INFP', 'ENFJ', 'INFJ', 'ENTP', 'INTP', 'ENTJ', 'INTJ', 'ESFP', 'ISFP', 'ESFJ', 'ISFJ', 'ESTP', 'ISTP', 'ESTJ', 'ISTJ'];
            const randomMbti = mbtiOptions[Math.floor(Math.random() * mbtiOptions.length)];
            console.log('üß† MBTI ÎûúÎç§ ÏÑ†ÌÉù:', randomMbti);
            document.querySelectorAll('.mbti-btn').forEach(btn => btn.classList.remove('selected'));
            const mbtiBtn = document.querySelector(`[data-mbti="${randomMbti}"]`);
            if (mbtiBtn) {
                mbtiBtn.classList.add('selected');
                document.getElementById('charMbti').value = randomMbti;
                console.log('‚úÖ MBTI Î≤ÑÌäº ÏÑ†ÌÉùÎê®:', randomMbti);
            } else {
                console.log('‚ùå MBTI Î≤ÑÌäºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå:', randomMbti);
            }

            // Í¥ÄÍ≥Ñ ÏÑ§Ï†ï ÎûúÎç§ ÏÑ†ÌÉù - Ïã§Ï†ú HTMLÏùò data-rel Í∞íÎì§ ÏÇ¨Ïö©
            const relationshipOptions = ['seductive_junior', 'adult_friend', 'mature_senior', 'sexy_classmate', 'sensual_clubmate', 'alluring_neighbor'];
            const randomRelationship = relationshipOptions[Math.floor(Math.random() * relationshipOptions.length)];
            console.log('üë• Í¥ÄÍ≥ÑÏÑ§Ï†ï ÎûúÎç§ ÏÑ†ÌÉù:', randomRelationship);
            document.querySelectorAll('.relationship-btn').forEach(btn => btn.classList.remove('selected'));
            const relationshipBtn = document.querySelector(`[data-rel="${randomRelationship}"]`);
            if (relationshipBtn) {
                relationshipBtn.classList.add('selected');
                document.getElementById('charRelationship').value = randomRelationship;
                console.log('‚úÖ Í¥ÄÍ≥ÑÏÑ§Ï†ï Î≤ÑÌäº ÏÑ†ÌÉùÎê®:', randomRelationship);
            } else {
                console.log('‚ùå Í¥ÄÍ≥ÑÏÑ§Ï†ï Î≤ÑÌäºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå:', randomRelationship);
            }

            // ÎßêÌà¨ Ïä§ÌÉÄÏùº ÎûúÎç§ ÏÑ†ÌÉù - Ïã§Ï†ú HTMLÏùò data-speech Í∞íÎì§ ÏÇ¨Ïö©
            const speechOptions = ['sensual_whisper', 'mature_elegant', 'playful_seductive', 'sexy_flirty', 'mysterious_seductive', 'confident_alluring', 'sultry_dominant', 'sweet_tempting', 'bold_provocative'];
            const randomSpeech = speechOptions[Math.floor(Math.random() * speechOptions.length)];
            console.log('üó£Ô∏è ÎßêÌà¨ ÎûúÎç§ ÏÑ†ÌÉù:', randomSpeech);
            document.querySelectorAll('.speech-btn').forEach(btn => btn.classList.remove('selected'));
            const speechBtn = document.querySelector(`[data-speech="${randomSpeech}"]`);
            if (speechBtn) {
                speechBtn.classList.add('selected');
                document.getElementById('charSpeechStyle').value = randomSpeech;
                console.log('‚úÖ ÎßêÌà¨ Î≤ÑÌäº ÏÑ†ÌÉùÎê®:', randomSpeech);
            } else {
                console.log('‚ùå ÎßêÌà¨ Î≤ÑÌäºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå:', randomSpeech);
            }

            // Îß§Î†• Ìè¨Ïù∏Ìä∏ ÎûúÎç§ ÏÑ†ÌÉù (1-3Í∞ú) - Ïã§Ï†ú HTMLÏùò data-charm Í∞íÎì§ ÏÇ¨Ïö©
            const charmOptions = ['infectious_smile', 'witty_banter', 'confident_touch', 'mysterious_aura', 'graceful_movements', 'expressive_eyes'];
            const numCharms = Math.floor(Math.random() * 3) + 1; // 1-3Í∞ú
            document.querySelectorAll('.charm-btn').forEach(btn => btn.classList.remove('selected'));
            const selectedCharms = [];
            for (let i = 0; i < numCharms; i++) {
                const availableOptions = charmOptions.filter(option => !selectedCharms.includes(option));
                if (availableOptions.length > 0) {
                    const randomCharm = availableOptions[Math.floor(Math.random() * availableOptions.length)];
                    selectedCharms.push(randomCharm);
                    const charmBtn = document.querySelector(`[data-charm="${randomCharm}"]`);
                    if (charmBtn) {
                        charmBtn.classList.add('selected');
                        console.log('‚úÖ Îß§Î†•Ìè¨Ïù∏Ìä∏ ÏÑ†ÌÉùÎê®:', randomCharm);
                    } else {
                        console.log('‚ùå Îß§Î†•Ìè¨Ïù∏Ìä∏ Î≤ÑÌäº Î™ªÏ∞æÏùå:', randomCharm);
                    }
                }
            }

            // ÌïµÏã¨ ÏöïÍµ¨ ÎûúÎç§ ÏÑ†ÌÉù (1-2Í∞ú) - Ïã§Ï†ú HTMLÏùò data-desire Í∞íÎì§ ÏÇ¨Ïö©
            const desireOptions = ['meaningful_connection', 'creative_expression', 'personal_growth', 'adventure_excitement', 'intellectual_stimulation'];
            const numDesires = Math.floor(Math.random() * 2) + 1; // 1-2Í∞ú
            document.querySelectorAll('.desire-btn').forEach(btn => btn.classList.remove('selected'));
            const selectedDesires = [];
            for (let i = 0; i < numDesires; i++) {
                const availableOptions = desireOptions.filter(option => !selectedDesires.includes(option));
                if (availableOptions.length > 0) {
                    const randomDesire = availableOptions[Math.floor(Math.random() * availableOptions.length)];
                    selectedDesires.push(randomDesire);
                    const desireBtn = document.querySelector(`[data-desire="${randomDesire}"]`);
                    if (desireBtn) {
                        desireBtn.classList.add('selected');
                        console.log('‚úÖ ÌïµÏã¨ÏöïÍµ¨ ÏÑ†ÌÉùÎê®:', randomDesire);
                    } else {
                        console.log('‚ùå ÌïµÏã¨ÏöïÍµ¨ Î≤ÑÌäº Î™ªÏ∞æÏùå:', randomDesire);
                    }
                }
            }

            // Ïä§ÌÇ®Ïã≠ ÏàòÏúÑ ÎûúÎç§ ÏÑ†ÌÉù (1-3Í∞ú) - Ïã§Ï†ú HTMLÏùò data-skinship Í∞íÎì§ ÏÇ¨Ïö©
            const skinshipOptions = ['hand_holding', 'light_hugs', 'cheek_kiss', 'shoulder_massage', 'head_patting', 'back_rubbing', 'intimate_cuddling', 'passionate_kiss'];
            const numSkinships = Math.floor(Math.random() * 3) + 1; // 1-3Í∞ú
            document.querySelectorAll('.skinship-btn').forEach(btn => btn.classList.remove('selected'));
            const selectedSkinships = [];
            for (let i = 0; i < numSkinships; i++) {
                const availableOptions = skinshipOptions.filter(option => !selectedSkinships.includes(option));
                if (availableOptions.length > 0) {
                    const randomSkinship = availableOptions[Math.floor(Math.random() * availableOptions.length)];
                    selectedSkinships.push(randomSkinship);
                    const skinshipBtn = document.querySelector(`[data-skinship="${randomSkinship}"]`);
                    if (skinshipBtn) {
                        skinshipBtn.classList.add('selected');
                        console.log('‚úÖ Ïä§ÌÇ®Ïã≠ ÏÑ†ÌÉùÎê®:', randomSkinship);
                    } else {
                        console.log('‚ùå Ïä§ÌÇ®Ïã≠ Î≤ÑÌäº Î™ªÏ∞æÏùå:', randomSkinship);
                    }
                }
            }

            // üéÄ ÏÑ±Í≤© ÌäπÏÑ± ÎûúÎç§ ÏÑ†ÌÉù (1-3Í∞ú)
            const traitOptions = ['Í∞êÏÑ±Ï†Å', 'ÌôúÎ∞úÌïú', 'Îß§ÌòπÏ†ÅÏù∏', 'ÏÑπÏãúÌïú', 'Ï∞ΩÏùòÏ†Å', 'Ïú†ÌòπÏ†ÅÏù∏', 'ÏûêÏã†Í∞ê ÏûàÎäî', 'Ïó¥Ï†ïÏ†Å', 'ÎèÑÎ∞úÏ†ÅÏù∏', 'ÏÑ±ÏàôÌïú'];
            const numTraits = Math.floor(Math.random() * 3) + 1; // 1-3Í∞ú
            document.querySelectorAll('.trait-btn').forEach(btn => btn.classList.remove('selected'));
            const selectedTraits = [];
            for (let i = 0; i < numTraits; i++) {
                const availableOptions = traitOptions.filter(option => !selectedTraits.includes(option));
                if (availableOptions.length > 0) {
                    const randomTrait = availableOptions[Math.floor(Math.random() * availableOptions.length)];
                    selectedTraits.push(randomTrait);
                    const traitBtn = document.querySelector(`.trait-btn[data-trait="${randomTrait}"]`);
                    if (traitBtn) {
                        traitBtn.classList.add('selected');
                        console.log('‚úÖ ÏÑ±Í≤©ÌäπÏÑ± ÏÑ†ÌÉùÎê®:', randomTrait);
                    }
                }
            }

            // üéÄ Ï∑®ÎØ∏ ÎûúÎç§ ÏÑ†ÌÉù (2-3Í∞ú)
            const hobbyOptions = ['reading', 'drawing', 'music', 'photography', 'cooking', 'exercise', 'travel', 'movies', 'gaming', 'dancing', 'shopping', 'cafe'];
            const numHobbies = Math.floor(Math.random() * 2) + 2; // 2-3Í∞ú
            document.querySelectorAll('.hobby-btn').forEach(btn => btn.classList.remove('selected'));
            const selectedHobbies = [];
            for (let i = 0; i < numHobbies; i++) {
                const availableOptions = hobbyOptions.filter(option => !selectedHobbies.includes(option));
                if (availableOptions.length > 0) {
                    const randomHobby = availableOptions[Math.floor(Math.random() * availableOptions.length)];
                    selectedHobbies.push(randomHobby);
                    const hobbyBtn = document.querySelector(`[data-hobby="${randomHobby}"]`);
                    if (hobbyBtn) {
                        hobbyBtn.classList.add('selected');
                        console.log('‚úÖ Ï∑®ÎØ∏ ÏÑ†ÌÉùÎê®:', randomHobby);
                    }
                }
            }

            // ‚ú® ÏûêÏã†ÏûàÎäî Î∂ÄÏúÑ ÎûúÎç§ ÏÑ†ÌÉù (2-3Í∞ú)
            const featureOptions = ['beautiful_face', 'seductive_eyes', 'sexy_lips', 'elegant_neck', 'attractive_chest', 'slim_waist', 'curvy_hips', 'long_legs', 'soft_skin'];
            const numFeatures = Math.floor(Math.random() * 2) + 2; // 2-3Í∞ú
            document.querySelectorAll('.confident-part-btn').forEach(btn => btn.classList.remove('selected'));
            const selectedFeatures = [];
            for (let i = 0; i < numFeatures; i++) {
                const availableOptions = featureOptions.filter(option => !selectedFeatures.includes(option));
                if (availableOptions.length > 0) {
                    const randomFeature = availableOptions[Math.floor(Math.random() * availableOptions.length)];
                    selectedFeatures.push(randomFeature);
                    const featureBtn = document.querySelector(`[data-feature="${randomFeature}"]`);
                    if (featureBtn) {
                        featureBtn.classList.add('selected');
                        console.log('‚úÖ ÏûêÏã†ÏûàÎäî Î∂ÄÏúÑ ÏÑ†ÌÉùÎê®:', randomFeature);
                    }
                }
            }

            // üíÉ ÏÑπÏãúÌè¨Ï¶à ÎûúÎç§ ÏÑ†ÌÉù (1-2Í∞ú)
            const poseOptions = ['ÏûÖÏà†Íπ®Î¨ºÍ∏∞', 'ÌóàÎ¶¨ÍµΩÌûàÍ∏∞', 'Îã§Î¶¨Íº¨Í∏∞', 'Ïñ¥Íπ®ÎìúÎü¨ÎÇ¥Í∏∞', 'Î™∏Í∏∞Ïö∏Ïù¥Í∏∞', 'ÏúôÌÅ¨ÌïòÍ∏∞', 'Ïä§Ìä∏Î†àÏπ≠', 'Ìó§Ïñ¥ÌÑ∞Ïπò', 'Ïú†ÌòπÏ†ÅÏãúÏÑ†'];
            const numPoses = Math.floor(Math.random() * 2) + 1; // 1-2Í∞ú
            document.querySelectorAll('.seductive-pose-btn').forEach(btn => btn.classList.remove('selected'));
            const selectedPoses = [];
            for (let i = 0; i < numPoses; i++) {
                const availableOptions = poseOptions.filter(option => !selectedPoses.includes(option));
                if (availableOptions.length > 0) {
                    const randomPose = availableOptions[Math.floor(Math.random() * availableOptions.length)];
                    selectedPoses.push(randomPose);
                    const poseBtn = document.querySelector(`[data-habit="${randomPose}"]`);
                    if (poseBtn) {
                        poseBtn.classList.add('selected');
                        console.log('‚úÖ ÏÑπÏãúÌè¨Ï¶à ÏÑ†ÌÉùÎê®:', randomPose);
                    }
                }
            }

            // üéÅ Ï¢ãÏïÑÌïòÎäî ÏÑ†Î¨º ÎûúÎç§ ÏÑ†ÌÉù (2-3Í∞ú)
            const giftOptions = ['luxury_lingerie', 'expensive_car', 'jewelry', 'perfume', 'designer_bag', 'flowers', 'chocolate', 'spa_voucher', 'wine', 'books', 'cute_accessories', 'travel_package'];
            const numGifts = Math.floor(Math.random() * 2) + 2; // 2-3Í∞ú
            document.querySelectorAll('.gift-btn').forEach(btn => btn.classList.remove('selected'));
            const selectedGifts = [];
            for (let i = 0; i < numGifts; i++) {
                const availableOptions = giftOptions.filter(option => !selectedGifts.includes(option));
                if (availableOptions.length > 0) {
                    const randomGift = availableOptions[Math.floor(Math.random() * availableOptions.length)];
                    selectedGifts.push(randomGift);
                    const giftBtn = document.querySelector(`[data-gift="${randomGift}"]`);
                    if (giftBtn) {
                        giftBtn.classList.add('selected');
                        console.log('‚úÖ Ï¢ãÏïÑÌïòÎäî ÏÑ†Î¨º ÏÑ†ÌÉùÎê®:', randomGift);
                    }
                }
            }

            // üí¨ ÌîåÎü¨ÌåÖ Ìå®ÌÑ¥ ÎûúÎç§ ÏÑ†ÌÉù (1-3Í∞ú)
            const flirtingOptions = ['subtle_teasing', 'direct_compliments', 'playful_banter', 'gentle_touches', 'eye_contact', 'mysterious_hints'];
            const numFlirting = Math.floor(Math.random() * 3) + 1; // 1-3Í∞ú
            document.querySelectorAll('.flirting-btn').forEach(btn => btn.classList.remove('selected'));
            const selectedFlirting = [];
            for (let i = 0; i < numFlirting; i++) {
                const availableOptions = flirtingOptions.filter(option => !selectedFlirting.includes(option));
                if (availableOptions.length > 0) {
                    const randomFlirting = availableOptions[Math.floor(Math.random() * availableOptions.length)];
                    selectedFlirting.push(randomFlirting);
                    const flirtingBtn = document.querySelector(`[data-flirting="${randomFlirting}"]`);
                    if (flirtingBtn) {
                        flirtingBtn.classList.add('selected');
                        console.log('‚úÖ ÌîåÎü¨ÌåÖ Ìå®ÌÑ¥ ÏÑ†ÌÉùÎê®:', randomFlirting);
                    }
                }
            }

            // üó®Ô∏è ÎåÄÌôî ÌõÖ ÎûúÎç§ ÏÑ†ÌÉù (2-4Í∞ú)
            const hookOptions = ['travel_stories', 'food_culture', 'music_movies', 'life_philosophy', 'future_dreams', 'childhood_memories', 'work_passion', 'relationships'];
            const numHooks = Math.floor(Math.random() * 3) + 2; // 2-4Í∞ú
            document.querySelectorAll('.hook-btn').forEach(btn => btn.classList.remove('selected'));
            const selectedHooks = [];
            for (let i = 0; i < numHooks; i++) {
                const availableOptions = hookOptions.filter(option => !selectedHooks.includes(option));
                if (availableOptions.length > 0) {
                    const randomHook = availableOptions[Math.floor(Math.random() * availableOptions.length)];
                    selectedHooks.push(randomHook);
                    const hookBtn = document.querySelector(`[data-hook="${randomHook}"]`);
                    if (hookBtn) {
                        hookBtn.classList.add('selected');
                        console.log('‚úÖ ÎåÄÌôî ÌõÖ ÏÑ†ÌÉùÎê®:', randomHook);
                    }
                }
            }

            // üé≠ ÌóàÏö© Î™®Ìã∞ÌîÑ ÎûúÎç§ ÏÑ†ÌÉù (2-5Í∞ú)
            const motifOptions = ['romance_love', 'dreams_goals', 'personal_growth', 'art_creativity', 'nature_travel', 'friendship', 'philosophy', 'daily_life'];
            const numMotifs = Math.floor(Math.random() * 4) + 2; // 2-5Í∞ú
            document.querySelectorAll('.motif-btn').forEach(btn => btn.classList.remove('selected'));
            const selectedMotifs = [];
            for (let i = 0; i < numMotifs; i++) {
                const availableOptions = motifOptions.filter(option => !selectedMotifs.includes(option));
                if (availableOptions.length > 0) {
                    const randomMotif = availableOptions[Math.floor(Math.random() * availableOptions.length)];
                    selectedMotifs.push(randomMotif);
                    const motifBtn = document.querySelector(`[data-motif="${randomMotif}"]`);
                    if (motifBtn) {
                        motifBtn.classList.add('selected');
                        console.log('‚úÖ ÌóàÏö© Î™®Ìã∞ÌîÑ ÏÑ†ÌÉùÎê®:', randomMotif);
                    }
                }
            }

            console.log('üé≤ Ï∫êÎ¶≠ÌÑ∞ Ìèº ÏûêÎèô Ï±ÑÏö∞Í∏∞ ÏôÑÎ£å:', {
                mbti: randomMbti,
                relationship: randomRelationship,
                speech: randomSpeech,
                traits: selectedTraits,
                hobbies: selectedHobbies,
                features: selectedFeatures,
                poses: selectedPoses,
                gifts: selectedGifts,
                flirting: selectedFlirting,
                hooks: selectedHooks,
                motifs: selectedMotifs,
                charms: selectedCharms,
                desires: selectedDesires,
                skinships: selectedSkinships
            });

            // üíï Ìù•Î∂ÑÏãú Î∞òÏùë ÎûúÎç§ ÏÑ†ÌÉù
            randomizeBodyLanguage();

            // üó£Ô∏è ÎßêÌà¨ ÏäµÍ¥Ä ÎûúÎç§ ÏÑ†ÌÉù
            randomizeSpeechHabits();

            // üö´ Í∏àÏßÄ Î∂ÑÏïº ÎûúÎç§ ÏÑ†ÌÉù
            randomizeForbiddenTopics();

            // üéÅ Ï¢ãÏïÑÌïòÎäî ÏÑ†Î¨º ÎûúÎç§ ÏÑ†ÌÉù
            randomizeGifts();

            // üë® ÎÇ®ÏûêÎ•º Î≥º Îïå ÏµúÏö∞ÏÑ†ÏãúÌïòÎäî Í≤É ÎûúÎç§ ÏÑ†ÌÉù
            randomizeMalePriorities();

            // üöÄ ÎØ∏Îûò ÏßÅÏóÖ Î™©Ìëú ÎûúÎç§ ÏÑ†ÌÉù
            randomizeFutureCareers();

            console.log('‚úÖ === autoFillRandomCharacterData ÏôÑÎ£å ===');
        }

        function resetAllFields() {
            document.getElementById('characterForm').reset();
            document.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
            const statusEl = document.getElementById('randomStatus');
            if (statusEl) {
                statusEl.innerHTML = 'üîÑ Î™®Îì† ÌïÑÎìúÍ∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§!';
            }
        }

        // üìù v2.1 Ïä§ÌÇ§Îßà ÌïÑÎìú Ï∂îÏ∂ú Ìï®ÏàòÎì§
        function getCharacterCharmPoints(character) {
            const charmPoints = character.appeal_profile?.charm_points;
            if (charmPoints && Array.isArray(charmPoints) && charmPoints.length > 0) {
                return charmPoints.map(point => translateToKorean(point, 'charm_points')).join(', ');
            }
            return '-';
        }

        function getCharacterSexualCuriosity(character) {
            const value = character.appeal_profile?.sexual_curiosity;
            return value ? `${value}/10` : '-';
        }

        function getCharacterSexualComfort(character) {
            const value = character.appeal_profile?.sexual_comfort;
            return value ? `${value}/10` : '-';
        }

        function getCharacterFeatureElements(character) {
            const features = character.physical_allure?.feature_elements;
            if (features && Array.isArray(features) && features.length > 0) {
                return features.map(feature => translateToKorean(feature, 'feature_elements')).join(', ');
            }
            return '-';
        }

        function getCharacterSensualHabits(character) {
            const habits = character.physical_allure?.sensual_habits;
            if (habits && Array.isArray(habits) && habits.length > 0) {
                return habits.map(habit => translateToKorean(habit, 'sensual_habits')).join(', ');
            }
            return '-';
        }

        function getCharacterBodyLanguage(character) {
            const bodyLanguage = character.physical_allure?.body_language;
            if (bodyLanguage && Array.isArray(bodyLanguage) && bodyLanguage.length > 0) {
                return bodyLanguage.map(lang => translateToKorean(lang, 'body_language')).join(', ');
            }
            return bodyLanguage ? translateToKorean(bodyLanguage, 'body_language') : '-';
        }

        // üéÅ Ï¢ãÏïÑÌïòÎäî ÏÑ†Î¨º ÌëúÏãú Ìï®Ïàò
        function getCharacterFavoriteGifts(character) {
            const gifts = character.favorite_gifts;
            if (gifts && Array.isArray(gifts) && gifts.length > 0) {
                return gifts.map(gift => translateToKorean(gift, 'favorite_gifts')).join(', ');
            }
            return '-';
        }

        function getCharacterCoreDesires(character) {
            const desires = character.psychological_depth?.core_desires;
            if (desires && Array.isArray(desires) && desires.length > 0) {
                return desires.map(desire => translateToKorean(desire, 'core_desires')).join(', ');
            }
            return '-';
        }

        function getCharacterVulnerabilities(character) {
            const vulnerabilities = character.psychological_depth?.vulnerabilities;
            return vulnerabilities && Array.isArray(vulnerabilities) ?
                vulnerabilities.map(vul => translateToKorean(vul, 'vulnerabilities')).join(', ') : '-';
        }

        function getCharacterComfortLevel(character) {
            const level = character.psychological_depth?.boundaries?.comfort_level || '-';
            return level === '-' ? level : translateToKorean(level, 'comfort_level');
        }

        function getCharacterEscalationPace(character) {
            const pace = character.psychological_depth?.boundaries?.escalation_pace || '-';
            return pace === '-' ? pace : translateToKorean(pace, 'escalation_pace');
        }

        function getCharacterSexualToneBand(character) {
            const toneBand = character.psychological_depth?.boundaries?.sexual_tone_band || '-';
            return toneBand === '-' ? toneBand : translateToKorean(toneBand, 'sexual_tone_band');
        }

        function getCharacterSexualFreedom(character) {
            const value = character.psychological_depth?.sexual_freedom;
            return value ? `${value}/10` : '-';
        }

        function getCharacterFlirtingPatterns(character) {
            const patterns = character.conversation_dynamics?.flirting_patterns;
            return patterns && Array.isArray(patterns) ? patterns.join(', ') : '-';
        }

        function getCharacterHumorResponse(character) {
            return character.conversation_dynamics?.reaction_tendencies?.humor || '-';
        }

        function getCharacterComplimentResponse(character) {
            return character.conversation_dynamics?.reaction_tendencies?.compliment || '-';
        }

        function getCharacterInterestResponse(character) {
            return character.conversation_dynamics?.reaction_tendencies?.interest_expression || '-';
        }

        function getCharacterConversationHooks(character) {
            const hooks = character.conversation_dynamics?.conversation_hooks;
            return hooks && Array.isArray(hooks) ? hooks.join(', ') : '-';
        }

        function getCharacterSpeechStyleNew(character) {
            const style = character.conversation_dynamics?.speech_style || '-';
            return style === '-' ? style : translateToKorean(style, 'speech_style');
        }

        function getCharacterSpeechHabits(character) {
            const habits = character.conversation_dynamics?.speech_habits;
            if (habits && Array.isArray(habits) && habits.length > 0) {
                return habits.map(habit => translateToKorean(habit, 'speech_habits')).join(', ');
            }
            return habits ? translateToKorean(habits, 'speech_habits') : '-';
        }

        function getCharacterVocabularyRegister(character) {
            return character.conversation_dynamics?.vocabulary_register || '-';
        }

        function getCharacterAllowedMotifs(character) {
            const motifs = character.conversation_dynamics?.allowed_motifs;
            return motifs && Array.isArray(motifs) ? motifs.join(', ') : '-';
        }

        function getCharacterForbiddenTerms(character) {
            const terms = character.conversation_dynamics?.forbidden_terms;
            if (terms && Array.isArray(terms) && terms.length > 0) {
                return terms.map(term => translateToKorean(term, 'forbidden_terms')).join(', ');
            }
            return terms ? translateToKorean(terms, 'forbidden_terms') : '-';
        }

        // üÜï ÏÉàÎ°ú Ï∂îÍ∞ÄÎêú ÌïÑÎìúÎì§ÏùÑ ÏúÑÌïú getter Ìï®ÏàòÎì§
        function getCharacterHobbies(character) {
            const hobbies = character.appeal_profile?.hobbies;
            if (hobbies && Array.isArray(hobbies) && hobbies.length > 0) {
                return hobbies.map(hobby => translateToKorean(hobby, 'hobbies')).join(', ');
            }
            return '-';
        }

        function getCharacterValues(character) {
            const values = character.psychological_depth?.values || '-';
            return values === '-' ? values : translateToKorean(values, 'values');
        }

        function getCharacterSexualCuriosity(character) {
            const value = character.appeal_profile?.sexual_curiosity;
            return value ? `${value}/10` : '-';
        }

        function getCharacterSexualComfort(character) {
            const value = character.appeal_profile?.sexual_comfort;
            return value ? `${value}/10` : '-';
        }

        function getCharacterFeatureElements(character) {
            const features = character.physical_allure?.feature_elements;
            if (features && Array.isArray(features) && features.length > 0) {
                return features.map(feature => translateToKorean(feature, 'feature_elements')).join(', ');
            }
            return '-';
        }

        function getCharacterSensualHabits(character) {
            const habits = character.physical_allure?.sensual_habits;
            if (habits && Array.isArray(habits) && habits.length > 0) {
                return habits.map(habit => translateToKorean(habit, 'sensual_habits')).join(', ');
            }
            return '-';
        }

        function getCharacterBodyLanguage(character) {
            const bodyLanguage = character.physical_allure?.body_language;
            if (bodyLanguage && Array.isArray(bodyLanguage) && bodyLanguage.length > 0) {
                return bodyLanguage.map(lang => translateToKorean(lang, 'body_language')).join(', ');
            }
            return bodyLanguage ? translateToKorean(bodyLanguage, 'body_language') : '-';
        }

        function getCharacterPreferredSkinship(character) {
            const skinship = character.past_history?.preferred_skinship;
            if (skinship && Array.isArray(skinship) && skinship.length > 0) {
                return skinship.map(skin => translateToKorean(skin, 'preferred_skinship')).join(', ');
            }
            return skinship ? translateToKorean(skinship, 'preferred_skinship') : '-';
        }

        function getCharacterRelationshipExperience(character) {
            const exp = character.past_history?.relationship_experience || '-';
            const translations = {
                'beginner': 'Ï¥àÎ≥¥ (1-2Î≤à)',
                'intermediate': 'Î≥¥ÌÜµ (3-5Î≤à)',
                'experienced': 'Í≤ΩÌóò ÎßéÏùå (6-8Î≤à)',
                'very_experienced': 'Îß§Ïö∞ Í≤ΩÌóò ÎßéÏùå (9Î≤à Ïù¥ÏÉÅ)'
            };
            return translations[exp] || exp;
        }

        function getCharacterFirstExperienceAge(character) {
            const age = character.past_history?.first_experience_age || '-';
            const translations = {
                'early_teens': 'Ï§ëÌïôÍµê (13-15ÏÑ∏)',
                'late_teens': 'Í≥†Îì±ÌïôÍµê (16-18ÏÑ∏)',
                'early_twenties': 'ÎåÄÌïôÍµê Ï¥àÍ∏∞ (19-21ÏÑ∏)',
                'mid_twenties': 'ÎåÄÌïôÍµê ÌõÑÍ∏∞/ÏßÅÏû• Ï¥àÍ∏∞ (22-25ÏÑ∏)',
                'late_twenties': 'ÏßÅÏû•Ïù∏ (26-29ÏÑ∏)',
                'no_experience': 'Í≤ΩÌóò ÏóÜÏùå'
            };
            return translations[age] || age;
        }

        function getCharacterMalePriorities(character) {
            const priorities = character.male_priorities;
            if (!priorities || !Array.isArray(priorities) || priorities.length === 0) {
                return '-';
            }

            return priorities.map(priority => translateToKorean(priority, 'male_priorities')).join(', ');
        }

        function getCharacterBoyfriendCount(character) {
            const count = character.past_history?.boyfriend_count;
            return count !== undefined ? `${count}Î™Ö` : '-';
        }

        function getCharacterPreferredSkinship(character) {
            const skinship = character.past_history?.preferred_skinship;
            if (skinship && Array.isArray(skinship) && skinship.length > 0) {
                return skinship.map(skin => translateToKorean(skin, 'preferred_skinship')).join(', ');
            }
            return skinship ? translateToKorean(skinship, 'preferred_skinship') : '-';
        }

        function getCharacterRelationshipExperience(character) {
            const exp = character.past_history?.relationship_experience || 'unknown';
            return translateToKorean(exp, 'relationship_experience');
        }

        function getCharacterFirstExperienceAge(character) {
            const age = character.past_history?.first_experience_age || 'unknown';
            return translateToKorean(age, 'first_experience_age');
        }

        // üîß Í≥†Í∏â Î©îÌÉÄ ÏÑ§Ï†ï ÌÜ†Í∏Ä Ìï®ÏàòÎì§
        function toggleAdvancedMeta() {
            const section = document.getElementById('advancedMetaSection');
            const button = document.getElementById('advancedToggleBtn');

            if (section.style.display === 'none') {
                section.style.display = 'block';
                button.innerHTML = 'üîß Í≥†Í∏â Î©îÌÉÄ ÏÑ§Ï†ï Ïà®Í∏∞Í∏∞';
            } else {
                section.style.display = 'none';
                button.innerHTML = 'üîß Í≥†Í∏â Î©îÌÉÄ ÏÑ§Ï†ï Î≥¥Í∏∞';
            }
        }

        function hideAdvancedMeta() {
            document.getElementById('advancedMetaSection').style.display = 'none';
            document.getElementById('advancedToggleBtn').innerHTML = 'üîß Í≥†Í∏â Î©îÌÉÄ ÏÑ§Ï†ï Î≥¥Í∏∞';
        }

        // Ï†ÑÏó≠ Ìï®ÏàòÎ°ú Îì±Î°ù
        window.randomizeName = randomizeName;
        window.randomizeAge = randomizeAge;
        window.randomizeOccupation = randomizeOccupation;
        // window.randomizeSeduction = randomizeSeduction; // Ï†úÍ±∞Îê®
        window.randomizeCharms = randomizeCharms;
        window.randomizeEI = randomizeEI;
        window.randomizeConfidence = randomizeConfidence;
        window.randomizeMystery = randomizeMystery;
        window.randomizeSexualCuriosity = randomizeSexualCuriosity;
        window.randomizeSexualComfort = randomizeSexualComfort;
        window.randomizeHair = randomizeHair;
        window.randomizeEyes = randomizeEyes;
        window.randomizeBody = randomizeBody;
        window.randomizeBust = randomizeBust;
        window.randomizeWaistHip = randomizeWaistHip;
        window.randomizeStyle = randomizeStyle;
        window.randomizeAllFields = randomizeAllFields;
        window.randomizeAssetGoal = randomizeAssetGoal;
        window.randomizeFutureCareers = randomizeFutureCareers;
        window.resetAllFields = resetAllFields;
        window.toggleAdvancedMeta = toggleAdvancedMeta;
        window.hideAdvancedMeta = hideAdvancedMeta;

        // Ï¶âÏãú Ï¥àÍ∏∞Ìôî (DOMContentLoaded Ïù¥ÎØ∏ Î∞úÏÉùÌïú Í≤ΩÏö∞ ÎåÄÎπÑ)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeDeveloperMode);
        } else {
            initializeDeveloperMode();
        }

        // üî¨ ================ Ï†ïÌôïÎèÑ ÌÖåÏä§Ìä∏ ÏãúÏä§ÌÖú ================

        // ÌïúÍµ≠Ïñ¥ Î≤àÏó≠ Îß§Ìïë
        const koreanTranslations = {
            // Basic Info
            'student': 'ÌïôÏÉù',
            'female': 'Ïó¨ÏÑ±',

            // Education (ÌïôÎ†•)
            'high_school': 'Í≥†Îì±ÌïôÍµê Ï°∏ÏóÖ',
            'college_dropout': 'ÎåÄÌïôÍµê Ï§ëÌá¥',
            'college_graduate': 'ÎåÄÌïôÍµê Ï°∏ÏóÖ',
            'masters': 'ÏÑùÏÇ¨ Ï°∏ÏóÖ',
            'phd': 'Î∞ïÏÇ¨ Ï°∏ÏóÖ',
            'technical_school': 'Ï†ÑÎ¨∏ÌïôÍµê Ï°∏ÏóÖ',
            'art_school': 'ÏòàÏà†ÎåÄÌïô Ï°∏ÏóÖ',

            // Location (Í±∞Ï£ºÏßÄÏó≠)
            'gangnam': 'Í∞ïÎÇ®Íµ¨',
            'hongdae': 'ÌôçÎåÄ',
            'itaewon': 'Ïù¥ÌÉúÏõê',
            'jongno': 'Ï¢ÖÎ°úÍµ¨',
            'mapo': 'ÎßàÌè¨Íµ¨',
            'seocho': 'ÏÑúÏ¥àÍµ¨',
            'yongsan': 'Ïö©ÏÇ∞Íµ¨',

            // Hometown (Ï∂úÏã†ÏßÄÏó≠)
            'seoul': 'ÏÑúÏö∏',
            'busan': 'Î∂ÄÏÇ∞',
            'daegu': 'ÎåÄÍµ¨',
            'incheon': 'Ïù∏Ï≤ú',
            'gwangju': 'Í¥ëÏ£º',
            'daejeon': 'ÎåÄÏ†Ñ',
            'ulsan': 'Ïö∏ÏÇ∞',
            'jeju': 'Ï†úÏ£ºÎèÑ',

            // Family Structure (Í∞ÄÏ°±Íµ¨ÏÑ±)
            'nuclear_family': 'ÌïµÍ∞ÄÏ°±',
            'extended_family': 'ÎåÄÍ∞ÄÏ°±',
            'single_parent': 'ÌïúÎ∂ÄÎ™® Í∞ÄÏ†ï',
            'grandparents': 'Ï°∞Î∂ÄÎ™®ÎãòÍ≥º Ìï®Íªò',
            'alone': 'ÎèÖÍ±∞',
            'roommate': 'Î£∏Î©îÏù¥Ìä∏ÏôÄ Ìï®Íªò',

            // Pets (Î∞òÎ†§ÎèôÎ¨º)
            'dog': 'Í∞ïÏïÑÏßÄ',
            'cat': 'Í≥†ÏñëÏù¥',
            'hamster': 'ÌñÑÏä§ÌÑ∞',
            'bird': 'ÏÉà',
            'fish': 'Î¨ºÍ≥†Í∏∞',
            'rabbit': 'ÌÜ†ÎÅº',
            'none': 'ÏóÜÏùå',

            // Blood Type (ÌòàÏï°Ìòï)
            'A': 'AÌòï',
            'B': 'BÌòï',
            'AB': 'ABÌòï',
            'O': 'OÌòï',

            // Appeal Profile
            'warm_nurturing': 'Îî∞ÎúªÌïòÍ≥† Î∞∞Î†§Ïã¨ ÏûàÎäî',
            'infectious_smile': 'Ï†ÑÏóºÏÑ± ÏûàÎäî ÎØ∏ÏÜå',
            'witty_banter': 'Ïû¨ÏπòÏûàÎäî ÎåÄÌôî',
            'reading': 'ÎèÖÏÑú',
            'music': 'ÏùåÏïÖ',
            'movies': 'ÏòÅÌôî',

            // Physical Allure
            'ponytail': 'Ìè¨ÎãàÌÖåÏùº',
            'seductive_eyes': 'Îß§ÌòπÏ†ÅÏù∏ Îàà',
            'petite_sexy': 'ÏûëÍ≥† ÏÑπÏãúÌïú',
            'slim_waist': 'Ïä¨Î¶ºÌïú ÌóàÎ¶¨',

            // Conversation Dynamics
            'sultry_dominant': 'Í¥ÄÎä•Ï†ÅÏù¥Í≥† Ï£ºÎèÑÏ†ÅÏù∏',
            'subtle_teasing': 'ÏùÄÏùÄÌïú Ìã∞Ïßï',
            'playful_banter': 'Ïû•ÎÇúÏä§Îü¨Ïö¥ ÎåÄÌôî',
            'giggles_easily': 'ÏâΩÍ≤å ÏõÉÎäî',
            'gracefully_accepts': 'Ïö∞ÏïÑÌïòÍ≤å Î∞õÏïÑÎì§Ïù¥Îäî',
            'enthusiastic_sharing': 'Ïó¥Ï†ïÏ†ÅÏúºÎ°ú Í≥µÏú†ÌïòÎäî',
            'travel_stories': 'Ïó¨Ìñâ Ïù¥ÏïºÍ∏∞',
            'music_movies': 'ÏùåÏïÖÍ≥º ÏòÅÌôî',
            'polite_ending': 'Ï†ïÏ§ëÌïú Ïñ¥ÎØ∏',
            'frequent_emoji': 'ÏûêÏ£º Ïù¥Î™®Ìã∞ÏΩò ÏÇ¨Ïö©',
            'casual_friendly': 'Ï∫êÏ£ºÏñºÌïòÍ≥† ÏπúÍ∑ºÌïú',

            // Psychological Depth
            'meaningful_connection': 'ÏùòÎØ∏ÏûàÎäî Í¥ÄÍ≥Ñ',
            'personal_growth': 'Í∞úÏù∏Ï†Å ÏÑ±Ïû•',
            'perfectionism': 'ÏôÑÎ≤ΩÏ£ºÏùò',
            'commitment_fear': 'ÏïΩÏÜçÏóê ÎåÄÌïú ÎëêÎ†§ÏõÄ',
            'love_family': 'ÏÇ¨ÎûëÍ≥º Í∞ÄÏ°±',
            'light_flirtation': 'Í∞ÄÎ≤ºÏö¥ Ïä§ÌÇ®Ïã≠',
            'very_gradual': 'Îß§Ïö∞ Ï†êÏßÑÏ†ÅÏù∏',
            'moderate': 'Ï†ÅÎãπÌïú',

            // Past History
            'hand_holding': 'ÏÜêÏû°Í∏∞',
            'cheek_kiss': 'Î≥ºÌÇ§Ïä§',
            'beginner': 'Ï¥àÎ≥¥Ïûê',
            'early_teens': '10ÎåÄ Ï¥àÎ∞ò',

            // Gifts & Goals
            'flowers': 'ÍΩÉ',
            'chocolate': 'Ï¥àÏΩúÎ¶ø',
            'perfume': 'Ìñ•Ïàò',
            '1_billion': '10Ïñµ'
        };

        // Ï†ÑÏ≤¥ ÌïÑÎìú Ï†ïÌôïÎèÑ ÌÖåÏä§Ìä∏ Ìï®Ïàò
        async function testFullFieldAccuracy() {
            const targetSelect = document.getElementById('characterPromptTarget');
            const selectedCharacterId = targetSelect.value;

            if (!selectedCharacterId) {
                alert('üö® Î®ºÏ†Ä ÌÖåÏä§Ìä∏Ìï† Ï∫êÎ¶≠ÌÑ∞Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }

            const button = event.target;
            const originalText = button.textContent;

            try {
                // 1Ô∏è‚É£ Î≤ÑÌäº ÏÉÅÌÉú Î≥ÄÍ≤Ω
                button.textContent = 'üî¨ Ï†ïÌôïÎèÑ ÌÖåÏä§Ìä∏ Ï§ë...';
                button.disabled = true;

                // 2Ô∏è‚É£ Í≤∞Í≥º ÏòÅÏó≠ ÌëúÏãú
                const resultsDiv = document.getElementById('accuracyTestResults');
                const metricsDiv = document.getElementById('accuracyMetrics');
                const detailsDiv = document.getElementById('accuracyDetails');

                resultsDiv.style.display = 'block';
                metricsDiv.innerHTML = '‚è≥ Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...';
                detailsDiv.innerHTML = '';

                // 3Ô∏è‚É£ Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
                const charactersResponse = await fetch('/api/character-ai-generator?action=list_characters');
                const charactersData = await charactersResponse.json();

                if (!charactersData.success) {
                    throw new Error('Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ùÏùÑ Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
                }

                // Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞ ÌôïÏù∏ Î∞è Ï†ÅÏ†àÌïú Î∞©ÏãùÏúºÎ°ú Ï∞æÍ∏∞
                console.log('üîç Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞:', charactersData);

                let targetCharacter = null;

                // Î∞∞Ïó¥Ïù∏ Í≤ΩÏö∞
                if (Array.isArray(charactersData.characters)) {
                    targetCharacter = charactersData.characters.find(c => c.id === selectedCharacterId);
                }
                // Í∞ùÏ≤¥Ïù∏ Í≤ΩÏö∞ (ÌòÑÏû¨ Íµ¨Ï°∞)
                else if (charactersData.characters && typeof charactersData.characters === 'object') {
                    targetCharacter = charactersData.characters[selectedCharacterId];
                }
                // data ÌîÑÎ°úÌçºÌã∞Ïóê ÏûàÎäî Í≤ΩÏö∞
                else if (charactersData.data && typeof charactersData.data === 'object') {
                    targetCharacter = charactersData.data[selectedCharacterId];
                }

                console.log('üéØ Ï∞æÏùÄ Ï∫êÎ¶≠ÌÑ∞:', targetCharacter);

                if (!targetCharacter) {
                    throw new Error('ÏÑ†ÌÉùÎêú Ï∫êÎ¶≠ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                }

                metricsDiv.innerHTML = 'ü§ñ AI ÌîÑÎ°¨ÌîÑÌä∏ ÏÉùÏÑ± Ï§ë...';

                // 4Ô∏è‚É£ AI ÌîÑÎ°¨ÌîÑÌä∏ ÏÉùÏÑ±
                const model = document.getElementById('promptGenerationModel').value;
                const style = document.getElementById('promptStyle').value;
                const length = document.getElementById('promptLength').value;

                const promptResponse = await fetch('/api/character-ai-generator', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'generate_character_prompt',
                        character_data: targetCharacter,
                        model: model,
                        style: style,
                        length: length,
                        system_prompt: 'AI Ï∫êÎ¶≠ÌÑ∞ ÌîÑÎ°¨ÌîÑÌä∏Î•º ÏÉÅÏÑ∏ÌïòÍ≤å ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî. Ï†úÍ≥µÎêú Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥Î•º ÏûêÏó∞Ïä§ÎüΩÍ≤å Ìè¨Ìï®Ìï¥Ïïº Ìï©ÎãàÎã§.'
                    })
                });

                const promptData = await promptResponse.json();

                if (!promptData.success) {
                    throw new Error(promptData.message || 'AI ÌîÑÎ°¨ÌîÑÌä∏ ÏÉùÏÑ± Ïã§Ìå®');
                }

                metricsDiv.innerHTML = 'üìä Ï†ïÌôïÎèÑ Î∂ÑÏÑù Ï§ë...';

                // 5Ô∏è‚É£ Ï†ïÌôïÎèÑ Î∂ÑÏÑù
                const analysisResult = analyzeFieldAccuracy(targetCharacter, promptData.prompt);

                // 6Ô∏è‚É£ Í≤∞Í≥º ÌëúÏãú
                displayAccuracyResults(analysisResult, promptData, targetCharacter.basic_info?.name || 'ÌÖåÏä§Ìä∏ Ï∫êÎ¶≠ÌÑ∞');

            } catch (error) {
                console.error('‚ùå Ï†ïÌôïÎèÑ ÌÖåÏä§Ìä∏ Ïã§Ìå®:', error);

                const resultsDiv = document.getElementById('accuracyTestResults');
                const metricsDiv = document.getElementById('accuracyMetrics');

                resultsDiv.style.display = 'block';
                metricsDiv.innerHTML = `‚ùå ÌÖåÏä§Ìä∏ Ïã§Ìå®: ${error.message}`;

            } finally {
                // 7Ô∏è‚É£ Î≤ÑÌäº Î≥µÏõê
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        // ÌïÑÎìú Ï†ïÌôïÎèÑ Î∂ÑÏÑù Ìï®Ïàò
        function analyzeFieldAccuracy(characterData, generatedPrompt) {
            const allFields = extractAllFields(characterData);
            const results = [];
            let foundCount = 0;

            allFields.forEach((field, index) => {
                const found = checkValueInPrompt(generatedPrompt, field.value);
                const translation = Array.isArray(field.value)
                    ? field.value.map(v => koreanTranslations[v] || v).join(', ')
                    : koreanTranslations[field.value] || field.value;

                results.push({
                    index: index + 1,
                    path: field.path,
                    originalValue: field.value,
                    translation: translation,
                    found: found,
                    type: field.type
                });

                if (found) foundCount++;
            });

            const accuracy = Math.round((foundCount / allFields.length) * 100);

            return {
                totalFields: allFields.length,
                foundFields: foundCount,
                missingFields: allFields.length - foundCount,
                accuracy: accuracy,
                details: results,
                prompt: generatedPrompt
            };
        }

        // ÌïÑÎìúÍ∞íÏù¥ ÌîÑÎ°¨ÌîÑÌä∏Ïóê Ìè¨Ìï®ÎêòÏñ¥ ÏûàÎäîÏßÄ Í≤ÄÏÇ¨
        function checkValueInPrompt(prompt, value) {
            const promptLower = prompt.toLowerCase();

            if (Array.isArray(value)) {
                return value.some(v => checkValueInPrompt(prompt, v));
            }

            const original = String(value).toLowerCase();
            const translated = koreanTranslations[String(value)] ? koreanTranslations[String(value)].toLowerCase() : null;

            return promptLower.includes(original) || (translated && promptLower.includes(translated));
        }

        // Î™®Îì† ÌïÑÎìú Ï∂îÏ∂ú Ìï®Ïàò
        function extractAllFields(data, prefix = '') {
            const fields = [];

            for (const [key, value] of Object.entries(data)) {
                const fieldPath = prefix ? `${prefix}.${key}` : key;

                if (value && typeof value === 'object' && !Array.isArray(value)) {
                    fields.push(...extractAllFields(value, fieldPath));
                } else if (value !== null && value !== undefined && value !== '') {
                    if (Array.isArray(value) && value.length > 0) {
                        fields.push({ path: fieldPath, value: value, type: 'array' });
                    } else if (!Array.isArray(value)) {
                        fields.push({ path: fieldPath, value: value, type: 'single' });
                    }
                }
            }

            return fields;
        }

        // Í≤∞Í≥º ÌëúÏãú Ìï®Ïàò
        function displayAccuracyResults(analysis, promptData, characterName) {
            const metricsDiv = document.getElementById('accuracyMetrics');
            const detailsDiv = document.getElementById('accuracyDetails');

            // Î©îÌä∏Î¶≠ ÌëúÏãú
            const accuracyColor = analysis.accuracy >= 40 ? '#28a745' : analysis.accuracy >= 30 ? '#ffc107' : '#dc3545';
            const baselineComparison = analysis.accuracy >= 38 ? `+${analysis.accuracy - 38}%p` : `${analysis.accuracy - 38}%p`;

            metricsDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; text-align: center;">
                    <div>
                        <h4 style="margin: 0; color: ${accuracyColor}; font-size: 2em;">${analysis.accuracy}%</h4>
                        <p style="margin: 5px 0 0 0; color: #666;">Ï†ïÌôïÎèÑ</p>
                    </div>
                    <div>
                        <h4 style="margin: 0; color: #28a745; font-size: 1.8em;">${analysis.foundFields}/${analysis.totalFields}</h4>
                        <p style="margin: 5px 0 0 0; color: #666;">Î∞òÏòÅÎêú ÌïÑÎìú</p>
                    </div>
                    <div>
                        <h4 style="margin: 0; color: #667eea; font-size: 1.5em;">${baselineComparison}</h4>
                        <p style="margin: 5px 0 0 0; color: #666;">Fallback ÎåÄÎπÑ</p>
                    </div>
                    <div>
                        <h4 style="margin: 0; color: #20c997; font-size: 1.5em;">${promptData.prompt.length}Ïûê</h4>
                        <p style="margin: 5px 0 0 0; color: #666;">ÌîÑÎ°¨ÌîÑÌä∏ Í∏∏Ïù¥</p>
                    </div>
                </div>
                <div style="margin-top: 15px; text-align: center;">
                    <p style="margin: 0; font-weight: bold; color: #333;">
                        üéØ ${characterName} Ï∫êÎ¶≠ÌÑ∞ | Î™®Îç∏: ${promptData.model_used} | Ïä§ÌÉÄÏùº: ${promptData.style}
                    </p>
                </div>
            `;

            // ÏÑ∏Î∂Ä Í≤∞Í≥º ÌëúÏãú
            let detailsHtml = '=== Ï∫êÎ¶≠ÌÑ∞ ÌîÑÎ°¨ÌîÑÌä∏ Ï†ïÌôïÎèÑ ÌÖåÏä§Ìä∏ Í≤∞Í≥º ===\\n\\n';
            detailsHtml += `üìä Ï¥ù ÌïÑÎìú Ïàò: ${analysis.totalFields}Í∞ú\\n\\n`;
            detailsHtml += 'üìã ÌïÑÎìúÎ≥Ñ Í≤ÄÏ¶ù Í≤∞Í≥º:\\n\\n';

            analysis.details.forEach(detail => {
                const status = detail.found ? '‚úÖ Î∞òÏòÅÎê®' : '‚ùå Î∞òÏòÅÏïàÎê®';
                detailsHtml += `${detail.index}. ${detail.path}: "${detail.originalValue}" ‚Üí "${detail.translation}" ${status}\\n`;
            });

            detailsHtml += '\\n' + '='.repeat(60) + '\\n';
            detailsHtml += 'üìä ÏµúÏ¢Ö Î∂ÑÏÑù Í≤∞Í≥º\\n';
            detailsHtml += '='.repeat(60) + '\\n';
            detailsHtml += `‚úÖ Î∞òÏòÅÎêú ÌïÑÎìú: ${analysis.foundFields}Í∞ú\\n`;
            detailsHtml += `‚ùå Î∞òÏòÅÏïàÎêú ÌïÑÎìú: ${analysis.missingFields}Í∞ú\\n`;
            detailsHtml += `üìà Ï†ïÌôïÎèÑ: ${analysis.accuracy}% (${analysis.foundFields}/${analysis.totalFields})\\n`;
            detailsHtml += `üìä Fallback 38% ÎåÄÎπÑ: ${baselineComparison}\\n\\n`;

            // ÎàÑÎùΩ ÌïÑÎìú Î∂ÑÏÑù
            const missingFields = analysis.details.filter(d => !d.found);
            if (missingFields.length > 0) {
                detailsHtml += 'üîç Î∞òÏòÅÎêòÏßÄ ÏïäÏùÄ Ï£ºÏöî ÌïÑÎìúÎì§:\\n';
                missingFields.slice(0, 10).forEach((field, index) => {
                    detailsHtml += `${index + 1}. ${field.path}: "${field.originalValue}" (Î≤àÏó≠: "${field.translation}")\\n`;
                });
                if (missingFields.length > 10) {
                    detailsHtml += `... Ïô∏ ${missingFields.length - 10}Í∞ú Îçî\\n`;
                }
            }

            detailsHtml += '\\n‚ö° ÏÑ±Îä• Î∂ÑÏÑù:\\n';
            detailsHtml += `üìè ÌîÑÎ°¨ÌîÑÌä∏ Í∏∏Ïù¥: ${analysis.prompt.length}Ïûê\\n`;
            detailsHtml += 'üöÄ ÏùëÎãµ ÏÜçÎèÑ: ~3Ï¥à (Groq API)\\n';
            detailsHtml += 'üí∞ ÎπÑÏö© Ìö®Ïú®ÏÑ±: OpenAI ÎåÄÎπÑ ÏïΩ 10Î∞∞ Ï†ÄÎ†¥\\n\\n';
            detailsHtml += `‚ú® Í≤∞Î°†: ${analysis.accuracy >= 35 ? 'Ïö∞ÏàòÌïú' : analysis.accuracy >= 25 ? 'ÏñëÌò∏Ìïú' : 'Í∞úÏÑ† ÌïÑÏöîÌïú'} Ï†ïÌôïÎèÑÎ•º Î≥¥Ïó¨Ï§çÎãàÎã§!`;

            detailsDiv.innerHTML = detailsHtml.replace(/\\n/g, '<br>');
        }

        // Ï†ÑÏó≠ Ìï®ÏàòÎ°ú Îì±Î°ù
        window.testFullFieldAccuracy = testFullFieldAccuracy;

        // ================ AI ÏÜåÍ∞ú ÏàòÏ†ï Î™®Îã¨ Í¥ÄÎ†® Ìï®ÏàòÎì§ ================

        let currentEditingCharacterId = null;
        let originalAiPrompt = null;

        // AI ÏÜåÍ∞ú ÏàòÏ†ï Î™®Îã¨ Ïó¥Í∏∞
        function openAiPromptEditModal() {
            console.log('‚úèÔ∏è AI ÏÜåÍ∞ú ÏàòÏ†ï Î™®Îã¨ Ïó¥Í∏∞ ÏãúÏûë');

            const currentDetailCharacter = getCurrentDetailCharacter();
            if (!currentDetailCharacter) {
                console.error('‚ùå getCurrentDetailCharacter Í≤∞Í≥ºÍ∞Ä null');
                showNotification('Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
                return;
            }

            console.log('‚úÖ Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥ Ï∞æÏùå:', currentDetailCharacter.basic_info?.name);

            currentEditingCharacterId = currentDetailCharacter.id;
            originalAiPrompt = currentDetailCharacter.ai_prompt || '';

            // Î™®Îã¨ Ïó¥Í∏∞
            const modal = document.getElementById('aiPromptEditModal');
            const textarea = document.getElementById('aiPromptTextArea');

            textarea.value = originalAiPrompt;
            updateCharacterCount();

            modal.style.display = 'flex';
            textarea.focus();

            console.log('‚úèÔ∏è AI ÏÜåÍ∞ú ÏàòÏ†ï Î™®Îã¨ Ïó¥Î¶º:', currentDetailCharacter.basic_info.name);
        }

        // AI ÏÜåÍ∞ú ÏàòÏ†ï Î™®Îã¨ Îã´Í∏∞
        function closeAiPromptEditModal() {
            const modal = document.getElementById('aiPromptEditModal');
            modal.style.display = 'none';

            // Î≥ÄÏàò Ï¥àÍ∏∞Ìôî
            currentEditingCharacterId = null;
            originalAiPrompt = null;

            console.log('‚ùå AI ÏÜåÍ∞ú ÏàòÏ†ï Î™®Îã¨ Îã´Ìûò');
        }

        // Î¨∏Ïûê Ïàò ÏóÖÎç∞Ïù¥Ìä∏
        function updateCharacterCount() {
            const textarea = document.getElementById('aiPromptTextArea');
            const charCount = document.getElementById('charCount');

            if (textarea && charCount) {
                const count = textarea.value.length;
                charCount.textContent = `${count.toLocaleString()}Ïûê`;

                // Í∏∏Ïù¥Ïóê Îî∞Î•∏ ÏÉâÏÉÅ Î≥ÄÍ≤Ω
                if (count > 3000) {
                    charCount.style.color = '#28a745'; // Ï†ÅÏ†ï Í∏∏Ïù¥
                } else if (count > 1000) {
                    charCount.style.color = '#ffc107'; // Î≥¥ÌÜµ Í∏∏Ïù¥
                } else {
                    charCount.style.color = '#999'; // ÏßßÏùÄ Í∏∏Ïù¥
                }
            }
        }

        // AI ÏÜåÍ∞ú Î≥ÄÍ≤ΩÏÇ¨Ìï≠ Ï†ÄÏû•
        async function saveAiPromptChanges() {
            const textarea = document.getElementById('aiPromptTextArea');
            const newPrompt = textarea.value.trim();

            if (!newPrompt) {
                showNotification('AI ÏÜåÍ∞ú ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'warning');
                return;
            }

            if (!currentEditingCharacterId) {
                showNotification('ÏàòÏ†ïÌï† Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
                return;
            }

            try {
                console.log('üíæ AI ÏÜåÍ∞ú Ï†ÄÏû• ÏãúÏûë:', currentEditingCharacterId);

                // APIÎ°ú Ï†ÄÏû•
                const response = await fetch('/api/character-ai-generator', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'save_ai_prompt',
                        character_id: currentEditingCharacterId,
                        ai_prompt: newPrompt
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('‚úÖ AI ÏÜåÍ∞úÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!', 'success');

                    // Ï∫êÎ¶≠ÌÑ∞ ÏÉÅÏÑ∏ ÌôîÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏
                    const aiPromptText = document.getElementById('aiPromptText');
                    if (aiPromptText) {
                        aiPromptText.textContent = newPrompt;
                    }

                    // Î™®Îã¨ Îã´Í∏∞
                    closeAiPromptEditModal();

                    // Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                    await loadCharacters();

                    console.log('‚úÖ AI ÏÜåÍ∞ú Ï†ÄÏû• ÏôÑÎ£å');
                } else {
                    throw new Error(result.error || 'AI ÏÜåÍ∞ú Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }

            } catch (error) {
                console.error('‚ùå AI ÏÜåÍ∞ú Ï†ÄÏû• Ïã§Ìå®:', error);
                showNotification('‚ùå AI ÏÜåÍ∞ú Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message, 'error');
            }
        }

        // ÌòÑÏû¨ ÏÉÅÏÑ∏Î≥¥Í∏∞ Ï§ëÏù∏ Ï∫êÎ¶≠ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
        function getCurrentDetailCharacter() {
            // Ï†ÑÏó≠ Î≥ÄÏàòÎÇò Î™®Îã¨Ïùò Îç∞Ïù¥ÌÑ∞ ÏÜçÏÑ±ÏóêÏÑú ÌòÑÏû¨ Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
            const modal = document.getElementById('characterDetailModal');
            if (modal && modal.dataset.characterId) {
                const characterId = modal.dataset.characterId;
                console.log('üîç Ï∫êÎ¶≠ÌÑ∞ ID Í≤ÄÏÉâ Ï§ë:', characterId);

                // characters Ï†ÑÏó≠ Î≥ÄÏàòÏóêÏÑú Ìï¥Îãπ Ï∫êÎ¶≠ÌÑ∞ Ï∞æÍ∏∞
                if (typeof characters !== 'undefined') {
                    console.log('üîç characters Ï†ÑÏó≠ Î≥ÄÏàò Íµ¨Ï°∞:', characters);

                    // v4.1.0 Íµ¨Ï°∞ ÏßÄÏõê: characters.characters ÎòêÎäî ÏßÅÏ†ë characters
                    let charactersData = null;
                    if (characters && characters.characters) {
                        charactersData = characters.characters;
                        console.log('üîç v4.1.0 Íµ¨Ï°∞ ÏÇ¨Ïö©: characters.characters');
                    } else if (characters) {
                        charactersData = characters;
                        console.log('üîç ÏßÅÏ†ë Íµ¨Ï°∞ ÏÇ¨Ïö©: characters');
                    }

                    if (charactersData) {
                        if (Array.isArray(charactersData)) {
                            const found = charactersData.find(char => char.id === characterId);
                            console.log('üîç Î∞∞Ïó¥ÏóêÏÑú Í≤ÄÏÉâ Í≤∞Í≥º:', found ? 'Ï∞æÏùå' : 'ÏóÜÏùå');
                            return found;
                        } else {
                            const found = charactersData[characterId];
                            console.log('üîç Í∞ùÏ≤¥ÏóêÏÑú Í≤ÄÏÉâ Í≤∞Í≥º:', found ? 'Ï∞æÏùå' : 'ÏóÜÏùå');
                            return found;
                        }
                    }
                }

                console.error('‚ùå characters Ï†ÑÏó≠ Î≥ÄÏàòÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå');
            } else {
                console.error('‚ùå Î™®Îã¨ ÎòêÎäî characterIdÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå');
            }
            return null;
        }

        // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('aiPromptEditModal');
            if (event.target === modal) {
                closeAiPromptEditModal();
            }
        });

        // ESC ÌÇ§Î°ú Î™®Îã¨ Îã´Í∏∞
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('aiPromptEditModal');
                if (modal.style.display === 'flex') {
                    closeAiPromptEditModal();
                }
            }
        });

    </script>

    <!-- üì∏ Ï∫êÎ¶≠ÌÑ∞ ÏÇ¨ÏßÑ Í¥ÄÎ¶¨ Î™®Îã¨ -->
    <div id="photoManagerModal" class="modal">
        <div class="modal-content photo-manager-modal">
            <div class="modal-header">
                <span class="close" onclick="closeModal('photoManagerModal')">&times;</span>
                <h2 id="photoManagerTitle">üì∏ <span id="characterPhotoName">Ï∫êÎ¶≠ÌÑ∞</span> ÏÇ¨ÏßÑ Í¥ÄÎ¶¨</h2>
                <p style="text-align: center; color: #666; margin-top: 5px;">
                    Ïπ¥ÌÖåÍ≥†Î¶¨Î≥ÑÎ°ú ÏÇ¨ÏßÑÏùÑ ÏóÖÎ°úÎìúÌïòÏó¨ Îã§ÏñëÌïú Í≤åÏûÑ ÏÉÅÌô©Ïóê ÌôúÏö©ÌïòÏÑ∏Ïöî ‚ú®
                </p>
            </div>
            <div class="modal-body">
                <div class="photo-manager-container">
                    <!-- ÏÇ¨ÏßÑ ÏóÖÎ°úÎìú ÏÉÅÌÉú ÌëúÏãú -->
                    <div class="photo-status-bar">
                        <div class="photo-stats">
                            <span id="totalPhotoCount">Ï¥ù 0Ïû•</span> |
                            <span id="totalPhotoSize">Ïö©Îüâ: 0KB</span> |
                            <span id="remainingSlots">ÎÇ®ÏùÄ Ïä¨Î°Ø: 20Í∞ú</span>
                        </div>
                    </div>

                    <!-- ÏÇ¨ÏßÑ Ïπ¥ÌÖåÍ≥†Î¶¨Îì§ -->
                    <div class="photo-categories-container">
                        <!-- ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ -->
                        <div class="photo-category-section">
                            <div class="category-header">
                                <h3>üìã ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ</h3>
                                <span class="category-limit">(1Ïû•)</span>
                            </div>
                            <div class="photo-upload-zone" data-category="profile">
                                <input type="file" id="profilePhotoInput" accept="image/*" style="display: none;">
                                <div class="upload-placeholder" onclick="document.getElementById('profilePhotoInput').click()">
                                    <div class="upload-icon">üì∑</div>
                                    <p>Î©îÏù∏ ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ ÏóÖÎ°úÎìú</p>
                                    <small>JPG, PNG, WEBP (ÏµúÎåÄ 3MB)</small>
                                </div>
                                <div class="photo-preview-container" id="profilePhotoContainer"></div>
                            </div>
                        </div>

                        <!-- ÏùºÏÉÅ ÏÇ¨ÏßÑÎì§ -->
                        <div class="photo-category-section">
                            <div class="category-header">
                                <h3>üòä ÏùºÏÉÅ ÏÇ¨ÏßÑ</h3>
                                <span class="category-limit">(ÏµúÎåÄ 5Ïû•)</span>
                            </div>
                            <div class="photo-upload-zone" data-category="casual">
                                <input type="file" id="casualPhotoInput" accept="image/*" multiple style="display: none;">
                                <div class="upload-placeholder" onclick="document.getElementById('casualPhotoInput').click()">
                                    <div class="upload-icon">üì∑</div>
                                    <p>ÏùºÏÉÅÏ†ÅÏù∏ Î™®Ïäµ ÏÇ¨ÏßÑ ÏóÖÎ°úÎìú</p>
                                    <small>ÏµúÎåÄ 5Ïû•, Í∞ÅÍ∞Å 3MB Ïù¥Ìïò</small>
                                </div>
                                <div class="photo-grid" id="casualPhotoGrid"></div>
                            </div>
                        </div>

                        <!-- Î°úÎß®Ìã± ÏÇ¨ÏßÑÎì§ -->
                        <div class="photo-category-section">
                            <div class="category-header">
                                <h3>üíï Î°úÎß®Ìã± ÏÇ¨ÏßÑ</h3>
                                <span class="category-limit">(ÏµúÎåÄ 5Ïû•)</span>
                            </div>
                            <div class="photo-upload-zone" data-category="romantic">
                                <input type="file" id="romanticPhotoInput" accept="image/*" multiple style="display: none;">
                                <div class="upload-placeholder" onclick="document.getElementById('romanticPhotoInput').click()">
                                    <div class="upload-icon">üì∑</div>
                                    <p>Î°úÎß®Ìã±Ìïú ÏàúÍ∞Ñ ÏÇ¨ÏßÑ ÏóÖÎ°úÎìú</p>
                                    <small>ÏµúÎåÄ 5Ïû•, Í∞ÅÍ∞Å 3MB Ïù¥Ìïò</small>
                                </div>
                                <div class="photo-grid" id="romanticPhotoGrid"></div>
                            </div>
                        </div>

                        <!-- Í∞êÏ†ï ÌëúÌòÑ ÏÇ¨ÏßÑÎì§ -->
                        <div class="photo-category-section">
                            <div class="category-header">
                                <h3>üòç Í∞êÏ†ï ÌëúÌòÑ ÏÇ¨ÏßÑ</h3>
                                <span class="category-limit">(ÏµúÎåÄ 5Ïû•)</span>
                            </div>
                            <div class="photo-upload-zone" data-category="emotional">
                                <input type="file" id="emotionalPhotoInput" accept="image/*" multiple style="display: none;">
                                <div class="upload-placeholder" onclick="document.getElementById('emotionalPhotoInput').click()">
                                    <div class="upload-icon">üì∑</div>
                                    <p>Îã§ÏñëÌïú Í∞êÏ†ï ÌëúÌòÑ ÏÇ¨ÏßÑ ÏóÖÎ°úÎìú</p>
                                    <small>ÏµúÎåÄ 5Ïû•, Í∞ÅÍ∞Å 3MB Ïù¥Ìïò</small>
                                </div>
                                <div class="photo-grid" id="emotionalPhotoGrid"></div>
                            </div>
                        </div>

                        <!-- ÌäπÎ≥ÑÌïú ÏàúÍ∞Ñ ÏÇ¨ÏßÑÎì§ -->
                        <div class="photo-category-section">
                            <div class="category-header">
                                <h3>‚ú® ÌäπÎ≥ÑÌïú ÏàúÍ∞Ñ</h3>
                                <span class="category-limit">(ÏµúÎåÄ 4Ïû•)</span>
                            </div>
                            <div class="photo-upload-zone" data-category="special">
                                <input type="file" id="specialPhotoInput" accept="image/*" multiple style="display: none;">
                                <div class="upload-placeholder" onclick="document.getElementById('specialPhotoInput').click()">
                                    <div class="upload-icon">üì∑</div>
                                    <p>ÌäπÎ≥ÑÌïú Ïù¥Î≤§Ìä∏ÎÇò ÏàúÍ∞Ñ ÏÇ¨ÏßÑ ÏóÖÎ°úÎìú</p>
                                    <small>ÏµúÎåÄ 4Ïû•, Í∞ÅÍ∞Å 3MB Ïù¥Ìïò</small>
                                </div>
                                <div class="photo-grid" id="specialPhotoGrid"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Í¥ÄÎ¶¨ Î≤ÑÌäºÎì§ -->
                    <div class="photo-management-actions">
                        <button class="btn btn-secondary" onclick="clearAllCharacterPhotos()">
                            üóëÔ∏è Î™®Îì† ÏÇ¨ÏßÑ ÏÇ≠Ï†ú
                        </button>
                        <button class="btn btn-primary" onclick="previewCharacterPhotos()">
                            üëÅÔ∏è Ï†ÑÏ≤¥ ÎØ∏Î¶¨Î≥¥Í∏∞
                        </button>
                        <button class="btn btn-success" onclick="savePhotoChanges()">
                            üíæ Î≥ÄÍ≤ΩÏÇ¨Ìï≠ Ï†ÄÏû•
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI ÏÜåÍ∞ú ÏàòÏ†ï Î™®Îã¨ -->
    <div id="aiPromptEditModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div class="modal-content" style="background: white; border-radius: 15px; padding: 0; width: 90%; max-width: 800px; max-height: 90vh; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px 15px 0 0;">
                <h2 style="margin: 0; font-size: 1.5em;">‚úèÔ∏è AI ÏÜåÍ∞ú ÏàòÏ†ï</h2>
                <button class="close-btn" onclick="closeAiPromptEditModal()" style="position: absolute; top: 15px; right: 20px; background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">√ó</button>
            </div>
            <div class="modal-body" style="padding: 20px; max-height: 60vh; overflow-y: auto;">
                <div style="margin-bottom: 20px;">
                    <label for="aiPromptTextArea" style="display: block; margin-bottom: 10px; font-weight: bold; color: #333;">AI ÏÜåÍ∞ú ÎÇ¥Ïö©:</label>
                    <textarea id="aiPromptTextArea"
                              style="width: 100%; height: 400px; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-family: 'Noto Sans KR', sans-serif; font-size: 14px; line-height: 1.6; resize: vertical; outline: none; transition: border-color 0.3s;"
                              placeholder="AI ÏÜåÍ∞ú ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÍ±∞ÎÇò ÏàòÏ†ïÌïòÏÑ∏Ïöî..."
                              onkeyup="updateCharacterCount()"></textarea>
                    <div style="margin-top: 8px; display: flex; justify-content: space-between; align-items: center;">
                        <small style="color: #666;">ÏπúÍµ¨Í∞Ä ÏπúÍµ¨Î•º ÏÜåÍ∞úÌïòÎäî ÏûêÏó∞Ïä§Îü¨Ïö¥ ÎäêÎÇåÏúºÎ°ú ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî</small>
                        <small id="charCount" style="color: #999;">0Ïûê</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="padding: 20px; border-top: 1px solid #eee; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeAiPromptEditModal()" style="padding: 10px 20px; border: 1px solid #ddd; background: #f8f9fa; color: #333; border-radius: 6px; cursor: pointer; font-size: 14px;">
                    ‚ùå Ï∑®ÏÜå
                </button>
                <button class="btn btn-primary" onclick="saveAiPromptChanges()" style="padding: 10px 20px; border: none; background: #007bff; color: white; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;">
                    üíæ Ï†ÄÏû•
                </button>
            </div>
        </div>
    </div>

</body>
</html>