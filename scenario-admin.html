<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåê Ïò®ÎùºÏù∏ Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú - Ï±ÑÌåÖ Í∏∞Ïà† ÌõàÎ†®</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .admin-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        /* ÌÉ≠ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò */
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .nav-tab {
            flex: 1;
            padding: 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .nav-tab:hover:not(.active) {
            background: #e9ecef;
        }

        .nav-tab .badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #e74c3c;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }

        /* ÏΩòÌÖêÏ∏† ÏÑπÏÖò */
        .content-section {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            animation: fadeIn 0.3s ease;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ÌÜµÍ≥Ñ Ïπ¥Îìú */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .stat-card h3 {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .stat-card .value {
            color: #2c3e50;
            font-size: 2em;
            font-weight: bold;
        }

        /* Ïï°ÏÖò Î≤ÑÌäº */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.4);
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }

        /* ÏòàÏãú ÏãúÏä§ÌÖú Ïä§ÌÉÄÏùº */
        .examples-container {
            margin-top: 8px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        .examples-label {
            font-size: 12px;
            color: #6c757d;
            font-weight: 500;
            margin-bottom: 8px;
            display: block;
        }
        .examples-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .example-tag {
            display: inline-block;
            padding: 4px 8px;
            background: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 12px;
            font-size: 11px;
            color: #495057;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            line-height: 1.2;
        }
        .example-tag:hover {
            background: #007bff;
            color: white;
            border-color: #007bff;
            transform: translateY(-1px);
        }
        .example-tag.selected {
            background: #28a745;
            color: white;
            border-color: #28a745;
            transform: scale(0.95);
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        /* ÏãúÎÇòÎ¶¨Ïò§ Í∑∏Î¶¨Îìú */
        .scenarios-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .scenario-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            border: 2px solid transparent;
        }

        .scenario-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border-color: #667eea;
        }

        .scenario-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .scenario-card .description {
            color: #7f8c8d;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .scenario-card .metadata {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tag {
            background: #f0f2ff;
            color: #667eea;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.85em;
        }

        .scenario-card .actions {
            display: flex;
            gap: 10px;
        }

        .scenario-card .actions button {
            flex: 1;
            padding: 8px;
            font-size: 0.9em;
        }

        /* ÎåÄÌôî Í∑∏Î¶¨Îìú */
        .dialogues-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .dialogue-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 2px solid transparent;
        }

        .dialogue-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            border-color: #667eea;
        }

        .dialogue-card.empty {
            border: 2px dashed #e0e0e0;
            background: #fafafa;
        }

        .dialogue-card.empty:hover {
            border-color: #667eea;
            background: white;
        }

        .dialogue-card .dialogue-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .dialogue-card.completed {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: white;
        }

        .dialogue-card.completed .dialogue-number {
            color: white;
        }

        /* ÏóêÌîºÏÜåÎìú Ïπ¥Îìú Ïä§ÌÉÄÏùº (ÏãúÎÇòÎ¶¨Ïò§ Ïπ¥ÎìúÏôÄ Íµ¨Î∂Ñ) */
        .episode-card {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
            border: 2px solid #ff6b9d;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(255, 107, 157, 0.2);
            position: relative;
            overflow: hidden;
        }

        .episode-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 107, 157, 0.3);
            border-color: #ff4081;
        }

        .episode-card .dialogue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .episode-card .dialogue-number {
            background: rgba(255, 255, 255, 0.9);
            color: #ff4081;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.1em;
        }

        .episode-card .difficulty-badge {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
            color: white;
        }

        .episode-card .difficulty-badge.easy {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .episode-card .difficulty-badge.medium {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .episode-card .difficulty-badge.hard {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .episode-card .difficulty-badge.expert {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .episode-card .dialogue-content {
            margin-bottom: 15px;
        }

        .episode-card .character-info {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.7);
            padding: 10px;
            border-radius: 10px;
        }

        .episode-card .character-icon {
            font-size: 1.3em;
            margin-right: 8px;
        }

        .episode-card .character-name {
            font-weight: 600;
            color: #333;
        }

        .episode-card .dialogue-status {
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.8);
            padding: 8px;
            border-radius: 8px;
        }

        .episode-card .status-icon {
            margin-right: 5px;
            font-size: 1.1em;
        }

        .episode-card .status-text {
            font-weight: 500;
            color: #27ae60;
        }

        .episode-card .dialogue-actions {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }

        .episode-card .action-btn {
            background: rgba(255, 255, 255, 0.9);
            color: #ff4081;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .episode-card .action-btn:hover {
            background: white;
            border-color: #ff4081;
            transform: scale(1.05);
        }

        /* ÏóêÌîºÏÜåÎìú Í∑∏Î¶¨Îìú Î†àÏù¥ÏïÑÏõÉ */
        .episodes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        /* ÏóêÌîºÏÜåÎìú Î¶¨Ïä§Ìä∏ Ïπ¥Îìú Ïä§ÌÉÄÏùº (ÏãúÎÇòÎ¶¨Ïò§+Ï∫êÎ¶≠ÌÑ∞ Ï°∞Ìï©) */
        .episodes-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .episode-list-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 2px solid #5a67d8;
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(90, 103, 216, 0.2);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .episode-list-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(90, 103, 216, 0.3);
            border-color: #4c51bf;
        }

        .episode-list-card .episode-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .episode-list-card .episode-title {
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .episode-list-card .episode-subtitle {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .episode-list-card .episode-badge {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        .episode-list-card .episode-content {
            margin-bottom: 20px;
        }

        .episode-list-card .character-info {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            background: rgba(255, 255, 255, 0.15);
            padding: 12px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .episode-list-card .character-avatar {
            font-size: 1.5em;
            margin-right: 12px;
        }

        .episode-list-card .character-details {
            flex: 1;
        }

        .episode-list-card .character-name {
            font-weight: 600;
            font-size: 1.1em;
        }

        .episode-list-card .character-mbti {
            font-size: 0.85em;
            opacity: 0.9;
        }

        .episode-list-card .episode-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .episode-list-card .stat-item {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 8px;
            backdrop-filter: blur(5px);
        }

        .episode-list-card .stat-number {
            font-size: 1.2em;
            font-weight: 700;
            display: block;
        }

        .episode-list-card .stat-label {
            font-size: 0.75em;
            opacity: 0.8;
        }

        .episode-list-card .episode-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .episode-list-card .action-btn {
            background: rgba(255, 255, 255, 0.9);
            color: #5a67d8;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9em;
            font-weight: 600;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .episode-list-card .action-btn:hover {
            background: white;
            border-color: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .episode-list-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            transition: all 0.5s ease;
            opacity: 0;
        }

        .episode-list-card:hover::before {
            animation: shimmer 1s ease-in-out;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); opacity: 0; }
        }

        /* ÏóêÌîºÏÜåÎìú ÎåÄÌôî Ïπ¥Îìú Ïä§ÌÉÄÏùº (ÏÉùÏÑ±Îêú ÎåÄÌôî ÌëúÏãúÏö©) */
        .episode-dialogue-card {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border: 2px solid #5ee7df;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(94, 231, 223, 0.2);
            min-height: 150px;
            display: flex;
            flex-direction: column;
        }

        .episode-dialogue-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(94, 231, 223, 0.3);
            border-color: #4dd5cb;
        }

        .episode-dialogue-card .dialogue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .episode-dialogue-card .dialogue-number {
            background: rgba(255, 255, 255, 0.9);
            color: #20a39e;
            padding: 6px 12px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .episode-dialogue-card .difficulty-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            color: white;
        }

        .episode-dialogue-card .dialogue-content {
            flex: 1;
            margin-bottom: 12px;
        }

        .episode-dialogue-card .dialogue-preview {
            background: rgba(255, 255, 255, 0.8);
            padding: 12px;
            border-radius: 8px;
            font-size: 0.9em;
            line-height: 1.4;
            color: #333;
            margin-bottom: 10px;
            min-height: 60px;
        }

        .episode-dialogue-card .dialogue-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: #666;
        }

        .episode-dialogue-card .dialogue-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .episode-dialogue-card .action-btn {
            background: rgba(255, 255, 255, 0.9);
            color: #20a39e;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .episode-dialogue-card .action-btn:hover {
            background: white;
            border-color: #20a39e;
            transform: scale(1.05);
        }

        .delete-episode-btn {
            background: rgba(255, 77, 77, 0.1);
            border: 2px solid #ff4d4d;
            color: #ff4d4d;
            padding: 6px 10px;
            border-radius: 50%;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-left: 8px;
        }

        .delete-episode-btn:hover {
            background: #ff4d4d;
            color: white;
            transform: scale(1.1);
        }

        /* + Î≤ÑÌäº Ïπ¥Îìú Ïä§ÌÉÄÏùº */
        .add-dialogue-card {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            border: 3px dashed #ff6b9d;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .add-dialogue-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 107, 157, 0.3);
            border-color: #ff4081;
            background: linear-gradient(135deg, #ff8a95 0%, #ffc3ee 100%);
        }

        .add-dialogue-card .add-icon {
            font-size: 3em;
            color: white;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .add-dialogue-card .add-text {
            color: white;
            font-weight: 600;
            font-size: 1.1em;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        /* ÎÇúÏù¥ÎèÑ ÌÉ≠ */
        .difficulty-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }

        .difficulty-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .difficulty-tab:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .difficulty-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: transparent;
        }

        /* Ï∫êÎ¶≠ÌÑ∞ Í∑∏Î¶¨Îìú */
        .characters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .character-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .character-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border-color: #667eea;
        }

        .character-image {
            width: 80px;
            height: 80px;
            margin-bottom: 15px;
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .character-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .character-image .no-image {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            border-radius: 50%;
        }

        .character-info {
            text-align: center;
            width: 100%;
        }

        .character-card .mbti {
            display: inline-block;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 0.85em;
        }

        .character-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .character-card .traits {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        /* Î™®Îã¨ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 20px auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 95vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }

        /* Ïä§ÌÅ¨Î°§Î∞î Ïä§ÌÉÄÏùº Í∞úÏÑ† */
        .modal-content::-webkit-scrollbar,
        .dialogue-container::-webkit-scrollbar,
        .choices-container::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-track,
        .dialogue-container::-webkit-scrollbar-track,
        .choices-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb,
        .dialogue-container::-webkit-scrollbar-thumb,
        .choices-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover,
        .dialogue-container::-webkit-scrollbar-thumb:hover,
        .choices-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 15px 15px 0 0;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5em;
        }

        .modal-body {
            padding: 25px 30px 35px 30px;
            max-height: calc(95vh - 140px);
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .modal-footer {
            background: #f5f5f5;
            padding: 20px 30px;
            border-radius: 0 0 15px 15px;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

        .close {
            color: white;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }

        .close:hover {
            opacity: 1;
        }

        /* AI Ïª®ÌÖçÏä§Ìä∏ */
        .ai-context {
            background: #f8f9ff;
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            min-height: 100px;
        }

        /* Í∏∞Ï°¥ Ïª®ÌÖçÏä§Ìä∏ ÌëúÏãú */
        .existing-context {
            background: #f0f8ff;
            border: 2px solid #4a90e2;
            border-radius: 8px;
            padding: 0;
            overflow: hidden;
        }

        .context-header {
            background: #4a90e2;
            color: white;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }

        .context-label {
            font-size: 14px;
        }

        .context-date {
            font-size: 12px;
            opacity: 0.9;
        }

        .context-content {
            padding: 15px;
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        /* Ïª®ÌÖçÏä§Ìä∏ ÏóÜÏùå ÌëúÏãú */
        .no-context {
            background: #fff9e6;
            border: 2px dashed #f39c12;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .no-context-message {
            color: #e67e22;
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .no-context-help {
            color: #8e6a00;
            font-size: 14px;
        }

        /* ÎåÄÌôî ÎØ∏Î¶¨Î≥¥Í∏∞ */
        .dialogue-preview {
            background: #f8f9ff;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .dialogue-text {
            color: #2c3e50;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .narration-text {
            color: #7f8c8d;
            font-style: italic;
            margin-bottom: 15px;
        }

        .choices-list {
            list-style: none;
        }

        .choice-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .choice-item .impact {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 15px;
            font-size: 0.85em;
        }

        /* Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉùÍ∏∞ */
        .character-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .character-option {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .character-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .character-option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        /* Î°úÎî© */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Îπà ÏÉÅÌÉú */
        .empty-state {
            text-align: center;
            padding: 60px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 2px dashed #e0e0e0;
        }

        .empty-state h3 {
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        .empty-state p {
            color: #95a5a6;
            margin-bottom: 30px;
        }

        /* ÏßÑÌñâÎ∞î */
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }

        /* Î∞òÏùëÌòï */
        @media (max-width: 768px) {
            .dialogues-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .scenarios-grid {
                grid-template-columns: 1fr;
            }
            
            .characters-grid {
                grid-template-columns: 1fr;
            }
        }

        /* AI Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú Ïä§ÌÉÄÏùº */
        .ai-tuning-container {
            margin-top: 30px;
        }

        .ai-tuning-container h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .tuning-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid #667eea;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }

        .tuning-section h4 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tuning-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        /* Ï†ïÎ≥¥ ÌëúÏãúÏö© Ïä§ÌÉÄÏùº */
        .info-display {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .info-title {
            font-weight: bold;
            color: #495057;
            font-size: 1.1em;
            margin-bottom: 8px;
        }

        .info-character {
            color: #6c757d;
            font-size: 0.95em;
        }

        .tuning-controls .form-group {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .tuning-controls .form-group label {
            display: block;
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .tuning-controls .form-group select {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: white;
            font-size: 0.95em;
            transition: all 0.3s ease;
        }

        .tuning-controls .form-group select:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-help {
            display: block;
            color: #6c757d;
            font-size: 0.85em;
            margin-top: 5px;
            line-height: 1.4;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin: 30px 0;
            justify-content: center;
            flex-wrap: wrap;
        }

        .test-results {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #28a745;
        }

        .test-results h4 {
            color: #495057;
            margin-bottom: 15px;
        }

        .ai-performance-log {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
        }

        .ai-performance-log h4 {
            color: #495057;
            margin-bottom: 15px;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
        }

        .log-entry {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.9em;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-time {
            color: #6c757d;
            font-weight: 600;
            min-width: 50px;
        }

        .log-type {
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.8em;
            font-weight: 600;
            min-width: 80px;
            text-align: center;
        }

        .log-type.success {
            background: #d1ecf1;
            color: #0c5460;
        }

        .log-type.info {
            background: #d4edda;
            color: #155724;
        }

        .log-type.warning {
            background: #fff3cd;
            color: #856404;
        }

        .log-message {
            color: #495057;
            flex: 1;
        }

        /* AI Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±Í∏∞ Ï†ÑÏö© Ïä§ÌÉÄÏùº */
        .ai-character-generator .modal-content {
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* üé≠ Ï∫êÎ¶≠ÌÑ∞ ÏöîÏïΩ ÏÑπÏÖò Ïä§ÌÉÄÏùº */
        .character-summary-section {
            margin-bottom: 25px;
            padding: 20px;
            border: 2px solid #17a2b8;
            border-radius: 15px;
            background: linear-gradient(135deg, #e8f7fa 0%, #f0f9fc 100%);
            box-shadow: 0 3px 10px rgba(23, 162, 184, 0.15);
        }

        .character-summary-section h3 {
            color: #17a2b8;
            margin-bottom: 15px;
            font-size: 1.3em;
            font-weight: bold;
            text-align: center;
        }

        .current-character-display {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .summary-item {
            display: flex;
            flex-direction: column;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid #17a2b8;
        }

        .summary-label {
            font-size: 0.85em;
            font-weight: bold;
            color: #17a2b8;
            margin-bottom: 4px;
        }

        .summary-value {
            font-size: 0.95em;
            color: #333;
            font-weight: 500;
        }

        .summary-details {
            margin-bottom: 15px;
        }

        .summary-row {
            display: flex;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .summary-row:last-child {
            border-bottom: none;
        }

        .summary-row .summary-label {
            min-width: 80px;
            color: #17a2b8;
            font-weight: bold;
            margin-right: 10px;
        }

        .summary-row .summary-value {
            flex: 1;
            color: #333;
        }

        .summary-actions {
            text-align: center;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .summary-details.collapsed {
            display: none;
        }

        .char-category {
            margin-bottom: 20px;
            padding: 25px;
            border: 2px solid #e1e5e9;
            border-radius: 20px;
            background: linear-gradient(135deg, #fdf7f9 0%, #fef9fc 100%);
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .char-category:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .char-category h3 {
            color: #d63384;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: bold;
        }

        .category-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        .appearance-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .genre-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* MBTI ÏÑ†ÌÉù Î≤ÑÌäº */
        .mbti-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .mbti-btn {
            padding: 15px 10px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .mbti-btn:hover {
            border-color: #d63384;
            background: #fdf2f8;
        }

        .mbti-btn.selected {
            border-color: #d63384;
            background: #d63384;
            color: white;
        }

        .mbti-btn small {
            display: block;
            font-size: 11px;
            font-weight: normal;
            opacity: 0.8;
        }

        /* ÏÑ±Í≤© ÌäπÏÑ± Î≤ÑÌäº */
        .trait-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .trait-btn {
            padding: 10px 8px;
            border: 1px solid #dee2e6;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            font-size: 13px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .trait-btn:hover {
            border-color: #fd7e14;
            background: #fff3cd;
        }

        .trait-btn.selected {
            border-color: #fd7e14;
            background: #fd7e14;
            color: white;
        }

        /* Í¥ÄÍ≥Ñ ÏÑ§Ï†ï Î≤ÑÌäº */
        .relationship-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .relationship-btn {
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }

        .relationship-btn:hover {
            border-color: #e83e8c;
            background: #f8d7da;
        }

        .relationship-btn.selected {
            border-color: #e83e8c;
            background: #e83e8c;
            color: white;
        }

        /* Ï∑®ÎØ∏ ÏÑ†ÌÉù Î≤ÑÌäº */
        .hobby-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .hobby-btn {
            padding: 10px 8px;
            border: 1px solid #dee2e6;
            border-radius: 15px;
            background: white;
            cursor: pointer;
            font-size: 12px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .hobby-btn:hover {
            border-color: #20c997;
            background: #d1ecf1;
        }

        .hobby-btn.selected {
            border-color: #20c997;
            background: #20c997;
            color: white;
        }

        /* ÎßêÌà¨ Ïä§ÌÉÄÏùº Î≤ÑÌäº */
        .speech-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .speech-btn {
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-size: 13px;
        }

        .speech-btn:hover {
            border-color: #6f42c1;
            background: #f8f9fa;
        }

        .speech-btn.selected {
            border-color: #6f42c1;
            background: #6f42c1;
            color: white;
        }

        /* AI ÏÉùÏÑ± ÏòÅÏó≠ */
        .ai-generation {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px dashed #6c757d;
        }

        .ai-controls {
            text-align: center;
            margin-bottom: 15px;
        }

        .btn-ai {
            background: linear-gradient(45deg, #6f42c1, #e83e8c);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-ai:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(111, 66, 193, 0.3);
        }

        .generation-status {
            margin-top: 10px;
            font-style: italic;
            color: #6c757d;
        }

        .generated-preview {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid #dee2e6;
        }

        /* Î∞òÏùëÌòï Ï°∞Ï†ï */
        @media (max-width: 768px) {
            .ai-character-generator .modal-content {
                max-width: 95%;
                margin: 2% auto;
            }
            
            .category-grid {
                grid-template-columns: 1fr;
            }
            
            .mbti-options {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .trait-options {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .relationship-options {
                grid-template-columns: 1fr;
            }
            
            .hobby-options {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .speech-options {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Dialogue Preview Modal Styles */
        .preview-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #fafbfc;
            border-radius: 12px;
            border: 1px solid #e9ecef;
        }

        .preview-section h3 {
            color: #333;
            margin: -5px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
            font-size: 1.2em;
            font-weight: 600;
        }

        .preview-section:first-child {
            margin-top: 0;
        }

        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .metadata-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .metadata-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .metadata-value {
            font-weight: bold;
            color: #333;
        }

        .dialogue-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }

        .character-message {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
            font-size: 1.1em;
            line-height: 1.5;
        }

        .narration {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 8px;
            font-style: italic;
            color: #1976d2;
            border-left: 4px solid #1976d2;
        }

        .choices-container {
            display: grid;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: #ffffff;
        }

        .choice-preview {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .choice-preview:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .choice-text {
            flex: 1;
            font-weight: 500;
        }

        .choice-impact {
            margin-left: 15px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .impact-positive {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .impact-negative {
            background: #ffebee;
            color: #c62828;
        }

        .impact-neutral {
            background: #f5f5f5;
            color: #666;
        }

        /* API Settings Styles */
        .api-settings-container {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .vercel-env-guide {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .guide-description {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .setup-steps {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .step {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .step-number {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
        }

        .step-content strong {
            color: #333;
            display: block;
            margin-bottom: 5px;
        }

        .step-content p {
            margin: 0;
            color: #666;
            line-height: 1.5;
        }

        .api-key-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .api-key-input-group input {
            flex: 1;
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
        }

        .api-key-input-group button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .api-key-input-group button:hover {
            background: #5a67d8;
        }

        .form-help {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
            display: block;
        }

        .test-results {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #667eea;
        }

        .test-results.success {
            border-left-color: #28a745;
            background: #f8fff9;
        }

        .test-results.error {
            border-left-color: #dc3545;
            background: #fff8f8;
        }

        .api-info {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .api-info h4 {
            color: #333;
            margin-bottom: 15px;
        }

        .api-info ol, .api-info ul {
            padding-left: 20px;
        }

        .api-info li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .api-info a {
            color: #667eea;
            text-decoration: none;
        }

        .api-info a:hover {
            text-decoration: underline;
        }

        .api-usage-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
        }

        .api-usage-info h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .status-connected {
            color: #28a745;
            font-weight: bold;
        }

        .status-disconnected {
            color: #dc3545;
            font-weight: bold;
        }

        .status-warning {
            color: #ffc107;
            font-weight: bold;
        }

        .status-unknown {
            color: #6c757d;
            font-weight: bold;
        }

        .status-testing {
            color: #17a2b8;
            font-weight: bold;
        }

        /* API ÏÇ¨Ïö©Îüâ ÌëúÏãú Í∞úÏÑ† */
        #apiUsage {
            font-size: 0.9em;
            line-height: 1.4;
        }

        /* üîê Î°úÍ∑∏Ïù∏ Î™®Îã¨ Ïä§ÌÉÄÏùº */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .login-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
        }

        .login-header h2 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.8em;
        }

        .login-header p {
            color: #7f8c8d;
            margin-bottom: 30px;
        }

        .login-form {
            text-align: left;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
            font-weight: 600;
        }

        .input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-bottom: 20px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .login-status {
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-weight: 500;
            text-align: center;
        }

        .login-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .login-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .login-status.loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .login-help {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            color: #6c757d;
        }

        .login-help code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #495057;
        }

        /* Î°úÍ∑∏Ïù∏ ÌõÑ Ìó§ÎçîÏóê ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÌëúÏãú */
        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.9);
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 14px;
            color: #2c3e50;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 12px;
        }

        /* ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉù Ïπ¥Îìú Ïä§ÌÉÄÏùº */
        .scenario-selection-container {
            margin-bottom: 25px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .section-header h4 {
            margin: 0;
            color: #333;
        }

        .scenario-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .scenario-selection-card {
            background: #fff;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .scenario-selection-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .scenario-selection-card.selected {
            border-color: #667eea;
            background: #f8f9ff;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .scenario-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .scenario-card-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .scenario-card-badge {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .scenario-card-description {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 12px;
        }

        .scenario-card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #888;
        }

        .scenario-card-character {
            background: #f0f2f5;
            padding: 4px 8px;
            border-radius: 8px;
            color: #555;
        }

        .loading-card {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            color: #6c757d;
        }

        .loading-card .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid #e9ecef;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        /* ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§ ÌëúÏãú */
        .selected-scenario-display {
            background: #f8f9ff;
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .selected-scenario-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .selected-scenario-header h5 {
            margin: 0;
            color: #667eea;
            font-weight: 600;
        }

        .selected-scenario-info {
            color: #555;
        }

        .selected-scenario-info .info-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .selected-scenario-info .info-character {
            color: #667eea;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .selected-scenario-info .info-description {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <!-- üîê Î°úÍ∑∏Ïù∏ Î™®Îã¨ -->
    <div id="loginModal" class="login-modal" style="display: block;">
        <div class="login-container">
            <div class="login-header">
                <h2>üîê Ïñ¥ÎìúÎØº Î°úÍ∑∏Ïù∏</h2>
                <p>Í¥ÄÎ¶¨Ïûê Í≥ÑÏ†ïÏúºÎ°ú Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî</p>
            </div>
            <form id="loginForm" class="login-form">
                <div class="input-group">
                    <label for="username">ÏÇ¨Ïö©ÏûêÎ™Ö</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="input-group">
                    <label for="password">ÎπÑÎ∞ÄÎ≤àÌò∏</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit" class="login-btn">
                    üöÄ Î°úÍ∑∏Ïù∏
                </button>
                <div id="loginStatus" class="login-status"></div>
            </form>
            <div class="login-help">
                <p><strong>Í∏∞Î≥∏ Í≥ÑÏ†ï:</strong></p>
                <p>ÏÇ¨Ïö©ÏûêÎ™Ö: <code>admin</code></p>
            </div>
        </div>
    </div>

    <!-- Î©îÏù∏ Ïñ¥ÎìúÎØº Ïù∏ÌÑ∞ÌéòÏù¥Ïä§ -->
    <div id="adminInterface" class="admin-container" style="display: none;">
        <div class="header" style="position: relative;">
            <!-- ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÌëúÏãú -->
            <div id="userInfo" class="user-info">
                <span id="userWelcome">üë§ admin</span>
                <button onclick="logout()" class="logout-btn">Î°úÍ∑∏ÏïÑÏõÉ</button>
            </div>

            <h1>üéÆ ÌÜµÌï© Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú</h1>
            <p>MBTI Î°úÎß®Ïä§ Í≤åÏûÑÏùò ÏãúÎÇòÎ¶¨Ïò§, ÎåÄÌôî, Ï∫êÎ¶≠ÌÑ∞Î•º Ìïú Í≥≥ÏóêÏÑú Í¥ÄÎ¶¨Ìï©ÎãàÎã§</p>

            <!-- Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨ Î≤ÑÌäºÎì§ -->
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button onclick="resetAllDataWithConfirm()"
                        style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 15px rgba(231,76,60,0.3);">
                    üóëÔ∏è Î™®Îì† Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
                </button>
                <button onclick="fetch('/api/character-ai-generator', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({action: 'reset_all_characters'})}).then(() => { alert('‚úÖ Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å'); loadCharacters(); }).catch(err => alert('‚ùå Ïò§Î•ò: ' + err.message))"
                        style="background: linear-gradient(135deg, #f39c12, #e67e22); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 15px rgba(243,156,18,0.3);">
                    üë• Ï∫êÎ¶≠ÌÑ∞Îßå Ï¥àÍ∏∞Ìôî
                </button>
                <button onclick="alert('ÏãúÎÇòÎ¶¨Ïò§ Ï¥àÍ∏∞Ìôî Í∏∞Îä•ÏùÄ Í∞úÎ∞ú Ï§ëÏûÖÎãàÎã§.')"
                        style="background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 15px rgba(155,89,182,0.3);">
                    üìù ÏãúÎÇòÎ¶¨Ïò§Îßå Ï¥àÍ∏∞Ìôî
                </button>
            </div>
        </div>

        <!-- ÌÉ≠ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('characters')">
                üë• Ï∫êÎ¶≠ÌÑ∞ Í¥ÄÎ¶¨
                <span class="badge" id="characterCount">0</span>
            </button>
            <button class="nav-tab" onclick="switchTab('scenarios')">
                üìö ÏãúÎÇòÎ¶¨Ïò§ Í¥ÄÎ¶¨
                <span class="badge" id="scenarioCount">0</span>
            </button>
            <button class="nav-tab" onclick="switchTab('dialogues')">
                üìù ÏóêÌîºÏÜåÎìú Í¥ÄÎ¶¨
                <span class="badge" id="episodeCount">0</span>
            </button>
            <button class="nav-tab" onclick="switchTab('ai-management')">
                üß† AI Í¥ÄÎ¶¨
                <span class="badge" id="aiEngineStatus">‚úÖ</span>
            </button>
            <button class="nav-tab" onclick="switchTab('settings')">
                ‚öôÔ∏è API ÏÑ§Ï†ï
                <span class="badge" id="apiStatus">‚ùå</span>
            </button>
        </div>

        <!-- Ï∫êÎ¶≠ÌÑ∞ Í¥ÄÎ¶¨ ÏÑπÏÖò -->
        <div id="characters-section" class="content-section active">
            <div class="stats-row">
                <div class="stat-card">
                    <h3>Ï†ÑÏ≤¥ Ï∫êÎ¶≠ÌÑ∞</h3>
                    <div class="value" id="totalCharacters">0</div>
                </div>
                <div class="stat-card">
                    <h3>ÌôúÏÑ± Ï∫êÎ¶≠ÌÑ∞</h3>
                    <div class="value" id="activeCharacters">0</div>
                </div>
                <div class="stat-card">
                    <h3>AI ÏÉùÏÑ± Ï∫êÎ¶≠ÌÑ∞</h3>
                    <div class="value" id="aiGeneratedCharacters">0</div>
                </div>
                <div class="stat-card">
                    <h3>Ï∫êÎ¶≠ÌÑ∞ ÌèâÍ∑† Ìò∏Í∞êÎèÑ</h3>
                    <div class="value" id="avgCharacterAffection">0</div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openCharacterModal('create')" style="background: linear-gradient(135deg, #e91e63, #9c27b0); font-size: 16px; padding: 15px 25px;">
                    üé≠‚ú® AI Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±Í∏∞
                </button>
                <button class="btn btn-secondary" onclick="loadCharacters()">
                    üîÑ ÏÉàÎ°úÍ≥†Ïπ®
                </button>
                <button class="btn btn-warning" onclick="resetAllCharacters()" style="background: #ff9800; color: white;">
                    üóëÔ∏è Î™®Îì† ÎçîÎØ∏ Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú
                </button>
            </div>

            <div id="charactersContainer" class="characters-grid">
                <!-- Ï∫êÎ¶≠ÌÑ∞ Ïπ¥ÎìúÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
            </div>
        </div>

        <!-- ÎåÄÌôî Í¥ÄÎ¶¨ ÏÑπÏÖò -->
        <div id="dialogues-section" class="content-section">
            <!-- ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉù Ïπ¥Îìú -->
            <div class="scenario-selection-container">
                <div class="section-header">
                    <h4>üìö ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉù</h4>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="refreshDialogueScenarioList()">
                        üîÑ ÏÉàÎ°úÍ≥†Ïπ®
                    </button>
                </div>
                <div id="scenarioCardsContainer" class="scenario-cards-grid">
                    <div class="loading-card">
                        <div class="spinner"></div>
                        <p>ÏãúÎÇòÎ¶¨Ïò§ Î°úÎî© Ï§ë...</p>
                    </div>
                </div>

                <!-- ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§ Ï†ïÎ≥¥ -->
                <div id="selectedScenarioDisplay" class="selected-scenario-display" style="display: none;">
                    <div class="selected-scenario-header">
                        <h5>‚úÖ ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§</h5>
                        <button type="button" class="btn btn-link btn-sm" onclick="clearScenarioSelection()">ÏÑ†ÌÉù Ìï¥Ï†ú</button>
                    </div>
                    <div id="selectedScenarioInfo" class="selected-scenario-info">
                    </div>
                </div>
            </div>

            <div id="dialogueInfo" style="display: none;">
                <div class="stats-row">
                    <div class="stat-card">
                        <h3>Ï†ÑÏ≤¥ ÎåÄÌôî</h3>
                        <div class="value" id="totalDialogues">0/36</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <h3>Easy (1-9)</h3>
                        <div class="value" id="easyCount">0/9</div>
                    </div>
                    <div class="stat-card">
                        <h3>Medium (10-18)</h3>
                        <div class="value" id="mediumCount">0/9</div>
                    </div>
                    <div class="stat-card">
                        <h3>Hard (19-27)</h3>
                        <div class="value" id="hardCount">0/9</div>
                    </div>
                    <div class="stat-card">
                        <h3>Expert (28-36)</h3>
                        <div class="value" id="expertCount">0/9</div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="openDialogueModal('create')">
                        ‚ú® ÏÉà ÎåÄÌôî ÏÉùÏÑ±
                    </button>
                    <button class="btn btn-secondary" onclick="generateBulkDialogues()">
                        üöÄ ÏùºÍ¥Ñ ÏÉùÏÑ± (AI)
                    </button>
                    <button class="btn btn-secondary" onclick="loadDialogues()">
                        üîÑ ÏÉàÎ°úÍ≥†Ïπ®
                    </button>
                    <button class="btn btn-warning" onclick="resetAllEpisodes()" style="background: #ff9800; color: white;">
                        üóëÔ∏è Î™®Îì† ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú
                    </button>
                </div>

                <div class="difficulty-tabs">
                    <div class="difficulty-tab active" onclick="filterByDifficulty('all')">
                        Ï†ÑÏ≤¥ <strong id="allCount">0</strong>
                    </div>
                    <div class="difficulty-tab" onclick="filterByDifficulty('easy')">
                        Easy <strong id="easyTabCount">0</strong>
                    </div>
                    <div class="difficulty-tab" onclick="filterByDifficulty('medium')">
                        Medium <strong id="mediumTabCount">0</strong>
                    </div>
                    <div class="difficulty-tab" onclick="filterByDifficulty('hard')">
                        Hard <strong id="hardTabCount">0</strong>
                    </div>
                    <div class="difficulty-tab" onclick="filterByDifficulty('expert')">
                        Expert <strong id="expertTabCount">0</strong>
                    </div>
                </div>

                <!-- ÏÉùÏÑ±Îêú ÏóêÌîºÏÜåÎìú Î™©Î°ù (ÏÉàÎ°ú Ï∂îÍ∞Ä) -->
                <div class="episodes-list-section" style="margin-bottom: 30px;">
                    <div class="section-header">
                        <h4>üìö ÏÉùÏÑ±Îêú ÏóêÌîºÏÜåÎìú Î™©Î°ù</h4>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="loadEpisodesList()">
                            üîÑ ÏÉàÎ°úÍ≥†Ïπ®
                        </button>
                    </div>
                    <div id="episodesListContainer" class="episodes-cards-grid">
                        <div class="loading-card">
                            <div class="spinner"></div>
                            <p>ÏóêÌîºÏÜåÎìú Î°úÎî© Ï§ë...</p>
                        </div>
                    </div>
                </div>

                <!-- ÏÑ†ÌÉùÎêú ÏóêÌîºÏÜåÎìúÏùò ÎåÄÌôî Î™©Î°ù -->
                <div id="selectedEpisodeDialogues" style="display: none;">
                    <div class="section-header">
                        <h4 id="selectedEpisodeTitle">üìñ ÏóêÌîºÏÜåÎìú ÎåÄÌôî Î™©Î°ù</h4>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="closeEpisodeDialogues()">
                            ‚ùå Îã´Í∏∞
                        </button>
                    </div>

                    <div id="dialoguesGrid" class="dialogues-grid">
                        <!-- 36Í∞úÏùò ÎåÄÌôî Ïπ¥ÎìúÍ∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- API ÏÑ§Ï†ï ÏÑπÏÖò -->
        <div id="settings-section" class="content-section">
            <div class="stats-row">
                <div class="stat-card">
                    <h3>OpenAI API ÏÉÅÌÉú</h3>
                    <div class="value" id="openaiStatus">‚ùå ÎØ∏Ïó∞Í≤∞</div>
                </div>
                <div class="stat-card">
                    <h3>API ÏÇ¨Ïö©Îüâ</h3>
                    <div class="value" id="apiUsage">ÌôïÏù∏ Ï§ë...</div>
                </div>
                <div class="stat-card">
                    <h3>ÎßàÏßÄÎßâ ÌÖåÏä§Ìä∏</h3>
                    <div class="value" id="lastTest">ÏóÜÏùå</div>
                </div>
            </div>

            <div class="api-settings-container">
                <div class="vercel-env-guide">
                    <h3>üîß Vercel ÌôòÍ≤ΩÎ≥ÄÏàò ÏÑ§Ï†ï ÏïàÎÇ¥</h3>
                    <p class="guide-description">AI ÏÉùÏÑ± Í∏∞Îä•ÏùÑ ÏÇ¨Ïö©ÌïòÎ†§Î©¥ Vercel ÎåÄÏãúÎ≥¥ÎìúÏóêÏÑú OpenAI API ÌÇ§Î•º ÌôòÍ≤ΩÎ≥ÄÏàòÎ°ú ÏÑ§Ï†ïÌï¥Ïïº Ìï©ÎãàÎã§.</p>

                    <div class="setup-steps">
                        <div class="step">
                            <span class="step-number">1</span>
                            <div class="step-content">
                                <strong>Vercel ÎåÄÏãúÎ≥¥Îìú Ï†ëÏÜç</strong>
                                <p><a href="https://vercel.com/dashboard" target="_blank" style="color: #667eea;">üîó Vercel Dashboard</a> ‚Üí ÌîÑÎ°úÏ†ùÌä∏ ÏÑ†ÌÉù</p>
                            </div>
                        </div>
                        <div class="step">
                            <span class="step-number">2</span>
                            <div class="step-content">
                                <strong>ÌôòÍ≤ΩÎ≥ÄÏàò ÌéòÏù¥ÏßÄ Ïù¥Îèô</strong>
                                <p>Settings ‚Üí Environment Variables</p>
                            </div>
                        </div>
                        <div class="step">
                            <span class="step-number">3</span>
                            <div class="step-content">
                                <strong>API ÌÇ§ Ï∂îÍ∞Ä</strong>
                                <p>Î≥ÄÏàòÎ™Ö: <code style="background: #e3f2fd; padding: 2px 6px; border-radius: 4px;">OPENAI_API_KEY</code><br>
                                Í∞í: Ïã§Ï†ú OpenAI API ÌÇ§ (sk-Î°ú ÏãúÏûë)</p>
                            </div>
                        </div>
                        <div class="step">
                            <span class="step-number">4</span>
                            <div class="step-content">
                                <strong>ÌôòÍ≤Ω ÏÑ†ÌÉù</strong>
                                <p>Production, Preview, Development Î™®Îëê Ï≤¥ÌÅ¨</p>
                            </div>
                        </div>
                        <div class="step">
                            <span class="step-number">5</span>
                            <div class="step-content">
                                <strong>Ï†ÄÏû• Î∞è Ïû¨Î∞∞Ìè¨</strong>
                                <p>Save ÌÅ¥Î¶≠ ÌõÑ ÏïΩ 1-2Î∂Ñ ÎåÄÍ∏∞</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="checkApiStatus()">
                        üîÑ API ÌÇ§ ÏÉÅÌÉú ÌôïÏù∏
                    </button>
                    <button class="btn btn-primary" onclick="openVercelDashboard()">
                        üöÄ Vercel ÎåÄÏãúÎ≥¥Îìú Ïó¥Í∏∞
                    </button>
                </div>

                <div id="apiTestResults" class="test-results" style="display: none;">
                    <!-- ÌÖåÏä§Ìä∏ Í≤∞Í≥ºÍ∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                </div>

                <div class="api-info">
                    <h4>üìã API ÌÇ§ ÏÑ§Ï†ï Î∞©Î≤ï:</h4>
                    <ol>
                        <li><a href="https://platform.openai.com/" target="_blank">OpenAI ÌîåÎû´Ìèº</a>ÏóêÏÑú Í≥ÑÏ†ïÏùÑ ÎßåÎì§Í≥† Î°úÍ∑∏Ïù∏</li>
                        <li>API ÌÇ§ ÏÑπÏÖòÏóêÏÑú ÏÉà API ÌÇ§ ÏÉùÏÑ±</li>
                        <li>ÏÉùÏÑ±Îêú ÌÇ§Î•º ÏúÑ ÏûÖÎ†•Ï∞ΩÏóê Î∂ôÏó¨ÎÑ£Í∏∞</li>
                        <li>"API ÌÇ§ Ï†ÄÏû•" Î≤ÑÌäº ÌÅ¥Î¶≠</li>
                        <li>"Ïó∞Í≤∞ ÌÖåÏä§Ìä∏" Î≤ÑÌäºÏúºÎ°ú Ï†ïÏÉÅ ÏûëÎèô ÌôïÏù∏</li>
                    </ol>
                    
                    <div class="api-usage-info">
                        <h4>üí∞ ÏÇ¨Ïö© ÏöîÍ∏à:</h4>
                        <ul>
                            <li><strong>GPT-4o-mini</strong>: Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±, ÏßàÎ¨∏ ÏÉùÏÑ± (Ï†ÄÎ†¥)</li>
                            <li><strong>GPT-4o Vision</strong>: Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù (Ï§ëÍ∞Ñ Í∞ÄÍ≤©)</li>
                            <li>ÎåÄÎ∂ÄÎ∂ÑÏùò ÏûëÏóÖÏùÄ Î™á ÏÑºÌä∏ÏóêÏÑú Î™á Îã¨Îü¨ ÏàòÏ§Ä</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Í¥ÄÎ¶¨ ÏÑπÏÖò -->
        <div id="ai-management-section" class="content-section">
            <div class="stats-row">
                <div class="stat-card">
                    <h3>üß† AI ÏóîÏßÑ ÏÉÅÌÉú</h3>
                    <div class="value" id="aiEngineCurrentStatus">Ï†ïÏÉÅ</div>
                </div>
                <div class="stat-card">
                    <h3>üìä Ïò§Îäò ÏÉùÏÑ±Îüâ</h3>
                    <div class="value" id="todayGenerationCount">0</div>
                </div>
                <div class="stat-card">
                    <h3>üéØ ÌíàÏßà Ï†êÏàò</h3>
                    <div class="value" id="aiQualityScore">85%</div>
                </div>
            </div>

            <!-- AI ÏÑ±Îä• ÌäúÎãù -->
            <div class="ai-tuning-container">
                <h3>üéõÔ∏è AI ÏÑ±Îä• ÌäúÎãù</h3>

                <!-- ÏãúÎÇòÎ¶¨Ïò§ ÏÉùÏÑ± ÏÑ§Ï†ï -->
                <div class="tuning-section">
                    <h4>üìö ÏãúÎÇòÎ¶¨Ïò§ ÏÉùÏÑ± Ìñ•ÏÉÅ</h4>
                    <div class="tuning-controls">
                        <div class="form-group">
                            <label for="scenarioContentLength">üìù Ïª®ÌÖçÏä§Ìä∏ Í∏∏Ïù¥ (ÌòÑÏû¨: Í∏∞Î≥∏)</label>
                            <select id="scenarioContentLength">
                                <option value="basic">Í∏∞Î≥∏ (ÌòÑÏû¨)</option>
                                <option value="extended" selected>ÌôïÏû• (3Î∞∞ Í∏∏Ïù¥)</option>
                                <option value="detailed">ÏÉÅÏÑ∏ (5Î∞∞ Í∏∏Ïù¥)</option>
                            </select>
                            <small class="form-help">ÏãúÎÇòÎ¶¨Ïò§ Î∞∞Í≤Ω ÏÑ§Ï†ïÍ≥º ÏÉÅÌô© ÏÑ§Î™ÖÏùÑ Îçî ÌíçÎ∂ÄÌïòÍ≤å ÏÉùÏÑ±</small>
                        </div>

                        <div class="form-group">
                            <label for="scenarioDepth">üé≠ Ïã¨Î¶¨ Î¨òÏÇ¨ ÍπäÏù¥</label>
                            <select id="scenarioDepth">
                                <option value="surface">ÌëúÎ©¥Ï†Å</option>
                                <option value="moderate" selected>Ï†ÅÎãπÌï®</option>
                                <option value="deep">ÍπäÏù¥ ÏûàÏùå</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="scenarioVariety">üé≤ ÏÉÅÌô© Îã§ÏñëÏÑ±</label>
                            <select id="scenarioVariety">
                                <option value="focused">ÏßëÏ§ëÌòï</option>
                                <option value="balanced" selected>Í∑†ÌòïÌòï</option>
                                <option value="diverse">Îã§ÏñëÌòï</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ÎåÄÌôî ÏÉùÏÑ± ÏÑ§Ï†ï -->
                <div class="tuning-section">
                    <h4>üí¨ ÎåÄÌôî ÏÉùÏÑ± Ìñ•ÏÉÅ</h4>
                    <div class="tuning-controls">
                        <div class="form-group">
                            <label for="dialogueLength">üìú ÎåÄÌôîÎüâ (ÌòÑÏû¨: Í∏∞Î≥∏)</label>
                            <select id="dialogueLength">
                                <option value="basic">Í∏∞Î≥∏ (ÌòÑÏû¨)</option>
                                <option value="extended" selected>ÌôïÏû• (5Î∞∞ ÎåÄÏÇ¨Îüâ)</option>
                                <option value="verbose">ÌíçÎ∂Ä (10Î∞∞ ÎåÄÏÇ¨Îüâ)</option>
                            </select>
                            <small class="form-help">Ìïú Î≤àÏùò ÏÉÅÌò∏ÏûëÏö©ÏóêÏÑú ÏÉùÏÑ±ÎêòÎäî ÎåÄÌôîÏùò ÏñëÏùÑ ÎäòÎ¶º</small>
                        </div>

                        <div class="form-group">
                            <label for="conversationStyle">üó£Ô∏è ÎåÄÌôî Ïä§ÌÉÄÏùº</label>
                            <select id="conversationStyle">
                                <option value="concise">Í∞ÑÍ≤∞Ìòï</option>
                                <option value="natural" selected>ÏûêÏó∞Ïä§Îü¨Ïö¥</option>
                                <option value="expressive">ÌëúÌòÑÎ†• ÌíçÎ∂Ä</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="emotionalRange">üíù Í∞êÏ†ï ÌëúÌòÑ Î≤îÏúÑ</label>
                            <select id="emotionalRange">
                                <option value="subtle">ÏùÄÏùÄÌï®</option>
                                <option value="balanced" selected>Í∑†ÌòïÏûàÏùå</option>
                                <option value="intense">Í∞ïÎ†¨Ìï®</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- MBTI Î∞òÏùë ÏãúÏä§ÌÖú -->
                <div class="tuning-section">
                    <h4>üß© MBTI ÎßûÏ∂§ Î∞òÏùë Í∞úÏÑ†</h4>
                    <div class="tuning-controls">
                        <div class="form-group">
                            <label for="mbtiAccuracy">üéØ MBTI ÌäπÏÑ± Î∞òÏòÅÎèÑ</label>
                            <select id="mbtiAccuracy">
                                <option value="basic">Í∏∞Î≥∏Ï†Å</option>
                                <option value="enhanced" selected>Ìñ•ÏÉÅÎêú</option>
                                <option value="expert">Ï†ÑÎ¨∏Í∞Ä ÏàòÏ§Ä</option>
                            </select>
                            <small class="form-help">ÏÇ¨Ïö©Ïûê ÏûÖÎ†•ÏùÑ MBTI ÌäπÏÑ±Ïóê ÎßûÍ≤å Î∂ÑÏÑùÌïòÏó¨ Ï∫êÎ¶≠ÌÑ∞Í∞Ä Î∞òÏùë</small>
                        </div>

                        <div class="form-group">
                            <label for="personalityConsistency">üë§ ÏÑ±Í≤© ÏùºÍ¥ÄÏÑ±</label>
                            <select id="personalityConsistency">
                                <option value="flexible">Ïú†Ïó∞Ìï®</option>
                                <option value="consistent" selected>ÏùºÍ¥ÄÏ†Å</option>
                                <option value="strict">ÏóÑÍ≤©Ìï®</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="responseIntelligence">üß† Î∞òÏùë ÏßÄÎä•ÎèÑ</label>
                            <select id="responseIntelligence">
                                <option value="simple">Îã®ÏàúÌï®</option>
                                <option value="smart" selected>Ïä§ÎßàÌä∏</option>
                                <option value="genius">Ï≤úÏû¨Í∏â</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ÎåÄÌôî Î∞òÎ≥µ Î∞©ÏßÄ -->
                <div class="tuning-section">
                    <h4>üîÑ ÎåÄÌôî Î∞òÎ≥µ Î∞©ÏßÄ ÏãúÏä§ÌÖú</h4>
                    <div class="tuning-controls">
                        <div class="form-group">
                            <label for="repetitionAvoidance">üö´ Î∞òÎ≥µ Î∞©ÏßÄ Í∞ïÎèÑ</label>
                            <select id="repetitionAvoidance">
                                <option value="off">ÎπÑÌôúÏÑ±Ìôî</option>
                                <option value="mild">ÏïΩÌï®</option>
                                <option value="moderate" selected>Î≥¥ÌÜµ</option>
                                <option value="strong">Í∞ïÌï®</option>
                            </select>
                            <small class="form-help">Ïù¥Ï†Ñ ÎåÄÌôîÏôÄ Ïú†ÏÇ¨Ìïú Ìå®ÌÑ¥ÏùÑ Í∞êÏßÄÌïòÏó¨ ÏÉàÎ°úÏö¥ ÎåÄÌôî ÏÉùÏÑ±</small>
                        </div>

                        <div class="form-group">
                            <label for="memoryDepth">üß† ÎåÄÌôî Í∏∞Ïñµ ÍπäÏù¥</label>
                            <select id="memoryDepth">
                                <option value="short">Îã®Í∏∞ (ÏµúÍ∑º 3ÌÑ¥)</option>
                                <option value="medium" selected>Ï§ëÍ∏∞ (ÏµúÍ∑º 10ÌÑ¥)</option>
                                <option value="long">Ïû•Í∏∞ (ÏÑ∏ÏÖò Ï†ÑÏ≤¥)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="creativityBoost">‚ú® Ï∞ΩÏùòÏÑ± Î∂ÄÏä§Ìä∏</label>
                            <select id="creativityBoost">
                                <option value="conservative">Î≥¥ÏàòÏ†Å</option>
                                <option value="balanced" selected>Í∑†ÌòïÏ†Å</option>
                                <option value="creative">Ï∞ΩÏùòÏ†Å</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- AI Ïó≠Ìï† Î∞è ÌéòÎ•¥ÏÜåÎÇò ÏÑ§Ï†ï -->
                <div class="tuning-section">
                    <h4>üé≠ AI Ïó≠Ìï† Î∞è ÌéòÎ•¥ÏÜåÎÇò ÏÑ§Ï†ï</h4>
                    <div class="tuning-controls">
                        <div class="form-group">
                            <label for="aiPersonaRole">üéØ AI Ï†ÑÎ¨∏ Ïó≠Ìï†</label>
                            <select id="aiPersonaRole">
                                <option value="general">ÏùºÎ∞ò AI Ïñ¥ÏãúÏä§ÌÑ¥Ìä∏</option>
                                <option value="romance_novelist" selected>Î≤†Ïä§Ìä∏ÏÖÄÎü¨ Ïó∞Ïï†ÏÜåÏÑ§Í∞Ä</option>
                                <option value="dating_coach">Ïó∞Ïï† ÏΩîÏπ≠ Ï†ÑÎ¨∏Í∞Ä</option>
                                <option value="messenger_expert">Î©îÏã†Ï†Ä ÎåÄÌôî Ï†ÑÎ¨∏Í∞Ä</option>
                                <option value="psychology_expert">Ïó∞Ïï† Ïã¨Î¶¨Ìïô Ï†ÑÎ¨∏Í∞Ä</option>
                            </select>
                            <small class="form-help">AIÍ∞Ä ÏàòÌñâÌï† Ï†ÑÎ¨∏ Ïó≠Ìï†ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</small>
                        </div>

                        <div class="form-group">
                            <label for="aiWritingStyle">üìù Í∏ÄÏì∞Í∏∞ Ïä§ÌÉÄÏùº</label>
                            <select id="aiWritingStyle">
                                <option value="casual">ÏùºÎ∞òÏ†Å</option>
                                <option value="literary">Î¨∏ÌïôÏ†Å</option>
                                <option value="bestseller" selected>Î≤†Ïä§Ìä∏ÏÖÄÎü¨ ÏÜåÏÑ§ Ïä§ÌÉÄÏùº</option>
                                <option value="coaching">ÏΩîÏπ≠ Ï†ÑÎ¨∏Í∞Ä Ïä§ÌÉÄÏùº</option>
                                <option value="contemporary">ÌòÑÎåÄÏ†Å Í∞êÍ∞Å</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="aiExpertiseLevel">üèÜ Ï†ÑÎ¨∏ÏÑ± ÏàòÏ§Ä</label>
                            <select id="aiExpertiseLevel">
                                <option value="basic">Í∏∞Î≥∏</option>
                                <option value="professional">Ï†ÑÎ¨∏Í∞Ä</option>
                                <option value="master" selected>ÎßàÏä§ÌÑ∞ Î†àÎ≤®</option>
                                <option value="legendary">Ï†ÑÏÑ§Í∏â</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="aiPersonality">üé® AI ÏÑ±Í≤© ÌäπÏÑ±</label>
                            <select id="aiPersonality">
                                <option value="neutral">Ï§ëÎ¶ΩÏ†Å</option>
                                <option value="warm">Îî∞ÎúªÌïòÍ≥† Í∞êÏÑ±Ï†Å</option>
                                <option value="witty" selected>Ïû¨ÏπòÏûàÍ≥† Ïú†Î®∏Îü¨Ïä§</option>
                                <option value="wise">ÏßÄÌòúÎ°≠Í≥† Í≤ΩÌóò ÎßéÏùÄ</option>
                                <option value="passionate">Ïó¥Ï†ïÏ†ÅÏù¥Í≥† Ï∞ΩÏùòÏ†Å</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="aiSpecialization">üé™ ÌäπÌôî Î∂ÑÏïº</label>
                            <select id="aiSpecialization">
                                <option value="general_romance">ÏùºÎ∞ò Ïó∞Ïï†</option>
                                <option value="messenger_chat" selected>Î©îÏã†Ï†Ä ÎåÄÌôî ÌäπÌôî</option>
                                <option value="emotional_connection">Í∞êÏ†ïÏ†Å Ïú†ÎåÄ Í¥ÄÍ≥Ñ</option>
                                <option value="dating_strategy">Ïó∞Ïï† Ï†ÑÎûµ</option>
                                <option value="relationship_building">Í¥ÄÍ≥Ñ Î∞úÏ†Ñ</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI ÏÑ§Ï†ï Ï†ÅÏö© Î≤ÑÌäº -->
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="applyAISettings()">
                    üöÄ AI ÏÑ§Ï†ï Ï†ÅÏö©
                </button>
                <button class="btn btn-secondary" onclick="testAIGeneration()">
                    üß™ AI ÏÉùÏÑ± ÌÖåÏä§Ìä∏
                </button>
                <button class="btn btn-warning" onclick="resetAISettings()">
                    üîÑ Í∏∞Î≥∏Í∞íÏúºÎ°ú Î¶¨ÏÖã
                </button>
            </div>

            <!-- AI ÏÉùÏÑ± ÌÖåÏä§Ìä∏ Í≤∞Í≥º -->
            <div id="aiTestResults" class="test-results" style="display: none;">
                <h4>üß™ AI ÏÉùÏÑ± ÌÖåÏä§Ìä∏ Í≤∞Í≥º</h4>
                <div id="testResultContent"></div>
            </div>

            <!-- AI ÏÑ±Îä• Î°úÍ∑∏ -->
            <div class="ai-performance-log">
                <h4>üìà AI ÏÑ±Îä• Î°úÍ∑∏</h4>
                <div id="performanceLogContent">
                    <div class="log-entry">
                        <span class="log-time">14:30</span>
                        <span class="log-type success">ÏãúÎÇòÎ¶¨Ïò§ ÏÉùÏÑ±</span>
                        <span class="log-message">ÏÉàÎ°úÏö¥ Î°úÎß®Ïä§ ÏãúÎÇòÎ¶¨Ïò§ "Ïπ¥ÌéòÏóêÏÑúÏùò ÎßåÎÇ®" ÏÉùÏÑ± ÏôÑÎ£å</span>
                    </div>
                    <div class="log-entry">
                        <span class="log-time">14:25</span>
                        <span class="log-type info">ÎåÄÌôî ÏÉùÏÑ±</span>
                        <span class="log-message">INFP Ï∫êÎ¶≠ÌÑ∞ ÎåÄÌôî 5ÌÑ¥ ÏÉùÏÑ±, ÌíàÏßà Ï†êÏàò: 87%</span>
                    </div>
                    <div class="log-entry">
                        <span class="log-time">14:20</span>
                        <span class="log-type warning">Î∞òÎ≥µ Í∞êÏßÄ</span>
                        <span class="log-message">Ïú†ÏÇ¨Ìïú ÎåÄÌôî Ìå®ÌÑ¥ Í∞êÏßÄÎê®, ÏÉàÎ°úÏö¥ Î≥ÄÌòï ÏÉùÏÑ±</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÏãúÎÇòÎ¶¨Ïò§ Í¥ÄÎ¶¨ ÏÑπÏÖò -->
        <div id="scenarios-section" class="content-section">
            <div class="stats-row">
                <div class="stat-card">
                    <h3>Ï†ÑÏ≤¥ ÏãúÎÇòÎ¶¨Ïò§</h3>
                    <div class="value" id="totalScenarios">0</div>
                </div>
                <div class="stat-card">
                    <h3>ÌôúÏÑ± ÏãúÎÇòÎ¶¨Ïò§</h3>
                    <div class="value" id="activeScenarios">0</div>
                </div>
                <div class="stat-card">
                    <h3>AI ÏÉùÏÑ± ÏãúÎÇòÎ¶¨Ïò§</h3>
                    <div class="value" id="aiGeneratedScenarios">0</div>
                </div>
                <div class="stat-card">
                    <h3>ÎåÄÌôî Ïàò</h3>
                    <div class="value" id="totalDialogues">0</div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openScenarioModal('create')" style="background: linear-gradient(135deg, #667eea, #764ba2); font-size: 16px; padding: 15px 25px;">
                    ‚ú® ÏÉà ÏãúÎÇòÎ¶¨Ïò§ ÎßåÎì§Í∏∞
                </button>
                <button class="btn btn-secondary" onclick="loadScenarios()">
                    üîÑ ÏÉàÎ°úÍ≥†Ïπ®
                </button>
            </div>

            <div id="scenariosContainer" class="scenarios-grid">
                <!-- ÏãúÎÇòÎ¶¨Ïò§ Ïπ¥ÎìúÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
            </div>
        </div>
    </div>

    <!-- ÏãúÎÇòÎ¶¨Ïò§ Î™®Îã¨ -->
    <div id="scenarioModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeModal('scenarioModal')">&times;</span>
                <h2 id="scenarioModalTitle">ÏÉà ÏãúÎÇòÎ¶¨Ïò§ ÎßåÎì§Í∏∞</h2>
            </div>
            <div class="modal-body">
                <form id="scenarioForm">
                    <input type="hidden" id="scenarioId" />

                    <!-- 1Îã®Í≥Ñ: Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉù (ÏµúÏö∞ÏÑ†) -->
                    <div class="form-group priority-section" style="border: 2px solid #667eea; border-radius: 10px; padding: 20px; margin-bottom: 25px; background: linear-gradient(135deg, #f8f9ff 0%, #e3e7ff 100%);">
                        <label style="font-size: 1.2em; color: #667eea; font-weight: bold;">üé≠ 1Îã®Í≥Ñ: ÎåÄÌôîÌï† Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉù *</label>
                        <div id="characterLoadingMsg" style="padding: 20px; text-align: center; color: #666;">
                            Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ùÏùÑ Î°úÎî© Ï§ëÏûÖÎãàÎã§...
                        </div>
                        <div class="character-selector" id="characterSelector" style="display: none;">
                            <!-- ÎèôÏ†ÅÏúºÎ°ú Î°úÎìúÎê©ÎãàÎã§ -->
                        </div>
                        <small style="color: #666; font-size: 12px;">üí° Î®ºÏ†Ä ÎåÄÌôîÌï† Ï∫êÎ¶≠ÌÑ∞Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</small>
                    </div>

                    <!-- 2Îã®Í≥Ñ: Î©îÏã†Ï†Ä ÏÉÅÌô© Ï†úÎ™© ÏÑ†ÌÉù -->
                    <div class="form-group">
                        <label for="scenarioTitle" style="font-size: 1.1em; color: #333; font-weight: bold;">üì± 2Îã®Í≥Ñ: Î©îÏã†Ï†Ä ÏÉÅÌô© Ï†úÎ™© *</label>
                        <input type="text" id="scenarioTitle" required placeholder="ÌÅ¥Î¶≠Ìï¥ÏÑú ÏÉÅÌô© ÏÑ†ÌÉù" onchange="updateSituationPreview()" />
                        <div class="examples-container">
                            <span class="examples-label">üì± Î©îÏã†Ï†Ä ÏÉÅÌô©:</span>
                            <div class="examples-grid">
                                <span class="example-tag" onclick="fillExample('scenarioTitle', this)">Ïñ¥Ï†ú Ïà†ÏûêÎ¶¨ Ïù¥ÌõÑ</span>
                                <span class="example-tag" onclick="fillExample('scenarioTitle', this)">Í∞ëÏûëÏä§Îü¨Ïö¥ ÌÇ§Ïä§ Ïù¥ÌõÑ</span>
                                <span class="example-tag" onclick="fillExample('scenarioTitle', this)">Í≥†Î∞± ÌõÑ ÎãµÎ≥Ä Í∏∞Îã§Î¶¨Îäî Ï§ë</span>
                                <span class="example-tag" onclick="fillExample('scenarioTitle', this)">Ï≤´ Îç∞Ïù¥Ìä∏ ÏïΩÏÜç Ïû°Í∏∞</span>
                                <span class="example-tag" onclick="fillExample('scenarioTitle', this)">Î∞§Îä¶ÏùÄ ÏßÑÏã¨ ÎåÄÌôî</span>
                                <span class="example-tag" onclick="fillExample('scenarioTitle', this)">Ïò§Ìï¥ ÌõÑ ÌôîÌï¥ÌïòÍ∏∞</span>
                                <span class="example-tag" onclick="fillExample('scenarioTitle', this)">ÏßàÌà¨ ÏÉÅÌô© Ìï¥Í≤∞ÌïòÍ∏∞</span>
                                <span class="example-tag" onclick="fillExample('scenarioTitle', this)">ÏÑúÏö¥Ìï® ÌëúÌòÑÌïòÍ∏∞</span>
                                <span class="example-tag" onclick="fillExample('scenarioTitle', this)">Ïï†Íµê Î∂ÄÎ¶¨Î©∞ Îã¨ÎûòÍ∏∞</span>
                                <span class="example-tag" onclick="fillExample('scenarioTitle', this)">ÏÉàÎ≤Ω Í∞êÏÑ± Î©îÏãúÏßÄ</span>
                                <span class="example-tag" onclick="fillExample('scenarioTitle', this)">Í∏∞ÎÖêÏùº ÍπúÏßù Ïù¥Î≤§Ìä∏</span>
                                <span class="example-tag" onclick="fillExample('scenarioTitle', this)">Ïû•Í±∞Î¶¨ Ïó∞Ïï† Í∑∏Î¶¨ÏõÄ</span>
                            </div>
                        </div>

                        <!-- ÏÉÅÌô© ÎØ∏Î¶¨Î≥¥Í∏∞ ÏÑπÏÖò -->
                        <div class="form-group" id="situationPreview" style="display: none; margin-top: 15px;">
                            <label style="color: #667eea;">üì≤ ÏÉÅÌô© ÎØ∏Î¶¨Î≥¥Í∏∞</label>
                            <div class="situation-preview-box" id="situationPreviewContent" style="background: #f8f9ff; border: 1px solid #e3e7ff; border-radius: 8px; padding: 15px; color: #555;">
                                <!-- ÏÑ†ÌÉùÌïú Ï†úÎ™©Ïóê Îî∞Îùº ÎèôÏ†ÅÏúºÎ°ú ÌëúÏãú -->
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="scenarioDescription" style="font-size: 1.1em; color: #333; font-weight: bold;">üìù 3Îã®Í≥Ñ: Î©îÏã†Ï†Ä ÏÉÅÌô© ÏÑ§Î™Ö *</label>
                        <textarea id="scenarioDescription" required placeholder="ÌÅ¥Î¶≠Ìï¥ÏÑú ÏÉÅÌô© ÏÑ†ÌÉù"></textarea>
                        <div class="examples-container">
                            <span class="examples-label">üì± Î©îÏã†Ï†Ä ÎåÄÌôî Î∞∞Í≤Ω:</span>
                            <div class="examples-grid">
                                <span class="example-tag" onclick="fillExample('scenarioDescription', this)">Ïñ¥Ï†ú Ïà†ÏûêÎ¶¨ÏóêÏÑú ÏßÑÏã¨ÏùÑ Í≥†Î∞±Ìïú ÌõÑ, Ïò§Îäò ÏïÑÏπ® ÏÑúÎ°ú Ïñ¥ÏÉâÌïú ÏÉÅÌô©ÏóêÏÑú Î©îÏã†Ï†ÄÎ°ú ÎåÄÌôîÎ•º ÏãúÏûëÌïòÎäî ÏÉÅÌô©</span>
                                <span class="example-tag" onclick="fillExample('scenarioDescription', this)">Í∞ëÏûëÏä§ÎüΩÍ≤å ÌÇ§Ïä§Ìïú ÌõÑ Î©∞Ïπ†Ïß∏ Ïó∞ÎùΩÏù¥ ÏóÜÏóàÎã§Í∞Ä, ÏÉÅÎåÄÎ∞©Ïù¥ Î®ºÏ†Ä Î©îÏã†Ï†ÄÎ•º Î≥¥ÎÇ¥Ïò® ÏÉÅÌô©</span>
                                <span class="example-tag" onclick="fillExample('scenarioDescription', this)">Í≥†Î∞±Ìïú ÌõÑ ÎãµÎ≥ÄÏùÑ Í∏∞Îã§Î¶¨Í≥† ÏûàÎäîÎç∞, ÏÉÅÎåÄÎ∞©Ïù¥ Ïã†Ï§ëÌïòÍ≤å Î©îÏã†Ï†ÄÎ°ú ÎßàÏùåÏùÑ ÌëúÌòÑÌïòÎ†§Îäî ÏÉÅÌô©</span>
                                <span class="example-tag" onclick="fillExample('scenarioDescription', this)">ÏÑúÎ°ú Ï¢ãÏïÑÌïòÏßÄÎßå Ï≤´ Îç∞Ïù¥Ìä∏ ÏïΩÏÜçÏùÑ Ïû°Í∏∞ÍπåÏßÄ Î©îÏã†Ï†ÄÎ°ú ÏùÄÍ∑ºÌïú Î∞ÄÎãπÏùÑ ÌïòÎäî ÏÉÅÌô©</span>
                                <span class="example-tag" onclick="fillExample('scenarioDescription', this)">Î∞§Îä¶Í≤å Ïû†Îì§Í∏∞ Ï†Ñ ÏßÑÏã¨Ïñ¥Î¶∞ Í∞êÏ†ïÏùÑ Î©îÏã†Ï†ÄÎ°ú ÎÇòÎàÑÎ©∞ Îçî ÍπäÏùÄ ÎåÄÌôîÎ•º Ïù¥Ïñ¥Í∞ÄÎäî ÏÉÅÌô©</span>
                                <span class="example-tag" onclick="fillExample('scenarioDescription', this)">Ïò§Ìï¥Í∞Ä ÏÉùÍ∏¥ ÌõÑ ÌôîÍ∞Ä ÎÇú ÏÉÅÎåÄÎ∞©ÏóêÍ≤å Î©îÏã†Ï†ÄÎ°ú ÏßÑÏ†ïÏÑ± ÏûàÍ≤å ÏÇ¨Í≥ºÌïòÍ≥† ÌôîÌï¥Î•º ÏãúÎèÑÌïòÎäî ÏÉÅÌô©</span>
                                <span class="example-tag" onclick="fillExample('scenarioDescription', this)">Îã§Î•∏ ÏÇ¨ÎûåÍ≥º ÏπúÌïòÍ≤å ÏßÄÎÇ¥Îäî Î™®ÏäµÏùÑ Î≥∏ ÌõÑ ÏßàÌà¨Í∞Ä ÎÇòÏÑú Î©îÏã†Ï†ÄÎ°ú ÏùÄÍ∑ºÌûà ÎßàÏùåÏùÑ ÌëúÌòÑÌïòÎäî ÏÉÅÌô©</span>
                                <span class="example-tag" onclick="fillExample('scenarioDescription', this)">ÏÉÅÎåÄÎ∞©Ïùò Î¨¥Í¥ÄÏã¨Ìïú ÌÉúÎèÑÏóê ÏÑúÏö¥Ìï®ÏùÑ ÎäêÍºàÏùÑ Îïå Î©îÏã†Ï†ÄÎ°ú ÏÜîÏßÅÌïú Í∞êÏ†ïÏùÑ ÌëúÌòÑÌïòÎäî ÏÉÅÌô©</span>
                                <span class="example-tag" onclick="fillExample('scenarioDescription', this)">ÌèâÏÜåÎ≥¥Îã§ Ïï†ÍµêÏä§ÎüΩÍ≤å Î©îÏã†Ï†ÄÎ•º Î≥¥ÎÇ¥Î©∞ ÏÉÅÎåÄÎ∞©Ïùò ÎßàÏùåÏùÑ ÏñªÏúºÎ†§Í≥† ÎÖ∏Î†•ÌïòÎäî ÏÉÅÌô©</span>
                                <span class="example-tag" onclick="fillExample('scenarioDescription', this)">ÏÉàÎ≤ΩÏóê Í∞êÏÑ±Ï†ÅÏù∏ Í∏∞Î∂ÑÏúºÎ°ú ÌèâÏÜå ÌïòÏßÄ Î™ªÌñàÎçò ÏÜîÏßÅÌïú ÎßàÏùåÏùÑ Î©îÏã†Ï†ÄÎ°ú Ï†ÑÌïòÎäî ÏÉÅÌô©</span>
                            </div>
                        </div>
                    </div>


                    <div class="form-group">
                        <label for="mood" style="font-size: 1.1em; color: #333; font-weight: bold;">üíï 4Îã®Í≥Ñ: Ïó∞Ïï† Í∞êÏ†ï ÌÖåÎßà *</label>
                        <input type="text" id="mood" required placeholder="ÌÅ¥Î¶≠Ìï¥ÏÑú Ïó∞Ïï† Í∞êÏ†ï ÏÑ†ÌÉù" />
                        <div class="examples-container">
                            <span class="examples-label">üíù Ïó∞Ïï† Î©îÌÉÄ:</span>
                            <div class="examples-grid">
                                <span class="example-tag" onclick="fillExample('mood', this)">Ïñ¥ÏÉâÌïú ÏÑ§Î†ò</span>
                                <span class="example-tag" onclick="fillExample('mood', this)">ÏßÑÏã¨ Í≥†Î∞±</span>
                                <span class="example-tag" onclick="fillExample('mood', this)">Îã¨ÏΩ§Ìïú Î∞ÄÎãπ</span>
                                <span class="example-tag" onclick="fillExample('mood', this)">Îñ®Î¶¨Îäî Ï≤´ÏÇ¨Îûë</span>
                                <span class="example-tag" onclick="fillExample('mood', this)">ÏùÄÍ∑ºÌïú ÏßàÌà¨</span>
                                <span class="example-tag" onclick="fillExample('mood', this)">ÏÑúÏö¥Ìïú ÎßàÏùå</span>
                                <span class="example-tag" onclick="fillExample('mood', this)">Ïï†ÍµêÏôÄ Ïû•ÎÇú</span>
                                <span class="example-tag" onclick="fillExample('mood', this)">ÍπäÏñ¥ÏßÄÎäî Í∞êÏ†ï</span>
                                <span class="example-tag" onclick="fillExample('mood', this)">ÏÉàÎ≤Ω Í∞êÏÑ±</span>
                                <span class="example-tag" onclick="fillExample('mood', this)">ÌôîÌï¥ÏôÄ Ïö©ÏÑú</span>
                                <span class="example-tag" onclick="fillExample('mood', this)">Í∞ÑÏ†àÌïú Í∑∏Î¶¨ÏõÄ</span>
                                <span class="example-tag" onclick="fillExample('mood', this)">ÏÜîÏßÅÌïú ÏÜçÎßàÏùå</span>
                                <span class="example-tag" onclick="fillExample('mood', this)">ÏÑ§Î†àÎäî Í∏∞ÎåÄÍ∞ê</span>
                                <span class="example-tag" onclick="fillExample('mood', this)">Îú®Í±∞Ïö¥ Ïï†Ï†ïÌëúÌòÑ</span>
                            </div>
                        </div>
                    </div>


                    <div class="form-group">
                        <label style="font-size: 1.1em; color: #333; font-weight: bold;">ü§ñ 5Îã®Í≥Ñ: Î©îÏã†Ï†Ä Ïª®ÌÖçÏä§Ìä∏ ÏÉùÏÑ±</label>
                        <button type="button" class="btn btn-secondary" onclick="generateAIContext()">
                            üì± Î©îÏã†Ï†Ä Ïª®ÌÖçÏä§Ìä∏ AI ÏÉùÏÑ±
                        </button>
                        <div id="aiContext" class="ai-context">
                            <div class="no-context">
                                <div class="no-context-message">
                                    üí° AI Ïª®ÌÖçÏä§Ìä∏Î•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî
                                </div>
                                <div class="no-context-help">
                                    ÏúÑÏùò "ü§ñ AI Ïª®ÌÖçÏä§Ìä∏ ÏÉùÏÑ±" Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ ÏÜåÏÑ§Ìíç ÏãúÎÇòÎ¶¨Ïò§ Ïª®ÌÖçÏä§Ìä∏Î•º ÏÉùÏÑ±ÌïòÏÑ∏Ïöî
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="customContext">Ïª§Ïä§ÌÖÄ Ïª®ÌÖçÏä§Ìä∏ (ÏÑ†ÌÉùÏÇ¨Ìï≠)</label>
                        <textarea id="customContext" placeholder="AI Ïª®ÌÖçÏä§Ìä∏Î•º ÏàòÏ†ïÌïòÍ±∞ÎÇò ÏßÅÏ†ë ÏûëÏÑ±Ìï† Ïàò ÏûàÏäµÎãàÎã§"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('scenarioModal')">Ï∑®ÏÜå</button>
                <button type="button" class="btn btn-primary" onclick="saveScenario()">Ï†ÄÏû•</button>
            </div>
        </div>
    </div>

    <!-- ÎåÄÌôî Î™®Îã¨ -->
    <div id="dialogueModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeModal('dialogueModal')">&times;</span>
                <h2 id="dialogueModalTitle">ÏÉà ÎåÄÌôî ÏÉùÏÑ±</h2>
            </div>
            <div class="modal-body">
                <form id="dialogueForm">
                    <input type="hidden" id="dialogueId" />
                    <input type="hidden" id="dialogueScenarioId" />

                    <!-- ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§ Ï†ïÎ≥¥ ÌëúÏãú -->
                    <div class="form-group">
                        <label>üìö ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§</label>
                        <div id="selectedScenarioInfo" class="info-display">
                            <div class="info-title">ÏãúÎÇòÎ¶¨Ïò§ Ï†úÎ™©Ïù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§</div>
                            <div class="info-character">Ï∫êÎ¶≠ÌÑ∞: </div>
                        </div>
                        <small class="form-text">ÏúÑ ÏãúÎÇòÎ¶¨Ïò§ÏôÄ Ï∫êÎ¶≠ÌÑ∞Î°ú ÎåÄÌôîÍ∞Ä ÏûêÎèô ÏÉùÏÑ±Îê©ÎãàÎã§.</small>
                    </div>

                    <div class="form-group">
                        <label for="dialogueNumber">ÎåÄÌôî Î≤àÌò∏ (1-36) *</label>
                        <input type="number" id="dialogueNumber" min="1" max="36" required readonly />
                        <small class="form-text">ÏÑ†ÌÉùÌïú Îπà ÎåÄÌôî Î≤àÌò∏Í∞Ä ÏûêÎèôÏúºÎ°ú ÏÑ§Ï†ïÎê©ÎãàÎã§.</small>
                    </div>

                    <div class="form-group">
                        <label for="difficulty">ÎÇúÏù¥ÎèÑ *</label>
                        <select id="difficulty" required>
                            <option value="easy">Easy (1-9)</option>
                            <option value="medium">Medium (10-18)</option>
                            <option value="hard">Hard (19-27)</option>
                            <option value="expert">Expert (28-36)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="userPrompt">ÏÉÅÌô© ÌîÑÎ°¨ÌîÑÌä∏ *</label>
                        <textarea id="userPrompt" required placeholder="Ïòà: Ïö∞Ïó∞Ìûà ÎèÑÏÑúÍ¥ÄÏóêÏÑú ÎßåÎÇú ÏÉÅÌô©, Í∏¥Ïû•Í∞êÍ≥º ÏÑ§Î†òÏù¥ ÍµêÏ∞®ÌïòÎäî ÏàúÍ∞Ñ"></textarea>
                    </div>

                    <div class="form-group">
                        <label>AI ÎåÄÌôî ÏÉùÏÑ±</label>
                        <button type="button" class="btn btn-secondary" onclick="generateDialogue()">
                            ü§ñ AI ÎåÄÌôî ÏÉùÏÑ±
                        </button>
                    </div>

                    <div id="dialoguePreview" class="dialogue-preview" style="display: none;">
                        <h4>ÏÉùÏÑ±Îêú ÎåÄÌôî ÎØ∏Î¶¨Î≥¥Í∏∞</h4>
                        <div class="dialogue-text" id="previewDialogue"></div>
                        <div class="narration-text" id="previewNarration"></div>
                        <ul class="choices-list" id="previewChoices"></ul>
                    </div>

                    <div class="form-group">
                        <label for="customDialogue">Ïª§Ïä§ÌÖÄ ÎåÄÌôî (ÏÑ†ÌÉùÏÇ¨Ìï≠)</label>
                        <textarea id="customDialogue" placeholder="AIÍ∞Ä ÏÉùÏÑ±Ìïú ÎåÄÌôîÎ•º ÏàòÏ†ïÌïòÍ±∞ÎÇò ÏßÅÏ†ë ÏûëÏÑ±Ìï† Ïàò ÏûàÏäµÎãàÎã§"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="customNarration">Ïª§Ïä§ÌÖÄ ÎÇòÎ†àÏù¥ÏÖò (ÏÑ†ÌÉùÏÇ¨Ìï≠)</label>
                        <textarea id="customNarration" placeholder="ÏÉÅÌô© ÏÑ§Î™ÖÏù¥ÎÇò Ï∫êÎ¶≠ÌÑ∞Ïùò ÌñâÎèôÏùÑ Î¨òÏÇ¨Ìï©ÎãàÎã§"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('dialogueModal')">Ï∑®ÏÜå</button>
                <button type="button" class="btn btn-primary" onclick="saveDialogue()">Ï†ÄÏû•</button>
            </div>
        </div>
    </div>

    <!-- Ï∫êÎ¶≠ÌÑ∞ Î™®Îã¨ - AI ÌÜµÌï©Ìòï ÏÉùÏÑ± ÏãúÏä§ÌÖú -->
    <div id="characterModal" class="modal">
        <div class="modal-content ai-character-generator">
            <div class="modal-header">
                <span class="close" onclick="closeModal('characterModal')">&times;</span>
                <h2 id="characterModalTitle">üé≠‚ú® ÏÑ∏Í≥ÑÍ¥Ä ÏµúÍ∞ï AI Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±Í∏∞</h2>
                <p style="text-align: center; color: #666; margin-top: 5px;">Ïä§ÌÅ¨Î°§ÌïòÎ©∞ ÏõêÌïòÎäî ÏöîÏÜåÎì§ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî üíñ</p>
            </div>
            <div class="modal-body">
                <form id="characterForm">
                    <input type="hidden" id="characterId" />

                    <!-- üé≠ Ï∫êÎ¶≠ÌÑ∞ ÏöîÏïΩ Ï†ïÎ≥¥ (ÏàòÏ†ï Î™®ÎìúÏùº ÎïåÎßå ÌëúÏãú) -->
                    <div id="characterSummarySection" class="character-summary-section" style="display: none;">
                        <h3>üé≠ ÌòÑÏû¨ Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥</h3>
                        <div class="current-character-display">
                            <div class="summary-grid">
                                <div class="summary-item">
                                    <span class="summary-label">Ïù¥Î¶Ñ:</span>
                                    <span id="summaryName" class="summary-value">-</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">ÎÇòÏù¥:</span>
                                    <span id="summaryAge" class="summary-value">-</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">MBTI:</span>
                                    <span id="summaryMbti" class="summary-value">-</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">ÏÑ±Î≥Ñ:</span>
                                    <span id="summaryGender" class="summary-value">-</span>
                                </div>
                            </div>
                            <div class="summary-details">
                                <div class="summary-row">
                                    <span class="summary-label">ÏÑ±Í≤©ÌäπÏÑ±:</span>
                                    <span id="summaryPersonality" class="summary-value">-</span>
                                </div>
                                <div class="summary-row">
                                    <span class="summary-label">Ï∑®ÎØ∏:</span>
                                    <span id="summaryHobbies" class="summary-value">-</span>
                                </div>
                                <div class="summary-row">
                                    <span class="summary-label">Ïô∏Î™®:</span>
                                    <span id="summaryAppearance" class="summary-value">-</span>
                                </div>
                                <div class="summary-row">
                                    <span class="summary-label">Î∞∞Í≤Ω:</span>
                                    <span id="summaryBackground" class="summary-value">-</span>
                                </div>
                                <div class="summary-row">
                                    <span class="summary-label">ÎßêÌà¨:</span>
                                    <span id="summarySpeechStyle" class="summary-value">-</span>
                                </div>
                            </div>
                            <div class="summary-actions">
                                <button type="button" class="btn btn-info btn-sm" onclick="toggleCharacterSummary()">
                                    <span id="summaryToggleText">üìñ ÏûêÏÑ∏Ìûà Î≥¥Í∏∞</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Í∏∞Î≥∏ Ï†ïÎ≥¥ -->
                    <div class="char-category">
                        <h3>üíñ Í∏∞Î≥∏ Ï†ïÎ≥¥</h3>
                        <div class="category-grid">
                            <div class="form-group">
                                <label>Ï∫êÎ¶≠ÌÑ∞ Ïù¥Î¶Ñ</label>
                                <input type="text" id="charName" placeholder="Ïòà: Ïú§ÏïÑ, ÏàòÏßÑ, ÌòúÏõê" />
                            </div>
                            <div class="form-group">
                                <label>ÎÇòÏù¥</label>
                                <select id="charAge">
                                    <option value="20" selected>20ÏÑ∏ (ÏÑ±Ïù∏ ÎåÄÌïôÏÉù)</option>
                                    <option value="21">21ÏÑ∏ (Îß§Î†•Ï†ÅÏù∏ ÎåÄÌïôÏÉù)</option>
                                    <option value="22">22ÏÑ∏ (ÏÑ±ÏàôÌïú ÎåÄÌïô ÏÑ†Î∞∞)</option>
                                    <option value="23">23ÏÑ∏ (ÏÑπÏãúÌïú ÎåÄÌïôÏõêÏÉù)</option>
                                    <option value="24">24ÏÑ∏ (Îß§ÌòπÏ†ÅÏù∏ ÎåÄÌïôÏõêÏÉù)</option>
                                    <option value="25">25ÏÑ∏ (ÏÑ±Ïù∏ Îß§Î†•Ïùò ÏÇ¨Ìöå Ï¥àÎÖÑÏÉù)</option>
                                    <option value="26">26ÏÑ∏ (ÏÑ±ÏàôÌïú ÏÇ¨ÌöåÏù∏)</option>
                                    <option value="27">27ÏÑ∏ (Îß§Î†•Ï†ÅÏù∏ ÏÇ¨ÌöåÏù∏)</option>
                                    <option value="28">28ÏÑ∏ (ÏÑπÏãúÌïú ÏßÅÏû•Ïù∏)</option>
                                    <option value="29">29ÏÑ∏ (ÏÑ±ÏàôÌïú Îß§Î†•Ïùò ÏßÅÏû•Ïù∏)</option>
                                    <option value="30">30ÏÑ∏ (ÏôÑÏÑ±Îêú ÏÑ±Ïù∏ Îß§Î†•)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Ï∫êÎ¶≠ÌÑ∞ ÌÉÄÏûÖ</label>
                                <select id="charType">
                                    <option value="seductive_junior">üíã Îß§ÌòπÏ†ÅÏù∏ ÌõÑÎ∞∞</option>
                                    <option value="sexy_peer">üî• ÏÑπÏãúÌïú ÎèôÍ∞ë</option>
                                    <option value="alluring_senior">üòà Ïú†ÌòπÏ†ÅÏù∏ ÏÑ†Î∞∞</option>
                                    <option value="sensual_friend">üíï Í¥ÄÎä•Ï†ÅÏù∏ ÏπúÍµ¨</option>
                                    <option value="mysterious_seductress">üåô Ïã†ÎπÑÎ°úÏö¥ ÏöîÎ∂Ä</option>
                                    <option value="mature_beauty">üëë ÏÑ±ÏàôÌïú ÎØ∏Ïù∏</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- ÏÑ±Í≤© ÏÑ§Ï†ï (MBTI Í∏∞Î∞ò) -->
                    <div class="char-category">
                        <h3>üß† ÏÑ±Í≤© ÏÑ§Ï†ï</h3>
                        <div class="mbti-selector">
                            <div class="mbti-group">
                                <label>MBTI Ïú†Ìòï (16Í∞ÄÏßÄ Ï†ÑÏ≤¥)</label>
                                <div class="mbti-options">
                                    <button type="button" class="mbti-btn" data-mbti="INFP">INFP<br><small>Í∞êÏÑ±Ï†Å Ï§ëÏû¨Ïûê</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="ENFP">ENFP<br><small>ÌôúÎ∞úÌïú ÌôúÎèôÍ∞Ä</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="INFJ">INFJ<br><small>ÏòπÌò∏Ïûê</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="ENFJ">ENFJ<br><small>Ï†ïÏùòÎ°úÏö¥ ÏÇ¨ÌöåÏö¥ÎèôÍ∞Ä</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="INTJ">INTJ<br><small>ÏôÑÎ≤ΩÌïú Ï†ÑÎûµÍ∞Ä</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="ENTJ">ENTJ<br><small>ÎåÄÎã¥Ìïú ÌÜµÏÜîÏûê</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="INTP">INTP<br><small>ÎÖºÎ¶¨Ï†Å ÏÇ¨ÏÉâÍ∞Ä</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="ENTP">ENTP<br><small>Îú®Í±∞Ïö¥ ÌÜ†Î°†Í∞Ä</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="ISFP">ISFP<br><small>Î™®ÌóòÍ∞Ä</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="ESFP">ESFP<br><small>ÏûêÏú†Î°úÏö¥ ÏòÅÌòº</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="ISTP">ISTP<br><small>ÎßåÎä• Ïû¨Ï£ºÍæº</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="ESTP">ESTP<br><small>Î™®ÌóòÏùÑ Ï¶êÍ∏∞Îäî ÏÇ¨ÏóÖÍ∞Ä</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="ISFJ">ISFJ<br><small>Ï°∞Ïö©Ìïú Î≥¥Ìò∏Ïûê</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="ESFJ">ESFJ<br><small>Îî∞ÎúªÌïú ÏÇ¨ÍµêÍ∞Ä</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="ISTJ">ISTJ<br><small>ÏóÑÍ≤©Ìïú Í¥ÄÎ¶¨Ïûê</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="ESTJ">ESTJ<br><small>ÏóÑÍ≤©Ìïú Í¥ÄÎ¶¨Ïûê</small></button>
                                </div>
                                <input type="hidden" id="charMbti" />
                            </div>
                            <div class="personality-traits">
                                <label>ÏÑ±Í≤© ÌäπÏÑ± (ÏµúÎåÄ 3Í∞ú ÏÑ†ÌÉù)</label>
                                <div class="trait-options">
                                    <button type="button" class="trait-btn" data-trait="Í∞êÏÑ±Ï†Å">üòä Í∞êÏÑ±Ï†Å</button>
                                    <button type="button" class="trait-btn" data-trait="ÌôúÎ∞úÌïú">‚ú® ÌôúÎ∞úÌïú</button>
                                    <button type="button" class="trait-btn" data-trait="Îß§ÌòπÏ†ÅÏù∏">üíã Îß§ÌòπÏ†ÅÏù∏</button>
                                    <button type="button" class="trait-btn" data-trait="ÏÑπÏãúÌïú">üî• ÏÑπÏãúÌïú</button>
                                    <button type="button" class="trait-btn" data-trait="Ï∞ΩÏùòÏ†Å">üé® Ï∞ΩÏùòÏ†Å</button>
                                    <button type="button" class="trait-btn" data-trait="Ïú†ÌòπÏ†ÅÏù∏">üòà Ïú†ÌòπÏ†ÅÏù∏</button>
                                    <button type="button" class="trait-btn" data-trait="ÏûêÏã†Í∞ê ÏûàÎäî">üí™ ÏûêÏã†Í∞ê ÏûàÎäî</button>
                                    <button type="button" class="trait-btn" data-trait="Ïó¥Ï†ïÏ†Å">üî• Ïó¥Ï†ïÏ†Å</button>
                                    <button type="button" class="trait-btn" data-trait="ÎèÑÎ∞úÏ†ÅÏù∏">üòè ÎèÑÎ∞úÏ†ÅÏù∏</button>
                                    <button type="button" class="trait-btn" data-trait="ÏÑ±ÏàôÌïú">üëë ÏÑ±ÏàôÌïú</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Î∞∞Í≤Ω ÏÑ§Ï†ï -->
                    <div class="char-category">
                        <h3>üéì Î∞∞Í≤Ω ÏÑ§Ï†ï</h3>
                        <div class="category-grid">
                            <div class="form-group">
                                <label>Ï†ÑÍ≥µ/ÏßÅÏóÖ</label>
                                <select id="charMajor">
                                    <option value="art">üé® ÏòàÏà†ÎåÄÌïô (ÎØ∏Ïà†, ÎîîÏûêÏù∏)</option>
                                    <option value="literature">üìö Î¨∏Í≥ºÎåÄÌïô (Î¨∏Ìïô, Ïñ¥Ìïô)</option>
                                    <option value="music">üéµ ÏùåÏïÖÎåÄÌïô</option>
                                    <option value="psychology">üß† Ïã¨Î¶¨ÌïôÍ≥º</option>
                                    <option value="education">üë©‚Äçüè´ ÏÇ¨Î≤îÎåÄÌïô</option>
                                    <option value="nursing">üë©‚Äç‚öïÔ∏è Í∞ÑÌò∏ÌïôÍ≥º</option>
                                    <option value="business">üíº Í≤ΩÏòÅÌïôÍ≥º</option>
                                    <option value="media">üì∫ Ïñ∏Î°†Ï†ïÎ≥¥ÌïôÍ≥º</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Í∞ÄÏ°± Í¥ÄÍ≥Ñ</label>
                                <select id="charFamily">
                                    <option value="only_child">Ïô∏ÎèôÎî∏</option>
                                    <option value="older_sister">Ïñ∏ÎãàÍ∞Ä ÏûàÎäî ÎßâÎÇ¥</option>
                                    <option value="younger_sibling">ÎèôÏÉùÏù¥ ÏûàÎäî Ï≤´Ïß∏</option>
                                    <option value="middle_child">Ï§ëÍ∞Ñ ÏûêÎÖÄ</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Ï∂úÏã† ÏßÄÏó≠</label>
                                <select id="charHometown">
                                    <option value="seoul">ÏÑúÏö∏ Ï∂úÏã†</option>
                                    <option value="busan">Î∂ÄÏÇ∞ Ï∂úÏã†</option>
                                    <option value="gyeonggi">Í≤ΩÍ∏∞ÎèÑ Ï∂úÏã†</option>
                                    <option value="countryside">ÏßÄÎ∞© Ï∂úÏã†</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Í¥ÄÍ≥Ñ ÏÑ§Ï†ï -->
                    <div class="char-category">
                        <h3>üíù Í¥ÄÍ≥Ñ ÏÑ§Ï†ï</h3>
                        <div class="relationship-options">
                            <button type="button" class="relationship-btn" data-rel="seductive_junior">üíã Ïú†ÌòπÏ†ÅÏù∏ ÌõÑÎ∞∞</button>
                            <button type="button" class="relationship-btn" data-rel="adult_friend">üî• ÏÑ±Ïù∏ Í¥ÄÍ≥ÑÏùò ÏπúÍµ¨</button>
                            <button type="button" class="relationship-btn" data-rel="mature_senior">üòà ÏÑ±ÏàôÌïú ÏÑ†Î∞∞</button>
                            <button type="button" class="relationship-btn" data-rel="sexy_classmate">üíï ÏÑπÏãúÌïú ÎèôÍ∏∞</button>
                            <button type="button" class="relationship-btn" data-rel="sensual_clubmate">üéØ Í¥ÄÎä•Ï†ÅÏù∏ ÎèôÏïÑÎ¶¨ ÏÑ†ÌõÑÎ∞∞</button>
                            <button type="button" class="relationship-btn" data-rel="alluring_neighbor">üè† Îß§ÌòπÏ†ÅÏù∏ Ïù¥ÏõÉ</button>
                        </div>
                        <input type="hidden" id="charRelationship" />
                    </div>

                    <!-- Ïô∏Î™® ÏÑ§Ï†ï -->
                    <div class="char-category">
                        <h3>‚ú® Ïô∏Î™® ÏÑ§Ï†ï</h3>
                        <div class="appearance-grid">
                            <div class="form-group">
                                <label>Ìó§Ïñ¥ Ïä§ÌÉÄÏùº</label>
                                <select id="charHair">
                                    <option value="long_straight">üíã ÏÑπÏãúÌïú Í∏¥ ÏÉùÎ®∏Î¶¨</option>
                                    <option value="shoulder_wave">üåä Îß§ÌòπÏ†ÅÏù∏ Ïõ®Ïù¥Î∏å</option>
                                    <option value="short_bob">üíá‚Äç‚ôÄÔ∏è ÎèÑÎ∞úÏ†ÅÏù∏ Îã®Î∞ú</option>
                                    <option value="ponytail">üéÄ Ïú†ÌòπÏ†ÅÏù∏ Ìè¨ÎãàÌÖåÏùº</option>
                                    <option value="curly_volume">üî• Î≥ºÎ•® ÏûàÎäî Ïª¨</option>
                                    <option value="messy_sexy">üòà ÏÑπÏãúÌïú Î¨¥Ï°∞Í±¥ Î®∏Î¶¨</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Îàà Î™®Ïñë</label>
                                <select id="charEyes">
                                    <option value="seductive_eyes">üòà Ïú†ÌòπÏ†ÅÏù∏ ÎààÎß§</option>
                                    <option value="almond_elegant">üòå ÏïÑÎ™¨ÎìúÌòï Ïö∞ÏïÑÌïú</option>
                                    <option value="cat_like">üò∏ Í≥†ÏñëÏù¥ Í∞ôÏùÄ</option>
                                    <option value="mysterious_deep">üåô Ïã†ÎπÑÎ°úÏö¥ ÍπäÏùÄ Îàà</option>
                                    <option value="sultry_gaze">üíã Í¥ÄÎä•Ï†ÅÏù∏ ÏãúÏÑ†</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>ÌÇ§/Ï≤¥Ìòï</label>
                                <select id="charBody">
                                    <option value="petite_sexy">üíã ÏûëÏßÄÎßå ÏÑπÏãúÌïú (155-160cm)</option>
                                    <option value="average_attractive">üî• Îß§Î†•Ï†ÅÏù∏ ÌèâÍ∑† (160-165cm)</option>
                                    <option value="tall_elegant">‚ú® Ïö∞ÏïÑÌïòÍ≤å ÌÇ§ ÌÅ∞ (165-170cm)</option>
                                    <option value="model_like">üëë Î™®Îç∏ Í∞ôÏùÄ (170cm+)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Í∞ÄÏä¥ ÏÇ¨Ïù¥Ï¶à</label>
                                <select id="charBust">
                                    <option value="small_cute">AÏªµ (ÏûëÍ≥† Í∑ÄÏó¨Ïö¥)</option>
                                    <option value="medium_balanced">BÏªµ (Í∑†ÌòïÏû°Ìûå)</option>
                                    <option value="full_attractive">CÏªµ (ÌíçÎßåÌïòÍ≥† Îß§Î†•Ï†Å)</option>
                                    <option value="voluptuous">DÏªµ (Î≥ºÎ•®Í∞ê ÏûàÎäî)</option>
                                    <option value="glamorous">EÏªµ+ (Í∏ÄÎûòÎ®∏Îü¨Ïä§)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>ÌóàÎ¶¨/ÏóâÎç©Ïù¥</label>
                                <select id="charWaistHip">
                                    <option value="slim_tight">Ïä¨Î¶ºÌïú ÌóàÎ¶¨, ÌÉÑÌÉÑÌïú ÏóâÎç©Ïù¥</option>
                                    <option value="curvy_sexy">Í≥°ÏÑ†ÎØ∏Í∞Ä ÎèãÎ≥¥Ïù¥Îäî Î™∏Îß§</option>
                                    <option value="hourglass">ÏôÑÎ≤ΩÌïú Î™®ÎûòÏãúÍ≥Ñ Î™∏Îß§</option>
                                    <option value="athletic_toned">Ïö¥ÎèôÏúºÎ°ú Îã§Ï†∏ÏßÑ Î™∏Îß§</option>
                                    <option value="soft_feminine">Î∂ÄÎìúÎüΩÍ≥† Ïó¨ÏÑ±Ïä§Îü¨Ïö¥</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Ìå®ÏÖò Ïä§ÌÉÄÏùº</label>
                                <select id="charStyle">
                                    <option value="sexy_chic">üíã ÏÑπÏãú ÏãúÌÅ¨</option>
                                    <option value="seductive_elegant">üòà Ïú†ÌòπÏ†Å ÏóòÎ†àÍ∞ÑÌä∏</option>
                                    <option value="mature_sophisticated">üëë ÏÑ±ÏàôÌïú ÏÑ∏Î†®Îê®</option>
                                    <option value="casual_alluring">üî• Ï∫êÏ£ºÏñº Îß§Ìòπ</option>
                                    <option value="provocative_fashion">üòè ÎèÑÎ∞úÏ†Å Ìå®ÏÖò</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- ÎÇ¥Î©¥/ÏäµÍ¥Ä -->
                    <div class="char-category">
                        <h3>üí´ ÎÇ¥Î©¥ & Ï∑®ÎØ∏</h3>
                        <div class="hobby-interests">
                            <div class="form-group">
                                <label>Ï∑®ÎØ∏ ÌôúÎèô (ÏµúÎåÄ 3Í∞ú ÏÑ†ÌÉù)</label>
                                <div class="hobby-options">
                                    <button type="button" class="hobby-btn" data-hobby="reading">üìö ÎèÖÏÑú</button>
                                    <button type="button" class="hobby-btn" data-hobby="drawing">üé® Í∑∏Î¶º Í∑∏Î¶¨Í∏∞</button>
                                    <button type="button" class="hobby-btn" data-hobby="music">üéµ ÏùåÏïÖ Í∞êÏÉÅ</button>
                                    <button type="button" class="hobby-btn" data-hobby="photography">üì∑ ÏÇ¨ÏßÑ Ï¥¨ÏòÅ</button>
                                    <button type="button" class="hobby-btn" data-hobby="cooking">üç≥ ÏöîÎ¶¨</button>
                                    <button type="button" class="hobby-btn" data-hobby="exercise">üèÉ‚Äç‚ôÄÔ∏è Ïö¥Îèô</button>
                                    <button type="button" class="hobby-btn" data-hobby="travel">‚úàÔ∏è Ïó¨Ìñâ</button>
                                    <button type="button" class="hobby-btn" data-hobby="movies">üé¨ ÏòÅÌôî Í∞êÏÉÅ</button>
                                    <button type="button" class="hobby-btn" data-hobby="gaming">üéÆ Í≤åÏûÑ</button>
                                    <button type="button" class="hobby-btn" data-hobby="dancing">üíÉ ÎåÑÏä§</button>
                                    <button type="button" class="hobby-btn" data-hobby="shopping">üõçÔ∏è ÏáºÌïë</button>
                                    <button type="button" class="hobby-btn" data-hobby="cafe">‚òï Ïπ¥Ìéò ÌÉêÎ∞©</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Í∞ÄÏπòÍ¥Ä</label>
                                <select id="charValues">
                                    <option value="love_family">Í∞ÄÏ°±Í≥º ÏÇ¨ÎûëÏùÑ Ï§ëÏãú</option>
                                    <option value="personal_growth">Í∞úÏù∏Ï†Å ÏÑ±Ïû•ÏùÑ Ï∂îÍµ¨</option>
                                    <option value="helping_others">ÌÉÄÏù∏ÏùÑ ÎèïÎäî Í≤ÉÏùÑ Ï¢ãÏïÑÌï®</option>
                                    <option value="creative_expression">Ï∞ΩÏùòÏ†Å ÌëúÌòÑÏùÑ Ï§ëÏãú</option>
                                    <option value="stability_security">ÏïàÏ†ïÍ≥º Î≥¥ÏïàÏùÑ Ï§ëÏãú</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- ÎßêÌà¨/ÎåÄÌôî Ïä§ÌÉÄÏùº -->
                    <div class="char-category">
                        <h3>üí¨ ÎßêÌà¨ & ÎåÄÌôî Ïä§ÌÉÄÏùº</h3>
                        <div class="speech-style-grid">
                            <div class="speech-options">
                                <button type="button" class="speech-btn" data-speech="sensual_whisper">üíã Í¥ÄÎä•Ï†ÅÏù¥Í≥† ÏÜçÏÇ≠Ïù¥Îäî</button>
                                <button type="button" class="speech-btn" data-speech="mature_elegant">üëë ÏÑ±ÏàôÌïòÍ≥† Ïö∞ÏïÑÌïú</button>
                                <button type="button" class="speech-btn" data-speech="playful_seductive">üé™ Ïû•ÎÇúÏä§ÎüΩÍ≥† Ïú†ÌòπÏ†ÅÏù∏</button>
                                <button type="button" class="speech-btn" data-speech="sexy_flirty">üòà ÏÑπÏãúÌïòÍ≥† ÎèÑÎ∞úÏ†ÅÏù∏</button>
                                <button type="button" class="speech-btn" data-speech="mysterious_seductive">üåô Ïã†ÎπÑÎ°≠Í≥† Îß§ÌòπÏ†ÅÏù∏</button>
                                <button type="button" class="speech-btn" data-speech="confident_alluring">üí™ ÏûêÏã†Í∞ê ÏûàÍ≥† Îß§Î†•Ï†ÅÏù∏</button>
                                <button type="button" class="speech-btn" data-speech="sultry_dominant">üî• ÎÜçÏóºÌïòÍ≥† Ï£ºÎèÑÏ†ÅÏù∏</button>
                                <button type="button" class="speech-btn" data-speech="sweet_tempting">üçØ Îã¨ÏΩ§ÌïòÍ≤å Ïú†ÌòπÌïòÎäî</button>
                                <button type="button" class="speech-btn" data-speech="bold_provocative">üòè ÎåÄÎã¥ÌïòÍ≥† ÎèÑÎ∞úÏ†ÅÏù∏</button>
                            </div>
                            <div class="form-group">
                                <label>ÌäπÎ≥ÑÌïú ÎßêÎ≤ÑÎ¶á/ÏäµÍ¥Ä</label>
                                <input type="text" id="charSpeechHabit" placeholder="Ïòà: Ïù¥Î™®Ìã∞ÏΩò ÏûêÏ£º ÏÇ¨Ïö©, ~Ìï¥Ïöî ÎßêÌà¨, ÏõÉÏùÑ Îïå ÏÜêÏúºÎ°ú ÏûÖ Í∞ÄÎ¶¨Í∏∞" />
                            </div>
                            <input type="hidden" id="charSpeechStyle" />
                        </div>
                    </div>

                    <!-- Ïû•Î•¥/ÏãúÎÇòÎ¶¨Ïò§ ÏÑ§Ï†ï ÏÑπÏÖò Ï†úÍ±∞Îê® -->

                    <!-- AI ÏÉùÏÑ± ÏòÅÏó≠ -->
                    <div class="char-category ai-generation">
                        <h3>ü§ñ AI ÏûêÎèô ÏÉùÏÑ± ÏòÅÏó≠</h3>
                        <div class="ai-controls">
                            <button type="button" class="btn btn-ai" onclick="generateAICharacter()">
                                ‚ú® AIÎ°ú Ï∫êÎ¶≠ÌÑ∞ ÏôÑÏÑ±ÌïòÍ∏∞
                            </button>
                            <div id="aiGenerationStatus" class="generation-status"></div>
                        </div>
                        <div class="generated-preview" id="characterPreview" style="display: none;">
                            <!-- AI ÏÉùÏÑ± Í≤∞Í≥º ÎØ∏Î¶¨Î≥¥Í∏∞ -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('characterModal')">Ï∑®ÏÜå</button>
                <button type="button" class="btn btn-primary" onclick="saveCharacter()">üíñ Ï∫êÎ¶≠ÌÑ∞ Ï†ÄÏû•</button>
            </div>
        </div>
    </div>

    <!-- Dialogue Preview Modal -->
    <div id="dialoguePreviewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeModal('dialoguePreviewModal')">&times;</span>
                <h2 id="dialoguePreviewTitle">üìñ ÎåÄÌôî ÎØ∏Î¶¨Î≥¥Í∏∞</h2>
            </div>
            <div class="modal-body">
                <div id="dialoguePreviewContent">
                    <div class="preview-section">
                        <h3>üìã ÎåÄÌôî Ï†ïÎ≥¥</h3>
                        <div id="dialogueMetadata" class="metadata-grid">
                            <!-- Dialogue metadata will be inserted here -->
                        </div>
                    </div>
                    
                    <div class="preview-section">
                        <h3>üí¨ ÎåÄÌôî ÎÇ¥Ïö©</h3>
                        <div id="dialogueDisplay" class="dialogue-container">
                            <div id="characterMessage" class="character-message">
                                <!-- Character message will be inserted here -->
                            </div>
                            <div id="narrationDisplay" class="narration">
                                <!-- Narration will be inserted here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="preview-section">
                        <h3>üîò ÏÑ†ÌÉùÏßÄ</h3>
                        <div id="choicesDisplay" class="choices-container">
                            <!-- Choices will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('dialoguePreviewModal')">Îã´Í∏∞</button>
                <button type="button" class="btn btn-primary" onclick="editDialogueFromPreview()">ÏàòÏ†ïÌïòÍ∏∞</button>
            </div>
        </div>
    </div>

    <script>
        // üîê Ïù∏Ï¶ù Í¥ÄÎ†® Ï†ÑÏó≠ Î≥ÄÏàò
        let currentAuthToken = null;
        let currentUser = null;
        let isAuthenticated = false;

        // Ï†ÑÏó≠ Î≥ÄÏàò
        let scenarios = {};
        let dialogues = {};
        let characters = {};
        let currentScenarioId = null;
        let currentDifficultyFilter = 'all';
        let currentMode = 'create';
        let selectedCharacters = new Set();
        let generatedDialogue = null;

        // Ï§ëÎ≥µ Ï≤òÎ¶¨ Î∞©ÏßÄÎ•º ÏúÑÌïú ÏÉÅÌÉú Í¥ÄÎ¶¨
        const processingState = {
            loadingEpisodes: false,
            loadingTotal: false,
            lastUpdate: null,
            updateInterval: 5000 // 5Ï¥à Í∞ÑÍ≤©ÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏ Ï†úÌïú
        };

        // üö® ÏóêÎü¨ Î°úÍπÖ ÏãúÏä§ÌÖú
        class ErrorLogger {
            static async logError(level, message, error, context = {}) {
                try {
                    const errorData = {
                        level: level, // 'critical', 'error', 'warning', 'info'
                        message: message,
                        stack: error?.stack || null,
                        url: window.location.href,
                        timestamp: new Date().toISOString(),
                        userId: currentUser?.id || 'anonymous',
                        sessionId: sessionStorage.getItem('sessionId') || null,
                        action: context.action || null,
                        component: context.component || null,
                        additionalData: {
                            userAgent: navigator.userAgent,
                            screenSize: `${screen.width}x${screen.height}`,
                            viewportSize: `${window.innerWidth}x${window.innerHeight}`,
                            ...context.data
                        }
                    };

                    // Î°úÏª¨ ÏΩòÏÜîÏóêÎèÑ Ï∂úÎ†•
                    const logMethod = level === 'critical' || level === 'error' ? console.error :
                                    level === 'warning' ? console.warn : console.log;
                    logMethod(`üö® ${level.toUpperCase()}:`, message, error);

                    // ÏÑúÎ≤ÑÎ°ú Ï†ÑÏÜ°
                    await fetch('/api/error-logger', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(errorData)
                    });

                } catch (logError) {
                    console.error('‚ùå Failed to log error to server:', logError);
                }
            }

            static critical(message, error, context = {}) {
                return this.logError('critical', message, error, context);
            }

            static error(message, error, context = {}) {
                return this.logError('error', message, error, context);
            }

            static warning(message, error, context = {}) {
                return this.logError('warning', message, error, context);
            }

            static info(message, error, context = {}) {
                return this.logError('info', message, error, context);
            }
        }

        // Ï†ÑÏó≠ ÏóêÎü¨ Ìï∏Îì§Îü¨ ÏÑ§Ï†ï
        window.addEventListener('error', (event) => {
            ErrorLogger.critical('Uncaught JavaScript Error', event.error, {
                action: 'global_error_handler',
                component: 'window',
                data: {
                    filename: event.filename,
                    lineno: event.lineno,
                    colno: event.colno
                }
            });
        });

        window.addEventListener('unhandledrejection', (event) => {
            ErrorLogger.critical('Unhandled Promise Rejection', event.reason, {
                action: 'promise_rejection',
                component: 'window'
            });
        });

        // üîç API ÏÉÅÌÉú ÌôïÏù∏ Ìï®Ïàò
        async function checkAPIStatus() {
            try {
                const response = await fetch('/api/error-logger');
                const data = await response.json();

                if (data.success) {
                    console.log('‚úÖ Error Logger API ÏÉÅÌÉú:', data.message);
                    ErrorLogger.info('API Status Check Successful', null, {
                        action: 'api_health_check',
                        component: 'error_logger',
                        data: { status: 'healthy' }
                    });
                }
            } catch (error) {
                console.error('‚ùå Error Logger API ÏÉÅÌÉú ÌôïÏù∏ Ïã§Ìå®:', error);
                // ÏóêÎü¨ Î°úÍ±∞ ÏûêÏ≤¥Ïóê Î¨∏Ï†úÍ∞Ä ÏûàÏúºÎØÄÎ°ú ÏùºÎ∞ò ÏΩòÏÜî Î°úÍ∑∏ ÏÇ¨Ïö©
            }
        }

        // üîÑ ÏÉàÎ°úÍ≥†Ïπ® ÏïåÎ¶º ÌëúÏãú Ìï®Ïàò
        function showRefreshNotification(message, isSuccess = false) {
            // Í∏∞Ï°¥ ÏïåÎ¶ºÏù¥ ÏûàÏúºÎ©¥ Ï†úÍ±∞
            const existingNotification = document.getElementById('refreshNotification');
            if (existingNotification) {
                existingNotification.remove();
            }

            // ÏÉà ÏïåÎ¶º ÏÉùÏÑ±
            const notification = document.createElement('div');
            notification.id = 'refreshNotification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${isSuccess ? '#28a745' : '#17a2b8'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-weight: bold;
                font-size: 14px;
                transition: all 0.3s ease;
                max-width: 300px;
            `;
            notification.textContent = message;

            document.body.appendChild(notification);

            // ÏÑ±Í≥µ Î©îÏãúÏßÄÎäî 3Ï¥à ÌõÑ ÏûêÎèô Ï†úÍ±∞, ÏßÑÌñâ Ï§ë Î©îÏãúÏßÄÎäî ÏàòÎèô Ï†úÍ±∞
            if (isSuccess) {
                setTimeout(() => {
                    if (notification && notification.parentNode) {
                        notification.style.opacity = '0';
                        setTimeout(() => notification.remove(), 300);
                    }
                }, 3000);
            }
        }

        // ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ ÌÜµÌï© Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî');

            // üîê Î°úÍ∑∏Ïù∏ ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî
            initializeAuth();

            // Í∏∞Ï°¥ Ï¥àÍ∏∞ÌôîÎäî Î°úÍ∑∏Ïù∏ ÌõÑÏóê Ïã§Ìñâ
        });

        // üîê ================ Î°úÍ∑∏Ïù∏ Ïù∏Ï¶ù ÏãúÏä§ÌÖú ================

        // Î°úÍ∑∏Ïù∏ ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî
        function initializeAuth() {
            console.log('üîê Î°úÍ∑∏Ïù∏ ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî');

            // ÏÑ∏ÏÖò ÌôïÏù∏
            const savedToken = sessionStorage.getItem('admin_auth_token');
            if (savedToken) {
                console.log('üíæ Ï†ÄÏû•Îêú ÌÜ†ÌÅ∞ ÌôïÏù∏ Ï§ë...');
                checkAuthToken(savedToken);
            } else {
                showLoginModal();
            }

            // Î°úÍ∑∏Ïù∏ Ìèº Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
        }

        // Î°úÍ∑∏Ïù∏ Î™®Îã¨ ÌëúÏãú
        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'flex';
            document.getElementById('adminInterface').style.display = 'none';
        }

        // Î°úÍ∑∏Ïù∏ Î™®Îã¨ Ïà®Í∏∞Í∏∞
        function hideLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('adminInterface').style.display = 'block';
        }

        // Î°úÍ∑∏Ïù∏ Ï≤òÎ¶¨
        async function handleLogin(event) {
            event.preventDefault();

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const statusEl = document.getElementById('loginStatus');

            if (!username || !password) {
                showLoginStatus('ÏÇ¨Ïö©ÏûêÎ™ÖÍ≥º ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }

            showLoginStatus('Î°úÍ∑∏Ïù∏ Ï§ë...', 'loading');

            try {
                const response = await fetch('/api/admin-auth?action=login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (data.success) {
                    console.log('‚úÖ Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ:', data);

                    // ÏÑ∏ÏÖò Ï†ïÎ≥¥ Ï†ÄÏû•
                    currentAuthToken = data.authToken;
                    currentUser = data.user;
                    isAuthenticated = true;

                    sessionStorage.setItem('admin_auth_token', data.authToken);
                    sessionStorage.setItem('admin_user', JSON.stringify(data.user));

                    showLoginStatus('Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ! ÏãúÏä§ÌÖúÏùÑ Ï¥àÍ∏∞ÌôîÌïòÎäî Ï§ë...', 'success');

                    // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
                    updateUserInfo(data.user);

                    // Î°úÍ∑∏Ïù∏Îêú ÏÇ¨Ïö©ÏûêÏùò API ÌÇ§ Î°úÎìú
                    await loadUserApiKey();

                    // Î©îÏù∏ ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî
                    setTimeout(() => {
                        hideLoginModal();
                        initializeMainSystem();
                    }, 1000);

                } else {
                    showLoginStatus(data.message || 'Î°úÍ∑∏Ïù∏Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
                }

            } catch (error) {
                await ErrorLogger.error('Login API Error', error, {
                    action: 'user_login',
                    component: 'auth_system',
                    data: { username: document.getElementById('username').value }
                });
                showLoginStatus('Î°úÍ∑∏Ïù∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message, 'error');
            }
        }

        // ÌÜ†ÌÅ∞ ÌôïÏù∏
        async function checkAuthToken(authToken) {
            try {
                console.log('üîç checkAuthToken ÎîîÎ≤ÑÍπÖ:', {
                    tokenPreview: authToken ? authToken.substring(0, 20) + '...' : 'None',
                    tokenLength: authToken ? authToken.length : 0
                });

                // Authorization Ìó§ÎçîÎ°ú ÌÜ†ÌÅ∞ Ï†ÑÏÜ°
                const response = await fetch('/api/admin-auth?action=check-session', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                const data = await response.json();

                if (data.success && data.authenticated) {
                    console.log('‚úÖ ÌÜ†ÌÅ∞ Ïú†Ìö®Ìï®:', data);

                    currentAuthToken = authToken;
                    currentUser = data.user;
                    isAuthenticated = true;

                    updateUserInfo(data.user);
                    await loadUserApiKey();
                    hideLoginModal();
                    initializeMainSystem();
                } else {
                    console.log('‚ùå ÌÜ†ÌÅ∞ Î¨¥Ìö®Ìï® ÎòêÎäî ÎßåÎ£åÎê®, Î°úÍ∑∏Ïù∏ ÌïÑÏöî');
                    sessionStorage.removeItem('admin_auth_token');
                    sessionStorage.removeItem('admin_user');
                    showLoginModal();
                }
            } catch (error) {
                await ErrorLogger.error('Session Check Error', error, {
                    action: 'check_auth_token',
                    component: 'auth_system'
                });
                showLoginModal();
            }
        }

        // Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú Î©îÏãúÏßÄ ÌëúÏãú
        function showLoginStatus(message, type) {
            const statusEl = document.getElementById('loginStatus');
            statusEl.textContent = message;
            statusEl.className = `login-status ${type}`;
            statusEl.style.display = 'block';
        }

        // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
        function updateUserInfo(user) {
            const userWelcome = document.getElementById('userWelcome');
            if (userWelcome) {
                userWelcome.textContent = `üë§ ${user.username}`;
                if (user.hasApiKey) {
                    userWelcome.textContent += ' üîë';
                }
            }
        }

        // ÏÇ¨Ïö©Ïûê API ÌÇ§ Î°úÎìú
        async function loadUserApiKey() {
            if (!currentAuthToken) return;

            try {
                console.log('üîç loadUserApiKey ÎîîÎ≤ÑÍπÖ:', {
                    tokenPreview: currentAuthToken ? currentAuthToken.substring(0, 20) + '...' : 'None',
                    tokenLength: currentAuthToken ? currentAuthToken.length : 0
                });

                // Authorization Ìó§ÎçîÎ°ú ÌÜ†ÌÅ∞ Ï†ÑÏÜ°
                const response = await fetch('/api/admin-auth?action=get-api-key', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${currentAuthToken}`
                    }
                });
                const data = await response.json();

                if (data.success && data.hasApiKey) {
                    console.log('üîë ÏÇ¨Ïö©Ïûê API ÌÇ§ Î°úÎìúÎê®:', data.keyPreview);

                    // API ÌÇ§Î•º Îã§Î•∏ ÏãúÏä§ÌÖúÏóêÏÑú ÏÇ¨Ïö©Ìï† Ïàò ÏûàÎèÑÎ°ù Ï†ÑÏó≠ ÏÑ§Ï†ï
                    if (data.apiKey) {
                        sessionStorage.setItem('openai_api_key', data.apiKey);
                    }

                    // API ÏÉÅÌÉú ÌôïÏù∏ (Îçî Í∏¥ ÎåÄÍ∏∞ ÏãúÍ∞Ñ)
                    setTimeout(() => {
                        console.log('üîÑ Î°úÍ∑∏Ïù∏ ÌõÑ API ÏÉÅÌÉú ÌôïÏù∏...');
                        checkApiStatus();
                    }, 2000);
                } else {
                    console.log('üìù ÏÇ¨Ïö©Ïûê API ÌÇ§ ÏóÜÏùå');
                }
            } catch (error) {
                console.error('‚ùå API ÌÇ§ Î°úÎìú Ïò§Î•ò:', error);
            }
        }

        // Î°úÍ∑∏ÏïÑÏõÉ
        async function logout() {
            if (!currentAuthToken) return;

            try {
                await fetch('/api/admin-auth?action=logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ authToken: currentAuthToken })
                });
            } catch (error) {
                console.error('‚ùå Î°úÍ∑∏ÏïÑÏõÉ API Ïò§Î•ò:', error);
            }

            // Î°úÏª¨ Ï†ïÎ≥¥ Ï†ïÎ¶¨
            currentAuthToken = null;
            currentUser = null;
            isAuthenticated = false;

            sessionStorage.removeItem('admin_auth_token');
            sessionStorage.removeItem('admin_user');
            sessionStorage.removeItem('openai_api_key');

            // Î°úÍ∑∏Ïù∏ ÌôîÎ©¥ ÌëúÏãú
            showLoginModal();

            // Ìèº Ï¥àÍ∏∞Ìôî
            document.getElementById('loginForm').reset();
            document.getElementById('loginStatus').style.display = 'none';

            console.log('üëã Î°úÍ∑∏ÏïÑÏõÉ ÏôÑÎ£å');
        }

        // Î©îÏù∏ ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî (Î°úÍ∑∏Ïù∏ ÌõÑ Ïã§Ìñâ)
        function initializeMainSystem() {
            console.log('üöÄ Î©îÏù∏ ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî ÏãúÏûë...');

            // API ÏÉÅÌÉú ÌôïÏù∏
            checkAPIStatus();

            // Í∏∞Ï°¥ Ï¥àÍ∏∞Ìôî ÏΩîÎìúÎì§
            initializeEventListeners();

            // Ïò®ÎùºÏù∏ ÏãúÏä§ÌÖúÏúºÎ°ú Ï†ÑÌôò: Î≥ÑÎèÑ Ï¥àÍ∏∞Ìôî ÎåÄÍ∏∞
            console.log('‚è∞ Ïò®ÎùºÏù∏ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ï¥àÍ∏∞Ìôî ÎåÄÍ∏∞ Ï§ë...');

            // Î°úÍ∑∏Ïù∏ ÌõÑ Îç∞Ïù¥ÌÑ∞ Î°úÎìú (Ï∂©Î∂ÑÌïú ÎîúÎ†àÏù¥Î°ú Î™®Îì† Ï¥àÍ∏∞Ìôî ÏôÑÎ£å ÌõÑ Ïã§Ìñâ)
            setTimeout(async () => {
                if (typeof window.loadDataAfterLogin === 'function') {
                    await window.loadDataAfterLogin();
                } else {
                    console.warn('‚ö†Ô∏è loadDataAfterLogin Ìï®ÏàòÍ∞Ä ÏïÑÏßÅ Î°úÎìúÎêòÏßÄ ÏïäÏùå. Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏãúÎèÑ...');
                    // Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏãúÎèÑ
                    try {
                        await loadCharacters();
                        await loadScenarios();
                        await loadTotalEpisodeCount(); // Ï†ÑÏ≤¥ ÏóêÌîºÏÜåÎìú Ïπ¥Ïö¥Ìä∏ Î°úÎìú
                        displayAvailableScenarios(); // ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÏûêÎèô ÌëúÏãú
                    } catch (error) {
                        console.error('‚ùå Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
                    }
                }
            }, 3000);
        }

        // üîê ================ Î°úÍ∑∏Ïù∏ ÏãúÏä§ÌÖú ÎÅù ================

        // API ÌÇ§ ÏûêÎèô Î≥µÏõê Ìï®Ïàò
        function restoreApiKey() {
            try {
                const savedKeyData = localStorage.getItem('chatgame_openai_key');
                if (savedKeyData) {
                    const keyData = JSON.parse(savedKeyData);
                    const savedTime = new Date(keyData.timestamp);
                    const now = new Date();
                    const hoursDiff = (now - savedTime) / (1000 * 60 * 60);

                    // 7Ïùº Ïù¥ÎÇ¥Ïùò ÌÇ§Îßå Î≥µÏõê (Î≥¥Ïïà)
                    if (hoursDiff <= 24 * 7) {
                        console.log('üîë Ï†ÄÏû•Îêú API ÌÇ§ Î≥µÏõê:', keyData.key.substring(0, 4) + '...');

                        // ÏÑúÎ≤ÑÏóê API ÌÇ§ Ïû¨ÏÑ§Ï†ï
                        fetch('/api/save-api-key', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ apiKey: keyData.key })
                        }).then(response => {
                            if (response.ok) {
                                console.log('‚úÖ API ÌÇ§ ÏûêÎèô Î≥µÏõê ÏôÑÎ£å');
                                sessionStorage.setItem('openai_api_key', keyData.key);
                                // ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ (1Ï¥à ÌõÑ)
                                setTimeout(checkApiStatus, 1000);
                            } else {
                                console.warn('‚ö†Ô∏è API ÌÇ§ Î≥µÏõê Ïã§Ìå®');
                            }
                        }).catch(error => {
                            console.warn('‚ö†Ô∏è API ÌÇ§ Î≥µÏõê Ï§ë Ïò§Î•ò:', error);
                        });
                    } else {
                        console.log('‚è∞ Ï†ÄÏû•Îêú API ÌÇ§Í∞Ä ÎÑàÎ¨¥ Ïò§ÎûòÎê® (7Ïùº Ï¥àÍ≥º), Ï†úÍ±∞');
                        localStorage.removeItem('chatgame_openai_key');
                    }
                } else {
                    console.log('üîç Ï†ÄÏû•Îêú API ÌÇ§ ÏóÜÏùå');
                }
            } catch (error) {
                console.error('‚ùå API ÌÇ§ Î≥µÏõê Ïò§Î•ò:', error);
            }
        }

        // Î™®Îì† Îç∞Ïù¥ÌÑ∞ Î°úÎìú (LocalStorage Ïö∞ÏÑ†)
        async function loadAllData() {
            console.log('üìä ÌÜµÌï© Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏãúÏûë...');
            
            try {
                // 1Îã®Í≥Ñ: LocalStorageÏóêÏÑú Î°úÎìú ÏãúÎèÑ
                console.log('üîÑ 1Îã®Í≥Ñ: LocalStorageÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏãúÎèÑ...');
                const localChars = localStorage.getItem('characters');
                const localScenarios = localStorage.getItem('scenarios');
                
                if (localChars) {
                    const parsedChars = JSON.parse(localChars);
                    if (Object.keys(parsedChars).length > 0) {
                        console.log('‚úÖ LocalStorageÏóêÏÑú Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú ÏÑ±Í≥µ:', Object.keys(parsedChars).length, 'Í∞ú');
                        // Ï†ÑÏó≠ Î≥ÄÏàòÏôÄ window ÏÜçÏÑ± Î™®ÎëêÏóê ÏÑ§Ï†ï
                        characters = parsedChars;
                        window.characters = parsedChars;
                        
                        const parsedScenarios = localScenarios ? JSON.parse(localScenarios) : {};
                        scenarios = parsedScenarios;
                        window.scenarios = parsedScenarios;
                        
                        displayCharacters();
                        displayScenarios();
                        updateAllStats();
                        return true;
                    }
                }
                
                // 2Îã®Í≥Ñ: Í∏∞Ï°¥ APIÏóêÏÑú Î°úÎìú ÏãúÎèÑ  
                console.log('üîÑ 2Îã®Í≥Ñ: Í∏∞Ï°¥ APIÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏãúÎèÑ...');
                await loadScenarios();
                await loadCharacters();
                await loadTotalEpisodeCount(); // Ï†ÑÏ≤¥ ÏóêÌîºÏÜåÎìú Ïπ¥Ïö¥Ìä∏ Î°úÎìú
                updateAllStats();
                
                if (window.characters && Object.keys(window.characters).length > 0) {
                    console.log('‚úÖ Í∏∞Ï°¥ APIÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏÑ±Í≥µ');
                    return true;
                }
                
                // Î™®Îì† Î∞©Î≤ï Ïã§Ìå®
                console.log('‚ö†Ô∏è Î™®Îì† Îç∞Ïù¥ÌÑ∞ ÏÜåÏä§ÏóêÏÑú Î°úÎìú Ïã§Ìå® - Îπà ÏÉÅÌÉúÎ°ú ÏãúÏûë');
                window.characters = {};
                window.scenarios = {};
                updateAllStats();
                return false;
                
            } catch (error) {
                console.error('‚ùå Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ï§ë Ïò§Î•ò:', error);
                // Í∏∞Î≥∏Í∞íÏúºÎ°ú ÏÑ§Ï†ï
                window.characters = window.characters || {};
                window.scenarios = window.scenarios || {};
                updateAllStats();
                return false;
            }
        }

        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï¥àÍ∏∞Ìôî
        function initializeEventListeners() {
            // Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉùÍ∏∞Îäî ÎèôÏ†Å Î°úÎî©ÏúºÎ°ú Ï¥àÍ∏∞ÌôîÎê®
            loadCharacterSelector();

            // ÏÉàÎ°úÏö¥ AI Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ± ÏãúÏä§ÌÖú Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑàÎì§
            initializeCharacterGeneratorEvents();

            // ESC ÌÇ§Î°ú Î™®Îã¨ Îã´Í∏∞
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                }
            });

            // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ÏúºÎ°ú Îã´Í∏∞
            window.onclick = function(event) {
                if (event.target.className === 'modal') {
                    event.target.style.display = 'none';
                }
            }
        }
        
        // Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉùÍ∏∞ ÎèôÏ†Å Î°úÎî©
        async function loadCharacterSelector() {
            console.log('üîÑ Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉùÍ∏∞ Î°úÎî© ÏãúÏûë...');
            
            try {
                const charactersData = window.characters || {};
                const characterKeys = Object.keys(charactersData);
                
                console.log('üìä Î°úÎìúÎêú Ï∫êÎ¶≠ÌÑ∞:', characterKeys.length, 'Í∞ú');
                
                const selector = document.getElementById('characterSelector');
                const loadingMsg = document.getElementById('characterLoadingMsg');
                
                if (characterKeys.length === 0) {
                    loadingMsg.innerHTML = '‚ùå ÏÉùÏÑ±Îêú Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.<br><small>Î®ºÏ†Ä Ï∫êÎ¶≠ÌÑ∞ ÌÉ≠ÏóêÏÑú Ï∫êÎ¶≠ÌÑ∞Î•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.</small>';
                    selector.style.display = 'none';
                    return;
                }
                
                // Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉù ÏòµÏÖò ÏÉùÏÑ±
                let html = '';
                characterKeys.forEach(charId => {
                    const char = charactersData[charId];
                    html += `
                        <div class="character-option" data-id="${charId}">
                            ${char.name} (${char.mbti})<br>
                            <small>${char.personality_traits?.primary?.slice(0, 2).join(', ') || 'ÏÉùÏÑ±Îêú Ï∫êÎ¶≠ÌÑ∞'}</small>
                        </div>
                    `;
                });
                
                selector.innerHTML = html;
                selector.style.display = 'grid';
                loadingMsg.style.display = 'none';
                
                // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä (Îã®Ïùº ÏÑ†ÌÉù)
                selector.querySelectorAll('.character-option').forEach(option => {
                    option.addEventListener('click', function() {
                        const characterId = this.dataset.id;

                        // Í∏∞Ï°¥ ÏÑ†ÌÉù Ìï¥Ï†ú (Î™®Îì† Ï∫êÎ¶≠ÌÑ∞)
                        selector.querySelectorAll('.character-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        selectedCharacters.clear();

                        // ÏÉà Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉù
                        this.classList.add('selected');
                        selectedCharacters.add(characterId);

                        console.log('‚úÖ ÏÑ†ÌÉùÎêú Ï∫êÎ¶≠ÌÑ∞ (Îã®Ïùº):', characterId);
                        console.log('‚úÖ ÏÑ†ÌÉùÎêú Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥:', charactersData[characterId]?.name, charactersData[characterId]?.mbti);
                    });
                });
                
                console.log('‚úÖ Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉùÍ∏∞ Î°úÎî© ÏôÑÎ£å');
                
            } catch (error) {
                console.error('‚ùå Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉùÍ∏∞ Î°úÎî© Ïã§Ìå®:', error);
                document.getElementById('characterLoadingMsg').innerHTML = 
                    '‚ùå Ï∫êÎ¶≠ÌÑ∞ Î°úÎî© Ïã§Ìå®<br><small>ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®ÌïòÍ±∞ÎÇò Ï∫êÎ¶≠ÌÑ∞Î•º Îã§Ïãú ÏÉùÏÑ±Ìï¥Î≥¥ÏÑ∏Ïöî.</small>';
            }
        }
        
        // ÏóêÌîºÏÜåÎìú ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉùÍ∏∞ Î°úÎî©
        async function loadDialogueScenarioSelector() {
            console.log('üîÑ ÏóêÌîºÏÜåÎìú ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉùÍ∏∞ Î°úÎî© ÏãúÏûë...');
            
            try {
                // Î™®Îì† ÏÜåÏä§ÏóêÏÑú ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ ÌÜµÌï© Î°úÎî©
                let scenariosData = {};
                
                // 1. Ï†ÑÏó≠ Î≥ÄÏàò scenarios ÌôïÏù∏
                if (window.scenarios && Object.keys(window.scenarios).length > 0) {
                    scenariosData = { ...window.scenarios };
                    console.log('‚úÖ window.scenariosÏóêÏÑú Î°úÎî©:', Object.keys(scenariosData).length, 'Í∞ú');
                }
                
                // 2. Ï†ÑÏó≠ scenarios Î≥ÄÏàò ÌôïÏù∏
                if (typeof scenarios !== 'undefined' && Object.keys(scenarios).length > 0) {
                    scenariosData = { ...scenariosData, ...scenarios };
                    console.log('‚úÖ Ï†ÑÏó≠ scenariosÏóêÏÑú Ï∂îÍ∞Ä Î°úÎî©:', Object.keys(scenariosData).length, 'Í∞ú');
                }
                
                // 3. LocalStorageÏóêÏÑú Î°úÎî©
                const localScenarios = localStorage.getItem('scenarios');
                if (localScenarios) {
                    const parsedLocal = JSON.parse(localScenarios);
                    scenariosData = { ...scenariosData, ...parsedLocal };
                    console.log('‚úÖ LocalStorageÏóêÏÑú Ï∂îÍ∞Ä Î°úÎî©:', Object.keys(scenariosData).length, 'Í∞ú');
                }
                
                // Î™®Îì† Î≥ÄÏàò ÎèôÍ∏∞Ìôî
                scenarios = scenariosData;
                window.scenarios = scenariosData;
                
                const scenarioKeys = Object.keys(scenariosData);
                console.log('üìä ÏµúÏ¢Ö Î°úÎìúÎêú ÏãúÎÇòÎ¶¨Ïò§:', scenarioKeys.length, 'Í∞ú');
                console.log('üìã ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù:', scenarioKeys.map(id => `${id}: ${scenariosData[id]?.title || 'Ï†úÎ™©ÏóÜÏùå'}`));
                
                const selector = document.getElementById('dialogueScenarioSelect');
                if (!selector) {
                    return; // Ïπ¥Îìú Í∏∞Î∞ò UI ÏÇ¨Ïö©
                }
                
                // Í∏∞Î≥∏ ÏòµÏÖò Ïú†ÏßÄ
                let html = '<option value="">ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>';
                
                if (scenarioKeys.length === 0) {
                    html += '<option value="" disabled>ÏÉùÏÑ±Îêú ÏãúÎÇòÎ¶¨Ïò§Í∞Ä ÏóÜÏäµÎãàÎã§</option>';
                } else {
                    scenarioKeys.forEach(scenarioId => {
                        const scenario = scenariosData[scenarioId];
                        if (scenario && scenario.title) {
                            html += `<option value="${scenarioId}">${scenario.title}</option>`;
                        } else {
                            console.warn('‚ö†Ô∏è ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ Î∂àÏôÑÏ†Ñ:', scenarioId, scenario);
                            html += `<option value="${scenarioId}">ÏãúÎÇòÎ¶¨Ïò§ ${scenarioId}</option>`;
                        }
                    });
                }
                
                selector.innerHTML = html;
                console.log('‚úÖ ÏóêÌîºÏÜåÎìú ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉùÍ∏∞ Î°úÎî© ÏôÑÎ£å');
                console.log('üîç ÏÉùÏÑ±Îêú HTML:', html);
                
            } catch (error) {
                console.error('‚ùå ÏóêÌîºÏÜåÎìú ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉùÍ∏∞ Î°úÎî© Ïã§Ìå®:', error);
                // ÏóêÎü¨ Î∞úÏÉù ÏãúÏóêÎèÑ Í∏∞Î≥∏ ÏÑ†ÌÉùÏßÄÎäî Ï†úÍ≥µ
                const selector = document.getElementById('dialogueScenarioSelect');
                if (selector) {
                    selector.innerHTML = '<option value="">ÏãúÎÇòÎ¶¨Ïò§ Î°úÎî© Ïò§Î•ò</option>';
                }
            }
        }
        
        // ÏãúÎÇòÎ¶¨Ïò§ Î≥ÄÍ≤Ω Ïãú Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
        function onScenarioChange() {
            const scenarioId = document.getElementById('dialogueScenarioSelect').value;
            console.log('üîÑ ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§:', scenarioId);
            
            const characterSelect = document.getElementById('characterSelect');
            
            if (!scenarioId) {
                characterSelect.innerHTML = '<option value="">Î®ºÏ†Ä ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>';
                return;
            }
            
            try {
                const scenariosData = window.scenarios || {};
                const scenario = scenariosData[scenarioId];
                
                if (!scenario) {
                    characterSelect.innerHTML = '<option value="">ÏãúÎÇòÎ¶¨Ïò§Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§</option>';
                    return;
                }
                
                console.log('üìä ÏãúÎÇòÎ¶¨Ïò§ ÏÇ¨Ïö©Í∞ÄÎä• Ï∫êÎ¶≠ÌÑ∞:', scenario.available_characters);
                
                let html = '<option value="">Ï∫êÎ¶≠ÌÑ∞Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>';
                
                if (scenario.available_characters && scenario.available_characters.length > 0) {
                    const charactersData = window.characters || {};
                    
                    scenario.available_characters.forEach(charId => {
                        const character = charactersData[charId];
                        if (character) {
                            html += `<option value="${charId}">${character.name} (${character.mbti})</option>`;
                        } else {
                            // Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥Í∞Ä ÏóÜÎäî Í≤ΩÏö∞ IDÎßå ÌëúÏãú
                            html += `<option value="${charId}">${charId}</option>`;
                        }
                    });
                } else {
                    html += '<option value="" disabled>Ïù¥ ÏãúÎÇòÎ¶¨Ïò§Ïóê ÏÇ¨Ïö©Í∞ÄÎä•Ìïú Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</option>';
                }
                
                characterSelect.innerHTML = html;
                
                // Ïà®Í≤®ÏßÑ ÌïÑÎìúÏóêÎèÑ ÏãúÎÇòÎ¶¨Ïò§ ID ÏÑ§Ï†ï
                document.getElementById('dialogueScenarioId').value = scenarioId;
                
                console.log('‚úÖ Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
                
            } catch (error) {
                console.error('‚ùå Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®:', error);
                characterSelect.innerHTML = '<option value="">Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§</option>';
            }
        }
        
        // ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ® (Î©îÏù∏ ÏãúÎÇòÎ¶¨Ïò§ ÏÑπÏÖò)
        async function refreshScenarioList() {
            console.log('üîÑ ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®...');
            try {
                await loadScenarios();
                console.log('‚úÖ ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ® ÏôÑÎ£å');
            } catch (error) {
                console.error('‚ùå ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ® Ïã§Ìå®:', error);
                throw error;
            }
        }

        // ÎåÄÌôî ÏÑπÏÖòÏùò ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
        function refreshDialogueScenarioList() {
            console.log('üîÑ ÎåÄÌôî ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®...');
            
            // Îëê Í≥≥ Î™®Îëê ÏóÖÎç∞Ïù¥Ìä∏
            loadDialogueScenarioCards(); // ÏÉàÎ°úÏö¥ Ïπ¥Îìú ÌòïÌÉú
            loadDialogueScenarioSelector(); // Î™®Îã¨Ïö©
            displayAvailableScenarios(); // ÏóêÌîºÏÜåÎìú ÏÑπÏÖòÏö©
            
            // ÏóêÌîºÏÜåÎìú ÏÑπÏÖòÏùò ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉù ÎìúÎ°≠Îã§Ïö¥ÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
            const dialogueSelect = document.getElementById('dialogueScenarioSelect');
            if (dialogueSelect) {
                loadDialogueScenarioSelector().then(() => {
                    // Î™®Îã¨Ïö© ÏÑ†ÌÉùÍ∏∞Ïùò ÎÇ¥Ïö©ÏùÑ ÏóêÌîºÏÜåÎìú ÏÑπÏÖòÏúºÎ°ú Î≥µÏÇ¨
                    const modalSelect = document.getElementById('dialogueScenarioSelect');
                    if (modalSelect) {
                        dialogueSelect.innerHTML = modalSelect.innerHTML;
                    }
                });
            }
        }
        
        // ÏóêÌîºÏÜåÎìú ÏÑπÏÖòÏóê ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÌëúÏãú
        function displayAvailableScenarios() {
            console.log('üìã ÏóêÌîºÏÜåÎìú ÏÑπÏÖòÏóê ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÌëúÏãú...');

            try {
                // ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ Î°úÎî©
                let scenariosData = window.scenarios || {};

                // LocalStorageÏóêÏÑúÎèÑ ÌôïÏù∏
                if (Object.keys(scenariosData).length === 0) {
                    const localScenarios = localStorage.getItem('scenarios');
                    if (localScenarios) {
                        scenariosData = JSON.parse(localScenarios);
                        window.scenarios = scenariosData;
                    }
                }

                const scenarioKeys = Object.keys(scenariosData);
                const scenariosListDiv = document.getElementById('scenarioCardsContainer');

                // DOM ÏöîÏÜåÍ∞Ä Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏúºÎ©¥ ÏóêÎü¨ Î∞©ÏßÄ
                if (!scenariosListDiv) {
                    console.warn('‚ö†Ô∏è scenarioCardsContainer ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                    return;
                }
                
                if (scenarioKeys.length === 0) {
                    scenariosListDiv.innerHTML = `
                        <div class="loading-card">
                            <p>‚ùå ÏÉùÏÑ±Îêú ÏãúÎÇòÎ¶¨Ïò§Í∞Ä ÏóÜÏäµÎãàÎã§.</p>
                            <p><small>Î®ºÏ†Ä ÏãúÎÇòÎ¶¨Ïò§ ÌÉ≠ÏóêÏÑú ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.</small></p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                scenarioKeys.forEach(scenarioId => {
                    const scenario = scenariosData[scenarioId];
                    if (scenario) {
                        html += `
                            <div class="scenario-selection-card" onclick="selectScenarioCard('${scenarioId}')" data-scenario-id="${scenarioId}">
                                <div class="scenario-header">
                                    <h5>${scenario.title || 'Ï†úÎ™© ÏóÜÏùå'}</h5>
                                    <span class="scenario-mood">${scenario.mood || 'ÏùºÎ∞ò'}</span>
                                </div>
                                <p class="scenario-description">${(scenario.description || '').substring(0, 100)}${scenario.description && scenario.description.length > 100 ? '...' : ''}</p>
                                <div class="scenario-stats">
                                    <span class="stat-item">üìö ${scenario.dialogue_count || 0}/36 ÏóêÌîºÏÜåÎìú</span>
                                    <span class="stat-item">üë• ${scenario.available_characters ? scenario.available_characters.length : 0} Ï∫êÎ¶≠ÌÑ∞</span>
                                </div>
                            </div>
                        `;
                    }
                });

                scenariosListDiv.innerHTML = html;
                console.log('‚úÖ ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÌëúÏãú ÏôÑÎ£å:', scenarioKeys.length, 'Í∞ú');
                
            } catch (error) {
                console.error('‚ùå ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÌëúÏãú Ïã§Ìå®:', error);
                const errorContainer = document.getElementById('scenarioCardsContainer');
                if (errorContainer) {
                    errorContainer.innerHTML = `
                        <div class="loading-card">
                            <p>‚ùå ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù Î°úÎî© Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.</p>
                            <p><small>ÏΩòÏÜîÏùÑ ÌôïÏù∏ÌïòÍ±∞ÎÇò ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Î≥¥ÏÑ∏Ïöî.</small></p>
                        </div>
                    `;
                }
            }
        }

        // ÏóêÌîºÏÜåÎìú ÏãúÎÇòÎ¶¨Ïò§ Ïπ¥Îìú Î°úÎî© (ÏÉàÎ°úÏö¥ Ïπ¥Îìú ÌòïÌÉú)
        async function loadDialogueScenarioCards() {
            console.log('üîÑ ÏóêÌîºÏÜåÎìú ÏãúÎÇòÎ¶¨Ïò§ Ïπ¥Îìú Î°úÎî© ÏãúÏûë...');

            try {
                // Î™®Îì† ÏÜåÏä§ÏóêÏÑú ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ ÌÜµÌï© Î°úÎî©
                let scenariosData = {};

                // 1. ÏãúÎÇòÎ¶¨Ïò§ Î©îÎãàÏ†ÄÏóêÏÑú ÏµúÏã† Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
                try {
                    const response = await fetch('/api/scenario-manager?action=list');
                    if (response.ok) {
                        const result = await response.json();
                        console.log('üìä ÏãúÎÇòÎ¶¨Ïò§ Îß§ÎãàÏ†Ä ÏùëÎãµ:', result);

                        if (result.success && result.scenarios) {
                            scenariosData = { ...scenariosData, ...result.scenarios };
                            console.log('‚úÖ ÏãúÎÇòÎ¶¨Ïò§ Îß§ÎãàÏ†ÄÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î°úÎìúÎê®');
                        }
                    }
                } catch (err) {
                    console.log('‚ö†Ô∏è ÏãúÎÇòÎ¶¨Ïò§ Îß§ÎãàÏ†Ä Ï†ëÍ∑º Ïã§Ìå®:', err.message);
                }

                console.log('üîç ÌÜµÌï©Îêú ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞:', scenariosData);

                // 2. ÏãúÎÇòÎ¶¨Ïò§ Ïπ¥Îìú ÏÉùÏÑ±
                const container = document.getElementById('scenarioCardsContainer');

                // ÌôúÏÑ± ÏãúÎÇòÎ¶¨Ïò§Îì§Îßå ÌïÑÌÑ∞ÎßÅ
                const activeScenarios = Object.values(scenariosData).filter(scenario =>
                    scenario && scenario.active_status !== false
                );

                console.log('üéØ ÌôúÏÑ± ÏãúÎÇòÎ¶¨Ïò§:', activeScenarios);

                if (activeScenarios.length > 0) {
                    let cardsHTML = '';

                    activeScenarios.forEach(scenario => {
                        const characterName = scenario.available_characters && scenario.available_characters.length > 0 ?
                            scenario.available_characters[0] : 'Ï∫êÎ¶≠ÌÑ∞ ÏóÜÏùå';

                        const createdDate = scenario.created_date ?
                            new Date(scenario.created_date).toLocaleDateString('ko-KR') : 'ÎÇ†Ïßú Ï†ïÎ≥¥ ÏóÜÏùå';

                        cardsHTML += `
                            <div class="scenario-selection-card" onclick="selectScenarioCard('${scenario.scenario_id}')" data-scenario-id="${scenario.scenario_id}">
                                <div class="scenario-card-header">
                                    <h6 class="scenario-card-title">${scenario.title}</h6>
                                    <span class="scenario-card-badge">${scenario.mood || 'ÏùºÎ∞ò'}</span>
                                </div>
                                <div class="scenario-card-description">
                                    ${scenario.description || 'ÏÑ§Î™ÖÏù¥ ÏóÜÏäµÎãàÎã§.'}
                                </div>
                                <div class="scenario-card-meta">
                                    <span class="scenario-card-character">üë§ ${characterName}</span>
                                    <span>üìÖ ${createdDate}</span>
                                </div>
                            </div>
                        `;
                    });

                    container.innerHTML = cardsHTML;
                } else {
                    container.innerHTML = `
                        <div class="loading-card">
                            <p style="margin: 0;">Îì±Î°ùÎêú ÏãúÎÇòÎ¶¨Ïò§Í∞Ä ÏóÜÏäµÎãàÎã§</p>
                            <small>ÏãúÎÇòÎ¶¨Ïò§Î•º Î®ºÏ†Ä ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî</small>
                        </div>
                    `;
                }

                console.log('‚úÖ ÏóêÌîºÏÜåÎìú ÏãúÎÇòÎ¶¨Ïò§ Ïπ¥Îìú Î°úÎî© ÏôÑÎ£å');

            } catch (error) {
                console.error('‚ùå ÏóêÌîºÏÜåÎìú ÏãúÎÇòÎ¶¨Ïò§ Ïπ¥Îìú Î°úÎî© Ïã§Ìå®:', error);
                const container = document.getElementById('scenarioCardsContainer');
                if (container) {
                    container.innerHTML = `
                        <div class="loading-card">
                            <p style="margin: 0; color: #dc3545;">ÏãúÎÇòÎ¶¨Ïò§ Î°úÎî© Ïò§Î•ò</p>
                            <small>${error.message}</small>
                        </div>
                    `;
                }
            }
        }

        // ÏãúÎÇòÎ¶¨Ïò§ Ïπ¥Îìú ÏÑ†ÌÉù
        function selectScenarioCard(scenarioId) {
            console.log('üéØ ÏãúÎÇòÎ¶¨Ïò§ Ïπ¥Îìú ÏÑ†ÌÉùÎê®:', scenarioId);

            // Í∏∞Ï°¥ ÏÑ†ÌÉù Ìï¥Ï†ú
            document.querySelectorAll('.scenario-selection-card').forEach(card => {
                card.classList.remove('selected');
            });

            // ÏÉàÎ°úÏö¥ Ïπ¥Îìú ÏÑ†ÌÉù
            const selectedCard = document.querySelector(`[data-scenario-id="${scenarioId}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }

            // Ï†ÑÏó≠ Î≥ÄÏàòÏóê ÌòÑÏû¨ ÏãúÎÇòÎ¶¨Ïò§ ID ÏÑ§Ï†ï
            currentScenarioId = scenarioId;
            console.log('‚úÖ currentScenarioId ÏÑ§Ï†ïÎê®:', currentScenarioId);

            // ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§ Ï†ïÎ≥¥ ÌëúÏãú
            showSelectedScenarioInfo(scenarioId);

            // ÏóêÌîºÏÜåÎìú Î°úÎìú
            loadDialogues();
        }

        // ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§ Ï†ïÎ≥¥ ÌëúÏãú
        function showSelectedScenarioInfo(scenarioId) {
            const scenario = window.scenarios?.[scenarioId];
            const display = document.getElementById('selectedScenarioDisplay');
            const info = document.getElementById('selectedScenarioInfo');

            if (scenario && display && info) {
                const characterId = scenario.available_characters?.[0];
                const character = window.characters?.[characterId];

                info.innerHTML = `
                    <div class="info-title">${scenario.title}</div>
                    <div class="info-character">Ï∫êÎ¶≠ÌÑ∞: ${character ? character.name : characterId || 'Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥ ÏóÜÏùå'}</div>
                    <div class="info-description">${scenario.description}</div>
                `;

                display.style.display = 'block';
            }
        }

        // ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉù Ìï¥Ï†ú
        function clearScenarioSelection() {
            currentScenarioId = null;

            // Ïπ¥Îìú ÏÑ†ÌÉù Ìï¥Ï†ú
            document.querySelectorAll('.scenario-selection-card').forEach(card => {
                card.classList.remove('selected');
            });

            // ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§ Ï†ïÎ≥¥ Ïà®Í∏∞Í∏∞
            document.getElementById('selectedScenarioDisplay').style.display = 'none';

            // ÏóêÌîºÏÜåÎìú Ï†ïÎ≥¥ Ïà®Í∏∞Í∏∞
            const dialogueInfo = document.getElementById('dialogueInfo');
            if (dialogueInfo) {
                dialogueInfo.style.display = 'none';
            }

            console.log('‚úÖ ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉù Ìï¥Ï†úÎê®');
        }

        // ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉù (ÏóêÌîºÏÜåÎìú ÏÑπÏÖòÏóêÏÑú)
        function selectScenarioForDialogue(scenarioId) {
            console.log('üéØ ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉùÎê®:', scenarioId);

            // Ï†ÑÏó≠ Î≥ÄÏàòÏóê ÌòÑÏû¨ ÏãúÎÇòÎ¶¨Ïò§ ID ÏÑ§Ï†ï
            currentScenarioId = scenarioId;
            console.log('‚úÖ currentScenarioId ÏÑ§Ï†ïÎê®:', currentScenarioId);

            const dialogueSelect = document.getElementById('dialogueScenarioSelect');
            if (dialogueSelect) {
                dialogueSelect.value = scenarioId;
            }

            // ÏóêÌîºÏÜåÎìú Î°úÎî©
            loadDialogues();

            // ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§ ÌïòÏù¥ÎùºÏù¥Ìä∏
            document.querySelectorAll('.scenario-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.closest('.scenario-item').classList.add('selected');
        }

        // ÌÉ≠ Ï†ÑÌôò (Ï†ÑÏó≠ Ìï®Ïàò)
        function switchTab(tabName) {
            // Î™®Îì† ÌÉ≠Í≥º ÏÑπÏÖò ÎπÑÌôúÏÑ±Ìôî
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));

            // ÏÑ†ÌÉùÎêú ÌÉ≠Í≥º ÏÑπÏÖò ÌôúÏÑ±Ìôî
            event.target.classList.add('active');
            document.getElementById(`${tabName}-section`).classList.add('active');

            // ÏãúÎÇòÎ¶¨Ïò§ ÌÉ≠ ÏÑ†ÌÉù Ïãú CSS Ï†ÅÏö© Î≥¥Ïû•ÏùÑ ÏúÑÌïú Ïû¨ÌëúÏãú
            if (tabName === 'scenarios') {
                setTimeout(() => {
                    if (window.scenarios && Object.keys(window.scenarios).length > 0) {
                        console.log('üîÑ ÏãúÎÇòÎ¶¨Ïò§ ÌÉ≠ Ï†ÑÌôò - CSS Ï†ÅÏö© Î≥¥Ïû•ÏùÑ ÏúÑÌïú Ïû¨ÌëúÏãú');
                        displayScenarios();
                    }
                }, 50);
            }

            // ÏóêÌîºÏÜåÎìú ÌÉ≠ ÏÑ†ÌÉù Ïãú ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏ Î∞è ÏóêÌîºÏÜåÎìú Î™©Î°ù Î°úÎìú
            if (tabName === 'dialogues') {
                populateDialogueScenarioSelect();
                // ÏóêÌîºÏÜåÎìú Î™©Î°ù ÏûêÎèô Î°úÎìú
                setTimeout(() => {
                    loadEpisodesList();
                    if (dialogues && Object.keys(dialogues).length > 0) {
                        console.log('üîÑ ÏóêÌîºÏÜåÎìú ÌÉ≠ Ï†ÑÌôò - CSS Ï†ÅÏö© Î≥¥Ïû•ÏùÑ ÏúÑÌïú Ïû¨ÌëúÏãú');
                        displayDialogues();
                    }
                }, 100);
            }

            // API ÏÑ§Ï†ï ÌÉ≠ ÏÑ†ÌÉù Ïãú ÏÉÅÌÉú ÌôïÏù∏
            if (tabName === 'settings') {
                checkApiStatus();
            }

            // AI Í¥ÄÎ¶¨ ÌÉ≠ ÏÑ†ÌÉù Ïãú ÏÑ§Ï†ï Î°úÎìú
            if (tabName === 'ai-management') {
                loadAISettings();
            }
        }

        // === API Í¥ÄÎ¶¨ Ìï®ÏàòÎì§ ===
        
        // API ÌÇ§ ÌëúÏãú/Ïà®ÍπÄ ÌÜ†Í∏Ä
        function toggleApiKeyVisibility() {
            const input = document.getElementById('openaiApiKey');
            const button = document.getElementById('toggleApiKey');
            
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = 'üôà';
            } else {
                input.type = 'password';
                button.textContent = 'üëÅÔ∏è';
            }
        }

        // Í∞ÑÎã®Ìïú API ÌÇ§ Ï†ÄÏû• (ÏÉàÎ°úÏö¥ Î∞©Ïãù)
        // Vercel ÎåÄÏãúÎ≥¥Îìú Ïó¥Í∏∞
        function openVercelDashboard() {
            window.open('https://vercel.com/dashboard', '_blank');
            showNotification('üöÄ Vercel ÎåÄÏãúÎ≥¥ÎìúÍ∞Ä ÏÉà ÌÉ≠ÏóêÏÑú Ïó¥Î†∏ÏäµÎãàÎã§. ÌîÑÎ°úÏ†ùÌä∏Î•º ÏÑ†ÌÉùÌïòÍ≥† Environment VariablesÎ•º ÏÑ§Ï†ïÌïòÏÑ∏Ïöî.', 'info');
        }

        // API Ïó∞Í≤∞ ÌÖåÏä§Ìä∏
        async function testApiConnection() {
            const testResults = document.getElementById('apiTestResults');
            testResults.style.display = 'block';
            testResults.className = 'test-results';
            testResults.innerHTML = '<div class="loading">üß™ API Ïó∞Í≤∞ ÌÖåÏä§Ìä∏ Ï§ë...</div>';
            
            // ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('openaiStatus').textContent = 'üîÑ ÌÖåÏä§Ìä∏ Ï§ë...';
            document.getElementById('openaiStatus').className = 'status-testing';

            try {
                // ÏÑ∏ÏÖòÏóêÏÑú API ÌÇ§ Í∞ÄÏ†∏Ïò§Í∏∞
                const sessionApiKey = sessionStorage.getItem('openai_api_key');
                
                // Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ± APIÎ•º ÌÜµÌï¥ Ïó∞Í≤∞ ÌÖåÏä§Ìä∏
                const response = await fetch('/api/test-openai-connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-OpenAI-Key': sessionApiKey || '' // Ìó§ÎçîÎ°ú API ÌÇ§ Ï†ÑÎã¨
                    },
                    body: JSON.stringify({
                        useSessionKey: true
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    testResults.className = 'test-results success';
                    testResults.innerHTML = `
                        <h4>‚úÖ Ïó∞Í≤∞ ÌÖåÏä§Ìä∏ ÏÑ±Í≥µ!</h4>
                        <p><strong>Î™®Îç∏:</strong> ${data.model || 'GPT-4o-mini'}</p>
                        <p><strong>ÏùëÎãµ ÏãúÍ∞Ñ:</strong> ${data.responseTime || 'ÌôïÏù∏ Ï§ë'}ms</p>
                        <p><strong>ÌÜ†ÌÅ∞ ÏÇ¨Ïö©Îüâ:</strong> ${data.tokensUsed || 'ÌôïÏù∏ Ï§ë'} tokens</p>
                        <p><strong>ÌÖåÏä§Ìä∏ ÏãúÍ∞Ñ:</strong> ${new Date().toLocaleString()}</p>
                    `;
                    
                    document.getElementById('openaiStatus').textContent = '‚úÖ Ïó∞Í≤∞Îê®';
                    document.getElementById('openaiStatus').className = 'status-connected';
                    document.getElementById('lastTest').textContent = new Date().toLocaleString();
                    document.getElementById('apiStatus').textContent = '‚úÖ';
                } else {
                    throw new Error(data.message || 'ÌÖåÏä§Ìä∏ Ïã§Ìå®');
                }
                
            } catch (error) {
                console.error('API ÌÖåÏä§Ìä∏ Ïò§Î•ò:', error);
                
                testResults.className = 'test-results error';
                testResults.innerHTML = `
                    <h4>‚ùå Ïó∞Í≤∞ ÌÖåÏä§Ìä∏ Ïã§Ìå®</h4>
                    <p><strong>Ïò§Î•ò:</strong> ${error.message}</p>
                    <p><strong>Ìï¥Í≤∞ Î∞©Î≤ï:</strong></p>
                    <ul>
                        <li>API ÌÇ§Í∞Ä Ïò¨Î∞îÎ•∏ÏßÄ ÌôïÏù∏</li>
                        <li>OpenAI Í≥ÑÏ†ïÏóê Ï∂©Î∂ÑÌïú ÌÅ¨Î†àÎîßÏù¥ ÏûàÎäîÏßÄ ÌôïÏù∏</li>
                        <li>API ÌÇ§ Í∂åÌïú ÏÑ§Ï†ï ÌôïÏù∏</li>
                    </ul>
                `;
                
                document.getElementById('openaiStatus').textContent = '‚ùå Ïó∞Í≤∞ Ïã§Ìå®';
                document.getElementById('openaiStatus').className = 'status-disconnected';
                document.getElementById('apiStatus').textContent = '‚ùå';
            }
        }

        // API ÏÉÅÌÉú ÌôïÏù∏ (ÌôòÍ≤ΩÎ≥ÄÏàò Í∏∞Î∞ò)
        async function checkApiStatus() {
            try {
                console.log('üîç API ÌÇ§ ÏÉÅÌÉú ÌôïÏù∏ ÏãúÏûë...');

                // ÌôòÍ≤ΩÎ≥ÄÏàòÎäî ÏÑúÎ≤ÑÏÇ¨Ïù¥ÎìúÏóêÏÑúÎßå ÌôïÏù∏ Í∞ÄÎä•ÌïòÎØÄÎ°ú Í∞ÑÎã®Ìïú ÌÖåÏä§Ìä∏ API ÏÇ¨Ïö©
                const response = await fetch('/api/character-ai-generator?action=list_characters');
                const data = await response.json();

                console.log('üìã API ÏÉÅÌÉú:', data.success ? 'Ï†ïÏÉÅ' : 'Ïò§Î•ò');

                const statusElement = document.getElementById('openaiStatus');

                if (data.success) {
                    console.log('‚úÖ API ÏÑúÎπÑÏä§Í∞Ä Ï†ïÏÉÅ ÏûëÎèô Ï§ë');

                    statusElement.innerHTML = `
                        <span class="status-indicator">‚úÖ</span>
                        <span class="status-text">API ÏÑúÎπÑÏä§ Ï†ïÏÉÅ ÏûëÎèô</span>
                    `;
                    statusElement.style.color = '#28a745';

                    showNotification('‚úÖ API ÏÑúÎπÑÏä§Í∞Ä Ï†ïÏÉÅÏ†ÅÏúºÎ°ú ÏûëÎèôÌï©ÎãàÎã§.', 'success');

                } else {
                    console.log('‚ùå API ÏÑúÎπÑÏä§ Ïò§Î•ò');

                    statusElement.innerHTML = `
                        <span class="status-indicator">‚ùå</span>
                        <span class="status-text">Vercel ÌôòÍ≤ΩÎ≥ÄÏàòÏóê OPENAI_API_KEYÍ∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§</span>
                    `;
                    statusElement.style.color = '#dc3545';

                    showNotification('‚ùå API ÌÇ§Í∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. Vercel ÎåÄÏãúÎ≥¥ÎìúÏóêÏÑú OPENAI_API_KEY ÌôòÍ≤ΩÎ≥ÄÏàòÎ•º ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.', 'error');
                }

            } catch (error) {
                console.error('‚ùå API ÏÉÅÌÉú ÌôïÏù∏ Ïò§Î•ò:', error);

                const statusElement = document.getElementById('openaiStatus');
                statusElement.innerHTML = `
                    <span class="status-indicator">‚ö†Ô∏è</span>
                    <span class="status-text">API Ïó∞Í≤∞ Ïã§Ìå®: ${error.message}</span>
                `;
                statusElement.style.color = '#ffc107';

                // Íµ¨Ï≤¥Ï†ÅÏù∏ ÏóêÎü¨ Î©îÏãúÏßÄÏôÄ Ìï¥Í≤∞Î∞©Î≤ï Ï†úÍ≥µ
                const errorMessage = `‚ùå API Ïó∞Í≤∞ Ïã§Ìå®\n\n${error.message}\n\nÌï¥Í≤∞Î∞©Î≤ï:\n1. Ïù∏ÌÑ∞ÎÑ∑ Ïó∞Í≤∞ ÌôïÏù∏\n2. Vercel ÎåÄÏãúÎ≥¥ÎìúÏóêÏÑú ÌôòÍ≤ΩÎ≥ÄÏàò ÌôïÏù∏\n3. GitHub API ÏÉÅÌÉú ÌôïÏù∏\n4. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑ`;

                showNotification(errorMessage, 'error');
            }
        }

        // API ÌÇ§ ÏÇ≠Ï†ú (Î°úÍ∑∏Ïù∏ Í∏∞Î∞ò + Secure Storage)
        async function clearApiKey() {
            if (!confirm('Ï†ïÎßêÎ°ú API ÌÇ§Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.\n\n(GitHub ÏïîÌò∏Ìôî Ï†ÄÏû•ÏÜåÏóêÏÑú ÏôÑÏ†ÑÌûà ÏÇ≠Ï†úÎê©ÎãàÎã§)')) {
                return;
            }

            try {
                console.log('üóëÔ∏è API ÌÇ§ ÏïàÏ†Ñ ÏÇ≠Ï†ú ÏãúÎèÑ...');

                // Î°úÍ∑∏Ïù∏Îêú ÏÇ¨Ïö©ÏûêÏùò ÌÜ†ÌÅ∞ Í∏∞Î∞ò ÏÇ≠Ï†ú
                if (currentAuthToken) {
                    const response = await fetch('/api/admin-auth?action=delete-api-key', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${currentAuthToken}`
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        console.log('‚úÖ ÌÜ†ÌÅ∞ Í∏∞Î∞ò API ÌÇ§ ÏÇ≠Ï†ú ÏÑ±Í≥µ:', data.message);

                        // ÌÜ†ÌÅ∞ Í∏∞Î∞ò: ÏùëÎãµÏóêÏÑú ÏóÖÎç∞Ïù¥Ìä∏Îêú ÌÜ†ÌÅ∞ Ï≤òÎ¶¨
                        if (data.authToken && data.authToken !== currentAuthToken) {
                            console.log('üîÑ ÌÜ†ÌÅ∞ ÏóÖÎç∞Ïù¥Ìä∏ (hasApiKey=false ÏÉÅÌÉú Î≥ÄÍ≤Ω)');
                            currentAuthToken = data.authToken;
                            sessionStorage.setItem('admin_auth_token', data.authToken);
                        }

                        showNotification('‚úÖ API ÌÇ§Í∞Ä ÏïàÏ†ÑÌïòÍ≤å ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§!\n(ÌÜ†ÌÅ∞ Í∏∞Î∞ò ÏïîÌò∏Ìôî Ï†ÄÏû•ÏÜåÏóêÏÑú ÏôÑÏ†Ñ Ï†úÍ±∞Îê®)', 'success');
                    } else {
                        const error = await response.json();
                        console.warn('‚ö†Ô∏è Î°úÍ∑∏Ïù∏ Í∏∞Î∞ò ÏÇ≠Ï†ú Ïã§Ìå®, ÏùºÎ∞ò ÏÇ≠Ï†ú ÏãúÎèÑ:', error.message);

                        // ÏùºÎ∞ò ÏÇ≠Ï†ú API ÏãúÎèÑ
                        await fallbackDeleteApiKey();
                        return;
                    }
                } else {
                    // Î°úÍ∑∏Ïù∏ÎêòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞ ÏùºÎ∞ò ÏÇ≠Ï†ú
                    await fallbackDeleteApiKey();
                    return;
                }

                // Î∏åÎùºÏö∞Ï†Ä ÏÑ∏ÏÖòÏóêÏÑúÎèÑ ÏÇ≠Ï†ú
                sessionStorage.removeItem('openai_api_key');

                // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
                if (currentUser) {
                    currentUser.hasApiKey = false;
                    updateUserInfo(currentUser);
                }

                // API ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                setTimeout(() => {
                    console.log('üîÑ API ÌÇ§ ÏÇ≠Ï†ú ÌõÑ ÏÉÅÌÉú ÌôïÏù∏...');
                    checkApiStatus();
                }, 1000);

                document.getElementById('apiTestResults').style.display = 'none';

            } catch (error) {
                console.error('‚ùå API ÌÇ§ ÏÇ≠Ï†ú Ïò§Î•ò:', error);
                showNotification('‚ùå API ÌÇ§ ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message, 'error');
            }
        }

        // ÏùºÎ∞ò API ÌÇ§ ÏÇ≠Ï†ú (fallback)
        async function fallbackDeleteApiKey() {
            console.log('üîÑ ÏùºÎ∞ò API ÌÇ§ ÏÇ≠Ï†ú ÏãúÎèÑ...');

            const response = await fetch('/api/clear-api-key', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const data = await response.json();
                console.log('‚úÖ ÏùºÎ∞ò API ÌÇ§ ÏÇ≠Ï†ú ÏÑ±Í≥µ:', data.message);
                showNotification('‚úÖ API ÌÇ§Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§!\n' + (data.note || ''), 'success');
            } else {
                const error = await response.json();
                throw new Error(error.message || 'ÏùºÎ∞ò ÏÇ≠Ï†úÎèÑ Ïã§Ìå®ÌñàÏäµÎãàÎã§');
            }
        }

        // === ÏãúÎÇòÎ¶¨Ïò§ Í¥ÄÎ¶¨ Ìï®ÏàòÎì§ ===
        
        // üöÄ GitHub API ÏãúÎÇòÎ¶¨Ïò§ Ï†ÄÏû• Ìï®Ïàò (ÌòÅÏã†Ï†Å!)
        async function saveScenarioToGitHub(scenario) {
            try {
                console.log('üêô GitHub APIÎ°ú ÏãúÎÇòÎ¶¨Ïò§ Ï†ÄÏû• ÏãúÏûë:', scenario.title);
                
                // GitHub ÌÜ†ÌÅ∞ÏùÄ ÏÑúÎ≤ÑÏÇ¨Ïù¥ÎìúÏóêÏÑú ÌôòÍ≤ΩÎ≥ÄÏàòÎ°ú Ï≤òÎ¶¨
                
                // ÏãúÎÇòÎ¶¨Ïò§ ID ÏÉùÏÑ± (ÏóÜÏúºÎ©¥)
                if (!scenario.id && !scenario.scenario_id) {
                    scenario.id = `scenario_${Date.now()}`;
                    scenario.scenario_id = scenario.id;
                    console.log('üîß ÏãúÎÇòÎ¶¨Ïò§ ID ÏÉùÏÑ±:', scenario.id);
                }
                
                // Í∏∞Ï°¥ ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù Î°úÎìú
                const existingScenarios = await loadScenariosFromGitHub();
                console.log('üìä Í∏∞Ï°¥ GitHub ÏãúÎÇòÎ¶¨Ïò§ Ïàò:', Object.keys(existingScenarios).length);
                
                // ÏÉà ÏãúÎÇòÎ¶¨Ïò§ Ï∂îÍ∞Ä
                const scenarioId = scenario.id || scenario.scenario_id;
                existingScenarios[scenarioId] = {
                    ...scenario,
                    last_modified: new Date().toISOString(),
                    source: 'github_api',
                    commit_hash: 'pending'
                };
                
                // GitHubÏóê Ïª§Î∞ãÌï† Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞ ÏÉùÏÑ±
                const scenarioData = {
                    metadata: {
                        version: "1.0.0",
                        created_date: new Date().toISOString().split('T')[0],
                        total_scenarios: Object.keys(existingScenarios).length,
                        ai_context_engine: "claude-3.5-sonnet",
                        source: "github_api"
                    },
                    scenarios: existingScenarios,
                    scenario_templates: {
                        romance_template: {
                            mood_options: ["ÏÑ§Î†ò", "Î∂ÄÎÅÑÎü¨ÏõÄ", "Í∏¥Ïû•Í∞ê", "Îã¨ÏΩ§Ìï®", "Ïï†Ï†àÌï®"],
                            setting_options: ["Ïπ¥Ìéò", "ÌïôÍµê", "Ïßë", "Í≥µÏõê", "ÎèÑÏÑúÍ¥Ä", "Í±∞Î¶¨"],
                            time_options: ["ÏïÑÏπ®", "Ï†êÏã¨", "Ï†ÄÎÖÅ", "Î∞§", "ÏÉàÎ≤Ω"]
                        }
                    }
                };
                
                // GitHub RepositoryÏóê ÏßÅÏ†ë Ïª§Î∞ã
                const commitMessage = `Add scenario: ${scenario.title}`;
                const commitResult = await commitToGitHub('data/scenarios/scenario-database.json', scenarioData, commitMessage);
                
                if (commitResult.success) {
                    // Ïª§Î∞ã Ìï¥Ïãú ÏóÖÎç∞Ïù¥Ìä∏
                    existingScenarios[scenarioId].commit_hash = commitResult.sha;
                    
                    // Î°úÏª¨ Î∞±ÏóÖÎèÑ Ï†ÄÏû•
                    localStorage.setItem('chatgame_scenarios', JSON.stringify(existingScenarios));
                    
                    console.log('‚úÖ GitHub API ÏãúÎÇòÎ¶¨Ïò§ Ï†ÄÏû• ÏôÑÎ£å! Ïª§Î∞ã SHA:', commitResult.sha);
                    console.log('üìù GitHubÏóê Ï†ÄÏû•Îêú ÏãúÎÇòÎ¶¨Ïò§ IDÎì§:', Object.keys(existingScenarios));
                    
                    return { success: true, commit_hash: commitResult.sha, url: commitResult.html_url };
                } else {
                    throw new Error('GitHub commit failed: ' + commitResult.error);
                }
                
            } catch (error) {
                console.error('‚ùå GitHub API ÏãúÎÇòÎ¶¨Ïò§ Ï†ÄÏû• Ïò§Î•ò:', error);
                
                // Ïã§Ìå® Ïãú Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÎ°ú Ìè¥Î∞±
                console.log('üíæ ÏãúÎÇòÎ¶¨Ïò§ Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÎ°ú Ìè¥Î∞±...');
                return saveScenarioToLocalStorage(scenario);
            }
        }
        
        // GitHubÏóêÏÑú ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        async function loadScenariosFromGitHub() {
            try {
                console.log('üì• GitHubÏóêÏÑú ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ Î°úÎìú...');
                const result = await getFileFromGitHub('data/scenarios/scenario-database.json');
                
                if (result.success) {
                    const scenarioData = result.content;
                    if (scenarioData.scenarios) {
                        return scenarioData.scenarios;
                    }
                    return {};
                } else {
                    console.warn('‚ö†Ô∏è GitHub ÏãúÎÇòÎ¶¨Ïò§ Î°úÎìú Ïã§Ìå®:', result.error);
                    return {};
                }
            } catch (error) {
                console.error('‚ùå GitHub ÏãúÎÇòÎ¶¨Ïò§ Î°úÎìú ÏòàÏô∏:', error);
                return {};
            }
        }
        
        // ÏãúÎÇòÎ¶¨Ïò§ Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ Ìè¥Î∞± Ìï®Ïàò
        function saveScenarioToLocalStorage(scenario) {
            try {
                const scenarioId = scenario.id || scenario.scenario_id || `scenario_${Date.now()}`;
                const existingScenarios = JSON.parse(localStorage.getItem('chatgame_scenarios') || '{}');
                
                existingScenarios[scenarioId] = {
                    ...scenario,
                    id: scenarioId,
                    scenario_id: scenarioId,
                    last_modified: new Date().toISOString(),
                    source: 'local_storage'
                };
                
                localStorage.setItem('chatgame_scenarios', JSON.stringify(existingScenarios));
                console.log('‚úÖ ÏãúÎÇòÎ¶¨Ïò§ Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ Ï†ÄÏû• ÏôÑÎ£å:', scenarioId);
                
                return { success: true, source: 'localStorage' };
            } catch (error) {
                console.error('‚ùå ÏãúÎÇòÎ¶¨Ïò§ Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ Ï†ÄÏû• Ïò§Î•ò:', error);
                return { success: false, error: error.message };
            }
        }
        async function loadScenarios() {
            console.log('üìö === ÏãúÎÇòÎ¶¨Ïò§ Î°úÎìú ÏãúÏûë ===');
            console.log('üïí Î°úÎìú ÏãúÍ∞Ñ:', new Date().toISOString());

            try {
                // üîß Í∞ïÎ†•Ìïú Ï∫êÏãú Î¨¥Ìö®Ìôî Î∞è Ïö∞ÏÑ†ÏàúÏúÑ ÏÑ§Ï†ï
                const timestamp = Date.now();
                const randomParam = Math.random().toString(36).substring(7);
                console.log('üîÑ ÏãúÎÇòÎ¶¨Ïò§ API Ìò∏Ï∂ú... (Ï∫êÏãú Î¨¥Ìö®Ìôî: ' + timestamp + ', ÎûúÎç§: ' + randomParam + ')');

                const response = await fetch(`/api/scenario-manager?action=list&_t=${timestamp}&_r=${randomParam}`, {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                console.log('üì∂ API ÏùëÎãµ ÏÉÅÌÉú:', response.status);
                
                const data = await response.json();
                console.log('üì¶ ÏõêÏãú ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞:', JSON.stringify(data, null, 2));

                if (data.success) {
                    scenarios = data.scenarios || {};
                    const scenarioCount = Object.keys(scenarios).length;
                    console.log('‚úÖ Î°úÎìúÎêú ÏãúÎÇòÎ¶¨Ïò§ Ïàò:', scenarioCount);
                    
                    if (scenarioCount > 0) {
                        console.log('‚úÖ ÏãúÎÇòÎ¶¨Ïò§ IDÎì§:', Object.keys(scenarios));
                    } else {
                        console.log('üòµ Îπà ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù');
                    }
                    
                    displayScenarios();
                    updateScenarioStats();
                    console.log('üéâ === ÏãúÎÇòÎ¶¨Ïò§ Î°úÎìú ÏôÑÎ£å ===');
                } else {
                    console.error('‚ùå ÏãúÎÇòÎ¶¨Ïò§ API Ïò§Î•ò:', data.message);
                    scenarios = {};
                    displayScenarios();
                    updateScenarioStats();
                }
            } catch (error) {
                console.error('‚ùå ÏãúÎÇòÎ¶¨Ïò§ Î°úÎìú ÏòàÏô∏:', error);
                // Ìè¥Î∞± Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©
                scenarios = {};
                displayScenarios();
                updateScenarioStats();
                console.log('üéâ === ÏãúÎÇòÎ¶¨Ïò§ Î°úÎìú ÏôÑÎ£å (Ìè¥Î∞±) ===');
            }
        }

        function displayScenarios() {
            console.log('üé® === ÏãúÎÇòÎ¶¨Ïò§ ÌëúÏãú Ìï®Ïàò ÏãúÏûë ===');
            const container = document.getElementById('scenariosContainer');

            // window.scenarios ÎòêÎäî Ï†ÑÏó≠ scenarios ÏÇ¨Ïö© (Ìò∏ÌôòÏÑ±)
            const scenariosData = window.scenarios || scenarios || {};

            // ÏãúÎÇòÎ¶¨Ïò§ Î∞∞Ïó¥ÏùÑ ÌÇ§ÏôÄ Ìï®Íªò Îß§Ìïë (ID Î¨∏Ï†ú Ìï¥Í≤∞)
            const scenarioArray = Object.entries(scenariosData).map(([key, scenario]) => ({
                ...scenario,
                // ID Ïö∞ÏÑ†ÏàúÏúÑ: scenario.id > scenario.scenario_id > key
                id: scenario.id || scenario.scenario_id || key
            }));

            console.log('üìä ÌëúÏãúÌï† ÏãúÎÇòÎ¶¨Ïò§ Ïàò:', scenarioArray.length);
            console.log('üìä ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ ÏÜåÏä§:', window.scenarios ? 'window.scenarios' : 'scenarios');

            if (scenarioArray.length > 0) {
                console.log('üìã ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù:', scenarioArray.map(s => `${s.title} (${s.id})`));
                console.log('üîç ÏãúÎÇòÎ¶¨Ïò§ ÏÉÅÏÑ∏ Ï†ïÎ≥¥:', scenarioArray.map(s => ({
                    title: s.title,
                    id: s.id,
                    originalKey: Object.keys(scenariosData).find(key => scenariosData[key] === s)
                })));
            } else {
                console.log('üì≠ ÌëúÏãúÌï† ÏãúÎÇòÎ¶¨Ïò§ ÏóÜÏùå');
            }

            if (scenarioArray.length === 0) {
                console.log('üì≠ ÏãúÎÇòÎ¶¨Ïò§ ÏóÜÏùå - Îπà ÏÉÅÌÉú ÌëúÏãú');

                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <h3>üì≠ ÏãúÎÇòÎ¶¨Ïò§Í∞Ä ÏóÜÏäµÎãàÎã§</h3>
                        <p>Ï≤´ Î≤àÏß∏ ÏãúÎÇòÎ¶¨Ïò§Î•º ÎßåÎì§Ïñ¥Î≥¥ÏÑ∏Ïöî!</p>
                        <button class="btn btn-primary" onclick="openScenarioModal('create')">
                            ‚ú® ÏÉà ÏãúÎÇòÎ¶¨Ïò§ ÎßåÎì§Í∏∞
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = scenarioArray.map(scenario => {
                const scenarioId = scenario.id;
                console.log(`üéØ ÏãúÎÇòÎ¶¨Ïò§ Ïπ¥Îìú ÏÉùÏÑ±: ${scenario.title} (ID: ${scenarioId})`);

                return `
                    <div class="scenario-card">
                        <h3>${scenario.title}</h3>
                        <p class="description">${scenario.description}</p>
                        <div class="metadata">
                            <span class="tag">Î∞∞Í≤Ω: ${scenario.background_setting || 'unknown'}</span>
                            <span class="tag">Î∂ÑÏúÑÍ∏∞: ${scenario.mood || 'unknown'}</span>
                            ${scenario.tags ? scenario.tags.slice(0, 3).map(tag => `<span class="tag">${tag}</span>`).join('') : ''}
                            <span class="tag">Ï∫êÎ¶≠ÌÑ∞: ${scenario.available_characters && scenario.available_characters.length > 0 ? scenario.available_characters.length + 'Î™Ö' : 'ÏóÜÏùå'}</span>
                            <span class="tag">ÏóêÌîºÏÜåÎìú: ${scenario.dialogue_count || 0}Í∞ú</span>
                        </div>
                        <div class="actions">
                            <button class="btn btn-success" onclick="editScenario('${scenarioId}')">ÏàòÏ†ï</button>
                            <button class="btn btn-primary" onclick="manageDialogues('${scenarioId}')">ÏóêÌîºÏÜåÎìú</button>
                            <button class="btn btn-danger" onclick="deleteScenario('${scenarioId}')">ÏÇ≠Ï†ú</button>
                        </div>
                    </div>
                `;
            }).join('');

            console.log('üéâ ÏãúÎÇòÎ¶¨Ïò§ Ïπ¥Îìú Î†åÎçîÎßÅ ÏôÑÎ£å');
        }

        function updateScenarioStats() {
            console.log('üìä ÏãúÎÇòÎ¶¨Ïò§ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÏûë...');
            
            // window.scenarios ÎòêÎäî Ï†ÑÏó≠ scenarios ÏÇ¨Ïö© (Ìò∏ÌôòÏÑ±)
            const scenariosData = window.scenarios || scenarios || {};
            const scenarioArray = Object.values(scenariosData);
            console.log('üìä ÏãúÎÇòÎ¶¨Ïò§ Î∞∞Ïó¥:', scenarioArray.length, 'Í∞ú');
            console.log('üìä ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ ÏÜåÏä§:', window.scenarios ? 'window.scenarios' : 'scenarios');
            
            // ÏïàÏ†ÑÌïú ÏöîÏÜå ÏóÖÎç∞Ïù¥Ìä∏ (ÏöîÏÜåÍ∞Ä ÏóÜÏúºÎ©¥ Î¨¥Ïãú)
            const safeUpdateElement = (id, value) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                    console.log(`‚úÖ ${id}: ${value}`);
                } else {
                    console.warn(`‚ö†Ô∏è ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå: ${id}`);
                }
            };
            
            // ÏãúÎÇòÎ¶¨Ïò§ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
            safeUpdateElement('totalScenarios', scenarioArray.length);
            safeUpdateElement('activeScenarios', scenarioArray.filter(s => s.active_status).length);
            safeUpdateElement('scenarioCount', scenarioArray.length);
            
            // AI ÏÉùÏÑ± ÏãúÎÇòÎ¶¨Ïò§ Í∞úÏàò
            const aiGeneratedCount = scenarioArray.filter(s => s.ai_generated_context && s.ai_generated_context.length > 0).length;
            safeUpdateElement('aiGeneratedScenarios', aiGeneratedCount);
            
            // ÎåÄÌôî/ÏóêÌîºÏÜåÎìú Ïàò (ÏãúÎÇòÎ¶¨Ïò§ ÏÑπÏÖòÏóêÎäî totalDialogues ÏÇ¨Ïö©)
            const totalEpisodes = scenarioArray.reduce((sum, s) => sum + (s.dialogue_count || 0), 0);
            safeUpdateElement('totalDialogues', totalEpisodes);
            
            console.log('‚úÖ ÏãúÎÇòÎ¶¨Ïò§ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
        }

        function openScenarioModal(mode, scenarioId = null) {
            currentMode = mode;
            const modal = document.getElementById('scenarioModal');
            
            if (mode === 'create') {
                document.getElementById('scenarioModalTitle').textContent = 'ÏÉà ÏãúÎÇòÎ¶¨Ïò§ ÎßåÎì§Í∏∞';
                document.getElementById('scenarioForm').reset();
                document.getElementById('aiContext').innerHTML = `
                    <div class="no-context">
                        <div class="no-context-message">
                            üí° AI Ïª®ÌÖçÏä§Ìä∏Î•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî
                        </div>
                        <div class="no-context-help">
                            ÏúÑÏùò "ü§ñ AI Ïª®ÌÖçÏä§Ìä∏ ÏÉùÏÑ±" Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ ÏÜåÏÑ§Ìíç ÏãúÎÇòÎ¶¨Ïò§ Ïª®ÌÖçÏä§Ìä∏Î•º ÏÉùÏÑ±ÌïòÏÑ∏Ïöî
                        </div>
                    </div>
                `;
                selectedCharacters.clear();
                // Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉùÍ∏∞Î•º Îã§Ïãú Î°úÎî©ÌïòÏó¨ ÏµúÏã† Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù ÌëúÏãú
                loadCharacterSelector();
            } else if (mode === 'edit' && scenarioId) {
                editScenario(scenarioId);
                return;
            }
            
            modal.style.display = 'block';
        }

        function editScenario(scenarioId) {
            console.log('üîß ÏãúÎÇòÎ¶¨Ïò§ Ìé∏Ïßë ÏãúÏûë:', scenarioId);
            const scenariosData = window.scenarios || scenarios || {};
            const scenario = scenariosData[scenarioId];

            console.log('üìã ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏:', {
                scenarioId,
                hasScenario: !!scenario,
                availableIds: Object.keys(scenariosData)
            });

            if (!scenario) {
                console.error('‚ùå ÏãúÎÇòÎ¶¨Ïò§Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§:', scenarioId);
                alert('ÏãúÎÇòÎ¶¨Ïò§Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }

            currentMode = 'edit';
            document.getElementById('scenarioModalTitle').textContent = 'ÏãúÎÇòÎ¶¨Ïò§ ÏàòÏ†ï';
            document.getElementById('scenarioId').value = scenarioId;
            document.getElementById('scenarioTitle').value = scenario.title;
            document.getElementById('scenarioDescription').value = scenario.description;
            // backgroundSetting ÌïÑÎìú Ï†úÍ±∞Îê® - Î©îÏã†Ï†Ä ÎåÄÌôîÎ°ú Í≥†Ï†ï
            document.getElementById('mood').value = scenario.mood;
            // AI ÏÉùÏÑ± Ïª®ÌÖçÏä§Ìä∏ ÌëúÏãú Í∞úÏÑ†
            const aiContextDiv = document.getElementById('aiContext');
            if (scenario.ai_generated_context && scenario.ai_generated_context.trim()) {
                aiContextDiv.innerHTML = `
                    <div class="existing-context">
                        <div class="context-header">
                            <span class="context-label">üìñ Í∏∞Ï°¥ ÏÉùÏÑ±Îêú Ïª®ÌÖçÏä§Ìä∏</span>
                            <span class="context-date">${scenario.updated_at ? new Date(scenario.updated_at).toLocaleString('ko-KR') : ''}</span>
                        </div>
                        <div class="context-content">${scenario.ai_generated_context}</div>
                    </div>
                `;
            } else {
                aiContextDiv.innerHTML = `
                    <div class="no-context">
                        <div class="no-context-message">
                            ‚ö†Ô∏è ÏïÑÏßÅ AI Ïª®ÌÖçÏä§Ìä∏Í∞Ä ÏÉùÏÑ±ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§
                        </div>
                        <div class="no-context-help">
                            ÏúÑÏùò "ü§ñ AI Ïª®ÌÖçÏä§Ìä∏ ÏÉùÏÑ±" Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ Ïª®ÌÖçÏä§Ìä∏Î•º ÏÉùÏÑ±ÌïòÏÑ∏Ïöî
                        </div>
                    </div>
                `;
            }
            document.getElementById('customContext').value = scenario.custom_context || '';

            // Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉù ÏÉÅÌÉú Î≥µÏõê
            selectedCharacters.clear();
            document.querySelectorAll('.character-option').forEach(opt => opt.classList.remove('selected'));
            
            if (scenario.available_characters) {
                scenario.available_characters.forEach(charId => {
                    selectedCharacters.add(charId);
                    document.querySelector(`.character-option[data-id="${charId}"]`)?.classList.add('selected');
                });
            }

            document.getElementById('scenarioModal').style.display = 'block';
        }

        async function saveScenario() {
            const title = document.getElementById('scenarioTitle').value;
            const description = document.getElementById('scenarioDescription').value;
            const mood = document.getElementById('mood').value;

            if (!title || !description || !mood) {
                alert('Î™®Îì† ÌïÑÏàò Ìï≠Î™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            const scenarioData = {
                title,
                description,
                background_setting: 'Î©îÏã†Ï†Ä ÎåÄÌôî', // Î©îÏã†Ï†Ä Í∏∞Î∞òÏúºÎ°ú Í≥†Ï†ï
                mood,
                available_characters: Array.from(selectedCharacters),
                action: 'create' // üîß Í∏∞Î≥∏Í∞íÏúºÎ°ú create ÏÑ§Ï†ï
            };

            if (currentMode === 'create') {
                // Ï†úÎ™©ÏùÑ Í∏∞Î∞òÏúºÎ°ú Í≥†Ïú†Ìïú ID ÏÉùÏÑ±
                const titleKey = title.toLowerCase()
                    .replace(/[^a-zA-ZÍ∞Ä-Ìû£0-9]/g, '_') // ÌäπÏàòÎ¨∏ÏûêÎ•º _Î°ú Î≥ÄÍ≤Ω
                    .replace(/_+/g, '_') // Ïó∞ÏÜçÎêú _Î•º ÌïòÎÇòÎ°ú
                    .replace(/^_|_$/g, ''); // ÏïûÎí§ _Ï†úÍ±∞
                scenarioData.scenario_id = `scenario_${titleKey}_${Date.now()}`;
                scenarioData.action = 'create';
                
                console.log('üîß ÏãúÎÇòÎ¶¨Ïò§ ID ÏÉùÏÑ±:', scenarioData.scenario_id);
            } else {
                scenarioData.scenario_id = document.getElementById('scenarioId').value;
                scenarioData.action = 'update';
            }

            try {
                // üöÄ Ï¶âÏãú UI ÏóÖÎç∞Ïù¥Ìä∏ (ÏÇ¨Ïö©Ïûê Í≤ΩÌóò Í∞úÏÑ†)
                console.log('‚ö° Ï¶âÏãú Î°úÏª¨ ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏...');
                
                // ÏãúÎÇòÎ¶¨Ïò§ ID ÌôïÎ≥¥
                const scenarioId = scenarioData.scenario_id;
                
                // Î°úÏª¨ ÏãúÎÇòÎ¶¨Ïò§ Í∞ùÏ≤¥Ïóê Ï¶âÏãú Ï∂îÍ∞Ä (UI Î∞òÏùëÏÑ± Í∞úÏÑ†)
                const globalScenarios = window.scenarios || {};
                globalScenarios[scenarioId] = {
                    id: scenarioId,
                    ...scenarioData,
                    created_date: new Date().toISOString().split('T')[0],
                    dialogue_count: 0,
                    tags: [scenarioData.mood]
                };
                window.scenarios = globalScenarios;
                
                // Ï¶âÏãú ÌôîÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏
                displayScenarios();
                updateScenarioStats();
                console.log('‚úÖ Ï¶âÏãú UI ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');

                // üíæ LocalStorage ÏßÅÏ†ë Ï†ÄÏû• (ÌôïÏã§Ìïú Î∞©Î≤ï!)
                console.log('üíæ LocalStorageÏóê ÏßÅÏ†ë Ï†ÄÏû• ÏãúÎèÑ...');
                try {
                    // ÌòÑÏû¨ Ï†ÄÏû•Îêú ÏãúÎÇòÎ¶¨Ïò§Îì§ÏùÑ Í∞ÄÏ†∏Ïò¥
                    const existingScenarios = localStorage.getItem('scenarios');
                    const scenariosData = existingScenarios ? JSON.parse(existingScenarios) : {};
                    
                    // ÏÉà ÏãúÎÇòÎ¶¨Ïò§ Ï∂îÍ∞Ä/ÏàòÏ†ï
                    scenariosData[scenarioId] = globalScenarios[scenarioId];
                    
                    // LocalStorageÏóê Ï†ÄÏû•
                    localStorage.setItem('scenarios', JSON.stringify(scenariosData));
                    console.log('‚úÖ LocalStorage Ï†ÄÏû• ÏÑ±Í≥µ! Ï¥ù', Object.keys(scenariosData).length, 'Í∞ú ÏãúÎÇòÎ¶¨Ïò§');
                    
                    // Ï†ÄÏû• ÏÑ±Í≥µ Î©îÏãúÏßÄ
                    const successMessage = currentMode === 'create' ? 
                        `üíñ ÏÉàÎ°úÏö¥ ÏãúÎÇòÎ¶¨Ïò§ '${title}'Í∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!\n‚úÖ ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ùÏóêÏÑú ÌôïÏù∏ÌïòÏÑ∏Ïöî!` :
                        `‚ú®ÏãúÎÇòÎ¶¨Ïò§ '${title}'Í∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§!`;
                    
                    alert(successMessage);
                    closeModal('scenarioModal');
                    
                    // UI ÏµúÏ¢Ö ÏóÖÎç∞Ïù¥Ìä∏
                    console.log('üîÑ Ï†ÄÏû• ÌõÑ ÏµúÏ¢Ö UI ÎèôÍ∏∞Ìôî...');
                    await loadAllData(); // ÏÉàÎ°úÏö¥ ÌÜµÌï© Î°úÎî© Ìï®Ïàò ÏÇ¨Ïö©
                    
                    // Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉùÍ∏∞ÎèÑ Í∞±Ïã† (ÏÉàÎ°ú ÏÉùÏÑ±Îêú Ï∫êÎ¶≠ÌÑ∞ Î∞òÏòÅ)
                    await loadCharacterSelector();
                    
                    console.log('‚úÖ ÏãúÎÇòÎ¶¨Ïò§ Ï†ÄÏû• ÌîÑÎ°úÏÑ∏Ïä§ ÏôÑÎ£å!');
                    
                } catch (storageError) {
                    console.error('‚ùå LocalStorage Ï†ÄÏû• Ïã§Ìå®:', storageError);
                    alert('Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + storageError.message);
                }
            } catch (error) {
                console.error('ÏãúÎÇòÎ¶¨Ïò§ Ï†ÄÏû• Ïò§Î•ò:', error);
                // ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•òÏó¨ÎèÑ Î°úÏª¨ UIÎäî Ïù¥ÎØ∏ ÏóÖÎç∞Ïù¥Ìä∏Îê®
                alert('‚ö†Ô∏è ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏßÄÎßå Î°úÏª¨ÏóêÏÑú ÌôïÏù∏ Í∞ÄÎä•Ìï©ÎãàÎã§!\n\nÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ùÏóêÏÑú ÌôïÏù∏ÌïòÏÑ∏Ïöî!\n\nÏò§Î•ò: ' + error.message);
                closeModal('scenarioModal');
            }
        }

        async function deleteScenario(scenarioId) {
            console.log('üéØ deleteScenario Ìï®Ïàò Ìò∏Ï∂úÎê®! (GitHub API Ïó∞Îèô Î≤ÑÏ†Ñ)');

            if (!confirm('Ï†ïÎßêÎ°ú Ïù¥ ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÍ¥ÄÎ†®Îêú Î™®Îì† ÏóêÌîºÏÜåÎìúÎèÑ Ìï®Íªò ÏÇ≠Ï†úÎê©ÎãàÎã§.')) {
                return;
            }

            try {
                console.log('üóëÔ∏è === ÏãúÎÇòÎ¶¨Ïò§ ÏÇ≠Ï†ú ÏãúÏûë ===');
                console.log('üéØ ÏÇ≠Ï†úÌï† ÏãúÎÇòÎ¶¨Ïò§ ID:', scenarioId);

                // 1. APIÎ•º ÌÜµÌïú ÏÑúÎ≤Ñ ÏÇ≠Ï†ú (GitHub ÎèôÍ∏∞Ìôî Ìè¨Ìï®)
                console.log('üì° ÏÑúÎ≤Ñ API Ìò∏Ï∂úÎ°ú ÏãúÎÇòÎ¶¨Ïò§ ÏÇ≠Ï†ú...');
                const response = await fetch('/api/scenario-manager', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'delete',
                        scenario_id: scenarioId
                    })
                });

                console.log('üì∂ API ÏùëÎãµ ÏÉÅÌÉú:', response.status);
                const result = await response.json();
                console.log('üì¶ API ÏùëÎãµ Îç∞Ïù¥ÌÑ∞:', result);

                if (!result.success) {
                    throw new Error(result.message || 'API ÏÇ≠Ï†ú Ïã§Ìå®');
                }

                console.log('‚úÖ ÏÑúÎ≤ÑÏóêÏÑú ÏãúÎÇòÎ¶¨Ïò§ ÏÇ≠Ï†ú ÏôÑÎ£å (GitHub ÎèôÍ∏∞Ìôî Ìè¨Ìï®)');

                // 2. Î°úÏª¨ Ï†ÑÏó≠ Î≥ÄÏàòÏóêÏÑúÎèÑ ÏÇ≠Ï†ú (UI Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏Ïö©)
                console.log('üîÑ Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî...');
                if (scenarios && scenarios[scenarioId]) {
                    delete scenarios[scenarioId];
                    console.log('‚úÖ scenarios Ï†ÑÏó≠ Î≥ÄÏàòÏóêÏÑú ÏÇ≠Ï†ú');
                }
                if (window.scenarios && window.scenarios[scenarioId]) {
                    delete window.scenarios[scenarioId];
                    console.log('‚úÖ window.scenariosÏóêÏÑú ÏÇ≠Ï†ú');
                }

                // 3. LocalStorage Ï†ïÎ¶¨ (ÌïÑÏöîÌïú Í≤ΩÏö∞)
                try {
                    const existingScenarios = localStorage.getItem('scenarios');
                    if (existingScenarios) {
                        const scenariosData = JSON.parse(existingScenarios);
                        if (scenariosData[scenarioId]) {
                            delete scenariosData[scenarioId];
                            localStorage.setItem('scenarios', JSON.stringify(scenariosData));
                            console.log('‚úÖ LocalStorage Ï†ïÎ¶¨ ÏôÑÎ£å');
                        }
                    }
                } catch (localError) {
                    console.warn('‚ö†Ô∏è LocalStorage Ï†ïÎ¶¨ Ïã§Ìå® (Î¨¥Ïãú):', localError.message);
                }

                // 4. UI Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏
                console.log('üé® UI ÏóÖÎç∞Ïù¥Ìä∏...');
                displayScenarios();
                updateScenarioStats();

                // 5. ÏÑ±Í≥µ Î©îÏãúÏßÄ
                alert('‚úÖ ÏãúÎÇòÎ¶¨Ïò§Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                console.log('üéâ === ÏãúÎÇòÎ¶¨Ïò§ ÏÇ≠Ï†ú ÏôÑÎ£å ===');

            } catch (error) {
                console.error('‚ùå === ÏãúÎÇòÎ¶¨Ïò§ ÏÇ≠Ï†ú Ïã§Ìå® ===');
                console.error('‚ùå Ïò§Î•ò ÏÉÅÏÑ∏:', error);
                console.error('‚ùå Ïä§ÌÉù Ìä∏Î†àÏù¥Ïä§:', error.stack);

                // ÏÇ¨Ïö©ÏûêÏóêÍ≤å Íµ¨Ï≤¥Ï†ÅÏù∏ Ïò§Î•ò Î©îÏãúÏßÄ Ï†úÍ≥µ
                let errorMessage = 'ÏãúÎÇòÎ¶¨Ïò§ ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.';
                if (error.message.includes('404')) {
                    errorMessage = 'ÏãúÎÇòÎ¶¨Ïò§Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. Ïù¥ÎØ∏ ÏÇ≠Ï†úÎêòÏóàÍ±∞ÎÇò IDÍ∞Ä ÏûòÎ™ªÎêòÏóàÏùÑ Ïàò ÏûàÏäµÎãàÎã§.';
                } else if (error.message.includes('500')) {
                    errorMessage = 'ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.';
                } else if (error.message.includes('ÎÑ§Ìä∏ÏõåÌÅ¨')) {
                    errorMessage = 'ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞ÏùÑ ÌôïÏù∏ÌïòÍ≥† Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.';
                }

                alert('‚ùå ' + errorMessage + '\n\nÍ∏∞Ïà†Ï†Å Ïò§Î•ò: ' + error.message);
            }
        }

        async function generateAIContext() {
            const title = document.getElementById('scenarioTitle').value;
            const description = document.getElementById('scenarioDescription').value;
            const mood = document.getElementById('mood').value;
            const backgroundSetting = 'Î©îÏã†Ï†Ä ÎåÄÌôî'; // Î©§Ïã†Ï†Ä Í∏∞Î∞òÏúºÎ°ú Í≥†Ï†ï

            if (!title || !description || !mood) {
                alert('Î©îÏã†Ï†Ä Ïª®ÌÖçÏä§Ìä∏ ÏÉùÏÑ±ÏùÑ ÏúÑÌï¥ Î™®Îì† ÌïÑÏàò Ìï≠Î™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            const aiContextDiv = document.getElementById('aiContext');
            aiContextDiv.innerHTML = '<div class="loading"></div> AIÍ∞Ä Ïª®ÌÖçÏä§Ìä∏Î•º ÏÉùÏÑ± Ï§ëÏûÖÎãàÎã§...';

            try {
                console.log('ü§ñ AI Ïª®ÌÖçÏä§Ìä∏ ÏÉùÏÑ± ÏöîÏ≤≠ ÏãúÏûë...');

                // Î®ºÏ†Ä ÏµúÏã† Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞Î•º Î°úÎìú
                console.log('üîÑ ÏµúÏã† Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ï§ë...');
                await window.loadCharacters();

                // ÏÑ†ÌÉùÎêú Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥ ÏàòÏßë
                console.log('üìã ÌòÑÏû¨ Ï†ÑÏó≠ characters:', Object.keys(characters || {}));
                console.log('üìã ÏÑ†ÌÉùÎêú Ï∫êÎ¶≠ÌÑ∞ IDÎì§:', selectedCharacters);

                const selectedCharacterData = [];
                for (const charId of selectedCharacters) {
                    const character = characters[charId] || window.characters?.[charId];
                    if (character) {
                        selectedCharacterData.push(character);
                        console.log('‚úÖ Ï∫êÎ¶≠ÌÑ∞ Ï∞æÏùå:', charId, character.name);
                    } else {
                        console.warn('‚ö†Ô∏è Ï∫êÎ¶≠ÌÑ∞ ÎØ∏Î∞úÍ≤¨:', charId);
                    }
                }

                console.log('üë• ÏÑ†ÌÉùÎêú Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥:', selectedCharacterData);

                if (selectedCharacterData.length === 0) {
                    throw new Error('ÏÑ†ÌÉùÎêú Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. Ï∫êÎ¶≠ÌÑ∞Î•º Î®ºÏ†Ä ÏÉùÏÑ±ÌïòÍ≥† ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                }

                const response = await fetch('/api/scenario-manager?action=regenerate_context', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title,
                        description,
                        background_setting: 'Î©§Ïã†Ï†Ä ÎåÄÌôî', // Î©§Ïã†Ï†Ä Í∏∞Î∞òÏúºÎ°ú Í≥†Ï†ï
                        mood,
                        available_characters: Array.from(selectedCharacters), // üîß SetÏùÑ Î∞∞Ïó¥Î°ú Î≥ÄÌôò
                        characters: selectedCharacterData // Ï∫êÎ¶≠ÌÑ∞ Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ÎèÑ Ï†ÑÎã¨ (Ìò∏ÌôòÏÑ±)
                    })
                });

                console.log('üì° API ÏùëÎãµ ÏÉÅÌÉú:', response.status);

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || errorData.message || `HTTP ${response.status} Ïò§Î•ò`);
                }

                const data = await response.json();

                if (data.success && data.scenario && data.scenario.ai_generated_context) {
                    console.log('‚úÖ AI Ïª®ÌÖçÏä§Ìä∏ ÏÉùÏÑ± ÏÑ±Í≥µ');

                    // UIÏóê Ïª®ÌÖçÏä§Ìä∏ ÌëúÏãú (ÏÉàÎ°úÏö¥ Ïä§ÌÉÄÏùº Ï†ÅÏö©)
                    aiContextDiv.innerHTML = `
                        <div class="existing-context">
                            <div class="context-header">
                                <span class="context-label">üìñ Î∞©Í∏à ÏÉùÏÑ±Îêú Ïª®ÌÖçÏä§Ìä∏</span>
                                <span class="context-date">${new Date().toLocaleString('ko-KR')}</span>
                            </div>
                            <div class="context-content">${data.scenario.ai_generated_context}</div>
                        </div>
                    `;

                    console.log('‚úÖ AI Ïª®ÌÖçÏä§Ìä∏ UI ÌëúÏãú ÏôÑÎ£å');
                    alert('‚úÖ AI Ïª®ÌÖçÏä§Ìä∏Í∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!\n\nÏù¥Ï†ú "Ï†ÄÏû•" Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ ÏãúÎÇòÎ¶¨Ïò§Î•º Ï†ÄÏû•Ìï¥Ï£ºÏÑ∏Ïöî.');

                } else {
                    throw new Error(data.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                }

            } catch (error) {
                console.error('‚ùå AI Ïª®ÌÖçÏä§Ìä∏ ÏÉùÏÑ± Ïã§Ìå®:', error);

                // ÏÇ¨Ïö©ÏûêÏóêÍ≤å ÏπúÌôîÏ†ÅÏù∏ ÏóêÎü¨ Î©îÏãúÏßÄ ÌëúÏãú
                let userMessage = error.message;

                if (error.message.includes('fetch')) {
                    userMessage = 'ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞Ïóê Î¨∏Ï†úÍ∞Ä ÏûàÏäµÎãàÎã§. Ïù∏ÌÑ∞ÎÑ∑ Ïó∞Í≤∞ÏùÑ ÌôïÏù∏ÌïòÍ≥† Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.';
                } else if (error.message.includes('API ÌÇ§')) {
                    userMessage = 'OpenAI API ÌÇ§Í∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÍ±∞ÎÇò Ïú†Ìö®ÌïòÏßÄ ÏïäÏäµÎãàÎã§.\nÍ¥ÄÎ¶¨Ïûê ÌéòÏù¥ÏßÄÏóêÏÑú API ÌÇ§Î•º Îã§Ïãú ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.';
                }

                // ÏóêÎü¨ ÌåùÏóÖ ÌëúÏãú
                alert(`‚ùå AI Ïª®ÌÖçÏä§Ìä∏ ÏÉùÏÑ± Ïã§Ìå®\n\n${userMessage}\n\nÎã§Ïãú ÏãúÎèÑÌïòÍ±∞ÎÇò Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Î¨∏ÏùòÌï¥Ï£ºÏÑ∏Ïöî.`);

                // UI ÏÉÅÌÉú Î≥µÏõê
                aiContextDiv.innerHTML = `
                    <div class="no-context">
                        <div class="no-context-message">
                            üí° AI Ïª®ÌÖçÏä§Ìä∏Î•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî
                        </div>
                        <div class="no-context-help">
                            ÏúÑÏùò "ü§ñ AI Ïª®ÌÖçÏä§Ìä∏ ÏÉùÏÑ±" Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ ÏÜåÏÑ§Ìíç ÏãúÎÇòÎ¶¨Ïò§ Ïª®ÌÖçÏä§Ìä∏Î•º ÏÉùÏÑ±ÌïòÏÑ∏Ïöî
                        </div>
                    </div>
                `;
            }
        }

        function generateLocalAIContext(title, description, backgroundSetting, mood) {
            const templates = {
                'Ïñ¥ÏÉâÌïú ÏÑ§Î†ò': `Î©§Ïã†Ï†Ä ÌôîÎ©¥ ÏÜçÏóêÏÑú ${description} ÏÉÅÌô©Ïù¥ Î≤åÏñ¥ÏßÄÎ©∞, ÏÑúÎ°úÏùò ÎßàÏùåÏùÑ ÌôïÏù∏Ìï¥Í∞ÄÎäî Îã¨ÏΩ§ÌïòÍ≥† Ïñ¥ÏÉâÌïú ÏàúÍ∞ÑÎì§Ïù¥ ÌÖçÏä§Ìä∏Î°ú Ï†ÑÌï¥ÏßÑÎã§.`,
                'ÏßÑÏã¨ Í≥†Î∞±': `${description} Î©§Ïã†Ï†ÄÎ•º ÌÜµÌï¥ ÏßÑÏã¨Ïñ¥Î¶∞ Í∞êÏ†ïÏù¥ Ïò§Í∞ÄÎ©∞, Îëê ÏÇ¨Îûå ÏÇ¨Ïù¥Ïùò ÏßÑÏßú ÎßàÏùåÏù¥ ÎìúÎü¨ÎÇòÎäî Ï§ëÏöîÌïú ÏàúÍ∞ÑÏù¥Îã§.`,
                'Îã¨ÏΩ§Ìïú Î∞ÄÎãπ': `${description} Î©§Ïã†Ï†Ä ÎåÄÌôîÏóêÏÑú ÏùÄÍ∑ºÌïú Î∞ÄÎãπÍ≥º ÏÑ§Î†òÏù¥ ÍµêÏ∞®ÌïòÎ©∞, ÏÑúÎ°úÏùò ÎßàÏùåÏùÑ Îñ†Î≥¥Îäî Îã¨ÏΩ§Ìïú Í≤åÏûÑÏù¥ ÌéºÏ≥êÏßÑÎã§.`,
                'ÏÉàÎ≤Ω Í∞êÏÑ±': `Îä¶ÏùÄ Î∞§ Î©§Ïã†Ï†ÄÎ°ú ${description} ÏÉÅÌô©Ïù¥ Ïù¥Ïñ¥ÏßÄÎ©∞, ÌèâÏÜå ÌïòÏßÄ Î™ªÌñàÎçò ÏÜîÏßÅÌïú Í∞êÏ†ïÎì§Ïù¥ Ï°∞Ïã¨Ïä§ÎüΩÍ≤å ÌëúÌòÑÎêúÎã§.`
            };

            return templates[mood] || templates['Îã¨ÏΩ§Ìïú Î∞ÄÎãπ'];
        }


        // === ÏòàÏãú ÏûêÎèô ÏûÖÎ†• Í∏∞Îä• ===
        function fillExample(fieldId, element) {
            const field = document.getElementById(fieldId);
            const text = element.textContent;

            if (field.tagName === 'TEXTAREA') {
                field.value = text;
                field.style.height = 'auto';
                field.style.height = field.scrollHeight + 'px';
            } else {
                field.value = text;
            }

            // ÏÉÅÌô© ÎØ∏Î¶¨Î≥¥Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏ (Ï†úÎ™© ÌïÑÎìúÏù∏ Í≤ΩÏö∞)
            if (fieldId === 'scenarioTitle') {
                updateSituationPreview();
            }

            // ÏãúÍ∞ÅÏ†Å ÌîºÎìúÎ∞±
            element.classList.add('selected');
            setTimeout(() => element.classList.remove('selected'), 300);

            // ÏûÖÎ†• Ïù¥Î≤§Ìä∏ Ìä∏Î¶¨Í±∞
            field.dispatchEvent(new Event('input', { bubbles: true }));
        }

        // === ÏÉÅÌô© ÎØ∏Î¶¨Î≥¥Í∏∞ Í∏∞Îä• ===
        function updateSituationPreview() {
            const title = document.getElementById('scenarioTitle').value;
            const previewDiv = document.getElementById('situationPreview');
            const contentDiv = document.getElementById('situationPreviewContent');

            if (!title) {
                previewDiv.style.display = 'none';
                return;
            }

            const situationExamples = {
                'Ïñ¥Ï†ú Ïà†ÏûêÎ¶¨ Ïù¥ÌõÑ': 'Ïñ¥Ï†ú Î∞§ Ïà†ÏûêÎ¶¨ÏóêÏÑú ÏßÑÏã¨Ïñ¥Î¶∞ ÎßàÏùåÏùÑ Í≥†Î∞±ÌñàÏßÄÎßå, Îëò Îã§ Ï∑®Ìï¥ÏûàÏñ¥ÏÑú Ïñ¥ÏÉâÌïú ÏÉÅÌô©. Ïò§Îäò ÏïÑÏπ®Ïóê Î©îÏã†Ï†ÄÎ°ú "Ïñ¥Ï†ú Í∏∞ÏñµÎÇò?"ÎùºÍ≥† ÏãúÏûëÌïòÎäî ÎåÄÌôî',
                'Í∞ëÏûëÏä§Îü¨Ïö¥ ÌÇ§Ïä§ Ïù¥ÌõÑ': 'ÏòàÏÉÅÏπò Î™ªÌïú ÏàúÍ∞ÑÏóê ÌÇ§Ïä§Í∞Ä ÏùºÏñ¥ÎÇ¨ÏßÄÎßå, Í∑∏ Ïù¥ÌõÑ Î©∞Ïπ†Í∞Ñ Ïó∞ÎùΩÏù¥ ÏóÜÏóàÎçò ÏÉÅÌô©. ÏÉÅÎåÄÎ∞©Ïù¥ Î®ºÏ†Ä "Í∑∏Îïå Ïùº ÎïåÎ¨∏Ïóê..."ÎùºÍ≥† Î©îÏã†Ï†ÄÎ•º Î≥¥ÎÇ¥Ïò® ÏÉÅÌô©',
                'Í≥†Î∞± ÌõÑ ÎãµÎ≥Ä Í∏∞Îã§Î¶¨Îäî Ï§ë': 'ÏßÑÏã¨ÏúºÎ°ú Í≥†Î∞±ÌñàÏßÄÎßå ÏïÑÏßÅ Î™ÖÌôïÌïú ÎãµÎ≥ÄÏùÑ Îì£ÏßÄ Î™ªÌïú ÏÉÅÌô©. ÏÉÅÎåÄÎ∞©Ïù¥ Ïã†Ï§ëÌïòÍ≤å Î©îÏã†Ï†ÄÎ°ú ÏûêÏã†Ïùò ÎßàÏùåÏùÑ Ï†ïÎ¶¨Ìï¥ÏÑú Î≥¥ÎÇ¥Îäî ÎåÄÌôî',
                'Ï≤´ Îç∞Ïù¥Ìä∏ ÏïΩÏÜç Ïû°Í∏∞': 'ÏÑúÎ°ú Ìò∏Í∞êÏù¥ ÏûàÎã§Îäî Í≤ÉÏùÑ ÌôïÏù∏ÌñàÏßÄÎßå, ÏïÑÏßÅ Í≥µÏãùÏ†ÅÏù∏ ÎßåÎÇ®ÏùÄ ÏóÜÏóàÎçò ÏÉÅÌô©. Î©îÏã†Ï†ÄÎ°ú ÏûêÏó∞Ïä§ÎüΩÍ≤å Ï≤´ Îç∞Ïù¥Ìä∏ ÏïΩÏÜçÏùÑ Ïû°ÏïÑÍ∞ÄÎäî Í≥ºÏ†ï',
                'Î∞§Îä¶ÏùÄ ÏßÑÏã¨ ÎåÄÌôî': 'ÌèâÏÜåÎ≥¥Îã§ Í∞êÏÑ±Ï†ÅÏù∏ ÏÉàÎ≤Ω ÏãúÍ∞Ñ, Ïû†Îì§Í∏∞ Ï†Ñ ÌèâÏÜå ÌïòÏßÄ Î™ªÌñàÎçò ÏßÑÏÜîÌïú ÎßàÏùåÏùÑ Î©îÏã†Ï†ÄÎ°ú ÎÇòÎàÑÎäî ÍπäÏùÄ ÎåÄÌôî',
                'Ïò§Ìï¥ ÌõÑ ÌôîÌï¥ÌïòÍ∏∞': 'ÏûëÏùÄ Ïò§Ìï¥Î°ú Ïù∏Ìï¥ ÏÇ¨Ïù¥Í∞Ä ÏÑúÎ®πÌï¥ÏßÑ ÏÉÅÌô©. Î©îÏã†Ï†ÄÎ°ú ÏßÑÏ†ïÏÑ± ÏûàÍ≤å ÏÇ¨Í≥ºÌïòÍ≥† ÏÑúÎ°úÏùò ÎßàÏùåÏùÑ ÌôïÏù∏ÌïòÎäî ÌôîÌï¥ Í≥ºÏ†ï',
                'ÏßàÌà¨ ÏÉÅÌô© Ìï¥Í≤∞ÌïòÍ∏∞': 'ÏÉÅÎåÄÎ∞©Ïù¥ Îã§Î•∏ ÏÇ¨ÎûåÍ≥º ÏπúÌïòÍ≤å ÏßÄÎÇ¥Îäî Î™®ÏäµÏùÑ Î≥∏ ÌõÑ ÏÉùÍ∏¥ ÏßàÌà¨Í∞êÏùÑ Î©îÏã†Ï†ÄÎ°ú ÏùÄÍ∑ºÌûà ÌëúÌòÑÌïòÎ©∞ Í¥ÄÍ≥ÑÎ•º ÌôïÏù∏ÌïòÎäî ÎåÄÌôî',
                'ÏÑúÏö¥Ìï® ÌëúÌòÑÌïòÍ∏∞': 'ÏÉÅÎåÄÎ∞©Ïùò Î¨¥Í¥ÄÏã¨ÌïòÍ±∞ÎÇò ÏÜåÌôÄÌïú ÌÉúÎèÑÏóê ÏÑúÏö¥Ìï®ÏùÑ ÎäêÍºàÏùÑ Îïå, Î©îÏã†Ï†ÄÎ°ú ÏÜîÏßÅÌïòÍ≤å ÏûêÏã†Ïùò Í∞êÏ†ïÏùÑ ÌëúÌòÑÌïòÎäî ÏÉÅÌô©',
                'Ïï†Íµê Î∂ÄÎ¶¨Î©∞ Îã¨ÎûòÍ∏∞': 'ÌèâÏÜåÎ≥¥Îã§ Ïï†ÍµêÏä§ÎüΩÍ≥† Í∑ÄÏó¨Ïö¥ Î©îÏãúÏßÄÎ°ú ÏÉÅÎåÄÎ∞©Ïùò ÎßàÏùåÏùÑ Îã¨ÎûòÍ±∞ÎÇò Í¥ÄÏã¨ÏùÑ ÎÅåÎ†§Í≥† ÎÖ∏Î†•ÌïòÎäî ÏÉÅÌô©',
                'ÏÉàÎ≤Ω Í∞êÏÑ± Î©îÏãúÏßÄ': 'ÏÉàÎ≤Ω Í∞êÏÑ±Ïóê Ï†ñÏñ¥ ÌèâÏÜå ÌïòÏßÄ Î™ªÌñàÎçò Î°úÎß®Ìã±Ìïú Î©îÏãúÏßÄÎÇò Í∞êÏ†ïÏùÑ ÏÜîÏßÅÌïòÍ≤å ÌëúÌòÑÌïòÎäî ÌäπÎ≥ÑÌïú ÏàúÍ∞Ñ',
                'Í∏∞ÎÖêÏùº ÍπúÏßù Ïù¥Î≤§Ìä∏': 'ÌäπÎ≥ÑÌïú ÎÇ†ÏùÑ Í∏∞ÎÖêÌïòÎ©∞ Î©îÏã†Ï†ÄÎ°ú ÍπúÏßù Ïù¥Î≤§Ìä∏ÎÇò ÏÑ†Î¨ºÏùÑ Ï§ÄÎπÑÌñàÎã§Îäî Î©îÏãúÏßÄÎ•º Î≥¥ÎÇ¥Îäî ÏÑ§Î†àÎäî ÏÉÅÌô©',
                'Ïû•Í±∞Î¶¨ Ïó∞Ïï† Í∑∏Î¶¨ÏõÄ': 'Î©ÄÎ¶¨ Îñ®Ïñ¥Ï†∏ ÏûàÏñ¥ÏÑú ÏûêÏ£º ÎßåÎÇ† Ïàò ÏóÜÎäî ÏÉÅÌô©ÏóêÏÑú Î©îÏã†Ï†ÄÎ°ú Í∑∏Î¶¨ÏõÄÍ≥º Ïï†ÌããÌïú ÎßàÏùåÏùÑ Ï†ÑÌïòÎäî ÎåÄÌôî'
            };

            const example = situationExamples[title];
            if (example) {
                contentDiv.innerHTML = `
                    <div style="margin-bottom: 10px;">
                        <strong>üì± ${title}</strong>
                    </div>
                    <div style="color: #666; font-size: 14px; line-height: 1.4;">
                        ${example}
                    </div>
                `;
                previewDiv.style.display = 'block';
            } else {
                previewDiv.style.display = 'none';
            }
        }

        // === ÏóêÌîºÏÜåÎìú Í¥ÄÎ¶¨ Ìï®ÏàòÎì§ ===
        function manageDialogues(scenarioId) {
            switchTab('dialogues');

            // select ÏöîÏÜåÍ∞Ä ÏûàÏúºÎ©¥ Í∞í ÏÑ§Ï†ï
            const dialogueSelect = document.getElementById('dialogueScenarioSelect');
            if (dialogueSelect) {
                dialogueSelect.value = scenarioId;
            }

            // currentScenarioIdÎ°úÎèÑ ÏÑ§Ï†ï (Ïπ¥Îìú Í∏∞Î∞ò UIÏóêÏÑú ÏÇ¨Ïö©)
            currentScenarioId = scenarioId;

            loadDialogues();
        }

        function populateDialogueScenarioSelect() {
            const select = document.getElementById('dialogueScenarioSelect');

            // DOM ÏöîÏÜåÍ∞Ä Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏúºÎ©¥ Ï°∞Ïö©Ìûà Î¶¨ÌÑ¥ (Ïπ¥Îìú Í∏∞Î∞ò UI ÏÇ¨Ïö©)
            if (!select) {
                return;
            }

            select.innerHTML = '<option value="">ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>';

            Object.values(scenarios).forEach(scenario => {
                const option = document.createElement('option');
                option.value = scenario.id;
                option.textContent = scenario.title;
                select.appendChild(option);
            });
        }

        async function loadDialogues() {
            // Ï§ëÎ≥µ Ìò∏Ï∂ú Î∞©ÏßÄ
            if (processingState.loadingEpisodes) {
                console.log('‚è≥ ÏóêÌîºÏÜåÎìú Î°úÎî© Ïù¥ÎØ∏ ÏßÑÌñâ Ï§ë - Í±¥ÎÑàÎúÄ');
                return;
            }

            processingState.loadingEpisodes = true;

            try {
                // Ïö∞ÏÑ†ÏàúÏúÑ: currentScenarioId ‚Üí dialogueScenarioSelect Í∞í
                let scenarioId = currentScenarioId;

            const dialogueSelect = document.getElementById('dialogueScenarioSelect');
            if (dialogueSelect && dialogueSelect.value) {
                scenarioId = dialogueSelect.value;
            }

            if (!scenarioId) {
                document.getElementById('dialogueInfo').style.display = 'none';
                console.log('‚ö†Ô∏è ÏãúÎÇòÎ¶¨Ïò§ IDÍ∞Ä ÏóÜÏñ¥ÏÑú ÏóêÌîºÏÜåÎìú Î°úÎî©ÏùÑ Í±¥ÎÑàÎúÅÎãàÎã§.');
                console.log('üîç ÎîîÎ≤ÑÍ∑∏ Ï†ïÎ≥¥:', {
                    currentScenarioId: currentScenarioId,
                    dialogueSelectValue: dialogueSelect ? dialogueSelect.value : 'element not found'
                });
                return;
            }

                currentScenarioId = scenarioId;
                document.getElementById('dialogueInfo').style.display = 'block';
                console.log('üìö ÏóêÌîºÏÜåÎìú Î°úÎî© ÏãúÏûë - ÏãúÎÇòÎ¶¨Ïò§:', scenarioId);

                // APIÏóêÏÑú ÏóêÌîºÏÜåÎìú Î°úÎî©
                console.log('üîó Dialogue Manager API Ìò∏Ï∂ú:', `/api/dialogue-manager?action=list&scenario_id=${scenarioId}`);

                const response = await fetch(`/api/dialogue-manager?action=list&scenario_id=${scenarioId}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('üìä API ÏùëÎãµ:', result);
                console.log('üîç ÏÉÅÏÑ∏ ÎîîÎ≤ÑÍπÖ:', {
                    success: result.success,
                    dialogues_count: result.dialogues ? result.dialogues.length : 0,
                    scenario_id: result.scenario_id,
                    requested_scenario_id: scenarioId,
                    first_dialogue: result.dialogues && result.dialogues[0] ? result.dialogues[0] : 'none'
                });

                let dialoguesData = {};

                if (result.success && result.dialogues) {
                    // APIÏóêÏÑú Î∞õÏùÄ ÎåÄÌôîÎ•º dialogue_numberÎ•º ÌÇ§Î°ú ÌïòÎäî Í∞ùÏ≤¥Î°ú Î≥ÄÌôò
                    result.dialogues.forEach(dialogue => {
                        dialoguesData[dialogue.dialogue_number] = dialogue;
                    });

                    console.log(`‚úÖ ÏãúÎÇòÎ¶¨Ïò§ ${scenarioId}Ïùò ÎåÄÌôî:`, Object.keys(dialoguesData).length, 'Í∞ú');
                    console.log('üìã ÎåÄÌôî Î≤àÌò∏ Î™©Î°ù:', Object.keys(dialoguesData));
                    console.log('üìÑ Ï≤´ Î≤àÏß∏ ÎåÄÌôî ÏÉÅÏÑ∏:', dialoguesData[Object.keys(dialoguesData)[0]]);
                } else {
                    console.log('üì≠ Ìï¥Îãπ ÏãúÎÇòÎ¶¨Ïò§Ïóê ÏÉùÏÑ±Îêú ÎåÄÌôîÍ∞Ä ÏóÜÏäµÎãàÎã§.');
                }

                // Ï†ÑÏó≠ Î≥ÄÏàò ÏóÖÎç∞Ïù¥Ìä∏
                dialogues = dialoguesData;
                window.dialogues = dialoguesData;

                // UI ÏóÖÎç∞Ïù¥Ìä∏
                displayDialogues();
                updateDialogueStats();

            } catch (error) {
                console.error('‚ùå ÏóêÌîºÏÜåÎìú API Î°úÎìú Ïò§Î•ò:', error);
                // API Ïã§Ìå® Ïãú Îπà Í∞ùÏ≤¥Î°ú Ï¥àÍ∏∞Ìôî
                dialogues = {};
                window.dialogues = {};
                displayDialogues();
                updateDialogueStats();

                showNotification(`ÏóêÌîºÏÜåÎìú Î°úÎìú Ïã§Ìå®: ${error.message}`, 'error');
            } finally {
                // Î°úÎî© ÏÉÅÌÉú Ìï¥Ï†ú
                processingState.loadingEpisodes = false;
                console.log('üîì ÏóêÌîºÏÜåÎìú Î°úÎî© ÏÉÅÌÉú Ìï¥Ï†ú');
            }
        }

        function displayDialogues() {
            const grid = document.getElementById('dialoguesGrid');
            grid.innerHTML = '';
            grid.className = 'episodes-grid'; // ÏóêÌîºÏÜåÎìú Ïπ¥Îìú Ï†ÑÏö© Í∑∏Î¶¨Îìú Ïä§ÌÉÄÏùº Ï†ÅÏö©

            console.log('üé® ÏóêÌîºÏÜåÎìú ÌëúÏãú ÏãúÏûë:', {
                dialogues_object: dialogues,
                dialogues_keys: Object.keys(dialogues),
                currentDifficultyFilter: currentDifficultyFilter
            });

            let displayedCount = 0;
            let completedCount = 0;

            for (let i = 1; i <= 36; i++) {
                const dialogue = dialogues[i];
                const difficulty = getDifficultyByNumber(i);

                if (currentDifficultyFilter !== 'all' && difficulty !== currentDifficultyFilter) {
                    continue;
                }

                if (dialogue) {
                    completedCount++;
                    console.log(`‚úÖ ÏóêÌîºÏÜåÎìú ${i}Î≤à ÌëúÏãú:`, dialogue.title || dialogue.id);
                }

                const card = createDialogueCard(i, dialogue, difficulty);
                grid.innerHTML += card;
                displayedCount++;
            }

            console.log(`üé® ÎåÄÌôî ÌëúÏãú ÏôÑÎ£å: ÌëúÏãúÎê® ${displayedCount}Í∞ú, ÏôÑÎ£åÎê® ${completedCount}Í∞ú`);
        }

        function createDialogueCard(number, dialogue, difficulty) {
            if (dialogue) {
                const characterName = getCharacterName(dialogue.character_id);
                return `
                    <div class="episode-card" onclick="previewDialogue(${number})" title="ÌÅ¥Î¶≠ÌïòÏó¨ ÏóêÌîºÏÜåÎìú #${number} ÎØ∏Î¶¨Î≥¥Í∏∞">
                        <div class="dialogue-header">
                            <div class="dialogue-number">#${number}</div>
                            <div class="difficulty-badge ${difficulty.toLowerCase()}">${difficulty.toUpperCase()}</div>
                        </div>
                        <div class="dialogue-content">
                            <div class="character-info">
                                <span class="character-icon">üë§</span>
                                <span class="character-name">${characterName}</span>
                            </div>
                            <div class="dialogue-status completed">
                                <span class="status-icon">‚úÖ</span>
                                <span class="status-text">ÏôÑÎ£åÎê®</span>
                            </div>
                        </div>
                        <div class="dialogue-actions">
                            <span class="action-btn preview">üìñ ÎØ∏Î¶¨Î≥¥Í∏∞</span>
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div class="episode-card" onclick="createDialogue(${number})" title="ÌÅ¥Î¶≠ÌïòÏó¨ ÏóêÌîºÏÜåÎìú #${number} ÏÉàÎ°ú ÏÉùÏÑ±">
                        <div class="dialogue-header">
                            <div class="dialogue-number">#${number}</div>
                            <div class="difficulty-badge ${difficulty.toLowerCase()}">${difficulty.toUpperCase()}</div>
                        </div>
                        <div class="dialogue-content">
                            <div class="empty-state">
                                <span class="empty-icon">üìù</span>
                                <span class="empty-text">ÏóêÌîºÏÜåÎìú ÏÉùÏÑ±</span>
                            </div>
                        </div>
                        <div class="dialogue-actions">
                            <span class="action-btn create">‚ú® ÏÉùÏÑ±ÌïòÍ∏∞</span>
                        </div>
                    </div>
                `;
            }
        }

        function getDifficultyColor(difficulty) {
            const colors = {
                'easy': '#4CAF50',
                'medium': '#FF9800',
                'hard': '#F44336',
                'expert': '#9C27B0'
            };
            return colors[difficulty.toLowerCase()] || '#666';
        }

        function getDifficultyByNumber(number) {
            if (number <= 9) return 'easy';
            if (number <= 18) return 'medium';
            if (number <= 27) return 'hard';
            return 'expert';
        }

        function getCharacterName(characterId) {
            const names = {
                'yuna_infp': 'Ïú§ÏïÑ',
                'mina_enfp': 'ÎØ∏ÎÇò',
                'seoyeon_intj': 'ÏÑúÏó∞',
                'jihye_esfj': 'ÏßÄÌòú',
                'hyejin_istp': 'ÌòúÏßÑ'
            };
            return names[characterId] || 'Ïïå Ïàò ÏóÜÏùå';
        }

        function updateDialogueStats() {
            const dialogueArray = Object.values(dialogues);

            // ÏóêÌîºÏÜåÎìú Í∞úÏàò Í≥ÑÏÇ∞: ÏãúÎÇòÎ¶¨Ïò§ + Ï∫êÎ¶≠ÌÑ∞ Ï°∞Ìï©Î≥ÑÎ°ú Í∑∏Î£πÌôî
            const episodeGroups = new Set();
            dialogueArray.forEach(dialogue => {
                if (dialogue.scenario_id && dialogue.character_id) {
                    episodeGroups.add(`${dialogue.scenario_id}_${dialogue.character_id}`);
                }
            });

            const episodeCount = episodeGroups.size;
            const totalDialogues = dialogueArray.length;

            console.log('üìä ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏:', {
                Ï¥ù_ÎåÄÌôîÏàò: totalDialogues,
                ÏóêÌîºÏÜåÎìú_Ï°∞Ìï©: Array.from(episodeGroups),
                ÏóêÌîºÏÜåÎìú_Í∞úÏàò: episodeCount
            });

            document.getElementById('totalDialogues').textContent = `${totalDialogues}/36`;
            document.getElementById('progressBar').style.width = `${(totalDialogues/36)*100}%`;
            document.getElementById('episodeCount').textContent = episodeCount;
            
            // ÎÇúÏù¥ÎèÑÎ≥Ñ Ïπ¥Ïö¥Ìä∏
            let counts = { easy: 0, medium: 0, hard: 0, expert: 0 };
            dialogueArray.forEach(ep => {
                const difficulty = getDifficultyByNumber(ep.dialogue_number);
                counts[difficulty]++;
            });
            
            document.getElementById('easyCount').textContent = `${counts.easy}/9`;
            document.getElementById('mediumCount').textContent = `${counts.medium}/9`;
            document.getElementById('hardCount').textContent = `${counts.hard}/9`;
            document.getElementById('expertCount').textContent = `${counts.expert}/9`;
            
            // ÌÉ≠ Ïπ¥Ïö¥Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('allCount').textContent = totalDialogues;
            document.getElementById('easyTabCount').textContent = counts.easy;
            document.getElementById('mediumTabCount').textContent = counts.medium;
            document.getElementById('hardTabCount').textContent = counts.hard;
            document.getElementById('expertTabCount').textContent = counts.expert;
        }

        // ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÏÉÅÌÉú ÌôïÏù∏ Î∞è Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî
        async function checkServerConnection() {
            try {
                console.log('üîó ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÏÉÅÌÉú ÌôïÏù∏ Ï§ë...');

                // API ÏóîÎìúÌè¨Ïù∏Ìä∏Î≥Ñ ÏÉÅÌÉú ÌôïÏù∏
                const checks = [
                    { name: 'Dialogue Manager', url: '/api/dialogue-manager?action=test' },
                    { name: 'Scenario Manager', url: '/api/scenario-manager?action=list' },
                    { name: 'Character Manager', url: '/api/character-ai-generator?action=list_characters' }
                ];

                const results = [];
                for (const check of checks) {
                    try {
                        const response = await fetch(check.url);
                        const isOk = response.ok;
                        results.push({ name: check.name, status: isOk ? '‚úÖ' : '‚ùå', code: response.status });
                        console.log(`${isOk ? '‚úÖ' : '‚ùå'} ${check.name}: ${response.status}`);
                    } catch (error) {
                        results.push({ name: check.name, status: '‚ùå', error: error.message });
                        console.error(`‚ùå ${check.name}: ${error.message}`);
                    }
                }

                // Ïó∞Í≤∞ ÏÉÅÌÉú UI ÏóÖÎç∞Ïù¥Ìä∏
                const statusElement = document.getElementById('serverStatus');
                if (statusElement) {
                    const allOk = results.every(r => r.status === '‚úÖ');
                    statusElement.innerHTML = allOk ?
                        'üü¢ ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ï†ïÏÉÅ' :
                        'üî¥ ÏùºÎ∂Ä ÏÑúÎ≤Ñ Ïó∞Í≤∞ Î∂àÏïàÏ†ï';
                    statusElement.className = allOk ? 'server-status online' : 'server-status offline';
                }

                return results;
            } catch (error) {
                console.error('‚ùå ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÌôïÏù∏ Ïã§Ìå®:', error);
                return [];
            }
        }

        // Ï†ÑÏ≤¥ ÏóêÌîºÏÜåÎìú Ïπ¥Ïö¥Ìä∏ Î°úÎìú (Ï¥àÍ∏∞ÌôîÏö©)
        async function loadTotalEpisodeCount() {
            // Ï§ëÎ≥µ Ìò∏Ï∂ú Î∞©ÏßÄ
            if (processingState.loadingTotal) {
                console.log('‚è≥ Ï†ÑÏ≤¥ ÏóêÌîºÏÜåÎìú Ïπ¥Ïö¥Ìä∏ Î°úÎî© Ïù¥ÎØ∏ ÏßÑÌñâ Ï§ë - Í±¥ÎÑàÎúÄ');
                return;
            }

            const now = Date.now();
            if (processingState.lastUpdate && (now - processingState.lastUpdate) < processingState.updateInterval) {
                console.log('‚è∞ ÏóÖÎç∞Ïù¥Ìä∏ Í∞ÑÍ≤© Ï†úÌïú - Í±¥ÎÑàÎúÄ (ÏµúÍ∑º ÏóÖÎç∞Ïù¥Ìä∏:', new Date(processingState.lastUpdate).toLocaleTimeString(), ')');
                return;
            }

            processingState.loadingTotal = true;
            processingState.lastUpdate = now;

            try {
                console.log('üìä Ï†ÑÏ≤¥ ÏóêÌîºÏÜåÎìú Ïπ¥Ïö¥Ìä∏ Î°úÎî© ÏãúÏûë...');

                // dialogue-manager APIÎ•º ÌÜµÌï¥ Ï†ÑÏ≤¥ ÏóêÌîºÏÜåÎìú Ï°∞Ìöå ÏãúÎèÑ
                const response = await fetch('/api/dialogue-manager?action=get_all_episodes');

                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.episodes) {
                        const allEpisodes = Object.values(result.episodes);

                        // ÏóêÌîºÏÜåÎìú Í∞úÏàò Í≥ÑÏÇ∞: ÏãúÎÇòÎ¶¨Ïò§ + Ï∫êÎ¶≠ÌÑ∞ Ï°∞Ìï©Î≥ÑÎ°ú Í∑∏Î£πÌôî
                        const episodeGroups = new Set();
                        allEpisodes.forEach(episode => {
                            if (episode.scenario_id && episode.character_id) {
                                episodeGroups.add(`${episode.scenario_id}_${episode.character_id}`);
                            }
                        });

                        const totalEpisodeCount = episodeGroups.size;
                        const totalDialogueCount = allEpisodes.length;

                        console.log('üìä Ï†ÑÏ≤¥ ÌÜµÍ≥Ñ:', {
                            Ï¥ù_ÏóêÌîºÏÜåÎìú_Ïàò: totalEpisodeCount,
                            Ï¥ù_ÎåÄÌôî_Ïàò: totalDialogueCount,
                            ÏóêÌîºÏÜåÎìú_Ï°∞Ìï©: Array.from(episodeGroups)
                        });

                        // ÏóêÌîºÏÜåÎìú ÌÉ≠ Ïπ¥Ïö¥Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
                        document.getElementById('episodeCount').textContent = totalEpisodeCount;

                        return totalEpisodeCount;
                    }
                }

                // API ÏùëÎãµÏù¥ Ïã§Ìå®Ìïú Í≤ΩÏö∞ ÏóêÎü¨ Ï∂úÎ†•
                const errorText = await response.text();
                throw new Error(`API Ïò§Î•ò (${response.status}): ${errorText}`);

            } catch (error) {
                console.error('‚ùå Ï†ÑÏ≤¥ ÏóêÌîºÏÜåÎìú Ïπ¥Ïö¥Ìä∏ Î°úÎî© Ïã§Ìå®:', error.message);
                showNotification(`Ï†ÑÏ≤¥ ÏóêÌîºÏÜåÎìú Ïπ¥Ïö¥Ìä∏ Î°úÎî© Ïã§Ìå®: ${error.message}`, 'error');

                // ÏóêÎü¨ Î∞úÏÉù Ïãú Í∏∞Î≥∏Í∞í ÌëúÏãú
                document.getElementById('episodeCount').textContent = 'ERROR';
            } finally {
                // Î°úÎî© ÏÉÅÌÉú Ìï¥Ï†ú
                processingState.loadingTotal = false;
                console.log('üîì Ï†ÑÏ≤¥ ÏóêÌîºÏÜåÎìú Ïπ¥Ïö¥Ìä∏ Î°úÎî© ÏÉÅÌÉú Ìï¥Ï†ú');
            }
        }

        function filterByDifficulty(difficulty) {
            currentDifficultyFilter = difficulty;
            
            // ÌÉ≠ ÌôúÏÑ±Ìôî ÏÉÅÌÉú Î≥ÄÍ≤Ω
            document.querySelectorAll('.difficulty-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.closest('.difficulty-tab').classList.add('active');
            
            displayDialogues();
        }

        function openDialogueModal(mode) {
            currentMode = mode;

            // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§Í∞Ä ÏóÜÏúºÎ©¥ Í≤ΩÍ≥†
            if (!currentScenarioId) {
                alert('Î®ºÏ†Ä ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.\n\nÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ùÏóêÏÑú ÏãúÎÇòÎ¶¨Ïò§Î•º ÌÅ¥Î¶≠ÌïòÍ±∞ÎÇò,\n"ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉù" ÎìúÎ°≠Îã§Ïö¥ÏóêÏÑú ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            document.getElementById('dialogueModalTitle').textContent = 'ÏÉà ÏóêÌîºÏÜåÎìú ÏÉùÏÑ±';
            document.getElementById('dialogueForm').reset();
            document.getElementById('dialoguePreview').style.display = 'none';
            generatedDialogue = null;

            // ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§ Ï†ïÎ≥¥ ÏûêÎèô ÌëúÏãú
            updateSelectedScenarioInfo();

            // ÏóêÌîºÏÜåÎìú Î≤àÌò∏Îäî ÏÇ¨Ïö©ÏûêÍ∞Ä ÏßÅÏ†ë ÏûÖÎ†•ÌïòÎèÑÎ°ù Ìï®
            document.getElementById('dialogueNumber').value = '';
            document.getElementById('difficulty').value = 'easy';

            document.getElementById('dialogueModal').style.display = 'block';
        }

        function createDialogue(number) {
            // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§Í∞Ä ÏóÜÏúºÎ©¥ ÏóêÎü¨
            if (!currentScenarioId) {
                alert('Î®ºÏ†Ä ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            openDialogueModal('create');
            document.getElementById('dialogueNumber').value = number;

            // ÎÇúÏù¥ÎèÑ ÏûêÎèô ÏÑ§Ï†ï
            const difficulty = getDifficultyByNumber(number);
            document.getElementById('difficulty').value = difficulty;

            // ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§ Ï†ïÎ≥¥ ÌëúÏãú
            updateSelectedScenarioInfo();
        }

        function updateSelectedScenarioInfo() {
            // ÏãúÎÇòÎ¶¨Ïò§ Ï†ïÎ≥¥ Ï°∞Ìöå (window.scenarios ÎòêÎäî Ï†ÑÏó≠ scenarios ÏÇ¨Ïö©)
            const scenariosData = window.scenarios || scenarios || {};
            const scenario = scenariosData[currentScenarioId];
            const infoContainer = document.getElementById('selectedScenarioInfo');

            if (scenario && infoContainer) {
                // ÏãúÎÇòÎ¶¨Ïò§Ïóê Ïó∞Í≤∞Îêú Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                const characterId = scenario.available_characters?.[0];

                // Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥ Ï°∞Ìöå (window.characters ÎòêÎäî Ï†ÑÏó≠ characters ÏÇ¨Ïö©)
                const charactersData = window.characters || characters || {};
                const character = charactersData[characterId];

                infoContainer.innerHTML = `
                    <div class="info-title">${scenario.title}</div>
                    <div class="info-character">Ï∫êÎ¶≠ÌÑ∞: ${character ? character.name : characterId || 'Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥ ÏóÜÏùå'}</div>
                    <div class="info-description" style="color: #6c757d; margin-top: 5px; font-size: 0.9em;">${scenario.description}</div>
                `;

                // hidden inputÏóê ÏãúÎÇòÎ¶¨Ïò§ ID ÏÑ§Ï†ï
                document.getElementById('dialogueScenarioId').value = currentScenarioId;
            } else {
                infoContainer.innerHTML = `
                    <div class="info-title">ÏãúÎÇòÎ¶¨Ïò§ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§</div>
                    <div class="info-character">Î®ºÏ†Ä ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.</div>
                `;
            }
        }

        // Episode Preview Functions
        let currentPreviewDialogueNumber = null;

        function previewDialogue(number) {
            const episode = dialogues[number];
            if (!episode) {
                alert('ÏóêÌîºÏÜåÎìú Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }

            currentPreviewDialogueNumber = number;
            console.log('üìñ ÏóêÌîºÏÜåÎìú ÎØ∏Î¶¨Î≥¥Í∏∞:', number, episode);

            // Update modal title
            document.getElementById('dialoguePreviewTitle').textContent = `üìñ ÏóêÌîºÏÜåÎìú #${number} ÎØ∏Î¶¨Î≥¥Í∏∞`;

            // Display episode metadata
            displayDialogueMetadata(episode, number);

            // Display dialogue content
            displayDialogueContent(episode);

            // Show modal
            document.getElementById('dialoguePreviewModal').style.display = 'block';
        }

        function displayDialogueMetadata(episode, number) {
            const metadata = document.getElementById('dialogueMetadata');
            const difficulty = getDifficultyByNumber(number);
            const characterName = getCharacterName(episode.character_id);

            metadata.innerHTML = `
                <div class="metadata-item">
                    <div class="metadata-label">ÏóêÌîºÏÜåÎìú Î≤àÌò∏</div>
                    <div class="metadata-value">#${number}</div>
                </div>
                <div class="metadata-item">
                    <div class="metadata-label">ÎÇúÏù¥ÎèÑ</div>
                    <div class="metadata-value">${difficulty.toUpperCase()}</div>
                </div>
                <div class="metadata-item">
                    <div class="metadata-label">Ï∫êÎ¶≠ÌÑ∞</div>
                    <div class="metadata-value">${characterName} (${episode.character_id})</div>
                </div>
                <div class="metadata-item">
                    <div class="metadata-label">ÏãúÎÇòÎ¶¨Ïò§</div>
                    <div class="metadata-value">${episode.scenario_id}</div>
                </div>
                <div class="metadata-item">
                    <div class="metadata-label">ÏÉùÏÑ±Ïùº</div>
                    <div class="metadata-value">${episode.created_at ? new Date(episode.created_at).toLocaleString() : 'Ïïå Ïàò ÏóÜÏùå'}</div>
                </div>
                <div class="metadata-item">
                    <div class="metadata-label">ÏÉÅÌô© ÌîÑÎ°¨ÌîÑÌä∏</div>
                    <div class="metadata-value">${episode.user_input_prompt || 'ÏóÜÏùå'}</div>
                </div>
            `;
        }

        function displayDialogueContent(episode) {
            const characterMessage = document.getElementById('characterMessage');
            const narrationDisplay = document.getElementById('narrationDisplay');
            const choicesDisplay = document.getElementById('choicesDisplay');

            // Get dialogue data - check all possible field names and structures
            let dialogueData = episode.dialogue || episode.generated_dialogue || episode.ai_generated_dialogue;

            console.log('üí¨ ÏóêÌîºÏÜåÎìú Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞:', episode);
            console.log('üí¨ ÎåÄÌôî Îç∞Ïù¥ÌÑ∞:', dialogueData);

            if (dialogueData) {
                // Handle different dialogue data structures
                let characterMsg = '';
                let narrationText = '';
                let choices = [];

                // Check if it's a story_flow structure
                if (dialogueData.story_flow && Array.isArray(dialogueData.story_flow)) {
                    const dialogueFlow = dialogueData.story_flow.find(item => item.type === 'dialogue');
                    const choiceFlow = dialogueData.story_flow.find(item => item.type === 'choice_point');

                    characterMsg = dialogueFlow ? dialogueFlow.text : 'ÎåÄÌôî ÎÇ¥Ïö©Ïù¥ ÏóÜÏäµÎãàÎã§.';
                    narrationText = dialogueFlow ? dialogueFlow.narration : '';
                    choices = choiceFlow ? choiceFlow.choices : [];
                } else {
                    // Standard dialogue structure
                    characterMsg = dialogueData.dialogue || dialogueData.character_message || dialogueData.text || 'ÎåÄÌôî ÎÇ¥Ïö©Ïù¥ ÏóÜÏäµÎãàÎã§.';
                    narrationText = dialogueData.narration || dialogueData.context || '';
                    choices = dialogueData.choices || [];
                }

                // Display character message
                characterMessage.innerHTML = `<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff;">${characterMsg}</div>`;

                // Display narration
                if (narrationText) {
                    narrationDisplay.innerHTML = `<div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; font-style: italic;">${narrationText}</div>`;
                    narrationDisplay.style.display = 'block';
                } else {
                    narrationDisplay.style.display = 'none';
                }

                // Display choices
                if (choices && Array.isArray(choices) && choices.length > 0) {
                    let choicesHtml = '<div style="margin-top: 15px;"><h4 style="margin-bottom: 10px; color: #495057;">ÏÑ†ÌÉùÏßÄ:</h4>';
                    choices.forEach((choice, index) => {
                        const impact = choice.affection_impact || 0;
                        const impactClass = impact > 0 ? 'impact-positive' : impact < 0 ? 'impact-negative' : 'impact-neutral';
                        const impactText = impact > 0 ? `+${impact}` : impact < 0 ? `${impact}` : '0';

                        choicesHtml += `
                            <div class="choice-preview" style="margin-bottom: 10px; padding: 12px; border: 1px solid #dee2e6; border-radius: 6px; background: #ffffff;">
                                <div class="choice-text" style="font-weight: 500; margin-bottom: 5px;">${index + 1}. ${choice.text}</div>
                                <div class="choice-impact ${impactClass}" style="font-size: 0.85em; font-weight: bold;">Ìò∏Í∞êÎèÑ ${impactText}</div>
                            </div>
                        `;
                    });
                    choicesHtml += '</div>';
                    choicesDisplay.innerHTML = choicesHtml;
                } else {
                    choicesDisplay.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">ÏÑ†ÌÉùÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>';
                }

                // Ï∂îÍ∞Ä Ï†ïÎ≥¥ ÌëúÏãú
                if (dialogueData.generated_at || dialogueData.source) {
                    const additionalInfo = document.createElement('div');
                    additionalInfo.style.cssText = 'margin-top: 20px; padding: 10px; background: #e9ecef; border-radius: 6px; font-size: 0.85em; color: #6c757d;';
                    additionalInfo.innerHTML = `
                        ${dialogueData.generated_at ? `<div>ÏÉùÏÑ± ÏãúÍ∞Ñ: ${new Date(dialogueData.generated_at).toLocaleString()}</div>` : ''}
                        ${dialogueData.source ? `<div>ÏÉùÏÑ± ÏóîÏßÑ: ${dialogueData.source}</div>` : ''}
                        ${dialogueData.difficulty ? `<div>ÎÇúÏù¥ÎèÑ: ${dialogueData.difficulty}</div>` : ''}
                    `;
                    choicesDisplay.appendChild(additionalInfo);
                }

            } else {
                characterMessage.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 20px; background: #f8d7da; border-radius: 6px;">ÎåÄÌôî Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.</div>';
                narrationDisplay.style.display = 'none';
                choicesDisplay.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">ÎåÄÌôî Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</div>';
            }
        }

        function editDialogueFromPreview() {
            if (currentPreviewDialogueNumber !== null) {
                closeModal('dialoguePreviewModal');
                editDialogue(currentPreviewDialogueNumber);
            }
        }

        function editDialogue(number) {
            const episode = dialogues[number];
            if (!episode) return;
            
            currentMode = 'edit';
            document.getElementById('dialogueModalTitle').textContent = 'ÏóêÌîºÏÜåÎìú ÏàòÏ†ï';
            document.getElementById('dialogueId').value = dialogue.id;
            document.getElementById('dialogueScenarioId').value = dialogue.scenario_id;
            document.getElementById('dialogueNumber').value = dialogue.dialogue_number;
            document.getElementById('characterSelect').value = dialogue.character_id;
            document.getElementById('difficulty').value = dialogue.difficulty;
            document.getElementById('userPrompt').value = dialogue.user_input_prompt;
            
            // AI ÏÉùÏÑ± ÎåÄÌôî ÌëúÏãú
            if (dialogue.ai_generated_dialogue) {
                generatedDialogue = dialogue.ai_generated_dialogue;
                displayDialoguePreview(generatedDialogue);
            }
            
            if (dialogue.custom_dialogue) {
                const custom = JSON.parse(dialogue.custom_dialogue);
                document.getElementById('customDialogue').value = custom.dialogue || '';
                document.getElementById('customNarration').value = custom.narration || '';
            }
            
            document.getElementById('dialogueModal').style.display = 'block';
        }

        async function generateDialogue() {
            const userPrompt = document.getElementById('userPrompt').value;
            const difficulty = document.getElementById('difficulty').value;

            // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§ÏóêÏÑú Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
            const currentScenario = window.scenarios?.[currentScenarioId];
            if (!currentScenario) {
                alert('ÏãúÎÇòÎ¶¨Ïò§ Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. ÏãúÎÇòÎ¶¨Ïò§Î•º Î®ºÏ†Ä ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            const characterId = currentScenario.available_characters?.[0] || currentScenario.character_id;
            const characterName = currentScenario.character_name || characterId;

            if (!userPrompt) {
                alert('ÏÉÅÌô© ÌîÑÎ°¨ÌîÑÌä∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            const previewDiv = document.getElementById('dialoguePreview');
            previewDiv.style.display = 'block';

            document.getElementById('previewDialogue').innerHTML = '<div class="loading"></div> AIÍ∞Ä ÎåÄÌôîÎ•º ÏÉùÏÑ± Ï§ëÏûÖÎãàÎã§...';
            document.getElementById('previewNarration').textContent = '';
            document.getElementById('previewChoices').innerHTML = '';

            try {
                console.log('ü§ñ AI ÎåÄÌôî ÏÉùÏÑ± ÏãúÏûë...');
                console.log(`üéØ Ï∫êÎ¶≠ÌÑ∞: ${characterName} (${characterId})`);
                console.log(`üìù ÌîÑÎ°¨ÌîÑÌä∏: ${userPrompt}`);
                console.log(`‚ö° ÎÇúÏù¥ÎèÑ: ${difficulty}`);

                // Ï±ÑÌåÖ ÌõàÎ†® APIÎ•º ÏÇ¨Ïö©Ìïú ÎåÄÌôî ÏÉùÏÑ±
                generatedDialogue = await generateLocalDialogue(characterId, characterName, userPrompt, difficulty);

                // ÏßßÏùÄ ÏßÄÏó∞ÏúºÎ°ú Î°úÎî© Ìö®Í≥º Ï†úÍ≥µ
                setTimeout(() => {
                    displayDialoguePreview(generatedDialogue);
                    console.log('‚úÖ AI ÎåÄÌôî ÏÉùÏÑ± ÏôÑÎ£å');
                }, 1000);

            } catch (error) {
                console.error('‚ùå ÎåÄÌôî ÏÉùÏÑ± Ïò§Î•ò:', error);

                // ÏóêÎü¨ Î©îÏãúÏßÄ ÌëúÏãú (Ìè¥Î∞± ÎåÄÏã†)
                const errorMessage = `‚ùå AI ÎåÄÌôî ÏÉùÏÑ± Ïã§Ìå®\n\n${error.message}\n\n‚Ä¢ API Ïó∞Í≤∞ ÏÉÅÌÉúÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî\n‚Ä¢ Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî\n‚Ä¢ Î¨∏Ï†úÍ∞Ä ÏßÄÏÜçÎêòÎ©¥ Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Î¨∏ÏùòÌïòÏÑ∏Ïöî`;

                document.getElementById('previewDialogue').innerHTML = `
                    <div class="error-message">
                        <p><strong>‚ùå AI ÎåÄÌôî ÏÉùÏÑ± Ïã§Ìå®</strong></p>
                        <p>${error.message}</p>
                        <ul>
                            <li>API Ïó∞Í≤∞ ÏÉÅÌÉúÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî</li>
                            <li>Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî</li>
                            <li>Î¨∏Ï†úÍ∞Ä ÏßÄÏÜçÎêòÎ©¥ Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Î¨∏ÏùòÌïòÏÑ∏Ïöî</li>
                        </ul>
                    </div>
                `;

                document.getElementById('previewNarration').textContent = '';
                document.getElementById('previewChoices').innerHTML = '';

                // ÌåùÏóÖÏúºÎ°úÎèÑ ÏóêÎü¨ ÏïåÎ¶º
                setTimeout(() => {
                    alert(errorMessage);
                }, 1500);
            }
        }

        function displayDialoguePreview(dialogue) {
            if (!dialogue) return;
            
            document.getElementById('dialoguePreview').style.display = 'block';
            document.getElementById('previewDialogue').textContent = dialogue.dialogue;
            document.getElementById('previewNarration').textContent = dialogue.narration;
            
            const choicesList = document.getElementById('previewChoices');
            choicesList.innerHTML = '';
            
            dialogue.choices.forEach(choice => {
                const li = document.createElement('li');
                li.className = 'choice-item';
                li.innerHTML = `
                    <span>${choice.text}</span>
                    <span class="impact">Ìò∏Í∞êÎèÑ ${choice.affection_impact > 0 ? '+' : ''}${choice.affection_impact}</span>
                `;
                choicesList.appendChild(li);
            });
        }

        async function saveDialogue() {
            // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§ Ï†ïÎ≥¥ ÏÇ¨Ïö©
            const scenarioId = currentScenarioId;
            const dialogueNumber = parseInt(document.getElementById('dialogueNumber').value);
            const difficulty = document.getElementById('difficulty').value;
            const userPrompt = document.getElementById('userPrompt').value;

            if (!scenarioId || !dialogueNumber || !userPrompt) {
                alert('Î™®Îì† ÌïÑÏàò Ìï≠Î™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.\n\n- ÎåÄÌôî Î≤àÌò∏\n- ÎÇúÏù¥ÎèÑ ÏÑ§Ï†ï\n- ÏÉÅÌô© ÌîÑÎ°¨ÌîÑÌä∏');
                return;
            }

            // ÌòÑÏû¨ ÏãúÎÇòÎ¶¨Ïò§ÏóêÏÑú Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
            const currentScenario = window.scenarios?.[scenarioId];
            if (!currentScenario) {
                alert('ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§ Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }

            // ÏãúÎÇòÎ¶¨Ïò§Ïùò Ï≤´ Î≤àÏß∏ Ï∫êÎ¶≠ÌÑ∞ ÏûêÎèô ÏÇ¨Ïö©
            const characterId = currentScenario.available_characters?.[0] || currentScenario.character_id;
            const characterName = currentScenario.character_name || characterId;
            
            const dialogueData = {
                scenario_id: scenarioId,
                dialogue_number: dialogueNumber,
                character_id: characterId,
                character_name: characterName,
                difficulty: difficulty,
                user_input_prompt: userPrompt,
                created_at: new Date().toISOString(),
                id: currentMode === 'create' ? `dialogue_${scenarioId}_${dialogueNumber}_${Date.now()}` : document.getElementById('dialogueId').value
            };
            
            if (currentMode === 'create') {
                dialogueData.action = 'create';
            } else {
                dialogueData.action = 'update';
                dialogueData.id = document.getElementById('dialogueId').value;
            }
            
            // Ïª§Ïä§ÌÖÄ ÎåÄÌôîÍ∞Ä ÏûàÏúºÎ©¥ Ï∂îÍ∞Ä
            const customDialogue = document.getElementById('customDialogue').value;
            const customNarration = document.getElementById('customNarration').value;
            if (customDialogue || customNarration) {
                dialogueData.custom_dialogue = {
                    dialogue: customDialogue,
                    narration: customNarration
                };
            }
            
            // ÏÉùÏÑ±Îêú ÎåÄÌôîÍ∞Ä ÏûàÏúºÎ©¥ Ï∂îÍ∞Ä
            if (generatedDialogue) {
                dialogueData.generated_dialogue = generatedDialogue;
            }
            
            try {
                console.log('üíæ === ÏóêÌîºÏÜåÎìú Ï†ÄÏû• ÏãúÏûë ===');
                console.log('üìä ÏóêÌîºÏÜåÎìú Îç∞Ïù¥ÌÑ∞:', dialogueData);

                // Dialogue Manager API Ìò∏Ï∂ú
                console.log('üîó Dialogue Manager API Ìò∏Ï∂ú...');

                const apiUrl = '/api/dialogue-manager';
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dialogueData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('üìä API ÏùëÎãµ:', result);

                if (result.success) {
                    console.log('‚úÖ Dialogue Manager API Ï†ÄÏû• ÏÑ±Í≥µ!');

                    // ÏÑ±Í≥µ Î©îÏãúÏßÄ
                    const successMessage = currentMode === 'create' ?
                        `üíñ ÏÉàÎ°úÏö¥ ÎåÄÌôî ${dialogueNumber}Î≤àÏù¥ ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!\nÏãúÎÇòÎ¶¨Ïò§: ${window.scenarios?.[scenarioId]?.title || scenarioId}\nÏ∫êÎ¶≠ÌÑ∞: ${characterName}` :
                        `‚ú®ÎåÄÌôî ${dialogueNumber}Î≤àÏù¥ ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§!`;

                    showNotification(successMessage, 'success');
                    closeModal('dialogueModal');

                    // UI ÏµúÏ¢Ö ÏóÖÎç∞Ïù¥Ìä∏
                    console.log('üîÑ Ï†ÄÏû• ÌõÑ ÏµúÏ¢Ö UI ÎèôÍ∏∞Ìôî...');
                    await loadDialogues(); // ÏóêÌîºÏÜåÎìú Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                    await loadTotalEpisodeCount(); // Ï†ÑÏ≤¥ ÏóêÌîºÏÜåÎìú Ïπ¥Ïö¥Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
                    updateScenarioStats();
                } else {
                    throw new Error(result.message || 'API ÏùëÎãµÏóêÏÑú success: false');
                }

                console.log('‚úÖ ÏóêÌîºÏÜåÎìú Ï†ÄÏû• ÌîÑÎ°úÏÑ∏Ïä§ ÏôÑÎ£å!');

            } catch (error) {
                await ErrorLogger.error('Episode Save Failed', error, {
                    action: 'save_episode',
                    component: 'dialogue_manager',
                    data: {
                        scenarioId: currentScenarioId,
                        dialogueNumber: document.getElementById('dialogueNumber').value,
                        difficulty: document.getElementById('difficulty').value
                    }
                });
                alert('ÎåÄÌôî Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
            }
        }

        async function generateBulkDialogues() {
            console.log('üöÄ ÎåÄÌôî ÏùºÍ¥Ñ ÏÉùÏÑ± ÏãúÏûë...');

            // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§ ÌôïÏù∏
            if (!currentScenarioId) {
                alert('Î®ºÏ†Ä ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.\n\nÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ùÏóêÏÑú ÏãúÎÇòÎ¶¨Ïò§Î•º ÌÅ¥Î¶≠ÌïòÍ±∞ÎÇò,\n"ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉù" ÎìúÎ°≠Îã§Ïö¥ÏóêÏÑú ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            // ÏãúÎÇòÎ¶¨Ïò§ Ï†ïÎ≥¥ Ï°∞Ìöå (window.scenarios ÎòêÎäî Ï†ÑÏó≠ scenarios ÏÇ¨Ïö©)
            const scenariosData = window.scenarios || scenarios || {};
            const selectedScenario = scenariosData[currentScenarioId];

            console.log('üîç ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ ÏÜåÏä§:', window.scenarios ? 'window.scenarios' : 'scenarios');
            console.log('üîç Ï†ÑÏ≤¥ ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù:', Object.keys(scenariosData));
            console.log('üîç Ï∞æÎäî ÏãúÎÇòÎ¶¨Ïò§ ID:', currentScenarioId);
            console.log('üîç Ï∞æÏùÄ ÏãúÎÇòÎ¶¨Ïò§:', selectedScenario);

            if (!selectedScenario) {
                alert(`ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§ Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.\n\nÏãúÎÇòÎ¶¨Ïò§ ID: ${currentScenarioId}\nÏÇ¨Ïö© Í∞ÄÎä•Ìïú ÏãúÎÇòÎ¶¨Ïò§: ${Object.keys(scenariosData).join(', ')}`);
                return;
            }

            console.log('‚úÖ ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§:', selectedScenario.title);

            // ÏãúÎÇòÎ¶¨Ïò§Ïóê Ïó∞Í≤∞Îêú Ï∫êÎ¶≠ÌÑ∞ ÏûêÎèô ÏÇ¨Ïö©
            const characterId = selectedScenario.available_characters?.[0] || selectedScenario.character_id;

            // Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥ Ï°∞Ìöå (window.characters ÎòêÎäî Ï†ÑÏó≠ characters ÏÇ¨Ïö©)
            const charactersData = window.characters || characters || {};
            const character = charactersData[characterId];

            console.log('üîç Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ ÏÜåÏä§:', window.characters ? 'window.characters' : 'characters');
            console.log('üîç Ï∞æÎäî Ï∫êÎ¶≠ÌÑ∞ ID:', characterId);
            console.log('üîç Ï†ÑÏ≤¥ Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù:', Object.keys(charactersData));
            console.log('üîç Ï∞æÏùÄ Ï∫êÎ¶≠ÌÑ∞:', character);

            if (!character) {
                alert(`ÏãúÎÇòÎ¶¨Ïò§Ïóê Ïó∞Í≤∞Îêú Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.\n\nÏ∫êÎ¶≠ÌÑ∞ ID: ${characterId}\nÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ï∫êÎ¶≠ÌÑ∞: ${Object.keys(charactersData).join(', ')}`);
                return;
            }

            console.log('‚úÖ ÏûêÎèô ÏÑ†ÌÉùÎêú Ï∫êÎ¶≠ÌÑ∞:', character.name);
            
            // 3. ÏóêÌîºÏÜåÎìú Î≤îÏúÑ ÏÑ†ÌÉù
            const startNum = parseInt(prompt('ÏãúÏûë ÎåÄÌôî Î≤àÌò∏ (1-36):'));
            const endNum = parseInt(prompt('Ï¢ÖÎ£å ÎåÄÌôî Î≤àÌò∏ (1-36):'));
            
            if (!startNum || !endNum || startNum < 1 || endNum > 36 || startNum > endNum) {
                alert('Ïò¨Î∞îÎ•∏ Î≤îÏúÑÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî. (1-36, ÏãúÏûëÎ≤àÌò∏ ‚â§ Ï¢ÖÎ£åÎ≤àÌò∏)');
                return;
            }
            
            const dialogueCount = endNum - startNum + 1;
            
            // 4. ÌôïÏù∏ Î∞è ÏÉùÏÑ±
            if (confirm(`üìã ÏùºÍ¥Ñ ÏÉùÏÑ± ÏÑ§Ï†ï:\n\nÏãúÎÇòÎ¶¨Ïò§: ${selectedScenario.title}\nÏ∫êÎ¶≠ÌÑ∞: ${character.name} (${character.mbti})\nÎ≤îÏúÑ: ${startNum}Î≤à ~ ${endNum}Î≤à (Ï¥ù ${dialogueCount}Í∞ú)\n\n‚ö†Ô∏è Ï£ºÏùò: AI API Ïó∞Í≤∞Ïù¥ Ïã§Ìå®ÌïòÎ©¥ Ï†ÑÏ≤¥ ÏÉùÏÑ±Ïù¥ Ï§ëÎã®Îê©ÎãàÎã§.\n\nÏÉùÏÑ±ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                
                console.log('üîÑ ÎåÄÌôî ÏùºÍ¥Ñ ÏÉùÏÑ± ÏßÑÌñâ...');
                let successCount = 0;
                let failCount = 0;
                
                for (let dialogueNum = startNum; dialogueNum <= endNum; dialogueNum++) {
                    try {
                        // Í∞Å ÏóêÌîºÏÜåÎìúÎ≥Ñ ÏÉÅÌô© ÌîÑÎ°¨ÌîÑÌä∏ ÏûêÎèô ÏÉùÏÑ±
                        const situationPrompts = [
                            "Ïö∞Ïó∞Ìûà ÎßàÏ£ºÏπú ÏÉÅÌô©ÏóêÏÑú ÏÑúÎ°úÎ•º ÏùòÏãùÌïòÎ©∞",
                            "Ìï®Íªò Í≥ºÏ†úÎ•º ÌïòÎ©¥ÏÑú Í∞ÄÍπåÏõåÏßÄÎäî ÏàúÍ∞Ñ",
                            "ÎπÑ ÎÇ¥Î¶¨Îäî ÎÇ† Í∞ôÏùÄ Ïö∞ÏÇ∞ÏùÑ Ïì∞Í≤å ÎêòÏñ¥",
                            "Ï∂ïÏ†úÏóêÏÑú Ìï®Íªò Ï¶êÍ±∞Ïö¥ ÏãúÍ∞ÑÏùÑ Î≥¥ÎÇ¥Î©∞",
                            "Ï°∞Ïö©Ìïú ÎèÑÏÑúÍ¥ÄÏóêÏÑú ÎààÏù¥ ÎßàÏ£ºÏ≥ê",
                            "Ïπ¥ÌéòÏóêÏÑú Ïö∞Ïó∞Ìûà ÎßåÎÇò ÎåÄÌôîÌïòÎ©∞",
                            "Î∞©Í≥ºÌõÑ ÍµêÏã§ÏóêÏÑú ÎëòÎßå ÎÇ®Í≤å ÎêòÏñ¥",
                            "ÏÇ∞Ï±ÖÌïòÎ©∞ ÏßÑÏÜîÌïú ÎåÄÌôîÎ•º ÎÇòÎàÑÎäî",
                            "ÌïôÍµê Ïò•ÏÉÅÏóêÏÑú Î∞îÎùºÎ≥∏ ÌïòÎäòÏ≤òÎüº Ï≤≠ÎüâÌïú",
                            "Ï∂îÏö¥ Í≤®Ïö∏ Îî∞ÎúªÌïú ÎßàÏùåÏùÑ ÎÇòÎàÑÎäî"
                        ];
                        
                        const promptIndex = (dialogueNum - 1) % situationPrompts.length;
                        const userPrompt = situationPrompts[promptIndex];
                        
                        // ÎÇúÏù¥ÎèÑ ÏÑ§Ï†ï (1-9: Easy, 10-18: Medium, 19-27: Hard, 28-36: Expert)
                        let difficulty = 'Easy';
                        if (dialogueNum >= 10 && dialogueNum <= 18) difficulty = 'Medium';
                        else if (dialogueNum >= 19 && dialogueNum <= 27) difficulty = 'Hard';
                        else if (dialogueNum >= 28 && dialogueNum <= 36) difficulty = 'Expert';
                        
                        // OpenAI API Rate Limiting Î∞©ÏßÄÎ•º ÏúÑÌïú ÏßÄÏó∞ (2Î≤àÏß∏ ÏöîÏ≤≠Î∂ÄÌÑ∞)
                        if (dialogueNum > startNum) {
                            console.log(`‚è≥ Rate Limiting Î∞©ÏßÄ ÎåÄÍ∏∞ Ï§ë... (${dialogueNum}Î≤àÏß∏ ÏöîÏ≤≠)`);
                            await new Promise(resolve => setTimeout(resolve, 2000)); // 2Ï¥à ÎåÄÍ∏∞
                        }

                        // Ï±ÑÌåÖ ÌõàÎ†® APIÎ•º ÏÇ¨Ïö©Ìïú ÎåÄÌôî ÏÉùÏÑ± (Ìè¥Î∞± ÏóÜÏùå)
                        console.log(`üéØ ÎåÄÌôî ${dialogueNum}Î≤à ÏÉùÏÑ± ÏãúÏûë...`);
                        const generatedDialogue = await generateLocalDialogue(characterId, character.name, userPrompt, difficulty);
                        
                        // ÏóêÌîºÏÜåÎìú Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
                        const dialogueData = {
                            dialogue_number: dialogueNum,
                            scenario_id: currentScenarioId,
                            character_id: characterId,
                            character_name: character.name,
                            user_input_prompt: userPrompt,
                            difficulty: difficulty,
                            ai_generated_dialogue: generatedDialogue,
                            generated_dialogue: generatedDialogue,
                            created_at: new Date().toISOString()
                        };
                        
                        // Dialogue Manager API Ìò∏Ï∂ú
                        const response = await fetch('/api/dialogue-manager', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                ...dialogueData,
                                action: 'create'
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`API Ìò∏Ï∂ú Ïã§Ìå®: ${response.status}`);
                        }

                        const result = await response.json();
                        if (!result.success) {
                            throw new Error(result.message || 'API Ï†ÄÏû• Ïã§Ìå®');
                        }
                        
                        successCount++;
                        console.log(`‚úÖ ÎåÄÌôî ${dialogueNum}Î≤à ÏÉùÏÑ± ÏôÑÎ£å`);
                        
                    } catch (error) {
                        console.error(`‚ùå ÎåÄÌôî ${dialogueNum}Î≤à ÏÉùÏÑ± Ïã§Ìå®:`, error);

                        // AI API ÏóêÎü¨ Ïãú Ï¶âÏãú Ï§ëÎã®ÌïòÍ≥† ÏÇ¨Ïö©ÏûêÏóêÍ≤å ÏïåÎ¶º
                        const errorMessage = `‚ùå AI ÎåÄÌôî ÏÉùÏÑ± Ïã§Ìå®\n\nÎåÄÌôî ${dialogueNum}Î≤àÏóêÏÑú Ïò§Î•ò Î∞úÏÉù:\n${error.message}\n\nÏÑ±Í≥µ: ${successCount}Í∞ú\nÏã§Ìå®: ${dialogueNum - startNum + 1}Î≤àÎ∂ÄÌÑ∞ Ï§ëÎã®\n\nÌï¥Í≤∞ Î∞©Î≤ï:\n1. OpenAI API ÌÇ§ ÌôòÍ≤ΩÎ≥ÄÏàò ÌôïÏù∏\n2. Vercel ÎåÄÏãúÎ≥¥ÎìúÏóêÏÑú ÌôòÍ≤ΩÎ≥ÄÏàò ÏÑ§Ï†ï\n3. API ÌÅ¨Î†àÎîß ÏûîÏï° ÌôïÏù∏\n4. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑ`;

                        alert(errorMessage);

                        // Ï¶âÏãú Ï§ëÎã®
                        return;
                    }
                }

                // Î™®Îì† ÏóêÌîºÏÜåÎìú ÏÑ±Í≥µ ÏãúÏóêÎßå ÌëúÏãú
                alert(`üéâ ÏùºÍ¥Ñ ÏÉùÏÑ± ÏôÑÎ£å!\n\n‚úÖ ÏÑ±Í≥µ: ${successCount}Í∞ú ÎåÄÌôî ÏÉùÏÑ±\n\nÎåÄÌôî Î™©Î°ùÏùÑ ÏÉàÎ°úÍ≥†Ïπ®Ìï©ÎãàÎã§.`);
                
                // UI ÏóÖÎç∞Ïù¥Ìä∏ (currentScenarioIdÎäî Ïù¥ÎØ∏ ÏÑ§Ï†ïÎêòÏñ¥ ÏûàÏùå)
                loadDialogues();
                loadTotalEpisodeCount(); // Ï†ÑÏ≤¥ ÏóêÌîºÏÜåÎìú Ïπ¥Ïö¥Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
            }
        }

        // === Ï∫êÎ¶≠ÌÑ∞ Í¥ÄÎ¶¨ Ìï®ÏàòÎì§ ===
        // üöÄ GitHub API Ïö∞ÏÑ† Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú (ÌòÅÏã†Ï†Å Ìï¥Í≤∞Ï±Ö!)
        async function loadCharacters() {
            console.log('üì• === Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú ÏãúÏûë (GitHub API Ïö∞ÏÑ†) ===');
            console.log('üïí Î°úÎìú ÏãúÍ∞Ñ:', new Date().toISOString());
            
            // 1ÏàúÏúÑ: GitHub APIÏóêÏÑú Î°úÎìú (ÏµúÏã† ÏòÅÍµ¨ Îç∞Ïù¥ÌÑ∞)
            try {
                console.log('üêô GitHub APIÏóêÏÑú Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú...');
                
                // GitHub ÌÜ†ÌÅ∞ÏùÄ ÏÑúÎ≤ÑÏÇ¨Ïù¥ÎìúÏóêÏÑú ÌôòÍ≤ΩÎ≥ÄÏàòÎ°ú Ï≤òÎ¶¨
                console.log('üîê GitHub ÌÜ†ÌÅ∞ÏùÄ ÏÑúÎ≤ÑÏóêÏÑú ÏûêÎèô Í¥ÄÎ¶¨Îê®');
                
                // APIÎ•º ÌÜµÌï¥ GitHub Îç∞Ïù¥ÌÑ∞ Î°úÎìú (ÌÜ†ÌÅ∞ÏùÄ ÏÑúÎ≤ÑÏóêÏÑú Ï≤òÎ¶¨)
                const apiResponse = await fetch('/api/character-ai-generator?action=list_characters');
                if (apiResponse.ok) {
                    const apiData = await apiResponse.json();
                    const gitHubCharacters = apiData.characters || {};
                    const characterCount = Object.keys(gitHubCharacters).length;
                    console.log('üìä GitHub Ï∫êÎ¶≠ÌÑ∞ Ïàò:', characterCount);
                    
                    if (characterCount > 0) {
                        characters = gitHubCharacters;
                        
                        // GitHub Îç∞Ïù¥ÌÑ∞Î•º Î°úÏª¨ÏóêÎèÑ Î∞±ÏóÖ
                        localStorage.setItem('chatgame_characters', JSON.stringify(characters));
                        
                        console.log('‚úÖ GitHub APIÏóêÏÑú Î°úÎìú ÏôÑÎ£å. Ï∫êÎ¶≠ÌÑ∞ IDÎì§:', Object.keys(characters));
                        displayCharacters();
                        updateCharacterStats();
                        console.log('üéâ === Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú ÏôÑÎ£å (GitHub API) ===');
                        return;
                    } else {
                        console.log('üì≠ GitHubÏóê Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå');
                    }
                } else {
                    console.log('üîê GitHub ÌÜ†ÌÅ∞ ÏóÜÏùå, Îã§Î•∏ Î∞©Î≤ï ÏãúÎèÑ...');
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è GitHub API Î°úÎìú Ïã§Ìå®:', error);
            }
            
            // 2ÏàúÏúÑ: Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú Î°úÎìú (Î∞±ÏóÖ)
            try {
                console.log('üíæ Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú Ï∫êÎ¶≠ÌÑ∞ Î∞±ÏóÖ Î°úÎìú...');
                const localData = localStorage.getItem('chatgame_characters');
                
                if (localData) {
                    const localCharacters = JSON.parse(localData);
                    const characterCount = Object.keys(localCharacters).length;
                    console.log('üìä Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ Î∞±ÏóÖ Ï∫êÎ¶≠ÌÑ∞ Ïàò:', characterCount);
                    
                    if (characterCount > 0) {
                        characters = localCharacters;
                        console.log('‚úÖ Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ Î∞±ÏóÖÏóêÏÑú Î°úÎìú ÏôÑÎ£å. Ï∫êÎ¶≠ÌÑ∞ IDÎì§:', Object.keys(characters));
                        displayCharacters();
                        updateCharacterStats();
                        console.log('üéâ === Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú ÏôÑÎ£å (Î°úÏª¨ Î∞±ÏóÖ) ===');
                        return;
                    }
                }
            } catch (error) {
                console.error('‚ùå Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ Î°úÎìú ÏòàÏô∏:', error);
            }
            
            // 3ÏàúÏúÑ: AI APIÏóêÏÑú Î°úÎìú
            try {
                console.log('ü§ñ AI Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±Í∏∞ API Î°úÎìú...');
                console.log('ü§ñ AI Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±Í∏∞ API Ìò∏Ï∂ú...');
                const aiResponse = await fetch('/api/character-ai-generator?action=list_characters&_t=' + Date.now());
                
                console.log('üì∂ AI API ÏùëÎãµ ÏÉÅÌÉú:', aiResponse.status);
                
                if (aiResponse.ok) {
                    const aiData = await aiResponse.json();
                    console.log('ü§ñ AI API ÏõêÏãú ÏùëÎãµ:', JSON.stringify(aiData, null, 2));
                    
                    if (aiData.success && aiData.characters) {
                        const characterCount = Object.keys(aiData.characters).length;
                        console.log('üìä AI API Ï∫êÎ¶≠ÌÑ∞ Ïàò:', characterCount);
                        
                        if (characterCount > 0) {
                            characters = aiData.characters;
                            console.log('‚úÖ AI APIÏóêÏÑú Î°úÎìú ÏôÑÎ£å. Ï∫êÎ¶≠ÌÑ∞ IDÎì§:', Object.keys(characters));
                            displayCharacters();
                            updateCharacterStats();
                            console.log('üéâ === Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú ÏôÑÎ£å (AI API) ===');
                            return;
                        } else {
                            console.log('üòµ AI APIÏóêÏÑú Îπà Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù Î∞òÌôò');
                        }
                    } else {
                        console.log('üòµ AI API ÏùëÎãµÏù¥ ÎπÑÏ†ïÏÉÅ:', aiData);
                    }
                } else {
                    console.log('‚ùå AI API HTTP Ïò§Î•ò:', aiResponse.status);
                }
            } catch (error) {
                console.error('‚ùå AI API ÏòàÏô∏:', error);
            }
            
            try {
                // Í∏∞Î≥∏ characters.json ÏãúÎèÑ
                console.log('üìÅ Í∏∞Î≥∏ characters.json ÌååÏùº Î°úÎìú...');
                const response = await fetch('/data/characters.json?_t=' + Date.now());
                
                console.log('üì∂ Í∏∞Î≥∏ ÌååÏùº ÏùëÎãµ ÏÉÅÌÉú:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('üìÅ Í∏∞Î≥∏ ÌååÏùº ÏõêÏãú Îç∞Ïù¥ÌÑ∞:', JSON.stringify(data, null, 2));
                    
                    if (data.characters && Array.isArray(data.characters)) {
                        // Array ÌòïÌÉúÎ•º Object ÌòïÌÉúÎ°ú Î≥ÄÌôò
                        characters = {};
                        data.characters.forEach(char => {
                            characters[char.id] = char;
                        });
                        const characterCount = Object.keys(characters).length;
                        console.log('‚úÖ Í∏∞Î≥∏ ÌååÏùºÏóêÏÑú Î°úÎìúÎêú Ï∫êÎ¶≠ÌÑ∞ Ïàò:', characterCount);
                        
                        if (characterCount > 0) {
                            console.log('‚úÖ Ï∫êÎ¶≠ÌÑ∞ IDÎì§:', Object.keys(characters));
                        }
                        
                        displayCharacters();
                        updateCharacterStats();
                        console.log('üéâ === Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú ÏôÑÎ£å (Í∏∞Î≥∏ ÌååÏùº) ===');
                        return;
                    } else {
                        console.log('üòµ Í∏∞Î≥∏ ÌååÏùºÏùò characters ÌïÑÎìúÍ∞Ä ÎπÑÏñ¥ÏûàÍ±∞ÎÇò ÎπÑÏ†ïÏÉÅ');
                    }
                } else {
                    console.log('‚ùå Í∏∞Î≥∏ ÌååÏùº HTTP Ïò§Î•ò:', response.status);
                }
            } catch (error) {
                console.error('‚ùå Í∏∞Î≥∏ ÌååÏùº ÏòàÏô∏:', error);
            }
            
            // Î™®Îì† Î∞©Î≤ïÏù¥ Ïã§Ìå®ÌïòÎ©¥ Îπà Îç∞Ïù¥ÌÑ∞Î°ú Ï¥àÍ∏∞Ìôî
            console.log('‚ö†Ô∏è === Î™®Îì† Î°úÎìú Î∞©Î≤ï Ïã§Ìå®, Îπà Îç∞Ïù¥ÌÑ∞Î°ú Ï¥àÍ∏∞Ìôî ===');
            characters = {};
            displayCharacters();
            updateCharacterStats();
            console.log('üéâ === Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú ÏôÑÎ£å (Îπà Îç∞Ïù¥ÌÑ∞) ===');
        }

        // Í∏∞Î≥∏ Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú (fallback)
        // ÏÇ¨Ïö©ÌïòÏßÄ ÏïäÏùÑ ÏòàÏ†ïÏù¥ÎØÄÎ°ú Ï£ºÏÑù Ï≤òÎ¶¨
        // function loadDefaultCharacters() { ... }







        // === ÎçîÎØ∏ Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú Í∏∞Îä• ===
        async function resetAllCharacters() {
            if (!confirm('‚ö†Ô∏è Ï£ºÏùò: Î™®Îì† Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏòÅÍµ¨Ï†ÅÏúºÎ°ú ÏÇ≠Ï†úÎê©ÎãàÎã§.\n\nÏ†ïÎßêÎ°ú Í≥ÑÏÜçÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                return;
            }
            
            if (!confirm('Ìïú Î≤à Îçî ÌôïÏù∏Ìï©ÎãàÎã§. Î™®Îì† Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏôÑÏ†ÑÌûà ÏÇ≠Ï†úÎê©ÎãàÎã§!')) {
                return;
            }
            
            try {
                console.log('üóëÔ∏è Î™®Îì† Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú ÏãúÏûë...');
                
                const response = await fetch('/api/character-ai-generator', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'reset_all_characters'
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert('‚úÖ Î™®Îì† Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                        
                        // Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                        setTimeout(() => {
                            loadCharacters();
                        }, 500);
                    } else {
                        throw new Error(result.message || 'ÏÇ≠Ï†ú Ïã§Ìå®');
                    }
                } else {
                    throw new Error('ÏÑúÎ≤Ñ Ïò§Î•ò: ' + response.status);
                }
                
            } catch (error) {
                console.error('‚ùå Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú Ïò§Î•ò:', error);
                alert('Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
            }
        }

        window.displayCharacters = function displayCharacters() {
            console.log('üé® === Ï∫êÎ¶≠ÌÑ∞ ÌëúÏãú Ìï®Ïàò ÏãúÏûë ===');
            console.log('üîç Ï†ÑÏó≠ characters Î≥ÄÏàò ÌôïÏù∏:', typeof characters, characters);
            console.log('üîç window.characters ÌôïÏù∏:', typeof window.characters, window.characters);

            const container = document.getElementById('charactersContainer');
            if (!container) {
                console.error('‚ùå charactersContainer ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå!');
                return;
            }

            const characterArray = Object.values(characters || {});
            console.log('üìä ÌëúÏãúÌï† Ï∫êÎ¶≠ÌÑ∞ Ïàò:', characterArray.length);
            console.log('üìã Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù:', characterArray.map(c => `${c?.name || 'NO_NAME'} (${c?.id || 'NO_ID'})`));
            
            if (characterArray.length === 0) {
                console.log('üì≠ Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÏóÜÏùå - Îπà ÏÉÅÌÉú Î©îÏãúÏßÄ ÌëúÏãú');
                container.innerHTML = `
                    <div class="empty-state">
                        <p>üé≠ ÏÉùÏÑ±Îêú Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</p>
                        <p><small>ÏúÑÏùò "üé≠‚ú® AI Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±Í∏∞" Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ ÏÉàÎ°úÏö¥ Ï∫êÎ¶≠ÌÑ∞Î•º ÎßåÎì§Ïñ¥Î≥¥ÏÑ∏Ïöî!</small></p>
                        <button class="btn btn-primary" onclick="openCharacterModal('create')" style="margin-top: 10px;">
                            ‚ú® ÏßÄÍ∏à Ï∫êÎ¶≠ÌÑ∞ ÎßåÎì§Í∏∞
                        </button>
                    </div>
                `;
                return;
            }

            console.log('üé® Ï∫êÎ¶≠ÌÑ∞ Ïπ¥Îìú HTML ÏÉùÏÑ± Ï§ë...');
            container.innerHTML = characterArray.map(character => `
                <div class="character-card">
                    <div class="character-image">
                        ${character.image ?
                            `<img src="${character.image}" alt="${character.name}" onerror="this.src='data:image/svg+xml,<svg xmlns=\\"http://www.w3.org/2000/svg\\" viewBox=\\"0 0 100 100\\"><rect width=\\"100\\" height=\\"100\\" fill=\\"%23f0f0f0\\"/><text x=\\"50\\" y=\\"50\\" text-anchor=\\"middle\\" dy=\\".3em\\" fill=\\"%23999\\">${character.name.charAt(0)}</text></svg>'"/>` :
                            `<div class="no-image">${character.name.charAt(0)}</div>`
                        }
                    </div>
                    <div class="character-info">
                        <div class="mbti">${character.mbti}</div>
                        <h3>${character.name}</h3>
                        <p class="traits">${character.personality_traits || character.personality || 'ÌäπÏÑ± Ï†ïÎ≥¥ ÏóÜÏùå'}</p>
                        <p style="font-size: 0.9em; color: #95a5a6; margin-bottom: 15px;">${character.speech_style || 'ÎßêÌà¨ Ï†ïÎ≥¥ ÏóÜÏùå'}</p>
                        <div class="actions">
                            <button class="btn btn-success" onclick="editCharacter('${character.id}')">ÏàòÏ†ï</button>
                            <button class="btn btn-danger" onclick="deleteCharacter('${character.id}')">ÏÇ≠Ï†ú</button>
                        </div>
                    </div>
                </div>
            `).join('');
            console.log('‚úÖ Ï∫êÎ¶≠ÌÑ∞ Ïπ¥Îìú HTML ÏÉùÏÑ± ÏôÑÎ£å');
        }

        function updateCharacterStats() {
            console.log('üìä Ï∫êÎ¶≠ÌÑ∞ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÏûë...');
            
            const characterArray = Object.values(characters);
            console.log('üìä Ï∫êÎ¶≠ÌÑ∞ Î∞∞Ïó¥:', characterArray.length, 'Í∞ú');
            
            // ÏïàÏ†ÑÌïú ÏöîÏÜå ÏóÖÎç∞Ïù¥Ìä∏ (ÏöîÏÜåÍ∞Ä ÏóÜÏúºÎ©¥ Î¨¥Ïãú)
            const safeUpdateElement = (id, value) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                    console.log(`‚úÖ ${id}: ${value}`);
                } else {
                    console.warn(`‚ö†Ô∏è ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå: ${id}`);
                }
            };
            
            // Ï∫êÎ¶≠ÌÑ∞ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
            safeUpdateElement('totalCharacters', characterArray.length);
            safeUpdateElement('activeCharacters', characterArray.filter(c => c.active !== false).length);
            safeUpdateElement('characterCount', characterArray.length);
            
            // AI ÏÉùÏÑ± Ï∫êÎ¶≠ÌÑ∞ Í∞úÏàò
            const aiGeneratedCharacters = characterArray.filter(c => c.source === 'ai_generator' || c.created_by === 'ai').length;
            safeUpdateElement('aiGeneratedCharacters', aiGeneratedCharacters);
            
            // ÌèâÍ∑† Ìò∏Í∞êÎèÑ (ÏòàÏãúÏö©)
            const avgAffection = characterArray.length > 0 
                ? Math.round(characterArray.reduce((sum, c) => sum + (c.initial_affection || 0), 0) / characterArray.length)
                : 0;
            safeUpdateElement('avgCharacterAffection', avgAffection);
            
            console.log('‚úÖ Ï∫êÎ¶≠ÌÑ∞ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£º');
        }

        function openCharacterModal(mode) {
            currentMode = mode;

            // üé≠ ÏÉà Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ± ÏãúÏóêÎäî ÏöîÏïΩ ÏÑπÏÖò Ïà®Í∏∞Í∏∞
            const summarySection = document.getElementById('characterSummarySection');
            if (summarySection) {
                summarySection.style.display = 'none';
                console.log('‚úÖ ÏöîÏïΩ ÏÑπÏÖò Ïà®ÍπÄ (ÏÉà Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ± Î™®Îìú)');
            }

            // Î™®Îã¨ Ï†úÎ™© ÏõêÎûòÎåÄÎ°ú Î≥µÏõê
            document.getElementById('characterModalTitle').textContent = 'üé≠‚ú® ÏÑ∏Í≥ÑÍ¥Ä ÏµúÍ∞ï AI Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±Í∏∞';

            document.getElementById('characterForm').reset();

            // Î™®Îì† ÏÑ†ÌÉù Î≤ÑÌäºÎì§ Ï¥àÍ∏∞Ìôî
            document.querySelectorAll('.mbti-btn.selected, .trait-btn.selected, .relationship-btn.selected, .hobby-btn.selected, .speech-btn.selected').forEach(btn => {
                btn.classList.remove('selected');
            });

            // Ïà®Í≤®ÏßÑ ÌïÑÎìúÎì§ Ï¥àÍ∏∞Ìôî
            document.getElementById('charMbti').value = '';
            document.getElementById('charRelationship').value = '';
            document.getElementById('charSpeechStyle').value = '';

            // AI ÏÉùÏÑ± ÏòÅÏó≠ Ï¥àÍ∏∞Ìôî
            generatedCharacter = null; // Í∏ÄÎ°úÎ≤å Î≥ÄÏàòÎèÑ Ï¥àÍ∏∞Ìôî
            document.getElementById('aiGenerationStatus').innerHTML = '';
            document.getElementById('characterPreview').style.display = 'none';
            
            document.getElementById('characterModal').style.display = 'block';
        }

        function editCharacter(characterId) {
            const character = characters[characterId];
            if (!character) {
                console.error('Ï∫êÎ¶≠ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§:', characterId);
                return;
            }

            console.log('‚úèÔ∏è Ï∫êÎ¶≠ÌÑ∞ Ìé∏Ïßë ÏãúÏûë:', character.name);
            currentMode = 'edit';

            // ÏïàÏ†ÑÌïú ÏöîÏÜå ÏÑ§Ï†ï Ìï®Ïàò
            const safeSetValue = (elementId, value) => {
                const element = document.getElementById(elementId);
                if (element && value !== undefined && value !== null) {
                    element.value = value;
                    console.log(`‚úÖ ${elementId} Í∞í ÏÑ§Ï†ï:`, value);
                } else if (!element) {
                    console.warn(`‚ö†Ô∏è ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå: ${elementId}`);
                } else {
                    console.log(`‚ö†Ô∏è ${elementId}Ïóê ÏÑ§Ï†ïÌï† Í∞íÏù¥ ÏóÜÏùå`);
                }
            };

            // üé≠ Ï∫êÎ¶≠ÌÑ∞ ÏöîÏïΩ ÏÑπÏÖò ÌëúÏãú Î∞è Îç∞Ïù¥ÌÑ∞ Ï±ÑÏö∞Í∏∞
            const summarySection = document.getElementById('characterSummarySection');
            if (summarySection) {
                summarySection.style.display = 'block';

                // ÏöîÏïΩ Ï†ïÎ≥¥ Ï±ÑÏö∞Í∏∞
                document.getElementById('summaryName').textContent = character.name || '-';
                document.getElementById('summaryAge').textContent = character.age ? `${character.age}ÏÑ∏` : '-';
                document.getElementById('summaryMbti').textContent = character.mbti || '-';
                document.getElementById('summaryGender').textContent = character.gender === 'female' ? 'Ïó¨ÏÑ±' : character.gender === 'male' ? 'ÎÇ®ÏÑ±' : '-';

                // ÏÑ±Í≤©ÌäπÏÑ±
                const personalityText = Array.isArray(character.personality_traits) && character.personality_traits.length > 0
                    ? character.personality_traits.join(', ')
                    : '-';
                document.getElementById('summaryPersonality').textContent = personalityText;

                // Ï∑®ÎØ∏
                const hobbiesText = Array.isArray(character.hobbies) && character.hobbies.length > 0
                    ? character.hobbies.join(', ')
                    : '-';
                document.getElementById('summaryHobbies').textContent = hobbiesText;

                // Ïô∏Î™® (hair, eyes, style)
                const appearanceText = character.appearance
                    ? `${character.appearance.hair || ''} / ${character.appearance.eyes || ''} / ${character.appearance.style || ''}`.replace(/\s*\/\s*$/g, '').replace(/^\s*\/\s*/g, '')
                    : '-';
                document.getElementById('summaryAppearance').textContent = appearanceText || '-';

                // Î∞∞Í≤Ω (family, hometown)
                const backgroundText = `${character.family || character.background?.family || ''} / ${character.hometown || character.background?.hometown || ''}`.replace(/\s*\/\s*$/g, '').replace(/^\s*\/\s*/g, '');
                document.getElementById('summaryBackground').textContent = backgroundText || '-';

                // ÎßêÌà¨
                document.getElementById('summarySpeechStyle').textContent = character.speech_style || '-';

                console.log('‚úÖ Ï∫êÎ¶≠ÌÑ∞ ÏöîÏïΩ Ï†ïÎ≥¥ ÌëúÏãú ÏôÑÎ£å');
            }

            // Î™®Îã¨ Ï†úÎ™© ÏÑ§Ï†ï
            safeSetValue('characterModalTitle', ''); // textContentÎ°ú Îî∞Î°ú ÏÑ§Ï†ï
            document.getElementById('characterModalTitle').textContent = `üé≠ Ï∫êÎ¶≠ÌÑ∞ ÏàòÏ†ï: ${character.name}`;
            
            // Í∏∞Î≥∏ ÌïÑÎìúÎì§ ÏÑ§Ï†ï
            safeSetValue('characterId', characterId);
            safeSetValue('charName', character.name);
            safeSetValue('charMbti', character.mbti);
            safeSetValue('charAge', character.age);
            safeSetValue('charType', character.character_type);
            safeSetValue('charMajor', character.major);
            safeSetValue('charFamily', character.family);
            safeSetValue('charHometown', character.hometown);
            safeSetValue('charRelationship', character.relationship);
            safeSetValue('charHair', character.appearance?.hair);
            safeSetValue('charEyes', character.appearance?.eyes);
            safeSetValue('charBody', character.appearance?.body);
            safeSetValue('charStyle', character.appearance?.style);
            safeSetValue('charValues', character.values);
            safeSetValue('charSpeechStyle', character.speech_style);
            safeSetValue('charSpeechHabit', character.speech_habit);
            // charGenre ÌïÑÎìú Ï†úÍ±∞Îê®
            // charMainSituation ÌïÑÎìú Ï†úÍ±∞Îê®

            // üéØ Ï≤¥ÌÅ¨Î∞ïÏä§ ÏÑ†ÌÉù Î≥µÏõê (ÏÑ±Í≤©ÌäπÏÑ±, Ï∑®ÎØ∏)
            if (Array.isArray(character.personality_traits)) {
                character.personality_traits.forEach(trait => {
                    const checkbox = document.querySelector(`input[name="personality"][value="${trait}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        console.log(`‚úÖ ÏÑ±Í≤©ÌäπÏÑ± Ï≤¥ÌÅ¨: ${trait}`);
                    }
                });
            }

            if (Array.isArray(character.hobbies)) {
                character.hobbies.forEach(hobby => {
                    const checkbox = document.querySelector(`input[name="hobbies"][value="${hobby}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        console.log(`‚úÖ Ï∑®ÎØ∏ Ï≤¥ÌÅ¨: ${hobby}`);
                    }
                });
            }

            // Î™®Îã¨ ÌëúÏãú
            document.getElementById('characterModal').style.display = 'block';
            console.log('‚úÖ Ï∫êÎ¶≠ÌÑ∞ Ìé∏Ïßë Î™®Îã¨ ÌëúÏãú ÏôÑÎ£å (ÏöîÏïΩ + Ìèº Îç∞Ïù¥ÌÑ∞)');
        }

        // ‚ö†Ô∏è Í∏∞Ï°¥ saveCharacter Ìï®Ïàò Ï†úÍ±∞Îê® - ÏÉàÎ°úÏö¥ Ïò®ÎùºÏù∏ Ï†ÑÏö© Ìï®ÏàòÎ°ú ÍµêÏ≤¥


        // Ï±ÑÌåÖ ÌõàÎ†® APIÎ•º ÏÇ¨Ïö©Ìïú ÎåÄÌôî ÏÉùÏÑ± Ìï®Ïàò (Í∞úÏÑ†Îêú Î≤ÑÏ†Ñ)
        async function generateLocalDialogue(characterId, characterName, userPrompt, difficulty) {
            console.log(`üéØ ${characterName}Ïùò ${difficulty} ÎÇúÏù¥ÎèÑ Ï±ÑÌåÖ ÌõàÎ†® ÎåÄÌôî ÏÉùÏÑ±:`, userPrompt);

            try {
                // Ï±ÑÌåÖ ÌõàÎ†® API Ìò∏Ï∂ú
                const response = await fetch('/api/episode-test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'generate',
                        character_id: characterId,
                        user_prompt: userPrompt,
                        difficulty: difficulty
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå API ÏùëÎãµ Ïã§Ìå®:', response.status, errorText);
                    throw new Error(`API Ìò∏Ï∂ú Ïã§Ìå® (${response.status}): ${errorText}`);
                }

                const data = await response.json();
                console.log('‚úÖ Ï±ÑÌåÖ ÌõàÎ†® API ÏùëÎãµ Î∞õÏùå:', data);

                // APIÍ∞Ä ÎπÑÌôúÏÑ±ÌôîÎêú Í≤ΩÏö∞ ÎòêÎäî ÏÑ±Í≥µÌïòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞ Ï≤òÎ¶¨
                if (!data.success) {
                    const errorMessage = data.message || 'AI ÎåÄÌôî ÏÉùÏÑ± APIÏóêÏÑú Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
                    console.error('‚ö†Ô∏è API Ïò§Î•ò:', errorMessage);
                    throw new Error(errorMessage);
                }

                // ÏÑ±Í≥µÌïú Í≤ΩÏö∞ Îç∞Ïù¥ÌÑ∞ Î∞òÌôò (ÏÉàÎ°úÏö¥ story_flow Íµ¨Ï°∞ ÏßÄÏõê)
                if (data.data) {
                    console.log('üéØ AI ÏùëÎãµ Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞ ÌôïÏù∏:', data.data);

                    // story_flow Íµ¨Ï°∞Ïù∏ÏßÄ ÌôïÏù∏
                    if (data.data.story_flow && Array.isArray(data.data.story_flow)) {
                        console.log('‚úÖ Story Flow Íµ¨Ï°∞Î°ú AI ÎåÄÌôî ÏÉùÏÑ±Îê®');
                        return {
                            story_flow: data.data.story_flow,
                            dialogue_summary: data.data.dialogue_summary,
                            difficulty: difficulty,
                            generated_at: new Date().toISOString(),
                            source: 'openai_gpt4o_mini'
                        };
                    }
                    // Í∏∞Ï°¥ Íµ¨Ï°∞ ÏßÄÏõê (ÌïòÏúÑ Ìò∏ÌôòÏÑ±)
                    else if (data.data.character_message || data.data.dialogue) {
                        console.log('üìù Í∏∞Ï°¥ Íµ¨Ï°∞Î°ú AI ÎåÄÌôî ÏÉùÏÑ±Îê®');
                        return {
                            dialogue: data.data.character_message || data.data.dialogue,
                            narration: data.data.context || data.data.narration,
                            choices: data.data.choices || [],
                            difficulty: difficulty,
                            generated_at: new Date().toISOString(),
                            source: 'legacy_api'
                        };
                    } else {
                        throw new Error('AI ÏùëÎãµ Îç∞Ïù¥ÌÑ∞ ÌòïÏãùÏùÑ Ïù∏ÏãùÌï† Ïàò ÏóÜÏäµÎãàÎã§.');
                    }
                } else {
                    throw new Error('API ÏùëÎãµÏóê Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
                }

            } catch (error) {
                // Íµ¨Ï≤¥Ï†ÅÏù∏ ÏóêÎü¨ Î©îÏãúÏßÄ Î°úÍπÖ
                const errorMessage = error.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
                console.error('‚ùå Ï±ÑÌåÖ ÌõàÎ†® API Ìò∏Ï∂ú Ïò§Î•ò:', errorMessage);
                console.error('‚ùå Ï†ÑÏ≤¥ ÏóêÎü¨ Í∞ùÏ≤¥:', error);

                // ÏóêÎü¨ Î©îÏãúÏßÄÎ•º Î™ÖÌôïÌïòÍ≤å Ï†ÑÎã¨
                throw new Error(errorMessage);
            }
        }

        // üöÄ GitHub API ÌïµÏã¨ Ìï®ÏàòÎì§ (ÌòÅÏã†Ï†Å Ìï¥Í≤∞Ï±Ö!)
        
        // GitHub Repository ÏÑ§Ï†ï
        const GITHUB_CONFIG = {
            owner: 'EnmanyProject',  // GitHub ÏÇ¨Ïö©ÏûêÎ™Ö
            repo: 'chatgame',        // Repository Ïù¥Î¶Ñ  
            token: null,             // Personal Access Token (ÌôòÍ≤ΩÎ≥ÄÏàòÏóêÏÑú Î°úÎìú)
            branch: 'main'           // Î∏åÎûúÏπòÎ™Ö
        };
        
        // GitHub ÌÜ†ÌÅ∞ÏùÄ Ïù¥Ï†ú ÏÑúÎ≤ÑÏÇ¨Ïù¥ÎìúÏóêÏÑú ÌôòÍ≤ΩÎ≥ÄÏàòÎ°ú Í¥ÄÎ¶¨Îê®
        
        // GitHub APIÎ°ú ÌååÏùº ÎÇ¥Ïö© Í∞ÄÏ†∏Ïò§Í∏∞
        async function getFileFromGitHub(filePath) {
            try {
                const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${filePath}`;
                console.log('üì• GitHubÏóêÏÑú ÌååÏùº Î°úÎìú:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const content = JSON.parse(atob(data.content));
                    console.log('‚úÖ GitHub ÌååÏùº Î°úÎìú ÏÑ±Í≥µ:', filePath);
                    return { success: true, content, sha: data.sha };
                } else if (response.status === 404) {
                    console.log('üì≠ GitHub ÌååÏùº ÏóÜÏùå, ÏÉà ÌååÏùº ÏÉùÏÑ±:', filePath);
                    return { success: true, content: { characters: {} }, sha: null };
                } else {
                    throw new Error(`GitHub API Error: ${response.status}`);
                }
            } catch (error) {
                console.error('‚ùå GitHub ÌååÏùº Î°úÎìú Ïã§Ìå®:', error);
                return { success: false, error: error.message };
            }
        }
        
        // GitHub APIÎ°ú ÌååÏùº ÏóÖÎç∞Ïù¥Ìä∏/ÏÉùÏÑ±
        async function commitToGitHub(filePath, content, commitMessage) {
            try {
                // ÌòÑÏû¨ ÌååÏùº SHA Í∞ÄÏ†∏Ïò§Í∏∞ (ÏóÖÎç∞Ïù¥Ìä∏Ïö©)
                const currentFile = await getFileFromGitHub(filePath);
                
                const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${filePath}`;
                console.log('üì§ GitHubÏóê Ïª§Î∞ã:', url);
                
                const body = {
                    message: commitMessage + ` ü§ñ Generated by ChatGame Admin`,
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2)))),
                    branch: GITHUB_CONFIG.branch
                };
                
                // ÌååÏùºÏù¥ Ï°¥Ïû¨ÌïòÎ©¥ SHA Ìè¨Ìï® (ÏóÖÎç∞Ïù¥Ìä∏)
                if (currentFile.sha) {
                    body.sha = currentFile.sha;
                }
                
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ GitHub Ïª§Î∞ã ÏÑ±Í≥µ! SHA:', data.commit.sha);
                    return { 
                        success: true, 
                        sha: data.commit.sha,
                        html_url: data.commit.html_url 
                    };
                } else {
                    const errorData = await response.json();
                    throw new Error(`GitHub Commit Error: ${response.status} - ${errorData.message}`);
                }
            } catch (error) {
                console.error('‚ùå GitHub Ïª§Î∞ã Ïã§Ìå®:', error);
                return { success: false, error: error.message };
            }
        }
        
        // GitHubÏóêÏÑú Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        async function loadCharactersFromGitHub() {
            try {
                console.log('üì• GitHubÏóêÏÑú Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú...');
                const result = await getFileFromGitHub('data/characters.json');
                
                if (result.success) {
                    // characters.json Ìè¨Îß∑ÏùÑ ID Í∏∞Î∞ò Í∞ùÏ≤¥Î°ú Î≥ÄÌôò
                    const charactersData = result.content;
                    if (charactersData.characters) {
                        if (Array.isArray(charactersData.characters)) {
                            // Array ÌòïÌÉúÎ•º Object ÌòïÌÉúÎ°ú Î≥ÄÌôò
                            const convertedCharacters = {};
                            charactersData.characters.forEach(char => {
                                convertedCharacters[char.id] = char;
                            });
                            return convertedCharacters;
                        } else {
                            return charactersData.characters;
                        }
                    }
                    return {};
                } else {
                    console.warn('‚ö†Ô∏è GitHub Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú Ïã§Ìå®:', result.error);
                    return {};
                }
            } catch (error) {
                console.error('‚ùå GitHub Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú ÏòàÏô∏:', error);
                return {};
            }
        }
        
        // üöÄ GitHub API Ï∫êÎ¶≠ÌÑ∞ Ï†ÄÏû• Ìï®Ïàò (ÌòÅÏã†Ï†Å!)
        async function saveCharacterToGitHub(character) {
            try {
                console.log('üêô GitHub APIÎ°ú Ï∫êÎ¶≠ÌÑ∞ Ï†ÄÏû• ÏãúÏûë:', character.name);
                
                // GitHub ÌÜ†ÌÅ∞ÏùÄ ÏÑúÎ≤ÑÏÇ¨Ïù¥ÎìúÏóêÏÑú ÌôòÍ≤ΩÎ≥ÄÏàòÎ°ú Ï≤òÎ¶¨
                
                // Ï∫êÎ¶≠ÌÑ∞ ID ÏÉùÏÑ± (ÏóÜÏúºÎ©¥)
                if (!character.id) {
                    character.id = `${character.name.toLowerCase().replace(/\s/g, '_')}_${character.mbti.toLowerCase()}_${Date.now()}`;
                    console.log('üîß Ï∫êÎ¶≠ÌÑ∞ ID ÏÉùÏÑ±:', character.id);
                }
                
                // Í∏∞Ï°¥ Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù Î°úÎìú
                const existingCharacters = await loadCharactersFromGitHub();
                console.log('üìä Í∏∞Ï°¥ GitHub Ï∫êÎ¶≠ÌÑ∞ Ïàò:', Object.keys(existingCharacters).length);
                
                // ÏÉà Ï∫êÎ¶≠ÌÑ∞ Ï∂îÍ∞Ä
                existingCharacters[character.id] = {
                    ...character,
                    updated_at: new Date().toISOString(),
                    source: 'github_api',
                    commit_hash: 'pending'
                };
                
                // GitHubÏóê Ïª§Î∞ãÌï† Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞ ÏÉùÏÑ±
                const charactersArrayData = {
                    characters: Object.values(existingCharacters)
                };
                
                // GitHub RepositoryÏóê ÏßÅÏ†ë Ïª§Î∞ã
                const commitMessage = `Add new character: ${character.name} (${character.mbti})`;
                const commitResult = await commitToGitHub('data/characters.json', charactersArrayData, commitMessage);
                
                if (commitResult.success) {
                    // Ïª§Î∞ã Ìï¥Ïãú ÏóÖÎç∞Ïù¥Ìä∏
                    existingCharacters[character.id].commit_hash = commitResult.sha;
                    
                    // Î°úÏª¨ Î∞±ÏóÖÎèÑ Ï†ÄÏû•
                    localStorage.setItem('chatgame_characters', JSON.stringify(existingCharacters));
                    
                    console.log('‚úÖ GitHub API Ï†ÄÏû• ÏôÑÎ£å! Ïª§Î∞ã SHA:', commitResult.sha);
                    console.log('üìù GitHubÏóê Ï†ÄÏû•Îêú Ï∫êÎ¶≠ÌÑ∞ IDÎì§:', Object.keys(existingCharacters));
                    console.log('üîó Ïª§Î∞ã URL:', commitResult.html_url);
                    
                    return { success: true, commit_hash: commitResult.sha, url: commitResult.html_url };
                } else {
                    throw new Error('GitHub commit failed: ' + commitResult.error);
                }
                
            } catch (error) {
                console.error('‚ùå GitHub API Ï†ÄÏû• Ïò§Î•ò:', error);
                
                // Ïã§Ìå® Ïãú Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÎ°ú Ìè¥Î∞±
                console.log('üíæ Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÎ°ú Ìè¥Î∞±...');
                return saveCharacterToLocalStorage(character);
            }
        }
        
        // Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ Ìè¥Î∞± Ìï®Ïàò
        function saveCharacterToLocalStorage(character) {
            try {
                console.log('üíæ Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóê Ï∫êÎ¶≠ÌÑ∞ Ï†ÄÏû• ÏãúÏûë:', character.name);
                
                // Ï∫êÎ¶≠ÌÑ∞ ID ÏÉùÏÑ± (ÏóÜÏúºÎ©¥)
                if (!character.id) {
                    character.id = `${character.name.toLowerCase()}_${character.mbti.toLowerCase()}_${Date.now()}`;
                    console.log('üîß Ï∫êÎ¶≠ÌÑ∞ ID ÏÉùÏÑ±:', character.id);
                }
                
                // Í∏∞Ï°¥ Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù Î°úÎìú
                const existingCharacters = JSON.parse(localStorage.getItem('chatgame_characters') || '{}');
                console.log('üìä Í∏∞Ï°¥ Ï∫êÎ¶≠ÌÑ∞ Ïàò:', Object.keys(existingCharacters).length);
                
                // ÏÉà Ï∫êÎ¶≠ÌÑ∞ Ï∂îÍ∞Ä
                existingCharacters[character.id] = {
                    ...character,
                    updated_at: new Date().toISOString(),
                    source: 'local_storage'
                };
                
                // Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóê Ï†ÄÏû•
                localStorage.setItem('chatgame_characters', JSON.stringify(existingCharacters));
                
                console.log('‚úÖ Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ Ï†ÄÏû• ÏôÑÎ£å. Ï¥ù Ï∫êÎ¶≠ÌÑ∞ Ïàò:', Object.keys(existingCharacters).length);
                console.log('üìù Ï†ÄÏû•Îêú Ï∫êÎ¶≠ÌÑ∞ IDÎì§:', Object.keys(existingCharacters));
                
                return true;
            } catch (error) {
                console.error('‚ùå Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ Ï†ÄÏû• Ïò§Î•ò:', error);
                return false;
            }
        }
        
        // API Î∞±ÏóÖ Ï†ÄÏû• Ìï®Ïàò (Ïã§Ìå®Ìï¥ÎèÑ Î¨¥Ïãú)
        async function saveCharacterToAPI(character) {
            try {
                console.log('üåê APIÎ°ú Ï∫êÎ¶≠ÌÑ∞ Î∞±ÏóÖ ÏãúÏûë:', character.name);
                
                const response = await fetch('/api/character-ai-generator', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'save_character',
                        character: character
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Ï∫êÎ¶≠ÌÑ∞ Ï†ÄÏû• ÏÑ±Í≥µ:', result);
                    return result.success;
                } else {
                    console.error('‚ùå API Ï†ÄÏû• Ïã§Ìå®:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Ï∫êÎ¶≠ÌÑ∞ Ï†ÄÏû• Ïò§Î•ò:', error);
                return false;
            }
        }

        // ÏÉàÎ°úÏö¥ Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ ÏàòÏßë Ìï®Ïàò
        function collectCharacterData() {
            return {
                name: document.getElementById('charName').value || 'ÎØ∏ÏßÄÏùò ÏÜåÎÖÄ',
                age: document.getElementById('charAge').value || '20',
                mbti: document.getElementById('charMbti').value,
                character_type: document.getElementById('charType').value || 'romance_junior',
                personality_traits: getSelectedTraits(),
                major: document.getElementById('charMajor').value || 'art',
                family: document.getElementById('charFamily').value || 'only_child',
                hometown: document.getElementById('charHometown').value || 'seoul',
                relationship: document.getElementById('charRelationship').value,
                image: null,
                hair: document.getElementById('charHair').value || 'long_straight',
                eyes: document.getElementById('charEyes').value || 'round_cute',
                body: document.getElementById('charBody').value || 'petite',
                style: document.getElementById('charStyle').value || 'cute_casual',
                hobbies: getSelectedHobbies(),
                values: document.getElementById('charValues').value || 'love_family',
                speech_style: document.getElementById('charSpeechStyle').value,
                speech_habit: document.getElementById('charSpeechHabit').value || '',
                // genre ÌïÑÎìú Ï†úÍ±∞Îê®
                // main_situation ÌïÑÎìú Ï†úÍ±∞Îê®
            };
        }

        // ÏÑ†ÌÉùÎêú ÏÑ±Í≤© ÌäπÏÑ±Îì§ Í∞ÄÏ†∏Ïò§Í∏∞
        function getSelectedTraits() {
            const selectedTraits = [];
            document.querySelectorAll('.trait-btn.selected').forEach(btn => {
                selectedTraits.push(btn.dataset.trait);
            });
            return selectedTraits.slice(0, 3); // ÏµúÎåÄ 3Í∞úÎßå
        }

        // ÏÑ†ÌÉùÎêú Ï∑®ÎØ∏Îì§ Í∞ÄÏ†∏Ïò§Í∏∞
        function getSelectedHobbies() {
            const selectedHobbies = [];
            document.querySelectorAll('.hobby-btn.selected').forEach(btn => {
                selectedHobbies.push(btn.dataset.hobby);
            });
            return selectedHobbies.slice(0, 3); // ÏµúÎåÄ 3Í∞úÎßå
        }

        // === AI Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±Í∏∞ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï¥àÍ∏∞Ìôî ===
        function initializeCharacterGeneratorEvents() {
            // MBTI Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('mbti-btn')) {
                    document.querySelectorAll('.mbti-btn').forEach(btn => btn.classList.remove('selected'));
                    e.target.classList.add('selected');
                    const selectedMbti = e.target.dataset.mbti;
                    document.getElementById('charMbti').value = selectedMbti;
                    console.log('‚úÖ MBTI ÏÑ†ÌÉùÎê®:', selectedMbti);
                }

                // ÏÑ±Í≤© ÌäπÏÑ± Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ (ÏµúÎåÄ 3Í∞ú ÏÑ†ÌÉù)
                if (e.target.classList.contains('trait-btn')) {
                    const selectedTraits = document.querySelectorAll('.trait-btn.selected').length;
                    
                    if (e.target.classList.contains('selected')) {
                        e.target.classList.remove('selected');
                    } else if (selectedTraits < 3) {
                        e.target.classList.add('selected');
                    } else {
                        alert('ÏÑ±Í≤© ÌäπÏÑ±ÏùÄ ÏµúÎåÄ 3Í∞úÍπåÏßÄÎßå ÏÑ†ÌÉù Í∞ÄÎä•Ìï©ÎãàÎã§.');
                    }
                }

                // Í¥ÄÍ≥Ñ ÏÑ§Ï†ï Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
                if (e.target.classList.contains('relationship-btn')) {
                    document.querySelectorAll('.relationship-btn').forEach(btn => btn.classList.remove('selected'));
                    e.target.classList.add('selected');
                    document.getElementById('charRelationship').value = e.target.dataset.rel;
                }

                // Ï∑®ÎØ∏ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ (ÏµúÎåÄ 3Í∞ú ÏÑ†ÌÉù)
                if (e.target.classList.contains('hobby-btn')) {
                    const selectedHobbies = document.querySelectorAll('.hobby-btn.selected').length;
                    
                    if (e.target.classList.contains('selected')) {
                        e.target.classList.remove('selected');
                    } else if (selectedHobbies < 3) {
                        e.target.classList.add('selected');
                    } else {
                        alert('Ï∑®ÎØ∏Îäî ÏµúÎåÄ 3Í∞úÍπåÏßÄÎßå ÏÑ†ÌÉù Í∞ÄÎä•Ìï©ÎãàÎã§.');
                    }
                }

                // ÎßêÌà¨ Ïä§ÌÉÄÏùº Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
                if (e.target.classList.contains('speech-btn')) {
                    document.querySelectorAll('.speech-btn').forEach(btn => btn.classList.remove('selected'));
                    e.target.classList.add('selected');
                    document.getElementById('charSpeechStyle').value = e.target.dataset.speech;
                }
            });
        }

        // === AI Ï∫êÎ¶≠ÌÑ∞ ÏûêÎèô ÏÉùÏÑ± Ìï®Ïàò ===
        async function generateAICharacter() {
            const statusDiv = document.getElementById('aiGenerationStatus');
            const previewDiv = document.getElementById('characterPreview');
            
            statusDiv.innerHTML = 'ü§ñ AIÍ∞Ä Ï∫êÎ¶≠ÌÑ∞Î•º ÏÉùÏÑ±ÌïòÍ≥† ÏûàÏäµÎãàÎã§...';
            
            try {
                // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Îç∞Ïù¥ÌÑ∞ ÏàòÏßë
                const currentData = collectCharacterData();
                
                // ÏÑ∏ÏÖòÏóêÏÑú API ÌÇ§ Í∞ÄÏ†∏Ïò§Í∏∞
                const sessionApiKey = sessionStorage.getItem('openai_api_key');
                
                // AI API Ìò∏Ï∂ú (character-ai-generator.js ÏÇ¨Ïö©)
                const response = await fetch('/api/character-ai-generator', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-OpenAI-Key': sessionApiKey || '' // API ÌÇ§ Ìó§Îçî Ï∂îÍ∞Ä
                    },
                    body: JSON.stringify({
                        action: 'generate_character',
                        answers: currentData
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        statusDiv.innerHTML = '‚ú® AI ÏÉùÏÑ± ÏôÑÎ£å!';
                        displayAIGeneratedCharacter(result.character);
                        previewDiv.style.display = 'block';
                    } else {
                        throw new Error(result.message || 'AI ÏÉùÏÑ± Ïã§Ìå®');
                    }
                } else {
                    // ÏÑúÎ≤ÑÏóêÏÑú ÏÉÅÏÑ∏Ìïú Ïò§Î•ò Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                    let errorMessage = `API Ïò§Î•ò: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        console.error('üî• ÏÑúÎ≤Ñ Ïò§Î•ò ÏÉÅÏÑ∏:', errorData);
                        errorMessage = errorData.message || errorMessage;
                    } catch (parseError) {
                        console.error('‚ö†Ô∏è Ïò§Î•ò ÏùëÎãµ ÌååÏã± Ïã§Ìå®:', parseError);
                    }
                    throw new Error(errorMessage);
                }
            } catch (error) {
                console.error('‚ùå AI Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ± Ïã§Ìå®:', error);
                statusDiv.innerHTML = `‚ùå AI ÏÉùÏÑ± Ïã§Ìå®: ${error.message}`;

                // ÏÇ¨Ïö©ÏûêÏóêÍ≤å Î™ÖÌôïÌïú Ïò§Î•ò Î©îÏãúÏßÄ ÌëúÏãú
                alert(`Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ± Ïã§Ìå®\n\n${error.message}\n\nÎã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.`);
            }
        }

        // ÏÉùÏÑ±Îêú Ï∫êÎ¶≠ÌÑ∞Î•º Ï†ÄÏû•Ìï† Í∏ÄÎ°úÎ≤å Î≥ÄÏàò
        let generatedCharacter = null;

        // AI ÏÉùÏÑ± Í≤∞Í≥º ÌëúÏãú
        function displayAIGeneratedCharacter(character) {
            // Í∏ÄÎ°úÎ≤å Î≥ÄÏàòÏóê Ï†ÄÏû•
            generatedCharacter = character;
            
            const previewDiv = document.getElementById('characterPreview');
            previewDiv.innerHTML = `
                <h4>üé≠ AI ÏÉùÏÑ±Í≤∞Í≥ºÎ≥¥Í∏∞</h4>
                <div class="character-preview-content">
                    <div class="preview-section">
                        <h5>üë§ Í∏∞Î≥∏ Ï†ïÎ≥¥</h5>
                        <p><strong>Ïù¥Î¶Ñ:</strong> ${character.name}</p>
                        <p><strong>ÎÇòÏù¥:</strong> ${character.age}ÏÑ∏</p>
                        <p><strong>ÏÑ±Î≥Ñ:</strong> ${character.gender === 'female' ? 'Ïó¨ÏÑ±' : 'ÎÇ®ÏÑ±'}</p>
                        <p><strong>MBTI:</strong> ${character.mbti}</p>
                    </div>

                    <div class="preview-section">
                        <h5>üåü ÏÑ±Í≤© & ÌäπÏÑ±</h5>
                        <p><strong>ÏÑ±Í≤© ÌäπÏÑ±:</strong> ${Array.isArray(character.personality_traits) ? character.personality_traits.join(', ') : character.personality_traits || 'Í∞êÏÑ±Ï†Å, ÎÇ¥Ìñ•Ï†Å'}</p>
                        <p><strong>Ï†ÑÍ≥µ:</strong> ${character.major || 'ÏùºÎ∞ò Ï†ÑÍ≥µ'}</p>
                        <p><strong>Í¥ÄÍ≥Ñ:</strong> ${character.relationship || 'ÏπúÍµ¨'}</p>
                        <p><strong>Í∞ÄÏπòÍ¥Ä:</strong> ${character.values || 'Í∞ÄÏ°± Ï§ëÏã¨'}</p>
                    </div>

                    <div class="preview-section">
                        <h5>üëÄ Ïô∏Î™® & Ïä§ÌÉÄÏùº</h5>
                        <p><strong>Ìó§Ïñ¥Ïä§ÌÉÄÏùº:</strong> ${character.appearance?.hair || character.hair || 'Í∏¥ ÏÉùÎ®∏Î¶¨'}</p>
                        <p><strong>Îàà:</strong> ${character.appearance?.eyes || character.eyes || 'ÌÅ∞ Îàà'}</p>
                        <p><strong>Ïä§ÌÉÄÏùº:</strong> ${character.appearance?.style || character.style || 'Ï∫êÏ£ºÏñº'}</p>
                    </div>

                    <div class="preview-section">
                        <h5>üè† Î∞∞Í≤Ω Ï†ïÎ≥¥</h5>
                        <p><strong>Í∞ÄÏ°±:</strong> ${character.family || character.background?.family || 'Ï†ïÎ≥¥ ÏóÜÏùå'}</p>
                        <p><strong>Í≥†Ìñ•:</strong> ${character.hometown || character.background?.hometown || 'Ï†ïÎ≥¥ ÏóÜÏùå'}</p>
                        <p><strong>ÏßÅÏóÖ:</strong> ${character.background?.occupation || 'ÎåÄÌïôÏÉù'}</p>
                    </div>

                    <div class="preview-section">
                        <h5>üí¨ ÎßêÌà¨ & ÏäµÍ¥Ä</h5>
                        <p><strong>ÎßêÌà¨:</strong> ${character.speech_style || 'ÏπúÍ∑ºÌïú ÎßêÌà¨'}</p>
                        <p><strong>ÎßêÎ≤ÑÎ¶á:</strong> ${character.speech_habit || 'Ïù¥Î™®Ìã∞ÏΩòÏùÑ ÏûêÏ£º ÏÇ¨Ïö©Ìï®'}</p>
                    </div>

                    <div class="preview-section">
                        <h5>üéØ Ï∑®ÎØ∏ & Í¥ÄÏã¨ÏÇ¨</h5>
                        <p><strong>Ï∑®ÎØ∏:</strong> ${Array.isArray(character.hobbies) ? character.hobbies.join(', ') : character.hobbies || 'ÎèÖÏÑú, ÏùåÏïÖÍ∞êÏÉÅ'}</p>
                        <p><strong>ÎëêÎ†§ÏõÄ:</strong> ${character.personality?.fears || character.fears || 'Í±∞Ï†àÎãπÌïòÎäî Í≤É'}</p>
                    </div>


                    <div class="preview-actions">
                        <button class="btn btn-primary" onclick="applyAIGeneratedData()">
                            üíñ Ïù¥ Ï∫êÎ¶≠ÌÑ∞ Ï†ÅÏö©ÌïòÍ∏∞
                        </button>
                        <button class="btn btn-secondary" onclick="generateRandomCharacter()" style="margin-left: 10px;">
                            üé≤ Îã§Ïãú ÏÉùÏÑ±ÌïòÍ∏∞
                        </button>
                    </div>
                </div>
            `;
        }

        // AI ÏÉùÏÑ± Îç∞Ïù¥ÌÑ∞Î•º ÌèºÏóê Ï†ÅÏö©
        async function applyAIGeneratedData() {
            if (!generatedCharacter) {
                alert('‚ö†Ô∏è Î®ºÏ†Ä AIÎ°ú Ï∫êÎ¶≠ÌÑ∞Î•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            try {
                const character = generatedCharacter;
                console.log('üé≠ AI Ï∫êÎ¶≠ÌÑ∞ Ìèº Ï†ÅÏö© ÏãúÏûë:', character);

                // ÏïàÏ†ÑÌïú ÏöîÏÜå ÏÑ§Ï†ï Ìï®Ïàò
                function safeSetValue(id, value) {
                    const element = document.getElementById(id);
                    if (element && value) {
                        element.value = value;
                        console.log(`‚úÖ ${id} ÏÑ§Ï†ï ÏôÑÎ£å:`, value);
                        return true;
                    } else if (!element) {
                        console.warn(`‚ö†Ô∏è ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå: ${id}`);
                    }
                    return false;
                }

                // Í∏∞Î≥∏ Ï†ïÎ≥¥ Ï†ÅÏö©
                safeSetValue('charName', character.name);
                safeSetValue('charAge', character.age || '22');
                safeSetValue('charMbti', character.mbti);

                // MBTI Î≤ÑÌäºÎèÑ ÏãúÍ∞ÅÏ†ÅÏúºÎ°ú ÏÑ†ÌÉù
                if (character.mbti) {
                    document.querySelectorAll('.mbti-btn').forEach(btn => {
                        if (btn.dataset && btn.dataset.mbti) {
                            btn.classList.toggle('selected', btn.dataset.mbti === character.mbti);
                        }
                    });
                }

                // ÏïàÏ†ÑÌïú Î≤ÑÌäº ÏÑ†ÌÉù Ìï®Ïàò
                function safeSelectButtons(selector, items, dataAttr) {
                    try {
                        // Í∏∞Ï°¥ ÏÑ†ÌÉù Ï¥àÍ∏∞Ìôî
                        document.querySelectorAll(`${selector}.selected`).forEach(btn => {
                            btn.classList.remove('selected');
                        });

                        // ÏÉà Ìï≠Î™© ÏÑ†ÌÉù
                        if (items && Array.isArray(items)) {
                            items.forEach(item => {
                                const btn = document.querySelector(`[${dataAttr}="${item}"]`);
                                if (btn) {
                                    btn.classList.add('selected');
                                    console.log(`‚úÖ ${selector} ÏÑ†ÌÉùÎê®:`, item);
                                }
                            });
                        }
                    } catch (error) {
                        console.warn(`‚ö†Ô∏è ${selector} ÏÑ†ÌÉù Ï§ë Ïò§Î•ò:`, error);
                    }
                }

                // ÏÑ±Í≤© ÌäπÏÑ±Í≥º Ï∑®ÎØ∏ ÏïàÏ†ÑÌïòÍ≤å Ï†ÅÏö©
                safeSelectButtons('.trait-btn', character.personality_traits, 'data-trait');
                safeSelectButtons('.hobby-btn', character.personality?.hobbies, 'data-hobby');

                console.log('üéâ AI Ï∫êÎ¶≠ÌÑ∞ Í∏∞Î≥∏ Ï†ïÎ≥¥ Ï†ÅÏö© ÏôÑÎ£å!');

                // Ï∂îÍ∞Ä Ìèº ÏöîÏÜåÎì§ÎèÑ ÏïàÏ†ÑÌïòÍ≤å Ï†ÅÏö©
                safeSetValue('charMajor', character.major);
                safeSetValue('charRelationship', character.relationship);
                safeSetValue('charFamily', character.background?.family);
                safeSetValue('charHometown', character.background?.hometown);
                safeSetValue('charHair', character.appearance?.hair);
                safeSetValue('charEyes', character.appearance?.eyes);
                safeSetValue('charStyle', character.appearance?.style);
                safeSetValue('charSpeechStyle', character.speech_style);
                safeSetValue('charSpeechHabit', character.speech_habit);
                safeSetValue('charValues', character.personality?.values);
                // charGenre ÌïÑÎìú Ï†úÍ±∞Îê®
                // charMainSituation ÌïÑÎìú Ï†úÍ±∞Îê®

                console.log('‚úÖ Î™®Îì† Ìèº ÏöîÏÜå Ï†ÅÏö© ÏôÑÎ£å!');

                // AI ÏÉùÏÑ± ÏòÅÏó≠ Ïà®Í∏∞Í∏∞
                const previewElement = document.getElementById('characterPreview');
                const statusElement = document.getElementById('aiGenerationStatus');

                if (previewElement) previewElement.style.display = 'none';
                if (statusElement) statusElement.innerHTML = '‚úÖ Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÌèºÏóê Ï†ÅÏö©ÎêòÏóàÏäµÎãàÎã§!';

                // ÏÑ±Í≥µ Î©îÏãúÏßÄÏôÄ ÏûêÎèô Ï†ÄÏû• Ïó¨Î∂Ä ÌôïÏù∏
                const autoSave = confirm('üíñ AI ÏÉùÏÑ± Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÌèºÏóê Ï†ÅÏö©ÎêòÏóàÏäµÎãàÎã§!\n\nÎ∞îÎ°ú Ï†ÄÏû•ÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\n‚Ä¢ ÌôïÏù∏: Î∞îÎ°ú Ï†ÄÏû•\n‚Ä¢ Ï∑®ÏÜå: ÏàòÏ†ï ÌõÑ Ï†ÄÏû•');

                if (autoSave) {
                    console.log('üöÄ ÏûêÎèô Ï†ÄÏû• ÏãúÏûë...');
                    await window.saveCharacter();
                } else {
                    alert('‚úÖ Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥Í∞Ä ÌèºÏóê Ï†ÅÏö©ÎêòÏóàÏäµÎãàÎã§.\nÏàòÏ†ïÏù¥ ÌïÑÏöîÌïòÎ©¥ ÌèºÏùÑ Ìé∏ÏßëÌïú ÌõÑ "Ï†ÄÏû•" Î≤ÑÌäºÏùÑ ÎàåÎü¨Ï£ºÏÑ∏Ïöî.');
                }

            } catch (error) {
                console.error('‚ùå AI Îç∞Ïù¥ÌÑ∞ Ï†ÅÏö© Ïò§Î•ò:', error);
                console.error('Ïò§Î•ò ÏÉÅÏÑ∏:', error.stack);

                // Íµ¨Ï≤¥Ï†ÅÏù∏ Ïò§Î•ò Î©îÏãúÏßÄ Ï†úÍ≥µ
                let errorMessage = 'Îç∞Ïù¥ÌÑ∞ Ï†ÅÏö© Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§:\n\n';
                errorMessage += `Ïò§Î•ò: ${error.message}\n\n`;
                errorMessage += 'Ìï¥Í≤∞Ï±Ö:\n';
                errorMessage += '1. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Î≥¥ÏÑ∏Ïöî\n';
                errorMessage += '2. AI Ï∫êÎ¶≠ÌÑ∞Î•º Îã§Ïãú ÏÉùÏÑ±Ìï¥Î≥¥ÏÑ∏Ïöî\n';
                errorMessage += '3. ÏàòÎèôÏúºÎ°ú Ï†ïÎ≥¥Î•º ÏûÖÎ†•Ìï¥Î≥¥ÏÑ∏Ïöî';

                alert(errorMessage);
            }
        }

        // Fallback Ïó¨ÏÑ± Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±
        // generateFallbackFemaleCharacter Ìï®Ïàò Ï†úÍ±∞Îê® - fallback Ï≤òÎ¶¨ ÏïàÌï®

        // Í¥ÄÍ≥Ñ Î≤àÏó≠ Ìï®Ïàò
        function translateRelationship(rel) {
            const translations = {
                'secret_crush': 'Î™∞Îûò Ï¢ãÏïÑÌïòÎäî ÌõÑÎ∞∞',
                'childhood_friend': 'Ïñ¥Î¶¥ ÎïåÎ∂ÄÌÑ∞ ÏπúÌïú ÏπúÍµ¨', 
                'senior_friend': 'Îã§Ï†ïÌïú ÏÑ†Î∞∞',
                'classmate': 'Í∞ôÏùÄ Í≥º ÎèôÍ∏∞',
                'club_mate': 'ÎèôÏïÑÎ¶¨ ÏÑ†ÌõÑÎ∞∞',
                'neighbor': 'ÏòÜÏßë Ïù¥ÏõÉ'
            };
            return translations[rel] || rel;
        }

        // ÎßêÌà¨ Î≤àÏó≠ Ìï®Ïàò
        function translateSpeechStyle(style) {
            const translations = {
                'soft_warm': 'Î∂ÄÎìúÎüΩÍ≥† Îî∞ÎúªÌïú',
                'bright_cheerful': 'Î∞ùÍ≥† Í≤ΩÏæåÌïú',
                'gentle_caring': 'Îã§Ï†ïÌïòÍ≥† Î∞∞Î†§ÍπäÏùÄ',
                'shy_cute': 'ÏàòÏ§çÍ≥† Í∑ÄÏó¨Ïö¥',
                'mature_elegant': 'ÏÑ±ÏàôÌïòÍ≥† Ïö∞ÏïÑÌïú',
                'playful_fun': 'Ïû•ÎÇúÏä§ÎüΩÍ≥† Ïû¨ÎØ∏ÏûàÎäî',
                'sexy_flirty': 'ÏÑπÏãúÌïòÍ≥† Ïú†ÌòπÏ†ÅÏù∏',
                'mysterious_seductive': 'Ïã†ÎπÑÎ°≠Í≥† Îß§ÌòπÏ†ÅÏù∏',
                'cute_naughty': 'Í∑ÄÏóΩÍ≤å ÏùëÌÅºÌïú'
            };
            return translations[style] || style;
        }

        async function deleteCharacter(characterId) {
            if (!confirm('Ï†ïÎßêÎ°ú Ïù¥ Ï∫êÎ¶≠ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                return;
            }

            try {
                console.log('üóëÔ∏è Ï∫êÎ¶≠ÌÑ∞ ÏÇ≠Ï†ú ÏãúÏûë (LocalStorage):', characterId);
                
                // LocalStorageÏóêÏÑú Ï∫êÎ¶≠ÌÑ∞ ÏÇ≠Ï†ú
                const existingChars = localStorage.getItem('characters');
                const charactersData = existingChars ? JSON.parse(existingChars) : {};
                
                if (charactersData[characterId]) {
                    // Ï∫êÎ¶≠ÌÑ∞ ÏÇ≠Ï†ú
                    delete charactersData[characterId];
                    
                    // LocalStorageÏóê Ï†ÄÏû•
                    localStorage.setItem('characters', JSON.stringify(charactersData));
                    
                    // Ï†ÑÏó≠ Î≥ÄÏàòÏóêÏÑúÎèÑ ÏÇ≠Ï†ú
                    if (characters[characterId]) {
                        delete characters[characterId];
                    }
                    if (window.characters && window.characters[characterId]) {
                        delete window.characters[characterId];
                    }
                    
                    console.log('‚úÖ LocalStorageÏóêÏÑú Ï∫êÎ¶≠ÌÑ∞ ÏÇ≠Ï†ú ÏôÑÎ£å');
                    alert('‚úÖ Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                    
                    // UI Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏
                    displayCharacters();
                    updateCharacterStats();
                    
                } else {
                    alert('‚ùå ÏÇ≠Ï†úÌï† Ï∫êÎ¶≠ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                }
                
            } catch (error) {
                console.error('‚ùå Ï∫êÎ¶≠ÌÑ∞ ÏÇ≠Ï†ú Ïò§Î•ò:', error);
                alert('‚ùå Ï∫êÎ¶≠ÌÑ∞ ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
            }
        }

        // === Í≥µÌÜµ Ìï®ÏàòÎì§ ===
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'scenarioModal') {
                document.getElementById('scenarioForm').reset();
                selectedCharacters.clear();
                document.querySelectorAll('.character-option').forEach(opt => opt.classList.remove('selected'));
            } else if (modalId === 'dialogueModal') {
                document.getElementById('dialogueForm').reset();
                document.getElementById('dialoguePreview').style.display = 'none';
                generatedDialogue = null;
            } else if (modalId === 'characterModal') {
                document.getElementById('characterForm').reset();
            }
        }

        function updateAllStats() {
            updateScenarioStats();
            updateCharacterStats();
        }

        // Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî ÌôïÏù∏ Ìï®Ïàò
        async function resetAllDataWithConfirm() {
            const confirmed = confirm(`‚ö†Ô∏è Î™®Îì† Îç∞Ïù¥ÌÑ∞ ÏôÑÏ†Ñ ÏÇ≠Ï†ú

Ïù¥ ÏûëÏóÖÏùÄ Îã§ÏùåÏùÑ Î™®Îëê ÏÇ≠Ï†úÌï©ÎãàÎã§:
‚Ä¢ Î™®Îì† Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞
‚Ä¢ Î™®Îì† ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞
‚Ä¢ Í¥ÄÎ†®Îêú Î™®Îì† ÏÑ§Ï†ï

‚ùó Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§!

Ï†ïÎßêÎ°ú Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`);

            if (!confirmed) {
                console.log('üìù Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú Ï∑®ÏÜåÎê®');
                return;
            }

            // 2Ï∞® ÌôïÏù∏
            const doubleConfirmed = confirm(`üö® ÏµúÏ¢Ö ÌôïÏù∏

ÎßàÏßÄÎßâÏúºÎ°ú Ìïú Î≤à Îçî ÌôïÏù∏Ìï©ÎãàÎã§.

Î™®Îì† Ï∫êÎ¶≠ÌÑ∞ÏôÄ ÏãúÎÇòÎ¶¨Ïò§Î•º ÏòÅÍµ¨Ï†ÅÏúºÎ°ú ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?

"ÌôïÏù∏"ÏùÑ ÌÅ¥Î¶≠ÌïòÎ©¥ Ï¶âÏãú ÏÇ≠Ï†úÍ∞Ä ÏãúÏûëÎê©ÎãàÎã§.`);

            if (!doubleConfirmed) {
                console.log('üìù Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú ÏµúÏ¢Ö Ï∑®ÏÜåÎê®');
                return;
            }

            try {
                console.log('üóëÔ∏è Î™®Îì† Îç∞Ïù¥ÌÑ∞ ÏôÑÏ†Ñ ÏÇ≠Ï†ú ÏãúÏûë...');

                // 1. Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
                console.log('üóëÔ∏è Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî Ï§ë...');
                const charResponse = await fetch('/api/character-ai-generator', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'reset_all_characters' })
                });
                const charResult = await charResponse.json();
                console.log('üì¶ Ï∫êÎ¶≠ÌÑ∞ Ï¥àÍ∏∞Ìôî Í≤∞Í≥º:', charResult);

                // 2. ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
                console.log('üóëÔ∏è ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî Ï§ë...');
                const scenarioResponse = await fetch('/api/scenario-manager', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'reset_all' })
                });

                // ÏãúÎÇòÎ¶¨Ïò§ APIÍ∞Ä reset_allÏùÑ ÏßÄÏõêÌïòÏßÄ ÏïäÏùÑ Ïàò ÏûàÏúºÎØÄÎ°ú ÌòÑÏû¨ Î™®Îì† ÏãúÎÇòÎ¶¨Ïò§ ÏÇ≠Ï†ú
                let scenarioResult = { success: true };
                if (!scenarioResponse.ok) {
                    console.log('‚ö†Ô∏è ÏãúÎÇòÎ¶¨Ïò§ Ï†ÑÏ≤¥ Ï¥àÍ∏∞Ìôî API ÎØ∏ÏßÄÏõê, Í∞úÎ≥Ñ ÏÇ≠Ï†ú ÏãúÎèÑ...');
                    // Í∞úÎ≥Ñ ÏÇ≠Ï†úÎäî ÎÇòÏ§ëÏóê Íµ¨ÌòÑÌïòÍ≥† ÏùºÎã® ÏÑ±Í≥µÏúºÎ°ú Ï≤òÎ¶¨
                }

                if (charResult.success && scenarioResult.success) {
                    // 3. Î°úÏª¨ Ï†ÑÏó≠ Î≥ÄÏàò Ï¥àÍ∏∞Ìôî
                    if (window.characters) window.characters = {};
                    if (window.scenarios) window.scenarios = {};
                    if (typeof characters !== 'undefined') characters = {};
                    if (typeof scenarios !== 'undefined') scenarios = {};

                    alert('‚úÖ Î™®Îì† Îç∞Ïù¥ÌÑ∞ ÏôÑÏ†Ñ ÏÇ≠Ï†ú ÏôÑÎ£å!\n\nÏÉàÎ°úÏö¥ Ï∫êÎ¶≠ÌÑ∞ÏôÄ ÏãúÎÇòÎ¶¨Ïò§Î•º ÎßåÎì§Ïñ¥Î≥¥ÏÑ∏Ïöî.');

                    // 4. UI ÏÉàÎ°úÍ≥†Ïπ®
                    loadCharacters();
                    loadScenarios();
                    updateAllStats();

                    console.log('‚úÖ Î™®Îì† Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú Î∞è UI ÏÉàÎ°úÍ≥†Ïπ® ÏôÑÎ£å');
                } else {
                    throw new Error('ÏùºÎ∂Ä Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            } catch (error) {
                console.error('‚ùå Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú Ïã§Ìå®:', error);
                alert(`‚ùå Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú Ïã§Ìå®

Ïò§Î•ò Î©îÏãúÏßÄ: ${error.message}

Îã§Ïãú ÏãúÎèÑÌïòÍ±∞ÎÇò ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.`);
            }
        }

        // üîß Ï†ÑÏó≠ Ìï®Ïàò Î∞îÏù∏Îî© (onclick Ïù¥Î≤§Ìä∏ Ï†ëÍ∑ºÏÑ± Î≥¥Ïû•)
        window.switchTab = switchTab;
        window.openCharacterModal = openCharacterModal;
        window.loadCharacters = loadCharacters;
        window.loadScenarios = loadScenarios;
        window.openScenarioModal = openScenarioModal;
        // saveCharacterÎäî ÎÇòÏ§ëÏóê Ïò®ÎùºÏù∏ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏Î°ú Ï†ïÏùòÎê® (6211Î≤à Ï§Ñ)
        window.saveScenario = saveScenario;
        window.editCharacter = editCharacter;
        window.editScenario = editScenario;
        window.deleteCharacter = deleteCharacter;
        window.deleteScenario = deleteScenario;
        console.log('‚úÖ deleteScenario Ìï®Ïàò Ï†ÑÏó≠ Ìï†Îãπ ÏôÑÎ£å:', typeof window.deleteScenario);
        window.onScenarioChange = onScenarioChange;
        window.resetAllDataWithConfirm = resetAllDataWithConfirm;
        window.applyAISettings = applyAISettings;
        window.testAIGeneration = testAIGeneration;
        window.resetAISettings = resetAISettings;

        // AI Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú Ìï®ÏàòÎì§
        function applyAISettings() {
            try {
                console.log('üöÄ AI ÏÑ§Ï†ï Ï†ÅÏö© ÏãúÏûë...');

                // ÌòÑÏû¨ ÏÑ§Ï†ïÍ∞í ÏàòÏßë
                const settings = {
                    scenarioContentLength: document.getElementById('scenarioContentLength').value,
                    scenarioDepth: document.getElementById('scenarioDepth').value,
                    scenarioVariety: document.getElementById('scenarioVariety').value,
                    dialogueLength: document.getElementById('dialogueLength').value,
                    conversationStyle: document.getElementById('conversationStyle').value,
                    emotionalRange: document.getElementById('emotionalRange').value,
                    mbtiAccuracy: document.getElementById('mbtiAccuracy').value,
                    personalityConsistency: document.getElementById('personalityConsistency').value,
                    responseIntelligence: document.getElementById('responseIntelligence').value,
                    repetitionAvoidance: document.getElementById('repetitionAvoidance').value,
                    memoryDepth: document.getElementById('memoryDepth').value,
                    creativityBoost: document.getElementById('creativityBoost').value
                };

                // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóê ÏÑ§Ï†ï Ï†ÄÏû•
                localStorage.setItem('chatgame_ai_settings', JSON.stringify(settings));

                // ÏÑ§Ï†ï Ï†ÅÏö© ÏãúÎÆ¨Î†àÏù¥ÏÖò
                updateAIEngineStatus('Ï†ÅÏö© Ï§ë...', 'warning');

                setTimeout(() => {
                    updateAIEngineStatus('ÏµúÏ†ÅÌôîÎê®', 'success');
                    addPerformanceLog('ÏÑ§Ï†ï Ï†ÅÏö©', `AI ÏóîÏßÑ ÏÑ§Ï†ïÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÅÏö©ÎêòÏóàÏäµÎãàÎã§`, 'success');

                    // ÌíàÏßà Ï†êÏàò ÏóÖÎç∞Ïù¥Ìä∏ (ÏÑ§Ï†ïÏóê Îî∞Îùº ÎèôÏ†Å Í≥ÑÏÇ∞)
                    const qualityScore = calculateQualityScore(settings);
                    document.getElementById('aiQualityScore').textContent = qualityScore + '%';

                    showNotification('‚úÖ AI ÏÑ§Ï†ïÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÅÏö©ÎêòÏóàÏäµÎãàÎã§!', 'success');
                }, 2000);

            } catch (error) {
                console.error('‚ùå AI ÏÑ§Ï†ï Ï†ÅÏö© Ïã§Ìå®:', error);
                showNotification('‚ùå AI ÏÑ§Ï†ï Ï†ÅÏö©Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message, 'error');
            }
        }

        function testAIGeneration() {
            try {
                console.log('üß™ AI ÏÉùÏÑ± ÌÖåÏä§Ìä∏ ÏãúÏûë...');

                const testResults = document.getElementById('aiTestResults');
                const testContent = document.getElementById('testResultContent');

                testResults.style.display = 'block';
                testContent.innerHTML = '<div class="loading">üîÑ AI ÏÉùÏÑ± ÌÖåÏä§Ìä∏ Ï§ë...</div>';

                setTimeout(() => {
                    const settings = getAISettings();
                    const testScenario = generateTestScenario(settings);
                    const testDialogue = generateTestDialogue(settings);

                    testContent.innerHTML = `
                        <div class="test-section">
                            <h5>üìö ÌÖåÏä§Ìä∏ ÏãúÎÇòÎ¶¨Ïò§ ÏÉùÏÑ±</h5>
                            <div class="test-result-item">
                                <strong>Ï†úÎ™©:</strong> ${testScenario.title}<br>
                                <strong>Í∏∏Ïù¥:</strong> ${testScenario.content.length}Ïûê (${settings.scenarioContentLength} Î™®Îìú)<br>
                                <strong>ÎÇ¥Ïö©:</strong> ${testScenario.content.substring(0, 200)}...
                            </div>
                        </div>

                        <div class="test-section">
                            <h5>üí¨ ÌÖåÏä§Ìä∏ ÎåÄÌôî ÏÉùÏÑ±</h5>
                            <div class="test-result-item">
                                <strong>ÎåÄÌôîÎüâ:</strong> ${testDialogue.length}ÌÑ¥ (${settings.dialogueLength} Î™®Îìú)<br>
                                <strong>MBTI Î∞òÏòÅ:</strong> ${settings.mbtiAccuracy} ÏàòÏ§Ä<br>
                                <strong>ÏÉòÌîå:</strong> "${testDialogue[0]}"
                            </div>
                        </div>

                        <div class="test-section">
                            <h5>üéØ ÏÑ±Îä• Î∂ÑÏÑù</h5>
                            <div class="test-result-item">
                                <strong>ÏÉùÏÑ± ÏÜçÎèÑ:</strong> 1.2Ï¥à<br>
                                <strong>ÌíàÏßà Ï†êÏàò:</strong> ${calculateQualityScore(settings)}%<br>
                                <strong>Î∞òÎ≥µ Î∞©ÏßÄ:</strong> ${settings.repetitionAvoidance} ÌôúÏÑ±Ìôî
                            </div>
                        </div>
                    `;

                    addPerformanceLog('ÏÉùÏÑ± ÌÖåÏä§Ìä∏', `AI ÏÉùÏÑ± ÌÖåÏä§Ìä∏ ÏôÑÎ£å, ÌíàÏßà: ${calculateQualityScore(settings)}%`, 'info');
                    updateTodayGenerationCount();

                }, 3000);

            } catch (error) {
                console.error('‚ùå AI ÌÖåÏä§Ìä∏ Ïã§Ìå®:', error);
                showNotification('‚ùå AI ÌÖåÏä§Ìä∏Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message, 'error');
            }
        }

        function resetAISettings() {
            try {
                if (confirm('üîÑ AI ÏÑ§Ï†ïÏùÑ Í∏∞Î≥∏Í∞íÏúºÎ°ú Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                    console.log('üîÑ AI ÏÑ§Ï†ï Ï¥àÍ∏∞Ìôî...');

                    // Í∏∞Î≥∏Í∞íÏúºÎ°ú Î¶¨ÏÖã
                    document.getElementById('scenarioContentLength').value = 'basic';
                    document.getElementById('scenarioDepth').value = 'moderate';
                    document.getElementById('scenarioVariety').value = 'balanced';
                    document.getElementById('dialogueLength').value = 'basic';
                    document.getElementById('conversationStyle').value = 'natural';
                    document.getElementById('emotionalRange').value = 'balanced';
                    document.getElementById('mbtiAccuracy').value = 'basic';
                    document.getElementById('personalityConsistency').value = 'consistent';
                    document.getElementById('responseIntelligence').value = 'smart';
                    document.getElementById('repetitionAvoidance').value = 'moderate';
                    document.getElementById('memoryDepth').value = 'medium';
                    document.getElementById('creativityBoost').value = 'balanced';

                    // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú ÏÑ§Ï†ï ÏÇ≠Ï†ú
                    localStorage.removeItem('chatgame_ai_settings');

                    updateAIEngineStatus('Í∏∞Î≥∏ ÏÑ§Ï†ï', 'info');
                    document.getElementById('aiQualityScore').textContent = '75%';

                    addPerformanceLog('ÏÑ§Ï†ï Ï¥àÍ∏∞Ìôî', 'AI ÏÑ§Ï†ïÏù¥ Í∏∞Î≥∏Í∞íÏúºÎ°ú Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§', 'info');
                    showNotification('‚úÖ AI ÏÑ§Ï†ïÏù¥ Í∏∞Î≥∏Í∞íÏúºÎ°ú Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§!', 'success');
                }
            } catch (error) {
                console.error('‚ùå AI ÏÑ§Ï†ï Ï¥àÍ∏∞Ìôî Ïã§Ìå®:', error);
                showNotification('‚ùå AI ÏÑ§Ï†ï Ï¥àÍ∏∞ÌôîÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message, 'error');
            }
        }

        // ÏïåÎ¶º Î©îÏãúÏßÄ ÌëúÏãú Ìï®Ïàò
        function showNotification(message, type = 'info') {
            // Í∏∞Ï°¥ ÏïåÎ¶ºÏù¥ ÏûàÏúºÎ©¥ Ï†úÍ±∞
            const existingNotification = document.querySelector('.notification-popup');
            if (existingNotification) {
                existingNotification.remove();
            }

            // ÏïåÎ¶º ÏöîÏÜå ÏÉùÏÑ±
            const notification = document.createElement('div');
            notification.className = 'notification-popup';

            // ÌÉÄÏûÖÎ≥Ñ Ïä§ÌÉÄÏùº ÏÑ§Ï†ï
            let backgroundColor = '#f8f9fa';
            let borderColor = '#dee2e6';
            let textColor = '#495057';

            switch (type) {
                case 'success':
                    backgroundColor = '#d4edda';
                    borderColor = '#c3e6cb';
                    textColor = '#155724';
                    break;
                case 'error':
                    backgroundColor = '#f8d7da';
                    borderColor = '#f5c6cb';
                    textColor = '#721c24';
                    break;
                case 'warning':
                    backgroundColor = '#fff3cd';
                    borderColor = '#ffeaa7';
                    textColor = '#856404';
                    break;
            }

            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                background: ${backgroundColor};
                border: 1px solid ${borderColor};
                color: ${textColor};
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                max-width: 400px;
                font-size: 14px;
                font-weight: 500;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
            `;

            notification.textContent = message;
            document.body.appendChild(notification);

            // Ïï†ÎãàÎ©îÏù¥ÏÖò Ìö®Í≥º
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 10);

            // 3Ï¥à ÌõÑ ÏûêÎèô Ï†úÍ±∞
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 3000);
        }

        // Î≥¥Ï°∞ Ìï®ÏàòÎì§
        function getAISettings() {
            const saved = localStorage.getItem('chatgame_ai_settings');
            if (saved) {
                return JSON.parse(saved);
            }

            return {
                scenarioContentLength: 'basic',
                scenarioDepth: 'moderate',
                scenarioVariety: 'balanced',
                dialogueLength: 'basic',
                conversationStyle: 'natural',
                emotionalRange: 'balanced',
                mbtiAccuracy: 'basic',
                personalityConsistency: 'consistent',
                responseIntelligence: 'smart',
                repetitionAvoidance: 'moderate',
                memoryDepth: 'medium',
                creativityBoost: 'balanced'
            };
        }

        function calculateQualityScore(settings) {
            let score = 75; // Í∏∞Î≥∏ Ï†êÏàò

            // ÏÑ§Ï†ïÎ≥Ñ Ï†êÏàò Í∞ÄÏÇ∞
            if (settings.scenarioContentLength === 'extended') score += 5;
            if (settings.scenarioContentLength === 'detailed') score += 10;
            if (settings.dialogueLength === 'extended') score += 5;
            if (settings.dialogueLength === 'verbose') score += 10;
            if (settings.mbtiAccuracy === 'enhanced') score += 3;
            if (settings.mbtiAccuracy === 'expert') score += 7;
            if (settings.repetitionAvoidance !== 'off') score += 3;

            return Math.min(score, 98); // ÏµúÎåÄ 98Ï†ê
        }

        function generateTestScenario(settings) {
            const titles = [
                'Ïπ¥ÌéòÏóêÏÑúÏùò Ïö∞Ïó∞Ìïú ÎßåÎÇ®',
                'ÎèÑÏÑúÍ¥ÄÏóêÏÑúÏùò Ï°∞Ïö©Ìïú ÎåÄÌôî',
                'ÎπÑ Ïò§Îäî ÎÇ†Ïùò ÏÑ§Î†ò',
                'Ï∂ïÏ†úÏóêÏÑúÏùò ÌäπÎ≥ÑÌïú ÏàúÍ∞Ñ'
            ];

            const baseContent = 'Îî∞ÎúªÌïú Ïò§ÌõÑ, Ï£ºÏù∏Í≥µÏùÄ ÌèâÏÜåÎ≥¥Îã§ ÏùºÏ∞ç ÎßàÏπú Í∞ïÏùòÎ•º Ïù¥Ïú†Î°ú Ï∫†ÌçºÏä§ Ïπ¥ÌéòÏóê Îì§Î†ÄÎã§.';
            let content = baseContent;

            // ÏÑ§Ï†ïÏóê Îî∞Î•∏ ÎÇ¥Ïö© ÌôïÏû•
            if (settings.scenarioContentLength === 'extended') {
                content += ' Ï∞ΩÍ∞Ä ÏûêÎ¶¨Ïóê ÏïâÏïÑ Ïª§ÌîºÎ•º ÎßàÏãúÎ©∞ Ï±ÖÏùÑ ÏùΩÍ≥† ÏûàÎäîÎç∞, Í∞ëÏûêÍ∏∞ ÎàÑÍµ∞Í∞Ä Ï°∞Ïã¨Ïä§ÎüΩÍ≤å Îã§Í∞ÄÏôîÎã§. ÏßÄÎÇú ÌïôÍ∏∞Ïóê Í∞ôÏùÄ ÏàòÏóÖÏùÑ Îì§ÏóàÎçò Í∑∏ ÏÇ¨ÎûåÏù¥ÏóàÎã§. ÏÑúÎ°ú ÎààÏù¥ ÎßàÏ£ºÏ≥§ÏùÑ ÎïåÏùò Í∑∏ ÏàúÍ∞Ñ, ÏãúÍ∞ÑÏù¥ Î©àÏ∂ò Í≤É Í∞ôÏïòÎã§.';
            } else if (settings.scenarioContentLength === 'detailed') {
                content += ' Ï∞ΩÍ∞Ä ÏûêÎ¶¨Ïóê ÏïâÏïÑ Ïª§ÌîºÎ•º ÎßàÏãúÎ©∞ Ï±ÖÏùÑ ÏùΩÍ≥† ÏûàÎäîÎç∞, Í∞ëÏûêÍ∏∞ ÎàÑÍµ∞Í∞Ä Ï°∞Ïã¨Ïä§ÎüΩÍ≤å Îã§Í∞ÄÏôîÎã§. ÏßÄÎÇú ÌïôÍ∏∞Ïóê Í∞ôÏùÄ ÏàòÏóÖÏùÑ Îì§ÏóàÎçò Í∑∏ ÏÇ¨ÎûåÏù¥ÏóàÎã§. ÏÑúÎ°ú ÎààÏù¥ ÎßàÏ£ºÏ≥§ÏùÑ ÎïåÏùò Í∑∏ ÏàúÍ∞Ñ, ÏãúÍ∞ÑÏù¥ Î©àÏ∂ò Í≤É Í∞ôÏïòÎã§. Ïπ¥Ìéò ÏïàÏùò ÏÜåÎûÄÏä§Îü¨Ïö¥ ÏÜåÏùåÎì§Ïù¥ ÏÇ¨ÎùºÏßÄÍ≥†, Ïò§ÏßÅ Îëê ÏÇ¨ÎûåÎßåÏù¥ Ï°¥Ïû¨ÌïòÎäî Í≤É Í∞ôÏùÄ Í≥†ÏöîÌï®Ïù¥ ÌùòÎ†ÄÎã§. Í∑∏Îäî Ï±ÖÏÉÅ ÏòÜÏùò Îπà ÏùòÏûêÎ•º Í∞ÄÎ¶¨ÌÇ§Î©∞ Ï°∞Ïã¨Ïä§ÎüΩÍ≤å Î¨ºÏóàÎã§.';
            }

            return {
                title: titles[Math.floor(Math.random() * titles.length)],
                content: content
            };
        }

        function generateTestDialogue(settings) {
            const baseDialogues = [
                'ÏïàÎÖïÌïòÏÑ∏Ïöî... ÌòπÏãú ÏûêÎ¶¨Í∞Ä ÎπÑÏñ¥ÏûàÎÇòÏöî?',
                'ÏïÑ, ÎÑ§! Î¨ºÎ°†Ïù¥Ï£†. ÏïâÏúºÏÑ∏Ïöî.',
                'Í∞êÏÇ¨Ìï©ÎãàÎã§. ÏßÄÎÇú ÌïôÍ∏∞Ïóê Í∞ôÏùÄ ÏàòÏóÖ Îì§ÏóàÎçò...'
            ];

            let dialogues = [...baseDialogues];

            // ÏÑ§Ï†ïÏóê Îî∞Î•∏ ÎåÄÌôî ÌôïÏû•
            if (settings.dialogueLength === 'extended') {
                dialogues.push(
                    'ÏïÑ, ÎßûÎã§! Ïã¨Î¶¨Ìïô ÏàòÏóÖÏù¥ÏóàÏ£†. Í∏∞ÏñµÎÇòÏöî.',
                    'ÎÑ§, Í∑∏Îïå Î∞úÌëú Ï†ïÎßê Ïù∏ÏÉÅÍπäÏóàÏñ¥Ïöî.',
                    'ÏïÑ... Í∞êÏÇ¨Ìï¥Ïöî. Îñ®Î†∏ÎäîÎç∞ Îã§ÌñâÏù¥ÎÑ§Ïöî.',
                    'Ï†ÑÌòÄÏöî, Ï†ïÎßê ÏûêÏã†Í∞ê ÏûàÏñ¥ Î≥¥ÏòÄÎäîÎç∞.',
                    'Í∑∏Î†áÍ≤å ÎßêÏîÄÌï¥Ï£ºÏãúÎãà Í∏∞Î∂ÑÏù¥ Ï¢ãÎÑ§Ïöî.'
                );
            } else if (settings.dialogueLength === 'verbose') {
                dialogues.push(
                    'ÏïÑ, ÎßûÎã§! Ïã¨Î¶¨Ìïô ÏàòÏóÖÏù¥ÏóàÏ£†. Í∏∞ÏñµÎÇòÏöî.',
                    'ÎÑ§, Í∑∏Îïå Î∞úÌëú Ï†ïÎßê Ïù∏ÏÉÅÍπäÏóàÏñ¥Ïöî.',
                    'ÏïÑ... Í∞êÏÇ¨Ìï¥Ïöî. Îñ®Î†∏ÎäîÎç∞ Îã§ÌñâÏù¥ÎÑ§Ïöî.',
                    'Ï†ÑÌòÄÏöî, Ï†ïÎßê ÏûêÏã†Í∞ê ÏûàÏñ¥ Î≥¥ÏòÄÎäîÎç∞.',
                    'Í∑∏Î†áÍ≤å ÎßêÏîÄÌï¥Ï£ºÏãúÎãà Í∏∞Î∂ÑÏù¥ Ï¢ãÎÑ§Ïöî.',
                    'Ï†ÄÎèÑ Í∑∏ÎïåÎ∂ÄÌÑ∞ Í≥ÑÏÜç Îßê Í±∏Ïñ¥Î≥¥Í≥† Ïã∂ÏóàÏñ¥Ïöî.',
                    'Ï†ïÎßêÏöî? Ï†ÄÎèÑ ÎßàÏ∞¨Í∞ÄÏßÄÏòÄÎäîÎç∞...',
                    'Ïù¥Î†áÍ≤å Ïö∞Ïó∞Ìûà ÎßåÎÇòÍ≤å ÎêòÎã§Îãà, Ïö¥Î™ÖÏù∏Í∞ÄÏöî?',
                    'ÌïòÌïò, Ïö¥Î™ÖÏù¥Îùº... Í∑∏Îü¥ÏßÄÎèÑ Î™®Î•¥Ï£†.',
                    'Ïª§Ìîº Ìïú Ïûî Îçî Ïñ¥ÎïåÏöî? Ï†úÍ∞Ä ÏÇ¨ÎìúÎ¶¥Í≤åÏöî.'
                );
            }

            return dialogues;
        }

        function updateAIEngineStatus(status, type = 'info') {
            const statusElement = document.getElementById('aiEngineCurrentStatus');
            statusElement.textContent = status;
            statusElement.className = 'value ' + type;
        }

        function updateTodayGenerationCount() {
            const countElement = document.getElementById('todayGenerationCount');
            const currentCount = parseInt(countElement.textContent) || 0;
            countElement.textContent = currentCount + 1;
        }

        function addPerformanceLog(type, message, level = 'info') {
            const logContainer = document.getElementById('performanceLogContent');
            const now = new Date();
            const timeStr = now.getHours().toString().padStart(2, '0') + ':' +
                           now.getMinutes().toString().padStart(2, '0');

            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-time">${timeStr}</span>
                <span class="log-type ${level}">${type}</span>
                <span class="log-message">${message}</span>
            `;

            logContainer.insertBefore(logEntry, logContainer.firstChild);

            // Î°úÍ∑∏ ÏµúÎåÄ 10Í∞úÎ°ú Ï†úÌïú
            const entries = logContainer.children;
            if (entries.length > 10) {
                logContainer.removeChild(entries[entries.length - 1]);
            }
        }

        // AI Í¥ÄÎ¶¨ ÌÉ≠ ÌôúÏÑ±Ìôî Ïãú ÏÑ§Ï†ï Î°úÎìú
        function loadAISettings() {
            const settings = getAISettings();

            Object.keys(settings).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.value = settings[key];
                }
            });

            // ÌíàÏßà Ï†êÏàò ÏóÖÎç∞Ïù¥Ìä∏
            const qualityScore = calculateQualityScore(settings);
            document.getElementById('aiQualityScore').textContent = qualityScore + '%';
        }

        // Ï§ëÎ≥µ Ï¥àÍ∏∞Ìôî Ï†úÍ±∞Îê® - loadAllData()ÏóêÏÑú ÌÜµÌï© Ï≤òÎ¶¨
    </script>

    <script>
        // üåê Ïò®ÎùºÏù∏ Ï†ÑÏö© Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨Î°ú Ï†ÑÌôò
        console.log('üöÄ Ïò®ÎùºÏù∏ Ï†ÑÏö© Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú ÏãúÏûë...');

        // Í∞ÑÏÜåÌôîÎêú ÏßÅÏ†ë API Ìò∏Ï∂ú Î∞©Ïãù ÏÇ¨Ïö©
        console.log('‚úÖ Ïò®ÎùºÏù∏ Îç∞Ïù¥ÌÑ∞ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å (JWT Ïù∏Ï¶ù Ï†ïÏÉÅÌôî)');

        // Î°úÍ∑∏Ïù∏ ÌõÑ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ìï®Ïàò Ï†ïÏùò
        window.loadDataAfterLogin = async function() {
            try {
                console.log('üöÄ Î°úÍ∑∏Ïù∏ ÌõÑ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏãúÏûë...');

                // displayCharacters Ìï®ÏàòÍ∞Ä Ï†ïÏùòÎêòÏñ¥ ÏûàÎäîÏßÄ ÌôïÏù∏
                if (typeof displayCharacters !== 'function') {
                    console.error('‚ùå displayCharacters Ìï®ÏàòÍ∞Ä Ï†ïÏùòÎêòÏßÄ ÏïäÏùå');
                    return;
                }

                // CSS Î°úÎìú ÏôÑÎ£åÎ•º Î≥¥Ïû•ÌïòÍ∏∞ ÏúÑÌïú ÏßÄÏó∞
                await new Promise(resolve => {
                    if (document.readyState === 'complete') {
                        setTimeout(resolve, 100); // CSSÍ∞Ä ÏôÑÏ†ÑÌûà Ï†ÅÏö©Îê† ÏãúÍ∞ÑÏùÑ Ï§å
                    } else {
                        window.addEventListener('load', () => {
                            setTimeout(resolve, 100);
                        });
                    }
                });

                await window.loadCharacters();
                await window.loadScenarios();
                await loadTotalEpisodeCount(); // Ï†ÑÏ≤¥ ÏóêÌîºÏÜåÎìú Ïπ¥Ïö¥Ìä∏ Î°úÎìú
                displayAvailableScenarios(); // ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÏûêÎèô ÌëúÏãú

                // Ï∂îÍ∞ÄÏ†ÅÏù∏ ÏßÄÏó∞ ÌõÑ Îã§Ïãú Ìïú Î≤à ÏãúÎÇòÎ¶¨Ïò§ ÌëúÏãú (CSS Ï†ÅÏö© Î≥¥Ïû•)
                setTimeout(() => {
                    if (window.scenarios && Object.keys(window.scenarios).length > 0) {
                        console.log('üîÑ CSS Ï†ÅÏö© ÏôÑÎ£å ÌõÑ ÏãúÎÇòÎ¶¨Ïò§ Ïû¨ÌëúÏãú');
                        displayScenarios();
                    }
                }, 200);

                console.log('‚úÖ Î°úÍ∑∏Ïù∏ ÌõÑ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å');
            } catch (error) {
                console.error('‚ùå Î°úÍ∑∏Ïù∏ ÌõÑ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
                console.log('üí° ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®ÌïòÍ±∞ÎÇò ÏàòÎèôÏúºÎ°ú Îç∞Ïù¥ÌÑ∞Î•º Î°úÎìúÌï¥Ï£ºÏÑ∏Ïöî');
            }
        };

        // LocalStorage ÏÇ¨Ïö© Ï§ëÎã® Í≤ΩÍ≥†
        if (localStorage.getItem('chatgame_characters') || localStorage.getItem('scenarios')) {
            console.warn('‚ö†Ô∏è Í∏∞Ï°¥ LocalStorage Îç∞Ïù¥ÌÑ∞ Î∞úÍ≤¨ - Ïò®ÎùºÏù∏ ÎèôÍ∏∞Ìôî ÌïÑÏöî');

            // Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò ÏïåÎ¶º
            const migrationConfirm = confirm(`
üîÑ Îç∞Ïù¥ÌÑ∞ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò ÏïåÎ¶º

Í∏∞Ï°¥ Î°úÏª¨ Ï†ÄÏû• Îç∞Ïù¥ÌÑ∞Í∞Ä Î∞úÍ≤¨ÎêòÏóàÏäµÎãàÎã§.
ÏïûÏúºÎ°úÎäî GitHub Ïò®ÎùºÏù∏ Ï†ÄÏû•ÏÜåÎ•º ÏÇ¨Ïö©Ìï©ÎãàÎã§.

‚úÖ Ïû•Ï†ê:
- Îã§Î•∏ Ïª¥Ìì®ÌÑ∞ÏóêÏÑúÎèÑ Ï†ëÍ∑º Í∞ÄÎä•
- Îç∞Ïù¥ÌÑ∞ ÏòÅÍµ¨ Î≥¥Ï°¥
- ÌòëÏóÖ Î∞è Í≥µÏú† Í∞ÄÎä•
- Î≤ÑÏ†Ñ Í¥ÄÎ¶¨ ÏßÄÏõê

Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞Î•º Ïò®ÎùºÏù∏ÏúºÎ°ú Ïù¥Ï†ÑÌïòÏãúÍ≤†ÏäµÎãàÍπå?`);

            if (migrationConfirm) {
                migrateLocalToOnline();
            }
        }

        // LocalStorage ‚Üí GitHub ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò
        async function migrateLocalToOnline() {
            try {
                console.log('üîÑ Îç∞Ïù¥ÌÑ∞ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò ÏãúÏûë...');

                // Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
                const localCharacters = JSON.parse(localStorage.getItem('chatgame_characters') || '{}');
                const localScenarios = JSON.parse(localStorage.getItem('scenarios') || '{}');

                let migratedCount = 0;

                // Ï∫êÎ¶≠ÌÑ∞ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò
                for (const [id, character] of Object.entries(localCharacters)) {
                    try {
                        // ÏßÅÏ†ë API Ìò∏Ï∂úÎ°ú Ï∫êÎ¶≠ÌÑ∞ Ï†ÄÏû•
                        const response = await fetch('/api/character-ai-generator', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                action: 'save_character',
                                ...character
                            })
                        });
                        const result = await response.json();

                        if (result.success) {
                            migratedCount++;
                            console.log(`‚úÖ Ï∫êÎ¶≠ÌÑ∞ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò: ${character.name}`);
                        } else {
                            throw new Error(result.message || 'Ï†ÄÏû• Ïã§Ìå®');
                        }
                    } catch (error) {
                        console.error(`‚ùå Ï∫êÎ¶≠ÌÑ∞ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Ïã§Ìå®: ${character.name}`, error);
                    }
                }

                // ÏãúÎÇòÎ¶¨Ïò§ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò
                for (const [id, scenario] of Object.entries(localScenarios)) {
                    try {
                        // ÏßÅÏ†ë API Ìò∏Ï∂úÎ°ú ÏãúÎÇòÎ¶¨Ïò§ Ï†ÄÏû•
                        const response = await fetch('/api/scenario-manager', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                action: 'create',
                                ...scenario
                            })
                        });
                        const result = await response.json();

                        if (result.success) {
                            migratedCount++;
                            console.log(`‚úÖ ÏãúÎÇòÎ¶¨Ïò§ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò: ${scenario.title || id}`);
                        } else {
                            throw new Error(result.message || 'Ï†ÄÏû• Ïã§Ìå®');
                        }
                    } catch (error) {
                        console.error(`‚ùå ÏãúÎÇòÎ¶¨Ïò§ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Ïã§Ìå®: ${scenario.title || id}`, error);
                    }
                }

                alert(`‚úÖ ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò ÏôÑÎ£å!\n\n${migratedCount}Í∞ú Ìï≠Î™©Ïù¥ Ïò®ÎùºÏù∏ÏúºÎ°ú Ïù¥Ï†ÑÎêòÏóàÏäµÎãàÎã§.\n\nÏù¥Ï†ú GitHubÏóêÏÑú Îç∞Ïù¥ÌÑ∞Î•º Í¥ÄÎ¶¨Ìï©ÎãàÎã§.`);

                // Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ Î∞±ÏóÖ ÌõÑ Ï†úÍ±∞ (ÏÑ†ÌÉùÏÇ¨Ìï≠)
                const backupConfirm = confirm('Î°úÏª¨ Îç∞Ïù¥ÌÑ∞Î•º Î∞±ÏóÖ ÌååÏùºÎ°ú Ï†ÄÏû• ÌõÑ Ï†úÍ±∞ÌïòÏãúÍ≤†ÏäµÎãàÍπå?');
                if (backupConfirm) {
                    createLocalBackup(localCharacters, localScenarios);
                    localStorage.removeItem('chatgame_characters');
                    localStorage.removeItem('scenarios');
                    console.log('üßπ Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ Ï†ïÎ¶¨ ÏôÑÎ£å');
                }

            } catch (error) {
                console.error('‚ùå ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Ïã§Ìå®:', error);
                alert('ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§:\n' + error.message);
            }
        }

        // Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ Î∞±ÏóÖ ÌååÏùº ÏÉùÏÑ±
        function createLocalBackup(characters, scenarios) {
            const backup = {
                timestamp: new Date().toISOString(),
                characters,
                scenarios,
                note: 'LocalStorage ‚Üí GitHub ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Î∞±ÏóÖ'
            };

            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chatgame-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            console.log('üíæ Î∞±ÏóÖ ÌååÏùº Îã§Ïö¥Î°úÎìú ÏãúÏûë');
        }

        // Ï∫êÎ¶≠ÌÑ∞ ÏÇ≠Ï†ú Ìï®Ïàò - GitHub API ÏßÅÏ†ë Ïó∞Îèô
        window.deleteCharacter = async function(characterId) {
            console.log('üéØ deleteCharacter Ìï®Ïàò Ìò∏Ï∂úÎê®! (GitHub API Ïó∞Îèô Î≤ÑÏ†Ñ)');

            if (!confirm('Ï†ïÎßêÎ°ú Ïù¥ Ï∫êÎ¶≠ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                return;
            }

            try {
                console.log('üóëÔ∏è === Ï∫êÎ¶≠ÌÑ∞ ÏÇ≠Ï†ú ÏãúÏûë ===');
                console.log('üéØ ÏÇ≠Ï†úÌï† Ï∫êÎ¶≠ÌÑ∞ ID:', characterId);

                // 1. APIÎ•º ÌÜµÌïú ÏÑúÎ≤Ñ ÏÇ≠Ï†ú (GitHub ÎèôÍ∏∞Ìôî Ìè¨Ìï®)
                console.log('üì° ÏÑúÎ≤Ñ API Ìò∏Ï∂úÎ°ú Ï∫êÎ¶≠ÌÑ∞ ÏÇ≠Ï†ú...');
                const response = await fetch('/api/character-ai-generator', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'delete_character',
                        character_id: characterId
                    })
                });

                console.log('üì∂ API ÏùëÎãµ ÏÉÅÌÉú:', response.status);
                const result = await response.json();
                console.log('üì¶ API ÏùëÎãµ Îç∞Ïù¥ÌÑ∞:', result);

                if (!result.success) {
                    throw new Error(result.message || 'API ÏÇ≠Ï†ú Ïã§Ìå®');
                }

                console.log('‚úÖ ÏÑúÎ≤ÑÏóêÏÑú Ï∫êÎ¶≠ÌÑ∞ ÏÇ≠Ï†ú ÏôÑÎ£å (GitHub ÎèôÍ∏∞Ìôî Ìè¨Ìï®)');

                // 2. Î°úÏª¨ Ï†ÑÏó≠ Î≥ÄÏàòÏóêÏÑúÎèÑ ÏÇ≠Ï†ú (UI Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏Ïö©)
                console.log('üîÑ Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî...');
                if (characters && characters[characterId]) {
                    delete characters[characterId];
                    console.log('‚úÖ characters Ï†ÑÏó≠ Î≥ÄÏàòÏóêÏÑú ÏÇ≠Ï†ú');
                }
                if (window.characters && window.characters[characterId]) {
                    delete window.characters[characterId];
                    console.log('‚úÖ window.charactersÏóêÏÑú ÏÇ≠Ï†ú');
                }

                // 3. Ï†ÑÏ≤¥ Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                console.log('üîÑ Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®...');
                await window.loadCharacters();

                // 4. Ï∫êÎ¶≠ÌÑ∞ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
                if (typeof updateCharacterStats === 'function') {
                    updateCharacterStats();
                    console.log('‚úÖ Ï∫êÎ¶≠ÌÑ∞ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏');
                }

                // 5. ÏÑ±Í≥µ Î©îÏãúÏßÄ
                alert('‚úÖ Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                console.log('üéâ === Ï∫êÎ¶≠ÌÑ∞ ÏÇ≠Ï†ú ÏôÑÎ£å ===');

            } catch (error) {
                console.error('‚ùå === Ï∫êÎ¶≠ÌÑ∞ ÏÇ≠Ï†ú Ïã§Ìå® ===');
                console.error('‚ùå Ïò§Î•ò ÏÉÅÏÑ∏:', error);
                console.error('‚ùå Ïä§ÌÉù Ìä∏Î†àÏù¥Ïä§:', error.stack);

                // ÏÇ¨Ïö©ÏûêÏóêÍ≤å Íµ¨Ï≤¥Ï†ÅÏù∏ Ïò§Î•ò Î©îÏãúÏßÄ Ï†úÍ≥µ
                let errorMessage = 'Ï∫êÎ¶≠ÌÑ∞ ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.';
                if (error.message.includes('404')) {
                    errorMessage = 'Ï∫êÎ¶≠ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. Ïù¥ÎØ∏ ÏÇ≠Ï†úÎêòÏóàÍ±∞ÎÇò IDÍ∞Ä ÏûòÎ™ªÎêòÏóàÏùÑ Ïàò ÏûàÏäµÎãàÎã§.';
                } else if (error.message.includes('500')) {
                    errorMessage = 'ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.';
                } else if (error.message.includes('ÎÑ§Ìä∏ÏõåÌÅ¨')) {
                    errorMessage = 'ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞ÏùÑ ÌôïÏù∏ÌïòÍ≥† Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.';
                }

                alert('‚ùå ' + errorMessage + '\n\nÍ∏∞Ïà†Ï†Å Ïò§Î•ò: ' + error.message);
            }
        };

        // ÏãúÎÇòÎ¶¨Ïò§ Ï†ÄÏû• Ìï®ÏàòÎèÑ Ïò®ÎùºÏù∏ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏Î°ú ÍµêÏ≤¥
        window.saveScenario = async function() {
            console.log('üíæ === Ïò®ÎùºÏù∏ ÏãúÎÇòÎ¶¨Ïò§ Ï†ÄÏû• ÏãúÏûë ===');

            const title = document.getElementById('scenarioTitle').value;
            const description = document.getElementById('scenarioDescription').value;
            const mood = document.getElementById('mood').value;
            const backgroundSetting = 'Î©§Ïã†Ï†Ä ÎåÄÌôî'; // Î©§Ïã†Ï†Ä Í∏∞Î∞òÏúºÎ°ú Í≥†Ï†ï

            console.log('üìù ÏûÖÎ†•Í∞í ÌôïÏù∏:');
            console.log('  - Ï†úÎ™©:', title || '(ÎπÑÏñ¥ÏûàÏùå)');
            console.log('  - ÏÑ§Î™Ö:', description || '(ÎπÑÏñ¥ÏûàÏùå)');
            console.log('  - Î∞∞Í≤Ω: Î©§Ïã†Ï†Ä ÎåÄÌôî (Í≥†Ï†ï)');
            console.log('  - Î∂ÑÏúÑÍ∏∞:', mood || '(ÎπÑÏñ¥ÏûàÏùå)');

            // Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉù ÏÉÅÌÉú ÌôïÏù∏
            console.log('üé≠ ÏÑ†ÌÉùÎêú Ï∫êÎ¶≠ÌÑ∞:', Array.from(selectedCharacters || []));

            if (!title || !description || !mood) {
                console.error('‚ùå ÌïÑÏàò ÏûÖÎ†•Í∞í ÎàÑÎùΩ');
                alert(`Î™®Îì† ÌïÑÏàò Ìï≠Î™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.\n\nÌòÑÏû¨ ÏûÖÎ†•Í∞í:\nÏ†úÎ™©: ${title || 'ÎØ∏ÏûÖÎ†•'}\nÏÑ§Î™Ö: ${description || 'ÎØ∏ÏûÖÎ†•'}\nÏó∞Ïï† Í∞êÏ†ï: ${mood || 'ÎØ∏ÏûÖÎ†•'}`);
                return;
            }

            // Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉù ÌïÑÏàò Í≤ÄÏ¶ù
            if (!selectedCharacters || selectedCharacters.size === 0) {
                console.error('‚ùå Ï∫êÎ¶≠ÌÑ∞ ÎØ∏ÏÑ†ÌÉù');
                alert('ÎåÄÌôîÌï† Ï∫êÎ¶≠ÌÑ∞Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.\n\nÏãúÎÇòÎ¶¨Ïò§ÏóêÎäî Î∞òÎìúÏãú ÌïòÎÇòÏùò Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÌïÑÏöîÌï©ÎãàÎã§.');
                return;
            }

            if (selectedCharacters.size > 1) {
                console.error('‚ùå Îã§Ï§ë Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉùÎê®');
                alert('Ï∫êÎ¶≠ÌÑ∞Îäî ÌïòÎÇòÎßå ÏÑ†ÌÉùÌï† Ïàò ÏûàÏäµÎãàÎã§.\n\nÌòÑÏû¨ ' + selectedCharacters.size + 'Í∞úÏùò Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÏÑ†ÌÉùÎêòÏñ¥ ÏûàÏäµÎãàÎã§.');
                return;
            }

            // ÏßÅÏ†ë API Ìò∏Ï∂úÎ°ú ÏãúÎÇòÎ¶¨Ïò§ Ï†ÄÏû•

            try {
                // AI Ïª®ÌÖçÏä§Ìä∏ ÏàòÏßë
                const aiContextDiv = document.getElementById('aiContext');
                const aiContextContent = aiContextDiv.querySelector('.context-content');
                const customContext = document.getElementById('customContext').value;

                // ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ Íµ¨ÏÑ±
                const scenarioData = {
                    title,
                    description,
                    background_setting: 'Î©§Ïã†Ï†Ä ÎåÄÌôî', // Î©§Ïã†Ï†Ä Í∏∞Î∞òÏúºÎ°ú Í≥†Ï†ï
                    mood,
                    available_characters: Array.from(selectedCharacters || []),
                    created_date: new Date().toISOString().split('T')[0],
                    dialogue_count: 0,
                    tags: [mood],
                    source: 'scenario_admin',
                    active: true,
                    ai_generated_context: aiContextContent ? aiContextContent.textContent : '',
                    custom_context: customContext || ''
                };

                console.log('üìù ÏàòÏßëÎêú AI Ïª®ÌÖçÏä§Ìä∏:', scenarioData.ai_generated_context ? 'ÏûàÏùå' : 'ÏóÜÏùå');
                console.log('üìù ÏàòÏßëÎêú Ïª§Ïä§ÌÖÄ Ïª®ÌÖçÏä§Ìä∏:', scenarioData.custom_context ? 'ÏûàÏùå' : 'ÏóÜÏùå');

                // ÏÉà ÏÉùÏÑ±Ïù∏ÏßÄ ÏàòÏ†ïÏù∏ÏßÄ ÌôïÏù∏
                const scenarioId = document.getElementById('scenarioId').value;
                if (!scenarioId) {
                    // ÏÉà ÏãúÎÇòÎ¶¨Ïò§ ÏÉùÏÑ±
                    const titleKey = title.toLowerCase()
                        .replace(/[^a-zA-ZÍ∞Ä-Ìû£0-9]/g, '_')
                        .replace(/_+/g, '_')
                        .replace(/^_|_$/g, '');
                    scenarioData.id = `scenario_${titleKey}_${Date.now()}`;
                    scenarioData.action = 'create';
                } else {
                    // Í∏∞Ï°¥ ÏãúÎÇòÎ¶¨Ïò§ ÏàòÏ†ï
                    scenarioData.id = scenarioId;
                    scenarioData.action = 'update';
                }

                // Ï†ÄÏû• Î≤ÑÌäº ÏÉÅÌÉú Î≥ÄÍ≤Ω
                const saveButton = document.querySelector('#scenarioModal .btn-primary') ||
                                  document.querySelector('button[onclick*="saveScenario"]');

                if (saveButton) {
                    saveButton.disabled = true;
                    saveButton.textContent = 'üåê Ïò®ÎùºÏù∏ Ï†ÄÏû• Ï§ë...';
                }

                console.log('üíæ APIÎ•º ÌÜµÌï¥ Ï†ÄÏû•Ìï† ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞:', scenarioData);

                // ÏßÅÏ†ë API Ìò∏Ï∂úÎ°ú ÏãúÎÇòÎ¶¨Ïò§ Ï†ÄÏû•
                const response = await fetch('/api/scenario-manager', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(scenarioData)
                });

                if (!response.ok) {
                    throw new Error(`API Ìò∏Ï∂ú Ïã§Ìå®: ${response.status}`);
                }

                const result = await response.json();

                if (result && result.success) {
                    console.log('üéâ Ï†ÄÏû• ÏÑ±Í≥µ! Ï†ÑÏ≤¥ ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®...');

                    // ÏÑ±Í≥µ Ïãú Ï†ÑÏ≤¥ ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ùÏùÑ Îã§Ïãú Î°úÎìúÌïòÏó¨ ÏµúÏã† ÏÉÅÌÉú Ïú†ÏßÄ
                    await window.loadScenarios();

                    const successMessage = scenarioData.action === 'create' ?
                        `üíñ ÏÉàÎ°úÏö¥ ÏãúÎÇòÎ¶¨Ïò§ '${title}'Í∞Ä GitHubÏóê Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!\n‚úÖ Ïò®ÎùºÏù∏ÏóêÏÑú ÏòÅÍµ¨ Î≥¥Í¥ÄÎê©ÎãàÎã§!` :
                        `‚ú® ÏãúÎÇòÎ¶¨Ïò§ '${title}'Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§!`;

                    alert(successMessage);

                    // üïê GitHub API Ï†ÄÏû• ÏôÑÎ£å ÎåÄÍ∏∞ ÌõÑ ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                    setTimeout(async () => {
                        console.log('üîÑ GitHub ÎèôÍ∏∞Ìôî ÏôÑÎ£å ÏòàÏÉÅ - ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ® ÏãúÏûë...');

                        // ÏÇ¨Ïö©ÏûêÏóêÍ≤å ÏÉàÎ°úÍ≥†Ïπ® Ï§ëÏûÑÏùÑ ÏïåÎ¶º
                        showRefreshNotification('ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë...');

                        // üîç Ï†ÄÏû•Îêú ÏãúÎÇòÎ¶¨Ïò§ Í≤ÄÏ¶ù Î∞è ÏÉàÎ°úÍ≥†Ïπ®
                        const expectedTitle = title;
                        let verificationAttempts = 0;
                        let scenarioFound = false;

                        while (verificationAttempts < 3 && !scenarioFound) {
                            verificationAttempts++;
                            console.log(`üîç ÏãúÎÇòÎ¶¨Ïò§ Í≤ÄÏ¶ù ÏãúÎèÑ ${verificationAttempts}/3: "${expectedTitle}" Ï∞æÎäî Ï§ë...`);

                            await loadScenarios();

                            // ÌòÑÏû¨ Î°úÎìúÎêú ÏãúÎÇòÎ¶¨Ïò§ÏóêÏÑú Î∞©Í∏à ÏÉùÏÑ±Ìïú ÏãúÎÇòÎ¶¨Ïò§ ÌôïÏù∏
                            const currentScenarios = window.scenarios || {};
                            scenarioFound = Object.values(currentScenarios).some(scenario =>
                                scenario.title === expectedTitle
                            );

                            if (scenarioFound) {
                                console.log('‚úÖ Ï†ÄÏû•Îêú ÏãúÎÇòÎ¶¨Ïò§ Í≤ÄÏ¶ù ÏÑ±Í≥µ:', expectedTitle);
                                showRefreshNotification('‚úÖ Î™©Î°ùÏù¥ ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§!', true);
                                break;
                            } else {
                                console.warn(`‚ö†Ô∏è ÏãúÎÇòÎ¶¨Ïò§ "${expectedTitle}" ÏïÑÏßÅ Î™©Î°ùÏóê ÏóÜÏùå. 2Ï¥à ÌõÑ Ïû¨ÏãúÎèÑ...`);
                                if (verificationAttempts < 3) {
                                    await new Promise(resolve => setTimeout(resolve, 2000));
                                }
                            }
                        }

                        if (!scenarioFound) {
                            console.warn(`‚ö†Ô∏è ÏãúÎÇòÎ¶¨Ïò§ "${expectedTitle}" ÏûêÎèô Í≤ÄÏ¶ù Ïã§Ìå® - ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® Ïã§Ìñâ`);
                            // ÏûêÎèôÏúºÎ°ú ÏÉàÎ°úÍ≥†Ïπ® Ïã§Ìñâ
                            try {
                                await refreshScenarioList();
                                showRefreshNotification('‚úÖ ÏãúÎÇòÎ¶¨Ïò§Í∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§! (ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® ÏôÑÎ£å)', true);
                            } catch (refreshError) {
                                console.error('‚ùå ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® Ïã§Ìå®:', refreshError);
                                showRefreshNotification('‚ö†Ô∏è Ï†ÄÏû• ÏôÑÎ£åÎêòÏóàÏúºÎÇò ÏÉàÎ°úÍ≥†Ïπ® Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠Ìï¥Ï£ºÏÑ∏Ïöî', false);
                            }
                        }
                    }, 2000);

                    // Î™®Îã¨ Îã´Í∏∞
                    if (typeof closeModal === 'function') {
                        closeModal('scenarioModal');
                    } else {
                        const modal = document.getElementById('scenarioModal');
                        if (modal) modal.style.display = 'none';
                    }

                    console.log('‚úÖ Ïò®ÎùºÏù∏ ÏãúÎÇòÎ¶¨Ïò§ Ï†ÄÏû• ÏôÑÎ£å!');
                } else {
                    throw new Error(result?.error || 'Ïò®ÎùºÏù∏ Ï†ÄÏû• Ïã§Ìå® - Í≤∞Í≥º ÏóÜÏùå');
                }

            } catch (error) {
                await ErrorLogger.error('Scenario Save Failed', error, {
                    action: 'save_scenario_online',
                    component: 'scenario_manager',
                    data: {
                        title: document.getElementById('scenarioTitle').value,
                        description: document.getElementById('scenarioDescription').value
                    }
                });

                let errorMessage = 'Ïò®ÎùºÏù∏ Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§:\n' + error.message;

                if (error.message.includes('GitHub Token')) {
                    errorMessage += '\n\nüîê Ìï¥Í≤∞Ï±Ö: GitHub TokenÏùÑ ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî';
                }

                alert(errorMessage);
            } finally {
                // Î≤ÑÌäº ÏÉÅÌÉú Î≥µÏõê
                const saveButton = document.querySelector('#scenarioModal .btn-primary') ||
                                  document.querySelector('button[onclick*="saveScenario"]');

                if (saveButton) {
                    saveButton.disabled = false;
                    saveButton.textContent = 'Ï†ÄÏû•';
                }
            }
        };

        // ÏãúÎÇòÎ¶¨Ïò§ ÏÇ≠Ï†ú Ìï®ÏàòÎäî ÏúÑÏóêÏÑú Ïù¥ÎØ∏ Íµ¨ÌòÑÎê® (GitHub API Ïó∞Îèô)

        // Ï†ÑÏó≠ Ìï®Ïàò ÍµêÏ≤¥: Ïò®ÎùºÏù∏ Îç∞Ïù¥ÌÑ∞ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÏÇ¨Ïö©
        window.loadCharacters = async function() {
            console.log('üåê === APIÎ•º ÌÜµÌïú Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú ÏãúÏûë ===');
            try {
                // ÏßÅÏ†ë API Ìò∏Ï∂úÎ°ú Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
                const response = await fetch('/api/character-ai-generator?action=list_characters');
                if (!response.ok) {
                    throw new Error(`API Ìò∏Ï∂ú Ïã§Ìå®: ${response.status}`);
                }
                const apiData = await response.json();
                const charactersData = apiData.characters || {};
                console.log('üìä APIÏóêÏÑú Î°úÎìúÎêú ÏõêÏãú Îç∞Ïù¥ÌÑ∞:', charactersData);
                console.log('üìä Îç∞Ïù¥ÌÑ∞ ÌÉÄÏûÖ:', typeof charactersData);
                console.log('üìä Îç∞Ïù¥ÌÑ∞ ÌÇ§Îì§:', Object.keys(charactersData || {}));

                // Ï†ÑÏó≠ characters Î≥ÄÏàòÏôÄ window.characters Î™®Îëê ÏóÖÎç∞Ïù¥Ìä∏
                characters = charactersData || {};
                window.characters = characters;

                console.log('üìã Ï†ÑÏó≠ Î≥ÄÏàò ÏÑ§Ï†ï ÌõÑ ÌôïÏù∏:', typeof characters, Object.keys(characters).length, 'Í∞ú Ï∫êÎ¶≠ÌÑ∞');
                console.log('üìã window.characters ÌôïÏù∏:', typeof window.characters, Object.keys(window.characters || {}).length, 'Í∞ú Ï∫êÎ¶≠ÌÑ∞');

                displayCharacters();
                updateCharacterStats();
                console.log('‚úÖ === Ï∫êÎ¶≠ÌÑ∞ Ïò®ÎùºÏù∏ Î°úÎìú ÏôÑÎ£å ===');
            } catch (error) {
                console.error('‚ùå Ï∫êÎ¶≠ÌÑ∞ Ïò®ÎùºÏù∏ Î°úÎìú Ïã§Ìå®:', error);
                console.error('‚ùå ÏóêÎü¨ ÏÉÅÏÑ∏:', error.stack);
                alert('Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§:\n' + error.message);

                // Ïò§Î•ò Î∞úÏÉù Ïãú Îπà Îç∞Ïù¥ÌÑ∞Î°ú Ï¥àÍ∏∞Ìôî
                characters = {};
                window.characters = characters;
                console.log('üîÑ Îπà Îç∞Ïù¥ÌÑ∞Î°ú Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
                displayCharacters();
                updateCharacterStats();
            }
        };

        // Ï∫êÎ¶≠ÌÑ∞ Ï†ÄÏû• Ìï®ÏàòÎèÑ Ïò®ÎùºÏù∏ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏Î°ú ÍµêÏ≤¥
        window.saveCharacter = async function() {
            console.log('üíæ === Ïò®ÎùºÏù∏ Ï∫êÎ¶≠ÌÑ∞ Ï†ÄÏû• ÏãúÏûë ===');

            const name = document.getElementById('charName').value;
            const mbti = document.getElementById('charMbti').value;

            console.log('üìù ÏûÖÎ†•Í∞í ÌôïÏù∏:');
            console.log('  - Ïù¥Î¶Ñ:', name || '(ÎπÑÏñ¥ÏûàÏùå)');
            console.log('  - MBTI:', mbti || '(ÎπÑÏñ¥ÏûàÏùå)');

            if (!name || !mbti) {
                console.error('‚ùå ÌïÑÏàò ÏûÖÎ†•Í∞í ÎàÑÎùΩ');
                alert(`Ïù¥Î¶ÑÍ≥º MBTIÎäî ÌïÑÏàò ÏûÖÎ†• Ìï≠Î™©ÏûÖÎãàÎã§.\n\nÌòÑÏû¨ ÏûÖÎ†•Í∞í:\nÏù¥Î¶Ñ: ${name || 'ÎØ∏ÏûÖÎ†•'}\nMBTI: ${mbti || 'ÎØ∏ÏûÖÎ†•'}`);
                return;
            }

            try {
                // Í∞ÑÎã®Ìïú Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ± (Î≥µÏû°Ìïú collectCharacterData ÎåÄÏã†)
                const characterId = `${name.toLowerCase().replace(/\s+/g, '_')}_${mbti.toLowerCase()}_${Date.now()}`;

                // üíé Ïã§Ï†ú ÏÇ¨Ïö©Ïûê ÏÑ†ÌÉùÍ∞íÏùÑ Î™®Îëê ÏàòÏßëÌïòÏó¨ Î∞òÏòÅ
                console.log('üìù Ìèº Îç∞Ïù¥ÌÑ∞ ÏàòÏßë Ï§ë...');

                // ÏÑ±Í≤© ÌäπÏÑ± Ï≤¥ÌÅ¨Î∞ïÏä§ÏóêÏÑú ÏÑ†ÌÉùÎêú Ìï≠Î™©Îì§ ÏàòÏßë
                const selectedPersonalities = Array.from(document.querySelectorAll('input[name="personality"]:checked')).map(cb => cb.value);
                console.log('  - ÏÑ†ÌÉùÎêú ÏÑ±Í≤©:', selectedPersonalities);

                // Ï∑®ÎØ∏ Ï≤¥ÌÅ¨Î∞ïÏä§ÏóêÏÑú ÏÑ†ÌÉùÎêú Ìï≠Î™©Îì§ ÏàòÏßë
                const selectedHobbies = Array.from(document.querySelectorAll('input[name="hobbies"]:checked')).map(cb => cb.value);
                console.log('  - ÏÑ†ÌÉùÎêú Ï∑®ÎØ∏:', selectedHobbies);

                const finalCharacterData = {
                    id: characterId,
                    name: name,
                    age: parseInt(document.getElementById('charAge')?.value) || 22,
                    mbti: mbti,
                    gender: 'female',

                    // ‚ú® Ïã§Ï†ú ÏÇ¨Ïö©Ïûê ÏÑ†ÌÉùÍ∞í Î∞òÏòÅ (Í∏∞Î≥∏Í∞í ÏóÜÏùå)
                    personality_traits: selectedPersonalities.length > 0 ? selectedPersonalities : [],
                    major: document.getElementById('charMajor')?.value || 'general',
                    family: document.getElementById('charFamily')?.value || 'average',
                    hometown: document.getElementById('charHometown')?.value || 'seoul',
                    relationship: document.getElementById('charRelationship')?.value || 'friend',

                    appearance: {
                        hair: document.getElementById('charHair')?.value || 'ÏÑπÏãúÌïú Í∏¥ ÏÉùÎ®∏Î¶¨',
                        eyes: document.getElementById('charEyes')?.value || 'Ïú†ÌòπÏ†ÅÏù∏ ÎààÎß§',
                        body: document.getElementById('charBody')?.value || 'Îß§Î†•Ï†ÅÏù∏ ÌèâÍ∑†',
                        bust: document.getElementById('charBust')?.value || 'medium_balanced',
                        waist_hip: document.getElementById('charWaistHip')?.value || 'curvy_sexy',
                        style: document.getElementById('charStyle')?.value || 'sexy_chic'
                    },

                    // ‚ú® Ï∑®ÎØ∏ÎèÑ Ïã§Ï†ú ÏÑ†ÌÉùÍ∞í Î∞òÏòÅ (Í∏∞Î≥∏Í∞í ÏóÜÏùå)
                    hobbies: selectedHobbies.length > 0 ? selectedHobbies : [],
                    values: document.getElementById('charValues')?.value || 'family_oriented',
                    speech_style: document.getElementById('charSpeechStyle')?.value || 'ÏπúÍ∑ºÌïú ÎßêÌà¨',
                    speech_habit: document.getElementById('charSpeechHabit')?.value || 'ÏûêÏ£º ÎØ∏ÏÜåÏßìÍ∏∞',

                    created_at: new Date().toISOString(),
                    source: 'scenario_admin',
                    active: true
                };

                console.log('üíæ ÏµúÏ¢Ö Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞:', finalCharacterData);

                // Ï†ÄÏû• Î≤ÑÌäº ÏÉÅÌÉú Î≥ÄÍ≤Ω
                const saveButton = document.querySelector('#characterModal .btn-primary') ||
                                  document.querySelector('button[onclick*="saveCharacter"]');

                if (saveButton) {
                    saveButton.disabled = true;
                    saveButton.textContent = 'üåê Ïò®ÎùºÏù∏ Ï†ÄÏû• Ï§ë...';
                }

                console.log('üíæ APIÎ•º ÌÜµÌï¥ Ï†ÄÏû•Ìï† Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞:', finalCharacterData);

                // ÏßÅÏ†ë API Ìò∏Ï∂úÎ°ú Ï∫êÎ¶≠ÌÑ∞ Ï†ÄÏû•
                const response = await fetch('/api/character-ai-generator', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'save_character',
                        character: finalCharacterData
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Ìò∏Ï∂ú Ïã§Ìå®: ${response.status}`);
                }

                const result = await response.json();

                if (result && result.success) {
                    console.log('üéâ Ï†ÄÏû• ÏÑ±Í≥µ! GitHub ÎèôÍ∏∞Ìôî ÎåÄÍ∏∞ ÌõÑ ÏÉàÎ°úÍ≥†Ïπ®...');

                    // üïê GitHub API Ï†ÄÏû• ÏôÑÎ£å ÎåÄÍ∏∞ (2Ï¥à ÏßÄÏó∞)
                    setTimeout(async () => {
                        console.log('üîÑ GitHub ÎèôÍ∏∞Ìôî ÏôÑÎ£å ÏòàÏÉÅ - Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ® ÏãúÏûë...');

                        // ÏÇ¨Ïö©ÏûêÏóêÍ≤å ÏÉàÎ°úÍ≥†Ïπ® Ï§ëÏûÑÏùÑ ÏïåÎ¶º
                        showRefreshNotification('Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë...');

                        // ÏÑ±Í≥µ Ïãú Ï†ÑÏ≤¥ Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ùÏùÑ Îã§Ïãú Î°úÎìúÌïòÏó¨ ÏµúÏã† ÏÉÅÌÉú Ïú†ÏßÄ
                        await window.loadCharacters();

                        console.log('‚úÖ Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ® ÏôÑÎ£å');
                        showRefreshNotification('‚úÖ Î™©Î°ùÏù¥ ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§!', true);
                    }, 2000);

                    const successMessage = `üíñ ÏÉàÎ°úÏö¥ Ï∫êÎ¶≠ÌÑ∞ '${name}'Í∞Ä GitHubÏóê Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!\n‚úÖ Ïò®ÎùºÏù∏ÏóêÏÑú ÏòÅÍµ¨ Î≥¥Í¥ÄÎê©ÎãàÎã§!`;

                    alert(successMessage);

                    // Î™®Îã¨ Îã´Í∏∞ (Ìï®ÏàòÍ∞Ä Ï°¥Ïû¨ÌïòÎäî Í≤ΩÏö∞Îßå)
                    if (typeof closeModal === 'function') {
                        closeModal('characterModal');
                    } else {
                        // ÏßÅÏ†ë Î™®Îã¨ Îã´Í∏∞
                        const modal = document.getElementById('characterModal');
                        if (modal) modal.style.display = 'none';
                    }

                    console.log('‚úÖ Ïò®ÎùºÏù∏ Ï∫êÎ¶≠ÌÑ∞ Ï†ÄÏû• ÏôÑÎ£å!');
                } else {
                    throw new Error(result?.error || 'Ïò®ÎùºÏù∏ Ï†ÄÏû• Ïã§Ìå® - Í≤∞Í≥º ÏóÜÏùå');
                }

            } catch (error) {
                console.error('‚ùå Ïò®ÎùºÏù∏ Ï∫êÎ¶≠ÌÑ∞ Ï†ÄÏû• Ïã§Ìå®:', error);

                let errorMessage = 'Ïò®ÎùºÏù∏ Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§:\n' + error.message;

                if (error.message.includes('GitHub Token')) {
                    errorMessage += '\n\nüîê Ìï¥Í≤∞Ï±Ö: GitHub TokenÏùÑ ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî';
                    errorMessage += '\n1. ÌÖåÏä§Ìä∏ ÌéòÏù¥ÏßÄÏóêÏÑú ÌÜ†ÌÅ∞ ÏÑ§Ï†ï';
                    errorMessage += '\n2. ÎòêÎäî Vercel ÌôòÍ≤ΩÎ≥ÄÏàò ÌôïÏù∏';
                }

                alert(errorMessage);
            } finally {
                // Î≤ÑÌäº ÏÉÅÌÉú Î≥µÏõê
                const saveButton = document.querySelector('#characterModal .btn-primary') ||
                                  document.querySelector('button[onclick*="saveCharacter"]');

                if (saveButton) {
                    saveButton.disabled = false;
                    saveButton.textContent = 'üíñ Ï∫êÎ¶≠ÌÑ∞ Ï†ÄÏû•';
                }
            }
        };

        window.loadScenarios = async function() {
            console.log('üåê APIÎ•º ÌÜµÌïú ÏãúÎÇòÎ¶¨Ïò§ Î°úÎìú...');
            try {
                // ÏßÅÏ†ë API Ìò∏Ï∂úÎ°ú ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
                const response = await fetch('/api/scenario-manager?action=list');
                if (!response.ok) {
                    throw new Error(`API Ìò∏Ï∂ú Ïã§Ìå®: ${response.status}`);
                }
                const apiData = await response.json();
                const scenariosData = apiData.scenarios || {};
                window.scenarios = scenariosData;
                displayScenarios();
                updateScenarioStats();
                console.log('‚úÖ ÏãúÎÇòÎ¶¨Ïò§ API Î°úÎìú ÏôÑÎ£å');
            } catch (error) {
                console.error('‚ùå ÏãúÎÇòÎ¶¨Ïò§ API Î°úÎìú Ïã§Ìå®:', error);
                // Ïò§Î•ò Ïãú Îπà Í∞ùÏ≤¥Î°ú Ï¥àÍ∏∞Ìôî
                window.scenarios = {};
                displayScenarios();
                updateScenarioStats();
            }
        };

        // Ïò®ÎùºÏù∏ ÏÉÅÌÉú ÌëúÏãú (Îã®ÏàúÌôîÎê®)
        setInterval(() => {
            const statusIndicator = document.getElementById('onlineStatus') || createStatusIndicator();
            statusIndicator.textContent = 'üåê Ïò®ÎùºÏù∏';
            statusIndicator.style.color = '#28a745';
        }, 30000); // 30Ï¥àÎßàÎã§ Ï≤¥ÌÅ¨

        // Ïò®ÎùºÏù∏ ÏÉÅÌÉú ÌëúÏãúÍ∏∞ ÏÉùÏÑ±
        function createStatusIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'onlineStatus';
            indicator.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: white;
                padding: 8px 12px;
                border-radius: 20px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                font-size: 14px;
                font-weight: bold;
                z-index: 1000;
            `;
            document.body.appendChild(indicator);
            return indicator;
        }

        console.log('‚úÖ Ïò®ÎùºÏù∏ Ï†ÑÏö© ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');

        // üé≠ Ï∫êÎ¶≠ÌÑ∞ ÏöîÏïΩ ÏÑπÏÖò Ï†ëÍ∏∞/ÌéºÏπòÍ∏∞ Ìï®Ïàò
        window.toggleCharacterSummary = function() {
            const detailsSection = document.querySelector('.summary-details');
            const toggleText = document.getElementById('summaryToggleText');

            if (detailsSection && toggleText) {
                if (detailsSection.classList.contains('collapsed')) {
                    detailsSection.classList.remove('collapsed');
                    toggleText.textContent = 'üìñ Í∞ÑÎã®Ìûà Î≥¥Í∏∞';
                } else {
                    detailsSection.classList.add('collapsed');
                    toggleText.textContent = 'üìñ ÏûêÏÑ∏Ìûà Î≥¥Í∏∞';
                }
            }
        };

        // ‚ú® ÏóêÌîºÏÜåÎìú Î™©Î°ù Í¥ÄÎ¶¨ Ìï®ÏàòÎì§ (ÏÉàÎ°ú Ï∂îÍ∞Ä)

        // ÏóêÌîºÏÜåÎìú Î™©Î°ù Î°úÎìú
        async function loadEpisodesList() {
            console.log('üìö ÏóêÌîºÏÜåÎìú Î™©Î°ù Î°úÎìú ÏãúÏûë...');
            const container = document.getElementById('episodesListContainer');

            try {
                // dialogue-manager APIÎ•º ÌÜµÌï¥ Ï†ÑÏ≤¥ ÏóêÌîºÏÜåÎìú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
                const response = await fetch('/api/dialogue-manager?action=get_all_episodes');
                if (!response.ok) {
                    throw new Error(`API Ìò∏Ï∂ú Ïã§Ìå®: ${response.status}`);
                }

                const data = await response.json();
                console.log('üìä ÏóêÌîºÏÜåÎìú API ÏùëÎãµ:', data);

                if (!data.success) {
                    throw new Error(data.message || 'ÏóêÌîºÏÜåÎìú Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®');
                }

                // ÏóêÌîºÏÜåÎìú Îç∞Ïù¥ÌÑ∞Î•º ÏãúÎÇòÎ¶¨Ïò§+Ï∫êÎ¶≠ÌÑ∞ Ï°∞Ìï©ÏúºÎ°ú Í∑∏Î£πÌôî
                const episodeGroups = groupEpisodesByScenarioCharacter(data.episodes || {});
                console.log('üìä Í∑∏Î£πÌôîÎêú ÏóêÌîºÏÜåÎìú:', episodeGroups);

                displayEpisodesList(episodeGroups);

            } catch (error) {
                console.error('‚ùå ÏóêÌîºÏÜåÎìú Î™©Î°ù Î°úÎìú Ïã§Ìå®:', error);
                container.innerHTML = `
                    <div class="error-card">
                        <h4>‚ùå ÏóêÌîºÏÜåÎìú Î°úÎìú Ïã§Ìå®</h4>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="loadEpisodesList()">üîÑ Îã§Ïãú ÏãúÎèÑ</button>
                    </div>
                `;
            }
        }

        // ÏóêÌîºÏÜåÎìúÎ•º ÏãúÎÇòÎ¶¨Ïò§+Ï∫êÎ¶≠ÌÑ∞ Ï°∞Ìï©ÏúºÎ°ú Í∑∏Î£πÌôî
        function groupEpisodesByScenarioCharacter(episodes) {
            const groups = {};

            Object.values(episodes).forEach(episode => {
                if (episode.scenario_id && episode.character_id) {
                    const groupKey = `${episode.scenario_id}_${episode.character_id}`;

                    if (!groups[groupKey]) {
                        groups[groupKey] = {
                            scenario_id: episode.scenario_id,
                            character_id: episode.character_id,
                            character_name: episode.character_name,
                            episodes: [],
                            total_dialogues: 0,
                            created_at: episode.created_at
                        };
                    }

                    groups[groupKey].episodes.push(episode);
                    groups[groupKey].total_dialogues++;

                    // Í∞ÄÏû• ÏµúÍ∑º ÏÉùÏÑ± ÏãúÍ∞ÑÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏
                    if (episode.created_at > groups[groupKey].created_at) {
                        groups[groupKey].created_at = episode.created_at;
                    }
                }
            });

            return groups;
        }

        // ÏóêÌîºÏÜåÎìú Î™©Î°ù ÌëúÏãú
        function displayEpisodesList(episodeGroups) {
            const container = document.getElementById('episodesListContainer');

            if (Object.keys(episodeGroups).length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                        <h3>üì≠ ÏÉùÏÑ±Îêú ÏóêÌîºÏÜåÎìúÍ∞Ä ÏóÜÏäµÎãàÎã§</h3>
                        <p>ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÑ†ÌÉùÌïòÍ≥† AIÎ°ú ÏóêÌîºÏÜåÎìúÎ•º ÏÉùÏÑ±Ìï¥Î≥¥ÏÑ∏Ïöî!</p>
                    </div>
                `;
                return;
            }

            const episodeCards = Object.entries(episodeGroups).map(([groupKey, group]) => {
                // ÏãúÎÇòÎ¶¨Ïò§ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                const scenariosData = window.scenarios || scenarios || {};
                const scenario = scenariosData[group.scenario_id];
                const scenarioTitle = scenario ? scenario.title : group.scenario_id;

                // Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                const charactersData = window.characters || characters || {};
                const character = charactersData[group.character_id];
                const characterMbti = character ? character.mbti : 'Unknown';

                // ÎÇúÏù¥ÎèÑÎ≥Ñ ÌÜµÍ≥Ñ Í≥ÑÏÇ∞
                const difficultyStats = calculateDifficultyStats(group.episodes);

                return `
                    <div class="episode-list-card" onclick="viewEpisodeDialogues('${groupKey}', '${scenarioTitle}', '${group.character_name}')">
                        <div class="episode-header">
                            <div>
                                <div class="episode-title">${scenarioTitle}</div>
                                <div class="episode-subtitle">with ${group.character_name}</div>
                            </div>
                            <div class="episode-badge">${group.total_dialogues}Í∞ú ÎåÄÌôî</div>
                        </div>

                        <div class="episode-content">
                            <div class="character-info">
                                <div class="character-avatar">üë§</div>
                                <div class="character-details">
                                    <div class="character-name">${group.character_name}</div>
                                    <div class="character-mbti">MBTI: ${characterMbti}</div>
                                </div>
                            </div>

                            <div class="episode-stats">
                                <div class="stat-item">
                                    <span class="stat-number">${difficultyStats.easy}</span>
                                    <span class="stat-label">Easy</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-number">${difficultyStats.medium}</span>
                                    <span class="stat-label">Medium</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-number">${difficultyStats.hard}</span>
                                    <span class="stat-label">Hard</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-number">${difficultyStats.expert}</span>
                                    <span class="stat-label">Expert</span>
                                </div>
                            </div>
                        </div>

                        <div class="episode-actions">
                            <span class="action-btn">üìñ ÎåÄÌôî Î≥¥Í∏∞</span>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = episodeCards;
        }

        // ÎÇúÏù¥ÎèÑÎ≥Ñ ÌÜµÍ≥Ñ Í≥ÑÏÇ∞
        function calculateDifficultyStats(episodes) {
            const stats = { easy: 0, medium: 0, hard: 0, expert: 0 };

            episodes.forEach(episode => {
                const difficulty = episode.difficulty ? episode.difficulty.toLowerCase() : 'easy';
                if (stats.hasOwnProperty(difficulty)) {
                    stats[difficulty]++;
                }
            });

            return stats;
        }

        // ÏóêÌîºÏÜåÎìú ÎåÄÌôî Î≥¥Í∏∞
        function viewEpisodeDialogues(groupKey, scenarioTitle, characterName) {
            console.log('üìñ ÏóêÌîºÏÜåÎìú ÎåÄÌôî Î≥¥Í∏∞:', groupKey, scenarioTitle, characterName);

            // Ï†úÎ™© ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('selectedEpisodeTitle').textContent =
                `üìñ ${scenarioTitle} - ${characterName}Ïùò ÎåÄÌôî Î™©Î°ù`;

            // ÏóêÌîºÏÜåÎìú Î™©Î°ù Ïà®Í∏∞Í≥† ÎåÄÌôî Î™©Î°ù ÌëúÏãú
            document.querySelector('.episodes-list-section').style.display = 'none';
            document.getElementById('selectedEpisodeDialogues').style.display = 'block';

            // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Í∑∏Î£πÏùò ÏãúÎÇòÎ¶¨Ïò§ IDÎ•º episodeGroupsÏóêÏÑú Í∞ÄÏ†∏Ïò§Í∏∞
            // groupKeyÎäî "scenario_id_character_id" ÌòïÏãùÏù¥ÎØÄÎ°ú ÏßÅÏ†ë ÌååÏã±ÌïòÍ∏∞ Ïñ¥Î†§ÏõÄ
            // Îî∞ÎùºÏÑú APIÏóêÏÑú ÏóêÌîºÏÜåÎìú Îç∞Ïù¥ÌÑ∞Î•º Î°úÎìúÌï¥ÏÑú scenario_idÎ•º Ï∞æÎäî Í≤ÉÏù¥ Îçî ÏïàÏ†ÑÌï®
            console.log('üîë GroupKeyÎ°ú scenario_id Ï∞æÍ∏∞:', groupKey);

            // Ìï¥Îãπ ÏóêÌîºÏÜåÎìúÏùò Ïã§Ï†ú ÎåÄÌôîÎì§Îßå ÌëúÏãú (Îπà Ïπ¥Îìú ÎåÄÏã†)
            displayEpisodeSpecificDialogues(groupKey, scenarioTitle, characterName);
        }

        // ÌäπÏ†ï ÏóêÌîºÏÜåÎìúÏùò ÎåÄÌôîÎßå ÌëúÏãú (ÏÉàÎ°ú Ï∂îÍ∞Ä)
        async function displayEpisodeSpecificDialogues(groupKey, scenarioTitle, characterName) {
            console.log('üéØ ÌäπÏ†ï ÏóêÌîºÏÜåÎìú ÎåÄÌôî ÌëúÏãú:', groupKey);
            const grid = document.getElementById('dialoguesGrid');

            try {
                // Î°úÎî© ÌëúÏãú
                grid.innerHTML = `
                    <div class="loading-card" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                        <div class="spinner"></div>
                        <h4>üìñ ÎåÄÌôî Î°úÎî© Ï§ë...</h4>
                    </div>
                `;

                // dialogue-manager APIÎ•º ÌÜµÌï¥ Ï†ÑÏ≤¥ ÏóêÌîºÏÜåÎìú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
                const response = await fetch('/api/dialogue-manager?action=get_all_episodes');
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message || 'ÏóêÌîºÏÜåÎìú Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®');
                }

                // groupKeyÏóêÏÑú scenario_idÏôÄ character_idÎ•º Ïò¨Î∞îÎ•¥Í≤å Ï∂îÏ∂ú
                // groupKey ÌòïÏãù: "scenario_id_character_id"ÏóêÏÑú Ïã§Ï†ú Í∞íÎì§ÏùÑ Ï∞æÏïÑÏïº Ìï®
                console.log('üîë GroupKey Î∂ÑÏÑù:', groupKey);

                // Î™®Îì† ÏóêÌîºÏÜåÎìúÎ•º ÌôïÏù∏Ìï¥ÏÑú Ìï¥Îãπ groupKeyÏôÄ Îß§ÏπòÎêòÎäî Í≤ÉÎì§ÏùÑ Ï∞æÍ∏∞
                const episodeDialogues = Object.values(data.episodes || {}).filter(episode => {
                    if (!episode.scenario_id || !episode.character_id) return false;

                    const episodeGroupKey = `${episode.scenario_id}_${episode.character_id}`;
                    const isMatch = episodeGroupKey === groupKey;

                    if (isMatch) {
                        console.log('‚úÖ Îß§ÏπòÎêú ÏóêÌîºÏÜåÎìú:', {
                            episode_id: episode.id,
                            scenario_id: episode.scenario_id,
                            character_id: episode.character_id,
                            character_name: episode.character_name
                        });
                    }

                    return isMatch;
                });

                console.log('üîç ÌïÑÌÑ∞ÎßÅÎêú ÏóêÌîºÏÜåÎìú ÎåÄÌôî:', episodeDialogues.length, 'Í∞ú');

                if (episodeDialogues.length === 0) {
                    // ÎåÄÌôîÍ∞Ä ÏóÜÎäî Í≤ΩÏö∞
                    grid.innerHTML = `
                        <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                            <h3>üì≠ ÏÉùÏÑ±Îêú ÎåÄÌôîÍ∞Ä ÏóÜÏäµÎãàÎã§</h3>
                            <p>+ Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠Ìï¥ÏÑú ÏÉàÎ°úÏö¥ ÎåÄÌôîÎ•º Ï∂îÍ∞ÄÌï¥Î≥¥ÏÑ∏Ïöî!</p>
                            <button class="btn btn-primary" onclick="addNewDialogueToEpisode('${groupKey}', '${scenarioTitle}', '${characterName}')" style="margin-top: 20px;">
                                ‚ú® Ï≤´ Î≤àÏß∏ ÎåÄÌôî ÎßåÎì§Í∏∞
                            </button>
                        </div>
                    `;
                    return;
                }

                // Ïã§Ï†ú ÎåÄÌôîÎì§ÏùÑ Ïπ¥ÎìúÎ°ú ÌëúÏãú + Ï∂îÍ∞Ä Î≤ÑÌäº
                const dialogueCards = episodeDialogues.map((episode, index) => `
                    <div class="episode-dialogue-card" onclick="previewEpisodeDialogue('${episode.id}')">
                        <div class="dialogue-header">
                            <div class="dialogue-number">#${episode.episode_number || index + 1}</div>
                            <div class="difficulty-badge ${(episode.difficulty || 'Easy').toLowerCase()}">${(episode.difficulty || 'Easy').toUpperCase()}</div>
                        </div>
                        <div class="dialogue-content">
                            <div class="dialogue-preview">
                                ${episode.dialogue?.dialogue ? episode.dialogue.dialogue.substring(0, 100) + '...' : 'ÎåÄÌôî ÎÇ¥Ïö© ÏóÜÏùå'}
                            </div>
                            <div class="dialogue-info">
                                <span class="dialogue-choices">ÏÑ†ÌÉùÏßÄ ${episode.dialogue?.choices?.length || 0}Í∞ú</span>
                                <span class="dialogue-date">${new Date(episode.created_at).toLocaleDateString()}</span>
                            </div>
                        </div>
                        <div class="dialogue-actions">
                            <span class="action-btn">üìñ Î≥¥Í∏∞</span>
                            <button class="delete-episode-btn" onclick="event.stopPropagation(); deleteEpisodeDialogue('${episode.id}', '${groupKey}', '${scenarioTitle}', '${characterName}')" title="ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `).join('');

                // + Î≤ÑÌäº Ïπ¥Îìú Ï∂îÍ∞Ä
                const addButtonCard = `
                    <div class="add-dialogue-card" onclick="addNewDialogueToEpisode('${groupKey}', '${scenarioTitle}', '${characterName}')">
                        <div class="add-icon">+</div>
                        <div class="add-text">ÏÉà ÎåÄÌôî Ï∂îÍ∞Ä</div>
                    </div>
                `;

                grid.innerHTML = dialogueCards + addButtonCard;

            } catch (error) {
                console.error('‚ùå ÏóêÌîºÏÜåÎìú ÎåÄÌôî ÌëúÏãú Ïã§Ìå®:', error);
                grid.innerHTML = `
                    <div class="error-card" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                        <h4>‚ùå ÎåÄÌôî Î°úÎìú Ïã§Ìå®</h4>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="displayEpisodeSpecificDialogues('${groupKey}', '${scenarioTitle}', '${characterName}')">üîÑ Îã§Ïãú ÏãúÎèÑ</button>
                    </div>
                `;
            }
        }

        // ÏóêÌîºÏÜåÎìúÏóê ÏÉà ÎåÄÌôî Ï∂îÍ∞Ä (ÏÉàÎ°ú Ï∂îÍ∞Ä)
        async function addNewDialogueToEpisode(groupKey, scenarioTitle, characterName) {
            console.log('‚ú® ÏÉà ÎåÄÌôî Ï∂îÍ∞Ä:', groupKey, scenarioTitle, characterName);

            try {
                // APIÏóêÏÑú ÏóêÌîºÏÜåÎìú Îç∞Ïù¥ÌÑ∞ Î°úÎìúÌï¥ÏÑú Ïã§Ï†ú scenario_id Ï∞æÍ∏∞
                const response = await fetch('/api/dialogue-manager?action=get_all_episodes');
                const data = await response.json();

                if (data.success && data.episodes) {
                    // Ìï¥Îãπ groupKeyÏôÄ Îß§ÏπòÎêòÎäî ÏóêÌîºÏÜåÎìú Ï∞æÍ∏∞
                    const matchingEpisode = Object.values(data.episodes).find(episode => {
                        if (!episode.scenario_id || !episode.character_id) return false;
                        const episodeGroupKey = `${episode.scenario_id}_${episode.character_id}`;
                        return episodeGroupKey === groupKey;
                    });

                    if (matchingEpisode) {
                        currentScenarioId = matchingEpisode.scenario_id;
                        console.log('‚úÖ Scenario ID ÏÑ§Ï†ï:', currentScenarioId);
                    } else {
                        console.warn('‚ö†Ô∏è Îß§ÏπòÎêòÎäî ÏóêÌîºÏÜåÎìúÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§');
                        // Fallback: groupKeyÏóêÏÑú Ï∂îÏ∏°Ìï¥Î≥¥Í∏∞
                        const lastUnderscoreIndex = groupKey.lastIndexOf('_');
                        if (lastUnderscoreIndex > 0) {
                            currentScenarioId = groupKey.substring(0, lastUnderscoreIndex);
                        }
                    }
                }

                // ÎåÄÌôî ÏÉùÏÑ± Î™®Îã¨ Ïó¥Í∏∞
                openDialogueModal('create');

                // ÏûêÎèôÏúºÎ°ú Îã§Ïùå ÏóêÌîºÏÜåÎìú Î≤àÌò∏ ÏÑ§Ï†ï (Ìñ•ÌõÑ Íµ¨ÌòÑ)
                // ÌòÑÏû¨Îäî ÏÇ¨Ïö©ÏûêÍ∞Ä ÏßÅÏ†ë Î≤àÌò∏ ÏûÖÎ†•

            } catch (error) {
                console.error('‚ùå Scenario ID Ï∞æÍ∏∞ Ïã§Ìå®:', error);
                // ÎåÄÌôî ÏÉùÏÑ± Î™®Îã¨ÏùÄ Ïó¨Ï†ÑÌûà Ïó¥Í∏∞
                openDialogueModal('create');
            }
        }

        // ÏóêÌîºÏÜåÎìú ÎåÄÌôî ÎØ∏Î¶¨Î≥¥Í∏∞ (ÏÉàÎ°ú Ï∂îÍ∞Ä)
        function previewEpisodeDialogue(episodeId) {
            console.log('üìñ ÏóêÌîºÏÜåÎìú ÎåÄÌôî ÎØ∏Î¶¨Î≥¥Í∏∞:', episodeId);
            // Í∏∞Ï°¥ previewDialogue Ìï®Ïàò ÌôúÏö©ÌïòÍ±∞ÎÇò ÏÉàÎ°úÏö¥ ÎØ∏Î¶¨Î≥¥Í∏∞ Íµ¨ÌòÑ
            // ÏùºÎã® Í∏∞Ï°¥ Ìï®Ïàò ÏÇ¨Ïö©
            previewDialogue(episodeId);
        }

        // ÏóêÌîºÏÜåÎìú ÎåÄÌôî ÏÇ≠Ï†ú (ÏÉàÎ°ú Ï∂îÍ∞Ä)
        async function deleteEpisodeDialogue(episodeId, groupKey, scenarioTitle, characterName) {
            console.log('üóëÔ∏è ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú:', episodeId);

            // ÏÇ¨Ïö©Ïûê ÌôïÏù∏
            if (!confirm(`Ï†ïÎßêÎ°ú Ïù¥ ÏóêÌîºÏÜåÎìúÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÏóêÌîºÏÜåÎìú ID: ${episodeId}\n\n‚ö†Ô∏è Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.`)) {
                return;
            }

            try {
                // APIÎ°ú ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú ÏöîÏ≤≠
                const response = await fetch('/api/dialogue-manager', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'delete_episode',
                        episode_id: episodeId
                    })
                });

                const result = await response.json();
                console.log('üóëÔ∏è ÏÇ≠Ï†ú API ÏùëÎãµ:', result);

                if (result.success) {
                    alert('‚úÖ ÏóêÌîºÏÜåÎìúÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');

                    // ÌòÑÏû¨ ÌôîÎ©¥ÏùÑ ÏÉàÎ°úÍ≥†Ïπ®ÌïòÏó¨ ÏÇ≠Ï†úÎêú ÏóêÌîºÏÜåÎìú Ï†úÍ±∞
                    displayEpisodeSpecificDialogues(groupKey, scenarioTitle, characterName);

                    // ÏóêÌîºÏÜåÎìú Î™©Î°ùÎèÑ ÏÉàÎ°úÍ≥†Ïπ®
                    loadEpisodesList();

                    // Ï¥ù ÏóêÌîºÏÜåÎìú Ïπ¥Ïö¥Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
                    loadTotalEpisodeCount();

                } else {
                    throw new Error(result.message || 'ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú Ïã§Ìå®');
                }

            } catch (error) {
                console.error('‚ùå ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú Ïã§Ìå®:', error);
                alert(`‚ùå ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú Ïã§Ìå®:\n${error.message}`);
            }
        }

        // ÏóêÌîºÏÜåÎìú ÎåÄÌôî Î≥¥Í∏∞ Îã´Í∏∞
        function closeEpisodeDialogues() {
            document.querySelector('.episodes-list-section').style.display = 'block';
            document.getElementById('selectedEpisodeDialogues').style.display = 'none';
            currentScenarioId = null;
        }

        // Ï†ÑÏó≠ Ìï®ÏàòÎ°ú Îì±Î°ù
        window.loadEpisodesList = loadEpisodesList;
        window.viewEpisodeDialogues = viewEpisodeDialogues;
        window.closeEpisodeDialogues = closeEpisodeDialogues;

        // ‚ú® Î™®Îì† ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú Í∏∞Îä• (ÏÉàÎ°ú Ï∂îÍ∞Ä)
        async function resetAllEpisodes() {
            console.log('üóëÔ∏è Î™®Îì† ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú ÏöîÏ≤≠...');

            // 2Îã®Í≥Ñ ÌôïÏù∏ (Ï∫êÎ¶≠ÌÑ∞ ÏÇ≠Ï†úÏôÄ ÎèôÏùºÌïú Î∞©Ïãù)
            const firstConfirm = confirm(
                '‚ö†Ô∏è Í≤ΩÍ≥†: Î™®Îì† ÏóêÌîºÏÜåÎìúÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\n' +
                'Ïù¥ ÏûëÏóÖÏùÄ Îã§ÏùåÏùÑ ÏÇ≠Ï†úÌï©ÎãàÎã§:\n' +
                '‚Ä¢ Î™®Îì† ÏãúÎÇòÎ¶¨Ïò§+Ï∫êÎ¶≠ÌÑ∞ Ï°∞Ìï©Ïùò ÏóêÌîºÏÜåÎìú\n' +
                '‚Ä¢ Í∞Å ÏóêÌîºÏÜåÎìúÏùò 1~36Î≤à ÎåÄÌôî ÎÇ¥Ïö©\n' +
                '‚Ä¢ ÏÉùÏÑ±Îêú Î™®Îì† AI ÎåÄÌôî Îç∞Ïù¥ÌÑ∞\n\n' +
                '‚ö†Ô∏è Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§!'
            );

            if (!firstConfirm) {
                console.log('‚úÖ ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú Ï∑®ÏÜåÎê®');
                return;
            }

            const secondConfirm = confirm(
                'üö® ÏµúÏ¢Ö ÌôïÏù∏\n\n' +
                'Ï†ïÎßêÎ°ú Î™®Îì† ÏóêÌîºÏÜåÎìú Îç∞Ïù¥ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\n' +
                'ÏÇ≠Ï†úÌï† Í≤ΩÏö∞:\n' +
                '‚Ä¢ Î™®Îì† AI ÏÉùÏÑ± ÎåÄÌôîÍ∞Ä ÏÇ¨ÎùºÏßëÎãàÎã§\n' +
                '‚Ä¢ ÏóêÌîºÏÜåÎìú Î™©Î°ùÏù¥ ÎπÑÏõåÏßëÎãàÎã§\n' +
                '‚Ä¢ GitHubÏóêÏÑúÎèÑ ÏôÑÏ†ÑÌûà ÏÇ≠Ï†úÎê©ÎãàÎã§\n\n' +
                'Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?'
            );

            if (!secondConfirm) {
                console.log('‚úÖ ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú ÏµúÏ¢Ö Ï∑®ÏÜåÎê®');
                return;
            }

            try {
                // Î°úÎî© ÌëúÏãú
                const container = document.getElementById('episodesListContainer');
                container.innerHTML = `
                    <div class="loading-card" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                        <div class="spinner"></div>
                        <h4>üóëÔ∏è Î™®Îì† ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú Ï§ë...</h4>
                        <p>Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî...</p>
                    </div>
                `;

                console.log('üîÑ dialogue-manager API Ìò∏Ï∂ú: Î™®Îì† ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú');

                // dialogue-manager APIÎ•º ÌÜµÌï¥ Î™®Îì† ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú
                const response = await fetch('/api/dialogue-manager', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'reset_all_episodes'
                    })
                });

                console.log('üì∂ API ÏùëÎãµ ÏÉÅÌÉú:', response.status);

                if (!response.ok) {
                    throw new Error(`API Ìò∏Ï∂ú Ïã§Ìå®: ${response.status}`);
                }

                const result = await response.json();
                console.log('üìä ÏÇ≠Ï†ú Í≤∞Í≥º:', result);

                if (result.success) {
                    // ÏÑ±Í≥µ Î©îÏãúÏßÄ (ÏÇ≠Ï†úÎêú Í∞úÏàò Ìè¨Ìï®)
                    const deletedCount = result.deleted_count || 0;
                    alert(
                        `‚úÖ Î™®Îì† ÏóêÌîºÏÜåÎìúÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§!\n\n` +
                        `üìä ÏÇ≠Ï†úÎêú ÏóêÌîºÏÜåÎìú: ${deletedCount}Í∞ú\n` +
                        '‚Ä¢ GitHubÏóêÏÑú ÏôÑÏ†ÑÌûà Ï†úÍ±∞Îê®\n' +
                        '‚Ä¢ Î™®Îì† AI ÎåÄÌôî Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†úÎê®\n' +
                        '‚Ä¢ Íπ®ÎÅóÌïú ÏÉÅÌÉúÎ°ú Ï¥àÍ∏∞ÌôîÎê®\n\n' +
                        'Ïù¥Ï†ú ÏÉàÎ°úÏö¥ ÏóêÌîºÏÜåÎìúÎ•º ÏÉùÏÑ±Ìï† Ïàò ÏûàÏäµÎãàÎã§!'
                    );

                    console.log('üìä ÏÇ≠Ï†ú ÏÑ±Í≥µ ÏÉÅÏÑ∏:', {
                        ÏÇ≠Ï†úÎêú_Í∞úÏàò: deletedCount,
                        Ïù¥Ï†Ñ_Í∞úÏàò: result.previous_count,
                        ÌòÑÏû¨_Í∞úÏàò: result.current_count,
                        ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ: result.timestamp
                    });

                    // ÏóêÌîºÏÜåÎìú Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                    await loadEpisodesList();

                    // Ï†ÑÏ≤¥ ÏóêÌîºÏÜåÎìú Ïπ¥Ïö¥Ìä∏ ÏÉàÎ°úÍ≥†Ïπ® (Í∞ÄÏû• Ï§ëÏöî!)
                    await loadTotalEpisodeCount();

                    // ÎåÄÌôî Î™©Î°ùÎèÑ ÏÉàÎ°úÍ≥†Ïπ® (Îπà ÏÉÅÌÉú)
                    displayDialogues();

                    // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
                    updateDialogueStats();

                    // Ï†ÑÏó≠ Î≥ÄÏàòÎèÑ Ï¥àÍ∏∞Ìôî
                    dialogues = {};
                    currentScenarioId = null;

                    console.log('‚úÖ ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú Î∞è ÏÉàÎ°úÍ≥†Ïπ® ÏôÑÎ£å');

                } else {
                    throw new Error(result.message || 'ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú Ïã§Ìå®');
                }

            } catch (error) {
                console.error('‚ùå ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú Ïã§Ìå®:', error);

                // Ïò§Î•ò ÌëúÏãú
                const container = document.getElementById('episodesListContainer');
                container.innerHTML = `
                    <div class="error-card" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                        <h4>‚ùå ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú Ïã§Ìå®</h4>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="loadEpisodesList()">üîÑ Îã§Ïãú Î°úÎìú</button>
                    </div>
                `;

                alert(
                    '‚ùå ÏóêÌîºÏÜåÎìú ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\n\n' +
                    `Ïò§Î•ò: ${error.message}\n\n` +
                    'Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.'
                );
            }
        }

        // Ï†ÑÏó≠ Ìï®ÏàòÎ°ú Îì±Î°ù
        window.resetAllEpisodes = resetAllEpisodes;
        window.displayEpisodeSpecificDialogues = displayEpisodeSpecificDialogues;
        window.addNewDialogueToEpisode = addNewDialogueToEpisode;
        window.previewEpisodeDialogue = previewEpisodeDialogue;
    </script>
</body>
</html>