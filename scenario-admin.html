<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÆ ÌÜµÌï© Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú - MBTI Î°úÎß®Ïä§ Í≤åÏûÑ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .admin-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        /* ÌÉ≠ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò */
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .nav-tab {
            flex: 1;
            padding: 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .nav-tab:hover:not(.active) {
            background: #e9ecef;
        }

        .nav-tab .badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #e74c3c;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }

        /* ÏΩòÌÖêÏ∏† ÏÑπÏÖò */
        .content-section {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            animation: fadeIn 0.3s ease;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ÌÜµÍ≥Ñ Ïπ¥Îìú */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .stat-card h3 {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .stat-card .value {
            color: #2c3e50;
            font-size: 2em;
            font-weight: bold;
        }

        /* Ïï°ÏÖò Î≤ÑÌäº */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.4);
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }

        /* ÏòàÏãú ÏãúÏä§ÌÖú Ïä§ÌÉÄÏùº */
        .examples-container {
            margin-top: 8px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        .examples-label {
            font-size: 12px;
            color: #6c757d;
            font-weight: 500;
            margin-bottom: 8px;
            display: block;
        }
        .examples-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .example-tag {
            display: inline-block;
            padding: 4px 8px;
            background: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 12px;
            font-size: 11px;
            color: #495057;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            line-height: 1.2;
        }
        .example-tag:hover {
            background: #007bff;
            color: white;
            border-color: #007bff;
            transform: translateY(-1px);
        }
        .example-tag.selected {
            background: #28a745;
            color: white;
            border-color: #28a745;
            transform: scale(0.95);
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        /* ÏãúÎÇòÎ¶¨Ïò§ Í∑∏Î¶¨Îìú */
        .scenarios-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .scenario-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            border: 2px solid transparent;
        }

        .scenario-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border-color: #667eea;
        }

        .scenario-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .scenario-card .description {
            color: #7f8c8d;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .scenario-card .metadata {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tag {
            background: #f0f2ff;
            color: #667eea;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.85em;
        }

        .scenario-card .actions {
            display: flex;
            gap: 10px;
        }

        .scenario-card .actions button {
            flex: 1;
            padding: 8px;
            font-size: 0.9em;
        }

        /* ÏóêÌîºÏÜåÎìú Í∑∏Î¶¨Îìú */
        .episodes-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .episode-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 2px solid transparent;
        }

        .episode-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            border-color: #667eea;
        }

        .episode-card.empty {
            border: 2px dashed #e0e0e0;
            background: #fafafa;
        }

        .episode-card.empty:hover {
            border-color: #667eea;
            background: white;
        }

        .episode-card .episode-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .episode-card.completed {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: white;
        }

        .episode-card.completed .episode-number {
            color: white;
        }

        /* ÎÇúÏù¥ÎèÑ ÌÉ≠ */
        .difficulty-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }

        .difficulty-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .difficulty-tab:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .difficulty-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: transparent;
        }

        /* Ï∫êÎ¶≠ÌÑ∞ Í∑∏Î¶¨Îìú */
        .characters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .character-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .character-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border-color: #667eea;
        }

        .character-image {
            width: 80px;
            height: 80px;
            margin-bottom: 15px;
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .character-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .character-image .no-image {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            border-radius: 50%;
        }

        .character-info {
            text-align: center;
            width: 100%;
        }

        .character-card .mbti {
            display: inline-block;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 0.85em;
        }

        .character-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .character-card .traits {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        /* Î™®Îã¨ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 15px 15px 0 0;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5em;
        }

        .modal-body {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .modal-footer {
            background: #f5f5f5;
            padding: 20px 30px;
            border-radius: 0 0 15px 15px;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

        .close {
            color: white;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }

        .close:hover {
            opacity: 1;
        }

        /* AI Ïª®ÌÖçÏä§Ìä∏ */
        .ai-context {
            background: #f8f9ff;
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            min-height: 100px;
        }

        /* ÎåÄÌôî ÎØ∏Î¶¨Î≥¥Í∏∞ */
        .dialogue-preview {
            background: #f8f9ff;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .dialogue-text {
            color: #2c3e50;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .narration-text {
            color: #7f8c8d;
            font-style: italic;
            margin-bottom: 15px;
        }

        .choices-list {
            list-style: none;
        }

        .choice-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .choice-item .impact {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 15px;
            font-size: 0.85em;
        }

        /* Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉùÍ∏∞ */
        .character-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .character-option {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .character-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .character-option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        /* Î°úÎî© */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Îπà ÏÉÅÌÉú */
        .empty-state {
            text-align: center;
            padding: 60px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 2px dashed #e0e0e0;
        }

        .empty-state h3 {
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        .empty-state p {
            color: #95a5a6;
            margin-bottom: 30px;
        }

        /* ÏßÑÌñâÎ∞î */
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }

        /* Î∞òÏùëÌòï */
        @media (max-width: 768px) {
            .episodes-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .scenarios-grid {
                grid-template-columns: 1fr;
            }
            
            .characters-grid {
                grid-template-columns: 1fr;
            }
        }

        /* AI Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±Í∏∞ Ï†ÑÏö© Ïä§ÌÉÄÏùº */
        .ai-character-generator .modal-content {
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .char-category {
            margin-bottom: 20px;
            padding: 25px;
            border: 2px solid #e1e5e9;
            border-radius: 20px;
            background: linear-gradient(135deg, #fdf7f9 0%, #fef9fc 100%);
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .char-category:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .char-category h3 {
            color: #d63384;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: bold;
        }

        .category-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        .appearance-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .genre-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* MBTI ÏÑ†ÌÉù Î≤ÑÌäº */
        .mbti-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .mbti-btn {
            padding: 15px 10px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .mbti-btn:hover {
            border-color: #d63384;
            background: #fdf2f8;
        }

        .mbti-btn.selected {
            border-color: #d63384;
            background: #d63384;
            color: white;
        }

        .mbti-btn small {
            display: block;
            font-size: 11px;
            font-weight: normal;
            opacity: 0.8;
        }

        /* ÏÑ±Í≤© ÌäπÏÑ± Î≤ÑÌäº */
        .trait-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .trait-btn {
            padding: 10px 8px;
            border: 1px solid #dee2e6;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            font-size: 13px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .trait-btn:hover {
            border-color: #fd7e14;
            background: #fff3cd;
        }

        .trait-btn.selected {
            border-color: #fd7e14;
            background: #fd7e14;
            color: white;
        }

        /* Í¥ÄÍ≥Ñ ÏÑ§Ï†ï Î≤ÑÌäº */
        .relationship-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .relationship-btn {
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }

        .relationship-btn:hover {
            border-color: #e83e8c;
            background: #f8d7da;
        }

        .relationship-btn.selected {
            border-color: #e83e8c;
            background: #e83e8c;
            color: white;
        }

        /* Ï∑®ÎØ∏ ÏÑ†ÌÉù Î≤ÑÌäº */
        .hobby-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .hobby-btn {
            padding: 10px 8px;
            border: 1px solid #dee2e6;
            border-radius: 15px;
            background: white;
            cursor: pointer;
            font-size: 12px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .hobby-btn:hover {
            border-color: #20c997;
            background: #d1ecf1;
        }

        .hobby-btn.selected {
            border-color: #20c997;
            background: #20c997;
            color: white;
        }

        /* ÎßêÌà¨ Ïä§ÌÉÄÏùº Î≤ÑÌäº */
        .speech-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .speech-btn {
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-size: 13px;
        }

        .speech-btn:hover {
            border-color: #6f42c1;
            background: #f8f9fa;
        }

        .speech-btn.selected {
            border-color: #6f42c1;
            background: #6f42c1;
            color: white;
        }

        /* AI ÏÉùÏÑ± ÏòÅÏó≠ */
        .ai-generation {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px dashed #6c757d;
        }

        .ai-controls {
            text-align: center;
            margin-bottom: 15px;
        }

        .btn-ai {
            background: linear-gradient(45deg, #6f42c1, #e83e8c);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-ai:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(111, 66, 193, 0.3);
        }

        .generation-status {
            margin-top: 10px;
            font-style: italic;
            color: #6c757d;
        }

        .generated-preview {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid #dee2e6;
        }

        /* Î∞òÏùëÌòï Ï°∞Ï†ï */
        @media (max-width: 768px) {
            .ai-character-generator .modal-content {
                max-width: 95%;
                margin: 2% auto;
            }
            
            .category-grid {
                grid-template-columns: 1fr;
            }
            
            .mbti-options {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .trait-options {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .relationship-options {
                grid-template-columns: 1fr;
            }
            
            .hobby-options {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .speech-options {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="header">
            <h1>üéÆ ÌÜµÌï© Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú</h1>
            <p>MBTI Î°úÎß®Ïä§ Í≤åÏûÑÏùò ÏãúÎÇòÎ¶¨Ïò§, ÏóêÌîºÏÜåÎìú, Ï∫êÎ¶≠ÌÑ∞Î•º Ìïú Í≥≥ÏóêÏÑú Í¥ÄÎ¶¨Ìï©ÎãàÎã§</p>
        </div>

        <!-- ÌÉ≠ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('characters')">
                üë• Ï∫êÎ¶≠ÌÑ∞ Í¥ÄÎ¶¨
                <span class="badge" id="characterCount">0</span>
            </button>
            <button class="nav-tab" onclick="switchTab('scenarios')">
                üìö ÏãúÎÇòÎ¶¨Ïò§ Í¥ÄÎ¶¨
                <span class="badge" id="scenarioCount">0</span>
            </button>
            <button class="nav-tab" onclick="switchTab('episodes')">
                üìù ÏóêÌîºÏÜåÎìú Í¥ÄÎ¶¨
                <span class="badge" id="episodeCount">0</span>
            </button>
        </div>

        <!-- Ï∫êÎ¶≠ÌÑ∞ Í¥ÄÎ¶¨ ÏÑπÏÖò -->
        <div id="characters-section" class="content-section active">
            <div class="stats-row">
                <div class="stat-card">
                    <h3>Ï†ÑÏ≤¥ Ï∫êÎ¶≠ÌÑ∞</h3>
                    <div class="value" id="totalCharacters">0</div>
                </div>
                <div class="stat-card">
                    <h3>ÌôúÏÑ± Ï∫êÎ¶≠ÌÑ∞</h3>
                    <div class="value" id="activeCharacters">0</div>
                </div>
                <div class="stat-card">
                    <h3>AI ÏÉùÏÑ± Ï∫êÎ¶≠ÌÑ∞</h3>
                    <div class="value" id="aiGeneratedCharacters">0</div>
                </div>
                <div class="stat-card">
                    <h3>Ï∫êÎ¶≠ÌÑ∞ ÌèâÍ∑† Ìò∏Í∞êÎèÑ</h3>
                    <div class="value" id="avgCharacterAffection">0</div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openCharacterModal('create')" style="background: linear-gradient(135deg, #e91e63, #9c27b0); font-size: 16px; padding: 15px 25px;">
                    üé≠‚ú® AI Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±Í∏∞
                </button>
                <button class="btn btn-secondary" onclick="loadCharacters()">
                    üîÑ ÏÉàÎ°úÍ≥†Ïπ®
                </button>
                <button class="btn btn-warning" onclick="resetAllCharacters()" style="background: #ff9800; color: white;">
                    üóëÔ∏è Î™®Îì† ÎçîÎØ∏ Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú
                </button>
            </div>

            <div id="charactersContainer" class="characters-grid">
                <!-- Ï∫êÎ¶≠ÌÑ∞ Ïπ¥ÎìúÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
            </div>
        </div>

        <!-- ÏóêÌîºÏÜåÎìú Í¥ÄÎ¶¨ ÏÑπÏÖò -->
        <div id="episodes-section" class="content-section">
            <div class="form-group">
                <label for="episodeScenarioSelect">ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉù:</label>
                <select id="episodeScenarioSelect" onchange="loadEpisodes()">
                    <option value="">ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                </select>
                <button type="button" class="btn btn-secondary" onclick="refreshEpisodeScenarioList()" style="margin-left: 10px;">
                    üîÑ ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                </button>
            </div>
            
            <!-- ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÌëúÏãú -->
            <div id="availableScenariosList" class="scenarios-list" style="margin-bottom: 20px;">
                <h4>üìã ÏÇ¨Ïö© Í∞ÄÎä•Ìïú ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù</h4>
                <div id="scenariosList">
                    <p class="loading-text">ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ùÏùÑ Î°úÎî© Ï§ë...</p>
                </div>
            </div>

            <div id="episodeInfo" style="display: none;">
                <div class="stats-row">
                    <div class="stat-card">
                        <h3>Ï†ÑÏ≤¥ ÏóêÌîºÏÜåÎìú</h3>
                        <div class="value" id="totalEpisodes">0/36</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <h3>Easy (1-9)</h3>
                        <div class="value" id="easyCount">0/9</div>
                    </div>
                    <div class="stat-card">
                        <h3>Medium (10-18)</h3>
                        <div class="value" id="mediumCount">0/9</div>
                    </div>
                    <div class="stat-card">
                        <h3>Hard (19-27)</h3>
                        <div class="value" id="hardCount">0/9</div>
                    </div>
                    <div class="stat-card">
                        <h3>Expert (28-36)</h3>
                        <div class="value" id="expertCount">0/9</div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="openEpisodeModal('create')">
                        ‚ú® ÏÉà ÏóêÌîºÏÜåÎìú ÏÉùÏÑ±
                    </button>
                    <button class="btn btn-secondary" onclick="generateBulkEpisodes()">
                        üöÄ ÏùºÍ¥Ñ ÏÉùÏÑ± (AI)
                    </button>
                    <button class="btn btn-secondary" onclick="loadEpisodes()">
                        üîÑ ÏÉàÎ°úÍ≥†Ïπ®
                    </button>
                </div>

                <div class="difficulty-tabs">
                    <div class="difficulty-tab active" onclick="filterByDifficulty('all')">
                        Ï†ÑÏ≤¥ <strong id="allCount">0</strong>
                    </div>
                    <div class="difficulty-tab" onclick="filterByDifficulty('easy')">
                        Easy <strong id="easyTabCount">0</strong>
                    </div>
                    <div class="difficulty-tab" onclick="filterByDifficulty('medium')">
                        Medium <strong id="mediumTabCount">0</strong>
                    </div>
                    <div class="difficulty-tab" onclick="filterByDifficulty('hard')">
                        Hard <strong id="hardTabCount">0</strong>
                    </div>
                    <div class="difficulty-tab" onclick="filterByDifficulty('expert')">
                        Expert <strong id="expertTabCount">0</strong>
                    </div>
                </div>

                <div id="episodesGrid" class="episodes-grid">
                    <!-- 36Í∞úÏùò ÏóêÌîºÏÜåÎìú Ïπ¥ÎìúÍ∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                </div>
            </div>
        </div>

        <!-- ÏãúÎÇòÎ¶¨Ïò§ Í¥ÄÎ¶¨ ÏÑπÏÖò -->
        <div id="scenarios-section" class="content-section">
            <div class="stats-row">
                <div class="stat-card">
                    <h3>Ï†ÑÏ≤¥ ÏãúÎÇòÎ¶¨Ïò§</h3>
                    <div class="value" id="totalScenarios">0</div>
                </div>
                <div class="stat-card">
                    <h3>ÌôúÏÑ± ÏãúÎÇòÎ¶¨Ïò§</h3>
                    <div class="value" id="activeScenarios">0</div>
                </div>
                <div class="stat-card">
                    <h3>AI ÏÉùÏÑ± ÏãúÎÇòÎ¶¨Ïò§</h3>
                    <div class="value" id="aiGeneratedScenarios">0</div>
                </div>
                <div class="stat-card">
                    <h3>ÏóêÌîºÏÜåÎìú Ïàò</h3>
                    <div class="value" id="totalDialogues">0</div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openScenarioModal('create')" style="background: linear-gradient(135deg, #667eea, #764ba2); font-size: 16px; padding: 15px 25px;">
                    ‚ú® ÏÉà ÏãúÎÇòÎ¶¨Ïò§ ÎßåÎì§Í∏∞
                </button>
                <button class="btn btn-secondary" onclick="loadScenarios()">
                    üîÑ ÏÉàÎ°úÍ≥†Ïπ®
                </button>
            </div>

            <div id="scenariosContainer" class="scenarios-grid">
                <!-- ÏãúÎÇòÎ¶¨Ïò§ Ïπ¥ÎìúÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
            </div>
        </div>
    </div>

    <!-- ÏãúÎÇòÎ¶¨Ïò§ Î™®Îã¨ -->
    <div id="scenarioModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeModal('scenarioModal')">&times;</span>
                <h2 id="scenarioModalTitle">ÏÉà ÏãúÎÇòÎ¶¨Ïò§ ÎßåÎì§Í∏∞</h2>
            </div>
            <div class="modal-body">
                <form id="scenarioForm">
                    <input type="hidden" id="scenarioId" />
                    
                    <div class="form-group">
                        <label for="scenarioTitle">ÏãúÎÇòÎ¶¨Ïò§ Ï†úÎ™© *</label>
                        <input type="text" id="scenarioTitle" required placeholder="ÌÅ¥Î¶≠Ìï¥ÏÑú ÏòàÏãú ÏÑ†ÌÉù" />
                        <div class="examples-container">
                            <span class="examples-label">ÏòàÏãú:</span>
                            <div class="examples-grid">
                                <span class="example-tag" onclick="fillExample('scenarioTitle', this)">Ïñ¥Ï†ú Î∞§Ïùò Í∏∞Ïñµ</span>
                                <span class="example-tag" onclick="fillExample('scenarioTitle', this)">Ïö¥Î™ÖÏùò ÎßåÎÇ®</span>
                                <span class="example-tag" onclick="fillExample('scenarioTitle', this)">ÎèÑÏÑúÍ¥ÄÏùò ÏÜçÏÇ≠ÏûÑ</span>
                                <span class="example-tag" onclick="fillExample('scenarioTitle', this)">Ïπ¥ÌéòÏùò ÌäπÎ≥ÑÌïú ÏÜêÎãò</span>
                                <span class="example-tag" onclick="fillExample('scenarioTitle', this)">Ï≤´ ÎààÏù¥ ÎÇ¥Î¶∞ ÎÇ†</span>
                                <span class="example-tag" onclick="fillExample('scenarioTitle', this)">Î≤öÍΩÉÏù¥ Ìù©ÎÇ†Î¶¨Îçò ÏàúÍ∞Ñ</span>
                                <span class="example-tag" onclick="fillExample('scenarioTitle', this)">Ïö∞Ïó∞Ìïú Ïû¨Ìöå</span>
                                <span class="example-tag" onclick="fillExample('scenarioTitle', this)">Îã¨Îπõ ÏïÑÎûòÏùò Í≥†Î∞±</span>
                                <span class="example-tag" onclick="fillExample('scenarioTitle', this)">ÏßÄÍ∏à Ïù¥ ÏàúÍ∞Ñ</span>
                                <span class="example-tag" onclick="fillExample('scenarioTitle', this)">ÎÑàÏóêÍ≤å ÎãøÍ∏∞Î•º</span>
                                <span class="example-tag" onclick="fillExample('scenarioTitle', this)">ÎßàÏßÄÎßâ Ïó¨Î¶ÑÎÇ†</span>
                                <span class="example-tag" onclick="fillExample('scenarioTitle', this)">ÎπÑ Ïò§Îäî ÎÇ†Ïùò Ïö∞ÏÇ∞</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="scenarioDescription">ÏãúÎÇòÎ¶¨Ïò§ ÏÑ§Î™Ö *</label>
                        <textarea id="scenarioDescription" required placeholder="ÌÅ¥Î¶≠Ìï¥ÏÑú ÏòàÏãú ÏÑ†ÌÉù"></textarea>
                        <div class="examples-container">
                            <span class="examples-label">ÏòàÏãú:</span>
                            <div class="examples-grid">
                                <span class="example-tag" onclick="fillExample('scenarioDescription', this)">Ï∑®Ìïú ÏÉÅÌÉúÏóêÏÑú ÏßÑÏã¨ÏùÑ Í≥†Î∞±Ìïú ÌõÑ, Îã§Ïùå ÎÇ† Ïñ¥ÏÉâÌï¥ÏßÑ Îëê ÏÇ¨ÎûåÏùò Ïù¥ÏïºÍ∏∞</span>
                                <span class="example-tag" onclick="fillExample('scenarioDescription', this)">Îß§Ïùº Í∞ôÏùÄ ÏãúÍ∞Ñ, Í∞ôÏùÄ Ïπ¥ÌéòÏóêÏÑú ÎßàÏ£ºÏπòÎäî Îëê ÏÇ¨ÎûåÏù¥ ÏÑúÎ°úÏóêÍ≤å Í¥ÄÏã¨ÏùÑ Í∞ñÍ≤å ÎêòÎäî ÏÉÅÌô©</span>
                                <span class="example-tag" onclick="fillExample('scenarioDescription', this)">ÎèÑÏÑúÍ¥ÄÏóêÏÑú Ïö∞Ïó∞Ìûà Í∞ôÏùÄ Ï±ÖÏùÑ ÏùΩÍ≥† ÏûàÎçò Îëê ÏÇ¨ÎûåÏù¥ Ï°∞Í∏àÏî© Í∞ÄÍπåÏõåÏßÄÎäî Í≥ºÏ†ï</span>
                                <span class="example-tag" onclick="fillExample('scenarioDescription', this)">ÎèôÏïÑÎ¶¨ MTÏóêÏÑú Ï≤òÏùå ÎßåÎÇú ÏÑ†ÌõÑÎ∞∞Í∞Ä ÌäπÎ≥ÑÌïú Í∞êÏ†ïÏùÑ ÎäêÎÅºÍ≤å ÎêòÎäî Ïù¥ÏïºÍ∏∞</span>
                                <span class="example-tag" onclick="fillExample('scenarioDescription', this)">ÎπÑ Ïò§Îäî ÎÇ† Ïö∞ÏÇ∞ÏùÑ Ìï®Íªò Ïì∞Í≤å Îêú Îëê ÏÇ¨ÎûåÏùò ÏÑ§Î†àÎäî ÎßåÎÇ®</span>
                                <span class="example-tag" onclick="fillExample('scenarioDescription', this)">Í≥ºÏ†úÎ•º Ìï®Íªò ÌïòÎ©¥ÏÑú ÏÑúÎ°úÎ•º ÏïåÏïÑÍ∞ÄÎäî ÌåÄÏõêÎì§Ïùò Î°úÎß®Ïä§</span>
                                <span class="example-tag" onclick="fillExample('scenarioDescription', this)">Ï°∏ÏóÖÏùÑ ÏïûÎëêÍ≥† ÎßàÏßÄÎßâÏúºÎ°ú Ï†ÑÌïòÍ≥† Ïã∂ÏóàÎçò ÎßàÏùåÏùÑ Í≥†Î∞±ÌïòÎäî ÏÉÅÌô©</span>
                                <span class="example-tag" onclick="fillExample('scenarioDescription', this)">ÏÉà ÌïôÍ∏∞ Ï≤´ÎÇ† Ïö∞Ïó∞Ìûà ÎßàÏ£ºÏπú Îëê ÏÇ¨ÎûåÏùò Ï≤´Ïù∏ÏÉÅÍ≥º Í∑∏ Ïù¥ÌõÑÏùò Ïù¥ÏïºÍ∏∞</span>
                                <span class="example-tag" onclick="fillExample('scenarioDescription', this)">Ï∂ïÏ†ú Ï§ÄÎπÑÎ•º ÌïòÎ©¥ÏÑú ÏûêÏó∞Ïä§ÎüΩÍ≤å Í∞ÄÍπåÏõåÏßÄÎäî ÌïôÏÉùÌöå Î©§Î≤ÑÎì§Ïùò Ïù¥ÏïºÍ∏∞</span>
                                <span class="example-tag" onclick="fillExample('scenarioDescription', this)">Ïä§ÌÑ∞Îîî Í∑∏Î£πÏóêÏÑú ÎßåÎÇú Îëê ÏÇ¨ÎûåÏù¥ ÌïôÏóÖÏùÑ ÌÜµÌï¥ ÎßàÏùåÏùÑ ÎÇòÎàÑÍ≤å ÎêòÎäî Í≥ºÏ†ï</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="backgroundSetting">Î∞∞Í≤Ω ÏÑ§Ï†ï *</label>
                        <input type="text" id="backgroundSetting" required placeholder="ÌÅ¥Î¶≠Ìï¥ÏÑú ÏòàÏãú ÏÑ†ÌÉù" />
                        <div class="examples-container">
                            <span class="examples-label">ÏòàÏãú:</span>
                            <div class="examples-grid">
                                <span class="example-tag" onclick="fillExample('backgroundSetting', this)">ÎåÄÌïôÍµê Ï∫†ÌçºÏä§</span>
                                <span class="example-tag" onclick="fillExample('backgroundSetting', this)">Ï°∞Ïö©Ìïú Ïπ¥Ìéò</span>
                                <span class="example-tag" onclick="fillExample('backgroundSetting', this)">Ï§ëÏïô ÎèÑÏÑúÍ¥Ä</span>
                                <span class="example-tag" onclick="fillExample('backgroundSetting', this)">Î≤öÍΩÉÏù¥ ÎßåÎ∞úÌïú Í≥µÏõê</span>
                                <span class="example-tag" onclick="fillExample('backgroundSetting', this)">Í∏∞ÏàôÏÇ¨ ÎùºÏö¥ÏßÄ</span>
                                <span class="example-tag" onclick="fillExample('backgroundSetting', this)">ÌïôÍµê Ï∂ïÏ†ú ÌòÑÏû•</span>
                                <span class="example-tag" onclick="fillExample('backgroundSetting', this)">Í∞ïÏùòÏã§</span>
                                <span class="example-tag" onclick="fillExample('backgroundSetting', this)">ÎåÄÌïôÍ∞Ä Ïà†Ïßë</span>
                                <span class="example-tag" onclick="fillExample('backgroundSetting', this)">Ï∫†ÌçºÏä§ Îí§Îú∞</span>
                                <span class="example-tag" onclick="fillExample('backgroundSetting', this)">ÌïôÏÉùÏãùÎãπ</span>
                                <span class="example-tag" onclick="fillExample('backgroundSetting', this)">ÎèôÏïÑÎ¶¨Ïã§</span>
                                <span class="example-tag" onclick="fillExample('backgroundSetting', this)">ÏïºÍ∞Ñ Ï∫†ÌçºÏä§</span>
                                <span class="example-tag" onclick="fillExample('backgroundSetting', this)">Í≥ÑÎã® ÍµêÏã§</span>
                                <span class="example-tag" onclick="fillExample('backgroundSetting', this)">ÏùåÏïÖÏã§</span>
                                <span class="example-tag" onclick="fillExample('backgroundSetting', this)">Ïò•ÏÉÅ Ï†ïÏõê</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="mood">Î∂ÑÏúÑÍ∏∞/Î¨¥Îìú *</label>
                        <input type="text" id="mood" required placeholder="ÌÅ¥Î¶≠Ìï¥ÏÑú ÏòàÏãú ÏÑ†ÌÉù" />
                        <div class="examples-container">
                            <span class="examples-label">ÏòàÏãú:</span>
                            <div class="examples-grid">
                                <span class="example-tag" onclick="fillExample('mood', this)">Î°úÎß®Ìã±</span>
                                <span class="example-tag" onclick="fillExample('mood', this)">ÏÑ§Î†ò</span>
                                <span class="example-tag" onclick="fillExample('mood', this)">Îã¨ÏΩ§Ìï®</span>
                                <span class="example-tag" onclick="fillExample('mood', this)">Í∏¥Ïû•Í∞ê</span>
                                <span class="example-tag" onclick="fillExample('mood', this)">ÎìúÎùºÎßàÌã±</span>
                                <span class="example-tag" onclick="fillExample('mood', this)">ÏΩîÎØπ</span>
                                <span class="example-tag" onclick="fillExample('mood', this)">ÌòÑÏã§Ï†Å</span>
                                <span class="example-tag" onclick="fillExample('mood', this)">Îî∞ÎúªÌï®</span>
                                <span class="example-tag" onclick="fillExample('mood', this)">Ïã†ÎπÑÎ°úÏõÄ</span>
                                <span class="example-tag" onclick="fillExample('mood', this)">Ï≤≠Ï∂ò</span>
                                <span class="example-tag" onclick="fillExample('mood', this)">ÏàúÏàòÌï®</span>
                                <span class="example-tag" onclick="fillExample('mood', this)">Í∞êÏÑ±Ï†Å</span>
                                <span class="example-tag" onclick="fillExample('mood', this)">Î™ΩÌôòÏ†Å</span>
                                <span class="example-tag" onclick="fillExample('mood', this)">ÏïÑÎ†®Ìï®</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉù</label>
                        <div id="characterLoadingMsg" style="padding: 20px; text-align: center; color: #666;">
                            Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ùÏùÑ Î°úÎî© Ï§ëÏûÖÎãàÎã§...
                        </div>
                        <div class="character-selector" id="characterSelector" style="display: none;">
                            <!-- ÎèôÏ†ÅÏúºÎ°ú Î°úÎìúÎê©ÎãàÎã§ -->
                        </div>
                    </div>

                    <div class="form-group">
                        <label>AI ÏÉùÏÑ± Ïª®ÌÖçÏä§Ìä∏</label>
                        <button type="button" class="btn btn-secondary" onclick="generateAIContext()">
                            ü§ñ AI Ïª®ÌÖçÏä§Ìä∏ ÏÉùÏÑ±
                        </button>
                        <div id="aiContext" class="ai-context">
                            AIÍ∞Ä ÏÉùÏÑ±Ìïú ÏÜåÏÑ§Ìíç ÏãúÎÇòÎ¶¨Ïò§ Ïª®ÌÖçÏä§Ìä∏Í∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="customContext">Ïª§Ïä§ÌÖÄ Ïª®ÌÖçÏä§Ìä∏ (ÏÑ†ÌÉùÏÇ¨Ìï≠)</label>
                        <textarea id="customContext" placeholder="AI Ïª®ÌÖçÏä§Ìä∏Î•º ÏàòÏ†ïÌïòÍ±∞ÎÇò ÏßÅÏ†ë ÏûëÏÑ±Ìï† Ïàò ÏûàÏäµÎãàÎã§"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('scenarioModal')">Ï∑®ÏÜå</button>
                <button type="button" class="btn btn-primary" onclick="saveScenario()">Ï†ÄÏû•</button>
            </div>
        </div>
    </div>

    <!-- ÏóêÌîºÏÜåÎìú Î™®Îã¨ -->
    <div id="episodeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeModal('episodeModal')">&times;</span>
                <h2 id="episodeModalTitle">ÏÉà ÏóêÌîºÏÜåÎìú ÏÉùÏÑ±</h2>
            </div>
            <div class="modal-body">
                <form id="episodeForm">
                    <input type="hidden" id="episodeId" />
                    <input type="hidden" id="episodeScenarioId" />
                    
                    <div class="form-group">
                        <label for="episodeScenarioSelect">ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉù *</label>
                        <select id="episodeScenarioSelect" required onchange="onScenarioChange()">
                            <option value="">ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                        </select>
                        <small class="form-text">ÏóêÌîºÏÜåÎìúÎ•º ÏÉùÏÑ±Ìï† ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.</small>
                    </div>

                    <div class="form-group">
                        <label for="episodeNumber">ÏóêÌîºÏÜåÎìú Î≤àÌò∏ (1-36) *</label>
                        <input type="number" id="episodeNumber" min="1" max="36" required />
                    </div>

                    <div class="form-group">
                        <label for="characterSelect">Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉù *</label>
                        <select id="characterSelect" required>
                            <option value="">Î®ºÏ†Ä ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                        </select>
                        <small class="form-text">ÏÑ†ÌÉùÌïú ÏãúÎÇòÎ¶¨Ïò§ÏóêÏÑú ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ï∫êÎ¶≠ÌÑ∞Îßå ÌëúÏãúÎê©ÎãàÎã§.</small>
                    </div>

                    <div class="form-group">
                        <label for="difficulty">ÎÇúÏù¥ÎèÑ *</label>
                        <select id="difficulty" required>
                            <option value="easy">Easy (1-9)</option>
                            <option value="medium">Medium (10-18)</option>
                            <option value="hard">Hard (19-27)</option>
                            <option value="expert">Expert (28-36)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="userPrompt">ÏÉÅÌô© ÌîÑÎ°¨ÌîÑÌä∏ *</label>
                        <textarea id="userPrompt" required placeholder="Ïòà: Ïö∞Ïó∞Ìûà ÎèÑÏÑúÍ¥ÄÏóêÏÑú ÎßåÎÇú ÏÉÅÌô©, Í∏¥Ïû•Í∞êÍ≥º ÏÑ§Î†òÏù¥ ÍµêÏ∞®ÌïòÎäî ÏàúÍ∞Ñ"></textarea>
                    </div>

                    <div class="form-group">
                        <label>AI ÎåÄÌôî ÏÉùÏÑ±</label>
                        <button type="button" class="btn btn-secondary" onclick="generateDialogue()">
                            ü§ñ AI ÎåÄÌôî ÏÉùÏÑ±
                        </button>
                    </div>

                    <div id="dialoguePreview" class="dialogue-preview" style="display: none;">
                        <h4>ÏÉùÏÑ±Îêú ÎåÄÌôî ÎØ∏Î¶¨Î≥¥Í∏∞</h4>
                        <div class="dialogue-text" id="previewDialogue"></div>
                        <div class="narration-text" id="previewNarration"></div>
                        <ul class="choices-list" id="previewChoices"></ul>
                    </div>

                    <div class="form-group">
                        <label for="customDialogue">Ïª§Ïä§ÌÖÄ ÎåÄÌôî (ÏÑ†ÌÉùÏÇ¨Ìï≠)</label>
                        <textarea id="customDialogue" placeholder="AIÍ∞Ä ÏÉùÏÑ±Ìïú ÎåÄÌôîÎ•º ÏàòÏ†ïÌïòÍ±∞ÎÇò ÏßÅÏ†ë ÏûëÏÑ±Ìï† Ïàò ÏûàÏäµÎãàÎã§"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="customNarration">Ïª§Ïä§ÌÖÄ ÎÇòÎ†àÏù¥ÏÖò (ÏÑ†ÌÉùÏÇ¨Ìï≠)</label>
                        <textarea id="customNarration" placeholder="ÏÉÅÌô© ÏÑ§Î™ÖÏù¥ÎÇò Ï∫êÎ¶≠ÌÑ∞Ïùò ÌñâÎèôÏùÑ Î¨òÏÇ¨Ìï©ÎãàÎã§"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('episodeModal')">Ï∑®ÏÜå</button>
                <button type="button" class="btn btn-primary" onclick="saveEpisode()">Ï†ÄÏû•</button>
            </div>
        </div>
    </div>

    <!-- Ï∫êÎ¶≠ÌÑ∞ Î™®Îã¨ - AI ÌÜµÌï©Ìòï ÏÉùÏÑ± ÏãúÏä§ÌÖú -->
    <div id="characterModal" class="modal">
        <div class="modal-content ai-character-generator">
            <div class="modal-header">
                <span class="close" onclick="closeModal('characterModal')">&times;</span>
                <h2 id="characterModalTitle">üé≠‚ú® ÏÑ∏Í≥ÑÍ¥Ä ÏµúÍ∞ï AI Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±Í∏∞</h2>
                <p style="text-align: center; color: #666; margin-top: 5px;">Ïä§ÌÅ¨Î°§ÌïòÎ©∞ ÏõêÌïòÎäî ÏöîÏÜåÎì§ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî üíñ</p>
            </div>
            <div class="modal-body">
                <form id="characterForm">
                    <input type="hidden" id="characterId" />
                    
                    <!-- ÏÇ¨ÏßÑ Î∂ÑÏÑù ÏÑ≠ÏÖò -->
                    <div class="char-category">
                        <h3>üì∑ ÏÇ¨ÏßÑ Î∂ÑÏÑù</h3>
                        <p style="text-align: center; color: #666; margin-bottom: 15px;">Ï∫êÎ¶≠ÌÑ∞ ÏÇ¨ÏßÑÏùÑ ÏóÖÎ°úÎìúÌïòÎ©¥ AIÍ∞Ä Ïô∏Î™®ÏôÄ ÏÑ±Í≤©ÏùÑ Î∂ÑÏÑùÌï¥ÎìúÎ¶ΩÎãàÎã§</p>
                        <div style="text-align: center; margin-bottom: 20px;">
                            <input type="file" id="characterImageUpload" accept="image/*" style="display: none;" onchange="handleImageUpload()">
                            <button type="button" class="btn btn-primary" onclick="document.getElementById('characterImageUpload').click()" style="background: #4CAF50;">
                                üì∑ ÏÇ¨ÏßÑ ÏóÖÎ°úÎìú
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="analyzeCharacterImage()" id="analyzeImageBtn" disabled>
                                ü§ñ Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù
                            </button>
                        </div>
                        <div id="imagePreview" style="display: none; text-align: center; margin-bottom: 15px;">
                            <img id="previewImg" style="max-width: 200px; max-height: 200px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                        </div>
                        <div id="analysisResult" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <h4 style="color: #28a745; margin-bottom: 10px;">üîç AI Î∂ÑÏÑù Í≤∞Í≥º</h4>
                            <div id="analysisContent"></div>
                            <button type="button" class="btn btn-success" onclick="applyAnalysisToForm()" id="applyAnalysisBtn" style="margin-top: 10px;">
                                ‚ú® Î∂ÑÏÑù Í≤∞Í≥º Ï†ÅÏö©
                            </button>
                        </div>
                    </div>
                    
                    <!-- Í∏∞Î≥∏ Ï†ïÎ≥¥ -->
                    <div class="char-category">
                        <h3>üíñ Í∏∞Î≥∏ Ï†ïÎ≥¥</h3>
                        <div class="category-grid">
                            <div class="form-group">
                                <label>Ï∫êÎ¶≠ÌÑ∞ Ïù¥Î¶Ñ</label>
                                <input type="text" id="charName" placeholder="Ïòà: Ïú§ÏïÑ, ÏàòÏßÑ, ÌòúÏõê" />
                            </div>
                            <div class="form-group">
                                <label>ÎÇòÏù¥</label>
                                <select id="charAge">
                                    <option value="19">19ÏÑ∏ (ÎåÄÌïô Ïã†ÏûÖÏÉù)</option>
                                    <option value="20" selected>20ÏÑ∏ (ÎåÄÌïôÏÉù)</option>
                                    <option value="21">21ÏÑ∏ (ÎåÄÌïôÏÉù)</option>
                                    <option value="22">22ÏÑ∏ (ÎåÄÌïô ÏÑ†Î∞∞)</option>
                                    <option value="23">23ÏÑ∏ (ÎåÄÌïôÏõêÏÉù)</option>
                                    <option value="24">24ÏÑ∏ (ÎåÄÌïôÏõêÏÉù)</option>
                                    <option value="25">25ÏÑ∏ (ÏÇ¨Ìöå Ï¥àÎÖÑÏÉù)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Ï∫êÎ¶≠ÌÑ∞ ÌÉÄÏûÖ</label>
                                <select id="charType">
                                    <option value="romance_junior">üå∏ Î°úÎß®Ïä§ ÌõÑÎ∞∞</option>
                                    <option value="romance_peer">üíï Î°úÎß®Ïä§ ÎèôÍ∞ë</option>
                                    <option value="romance_senior">üíñ Î°úÎß®Ïä§ ÏÑ†Î∞∞</option>
                                    <option value="childhood_friend">üé™ ÏÜåÍøâÏπúÍµ¨</option>
                                    <option value="mysterious_girl">üåô ÎØ∏Ïä§ÌÑ∞Î¶¨ Ïó¨ÏÑ±</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- ÏÑ±Í≤© ÏÑ§Ï†ï (MBTI Í∏∞Î∞ò) -->
                    <div class="char-category">
                        <h3>üß† ÏÑ±Í≤© ÏÑ§Ï†ï</h3>
                        <div class="mbti-selector">
                            <div class="mbti-group">
                                <label>MBTI Ïú†Ìòï (16Í∞ÄÏßÄ Ï†ÑÏ≤¥)</label>
                                <div class="mbti-options">
                                    <button type="button" class="mbti-btn" data-mbti="INFP">INFP<br><small>Í∞êÏÑ±Ï†Å Ï§ëÏû¨Ïûê</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="ENFP">ENFP<br><small>ÌôúÎ∞úÌïú ÌôúÎèôÍ∞Ä</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="INFJ">INFJ<br><small>ÏòπÌò∏Ïûê</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="ENFJ">ENFJ<br><small>Ï†ïÏùòÎ°úÏö¥ ÏÇ¨ÌöåÏö¥ÎèôÍ∞Ä</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="INTJ">INTJ<br><small>ÏôÑÎ≤ΩÌïú Ï†ÑÎûµÍ∞Ä</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="ENTJ">ENTJ<br><small>ÎåÄÎã¥Ìïú ÌÜµÏÜîÏûê</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="INTP">INTP<br><small>ÎÖºÎ¶¨Ï†Å ÏÇ¨ÏÉâÍ∞Ä</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="ENTP">ENTP<br><small>Îú®Í±∞Ïö¥ ÌÜ†Î°†Í∞Ä</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="ISFP">ISFP<br><small>Î™®ÌóòÍ∞Ä</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="ESFP">ESFP<br><small>ÏûêÏú†Î°úÏö¥ ÏòÅÌòº</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="ISTP">ISTP<br><small>ÎßåÎä• Ïû¨Ï£ºÍæº</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="ESTP">ESTP<br><small>Î™®ÌóòÏùÑ Ï¶êÍ∏∞Îäî ÏÇ¨ÏóÖÍ∞Ä</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="ISFJ">ISFJ<br><small>Ï°∞Ïö©Ìïú Î≥¥Ìò∏Ïûê</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="ESFJ">ESFJ<br><small>Îî∞ÎúªÌïú ÏÇ¨ÍµêÍ∞Ä</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="ISTJ">ISTJ<br><small>ÏóÑÍ≤©Ìïú Í¥ÄÎ¶¨Ïûê</small></button>
                                    <button type="button" class="mbti-btn" data-mbti="ESTJ">ESTJ<br><small>ÏóÑÍ≤©Ìïú Í¥ÄÎ¶¨Ïûê</small></button>
                                </div>
                                <input type="hidden" id="charMbti" />
                            </div>
                            <div class="personality-traits">
                                <label>ÏÑ±Í≤© ÌäπÏÑ± (ÏµúÎåÄ 3Í∞ú ÏÑ†ÌÉù)</label>
                                <div class="trait-options">
                                    <button type="button" class="trait-btn" data-trait="Í∞êÏÑ±Ï†Å">üòä Í∞êÏÑ±Ï†Å</button>
                                    <button type="button" class="trait-btn" data-trait="ÌôúÎ∞úÌïú">‚ú® ÌôúÎ∞úÌïú</button>
                                    <button type="button" class="trait-btn" data-trait="ÎÇ¥Ìñ•Ï†Å">üå∏ ÎÇ¥Ìñ•Ï†Å</button>
                                    <button type="button" class="trait-btn" data-trait="Ïù¥ÏÉÅÏ£ºÏùòÏ†Å">üåô Ïù¥ÏÉÅÏ£ºÏùòÏ†Å</button>
                                    <button type="button" class="trait-btn" data-trait="Ï∞ΩÏùòÏ†Å">üé® Ï∞ΩÏùòÏ†Å</button>
                                    <button type="button" class="trait-btn" data-trait="Î∞∞Î†§Ïã¨ ÎßéÏùÄ">üíï Î∞∞Î†§Ïã¨ ÎßéÏùÄ</button>
                                    <button type="button" class="trait-btn" data-trait="Ï∞®Î∂ÑÌïú">üçÉ Ï∞®Î∂ÑÌïú</button>
                                    <button type="button" class="trait-btn" data-trait="Ïó¥Ï†ïÏ†Å">üî• Ïó¥Ï†ïÏ†Å</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Î∞∞Í≤Ω ÏÑ§Ï†ï -->
                    <div class="char-category">
                        <h3>üéì Î∞∞Í≤Ω ÏÑ§Ï†ï</h3>
                        <div class="category-grid">
                            <div class="form-group">
                                <label>Ï†ÑÍ≥µ/ÏßÅÏóÖ</label>
                                <select id="charMajor">
                                    <option value="art">üé® ÏòàÏà†ÎåÄÌïô (ÎØ∏Ïà†, ÎîîÏûêÏù∏)</option>
                                    <option value="literature">üìö Î¨∏Í≥ºÎåÄÌïô (Î¨∏Ìïô, Ïñ¥Ìïô)</option>
                                    <option value="music">üéµ ÏùåÏïÖÎåÄÌïô</option>
                                    <option value="psychology">üß† Ïã¨Î¶¨ÌïôÍ≥º</option>
                                    <option value="education">üë©‚Äçüè´ ÏÇ¨Î≤îÎåÄÌïô</option>
                                    <option value="nursing">üë©‚Äç‚öïÔ∏è Í∞ÑÌò∏ÌïôÍ≥º</option>
                                    <option value="business">üíº Í≤ΩÏòÅÌïôÍ≥º</option>
                                    <option value="media">üì∫ Ïñ∏Î°†Ï†ïÎ≥¥ÌïôÍ≥º</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Í∞ÄÏ°± Í¥ÄÍ≥Ñ</label>
                                <select id="charFamily">
                                    <option value="only_child">Ïô∏ÎèôÎî∏</option>
                                    <option value="older_sister">Ïñ∏ÎãàÍ∞Ä ÏûàÎäî ÎßâÎÇ¥</option>
                                    <option value="younger_sibling">ÎèôÏÉùÏù¥ ÏûàÎäî Ï≤´Ïß∏</option>
                                    <option value="middle_child">Ï§ëÍ∞Ñ ÏûêÎÖÄ</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Ï∂úÏã† ÏßÄÏó≠</label>
                                <select id="charHometown">
                                    <option value="seoul">ÏÑúÏö∏ Ï∂úÏã†</option>
                                    <option value="busan">Î∂ÄÏÇ∞ Ï∂úÏã†</option>
                                    <option value="gyeonggi">Í≤ΩÍ∏∞ÎèÑ Ï∂úÏã†</option>
                                    <option value="countryside">ÏßÄÎ∞© Ï∂úÏã†</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Í¥ÄÍ≥Ñ ÏÑ§Ï†ï -->
                    <div class="char-category">
                        <h3>üíù Í¥ÄÍ≥Ñ ÏÑ§Ï†ï</h3>
                        <div class="relationship-options">
                            <button type="button" class="relationship-btn" data-rel="secret_crush">üíï Î™∞Îûò Ï¢ãÏïÑÌïòÎäî ÌõÑÎ∞∞</button>
                            <button type="button" class="relationship-btn" data-rel="childhood_friend">üé™ Ïñ¥Î¶¥ ÎïåÎ∂ÄÌÑ∞ ÏπúÌïú ÏπúÍµ¨</button>
                            <button type="button" class="relationship-btn" data-rel="senior_friend">üíñ Îã§Ï†ïÌïú ÏÑ†Î∞∞</button>
                            <button type="button" class="relationship-btn" data-rel="classmate">üë´ Í∞ôÏùÄ Í≥º ÎèôÍ∏∞</button>
                            <button type="button" class="relationship-btn" data-rel="club_mate">üéØ ÎèôÏïÑÎ¶¨ ÏÑ†ÌõÑÎ∞∞</button>
                            <button type="button" class="relationship-btn" data-rel="neighbor">üè† ÏòÜÏßë Ïù¥ÏõÉ</button>
                        </div>
                        <input type="hidden" id="charRelationship" />
                    </div>

                    <!-- Ïô∏Î™® ÏÑ§Ï†ï -->
                    <div class="char-category">
                        <h3>‚ú® Ïô∏Î™® ÏÑ§Ï†ï</h3>
                        <div class="appearance-grid">
                            <div class="form-group">
                                <label>Ìó§Ïñ¥ Ïä§ÌÉÄÏùº</label>
                                <select id="charHair">
                                    <option value="long_straight">üå∏ Í∏¥ ÏÉùÎ®∏Î¶¨</option>
                                    <option value="shoulder_wave">üåä Ïñ¥Íπ®Í∏∏Ïù¥ Ïõ®Ïù¥Î∏å</option>
                                    <option value="short_bob">üíá‚Äç‚ôÄÔ∏è Îã®Î∞ú Î≥¥Î∏åÏª∑</option>
                                    <option value="ponytail">üéÄ Ìè¨ÎãàÌÖåÏùº</option>
                                    <option value="twin_tail">üé™ Ìä∏ÏúàÌÖåÏùº</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Îàà Î™®Ïñë</label>
                                <select id="charEyes">
                                    <option value="round_cute">üòä ÎèôÍ∑∏ÎûóÍ≥† Í∑ÄÏó¨Ïö¥</option>
                                    <option value="almond_elegant">üòå ÏïÑÎ™¨ÎìúÌòï Ïö∞ÏïÑÌïú</option>
                                    <option value="cat_like">üò∏ Í≥†ÏñëÏù¥ Í∞ôÏùÄ</option>
                                    <option value="double_eyelid">üëÅÔ∏è ÎòêÎ†∑Ìïú ÏåçÍ∫ºÌíÄ</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>ÌÇ§/Ï≤¥Ìòï</label>
                                <select id="charBody">
                                    <option value="petite">üå∏ ÏûëÍ≥† Í∑ÄÏó¨Ïö¥ (155-160cm)</option>
                                    <option value="average">üíï ÌèâÍ∑†Ï†ÅÏù∏ (160-165cm)</option>
                                    <option value="tall">‚ú® ÌÇ§ ÌÅ∞ (165-170cm)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Ìå®ÏÖò Ïä§ÌÉÄÏùº</label>
                                <select id="charStyle">
                                    <option value="cute_casual">üå∏ ÌÅêÌä∏ Ï∫êÏ£ºÏñº</option>
                                    <option value="feminine_lovely">üíñ ÌéòÎØ∏Îãå Îü¨Î∏îÎ¶¨</option>
                                    <option value="natural_simple">üçÉ ÎÇ¥Ï∂îÎü¥ Ïã¨Ìîå</option>
                                    <option value="elegant_chic">‚ú® ÏóòÎ†àÍ∞ÑÌä∏ ÏãúÌÅ¨</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- ÎÇ¥Î©¥/ÏäµÍ¥Ä -->
                    <div class="char-category">
                        <h3>üí´ ÎÇ¥Î©¥ & Ï∑®ÎØ∏</h3>
                        <div class="hobby-interests">
                            <div class="form-group">
                                <label>Ï∑®ÎØ∏ ÌôúÎèô (ÏµúÎåÄ 3Í∞ú ÏÑ†ÌÉù)</label>
                                <div class="hobby-options">
                                    <button type="button" class="hobby-btn" data-hobby="reading">üìö ÎèÖÏÑú</button>
                                    <button type="button" class="hobby-btn" data-hobby="drawing">üé® Í∑∏Î¶º Í∑∏Î¶¨Í∏∞</button>
                                    <button type="button" class="hobby-btn" data-hobby="music">üéµ ÏùåÏïÖ Í∞êÏÉÅ</button>
                                    <button type="button" class="hobby-btn" data-hobby="photography">üì∑ ÏÇ¨ÏßÑ Ï¥¨ÏòÅ</button>
                                    <button type="button" class="hobby-btn" data-hobby="cooking">üç≥ ÏöîÎ¶¨</button>
                                    <button type="button" class="hobby-btn" data-hobby="exercise">üèÉ‚Äç‚ôÄÔ∏è Ïö¥Îèô</button>
                                    <button type="button" class="hobby-btn" data-hobby="travel">‚úàÔ∏è Ïó¨Ìñâ</button>
                                    <button type="button" class="hobby-btn" data-hobby="movies">üé¨ ÏòÅÌôî Í∞êÏÉÅ</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Í∞ÄÏπòÍ¥Ä</label>
                                <select id="charValues">
                                    <option value="love_family">Í∞ÄÏ°±Í≥º ÏÇ¨ÎûëÏùÑ Ï§ëÏãú</option>
                                    <option value="personal_growth">Í∞úÏù∏Ï†Å ÏÑ±Ïû•ÏùÑ Ï∂îÍµ¨</option>
                                    <option value="helping_others">ÌÉÄÏù∏ÏùÑ ÎèïÎäî Í≤ÉÏùÑ Ï¢ãÏïÑÌï®</option>
                                    <option value="creative_expression">Ï∞ΩÏùòÏ†Å ÌëúÌòÑÏùÑ Ï§ëÏãú</option>
                                    <option value="stability_security">ÏïàÏ†ïÍ≥º Î≥¥ÏïàÏùÑ Ï§ëÏãú</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- ÎßêÌà¨/ÎåÄÌôî Ïä§ÌÉÄÏùº -->
                    <div class="char-category">
                        <h3>üí¨ ÎßêÌà¨ & ÎåÄÌôî Ïä§ÌÉÄÏùº</h3>
                        <div class="speech-style-grid">
                            <div class="speech-options">
                                <button type="button" class="speech-btn" data-speech="soft_warm">üå∏ Î∂ÄÎìúÎüΩÍ≥† Îî∞ÎúªÌïú</button>
                                <button type="button" class="speech-btn" data-speech="bright_cheerful">‚ú® Î∞ùÍ≥† Í≤ΩÏæåÌïú</button>
                                <button type="button" class="speech-btn" data-speech="gentle_caring">üíï Îã§Ï†ïÌïòÍ≥† Î∞∞Î†§ÍπäÏùÄ</button>
                                <button type="button" class="speech-btn" data-speech="shy_cute">üòä ÏàòÏ§çÍ≥† Í∑ÄÏó¨Ïö¥</button>
                                <button type="button" class="speech-btn" data-speech="mature_elegant">üëë ÏÑ±ÏàôÌïòÍ≥† Ïö∞ÏïÑÌïú</button>
                                <button type="button" class="speech-btn" data-speech="playful_fun">üé™ Ïû•ÎÇúÏä§ÎüΩÍ≥† Ïû¨ÎØ∏ÏûàÎäî</button>
                            </div>
                            <div class="form-group">
                                <label>ÌäπÎ≥ÑÌïú ÎßêÎ≤ÑÎ¶á/ÏäµÍ¥Ä</label>
                                <input type="text" id="charSpeechHabit" placeholder="Ïòà: Ïù¥Î™®Ìã∞ÏΩò ÏûêÏ£º ÏÇ¨Ïö©, ~Ìï¥Ïöî ÎßêÌà¨, ÏõÉÏùÑ Îïå ÏÜêÏúºÎ°ú ÏûÖ Í∞ÄÎ¶¨Í∏∞" />
                            </div>
                            <input type="hidden" id="charSpeechStyle" />
                        </div>
                    </div>

                    <!-- Ïû•Î•¥/ÏãúÎÇòÎ¶¨Ïò§ ÏÑ§Ï†ï -->
                    <div class="char-category">
                        <h3>üìñ Ïû•Î•¥ & ÏãúÎÇòÎ¶¨Ïò§ ÌÉÄÏûÖ</h3>
                        <div class="genre-grid">
                            <div class="form-group">
                                <label>Î°úÎß®Ïä§ Ïû•Î•¥</label>
                                <select id="charGenre">
                                    <option value="school_romance">üè´ ÌïôÏõê Î°úÎß®Ïä§</option>
                                    <option value="daily_romance">‚òÄÔ∏è ÏùºÏÉÅ Î°úÎß®Ïä§</option>
                                    <option value="sweet_romance">üçØ Îã¨ÏΩ§Ìïú Î°úÎß®Ïä§</option>
                                    <option value="emotional_romance">üíî Í∞êÏÑ± Î°úÎß®Ïä§</option>
                                    <option value="healing_romance">üåø ÌûêÎßÅ Î°úÎß®Ïä§</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Ï£ºÏöî ÏãúÎÇòÎ¶¨Ïò§ ÏÉÅÌô©</label>
                                <select id="charMainSituation">
                                    <option value="confession_aftermath">Í≥†Î∞± ÌõÑ Ïñ¥ÏÉâÌïú ÏÉÅÌô©</option>
                                    <option value="study_together">Ìï®Íªò Í≥µÎ∂ÄÌïòÎäî ÏÉÅÌô©</option>
                                    <option value="festival_date">Ï∂ïÏ†ú Îç∞Ïù¥Ìä∏ ÏÉÅÌô©</option>
                                    <option value="rainy_day">ÎπÑ Ïò§Îäî ÎÇ† ÏÉÅÌô©</option>
                                    <option value="cafe_meeting">Ïπ¥ÌéòÏóêÏÑú ÎßåÎÇòÎäî ÏÉÅÌô©</option>
                                    <option value="library_encounter">ÎèÑÏÑúÍ¥ÄÏóêÏÑú Ïö∞Ïó∞Ìïú ÎßåÎÇ®</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- AI ÏÉùÏÑ± ÏòÅÏó≠ -->
                    <div class="char-category ai-generation">
                        <h3>ü§ñ AI ÏûêÎèô ÏÉùÏÑ± ÏòÅÏó≠</h3>
                        <div class="ai-controls">
                            <button type="button" class="btn btn-ai" onclick="generateAICharacter()">
                                ‚ú® AIÎ°ú Ï∫êÎ¶≠ÌÑ∞ ÏôÑÏÑ±ÌïòÍ∏∞
                            </button>
                            <div id="aiGenerationStatus" class="generation-status"></div>
                        </div>
                        <div class="generated-preview" id="characterPreview" style="display: none;">
                            <!-- AI ÏÉùÏÑ± Í≤∞Í≥º ÎØ∏Î¶¨Î≥¥Í∏∞ -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('characterModal')">Ï∑®ÏÜå</button>
                <button type="button" class="btn btn-primary" onclick="saveCharacter()">üíñ Ï∫êÎ¶≠ÌÑ∞ Ï†ÄÏû•</button>
            </div>
        </div>
    </div>

    <script>
        // Ï†ÑÏó≠ Î≥ÄÏàò
        let scenarios = {};
        let episodes = {};
        let characters = {};
        let currentScenarioId = null;
        let currentDifficultyFilter = 'all';
        let currentMode = 'create';
        let selectedCharacters = new Set();
        let generatedDialogue = null;

        // ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ ÌÜµÌï© Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî');
            loadAllData();
            initializeEventListeners();
        });

        // Î™®Îì† Îç∞Ïù¥ÌÑ∞ Î°úÎìú (LocalStorage Ïö∞ÏÑ†)
        async function loadAllData() {
            console.log('üìä ÌÜµÌï© Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏãúÏûë...');
            
            try {
                // 1Îã®Í≥Ñ: LocalStorageÏóêÏÑú Î°úÎìú ÏãúÎèÑ
                console.log('üîÑ 1Îã®Í≥Ñ: LocalStorageÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏãúÎèÑ...');
                const localChars = localStorage.getItem('characters');
                const localScenarios = localStorage.getItem('scenarios');
                
                if (localChars) {
                    const parsedChars = JSON.parse(localChars);
                    if (Object.keys(parsedChars).length > 0) {
                        console.log('‚úÖ LocalStorageÏóêÏÑú Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú ÏÑ±Í≥µ:', Object.keys(parsedChars).length, 'Í∞ú');
                        // Ï†ÑÏó≠ Î≥ÄÏàòÏôÄ window ÏÜçÏÑ± Î™®ÎëêÏóê ÏÑ§Ï†ï
                        characters = parsedChars;
                        window.characters = parsedChars;
                        
                        const parsedScenarios = localScenarios ? JSON.parse(localScenarios) : {};
                        scenarios = parsedScenarios;
                        window.scenarios = parsedScenarios;
                        
                        displayCharacters();
                        displayScenarios();
                        updateAllStats();
                        return true;
                    }
                }
                
                // 2Îã®Í≥Ñ: Í∏∞Ï°¥ APIÏóêÏÑú Î°úÎìú ÏãúÎèÑ  
                console.log('üîÑ 2Îã®Í≥Ñ: Í∏∞Ï°¥ APIÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏãúÎèÑ...');
                await loadScenarios();
                await loadCharacters();
                updateAllStats();
                
                if (window.characters && Object.keys(window.characters).length > 0) {
                    console.log('‚úÖ Í∏∞Ï°¥ APIÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏÑ±Í≥µ');
                    return true;
                }
                
                // Î™®Îì† Î∞©Î≤ï Ïã§Ìå®
                console.log('‚ö†Ô∏è Î™®Îì† Îç∞Ïù¥ÌÑ∞ ÏÜåÏä§ÏóêÏÑú Î°úÎìú Ïã§Ìå® - Îπà ÏÉÅÌÉúÎ°ú ÏãúÏûë');
                window.characters = {};
                window.scenarios = {};
                updateAllStats();
                return false;
                
            } catch (error) {
                console.error('‚ùå Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ï§ë Ïò§Î•ò:', error);
                // Í∏∞Î≥∏Í∞íÏúºÎ°ú ÏÑ§Ï†ï
                window.characters = window.characters || {};
                window.scenarios = window.scenarios || {};
                updateAllStats();
                return false;
            }
        }

        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï¥àÍ∏∞Ìôî
        function initializeEventListeners() {
            // Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉùÍ∏∞Îäî ÎèôÏ†Å Î°úÎî©ÏúºÎ°ú Ï¥àÍ∏∞ÌôîÎê®
            loadCharacterSelector();

            // ÏÉàÎ°úÏö¥ AI Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ± ÏãúÏä§ÌÖú Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑàÎì§
            initializeCharacterGeneratorEvents();

            // ESC ÌÇ§Î°ú Î™®Îã¨ Îã´Í∏∞
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                }
            });

            // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ÏúºÎ°ú Îã´Í∏∞
            window.onclick = function(event) {
                if (event.target.className === 'modal') {
                    event.target.style.display = 'none';
                }
            }
        }
        
        // Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉùÍ∏∞ ÎèôÏ†Å Î°úÎî©
        async function loadCharacterSelector() {
            console.log('üîÑ Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉùÍ∏∞ Î°úÎî© ÏãúÏûë...');
            
            try {
                const charactersData = window.characters || {};
                const characterKeys = Object.keys(charactersData);
                
                console.log('üìä Î°úÎìúÎêú Ï∫êÎ¶≠ÌÑ∞:', characterKeys.length, 'Í∞ú');
                
                const selector = document.getElementById('characterSelector');
                const loadingMsg = document.getElementById('characterLoadingMsg');
                
                if (characterKeys.length === 0) {
                    loadingMsg.innerHTML = '‚ùå ÏÉùÏÑ±Îêú Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.<br><small>Î®ºÏ†Ä Ï∫êÎ¶≠ÌÑ∞ ÌÉ≠ÏóêÏÑú Ï∫êÎ¶≠ÌÑ∞Î•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.</small>';
                    selector.style.display = 'none';
                    return;
                }
                
                // Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉù ÏòµÏÖò ÏÉùÏÑ±
                let html = '';
                characterKeys.forEach(charId => {
                    const char = charactersData[charId];
                    html += `
                        <div class="character-option" data-id="${charId}">
                            ${char.name} (${char.mbti})<br>
                            <small>${char.personality_traits?.primary?.slice(0, 2).join(', ') || 'ÏÉùÏÑ±Îêú Ï∫êÎ¶≠ÌÑ∞'}</small>
                        </div>
                    `;
                });
                
                selector.innerHTML = html;
                selector.style.display = 'grid';
                loadingMsg.style.display = 'none';
                
                // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
                selector.querySelectorAll('.character-option').forEach(option => {
                    option.addEventListener('click', function() {
                        const characterId = this.dataset.id;
                        if (selectedCharacters.has(characterId)) {
                            selectedCharacters.delete(characterId);
                            this.classList.remove('selected');
                        } else {
                            selectedCharacters.add(characterId);
                            this.classList.add('selected');
                        }
                        console.log('‚úÖ ÏÑ†ÌÉùÎêú Ï∫êÎ¶≠ÌÑ∞Îì§:', Array.from(selectedCharacters));
                    });
                });
                
                console.log('‚úÖ Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉùÍ∏∞ Î°úÎî© ÏôÑÎ£å');
                
            } catch (error) {
                console.error('‚ùå Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉùÍ∏∞ Î°úÎî© Ïã§Ìå®:', error);
                document.getElementById('characterLoadingMsg').innerHTML = 
                    '‚ùå Ï∫êÎ¶≠ÌÑ∞ Î°úÎî© Ïã§Ìå®<br><small>ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®ÌïòÍ±∞ÎÇò Ï∫êÎ¶≠ÌÑ∞Î•º Îã§Ïãú ÏÉùÏÑ±Ìï¥Î≥¥ÏÑ∏Ïöî.</small>';
            }
        }
        
        // ÏóêÌîºÏÜåÎìú ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉùÍ∏∞ Î°úÎî©
        async function loadEpisodeScenarioSelector() {
            console.log('üîÑ ÏóêÌîºÏÜåÎìú ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉùÍ∏∞ Î°úÎî© ÏãúÏûë...');
            
            try {
                // Î™®Îì† ÏÜåÏä§ÏóêÏÑú ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ ÌÜµÌï© Î°úÎî©
                let scenariosData = {};
                
                // 1. Ï†ÑÏó≠ Î≥ÄÏàò scenarios ÌôïÏù∏
                if (window.scenarios && Object.keys(window.scenarios).length > 0) {
                    scenariosData = { ...window.scenarios };
                    console.log('‚úÖ window.scenariosÏóêÏÑú Î°úÎî©:', Object.keys(scenariosData).length, 'Í∞ú');
                }
                
                // 2. Ï†ÑÏó≠ scenarios Î≥ÄÏàò ÌôïÏù∏
                if (typeof scenarios !== 'undefined' && Object.keys(scenarios).length > 0) {
                    scenariosData = { ...scenariosData, ...scenarios };
                    console.log('‚úÖ Ï†ÑÏó≠ scenariosÏóêÏÑú Ï∂îÍ∞Ä Î°úÎî©:', Object.keys(scenariosData).length, 'Í∞ú');
                }
                
                // 3. LocalStorageÏóêÏÑú Î°úÎî©
                const localScenarios = localStorage.getItem('scenarios');
                if (localScenarios) {
                    const parsedLocal = JSON.parse(localScenarios);
                    scenariosData = { ...scenariosData, ...parsedLocal };
                    console.log('‚úÖ LocalStorageÏóêÏÑú Ï∂îÍ∞Ä Î°úÎî©:', Object.keys(scenariosData).length, 'Í∞ú');
                }
                
                // Î™®Îì† Î≥ÄÏàò ÎèôÍ∏∞Ìôî
                scenarios = scenariosData;
                window.scenarios = scenariosData;
                
                const scenarioKeys = Object.keys(scenariosData);
                console.log('üìä ÏµúÏ¢Ö Î°úÎìúÎêú ÏãúÎÇòÎ¶¨Ïò§:', scenarioKeys.length, 'Í∞ú');
                console.log('üìã ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù:', scenarioKeys.map(id => `${id}: ${scenariosData[id]?.title || 'Ï†úÎ™©ÏóÜÏùå'}`));
                
                const selector = document.getElementById('episodeScenarioSelect');
                if (!selector) {
                    console.error('‚ùå episodeScenarioSelect ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§');
                    return;
                }
                
                // Í∏∞Î≥∏ ÏòµÏÖò Ïú†ÏßÄ
                let html = '<option value="">ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>';
                
                if (scenarioKeys.length === 0) {
                    html += '<option value="" disabled>ÏÉùÏÑ±Îêú ÏãúÎÇòÎ¶¨Ïò§Í∞Ä ÏóÜÏäµÎãàÎã§</option>';
                } else {
                    scenarioKeys.forEach(scenarioId => {
                        const scenario = scenariosData[scenarioId];
                        if (scenario && scenario.title) {
                            html += `<option value="${scenarioId}">${scenario.title}</option>`;
                        } else {
                            console.warn('‚ö†Ô∏è ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ Î∂àÏôÑÏ†Ñ:', scenarioId, scenario);
                            html += `<option value="${scenarioId}">ÏãúÎÇòÎ¶¨Ïò§ ${scenarioId}</option>`;
                        }
                    });
                }
                
                selector.innerHTML = html;
                console.log('‚úÖ ÏóêÌîºÏÜåÎìú ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉùÍ∏∞ Î°úÎî© ÏôÑÎ£å');
                console.log('üîç ÏÉùÏÑ±Îêú HTML:', html);
                
            } catch (error) {
                console.error('‚ùå ÏóêÌîºÏÜåÎìú ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉùÍ∏∞ Î°úÎî© Ïã§Ìå®:', error);
                // ÏóêÎü¨ Î∞úÏÉù ÏãúÏóêÎèÑ Í∏∞Î≥∏ ÏÑ†ÌÉùÏßÄÎäî Ï†úÍ≥µ
                const selector = document.getElementById('episodeScenarioSelect');
                if (selector) {
                    selector.innerHTML = '<option value="">ÏãúÎÇòÎ¶¨Ïò§ Î°úÎî© Ïò§Î•ò</option>';
                }
            }
        }
        
        // ÏãúÎÇòÎ¶¨Ïò§ Î≥ÄÍ≤Ω Ïãú Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
        function onScenarioChange() {
            const scenarioId = document.getElementById('episodeScenarioSelect').value;
            console.log('üîÑ ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§:', scenarioId);
            
            const characterSelect = document.getElementById('characterSelect');
            
            if (!scenarioId) {
                characterSelect.innerHTML = '<option value="">Î®ºÏ†Ä ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>';
                return;
            }
            
            try {
                const scenariosData = window.scenarios || {};
                const scenario = scenariosData[scenarioId];
                
                if (!scenario) {
                    characterSelect.innerHTML = '<option value="">ÏãúÎÇòÎ¶¨Ïò§Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§</option>';
                    return;
                }
                
                console.log('üìä ÏãúÎÇòÎ¶¨Ïò§ ÏÇ¨Ïö©Í∞ÄÎä• Ï∫êÎ¶≠ÌÑ∞:', scenario.available_characters);
                
                let html = '<option value="">Ï∫êÎ¶≠ÌÑ∞Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>';
                
                if (scenario.available_characters && scenario.available_characters.length > 0) {
                    const charactersData = window.characters || {};
                    
                    scenario.available_characters.forEach(charId => {
                        const character = charactersData[charId];
                        if (character) {
                            html += `<option value="${charId}">${character.name} (${character.mbti})</option>`;
                        } else {
                            // Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥Í∞Ä ÏóÜÎäî Í≤ΩÏö∞ IDÎßå ÌëúÏãú
                            html += `<option value="${charId}">${charId}</option>`;
                        }
                    });
                } else {
                    html += '<option value="" disabled>Ïù¥ ÏãúÎÇòÎ¶¨Ïò§Ïóê ÏÇ¨Ïö©Í∞ÄÎä•Ìïú Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</option>';
                }
                
                characterSelect.innerHTML = html;
                
                // Ïà®Í≤®ÏßÑ ÌïÑÎìúÏóêÎèÑ ÏãúÎÇòÎ¶¨Ïò§ ID ÏÑ§Ï†ï
                document.getElementById('episodeScenarioId').value = scenarioId;
                
                console.log('‚úÖ Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
                
            } catch (error) {
                console.error('‚ùå Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®:', error);
                characterSelect.innerHTML = '<option value="">Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§</option>';
            }
        }
        
        // ÏóêÌîºÏÜåÎìú ÏÑπÏÖòÏùò ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
        function refreshEpisodeScenarioList() {
            console.log('üîÑ ÏóêÌîºÏÜåÎìú ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®...');
            
            // Îëê Í≥≥ Î™®Îëê ÏóÖÎç∞Ïù¥Ìä∏
            loadEpisodeScenarioSelector(); // Î™®Îã¨Ïö©
            displayAvailableScenarios(); // ÏóêÌîºÏÜåÎìú ÏÑπÏÖòÏö©
            
            // ÏóêÌîºÏÜåÎìú ÏÑπÏÖòÏùò ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉù ÎìúÎ°≠Îã§Ïö¥ÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
            const episodeSelect = document.getElementById('episodeScenarioSelect');
            if (episodeSelect) {
                loadEpisodeScenarioSelector().then(() => {
                    // Î™®Îã¨Ïö© ÏÑ†ÌÉùÍ∏∞Ïùò ÎÇ¥Ïö©ÏùÑ ÏóêÌîºÏÜåÎìú ÏÑπÏÖòÏúºÎ°ú Î≥µÏÇ¨
                    const modalSelect = document.getElementById('episodeScenarioSelect');
                    if (modalSelect) {
                        episodeSelect.innerHTML = modalSelect.innerHTML;
                    }
                });
            }
        }
        
        // ÏóêÌîºÏÜåÎìú ÏÑπÏÖòÏóê ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÌëúÏãú
        function displayAvailableScenarios() {
            console.log('üìã ÏóêÌîºÏÜåÎìú ÏÑπÏÖòÏóê ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÌëúÏãú...');
            
            try {
                // ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ Î°úÎî©
                let scenariosData = window.scenarios || {};
                
                // LocalStorageÏóêÏÑúÎèÑ ÌôïÏù∏
                if (Object.keys(scenariosData).length === 0) {
                    const localScenarios = localStorage.getItem('scenarios');
                    if (localScenarios) {
                        scenariosData = JSON.parse(localScenarios);
                        window.scenarios = scenariosData;
                    }
                }
                
                const scenarioKeys = Object.keys(scenariosData);
                const scenariosListDiv = document.getElementById('scenariosList');
                
                if (scenarioKeys.length === 0) {
                    scenariosListDiv.innerHTML = `
                        <div class="empty-state">
                            <p>‚ùå ÏÉùÏÑ±Îêú ÏãúÎÇòÎ¶¨Ïò§Í∞Ä ÏóÜÏäµÎãàÎã§.</p>
                            <p><small>Î®ºÏ†Ä ÏãúÎÇòÎ¶¨Ïò§ ÌÉ≠ÏóêÏÑú ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.</small></p>
                        </div>
                    `;
                    return;
                }
                
                let html = `<div class="scenarios-grid">`;
                scenarioKeys.forEach(scenarioId => {
                    const scenario = scenariosData[scenarioId];
                    if (scenario) {
                        html += `
                            <div class="scenario-item" onclick="selectScenarioForEpisode('${scenarioId}')">
                                <h5>${scenario.title || 'Ï†úÎ™© ÏóÜÏùå'}</h5>
                                <p>${(scenario.description || '').substring(0, 100)}${scenario.description && scenario.description.length > 100 ? '...' : ''}</p>
                                <div class="scenario-meta">
                                    <span class="episode-count">${scenario.episode_count || 0}/36 ÏóêÌîºÏÜåÎìú</span>
                                    <span class="character-count">${scenario.available_characters ? scenario.available_characters.length : 0} Ï∫êÎ¶≠ÌÑ∞</span>
                                </div>
                            </div>
                        `;
                    }
                });
                html += `</div>`;
                
                scenariosListDiv.innerHTML = html;
                console.log('‚úÖ ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÌëúÏãú ÏôÑÎ£å:', scenarioKeys.length, 'Í∞ú');
                
            } catch (error) {
                console.error('‚ùå ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÌëúÏãú Ïã§Ìå®:', error);
                document.getElementById('scenariosList').innerHTML = `
                    <div class="error-state">
                        <p>‚ùå ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù Î°úÎî© Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.</p>
                        <p><small>ÏΩòÏÜîÏùÑ ÌôïÏù∏ÌïòÍ±∞ÎÇò ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Î≥¥ÏÑ∏Ïöî.</small></p>
                    </div>
                `;
            }
        }
        
        // ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉù (ÏóêÌîºÏÜåÎìú ÏÑπÏÖòÏóêÏÑú)
        function selectScenarioForEpisode(scenarioId) {
            console.log('üéØ ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉùÎê®:', scenarioId);
            
            const episodeSelect = document.getElementById('episodeScenarioSelect');
            if (episodeSelect) {
                episodeSelect.value = scenarioId;
                loadEpisodes(); // ÏóêÌîºÏÜåÎìú Î°úÎî©
            }
            
            // ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§ ÌïòÏù¥ÎùºÏù¥Ìä∏
            document.querySelectorAll('.scenario-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.closest('.scenario-item').classList.add('selected');
        }

        // ÌÉ≠ Ï†ÑÌôò (Ï†ÑÏó≠ Ìï®Ïàò)
        function switchTab(tabName) {
            // Î™®Îì† ÌÉ≠Í≥º ÏÑπÏÖò ÎπÑÌôúÏÑ±Ìôî
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));

            // ÏÑ†ÌÉùÎêú ÌÉ≠Í≥º ÏÑπÏÖò ÌôúÏÑ±Ìôî
            event.target.classList.add('active');
            document.getElementById(`${tabName}-section`).classList.add('active');

            // ÏóêÌîºÏÜåÎìú ÌÉ≠ ÏÑ†ÌÉù Ïãú ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
            if (tabName === 'episodes') {
                populateEpisodeScenarioSelect();
            }
        }

        // === ÏãúÎÇòÎ¶¨Ïò§ Í¥ÄÎ¶¨ Ìï®ÏàòÎì§ ===
        
        // üöÄ GitHub API ÏãúÎÇòÎ¶¨Ïò§ Ï†ÄÏû• Ìï®Ïàò (ÌòÅÏã†Ï†Å!)
        async function saveScenarioToGitHub(scenario) {
            try {
                console.log('üêô GitHub APIÎ°ú ÏãúÎÇòÎ¶¨Ïò§ Ï†ÄÏû• ÏãúÏûë:', scenario.title);
                
                // GitHub ÌÜ†ÌÅ∞ ÌôïÏù∏/Î°úÎìú
                if (!GITHUB_CONFIG.token) {
                    const tokenLoaded = await loadGitHubToken();
                    if (!tokenLoaded) {
                        throw new Error('GitHub token not available');
                    }
                }
                
                // ÏãúÎÇòÎ¶¨Ïò§ ID ÏÉùÏÑ± (ÏóÜÏúºÎ©¥)
                if (!scenario.id && !scenario.scenario_id) {
                    scenario.id = `scenario_${Date.now()}`;
                    scenario.scenario_id = scenario.id;
                    console.log('üîß ÏãúÎÇòÎ¶¨Ïò§ ID ÏÉùÏÑ±:', scenario.id);
                }
                
                // Í∏∞Ï°¥ ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù Î°úÎìú
                const existingScenarios = await loadScenariosFromGitHub();
                console.log('üìä Í∏∞Ï°¥ GitHub ÏãúÎÇòÎ¶¨Ïò§ Ïàò:', Object.keys(existingScenarios).length);
                
                // ÏÉà ÏãúÎÇòÎ¶¨Ïò§ Ï∂îÍ∞Ä
                const scenarioId = scenario.id || scenario.scenario_id;
                existingScenarios[scenarioId] = {
                    ...scenario,
                    last_modified: new Date().toISOString(),
                    source: 'github_api',
                    commit_hash: 'pending'
                };
                
                // GitHubÏóê Ïª§Î∞ãÌï† Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞ ÏÉùÏÑ±
                const scenarioData = {
                    metadata: {
                        version: "1.0.0",
                        created_date: new Date().toISOString().split('T')[0],
                        total_scenarios: Object.keys(existingScenarios).length,
                        ai_context_engine: "claude-3.5-sonnet",
                        source: "github_api"
                    },
                    scenarios: existingScenarios,
                    scenario_templates: {
                        romance_template: {
                            mood_options: ["ÏÑ§Î†ò", "Î∂ÄÎÅÑÎü¨ÏõÄ", "Í∏¥Ïû•Í∞ê", "Îã¨ÏΩ§Ìï®", "Ïï†Ï†àÌï®"],
                            setting_options: ["Ïπ¥Ìéò", "ÌïôÍµê", "Ïßë", "Í≥µÏõê", "ÎèÑÏÑúÍ¥Ä", "Í±∞Î¶¨"],
                            time_options: ["ÏïÑÏπ®", "Ï†êÏã¨", "Ï†ÄÎÖÅ", "Î∞§", "ÏÉàÎ≤Ω"]
                        }
                    }
                };
                
                // GitHub RepositoryÏóê ÏßÅÏ†ë Ïª§Î∞ã
                const commitMessage = `Add scenario: ${scenario.title}`;
                const commitResult = await commitToGitHub('data/scenarios/scenario-database.json', scenarioData, commitMessage);
                
                if (commitResult.success) {
                    // Ïª§Î∞ã Ìï¥Ïãú ÏóÖÎç∞Ïù¥Ìä∏
                    existingScenarios[scenarioId].commit_hash = commitResult.sha;
                    
                    // Î°úÏª¨ Î∞±ÏóÖÎèÑ Ï†ÄÏû•
                    localStorage.setItem('chatgame_scenarios', JSON.stringify(existingScenarios));
                    
                    console.log('‚úÖ GitHub API ÏãúÎÇòÎ¶¨Ïò§ Ï†ÄÏû• ÏôÑÎ£å! Ïª§Î∞ã SHA:', commitResult.sha);
                    console.log('üìù GitHubÏóê Ï†ÄÏû•Îêú ÏãúÎÇòÎ¶¨Ïò§ IDÎì§:', Object.keys(existingScenarios));
                    
                    return { success: true, commit_hash: commitResult.sha, url: commitResult.html_url };
                } else {
                    throw new Error('GitHub commit failed: ' + commitResult.error);
                }
                
            } catch (error) {
                console.error('‚ùå GitHub API ÏãúÎÇòÎ¶¨Ïò§ Ï†ÄÏû• Ïò§Î•ò:', error);
                
                // Ïã§Ìå® Ïãú Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÎ°ú Ìè¥Î∞±
                console.log('üíæ ÏãúÎÇòÎ¶¨Ïò§ Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÎ°ú Ìè¥Î∞±...');
                return saveScenarioToLocalStorage(scenario);
            }
        }
        
        // GitHubÏóêÏÑú ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        async function loadScenariosFromGitHub() {
            try {
                console.log('üì• GitHubÏóêÏÑú ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ Î°úÎìú...');
                const result = await getFileFromGitHub('data/scenarios/scenario-database.json');
                
                if (result.success) {
                    const scenarioData = result.content;
                    if (scenarioData.scenarios) {
                        return scenarioData.scenarios;
                    }
                    return {};
                } else {
                    console.warn('‚ö†Ô∏è GitHub ÏãúÎÇòÎ¶¨Ïò§ Î°úÎìú Ïã§Ìå®:', result.error);
                    return {};
                }
            } catch (error) {
                console.error('‚ùå GitHub ÏãúÎÇòÎ¶¨Ïò§ Î°úÎìú ÏòàÏô∏:', error);
                return {};
            }
        }
        
        // ÏãúÎÇòÎ¶¨Ïò§ Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ Ìè¥Î∞± Ìï®Ïàò
        function saveScenarioToLocalStorage(scenario) {
            try {
                const scenarioId = scenario.id || scenario.scenario_id || `scenario_${Date.now()}`;
                const existingScenarios = JSON.parse(localStorage.getItem('chatgame_scenarios') || '{}');
                
                existingScenarios[scenarioId] = {
                    ...scenario,
                    id: scenarioId,
                    scenario_id: scenarioId,
                    last_modified: new Date().toISOString(),
                    source: 'local_storage'
                };
                
                localStorage.setItem('chatgame_scenarios', JSON.stringify(existingScenarios));
                console.log('‚úÖ ÏãúÎÇòÎ¶¨Ïò§ Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ Ï†ÄÏû• ÏôÑÎ£å:', scenarioId);
                
                return { success: true, source: 'localStorage' };
            } catch (error) {
                console.error('‚ùå ÏãúÎÇòÎ¶¨Ïò§ Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ Ï†ÄÏû• Ïò§Î•ò:', error);
                return { success: false, error: error.message };
            }
        }
        async function loadScenarios() {
            console.log('üìö === ÏãúÎÇòÎ¶¨Ïò§ Î°úÎìú ÏãúÏûë ===');
            console.log('üïí Î°úÎìú ÏãúÍ∞Ñ:', new Date().toISOString());
            
            try {
                console.log('üîÑ ÏãúÎÇòÎ¶¨Ïò§ API Ìò∏Ï∂ú...');
                const response = await fetch('/api/scenario-manager?action=list&_t=' + Date.now());
                console.log('üì∂ API ÏùëÎãµ ÏÉÅÌÉú:', response.status);
                
                const data = await response.json();
                console.log('üì¶ ÏõêÏãú ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞:', JSON.stringify(data, null, 2));

                if (data.success) {
                    scenarios = data.scenarios || {};
                    const scenarioCount = Object.keys(scenarios).length;
                    console.log('‚úÖ Î°úÎìúÎêú ÏãúÎÇòÎ¶¨Ïò§ Ïàò:', scenarioCount);
                    
                    if (scenarioCount > 0) {
                        console.log('‚úÖ ÏãúÎÇòÎ¶¨Ïò§ IDÎì§:', Object.keys(scenarios));
                    } else {
                        console.log('üòµ Îπà ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù');
                    }
                    
                    displayScenarios();
                    updateScenarioStats();
                    console.log('üéâ === ÏãúÎÇòÎ¶¨Ïò§ Î°úÎìú ÏôÑÎ£å ===');
                } else {
                    console.error('‚ùå ÏãúÎÇòÎ¶¨Ïò§ API Ïò§Î•ò:', data.message);
                    scenarios = {};
                    displayScenarios();
                    updateScenarioStats();
                }
            } catch (error) {
                console.error('‚ùå ÏãúÎÇòÎ¶¨Ïò§ Î°úÎìú ÏòàÏô∏:', error);
                // Ìè¥Î∞± Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©
                scenarios = {};
                displayScenarios();
                updateScenarioStats();
                console.log('üéâ === ÏãúÎÇòÎ¶¨Ïò§ Î°úÎìú ÏôÑÎ£å (Ìè¥Î∞±) ===');
            }
        }

        function displayScenarios() {
            console.log('üé® === ÏãúÎÇòÎ¶¨Ïò§ ÌëúÏãú Ìï®Ïàò ÏãúÏûë ===');
            const container = document.getElementById('scenariosContainer');
            
            // window.scenarios ÎòêÎäî Ï†ÑÏó≠ scenarios ÏÇ¨Ïö© (Ìò∏ÌôòÏÑ±)
            const scenariosData = window.scenarios || scenarios || {};
            const scenarioArray = Object.values(scenariosData);
            console.log('üìä ÌëúÏãúÌï† ÏãúÎÇòÎ¶¨Ïò§ Ïàò:', scenarioArray.length);
            console.log('üìä ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ ÏÜåÏä§:', window.scenarios ? 'window.scenarios' : 'scenarios');
            if (scenarioArray.length > 0) {
                console.log('üìã ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù:', scenarioArray.map(s => `${s.title} (${s.id || s.scenario_id})`));
            } else {
                console.log('üì≠ ÌëúÏãúÌï† ÏãúÎÇòÎ¶¨Ïò§ ÏóÜÏùå');
            }
            
            if (scenarioArray.length === 0) {
                console.log('üì≠ ÏãúÎÇòÎ¶¨Ïò§ ÏóÜÏùå - Îπà ÏÉÅÌÉú ÌëúÏãú');
                
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <h3>üì≠ ÏãúÎÇòÎ¶¨Ïò§Í∞Ä ÏóÜÏäµÎãàÎã§</h3>
                        <p>Ï≤´ Î≤àÏß∏ ÏãúÎÇòÎ¶¨Ïò§Î•º ÎßåÎì§Ïñ¥Î≥¥ÏÑ∏Ïöî!</p>
                        <button class="btn btn-primary" onclick="openScenarioModal('create')">
                            ‚ú® ÏÉà ÏãúÎÇòÎ¶¨Ïò§ ÎßåÎì§Í∏∞
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = scenarioArray.map(scenario => `
                <div class="scenario-card">
                    <h3>${scenario.title}</h3>
                    <p class="description">${scenario.description}</p>
                    <div class="metadata">
                        ${scenario.tags ? scenario.tags.map(tag => `<span class="tag">${tag}</span>`).join('') : ''}
                        <span class="tag">Ï∫êÎ¶≠ÌÑ∞: ${scenario.available_characters ? scenario.available_characters.length : 0}Î™Ö</span>
                        <span class="tag">ÏóêÌîºÏÜåÎìú: ${scenario.episode_count || 0}Í∞ú</span>
                    </div>
                    <div class="actions">
                        <button class="btn btn-success" onclick="editScenario('${scenario.id}')">ÏàòÏ†ï</button>
                        <button class="btn btn-primary" onclick="manageEpisodes('${scenario.id}')">ÏóêÌîºÏÜåÎìú</button>
                        <button class="btn btn-danger" onclick="deleteScenario('${scenario.id}')">ÏÇ≠Ï†ú</button>
                    </div>
                </div>
            `).join('');
        }

        function updateScenarioStats() {
            console.log('üìä ÏãúÎÇòÎ¶¨Ïò§ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÏûë...');
            
            // window.scenarios ÎòêÎäî Ï†ÑÏó≠ scenarios ÏÇ¨Ïö© (Ìò∏ÌôòÏÑ±)
            const scenariosData = window.scenarios || scenarios || {};
            const scenarioArray = Object.values(scenariosData);
            console.log('üìä ÏãúÎÇòÎ¶¨Ïò§ Î∞∞Ïó¥:', scenarioArray.length, 'Í∞ú');
            console.log('üìä ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ ÏÜåÏä§:', window.scenarios ? 'window.scenarios' : 'scenarios');
            
            // ÏïàÏ†ÑÌïú ÏöîÏÜå ÏóÖÎç∞Ïù¥Ìä∏ (ÏöîÏÜåÍ∞Ä ÏóÜÏúºÎ©¥ Î¨¥Ïãú)
            const safeUpdateElement = (id, value) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                    console.log(`‚úÖ ${id}: ${value}`);
                } else {
                    console.warn(`‚ö†Ô∏è ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå: ${id}`);
                }
            };
            
            // ÏãúÎÇòÎ¶¨Ïò§ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
            safeUpdateElement('totalScenarios', scenarioArray.length);
            safeUpdateElement('activeScenarios', scenarioArray.filter(s => s.active_status).length);
            safeUpdateElement('scenarioCount', scenarioArray.length);
            
            // AI ÏÉùÏÑ± ÏãúÎÇòÎ¶¨Ïò§ Í∞úÏàò
            const aiGeneratedCount = scenarioArray.filter(s => s.ai_generated_context && s.ai_generated_context.length > 0).length;
            safeUpdateElement('aiGeneratedScenarios', aiGeneratedCount);
            
            // ÎåÄÌôî/ÏóêÌîºÏÜåÎìú Ïàò (ÏãúÎÇòÎ¶¨Ïò§ ÏÑπÏÖòÏóêÎäî totalDialogues ÏÇ¨Ïö©)
            const totalEpisodes = scenarioArray.reduce((sum, s) => sum + (s.episode_count || 0), 0);
            safeUpdateElement('totalDialogues', totalEpisodes);
            
            console.log('‚úÖ ÏãúÎÇòÎ¶¨Ïò§ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
        }

        function openScenarioModal(mode, scenarioId = null) {
            currentMode = mode;
            const modal = document.getElementById('scenarioModal');
            
            if (mode === 'create') {
                document.getElementById('scenarioModalTitle').textContent = 'ÏÉà ÏãúÎÇòÎ¶¨Ïò§ ÎßåÎì§Í∏∞';
                document.getElementById('scenarioForm').reset();
                document.getElementById('aiContext').innerHTML = 'AIÍ∞Ä ÏÉùÏÑ±Ìïú ÏÜåÏÑ§Ìíç ÏãúÎÇòÎ¶¨Ïò§ Ïª®ÌÖçÏä§Ìä∏Í∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§';
                selectedCharacters.clear();
                // Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉùÍ∏∞Î•º Îã§Ïãú Î°úÎî©ÌïòÏó¨ ÏµúÏã† Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù ÌëúÏãú
                loadCharacterSelector();
            } else if (mode === 'edit' && scenarioId) {
                editScenario(scenarioId);
                return;
            }
            
            modal.style.display = 'block';
        }

        function editScenario(scenarioId) {
            const scenario = scenarios[scenarioId];
            if (!scenario) return;

            currentMode = 'edit';
            document.getElementById('scenarioModalTitle').textContent = 'ÏãúÎÇòÎ¶¨Ïò§ ÏàòÏ†ï';
            document.getElementById('scenarioId').value = scenarioId;
            document.getElementById('scenarioTitle').value = scenario.title;
            document.getElementById('scenarioDescription').value = scenario.description;
            document.getElementById('backgroundSetting').value = scenario.background_setting;
            document.getElementById('mood').value = scenario.mood;
            document.getElementById('aiContext').innerHTML = scenario.ai_generated_context || '';
            document.getElementById('customContext').value = scenario.custom_context || '';

            // Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉù ÏÉÅÌÉú Î≥µÏõê
            selectedCharacters.clear();
            document.querySelectorAll('.character-option').forEach(opt => opt.classList.remove('selected'));
            
            if (scenario.available_characters) {
                scenario.available_characters.forEach(charId => {
                    selectedCharacters.add(charId);
                    document.querySelector(`.character-option[data-id="${charId}"]`)?.classList.add('selected');
                });
            }

            document.getElementById('scenarioModal').style.display = 'block';
        }

        async function saveScenario() {
            const title = document.getElementById('scenarioTitle').value;
            const description = document.getElementById('scenarioDescription').value;
            const backgroundSetting = document.getElementById('backgroundSetting').value;
            const mood = document.getElementById('mood').value;

            if (!title || !description || !backgroundSetting || !mood) {
                alert('Î™®Îì† ÌïÑÏàò Ìï≠Î™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            const scenarioData = {
                title,
                description,
                background_setting: backgroundSetting,
                mood,
                available_characters: Array.from(selectedCharacters)
            };

            if (currentMode === 'create') {
                // Ï†úÎ™©ÏùÑ Í∏∞Î∞òÏúºÎ°ú Í≥†Ïú†Ìïú ID ÏÉùÏÑ±
                const titleKey = title.toLowerCase()
                    .replace(/[^a-zA-ZÍ∞Ä-Ìû£0-9]/g, '_') // ÌäπÏàòÎ¨∏ÏûêÎ•º _Î°ú Î≥ÄÍ≤Ω
                    .replace(/_+/g, '_') // Ïó∞ÏÜçÎêú _Î•º ÌïòÎÇòÎ°ú
                    .replace(/^_|_$/g, ''); // ÏïûÎí§ _Ï†úÍ±∞
                scenarioData.scenario_id = `scenario_${titleKey}_${Date.now()}`;
                scenarioData.action = 'create';
                
                console.log('üîß ÏãúÎÇòÎ¶¨Ïò§ ID ÏÉùÏÑ±:', scenarioData.scenario_id);
            } else {
                scenarioData.scenario_id = document.getElementById('scenarioId').value;
                scenarioData.action = 'update';
            }

            try {
                // üöÄ Ï¶âÏãú UI ÏóÖÎç∞Ïù¥Ìä∏ (ÏÇ¨Ïö©Ïûê Í≤ΩÌóò Í∞úÏÑ†)
                console.log('‚ö° Ï¶âÏãú Î°úÏª¨ ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏...');
                
                // ÏãúÎÇòÎ¶¨Ïò§ ID ÌôïÎ≥¥
                const scenarioId = scenarioData.scenario_id;
                
                // Î°úÏª¨ ÏãúÎÇòÎ¶¨Ïò§ Í∞ùÏ≤¥Ïóê Ï¶âÏãú Ï∂îÍ∞Ä (UI Î∞òÏùëÏÑ± Í∞úÏÑ†)
                const globalScenarios = window.scenarios || {};
                globalScenarios[scenarioId] = {
                    id: scenarioId,
                    ...scenarioData,
                    created_date: new Date().toISOString().split('T')[0],
                    episode_count: 0,
                    tags: [scenarioData.mood]
                };
                window.scenarios = globalScenarios;
                
                // Ï¶âÏãú ÌôîÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏
                displayScenarios();
                updateScenarioStats();
                console.log('‚úÖ Ï¶âÏãú UI ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');

                // üíæ LocalStorage ÏßÅÏ†ë Ï†ÄÏû• (ÌôïÏã§Ìïú Î∞©Î≤ï!)
                console.log('üíæ LocalStorageÏóê ÏßÅÏ†ë Ï†ÄÏû• ÏãúÎèÑ...');
                try {
                    // ÌòÑÏû¨ Ï†ÄÏû•Îêú ÏãúÎÇòÎ¶¨Ïò§Îì§ÏùÑ Í∞ÄÏ†∏Ïò¥
                    const existingScenarios = localStorage.getItem('scenarios');
                    const scenariosData = existingScenarios ? JSON.parse(existingScenarios) : {};
                    
                    // ÏÉà ÏãúÎÇòÎ¶¨Ïò§ Ï∂îÍ∞Ä/ÏàòÏ†ï
                    scenariosData[scenarioId] = globalScenarios[scenarioId];
                    
                    // LocalStorageÏóê Ï†ÄÏû•
                    localStorage.setItem('scenarios', JSON.stringify(scenariosData));
                    console.log('‚úÖ LocalStorage Ï†ÄÏû• ÏÑ±Í≥µ! Ï¥ù', Object.keys(scenariosData).length, 'Í∞ú ÏãúÎÇòÎ¶¨Ïò§');
                    
                    // Ï†ÄÏû• ÏÑ±Í≥µ Î©îÏãúÏßÄ
                    const successMessage = currentMode === 'create' ? 
                        `üíñ ÏÉàÎ°úÏö¥ ÏãúÎÇòÎ¶¨Ïò§ '${title}'Í∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!\n‚úÖ ÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ùÏóêÏÑú ÌôïÏù∏ÌïòÏÑ∏Ïöî!` :
                        `‚ú®ÏãúÎÇòÎ¶¨Ïò§ '${title}'Í∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§!`;
                    
                    alert(successMessage);
                    closeModal('scenarioModal');
                    
                    // UI ÏµúÏ¢Ö ÏóÖÎç∞Ïù¥Ìä∏
                    console.log('üîÑ Ï†ÄÏû• ÌõÑ ÏµúÏ¢Ö UI ÎèôÍ∏∞Ìôî...');
                    await loadAllData(); // ÏÉàÎ°úÏö¥ ÌÜµÌï© Î°úÎî© Ìï®Ïàò ÏÇ¨Ïö©
                    
                    // Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉùÍ∏∞ÎèÑ Í∞±Ïã† (ÏÉàÎ°ú ÏÉùÏÑ±Îêú Ï∫êÎ¶≠ÌÑ∞ Î∞òÏòÅ)
                    await loadCharacterSelector();
                    
                    console.log('‚úÖ ÏãúÎÇòÎ¶¨Ïò§ Ï†ÄÏû• ÌîÑÎ°úÏÑ∏Ïä§ ÏôÑÎ£å!');
                    
                } catch (storageError) {
                    console.error('‚ùå LocalStorage Ï†ÄÏû• Ïã§Ìå®:', storageError);
                    alert('Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + storageError.message);
                }
            } catch (error) {
                console.error('ÏãúÎÇòÎ¶¨Ïò§ Ï†ÄÏû• Ïò§Î•ò:', error);
                // ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•òÏó¨ÎèÑ Î°úÏª¨ UIÎäî Ïù¥ÎØ∏ ÏóÖÎç∞Ïù¥Ìä∏Îê®
                alert('‚ö†Ô∏è ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏßÄÎßå Î°úÏª¨ÏóêÏÑú ÌôïÏù∏ Í∞ÄÎä•Ìï©ÎãàÎã§!\n\nÏãúÎÇòÎ¶¨Ïò§ Î™©Î°ùÏóêÏÑú ÌôïÏù∏ÌïòÏÑ∏Ïöî!\n\nÏò§Î•ò: ' + error.message);
                closeModal('scenarioModal');
            }
        }

        async function deleteScenario(scenarioId) {
            if (!confirm('Ï†ïÎßêÎ°ú Ïù¥ ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÍ¥ÄÎ†®Îêú Î™®Îì† ÏóêÌîºÏÜåÎìúÎèÑ Ìï®Íªò ÏÇ≠Ï†úÎê©ÎãàÎã§.')) {
                return;
            }

            try {
                console.log('üóëÔ∏è ÏãúÎÇòÎ¶¨Ïò§ ÏÇ≠Ï†ú ÏãúÏûë (LocalStorage):', scenarioId);
                
                // LocalStorageÏóêÏÑú ÏãúÎÇòÎ¶¨Ïò§ ÏÇ≠Ï†ú
                const existingScenarios = localStorage.getItem('scenarios');
                const scenariosData = existingScenarios ? JSON.parse(existingScenarios) : {};
                
                if (scenariosData[scenarioId]) {
                    // ÏãúÎÇòÎ¶¨Ïò§ ÏÇ≠Ï†ú
                    delete scenariosData[scenarioId];
                    
                    // LocalStorageÏóê Ï†ÄÏû•
                    localStorage.setItem('scenarios', JSON.stringify(scenariosData));
                    console.log('‚úÖ LocalStorageÏóêÏÑú ÏãúÎÇòÎ¶¨Ïò§ ÏÇ≠Ï†ú ÏôÑÎ£å');
                }
                
                // Ï†ÑÏó≠ Î≥ÄÏàòÏóêÏÑúÎèÑ ÏÇ≠Ï†ú
                if (scenarios[scenarioId]) {
                    delete scenarios[scenarioId];
                }
                if (window.scenarios && window.scenarios[scenarioId]) {
                    delete window.scenarios[scenarioId];
                }
                
                // UI Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏
                displayScenarios();
                updateScenarioStats();
                
                alert('‚úÖ ÏãúÎÇòÎ¶¨Ïò§Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                console.log('‚úÖ ÏãúÎÇòÎ¶¨Ïò§ ÏÇ≠Ï†ú ÌîÑÎ°úÏÑ∏Ïä§ ÏôÑÎ£å');
                
            } catch (error) {
                console.error('‚ùå ÏãúÎÇòÎ¶¨Ïò§ ÏÇ≠Ï†ú Ïò§Î•ò:', error);
                alert('‚ùå ÏãúÎÇòÎ¶¨Ïò§ ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message);
            }
        }

        async function generateAIContext() {
            const title = document.getElementById('scenarioTitle').value;
            const description = document.getElementById('scenarioDescription').value;
            const backgroundSetting = document.getElementById('backgroundSetting').value;
            const mood = document.getElementById('mood').value;

            if (!title || !description || !backgroundSetting || !mood) {
                alert('AI Ïª®ÌÖçÏä§Ìä∏ ÏÉùÏÑ±ÏùÑ ÏúÑÌï¥ Î™®Îì† ÌïÑÏàò Ìï≠Î™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            const aiContextDiv = document.getElementById('aiContext');
            aiContextDiv.innerHTML = '<div class="loading"></div> AIÍ∞Ä Ïª®ÌÖçÏä§Ìä∏Î•º ÏÉùÏÑ± Ï§ëÏûÖÎãàÎã§...';

            // Fallback: Î°úÏª¨ ÌÖúÌîåÎ¶ø Í∏∞Î∞ò Ïª®ÌÖçÏä§Ìä∏ ÏÉùÏÑ±
            setTimeout(() => {
                const context = generateLocalAIContext(title, description, backgroundSetting, mood);
                aiContextDiv.innerHTML = context;
            }, 1500);
        }

        function generateLocalAIContext(title, description, backgroundSetting, mood) {
            const templates = {
                'Î°úÎß®Ìã±': `ÎåÄÌïôÍµê ${backgroundSetting}ÏóêÏÑú Î≤åÏñ¥ÏßÄÎäî Îã¨ÏΩ§Ìïú Î°úÎß®Ïä§. ${description}ÎùºÎäî ÏÉÅÌô© ÏÜçÏóêÏÑú Îëê ÏÇ¨ÎûåÏùò ÎßàÏùåÏù¥ ÏÑúÎ°úÎ•º Ìñ•Ìï¥ Îã§Í∞ÄÍ∞ÄÍ≥† ÏûàÎã§. Îî∞ÎúªÌïú Î¥ÑÎÇ†, Î≤öÍΩÉÏù¥ Ìù©ÎÇ†Î¶¨Îäî Ï∫†ÌçºÏä§ÏóêÏÑú ÏãúÏûëÎêú Ïù¥ÏïºÍ∏∞Îäî Ï†êÏ†ê ÍπäÏñ¥Ï†∏Í∞ÑÎã§.`,
                'ÎìúÎùºÎßàÌã±': `${backgroundSetting}Î•º Î∞∞Í≤ΩÏúºÎ°ú Ìïú Í∞êÏ†ïÏùò ÏÜåÏö©ÎèåÏù¥. ${description}ÎùºÎäî Î≥µÏû°Ìïú ÏÉÅÌô©Ïù¥ Îëê ÏÇ¨ÎûåÏùò Í¥ÄÍ≥ÑÎ•º ÏãúÌóòÏóê Îì§Í≤å ÌïúÎã§. Í∞àÎì±Í≥º Ïò§Ìï¥Í∞Ä ÏñΩÌûàÎ©¥ÏÑúÎèÑ ÏßÑÏã§Ìïú Í∞êÏ†ïÏùÑ Ï∞æÏïÑÍ∞ÄÎäî Ïó¨Ï†ïÏù¥ ÌéºÏ≥êÏßÑÎã§.`,
                'ÏΩîÎØπ': `ÏõÉÏùåÏù¥ ÎÅäÏù¥ÏßÄ ÏïäÎäî ${backgroundSetting}ÏóêÏÑúÏùò Ïú†ÏæåÌïú ÎßåÎÇ®. ${description}ÎùºÎäî Ïû¨ÎØ∏ÏûàÎäî ÏÉÅÌô©Îì§Ïù¥ Ïó∞ÏÜçÏúºÎ°ú ÏùºÏñ¥ÎÇòÎ©∞ Îëê ÏÇ¨Îûå ÏÇ¨Ïù¥Ïóê ÌäπÎ≥ÑÌïú ÏºÄÎØ∏Ïä§Ìä∏Î¶¨Í∞Ä ÎßåÎì§Ïñ¥ÏßÑÎã§. ÏÜåÏÜåÌïú Ìï¥ÌîÑÎãùÎì§Ïù¥ Îã¨ÏΩ§Ìïú Ï∂îÏñµÏúºÎ°ú Î≥ÄÌï¥Í∞ÑÎã§.`,
                'ÌòÑÏã§Ï†Å': `ÌòÑÏã§Ï†ÅÏù¥Í≥† ÏßÑÏÜîÌïú ${backgroundSetting}ÏóêÏÑúÏùò Ïù¥ÏïºÍ∏∞. ${description}Î•º ÌÜµÌï¥ ÏßÑÏßú ÏÇ¨ÎûëÏù¥ Î¨¥ÏóáÏù∏ÏßÄ Í≥†ÎØºÌïòÍ≤å ÎêúÎã§. Ïù¥ÏÉÅÍ≥º ÌòÑÏã§ ÏÇ¨Ïù¥ÏóêÏÑú Í∑†ÌòïÏùÑ Ï∞æÏïÑÍ∞ÄÎ©∞ ÏÑúÎ°úÎ•º Ïù¥Ìï¥Ìï¥ÎÇòÍ∞ÄÎäî Í≥ºÏ†ïÏù¥ Í∑∏Î†§ÏßÑÎã§.`
            };
            
            return templates[mood] || templates['Î°úÎß®Ìã±'];
        }


        // === ÏòàÏãú ÏûêÎèô ÏûÖÎ†• Í∏∞Îä• ===
        function fillExample(fieldId, element) {
            const field = document.getElementById(fieldId);
            const text = element.textContent;
            
            if (field.tagName === 'TEXTAREA') {
                field.value = text;
                field.style.height = 'auto';
                field.style.height = field.scrollHeight + 'px';
            } else {
                field.value = text;
            }
            
            // ÏãúÍ∞ÅÏ†Å ÌîºÎìúÎ∞±
            element.classList.add('selected');
            setTimeout(() => element.classList.remove('selected'), 300);
            
            // ÏûÖÎ†• Ïù¥Î≤§Ìä∏ Ìä∏Î¶¨Í±∞
            field.dispatchEvent(new Event('input', { bubbles: true }));
        }

        // === ÏóêÌîºÏÜåÎìú Í¥ÄÎ¶¨ Ìï®ÏàòÎì§ ===
        function manageEpisodes(scenarioId) {
            switchTab('episodes');
            document.getElementById('episodeScenarioSelect').value = scenarioId;
            loadEpisodes();
        }

        function populateEpisodeScenarioSelect() {
            const select = document.getElementById('episodeScenarioSelect');
            select.innerHTML = '<option value="">ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>';

            Object.values(scenarios).forEach(scenario => {
                const option = document.createElement('option');
                option.value = scenario.id;
                option.textContent = scenario.title;
                select.appendChild(option);
            });
        }

        async function loadEpisodes() {
            const scenarioId = document.getElementById('episodeScenarioSelect').value || currentScenarioId;
            if (!scenarioId) {
                document.getElementById('episodeInfo').style.display = 'none';
                console.log('‚ö†Ô∏è ÏãúÎÇòÎ¶¨Ïò§ IDÍ∞Ä ÏóÜÏñ¥ÏÑú ÏóêÌîºÏÜåÎìú Î°úÎî©ÏùÑ Í±¥ÎÑàÎúÅÎãàÎã§.');
                return;
            }

            currentScenarioId = scenarioId;
            document.getElementById('episodeInfo').style.display = 'block';
            console.log('üìö ÏóêÌîºÏÜåÎìú Î°úÎî© ÏãúÏûë - ÏãúÎÇòÎ¶¨Ïò§:', scenarioId);

            try {
                // LocalStorageÏóêÏÑú ÏóêÌîºÏÜåÎìú Î°úÎî©
                const localEpisodes = localStorage.getItem('episodes');
                let episodesData = {};
                
                if (localEpisodes) {
                    const allEpisodes = JSON.parse(localEpisodes);
                    console.log('üìä Ï†ÑÏ≤¥ ÏóêÌîºÏÜåÎìú Ïàò:', Object.keys(allEpisodes).length);
                    
                    // ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§Ïùò ÏóêÌîºÏÜåÎìúÎßå ÌïÑÌÑ∞ÎßÅ
                    Object.keys(allEpisodes).forEach(key => {
                        const episode = allEpisodes[key];
                        if (episode.scenario_id === scenarioId) {
                            episodesData[episode.episode_number] = episode;
                        }
                    });
                    
                    console.log(`‚úÖ ÏãúÎÇòÎ¶¨Ïò§ ${scenarioId}Ïùò ÏóêÌîºÏÜåÎìú:`, Object.keys(episodesData).length, 'Í∞ú');
                }
                
                // Ï†ÑÏó≠ Î≥ÄÏàò ÏóÖÎç∞Ïù¥Ìä∏
                episodes = episodesData;
                window.episodes = episodesData;
                
                // UI ÏóÖÎç∞Ïù¥Ìä∏
                displayEpisodes();
                updateEpisodeStats();
                
            } catch (error) {
                console.error('ÏóêÌîºÏÜåÎìú Î°úÎìú Ïò§Î•ò:', error);
                episodes = {};
                displayEpisodes();
                updateEpisodeStats();
            }
        }

        function displayEpisodes() {
            const grid = document.getElementById('episodesGrid');
            grid.innerHTML = '';

            for (let i = 1; i <= 36; i++) {
                const episode = episodes[i];
                const difficulty = getDifficultyByNumber(i);
                
                if (currentDifficultyFilter !== 'all' && difficulty !== currentDifficultyFilter) {
                    continue;
                }

                const card = createEpisodeCard(i, episode, difficulty);
                grid.innerHTML += card;
            }
        }

        function createEpisodeCard(number, episode, difficulty) {
            if (episode) {
                const characterName = getCharacterName(episode.character_id);
                return `
                    <div class="episode-card completed" onclick="editEpisode(${number})">
                        <div class="episode-number">#${number}</div>
                        <div style="font-size: 0.9em; color: white;">${characterName}</div>
                        <div style="font-size: 0.8em; opacity: 0.9;">Ìò∏Í∞êÎèÑ ${episode.required_affection}+</div>
                    </div>
                `;
            } else {
                return `
                    <div class="episode-card empty" onclick="createEpisode(${number})">
                        <div class="episode-number">#${number}</div>
                        <div style="color: #999; font-size: 0.9em;">ÎπÑÏñ¥ÏûàÏùå</div>
                        <div style="color: #ccc; font-size: 0.8em;">${difficulty.toUpperCase()}</div>
                    </div>
                `;
            }
        }

        function getDifficultyByNumber(number) {
            if (number <= 9) return 'easy';
            if (number <= 18) return 'medium';
            if (number <= 27) return 'hard';
            return 'expert';
        }

        function getCharacterName(characterId) {
            const names = {
                'yuna_infp': 'Ïú§ÏïÑ',
                'mina_enfp': 'ÎØ∏ÎÇò',
                'seoyeon_intj': 'ÏÑúÏó∞',
                'jihye_esfj': 'ÏßÄÌòú',
                'hyejin_istp': 'ÌòúÏßÑ'
            };
            return names[characterId] || 'Ïïå Ïàò ÏóÜÏùå';
        }

        function updateEpisodeStats() {
            const episodeArray = Object.values(episodes);
            const total = episodeArray.length;
            
            document.getElementById('totalEpisodes').textContent = `${total}/36`;
            document.getElementById('progressBar').style.width = `${(total/36)*100}%`;
            document.getElementById('episodeCount').textContent = total;
            
            // ÎÇúÏù¥ÎèÑÎ≥Ñ Ïπ¥Ïö¥Ìä∏
            let counts = { easy: 0, medium: 0, hard: 0, expert: 0 };
            episodeArray.forEach(ep => {
                const difficulty = getDifficultyByNumber(ep.episode_number);
                counts[difficulty]++;
            });
            
            document.getElementById('easyCount').textContent = `${counts.easy}/9`;
            document.getElementById('mediumCount').textContent = `${counts.medium}/9`;
            document.getElementById('hardCount').textContent = `${counts.hard}/9`;
            document.getElementById('expertCount').textContent = `${counts.expert}/9`;
            
            // ÌÉ≠ Ïπ¥Ïö¥Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('allCount').textContent = total;
            document.getElementById('easyTabCount').textContent = counts.easy;
            document.getElementById('mediumTabCount').textContent = counts.medium;
            document.getElementById('hardTabCount').textContent = counts.hard;
            document.getElementById('expertTabCount').textContent = counts.expert;
        }

        function filterByDifficulty(difficulty) {
            currentDifficultyFilter = difficulty;
            
            // ÌÉ≠ ÌôúÏÑ±Ìôî ÏÉÅÌÉú Î≥ÄÍ≤Ω
            document.querySelectorAll('.difficulty-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.closest('.difficulty-tab').classList.add('active');
            
            displayEpisodes();
        }

        function openEpisodeModal(mode) {
            currentMode = mode;
            document.getElementById('episodeModalTitle').textContent = 'ÏÉà ÏóêÌîºÏÜåÎìú ÏÉùÏÑ±';
            document.getElementById('episodeForm').reset();
            document.getElementById('dialoguePreview').style.display = 'none';
            generatedDialogue = null;
            
            // ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉùÍ∏∞ ÎèôÏ†Å Î°úÎî©
            loadEpisodeScenarioSelector();
            
            // Í∏∞Ï°¥ ÏãúÎÇòÎ¶¨Ïò§ IDÍ∞Ä ÏûàÏúºÎ©¥ ÏÑ†ÌÉù ÏÉÅÌÉúÎ°ú ÏÑ§Ï†ï
            if (currentScenarioId) {
                // ÏÑ†ÌÉùÍ∏∞Í∞Ä Î°úÎî©Îêú ÌõÑ ÏÑ§Ï†ïÌïòÍ∏∞ ÏúÑÌï¥ ÏïΩÍ∞Ñ ÏßÄÏó∞
                setTimeout(() => {
                    const scenarioSelect = document.getElementById('episodeScenarioSelect');
                    if (scenarioSelect.querySelector(`option[value="${currentScenarioId}"]`)) {
                        scenarioSelect.value = currentScenarioId;
                        onScenarioChange(); // Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ùÎèÑ ÏûêÎèô ÏóÖÎç∞Ïù¥Ìä∏
                    }
                }, 100);
            }
            
            document.getElementById('episodeModal').style.display = 'block';
        }

        function createEpisode(number) {
            openEpisodeModal('create');
            document.getElementById('episodeNumber').value = number;
            
            // ÎÇúÏù¥ÎèÑ ÏûêÎèô ÏÑ§Ï†ï
            const difficulty = getDifficultyByNumber(number);
            document.getElementById('difficulty').value = difficulty;
        }

        function editEpisode(number) {
            const episode = episodes[number];
            if (!episode) return;
            
            currentMode = 'edit';
            document.getElementById('episodeModalTitle').textContent = 'ÏóêÌîºÏÜåÎìú ÏàòÏ†ï';
            document.getElementById('episodeId').value = episode.id;
            document.getElementById('episodeScenarioId').value = episode.scenario_id;
            document.getElementById('episodeNumber').value = episode.episode_number;
            document.getElementById('characterSelect').value = episode.character_id;
            document.getElementById('difficulty').value = episode.difficulty;
            document.getElementById('userPrompt').value = episode.user_input_prompt;
            
            // AI ÏÉùÏÑ± ÎåÄÌôî ÌëúÏãú
            if (episode.ai_generated_dialogue) {
                generatedDialogue = episode.ai_generated_dialogue;
                displayDialoguePreview(generatedDialogue);
            }
            
            if (episode.custom_dialogue) {
                const custom = JSON.parse(episode.custom_dialogue);
                document.getElementById('customDialogue').value = custom.dialogue || '';
                document.getElementById('customNarration').value = custom.narration || '';
            }
            
            document.getElementById('episodeModal').style.display = 'block';
        }

        async function generateDialogue() {
            const characterId = document.getElementById('characterSelect').value;
            const userPrompt = document.getElementById('userPrompt').value;
            const difficulty = document.getElementById('difficulty').value;
            
            if (!characterId || !userPrompt) {
                alert('Ï∫êÎ¶≠ÌÑ∞ÏôÄ ÏÉÅÌô© ÌîÑÎ°¨ÌîÑÌä∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            const characterName = getCharacterName(characterId);
            const previewDiv = document.getElementById('dialoguePreview');
            previewDiv.style.display = 'block';
            
            document.getElementById('previewDialogue').innerHTML = '<div class="loading"></div> AIÍ∞Ä ÎåÄÌôîÎ•º ÏÉùÏÑ± Ï§ëÏûÖÎãàÎã§...';
            document.getElementById('previewNarration').textContent = '';
            document.getElementById('previewChoices').innerHTML = '';
            
            try {
                console.log('ü§ñ Î°úÏª¨ ÎåÄÌôî ÏÉùÏÑ± ÏãúÏûë...');
                
                // Î°úÏª¨ ÎåÄÌôî ÏÉùÏÑ± (API ÎåÄÏã†)
                generatedDialogue = generateLocalDialogue(characterId, characterName, userPrompt, difficulty);
                
                // ÏßßÏùÄ ÏßÄÏó∞ÏúºÎ°ú Î°úÎî© Ìö®Í≥º Ï†úÍ≥µ
                setTimeout(() => {
                    displayDialoguePreview(generatedDialogue);
                    console.log('‚úÖ Î°úÏª¨ ÎåÄÌôî ÏÉùÏÑ± ÏôÑÎ£å');
                }, 1000);
                
            } catch (error) {
                console.error('ÎåÄÌôî ÏÉùÏÑ± Ïò§Î•ò:', error);
                document.getElementById('previewDialogue').textContent = '‚ö†Ô∏è ÎåÄÌôî ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.';
            }
        }

        function displayDialoguePreview(dialogue) {
            if (!dialogue) return;
            
            document.getElementById('dialoguePreview').style.display = 'block';
            document.getElementById('previewDialogue').textContent = dialogue.dialogue;
            document.getElementById('previewNarration').textContent = dialogue.narration;
            
            const choicesList = document.getElementById('previewChoices');
            choicesList.innerHTML = '';
            
            dialogue.choices.forEach(choice => {
                const li = document.createElement('li');
                li.className = 'choice-item';
                li.innerHTML = `
                    <span>${choice.text}</span>
                    <span class="impact">Ìò∏Í∞êÎèÑ ${choice.affection_impact > 0 ? '+' : ''}${choice.affection_impact}</span>
                `;
                choicesList.appendChild(li);
            });
        }

        async function saveEpisode() {
            const scenarioId = document.getElementById('episodeScenarioSelect').value;
            const episodeNumber = parseInt(document.getElementById('episodeNumber').value);
            const characterId = document.getElementById('characterSelect').value;
            const difficulty = document.getElementById('difficulty').value;
            const userPrompt = document.getElementById('userPrompt').value;
            
            if (!scenarioId || !episodeNumber || !characterId || !userPrompt) {
                alert('Î™®Îì† ÌïÑÏàò Ìï≠Î™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.\n\n- ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉù\n- ÏóêÌîºÏÜåÎìú Î≤àÌò∏\n- Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉù\n- ÏÉÅÌô© ÌîÑÎ°¨ÌîÑÌä∏');
                return;
            }
            
            // Ï∫êÎ¶≠ÌÑ∞ Ïù¥Î¶Ñ Í∞ÄÏ†∏Ïò§Í∏∞
            const charactersData = window.characters || {};
            const character = charactersData[characterId];
            const characterName = character ? character.name : characterId;
            
            const episodeData = {
                scenario_id: scenarioId,
                episode_number: episodeNumber,
                character_id: characterId,
                character_name: characterName,
                difficulty: difficulty,
                user_input_prompt: userPrompt,
                created_at: new Date().toISOString(),
                id: currentMode === 'create' ? `episode_${scenarioId}_${episodeNumber}_${Date.now()}` : document.getElementById('episodeId').value
            };
            
            if (currentMode === 'create') {
                episodeData.action = 'create';
            } else {
                episodeData.action = 'update';
                episodeData.id = document.getElementById('episodeId').value;
            }
            
            // Ïª§Ïä§ÌÖÄ ÎåÄÌôîÍ∞Ä ÏûàÏúºÎ©¥ Ï∂îÍ∞Ä
            const customDialogue = document.getElementById('customDialogue').value;
            const customNarration = document.getElementById('customNarration').value;
            if (customDialogue || customNarration) {
                episodeData.custom_dialogue = {
                    dialogue: customDialogue,
                    narration: customNarration
                };
            }
            
            // ÏÉùÏÑ±Îêú ÎåÄÌôîÍ∞Ä ÏûàÏúºÎ©¥ Ï∂îÍ∞Ä
            if (generatedDialogue) {
                episodeData.generated_dialogue = generatedDialogue;
            }
            
            try {
                console.log('üíæ === ÏóêÌîºÏÜåÎìú Ï†ÄÏû• ÏãúÏûë ===');
                console.log('üìä ÏóêÌîºÏÜåÎìú Îç∞Ïù¥ÌÑ∞:', episodeData);
                
                // üíæ LocalStorage ÏßÅÏ†ë Ï†ÄÏû• (ÌôïÏã§Ìïú Î∞©Î≤ï!)
                console.log('üíæ LocalStorageÏóê ÏóêÌîºÏÜåÎìú Ï†ÄÏû• ÏãúÎèÑ...');
                
                // ÌòÑÏû¨ Ï†ÄÏû•Îêú ÏóêÌîºÏÜåÎìúÎì§ÏùÑ Í∞ÄÏ†∏Ïò¥
                const existingEpisodes = localStorage.getItem('episodes');
                const episodesData = existingEpisodes ? JSON.parse(existingEpisodes) : {};
                
                // ÏÉà ÏóêÌîºÏÜåÎìú Ï∂îÍ∞Ä/ÏàòÏ†ï
                episodesData[episodeData.id] = episodeData;
                
                // LocalStorageÏóê Ï†ÄÏû•
                localStorage.setItem('episodes', JSON.stringify(episodesData));
                console.log('‚úÖ LocalStorage ÏóêÌîºÏÜåÎìú Ï†ÄÏû• ÏÑ±Í≥µ! Ï¥ù', Object.keys(episodesData).length, 'Í∞ú ÏóêÌîºÏÜåÎìú');
                
                // ÏãúÎÇòÎ¶¨Ïò§Ïùò ÏóêÌîºÏÜåÎìú Ïπ¥Ïö¥Ìä∏ÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
                const scenariosData = window.scenarios || {};
                if (scenariosData[scenarioId]) {
                    const scenarioEpisodes = Object.values(episodesData).filter(ep => ep.scenario_id === scenarioId);
                    scenariosData[scenarioId].episode_count = scenarioEpisodes.length;
                    window.scenarios = scenariosData;
                    
                    // ÏãúÎÇòÎ¶¨Ïò§ÎèÑ LocalStorageÏóê Ï†ÄÏû•
                    localStorage.setItem('scenarios', JSON.stringify(scenariosData));
                    console.log('‚úÖ ÏãúÎÇòÎ¶¨Ïò§ ÏóêÌîºÏÜåÎìú Ïπ¥Ïö¥Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏:', scenariosData[scenarioId].episode_count);
                }
                
                // Ï†ÄÏû• ÏÑ±Í≥µ Î©îÏãúÏßÄ
                const successMessage = currentMode === 'create' ? 
                    `üíñ ÏÉàÎ°úÏö¥ ÏóêÌîºÏÜåÎìú ${episodeNumber}Î≤àÏù¥ ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!\nÏãúÎÇòÎ¶¨Ïò§: ${scenariosData[scenarioId]?.title || scenarioId}\nÏ∫êÎ¶≠ÌÑ∞: ${characterName}` :
                    `‚ú®ÏóêÌîºÏÜåÎìú ${episodeNumber}Î≤àÏù¥ ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§!`;
                
                alert(successMessage);
                closeModal('episodeModal');
                
                // UI ÏµúÏ¢Ö ÏóÖÎç∞Ïù¥Ìä∏
                console.log('üîÑ Ï†ÄÏû• ÌõÑ ÏµúÏ¢Ö UI ÎèôÍ∏∞Ìôî...');
                updateScenarioStats();
                // loadEpisodes(); // ÏóêÌîºÏÜåÎìú Î™©Î°ùÎèÑ ÏÉàÎ°úÍ≥†Ïπ® (ÌïÑÏöîÏãú)
                
                console.log('‚úÖ ÏóêÌîºÏÜåÎìú Ï†ÄÏû• ÌîÑÎ°úÏÑ∏Ïä§ ÏôÑÎ£å!');
                
            } catch (error) {
                console.error('‚ùå ÏóêÌîºÏÜåÎìú Ï†ÄÏû• Ïã§Ìå®:', error);
                alert('ÏóêÌîºÏÜåÎìú Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
            }
        }

        async function generateBulkEpisodes() {
            console.log('üöÄ ÏóêÌîºÏÜåÎìú ÏùºÍ¥Ñ ÏÉùÏÑ± ÏãúÏûë...');
            
            // 1. ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉù
            const availableScenarios = Object.keys(scenarios);
            if (availableScenarios.length === 0) {
                alert('ÏÉùÏÑ±Îêú ÏãúÎÇòÎ¶¨Ïò§Í∞Ä ÏóÜÏäµÎãàÎã§. Î®ºÏ†Ä ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            let scenarioOptions = 'ÏÇ¨Ïö© Í∞ÄÎä•Ìïú ÏãúÎÇòÎ¶¨Ïò§:\n';
            availableScenarios.forEach((id, index) => {
                scenarioOptions += `${index + 1}. ${scenarios[id].title} (ID: ${id})\n`;
            });
            
            const scenarioChoice = prompt(`${scenarioOptions}\nÏãúÎÇòÎ¶¨Ïò§ Î≤àÌò∏Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî (1-${availableScenarios.length}):`);
            if (!scenarioChoice) return;
            
            const selectedScenarioIndex = parseInt(scenarioChoice) - 1;
            if (selectedScenarioIndex < 0 || selectedScenarioIndex >= availableScenarios.length) {
                alert('Ïò¨Î∞îÎ•∏ ÏãúÎÇòÎ¶¨Ïò§ Î≤àÌò∏Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            const selectedScenarioId = availableScenarios[selectedScenarioIndex];
            const selectedScenario = scenarios[selectedScenarioId];
            console.log('‚úÖ ÏÑ†ÌÉùÎêú ÏãúÎÇòÎ¶¨Ïò§:', selectedScenario.title);
            
            // 2. Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉù  
            const availableCharacters = Object.keys(characters);
            if (availableCharacters.length === 0) {
                alert('ÏÉùÏÑ±Îêú Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§. Î®ºÏ†Ä Ï∫êÎ¶≠ÌÑ∞Î•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            let characterOptions = 'ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ï∫êÎ¶≠ÌÑ∞:\n';
            availableCharacters.forEach((id, index) => {
                const char = characters[id];
                characterOptions += `${index + 1}. ${char.name} (${char.mbti}) - ID: ${id}\n`;
            });
            
            const characterChoice = prompt(`${characterOptions}\nÏ∫êÎ¶≠ÌÑ∞ Î≤àÌò∏Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî (1-${availableCharacters.length}):`);
            if (!characterChoice) return;
            
            const selectedCharacterIndex = parseInt(characterChoice) - 1;
            if (selectedCharacterIndex < 0 || selectedCharacterIndex >= availableCharacters.length) {
                alert('Ïò¨Î∞îÎ•∏ Ï∫êÎ¶≠ÌÑ∞ Î≤àÌò∏Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            const selectedCharacterId = availableCharacters[selectedCharacterIndex];
            const selectedCharacter = characters[selectedCharacterId];
            console.log('‚úÖ ÏÑ†ÌÉùÎêú Ï∫êÎ¶≠ÌÑ∞:', selectedCharacter.name);
            
            // 3. ÏóêÌîºÏÜåÎìú Î≤îÏúÑ ÏÑ†ÌÉù
            const startNum = parseInt(prompt('ÏãúÏûë ÏóêÌîºÏÜåÎìú Î≤àÌò∏ (1-36):'));
            const endNum = parseInt(prompt('Ï¢ÖÎ£å ÏóêÌîºÏÜåÎìú Î≤àÌò∏ (1-36):'));
            
            if (!startNum || !endNum || startNum < 1 || endNum > 36 || startNum > endNum) {
                alert('Ïò¨Î∞îÎ•∏ Î≤îÏúÑÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî. (1-36, ÏãúÏûëÎ≤àÌò∏ ‚â§ Ï¢ÖÎ£åÎ≤àÌò∏)');
                return;
            }
            
            const episodeCount = endNum - startNum + 1;
            
            // 4. ÌôïÏù∏ Î∞è ÏÉùÏÑ±
            if (confirm(`üìã ÏùºÍ¥Ñ ÏÉùÏÑ± ÏÑ§Ï†ï:\n\nÏãúÎÇòÎ¶¨Ïò§: ${selectedScenario.title}\nÏ∫êÎ¶≠ÌÑ∞: ${selectedCharacter.name} (${selectedCharacter.mbti})\nÎ≤îÏúÑ: ${startNum}Î≤à ~ ${endNum}Î≤à (Ï¥ù ${episodeCount}Í∞ú)\n\nÏÉùÏÑ±ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                
                console.log('üîÑ ÏóêÌîºÏÜåÎìú ÏùºÍ¥Ñ ÏÉùÏÑ± ÏßÑÌñâ...');
                let successCount = 0;
                let failCount = 0;
                
                for (let episodeNum = startNum; episodeNum <= endNum; episodeNum++) {
                    try {
                        // Í∞Å ÏóêÌîºÏÜåÎìúÎ≥Ñ ÏÉÅÌô© ÌîÑÎ°¨ÌîÑÌä∏ ÏûêÎèô ÏÉùÏÑ±
                        const situationPrompts = [
                            "Ïö∞Ïó∞Ìûà ÎßàÏ£ºÏπú ÏÉÅÌô©ÏóêÏÑú ÏÑúÎ°úÎ•º ÏùòÏãùÌïòÎ©∞",
                            "Ìï®Íªò Í≥ºÏ†úÎ•º ÌïòÎ©¥ÏÑú Í∞ÄÍπåÏõåÏßÄÎäî ÏàúÍ∞Ñ",
                            "ÎπÑ ÎÇ¥Î¶¨Îäî ÎÇ† Í∞ôÏùÄ Ïö∞ÏÇ∞ÏùÑ Ïì∞Í≤å ÎêòÏñ¥",
                            "Ï∂ïÏ†úÏóêÏÑú Ìï®Íªò Ï¶êÍ±∞Ïö¥ ÏãúÍ∞ÑÏùÑ Î≥¥ÎÇ¥Î©∞",
                            "Ï°∞Ïö©Ìïú ÎèÑÏÑúÍ¥ÄÏóêÏÑú ÎààÏù¥ ÎßàÏ£ºÏ≥ê",
                            "Ïπ¥ÌéòÏóêÏÑú Ïö∞Ïó∞Ìûà ÎßåÎÇò ÎåÄÌôîÌïòÎ©∞",
                            "Î∞©Í≥ºÌõÑ ÍµêÏã§ÏóêÏÑú ÎëòÎßå ÎÇ®Í≤å ÎêòÏñ¥",
                            "ÏÇ∞Ï±ÖÌïòÎ©∞ ÏßÑÏÜîÌïú ÎåÄÌôîÎ•º ÎÇòÎàÑÎäî",
                            "ÌïôÍµê Ïò•ÏÉÅÏóêÏÑú Î∞îÎùºÎ≥∏ ÌïòÎäòÏ≤òÎüº Ï≤≠ÎüâÌïú",
                            "Ï∂îÏö¥ Í≤®Ïö∏ Îî∞ÎúªÌïú ÎßàÏùåÏùÑ ÎÇòÎàÑÎäî"
                        ];
                        
                        const promptIndex = (episodeNum - 1) % situationPrompts.length;
                        const userPrompt = situationPrompts[promptIndex];
                        
                        // ÎÇúÏù¥ÎèÑ ÏÑ§Ï†ï (1-9: Easy, 10-18: Medium, 19-27: Hard, 28-36: Expert)
                        let difficulty = 'Easy';
                        if (episodeNum >= 10 && episodeNum <= 18) difficulty = 'Medium';
                        else if (episodeNum >= 19 && episodeNum <= 27) difficulty = 'Hard';
                        else if (episodeNum >= 28 && episodeNum <= 36) difficulty = 'Expert';
                        
                        // Î°úÏª¨ ÎåÄÌôî ÏÉùÏÑ±
                        const generatedDialogue = generateLocalDialogue(selectedCharacterId, selectedCharacter.name, userPrompt, difficulty);
                        
                        // ÏóêÌîºÏÜåÎìú Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
                        const episodeData = {
                            episode_number: episodeNum,
                            scenario_id: selectedScenarioId,
                            character_id: selectedCharacterId,
                            character_name: selectedCharacter.name,
                            user_input_prompt: userPrompt,
                            difficulty: difficulty,
                            ai_generated_dialogue: generatedDialogue,
                            generated_dialogue: generatedDialogue,
                            created_at: new Date().toISOString()
                        };
                        
                        // LocalStorageÏóê Ï†ÄÏû•
                        const existingEpisodes = localStorage.getItem('episodes');
                        const episodesData = existingEpisodes ? JSON.parse(existingEpisodes) : {};
                        
                        const episodeKey = `${selectedScenarioId}_${episodeNum}`;
                        episodesData[episodeKey] = episodeData;
                        
                        localStorage.setItem('episodes', JSON.stringify(episodesData));
                        
                        // Ï†ÑÏó≠ Î≥ÄÏàòÏóêÎèÑ Ï†ÄÏû•
                        if (!episodes) episodes = {};
                        episodes[episodeKey] = episodeData;
                        
                        successCount++;
                        console.log(`‚úÖ ÏóêÌîºÏÜåÎìú ${episodeNum}Î≤à ÏÉùÏÑ± ÏôÑÎ£å`);
                        
                    } catch (error) {
                        console.error(`‚ùå ÏóêÌîºÏÜåÎìú ${episodeNum}Î≤à ÏÉùÏÑ± Ïã§Ìå®:`, error);
                        failCount++;
                    }
                }
                
                // Í≤∞Í≥º ÌëúÏãú
                alert(`üéâ ÏùºÍ¥Ñ ÏÉùÏÑ± ÏôÑÎ£å!\n\n‚úÖ ÏÑ±Í≥µ: ${successCount}Í∞ú\n‚ùå Ïã§Ìå®: ${failCount}Í∞ú\n\nÏóêÌîºÏÜåÎìú Î™©Î°ùÏùÑ ÏÉàÎ°úÍ≥†Ïπ®Ìï©ÎãàÎã§.`);
                
                // UI ÏóÖÎç∞Ïù¥Ìä∏
                currentScenarioId = selectedScenarioId;
                loadEpisodes();
            }
        }

        // === Ï∫êÎ¶≠ÌÑ∞ Í¥ÄÎ¶¨ Ìï®ÏàòÎì§ ===
        // üöÄ GitHub API Ïö∞ÏÑ† Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú (ÌòÅÏã†Ï†Å Ìï¥Í≤∞Ï±Ö!)
        async function loadCharacters() {
            console.log('üì• === Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú ÏãúÏûë (GitHub API Ïö∞ÏÑ†) ===');
            console.log('üïí Î°úÎìú ÏãúÍ∞Ñ:', new Date().toISOString());
            
            // 1ÏàúÏúÑ: GitHub APIÏóêÏÑú Î°úÎìú (ÏµúÏã† ÏòÅÍµ¨ Îç∞Ïù¥ÌÑ∞)
            try {
                console.log('üêô GitHub APIÏóêÏÑú Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú...');
                
                // GitHub ÌÜ†ÌÅ∞ ÌôïÏù∏
                if (!GITHUB_CONFIG.token) {
                    console.log('üîê GitHub ÌÜ†ÌÅ∞ Î°úÎìú ÏãúÎèÑ...');
                    await loadGitHubToken();
                }
                
                if (GITHUB_CONFIG.token) {
                    const gitHubCharacters = await loadCharactersFromGitHub();
                    const characterCount = Object.keys(gitHubCharacters).length;
                    console.log('üìä GitHub Ï∫êÎ¶≠ÌÑ∞ Ïàò:', characterCount);
                    
                    if (characterCount > 0) {
                        characters = gitHubCharacters;
                        
                        // GitHub Îç∞Ïù¥ÌÑ∞Î•º Î°úÏª¨ÏóêÎèÑ Î∞±ÏóÖ
                        localStorage.setItem('chatgame_characters', JSON.stringify(characters));
                        
                        console.log('‚úÖ GitHub APIÏóêÏÑú Î°úÎìú ÏôÑÎ£å. Ï∫êÎ¶≠ÌÑ∞ IDÎì§:', Object.keys(characters));
                        displayCharacters();
                        updateCharacterStats();
                        console.log('üéâ === Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú ÏôÑÎ£å (GitHub API) ===');
                        return;
                    } else {
                        console.log('üì≠ GitHubÏóê Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå');
                    }
                } else {
                    console.log('üîê GitHub ÌÜ†ÌÅ∞ ÏóÜÏùå, Îã§Î•∏ Î∞©Î≤ï ÏãúÎèÑ...');
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è GitHub API Î°úÎìú Ïã§Ìå®:', error);
            }
            
            // 2ÏàúÏúÑ: Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú Î°úÎìú (Î∞±ÏóÖ)
            try {
                console.log('üíæ Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú Ï∫êÎ¶≠ÌÑ∞ Î∞±ÏóÖ Î°úÎìú...');
                const localData = localStorage.getItem('chatgame_characters');
                
                if (localData) {
                    const localCharacters = JSON.parse(localData);
                    const characterCount = Object.keys(localCharacters).length;
                    console.log('üìä Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ Î∞±ÏóÖ Ï∫êÎ¶≠ÌÑ∞ Ïàò:', characterCount);
                    
                    if (characterCount > 0) {
                        characters = localCharacters;
                        console.log('‚úÖ Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ Î∞±ÏóÖÏóêÏÑú Î°úÎìú ÏôÑÎ£å. Ï∫êÎ¶≠ÌÑ∞ IDÎì§:', Object.keys(characters));
                        displayCharacters();
                        updateCharacterStats();
                        console.log('üéâ === Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú ÏôÑÎ£å (Î°úÏª¨ Î∞±ÏóÖ) ===');
                        return;
                    }
                }
            } catch (error) {
                console.error('‚ùå Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ Î°úÎìú ÏòàÏô∏:', error);
            }
            
            // 3ÏàúÏúÑ: AI APIÏóêÏÑú Î°úÎìú
            try {
                console.log('ü§ñ AI Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±Í∏∞ API Î°úÎìú...');
                console.log('ü§ñ AI Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±Í∏∞ API Ìò∏Ï∂ú...');
                const aiResponse = await fetch('/api/character-ai-generator?action=list_characters&_t=' + Date.now());
                
                console.log('üì∂ AI API ÏùëÎãµ ÏÉÅÌÉú:', aiResponse.status);
                
                if (aiResponse.ok) {
                    const aiData = await aiResponse.json();
                    console.log('ü§ñ AI API ÏõêÏãú ÏùëÎãµ:', JSON.stringify(aiData, null, 2));
                    
                    if (aiData.success && aiData.characters) {
                        const characterCount = Object.keys(aiData.characters).length;
                        console.log('üìä AI API Ï∫êÎ¶≠ÌÑ∞ Ïàò:', characterCount);
                        
                        if (characterCount > 0) {
                            characters = aiData.characters;
                            console.log('‚úÖ AI APIÏóêÏÑú Î°úÎìú ÏôÑÎ£å. Ï∫êÎ¶≠ÌÑ∞ IDÎì§:', Object.keys(characters));
                            displayCharacters();
                            updateCharacterStats();
                            console.log('üéâ === Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú ÏôÑÎ£å (AI API) ===');
                            return;
                        } else {
                            console.log('üòµ AI APIÏóêÏÑú Îπà Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù Î∞òÌôò');
                        }
                    } else {
                        console.log('üòµ AI API ÏùëÎãµÏù¥ ÎπÑÏ†ïÏÉÅ:', aiData);
                    }
                } else {
                    console.log('‚ùå AI API HTTP Ïò§Î•ò:', aiResponse.status);
                }
            } catch (error) {
                console.error('‚ùå AI API ÏòàÏô∏:', error);
            }
            
            try {
                // Í∏∞Î≥∏ characters.json ÏãúÎèÑ
                console.log('üìÅ Í∏∞Î≥∏ characters.json ÌååÏùº Î°úÎìú...');
                const response = await fetch('/data/characters.json?_t=' + Date.now());
                
                console.log('üì∂ Í∏∞Î≥∏ ÌååÏùº ÏùëÎãµ ÏÉÅÌÉú:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('üìÅ Í∏∞Î≥∏ ÌååÏùº ÏõêÏãú Îç∞Ïù¥ÌÑ∞:', JSON.stringify(data, null, 2));
                    
                    if (data.characters && Array.isArray(data.characters)) {
                        // Array ÌòïÌÉúÎ•º Object ÌòïÌÉúÎ°ú Î≥ÄÌôò
                        characters = {};
                        data.characters.forEach(char => {
                            characters[char.id] = char;
                        });
                        const characterCount = Object.keys(characters).length;
                        console.log('‚úÖ Í∏∞Î≥∏ ÌååÏùºÏóêÏÑú Î°úÎìúÎêú Ï∫êÎ¶≠ÌÑ∞ Ïàò:', characterCount);
                        
                        if (characterCount > 0) {
                            console.log('‚úÖ Ï∫êÎ¶≠ÌÑ∞ IDÎì§:', Object.keys(characters));
                        }
                        
                        displayCharacters();
                        updateCharacterStats();
                        console.log('üéâ === Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú ÏôÑÎ£å (Í∏∞Î≥∏ ÌååÏùº) ===');
                        return;
                    } else {
                        console.log('üòµ Í∏∞Î≥∏ ÌååÏùºÏùò characters ÌïÑÎìúÍ∞Ä ÎπÑÏñ¥ÏûàÍ±∞ÎÇò ÎπÑÏ†ïÏÉÅ');
                    }
                } else {
                    console.log('‚ùå Í∏∞Î≥∏ ÌååÏùº HTTP Ïò§Î•ò:', response.status);
                }
            } catch (error) {
                console.error('‚ùå Í∏∞Î≥∏ ÌååÏùº ÏòàÏô∏:', error);
            }
            
            // Î™®Îì† Î∞©Î≤ïÏù¥ Ïã§Ìå®ÌïòÎ©¥ Îπà Îç∞Ïù¥ÌÑ∞Î°ú Ï¥àÍ∏∞Ìôî
            console.log('‚ö†Ô∏è === Î™®Îì† Î°úÎìú Î∞©Î≤ï Ïã§Ìå®, Îπà Îç∞Ïù¥ÌÑ∞Î°ú Ï¥àÍ∏∞Ìôî ===');
            characters = {};
            displayCharacters();
            updateCharacterStats();
            console.log('üéâ === Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú ÏôÑÎ£å (Îπà Îç∞Ïù¥ÌÑ∞) ===');
        }

        // Í∏∞Î≥∏ Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú (fallback)
        // ÏÇ¨Ïö©ÌïòÏßÄ ÏïäÏùÑ ÏòàÏ†ïÏù¥ÎØÄÎ°ú Ï£ºÏÑù Ï≤òÎ¶¨
        // function loadDefaultCharacters() { ... }

        // === ÏÇ¨ÏßÑ Î∂ÑÏÑù Í∏∞Îä• ===
        let uploadedImageBase64 = null;
        let currentAnalysisResult = null;

        // Ïù¥ÎØ∏ÏßÄ ÏïïÏ∂ï Ìï®Ïàò
        function compressImage(dataUrl, quality, callback) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                // ÏµúÎåÄ ÌÅ¨Í∏∞ Ï†úÌïú (Í∞ÄÎ°ú/ÏÑ∏Î°ú 800px)
                const maxSize = 800;
                let { width, height } = img;
                
                if (width > height) {
                    if (width > maxSize) {
                        height = (height * maxSize) / width;
                        width = maxSize;
                    }
                } else {
                    if (height > maxSize) {
                        width = (width * maxSize) / height;
                        height = maxSize;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                
                // Ïù¥ÎØ∏ÏßÄ Í∑∏Î¶¨Í∏∞
                ctx.drawImage(img, 0, 0, width, height);
                
                // ÏïïÏ∂ïÎêú Îç∞Ïù¥ÌÑ∞ URL Î∞òÌôò
                const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                callback(compressedDataUrl);
            };
            
            img.src = dataUrl;
        }

        function handleImageUpload() {
            const fileInput = document.getElementById('characterImageUpload');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            // ÌååÏùº ÌÅ¨Í∏∞ Í≤ÄÏÇ¨ (2MB Ï†úÌïú - Vercel ÏóÖÎ°úÎìú Ï†úÌïú Í≥†Î†§)
            const maxSize = 2 * 1024 * 1024; // 2MB
            if (file.size > maxSize) {
                const sizeInMB = (file.size / (1024 * 1024)).toFixed(1);
                alert(`Ïù¥ÎØ∏ÏßÄ ÌååÏùºÏù¥ ÎÑàÎ¨¥ ÌÅΩÎãàÎã§!\nÌòÑÏû¨ ÌÅ¨Í∏∞: ${sizeInMB}MB\nÏµúÎåÄ ÌóàÏö©: 2.0MB\n\nÎçî ÏûëÏùÄ Ïù¥ÎØ∏ÏßÄÎ•º ÏÑ†ÌÉùÌïòÍ±∞ÎÇò Ïù¥ÎØ∏ÏßÄÎ•º ÏïïÏ∂ïÌï¥Ï£ºÏÑ∏Ïöî.`);
                // ÌååÏùº ÏûÖÎ†• Ï¥àÍ∏∞Ìôî
                fileInput.value = '';
                return;
            }
            
            // Ïù¥ÎØ∏ÏßÄ ÌååÏùºÏù∏ÏßÄ Í≤ÄÏÇ¨
            if (!file.type.startsWith('image/')) {
                alert('Ïù¥ÎØ∏ÏßÄ ÌååÏùºÎßå ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§.');
                return;
            }
            
            console.log('üì∑ Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú ÏãúÏûë:', file.name);
            
            // Ïù¥ÎØ∏ÏßÄ ÏïïÏ∂ï Î∞è Ï≤òÎ¶¨
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // Ïù¥ÎØ∏ÏßÄ ÏïïÏ∂ï Ï≤òÎ¶¨
                    compressImage(e.target.result, 0.8, (compressedDataUrl) => {
                        // Base64 Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• (Îç∞Ïù¥ÌÑ∞ URI Ìó§Îçî Ï†úÍ±∞)
                        uploadedImageBase64 = compressedDataUrl.split(',')[1];
                        
                        // ÎØ∏Î¶¨Î≥¥Í∏∞ ÌëúÏãú
                        document.getElementById('previewImg').src = compressedDataUrl;
                        document.getElementById('imagePreview').style.display = 'block';
                        
                        // Î∂ÑÏÑù Î≤ÑÌäº ÌôúÏÑ±Ìôî
                        document.getElementById('analyzeImageBtn').disabled = false;
                        
                        // ÏïïÏ∂ïÎêú ÌÅ¨Í∏∞ ÌëúÏãú
                        const compressedSize = (compressedDataUrl.length * 0.75 / 1024).toFixed(1);
                        console.log(`‚úÖ Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú ÏôÑÎ£å (ÏïïÏ∂ï ÌõÑ ÌÅ¨Í∏∞: ${compressedSize}KB)`);
                    });
                } catch (error) {
                    console.error('‚ùå Ïù¥ÎØ∏ÏßÄ Ï≤òÎ¶¨ Ïò§Î•ò:', error);
                    alert('Ïù¥ÎØ∏ÏßÄ Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                }
            };
            
            reader.onerror = function() {
                console.error('‚ùå Ïù¥ÎØ∏ÏßÄ ÏùΩÍ∏∞ Ïã§Ìå®');
                alert('Ïù¥ÎØ∏ÏßÄ ÏùΩÍ∏∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            };
            
            reader.readAsDataURL(file);
        }

        async function analyzeCharacterImage() {
            if (!uploadedImageBase64) {
                alert('Î®ºÏ†Ä Ïù¥ÎØ∏ÏßÄÎ•º ÏóÖÎ°úÎìúÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            const analyzeBtn = document.getElementById('analyzeImageBtn');
            const originalText = analyzeBtn.textContent;
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = 'ü§ñ Î∂ÑÏÑù Ï§ë...';
            
            try {
                console.log('üîç Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù ÏãúÏûë...');
                
                const response = await fetch('/api/character-ai-generator', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'analyze_character_image',
                        imageBase64: uploadedImageBase64
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        currentAnalysisResult = result.analysis;
                        displayAnalysisResult(result.analysis);
                        console.log('‚úÖ Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù ÏôÑÎ£å:', result.analysis);
                    } else {
                        throw new Error(result.message || 'Î∂ÑÏÑù Ïã§Ìå®');
                    }
                } else {
                    throw new Error('ÏÑúÎ≤Ñ Ïò§Î•ò: ' + response.status);
                }
                
            } catch (error) {
                console.error('‚ùå Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù Ïò§Î•ò:', error);
                alert('Ïù¥ÎØ∏ÏßÄ Î∂ÑÏÑù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = originalText;
            }
        }

        function displayAnalysisResult(analysis) {
            const container = document.getElementById('analysisContent');
            
            let html = '<div style="font-size: 14px; line-height: 1.6;">';
            
            if (analysis.appearance) {
                html += `<div style="margin-bottom: 10px;"><strong>üëÄ Ïô∏Î™®:</strong> ${analysis.appearance}</div>`;
            }
            
            if (analysis.personality_prediction) {
                html += `<div style="margin-bottom: 10px;"><strong>üòä ÏÑ±Í≤© ÏòàÏ∏°:</strong> ${analysis.personality_prediction}</div>`;
            }
            
            if (analysis.mbti_suggestion) {
                html += `<div style="margin-bottom: 10px;"><strong>üéØ MBTI Ï∂îÏ≤ú:</strong> ${analysis.mbti_suggestion}</div>`;
            }
            
            if (analysis.speech_style) {
                html += `<div style="margin-bottom: 10px;"><strong>üí¨ ÎßêÌà¨:</strong> ${analysis.speech_style}</div>`;
            }
            
            if (analysis.background_suggestion) {
                html += `<div style="margin-bottom: 10px;"><strong>üè† Î∞∞Í≤Ω:</strong> ${analysis.background_suggestion}</div>`;
            }
            
            if (analysis.note) {
                html += `<div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px; color: #856404;"><small>üìù ${analysis.note}</small></div>`;
            }
            
            if (analysis.raw_analysis) {
                html += `<div style="margin-top: 15px; padding: 10px; background: #e9ecef; border-radius: 5px;"><small>ü§ñ ÏõêÏãú Î∂ÑÏÑù:</small><br><pre style="white-space: pre-wrap; font-size: 12px;">${analysis.raw_analysis}</pre></div>`;
            }
            
            html += '</div>';
            
            container.innerHTML = html;
            document.getElementById('analysisResult').style.display = 'block';
        }

        function applyAnalysisToForm() {
            if (!currentAnalysisResult) {
                alert('Ï†ÅÏö©Ìï† Î∂ÑÏÑù Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            const analysis = currentAnalysisResult;
            console.log('üîß Î∂ÑÏÑù Í≤∞Í≥º Ï†ÅÏö© ÏãúÏûë:', analysis);
            
            // ÏïàÏ†ÑÌïú ÏöîÏÜå ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
            const safeSetValue = (elementId, value) => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.value = value;
                    console.log(`‚úÖ ${elementId} Í∞í Ï†ÅÏö©:`, value);
                } else {
                    console.warn(`‚ö†Ô∏è ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå: ${elementId}`);
                }
            };
            
            // MBTI Ï†ÅÏö©
            if (analysis.mbti_suggestion && analysis.mbti_suggestion.length === 4) {
                safeSetValue('charMbti', analysis.mbti_suggestion);
            }
            
            // ÎßêÌà¨ Ï†ÅÏö© (charSpeechStyleÏù¥ Ïã§Ï†úÎ°ú Ï°¥Ïû¨ÌïòÎäîÏßÄ ÌôïÏù∏)
            if (analysis.speech_style) {
                safeSetValue('charSpeechStyle', analysis.speech_style);
            }
            
            // ÏÑ§Î™Ö Ï†ÅÏö© (ÏïàÏ†ÑÌïú Î∞©Ïãù)
            if (analysis.appearance || analysis.background_suggestion) {
                let description = '';
                if (analysis.appearance) description += `Ïô∏Î™®: ${analysis.appearance}. `;
                if (analysis.background_suggestion) description += `Î∞∞Í≤Ω: ${analysis.background_suggestion}.`;
                safeSetValue('charDescription', description);
            }
            
            // Í∏∞ÌÉÄ ÌïÑÎìúÎì§ÎèÑ ÏïàÏ†ÑÌïòÍ≤å Ï†ÅÏö©
            if (analysis.name_suggestion) {
                safeSetValue('charName', analysis.name_suggestion);
            }
            
            if (analysis.age_suggestion) {
                safeSetValue('charAge', analysis.age_suggestion);
            }
            
            alert('üéâ Î∂ÑÏÑù Í≤∞Í≥ºÍ∞Ä ÌèºÏóê Ï†ÅÏö©ÎêòÏóàÏäµÎãàÎã§!');
        }

        // === ÎçîÎØ∏ Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú Í∏∞Îä• ===
        async function resetAllCharacters() {
            if (!confirm('‚ö†Ô∏è Ï£ºÏùò: Î™®Îì† Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏòÅÍµ¨Ï†ÅÏúºÎ°ú ÏÇ≠Ï†úÎê©ÎãàÎã§.\n\nÏ†ïÎßêÎ°ú Í≥ÑÏÜçÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                return;
            }
            
            if (!confirm('Ìïú Î≤à Îçî ÌôïÏù∏Ìï©ÎãàÎã§. Î™®Îì† Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏôÑÏ†ÑÌûà ÏÇ≠Ï†úÎê©ÎãàÎã§!')) {
                return;
            }
            
            try {
                console.log('üóëÔ∏è Î™®Îì† Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú ÏãúÏûë...');
                
                const response = await fetch('/api/character-ai-generator', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'reset_all_characters'
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert('‚úÖ Î™®Îì† Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                        
                        // Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
                        setTimeout(() => {
                            loadCharacters();
                        }, 500);
                    } else {
                        throw new Error(result.message || 'ÏÇ≠Ï†ú Ïã§Ìå®');
                    }
                } else {
                    throw new Error('ÏÑúÎ≤Ñ Ïò§Î•ò: ' + response.status);
                }
                
            } catch (error) {
                console.error('‚ùå Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú Ïò§Î•ò:', error);
                alert('Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
            }
        }

        function displayCharacters() {
            console.log('üé® === Ï∫êÎ¶≠ÌÑ∞ ÌëúÏãú Ìï®Ïàò ÏãúÏûë ===');
            const container = document.getElementById('charactersContainer');
            const characterArray = Object.values(characters);
            console.log('üìä ÌëúÏãúÌï† Ï∫êÎ¶≠ÌÑ∞ Ïàò:', characterArray.length);
            console.log('üìã Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù:', characterArray.map(c => `${c.name} (${c.id})`));
            
            container.innerHTML = characterArray.map(character => `
                <div class="character-card">
                    <div class="character-image">
                        ${character.image ? 
                            `<img src="${character.image}" alt="${character.name}" onerror="this.src='data:image/svg+xml,<svg xmlns=\\"http://www.w3.org/2000/svg\\" viewBox=\\"0 0 100 100\\"><rect width=\\"100\\" height=\\"100\\" fill=\\"%23f0f0f0\\"/><text x=\\"50\\" y=\\"50\\" text-anchor=\\"middle\\" dy=\\".3em\\" fill=\\"%23999\\">${character.name.charAt(0)}</text></svg>'"/>` :
                            `<div class="no-image">${character.name.charAt(0)}</div>`
                        }
                    </div>
                    <div class="character-info">
                        <div class="mbti">${character.mbti}</div>
                        <h3>${character.name}</h3>
                        <p class="traits">${character.personality_traits || character.personality || 'ÌäπÏÑ± Ï†ïÎ≥¥ ÏóÜÏùå'}</p>
                        <p style="font-size: 0.9em; color: #95a5a6; margin-bottom: 15px;">${character.speech_style || 'ÎßêÌà¨ Ï†ïÎ≥¥ ÏóÜÏùå'}</p>
                        <div class="actions">
                            <button class="btn btn-success" onclick="editCharacter('${character.id}')">ÏàòÏ†ï</button>
                            <button class="btn btn-danger" onclick="deleteCharacter('${character.id}')">ÏÇ≠Ï†ú</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateCharacterStats() {
            console.log('üìä Ï∫êÎ¶≠ÌÑ∞ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÏûë...');
            
            const characterArray = Object.values(characters);
            console.log('üìä Ï∫êÎ¶≠ÌÑ∞ Î∞∞Ïó¥:', characterArray.length, 'Í∞ú');
            
            // ÏïàÏ†ÑÌïú ÏöîÏÜå ÏóÖÎç∞Ïù¥Ìä∏ (ÏöîÏÜåÍ∞Ä ÏóÜÏúºÎ©¥ Î¨¥Ïãú)
            const safeUpdateElement = (id, value) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                    console.log(`‚úÖ ${id}: ${value}`);
                } else {
                    console.warn(`‚ö†Ô∏è ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå: ${id}`);
                }
            };
            
            // Ï∫êÎ¶≠ÌÑ∞ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
            safeUpdateElement('totalCharacters', characterArray.length);
            safeUpdateElement('activeCharacters', characterArray.filter(c => c.active !== false).length);
            safeUpdateElement('characterCount', characterArray.length);
            
            // AI ÏÉùÏÑ± Ï∫êÎ¶≠ÌÑ∞ Í∞úÏàò
            const aiGeneratedCharacters = characterArray.filter(c => c.source === 'ai_generator' || c.created_by === 'ai').length;
            safeUpdateElement('aiGeneratedCharacters', aiGeneratedCharacters);
            
            // ÌèâÍ∑† Ìò∏Í∞êÎèÑ (ÏòàÏãúÏö©)
            const avgAffection = characterArray.length > 0 
                ? Math.round(characterArray.reduce((sum, c) => sum + (c.initial_affection || 0), 0) / characterArray.length)
                : 0;
            safeUpdateElement('avgCharacterAffection', avgAffection);
            
            console.log('‚úÖ Ï∫êÎ¶≠ÌÑ∞ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£º');
        }

        function openCharacterModal(mode) {
            currentMode = mode;
            // Ï†úÎ™©ÏùÄ Ïù¥ÎØ∏ HTMLÏóêÏÑú ÏÑ§Ï†ïÎêòÏñ¥ ÏûàÏúºÎØÄÎ°ú Î≥ÄÍ≤ΩÌïòÏßÄ ÏïäÏùå
            document.getElementById('characterForm').reset();
            
            // Î™®Îì† ÏÑ†ÌÉù Î≤ÑÌäºÎì§ Ï¥àÍ∏∞Ìôî
            document.querySelectorAll('.mbti-btn.selected, .trait-btn.selected, .relationship-btn.selected, .hobby-btn.selected, .speech-btn.selected').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Ïà®Í≤®ÏßÑ ÌïÑÎìúÎì§ Ï¥àÍ∏∞Ìôî
            document.getElementById('charMbti').value = '';
            document.getElementById('charRelationship').value = '';
            document.getElementById('charSpeechStyle').value = '';
            
            // AI ÏÉùÏÑ± ÏòÅÏó≠ Ï¥àÍ∏∞Ìôî
            document.getElementById('aiGenerationStatus').innerHTML = '';
            document.getElementById('characterPreview').style.display = 'none';
            
            document.getElementById('characterModal').style.display = 'block';
        }

        function editCharacter(characterId) {
            const character = characters[characterId];
            if (!character) {
                console.error('Ï∫êÎ¶≠ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§:', characterId);
                return;
            }

            console.log('‚úèÔ∏è Ï∫êÎ¶≠ÌÑ∞ Ìé∏Ïßë ÏãúÏûë:', character.name);
            currentMode = 'edit';
            
            // ÏïàÏ†ÑÌïú ÏöîÏÜå ÏÑ§Ï†ï Ìï®Ïàò
            const safeSetValue = (elementId, value) => {
                const element = document.getElementById(elementId);
                if (element && value !== undefined && value !== null) {
                    element.value = value;
                    console.log(`‚úÖ ${elementId} Í∞í ÏÑ§Ï†ï:`, value);
                } else if (!element) {
                    console.warn(`‚ö†Ô∏è ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå: ${elementId}`);
                } else {
                    console.log(`‚ö†Ô∏è ${elementId}Ïóê ÏÑ§Ï†ïÌï† Í∞íÏù¥ ÏóÜÏùå`);
                }
            };

            // Î™®Îã¨ Ï†úÎ™© ÏÑ§Ï†ï
            safeSetValue('characterModalTitle', ''); // textContentÎ°ú Îî∞Î°ú ÏÑ§Ï†ï
            document.getElementById('characterModalTitle').textContent = 'Ï∫êÎ¶≠ÌÑ∞ ÏàòÏ†ï';
            
            // Í∏∞Î≥∏ ÌïÑÎìúÎì§ ÏÑ§Ï†ï
            safeSetValue('characterId', characterId);
            safeSetValue('charName', character.name);
            safeSetValue('charMbti', character.mbti);
            safeSetValue('charAge', character.age);
            safeSetValue('charType', character.character_type);
            safeSetValue('charMajor', character.major);
            safeSetValue('charFamily', character.family);
            safeSetValue('charHometown', character.hometown);
            safeSetValue('charRelationship', character.relationship);
            safeSetValue('charHair', character.appearance?.hair);
            safeSetValue('charEyes', character.appearance?.eyes);
            safeSetValue('charBody', character.appearance?.body);
            safeSetValue('charStyle', character.appearance?.style);
            safeSetValue('charValues', character.values);
            safeSetValue('charSpeechStyle', character.speech_style);
            safeSetValue('charSpeechHabit', character.speech_habit);
            safeSetValue('charGenre', character.genre);
            safeSetValue('charMainSituation', character.main_situation);

            // Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏûàÏúºÎ©¥ ÎØ∏Î¶¨Î≥¥Í∏∞ ÏÑ§Ï†ï
            if (character.image) {
                const previewImg = document.getElementById('previewImg');
                const imagePreview = document.getElementById('imagePreview');
                if (previewImg && imagePreview) {
                    previewImg.src = character.image;
                    imagePreview.style.display = 'block';
                }
            }

            // Î™®Îã¨ ÌëúÏãú
            document.getElementById('characterModal').style.display = 'block';
            console.log('‚úÖ Ï∫êÎ¶≠ÌÑ∞ Ìé∏Ïßë Î™®Îã¨ ÌëúÏãú ÏôÑÎ£å');
        }

        async function saveCharacter() {
            console.log('üíæ === Ï∫êÎ¶≠ÌÑ∞ Ï†ÄÏû• ÏãúÏûë ===');
            
            const name = document.getElementById('charName').value;
            const mbti = document.getElementById('charMbti').value;
            
            console.log('üìù ÏûÖÎ†•Í∞í ÌôïÏù∏:');
            console.log('  - Ïù¥Î¶Ñ:', name || '(ÎπÑÏñ¥ÏûàÏùå)');
            console.log('  - MBTI:', mbti || '(ÎπÑÏñ¥ÏûàÏùå)');
            
            if (!name || !mbti) {
                console.error('‚ùå ÌïÑÏàò ÏûÖÎ†•Í∞í ÎàÑÎùΩ');
                alert(`Ïù¥Î¶ÑÍ≥º MBTIÎäî ÌïÑÏàò ÏûÖÎ†• Ìï≠Î™©ÏûÖÎãàÎã§.\n\nÌòÑÏû¨ ÏûÖÎ†•Í∞í:\nÏù¥Î¶Ñ: ${name || 'ÎØ∏ÏûÖÎ†•'}\nMBTI: ${mbti || 'ÎØ∏ÏûÖÎ†•'}`);
                return;
            }

            // ÏÉàÎ°úÏö¥ AI Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ± ÏãúÏä§ÌÖúÏóêÏÑú Îç∞Ïù¥ÌÑ∞ ÏàòÏßë
            const characterData = collectCharacterData();
            
            const characterId = currentMode === 'create' 
                ? `${name.toLowerCase()}_${mbti.toLowerCase()}`
                : document.getElementById('characterId').value;

            characters[characterId] = {
                id: characterId,
                name: characterData.name,
                age: characterData.age,
                mbti: characterData.mbti,
                character_type: characterData.character_type,
                personality_traits: characterData.personality_traits,
                major: characterData.major,
                family: characterData.family,
                hometown: characterData.hometown,
                relationship: characterData.relationship,
                appearance: {
                    hair: characterData.hair,
                    eyes: characterData.eyes,
                    body: characterData.body,
                    style: characterData.style
                },
                hobbies: characterData.hobbies,
                values: characterData.values,
                speech_style: characterData.speech_style,
                speech_habit: characterData.speech_habit,
                genre: characterData.genre,
                main_situation: characterData.main_situation,
                created_at: new Date().toISOString(),
                active: true
            };

            // Ï†ÄÏû• Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî Î∞è ÏÉÅÌÉú ÌëúÏãú
            const saveButton = document.querySelector('#characterModal .btn-primary');
            const originalText = saveButton.textContent;
            saveButton.disabled = true;
            saveButton.textContent = 'üíæ Ï†ÄÏû• Ï§ë...';
            
            // APIÏóê Ï∫êÎ¶≠ÌÑ∞ Ï†ÄÏû•
            console.log('üíæ Ï†ÄÏû•Ìï† Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞:', characters[characterId]);
            
            // üöÄ Ï¶âÏãú UI ÏóÖÎç∞Ïù¥Ìä∏ (ÏÇ¨Ïö©Ïûê Í≤ΩÌóò Í∞úÏÑ†)
            console.log('‚ö° Ï¶âÏãú Î°úÏª¨ Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏...');
            
            // Î°úÏª¨ Ï∫êÎ¶≠ÌÑ∞ Í∞ùÏ≤¥Ïóê Ï¶âÏãú Ï∂îÍ∞Ä (UI Î∞òÏùëÏÑ± Í∞úÏÑ†)
            const globalCharacters = window.characters || {};
            globalCharacters[characterId] = characters[characterId];
            window.characters = globalCharacters;
            
            // Ï¶âÏãú ÌôîÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏
            displayCharacters();
            updateCharacterStats();
            console.log('‚úÖ Ï¶âÏãú UI ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
            
            // üíæ LocalStorage ÏßÅÏ†ë Ï†ÄÏû• (ÌôïÏã§Ìïú Î∞©Î≤ï!)
            console.log('üíæ LocalStorageÏóê ÏßÅÏ†ë Ï†ÄÏû• ÏãúÎèÑ...');
            try {
                // ÌòÑÏû¨ Ï†ÄÏû•Îêú Ï∫êÎ¶≠ÌÑ∞Îì§ÏùÑ Í∞ÄÏ†∏Ïò¥
                const existingChars = localStorage.getItem('characters');
                const charactersData = existingChars ? JSON.parse(existingChars) : {};
                
                // ÏÉà Ï∫êÎ¶≠ÌÑ∞ Ï∂îÍ∞Ä/ÏàòÏ†ï
                charactersData[characterId] = characters[characterId];
                
                // LocalStorageÏóê Ï†ÄÏû•
                localStorage.setItem('characters', JSON.stringify(charactersData));
                console.log('‚úÖ LocalStorage Ï†ÄÏû• ÏÑ±Í≥µ! Ï¥ù', Object.keys(charactersData).length, 'Í∞ú Ï∫êÎ¶≠ÌÑ∞');
                
                // Ï†ÄÏû• ÏÑ±Í≥µ Î©îÏãúÏßÄ
                const successMessage = currentMode === 'create' ? 
                    `üíñ ÏÉàÎ°úÏö¥ Ï∫êÎ¶≠ÌÑ∞ '${name}'Í∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!\n‚úÖ Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ùÏóêÏÑú ÌôïÏù∏ÌïòÏÑ∏Ïöî!` :
                    `‚ú®Ï∫êÎ¶≠ÌÑ∞ '${name}'Í∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§!`;
                
                alert(successMessage);
                closeModal('characterModal');
                
                // UI ÏµúÏ¢Ö ÏóÖÎç∞Ïù¥Ìä∏
                console.log('üîÑ Ï†ÄÏû• ÌõÑ ÏµúÏ¢Ö UI ÎèôÍ∏∞Ìôî...');
                await loadAllData(); // ÏÉàÎ°úÏö¥ ÌÜµÌï© Î°úÎî© Ìï®Ïàò ÏÇ¨Ïö©
                
                console.log('‚úÖ Ï∫êÎ¶≠ÌÑ∞ Ï†ÄÏû• ÌîÑÎ°úÏÑ∏Ïä§ ÏôÑÎ£å!');
                
            } catch (storageError) {
                console.error('‚ùå LocalStorage Ï†ÄÏû• Ïã§Ìå®:', storageError);
                alert('Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + storageError.message);
            }
            
            // Ï†ÄÏû• Î≤ÑÌäº Î≥µÏõê
            saveButton.disabled = false;
            saveButton.textContent = originalText;
        }

        // Î°úÏª¨ ÎåÄÌôî ÏÉùÏÑ± Ìï®Ïàò
        function generateLocalDialogue(characterId, characterName, userPrompt, difficulty) {
            console.log(`üé≠ ${characterName}Ïùò ${difficulty} ÎÇúÏù¥ÎèÑ ÎåÄÌôî ÏÉùÏÑ±:`, userPrompt);

            // MBTIÎ≥Ñ Ï∫êÎ¶≠ÌÑ∞ ÌäπÏÑ± Ï†ïÏùò
            const mbtiStyles = {
                'INFP': {
                    style: 'Î∂ÄÎìúÎüΩÍ≥† Í∞êÏÑ±Ï†ÅÏù∏',
                    endings: ['...', '~ üíï', 'Í∑∏Îü∞ Í≤É Í∞ôÏïÑÏöî'],
                    personality: 'ÎÇ¥ÏÑ±Ï†ÅÏù¥Í≥† Ïù¥ÏÉÅÏ£ºÏùòÏ†ÅÏù∏'
                },
                'ENFP': {
                    style: 'Î∞ùÍ≥† ÌôúÎ∞úÌïú',
                    endings: ['!', '!! ‚ú®', '~!!'],
                    personality: 'Ïô∏Ìñ•Ï†ÅÏù¥Í≥† Ïó¥Ï†ïÏ†ÅÏù∏'
                },
                'INTJ': {
                    style: 'ÎÖºÎ¶¨Ï†ÅÏù¥Í≥† Í∞ÑÍ≤∞Ìïú',
                    endings: ['.', 'ÎÑ§.', 'ÏûÖÎãàÎã§.'],
                    personality: 'ÎèÖÎ¶ΩÏ†ÅÏù¥Í≥† Í≥ÑÌöçÏ†ÅÏù∏'
                },
                'ESFJ': {
                    style: 'Îî∞ÎúªÌïòÍ≥† Î∞∞Î†§ÍπäÏùÄ',
                    endings: ['Ïöî~', 'ÎÑ§! üòä', 'Ìï†Í≤åÏöî'],
                    personality: 'ÏÇ¨ÍµêÏ†ÅÏù¥Í≥† ÌòëÏ°∞Ï†ÅÏù∏'
                },
                'ISTP': {
                    style: 'Í∞ÑÍ≤∞ÌïòÍ≥† Ïã§Ïö©Ï†ÅÏù∏',
                    endings: ['.', '...', 'Í∑∏Îü∞Îç∞'],
                    personality: 'ÌòÑÏã§Ï†ÅÏù¥Í≥† ÎèÖÎ¶ΩÏ†ÅÏù∏'
                }
            };

            // Ï∫êÎ¶≠ÌÑ∞ MBTI Ï∂îÏ∂ú (Ï∫êÎ¶≠ÌÑ∞ IDÏóêÏÑú)
            const mbti = characterId.split('_')[1]?.toUpperCase() || 'INFP';
            const characterStyle = mbtiStyles[mbti] || mbtiStyles['INFP'];

            // ÎÇúÏù¥ÎèÑÎ≥Ñ ÏÑ†ÌÉùÏßÄ Ìò∏Í∞êÎèÑ ÏòÅÌñ•
            const difficultySettings = {
                'Easy': { baseAffection: 0, choiceRange: [0, 1, 2] },
                'Medium': { baseAffection: 10, choiceRange: [-1, 1, 2] },
                'Hard': { baseAffection: 20, choiceRange: [-2, 0, 3] },
                'Expert': { baseAffection: 30, choiceRange: [-3, 1, 4] }
            };

            const settings = difficultySettings[difficulty] || difficultySettings['Easy'];
            const ending = characterStyle.endings[Math.floor(Math.random() * characterStyle.endings.length)];

            // Î°úÎß®Ìã±Ìïú ÏÉÅÌô©Î≥Ñ ÎåÄÌôî ÌÖúÌîåÎ¶ø
            const dialogueTemplates = [
                `${characterName}Ïù¥ ${userPrompt}ÌïòÎäî ÏÉÅÌô©ÏóêÏÑú Ï°∞Í∏à Î∂ÄÎÅÑÎü¨ÏõåÌïòÎ©∞ ÎßêÌïúÎã§${ending}`,
                `${characterStyle.personality} ${characterName}Ïù¥ ${userPrompt}Ïóê ÎåÄÌï¥ ÏÜîÏßÅÌïú ÎßàÏùåÏùÑ Ï†ÑÌïúÎã§${ending}`,
                `${characterName}Ïù¥ ${userPrompt}ÌïòÎ©¥ÏÑú Îî∞ÎúªÌïú ÎØ∏ÏÜåÎ•º ÏßÄÏúºÎ©∞ ÎåÄÎãµÌïúÎã§${ending}`,
                `${characterStyle.style} ${characterName}Ïù¥ ${userPrompt}Ïóê ÎåÄÌïú ÏßÑÏã¨ÏùÑ ÌëúÌòÑÌïúÎã§${ending}`
            ];

            const dialogue = dialogueTemplates[Math.floor(Math.random() * dialogueTemplates.length)];
            
            const narration = `${characterName}Ïùò ÌëúÏ†ïÏù¥ Î∂ÄÎìúÎü¨ÏõåÏßÄÎ©∞, ${characterStyle.personality.toLowerCase()} ÏÑ±Í≤©Ïù¥ ÎäêÍª¥ÏßÑÎã§. Îëê ÏÇ¨Îûå ÏÇ¨Ïù¥Ïùò Î∂ÑÏúÑÍ∏∞Í∞Ä ${difficulty === 'Easy' ? 'Ìé∏ÏïàÌïòÍ≤å' : difficulty === 'Expert' ? 'Í∏¥Ïû•Í∞ê ÏûàÍ≤å' : 'ÏûêÏó∞Ïä§ÎüΩÍ≤å'} ÌùòÎü¨Í∞ÑÎã§.`;

            return {
                dialogue: dialogue,
                narration: narration,
                choices: [
                    {
                        text: "Í≥µÍ∞êÌïòÎ©∞ Îî∞ÎúªÌïòÍ≤å Î∞òÏùëÌïúÎã§",
                        affection_impact: settings.choiceRange[2]
                    },
                    {
                        text: "ÏÉÅÌô©Ïóê ÎåÄÌï¥ Îçî ÏûêÏÑ∏Ìûà Î¨ºÏñ¥Î≥∏Îã§", 
                        affection_impact: settings.choiceRange[1]
                    },
                    {
                        text: "Ï°∞Ïã¨Ïä§ÎüΩÍ≤å Îã§Î•∏ Ï£ºÏ†úÎ°ú ÎÑòÏñ¥Í∞ÑÎã§",
                        affection_impact: settings.choiceRange[0]
                    }
                ],
                difficulty: difficulty,
                generated_at: new Date().toISOString(),
                source: 'local_generation'
            };
        }

        // üöÄ GitHub API ÌïµÏã¨ Ìï®ÏàòÎì§ (ÌòÅÏã†Ï†Å Ìï¥Í≤∞Ï±Ö!)
        
        // GitHub Repository ÏÑ§Ï†ï
        const GITHUB_CONFIG = {
            owner: 'EnmanyProject',  // GitHub ÏÇ¨Ïö©ÏûêÎ™Ö
            repo: 'chatgame',        // Repository Ïù¥Î¶Ñ  
            token: null,             // Personal Access Token (ÌôòÍ≤ΩÎ≥ÄÏàòÏóêÏÑú Î°úÎìú)
            branch: 'main'           // Î∏åÎûúÏπòÎ™Ö
        };
        
        // GitHub Personal Access Token Î°úÎìú
        async function loadGitHubToken() {
            try {
                // ÌôòÍ≤ΩÎ≥ÄÏàòÏóêÏÑú ÌÜ†ÌÅ∞ Î°úÎìú ÏãúÎèÑ
                const response = await fetch('/api/github-token');
                if (response.ok) {
                    const data = await response.json();
                    GITHUB_CONFIG.token = data.token;
                    console.log('‚úÖ GitHub ÌÜ†ÌÅ∞ Î°úÎìú ÏÑ±Í≥µ');
                    return true;
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è ÌôòÍ≤ΩÎ≥ÄÏàò ÌÜ†ÌÅ∞ Î°úÎìú Ïã§Ìå®:', error);
            }
            
            // Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú ÌÜ†ÌÅ∞ Î°úÎìú ÏãúÎèÑ
            const localToken = localStorage.getItem('github_token');
            if (localToken) {
                GITHUB_CONFIG.token = localToken;
                console.log('üíæ Î°úÏª¨ GitHub ÌÜ†ÌÅ∞ ÏÇ¨Ïö©');
                return true;
            }
            
            // ÌÜ†ÌÅ∞Ïù¥ ÏóÜÏúºÎ©¥ ÏÇ¨Ïö©ÏûêÏóêÍ≤å ÏöîÏ≤≠
            const userToken = prompt(`
üîê GitHub Personal Access TokenÏù¥ ÌïÑÏöîÌï©ÎãàÎã§!

1. GitHub.com ‚Üí Settings ‚Üí Developer settings ‚Üí Personal access tokens
2. Generate new token (classic)
3. Select scopes: 'repo' (Full control of private repositories)
4. Copy token and paste below:

GitHub Token:`);
            
            if (userToken && userToken.trim().length > 20) {
                GITHUB_CONFIG.token = userToken.trim();
                localStorage.setItem('github_token', GITHUB_CONFIG.token);
                console.log('üîê ÏÇ¨Ïö©Ïûê GitHub ÌÜ†ÌÅ∞ Ï†ÄÏû•Îê®');
                return true;
            }
            
            console.error('‚ùå GitHub ÌÜ†ÌÅ∞ ÏóÜÏùå - Î°úÏª¨ Ï†ÄÏû•ÏÜåÎ°ú Ìè¥Î∞±');
            return false;
        }
        
        // GitHub APIÎ°ú ÌååÏùº ÎÇ¥Ïö© Í∞ÄÏ†∏Ïò§Í∏∞
        async function getFileFromGitHub(filePath) {
            try {
                const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${filePath}`;
                console.log('üì• GitHubÏóêÏÑú ÌååÏùº Î°úÎìú:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const content = JSON.parse(atob(data.content));
                    console.log('‚úÖ GitHub ÌååÏùº Î°úÎìú ÏÑ±Í≥µ:', filePath);
                    return { success: true, content, sha: data.sha };
                } else if (response.status === 404) {
                    console.log('üì≠ GitHub ÌååÏùº ÏóÜÏùå, ÏÉà ÌååÏùº ÏÉùÏÑ±:', filePath);
                    return { success: true, content: { characters: {} }, sha: null };
                } else {
                    throw new Error(`GitHub API Error: ${response.status}`);
                }
            } catch (error) {
                console.error('‚ùå GitHub ÌååÏùº Î°úÎìú Ïã§Ìå®:', error);
                return { success: false, error: error.message };
            }
        }
        
        // GitHub APIÎ°ú ÌååÏùº ÏóÖÎç∞Ïù¥Ìä∏/ÏÉùÏÑ±
        async function commitToGitHub(filePath, content, commitMessage) {
            try {
                // ÌòÑÏû¨ ÌååÏùº SHA Í∞ÄÏ†∏Ïò§Í∏∞ (ÏóÖÎç∞Ïù¥Ìä∏Ïö©)
                const currentFile = await getFileFromGitHub(filePath);
                
                const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${filePath}`;
                console.log('üì§ GitHubÏóê Ïª§Î∞ã:', url);
                
                const body = {
                    message: commitMessage + ` ü§ñ Generated by ChatGame Admin`,
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2)))),
                    branch: GITHUB_CONFIG.branch
                };
                
                // ÌååÏùºÏù¥ Ï°¥Ïû¨ÌïòÎ©¥ SHA Ìè¨Ìï® (ÏóÖÎç∞Ïù¥Ìä∏)
                if (currentFile.sha) {
                    body.sha = currentFile.sha;
                }
                
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ GitHub Ïª§Î∞ã ÏÑ±Í≥µ! SHA:', data.commit.sha);
                    return { 
                        success: true, 
                        sha: data.commit.sha,
                        html_url: data.commit.html_url 
                    };
                } else {
                    const errorData = await response.json();
                    throw new Error(`GitHub Commit Error: ${response.status} - ${errorData.message}`);
                }
            } catch (error) {
                console.error('‚ùå GitHub Ïª§Î∞ã Ïã§Ìå®:', error);
                return { success: false, error: error.message };
            }
        }
        
        // GitHubÏóêÏÑú Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        async function loadCharactersFromGitHub() {
            try {
                console.log('üì• GitHubÏóêÏÑú Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú...');
                const result = await getFileFromGitHub('data/characters.json');
                
                if (result.success) {
                    // characters.json Ìè¨Îß∑ÏùÑ ID Í∏∞Î∞ò Í∞ùÏ≤¥Î°ú Î≥ÄÌôò
                    const charactersData = result.content;
                    if (charactersData.characters) {
                        if (Array.isArray(charactersData.characters)) {
                            // Array ÌòïÌÉúÎ•º Object ÌòïÌÉúÎ°ú Î≥ÄÌôò
                            const convertedCharacters = {};
                            charactersData.characters.forEach(char => {
                                convertedCharacters[char.id] = char;
                            });
                            return convertedCharacters;
                        } else {
                            return charactersData.characters;
                        }
                    }
                    return {};
                } else {
                    console.warn('‚ö†Ô∏è GitHub Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú Ïã§Ìå®:', result.error);
                    return {};
                }
            } catch (error) {
                console.error('‚ùå GitHub Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú ÏòàÏô∏:', error);
                return {};
            }
        }
        
        // üöÄ GitHub API Ï∫êÎ¶≠ÌÑ∞ Ï†ÄÏû• Ìï®Ïàò (ÌòÅÏã†Ï†Å!)
        async function saveCharacterToGitHub(character) {
            try {
                console.log('üêô GitHub APIÎ°ú Ï∫êÎ¶≠ÌÑ∞ Ï†ÄÏû• ÏãúÏûë:', character.name);
                
                // GitHub ÌÜ†ÌÅ∞ ÌôïÏù∏/Î°úÎìú
                if (!GITHUB_CONFIG.token) {
                    const tokenLoaded = await loadGitHubToken();
                    if (!tokenLoaded) {
                        throw new Error('GitHub token not available');
                    }
                }
                
                // Ï∫êÎ¶≠ÌÑ∞ ID ÏÉùÏÑ± (ÏóÜÏúºÎ©¥)
                if (!character.id) {
                    character.id = `${character.name.toLowerCase().replace(/\s/g, '_')}_${character.mbti.toLowerCase()}_${Date.now()}`;
                    console.log('üîß Ï∫êÎ¶≠ÌÑ∞ ID ÏÉùÏÑ±:', character.id);
                }
                
                // Í∏∞Ï°¥ Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù Î°úÎìú
                const existingCharacters = await loadCharactersFromGitHub();
                console.log('üìä Í∏∞Ï°¥ GitHub Ï∫êÎ¶≠ÌÑ∞ Ïàò:', Object.keys(existingCharacters).length);
                
                // ÏÉà Ï∫êÎ¶≠ÌÑ∞ Ï∂îÍ∞Ä
                existingCharacters[character.id] = {
                    ...character,
                    updated_at: new Date().toISOString(),
                    source: 'github_api',
                    commit_hash: 'pending'
                };
                
                // GitHubÏóê Ïª§Î∞ãÌï† Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞ ÏÉùÏÑ±
                const charactersArrayData = {
                    characters: Object.values(existingCharacters)
                };
                
                // GitHub RepositoryÏóê ÏßÅÏ†ë Ïª§Î∞ã
                const commitMessage = `Add new character: ${character.name} (${character.mbti})`;
                const commitResult = await commitToGitHub('data/characters.json', charactersArrayData, commitMessage);
                
                if (commitResult.success) {
                    // Ïª§Î∞ã Ìï¥Ïãú ÏóÖÎç∞Ïù¥Ìä∏
                    existingCharacters[character.id].commit_hash = commitResult.sha;
                    
                    // Î°úÏª¨ Î∞±ÏóÖÎèÑ Ï†ÄÏû•
                    localStorage.setItem('chatgame_characters', JSON.stringify(existingCharacters));
                    
                    console.log('‚úÖ GitHub API Ï†ÄÏû• ÏôÑÎ£å! Ïª§Î∞ã SHA:', commitResult.sha);
                    console.log('üìù GitHubÏóê Ï†ÄÏû•Îêú Ï∫êÎ¶≠ÌÑ∞ IDÎì§:', Object.keys(existingCharacters));
                    console.log('üîó Ïª§Î∞ã URL:', commitResult.html_url);
                    
                    return { success: true, commit_hash: commitResult.sha, url: commitResult.html_url };
                } else {
                    throw new Error('GitHub commit failed: ' + commitResult.error);
                }
                
            } catch (error) {
                console.error('‚ùå GitHub API Ï†ÄÏû• Ïò§Î•ò:', error);
                
                // Ïã§Ìå® Ïãú Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÎ°ú Ìè¥Î∞±
                console.log('üíæ Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÎ°ú Ìè¥Î∞±...');
                return saveCharacterToLocalStorage(character);
            }
        }
        
        // Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ Ìè¥Î∞± Ìï®Ïàò
        function saveCharacterToLocalStorage(character) {
            try {
                console.log('üíæ Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóê Ï∫êÎ¶≠ÌÑ∞ Ï†ÄÏû• ÏãúÏûë:', character.name);
                
                // Ï∫êÎ¶≠ÌÑ∞ ID ÏÉùÏÑ± (ÏóÜÏúºÎ©¥)
                if (!character.id) {
                    character.id = `${character.name.toLowerCase()}_${character.mbti.toLowerCase()}_${Date.now()}`;
                    console.log('üîß Ï∫êÎ¶≠ÌÑ∞ ID ÏÉùÏÑ±:', character.id);
                }
                
                // Í∏∞Ï°¥ Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù Î°úÎìú
                const existingCharacters = JSON.parse(localStorage.getItem('chatgame_characters') || '{}');
                console.log('üìä Í∏∞Ï°¥ Ï∫êÎ¶≠ÌÑ∞ Ïàò:', Object.keys(existingCharacters).length);
                
                // ÏÉà Ï∫êÎ¶≠ÌÑ∞ Ï∂îÍ∞Ä
                existingCharacters[character.id] = {
                    ...character,
                    updated_at: new Date().toISOString(),
                    source: 'local_storage'
                };
                
                // Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóê Ï†ÄÏû•
                localStorage.setItem('chatgame_characters', JSON.stringify(existingCharacters));
                
                console.log('‚úÖ Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ Ï†ÄÏû• ÏôÑÎ£å. Ï¥ù Ï∫êÎ¶≠ÌÑ∞ Ïàò:', Object.keys(existingCharacters).length);
                console.log('üìù Ï†ÄÏû•Îêú Ï∫êÎ¶≠ÌÑ∞ IDÎì§:', Object.keys(existingCharacters));
                
                return true;
            } catch (error) {
                console.error('‚ùå Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ Ï†ÄÏû• Ïò§Î•ò:', error);
                return false;
            }
        }
        
        // API Î∞±ÏóÖ Ï†ÄÏû• Ìï®Ïàò (Ïã§Ìå®Ìï¥ÎèÑ Î¨¥Ïãú)
        async function saveCharacterToAPI(character) {
            try {
                console.log('üåê APIÎ°ú Ï∫êÎ¶≠ÌÑ∞ Î∞±ÏóÖ ÏãúÏûë:', character.name);
                
                const response = await fetch('/api/character-ai-generator', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'save_character',
                        character: character
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Ï∫êÎ¶≠ÌÑ∞ Ï†ÄÏû• ÏÑ±Í≥µ:', result);
                    return result.success;
                } else {
                    console.error('‚ùå API Ï†ÄÏû• Ïã§Ìå®:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Ï∫êÎ¶≠ÌÑ∞ Ï†ÄÏû• Ïò§Î•ò:', error);
                return false;
            }
        }

        // ÏÉàÎ°úÏö¥ Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ ÏàòÏßë Ìï®Ïàò
        function collectCharacterData() {
            return {
                name: document.getElementById('charName').value || 'ÎØ∏ÏßÄÏùò ÏÜåÎÖÄ',
                age: document.getElementById('charAge').value || '20',
                mbti: document.getElementById('charMbti').value,
                character_type: document.getElementById('charType').value || 'romance_junior',
                personality_traits: getSelectedTraits(),
                major: document.getElementById('charMajor').value || 'art',
                family: document.getElementById('charFamily').value || 'only_child',
                hometown: document.getElementById('charHometown').value || 'seoul',
                relationship: document.getElementById('charRelationship').value,
                image: uploadedImageBase64 ? `data:image/jpeg;base64,${uploadedImageBase64}` : null,
                hair: document.getElementById('charHair').value || 'long_straight',
                eyes: document.getElementById('charEyes').value || 'round_cute',
                body: document.getElementById('charBody').value || 'petite',
                style: document.getElementById('charStyle').value || 'cute_casual',
                hobbies: getSelectedHobbies(),
                values: document.getElementById('charValues').value || 'love_family',
                speech_style: document.getElementById('charSpeechStyle').value,
                speech_habit: document.getElementById('charSpeechHabit').value || '',
                genre: document.getElementById('charGenre').value || 'school_romance',
                main_situation: document.getElementById('charMainSituation').value || 'confession_aftermath'
            };
        }

        // ÏÑ†ÌÉùÎêú ÏÑ±Í≤© ÌäπÏÑ±Îì§ Í∞ÄÏ†∏Ïò§Í∏∞
        function getSelectedTraits() {
            const selectedTraits = [];
            document.querySelectorAll('.trait-btn.selected').forEach(btn => {
                selectedTraits.push(btn.dataset.trait);
            });
            return selectedTraits.slice(0, 3); // ÏµúÎåÄ 3Í∞úÎßå
        }

        // ÏÑ†ÌÉùÎêú Ï∑®ÎØ∏Îì§ Í∞ÄÏ†∏Ïò§Í∏∞
        function getSelectedHobbies() {
            const selectedHobbies = [];
            document.querySelectorAll('.hobby-btn.selected').forEach(btn => {
                selectedHobbies.push(btn.dataset.hobby);
            });
            return selectedHobbies.slice(0, 3); // ÏµúÎåÄ 3Í∞úÎßå
        }

        // === AI Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±Í∏∞ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï¥àÍ∏∞Ìôî ===
        function initializeCharacterGeneratorEvents() {
            // MBTI Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('mbti-btn')) {
                    document.querySelectorAll('.mbti-btn').forEach(btn => btn.classList.remove('selected'));
                    e.target.classList.add('selected');
                    const selectedMbti = e.target.dataset.mbti;
                    document.getElementById('charMbti').value = selectedMbti;
                    console.log('‚úÖ MBTI ÏÑ†ÌÉùÎê®:', selectedMbti);
                }

                // ÏÑ±Í≤© ÌäπÏÑ± Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ (ÏµúÎåÄ 3Í∞ú ÏÑ†ÌÉù)
                if (e.target.classList.contains('trait-btn')) {
                    const selectedTraits = document.querySelectorAll('.trait-btn.selected').length;
                    
                    if (e.target.classList.contains('selected')) {
                        e.target.classList.remove('selected');
                    } else if (selectedTraits < 3) {
                        e.target.classList.add('selected');
                    } else {
                        alert('ÏÑ±Í≤© ÌäπÏÑ±ÏùÄ ÏµúÎåÄ 3Í∞úÍπåÏßÄÎßå ÏÑ†ÌÉù Í∞ÄÎä•Ìï©ÎãàÎã§.');
                    }
                }

                // Í¥ÄÍ≥Ñ ÏÑ§Ï†ï Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
                if (e.target.classList.contains('relationship-btn')) {
                    document.querySelectorAll('.relationship-btn').forEach(btn => btn.classList.remove('selected'));
                    e.target.classList.add('selected');
                    document.getElementById('charRelationship').value = e.target.dataset.rel;
                }

                // Ï∑®ÎØ∏ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ (ÏµúÎåÄ 3Í∞ú ÏÑ†ÌÉù)
                if (e.target.classList.contains('hobby-btn')) {
                    const selectedHobbies = document.querySelectorAll('.hobby-btn.selected').length;
                    
                    if (e.target.classList.contains('selected')) {
                        e.target.classList.remove('selected');
                    } else if (selectedHobbies < 3) {
                        e.target.classList.add('selected');
                    } else {
                        alert('Ï∑®ÎØ∏Îäî ÏµúÎåÄ 3Í∞úÍπåÏßÄÎßå ÏÑ†ÌÉù Í∞ÄÎä•Ìï©ÎãàÎã§.');
                    }
                }

                // ÎßêÌà¨ Ïä§ÌÉÄÏùº Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
                if (e.target.classList.contains('speech-btn')) {
                    document.querySelectorAll('.speech-btn').forEach(btn => btn.classList.remove('selected'));
                    e.target.classList.add('selected');
                    document.getElementById('charSpeechStyle').value = e.target.dataset.speech;
                }
            });
        }

        // === AI Ï∫êÎ¶≠ÌÑ∞ ÏûêÎèô ÏÉùÏÑ± Ìï®Ïàò ===
        async function generateAICharacter() {
            const statusDiv = document.getElementById('aiGenerationStatus');
            const previewDiv = document.getElementById('characterPreview');
            
            statusDiv.innerHTML = 'ü§ñ AIÍ∞Ä Ï∫êÎ¶≠ÌÑ∞Î•º ÏÉùÏÑ±ÌïòÍ≥† ÏûàÏäµÎãàÎã§...';
            
            try {
                // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Îç∞Ïù¥ÌÑ∞ ÏàòÏßë
                const currentData = collectCharacterData();
                
                // AI API Ìò∏Ï∂ú (character-ai-generator.js ÏÇ¨Ïö©)
                const response = await fetch('/api/character-ai-generator', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'generate_character',
                        answers: currentData
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        statusDiv.innerHTML = '‚ú® AI ÏÉùÏÑ± ÏôÑÎ£å!';
                        displayAIGeneratedCharacter(result.character);
                        previewDiv.style.display = 'block';
                    } else {
                        throw new Error(result.message || 'AI ÏÉùÏÑ± Ïã§Ìå®');
                    }
                } else {
                    throw new Error(`API Ïò§Î•ò: ${response.status}`);
                }
            } catch (error) {
                console.error('AI Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ± Ïò§Î•ò:', error);
                statusDiv.innerHTML = '‚ö†Ô∏è AI ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. ÏàòÎèôÏúºÎ°ú ÏôÑÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.';
                
                // Fallback: Í∏∞Î≥∏ Ïó¨ÏÑ± Ï∫êÎ¶≠ÌÑ∞ ÌÖúÌîåÎ¶ø Ï†úÍ≥µ
                generateFallbackFemaleCharacter();
            }
        }

        // AI ÏÉùÏÑ± Í≤∞Í≥º ÌëúÏãú
        function displayAIGeneratedCharacter(character) {
            const previewDiv = document.getElementById('characterPreview');
            previewDiv.innerHTML = `
                <h4>üé≠ AI ÏÉùÏÑ± Í≤∞Í≥º ÎØ∏Î¶¨Î≥¥Í∏∞</h4>
                <div class="character-preview-content">
                    <p><strong>Ïù¥Î¶Ñ:</strong> ${character.name}</p>
                    <p><strong>ÎÇòÏù¥:</strong> ${character.age}ÏÑ∏</p>
                    <p><strong>MBTI:</strong> ${character.mbti}</p>
                    <p><strong>ÏÑ±Í≤©:</strong> ${character.personality_traits ? character.personality_traits.join(', ') : 'Í∞êÏÑ±Ï†Å, ÎÇ¥Ìñ•Ï†Å, Ïù¥ÏÉÅÏ£ºÏùòÏ†Å'}</p>
                    <p><strong>Ïô∏Î™®:</strong> ${character.appearance ? 
                        `${character.appearance.hair}, ${character.appearance.eyes}, ${character.appearance.style}` : 
                        'Í∏¥ ÏÉùÎ®∏Î¶¨, ÎèôÍ∑∏ÎûóÍ≥† Í∑ÄÏó¨Ïö¥ Îàà, ÌÅêÌä∏ Ï∫êÏ£ºÏñº'}</p>
                    <p><strong>Í¥ÄÍ≥Ñ:</strong> ${translateRelationship(character.relationship || 'secret_crush')}</p>
                    <p><strong>ÎßêÌà¨:</strong> ${translateSpeechStyle(character.speech_style || 'soft_warm')}</p>
                    <button class="btn btn-primary" onclick="applyAIGeneratedData(${JSON.stringify(JSON.stringify(character))})">
                        üíñ Ïù¥ Ï∫êÎ¶≠ÌÑ∞ Ï†ÅÏö©ÌïòÍ∏∞
                    </button>
                </div>
            `;
        }

        // AI ÏÉùÏÑ± Îç∞Ïù¥ÌÑ∞Î•º ÌèºÏóê Ï†ÅÏö©
        function applyAIGeneratedData(characterData) {
            try {
                const character = JSON.parse(characterData);
                
                // Í∏∞Î≥∏ Ï†ïÎ≥¥ Ï†ÅÏö©
                if (character.name) document.getElementById('charName').value = character.name;
                if (character.age) document.getElementById('charAge').value = character.age;
                if (character.mbti) {
                    document.getElementById('charMbti').value = character.mbti;
                    // MBTI Î≤ÑÌäºÎèÑ ÏãúÍ∞ÅÏ†ÅÏúºÎ°ú ÏÑ†ÌÉù
                    document.querySelectorAll('.mbti-btn').forEach(btn => {
                        btn.classList.toggle('selected', btn.dataset.mbti === character.mbti);
                    });
                }
                
                // Ïô∏Î™® Ï†ïÎ≥¥ Ï†ÅÏö©
                if (character.appearance) {
                    if (character.appearance.hair) document.getElementById('charHair').value = character.appearance.hair;
                    if (character.appearance.eyes) document.getElementById('charEyes').value = character.appearance.eyes;
                    if (character.appearance.style) document.getElementById('charStyle').value = character.appearance.style;
                }
                
                alert('üíñ AI ÏÉùÏÑ± Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÌèºÏóê Ï†ÅÏö©ÎêòÏóàÏäµÎãàÎã§! Ï†ÄÏû• Î≤ÑÌäºÏùÑ ÎàåÎü¨Ï£ºÏÑ∏Ïöî.');
                
            } catch (error) {
                console.error('AI Îç∞Ïù¥ÌÑ∞ Ï†ÅÏö© Ïò§Î•ò:', error);
                alert('Îç∞Ïù¥ÌÑ∞ Ï†ÅÏö© Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        // Fallback Ïó¨ÏÑ± Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±
        function generateFallbackFemaleCharacter() {
            const femaleTemplates = [
                {
                    name: 'Ïú§ÏÑú', age: '20', mbti: 'INFP', 
                    traits: ['Í∞êÏÑ±Ï†Å', 'ÎÇ¥Ìñ•Ï†Å', 'Ïù¥ÏÉÅÏ£ºÏùòÏ†Å'],
                    major: 'art', relationship: 'secret_crush',
                    hair: 'long_straight', eyes: 'round_cute', style: 'cute_casual',
                    speech_style: 'soft_warm', genre: 'school_romance'
                },
                {
                    name: 'ÌïòÏùÄ', age: '21', mbti: 'ENFP',
                    traits: ['ÌôúÎ∞úÌïú', 'Ïó¥Ï†ïÏ†Å', 'Ï∞ΩÏùòÏ†Å'], 
                    major: 'music', relationship: 'childhood_friend',
                    hair: 'shoulder_wave', eyes: 'almond_elegant', style: 'feminine_lovely',
                    speech_style: 'bright_cheerful', genre: 'daily_romance'
                },
                {
                    name: 'ÏÜåÌù¨', age: '19', mbti: 'ISFJ',
                    traits: ['Ï∞®Î∂ÑÌïú', 'Î∞∞Î†§Ïã¨ ÎßéÏùÄ', 'ÎÇ¥Ìñ•Ï†Å'],
                    major: 'education', relationship: 'senior_friend', 
                    hair: 'short_bob', eyes: 'double_eyelid', style: 'natural_simple',
                    speech_style: 'gentle_caring', genre: 'healing_romance'
                }
            ];
            
            const template = femaleTemplates[Math.floor(Math.random() * femaleTemplates.length)];
            displayAIGeneratedCharacter(template);
            document.getElementById('characterPreview').style.display = 'block';
            document.getElementById('aiGenerationStatus').innerHTML = 'üå∏ Ïó¨ÏÑ± Ï∫êÎ¶≠ÌÑ∞ ÌÖúÌîåÎ¶øÏù¥ Ï†úÍ≥µÎêòÏóàÏäµÎãàÎã§.';
        }

        // Í¥ÄÍ≥Ñ Î≤àÏó≠ Ìï®Ïàò
        function translateRelationship(rel) {
            const translations = {
                'secret_crush': 'Î™∞Îûò Ï¢ãÏïÑÌïòÎäî ÌõÑÎ∞∞',
                'childhood_friend': 'Ïñ¥Î¶¥ ÎïåÎ∂ÄÌÑ∞ ÏπúÌïú ÏπúÍµ¨', 
                'senior_friend': 'Îã§Ï†ïÌïú ÏÑ†Î∞∞',
                'classmate': 'Í∞ôÏùÄ Í≥º ÎèôÍ∏∞',
                'club_mate': 'ÎèôÏïÑÎ¶¨ ÏÑ†ÌõÑÎ∞∞',
                'neighbor': 'ÏòÜÏßë Ïù¥ÏõÉ'
            };
            return translations[rel] || rel;
        }

        // ÎßêÌà¨ Î≤àÏó≠ Ìï®Ïàò
        function translateSpeechStyle(style) {
            const translations = {
                'soft_warm': 'Î∂ÄÎìúÎüΩÍ≥† Îî∞ÎúªÌïú',
                'bright_cheerful': 'Î∞ùÍ≥† Í≤ΩÏæåÌïú',
                'gentle_caring': 'Îã§Ï†ïÌïòÍ≥† Î∞∞Î†§ÍπäÏùÄ',
                'shy_cute': 'ÏàòÏ§çÍ≥† Í∑ÄÏó¨Ïö¥',
                'mature_elegant': 'ÏÑ±ÏàôÌïòÍ≥† Ïö∞ÏïÑÌïú',
                'playful_fun': 'Ïû•ÎÇúÏä§ÎüΩÍ≥† Ïû¨ÎØ∏ÏûàÎäî'
            };
            return translations[style] || style;
        }

        async function deleteCharacter(characterId) {
            if (!confirm('Ï†ïÎßêÎ°ú Ïù¥ Ï∫êÎ¶≠ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                return;
            }

            try {
                console.log('üóëÔ∏è Ï∫êÎ¶≠ÌÑ∞ ÏÇ≠Ï†ú ÏãúÏûë (LocalStorage):', characterId);
                
                // LocalStorageÏóêÏÑú Ï∫êÎ¶≠ÌÑ∞ ÏÇ≠Ï†ú
                const existingChars = localStorage.getItem('characters');
                const charactersData = existingChars ? JSON.parse(existingChars) : {};
                
                if (charactersData[characterId]) {
                    // Ï∫êÎ¶≠ÌÑ∞ ÏÇ≠Ï†ú
                    delete charactersData[characterId];
                    
                    // LocalStorageÏóê Ï†ÄÏû•
                    localStorage.setItem('characters', JSON.stringify(charactersData));
                    
                    // Ï†ÑÏó≠ Î≥ÄÏàòÏóêÏÑúÎèÑ ÏÇ≠Ï†ú
                    if (characters[characterId]) {
                        delete characters[characterId];
                    }
                    if (window.characters && window.characters[characterId]) {
                        delete window.characters[characterId];
                    }
                    
                    console.log('‚úÖ LocalStorageÏóêÏÑú Ï∫êÎ¶≠ÌÑ∞ ÏÇ≠Ï†ú ÏôÑÎ£å');
                    alert('‚úÖ Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                    
                    // UI Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏
                    displayCharacters();
                    updateCharacterStats();
                    
                } else {
                    alert('‚ùå ÏÇ≠Ï†úÌï† Ï∫êÎ¶≠ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                }
                
            } catch (error) {
                console.error('‚ùå Ï∫êÎ¶≠ÌÑ∞ ÏÇ≠Ï†ú Ïò§Î•ò:', error);
                alert('‚ùå Ï∫êÎ¶≠ÌÑ∞ ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
            }
        }

        // === Í≥µÌÜµ Ìï®ÏàòÎì§ ===
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'scenarioModal') {
                document.getElementById('scenarioForm').reset();
                selectedCharacters.clear();
                document.querySelectorAll('.character-option').forEach(opt => opt.classList.remove('selected'));
            } else if (modalId === 'episodeModal') {
                document.getElementById('episodeForm').reset();
                document.getElementById('dialoguePreview').style.display = 'none';
                generatedDialogue = null;
            } else if (modalId === 'characterModal') {
                document.getElementById('characterForm').reset();
            }
        }

        function updateAllStats() {
            updateScenarioStats();
            updateCharacterStats();
        }

        // üîß Ï†ÑÏó≠ Ìï®Ïàò Î∞îÏù∏Îî© (onclick Ïù¥Î≤§Ìä∏ Ï†ëÍ∑ºÏÑ± Î≥¥Ïû•)
        window.switchTab = switchTab;
        window.openCharacterModal = openCharacterModal;
        window.loadCharacters = loadCharacters;
        window.loadScenarios = loadScenarios;
        window.openScenarioModal = openScenarioModal;
        window.saveCharacter = saveCharacter;
        window.saveScenario = saveScenario;
        window.editCharacter = editCharacter;
        window.editScenario = editScenario;
        window.deleteCharacter = deleteCharacter;
        window.deleteScenario = deleteScenario;
        window.onScenarioChange = onScenarioChange;
        
        // Ï§ëÎ≥µ Ï¥àÍ∏∞Ìôî Ï†úÍ±∞Îê® - loadAllData()ÏóêÏÑú ÌÜµÌï© Ï≤òÎ¶¨
    </script>
</body>
</html>