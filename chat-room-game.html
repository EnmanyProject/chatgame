<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí¨ ÏãúÎÇòÎ¶¨Ïò§ Ï±ÑÌåÖ Í≤åÏûÑ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            height: 100vh;
            overflow: hidden;
            color: #ffffff;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Ï±ÑÌåÖÎ∞© Î™©Î°ù */
        .chat-list {
            width: 350px;
            background: #2c2c2c;
            border-right: 1px solid #444444;
            display: flex;
            flex-direction: column;
        }

        .chat-list-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
        }

        .chat-list-header h2 {
            margin-bottom: 5px;
        }

        .chat-rooms {
            flex: 1;
            overflow-y: auto;
        }

        .chat-room-item {
            padding: 15px 20px;
            border-bottom: 1px solid #404040;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .chat-room-item:hover {
            background: #3c3c3c;
        }

        .chat-room-item.active {
            background: #4a4a4a;
            border-left: 3px solid #667eea;
        }

        .room-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .room-info {
            flex: 1;
        }

        .room-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 5px;
            color: #ffffff;
        }

        .room-preview {
            font-size: 13px;
            color: #b0b0b0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .character-badge {
            background: #667eea;
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: bold;
        }

        /* Ï±ÑÌåÖ ÏòÅÏó≠ */
        .chat-area {
            flex: 1;
            display: none;
            flex-direction: column;
            background: #1e1e1e;
        }

        .chat-area.active {
            display: flex;
        }

        .chat-header {
            background: #2c2c2c;
            padding: 15px 20px;
            border-bottom: 1px solid #444444;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db, #e74c3c);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .chat-info h3 {
            font-size: 16px;
            color: #ffffff;
        }

        .chat-status {
            font-size: 12px;
            color: #b0b0b0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .affection-mini {
            background: #4a4a4a;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            color: #ffffff;
        }

        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #1e1e1e;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-end;
            max-width: 100%;
        }

        .message.sent {
            justify-content: flex-end;
        }

        .message.received {
            justify-content: flex-start;
        }

        .message-content {
            max-width: 70%;
            position: relative;
        }

        .message-bubble {
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
            word-wrap: break-word;
            position: relative;
        }

        .message.sent .message-bubble {
            background: #667eea;
            color: #ffffff;
            border-bottom-right-radius: 5px;
            margin-left: auto;
        }

        .message.received .message-bubble {
            background: #3c3c3c;
            color: #ffffff;
            border-bottom-left-radius: 5px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .message-time {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
            text-align: right;
        }

        .message.received .message-time {
            text-align: left;
        }

        .narration {
            background: rgba(102, 126, 234, 0.15);
            border-left: 3px solid #667eea;
            padding: 10px 15px;
            margin: 15px 0;
            border-radius: 5px;
            font-style: italic;
            color: #e0e0e0;
            text-align: center;
        }

        .choices-container {
            margin: 15px 0;
            display: grid;
            gap: 8px;
        }

        .choice-btn {
            background: #2c2c2c;
            border: 2px solid #667eea;
            color: #667eea;
            padding: 12px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            text-align: center;
        }

        .choice-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102,126,234,0.4);
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #3c3c3c;
            padding: 12px 16px;
            border-radius: 18px;
            border-bottom-left-radius: 5px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
            margin-bottom: 15px;
            max-width: fit-content;
        }

        .typing-dots {
            display: flex;
            gap: 3px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: #b0b0b0;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .input-container {
            background: #2c2c2c;
            padding: 15px 20px;
            border-top: 1px solid #444444;
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #1a1a1a;
            border-radius: 25px;
            padding: 8px 15px;
        }

        .message-input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 8px 0;
            font-size: 14px;
            outline: none;
            color: #ffffff;
        }

        .message-input::placeholder {
            color: #888888;
        }

        .input-group.subjective-mode {
            background: #2a2a4a;
            border: 2px solid #667eea;
        }

        .send-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .send-btn:hover {
            background: #5a6fd8;
            transform: scale(1.1);
        }

        .send-btn:disabled {
            background: #bbb;
            cursor: not-allowed;
            transform: none;
        }

        .welcome-screen {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #1e1e1e;
            flex-direction: column;
            color: #b0b0b0;
        }

        .welcome-screen h2 {
            margin-bottom: 10px;
            color: #ffffff;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #888888;
        }

        .game-stats {
            background: rgba(255,255,255,0.9);
            padding: 10px 15px;
            border-radius: 20px;
            margin: 10px 0;
            text-align: center;
            font-size: 12px;
            color: #2c3e50;
        }

        .affection-progress {
            background: #ecf0f1;
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            margin: 5px 0;
        }

        .affection-fill {
            background: linear-gradient(to right, #e74c3c, #e67e22, #f39c12);
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 3px;
        }

        @media (max-width: 768px) {
            .chat-list {
                width: 100%;
                position: absolute;
                z-index: 1000;
                height: 100vh;
            }

            .chat-list.hidden {
                display: none;
            }

            .chat-area {
                width: 100%;
            }

            .back-btn {
                background: none;
                border: none;
                color: white;
                font-size: 20px;
                cursor: pointer;
                margin-right: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Ï±ÑÌåÖÎ∞© Î™©Î°ù -->
        <div id="chat-list" class="chat-list">
            <div class="chat-list-header">
                <h2>üí¨ ÏãúÎÇòÎ¶¨Ïò§ Ï±ÑÌåÖ</h2>
                <p>ÎåÄÌôîÌï† ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</p>
            </div>
            <div id="chat-rooms" class="chat-rooms">
                <div class="loading">ÏãúÎÇòÎ¶¨Ïò§Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
            </div>
        </div>

        <!-- ÌôòÏòÅ ÌôîÎ©¥ -->
        <div id="welcome-screen" class="welcome-screen">
            <h2>üëã ÌôòÏòÅÌï©ÎãàÎã§!</h2>
            <p>ÏôºÏ™ΩÏóêÏÑú ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÑ†ÌÉùÌïòÏó¨ ÎåÄÌôîÎ•º ÏãúÏûëÌïòÏÑ∏Ïöî</p>
        </div>

        <!-- Ï±ÑÌåÖ ÏòÅÏó≠ -->
        <div id="chat-area" class="chat-area">
            <div class="chat-header">
                <button class="back-btn" onclick="showChatList()" style="display: none;">‚Üê</button>
                <div id="chat-avatar" class="chat-avatar"></div>
                <div class="chat-info">
                    <h3 id="chat-title"></h3>
                    <div class="chat-status">
                        <span id="character-info"></span>
                        <div class="affection-mini">
                            Ìò∏Í∞êÎèÑ: <span id="affection-display">75</span>/100
                        </div>
                    </div>
                </div>
            </div>

            <div id="messages-container" class="messages-container">
                <!-- Î©îÏãúÏßÄÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
            </div>

            <div class="input-container">
                <div id="input-group" class="input-group">
                    <input 
                        type="text" 
                        id="message-input" 
                        class="message-input" 
                        placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."
                        maxlength="150"
                        disabled
                    >
                    <button id="send-btn" class="send-btn" onclick="sendMessage()" disabled>
                        ‚û§
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentScenarios = [];
        let currentCharacters = [];
        let selectedScenario = null;
        let selectedCharacter = null;
        let gameState = {
            affection: 75,
            choiceCount: 0,
            messageCount: 0,
            waitingForSubjective: false,
            currentChoices: []
        };

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', function() {
            loadScenariosAndCharacters();
            setupEventListeners();
        });

        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
        function setupEventListeners() {
            const messageInput = document.getElementById('message-input');
            
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Î∞òÏùëÌòïÏùÑ ÏúÑÌïú ÌôîÎ©¥ ÌÅ¨Í∏∞ Ï≤¥ÌÅ¨
            window.addEventListener('resize', handleResize);
            handleResize();
        }

        // ÏãúÎÇòÎ¶¨Ïò§ÏôÄ Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú
        async function loadScenariosAndCharacters() {
            try {
                console.log('Loading scenarios and characters...');
                
                const [scenarioResponse, characterResponse] = await Promise.all([
                    fetch('/api/scenario?action=list&type=scenarios'),
                    fetch('/api/scenario?action=list&type=characters')
                ]);

                console.log('Response status:', scenarioResponse.status, characterResponse.status);

                if (!scenarioResponse.ok || !characterResponse.ok) {
                    throw new Error(`HTTP error! status: ${scenarioResponse.status}`);
                }

                const scenarioData = await scenarioResponse.json();
                const characterData = await characterResponse.json();

                console.log('Loaded data:', scenarioData, characterData);

                if (scenarioData.success && characterData.success) {
                    currentScenarios = (scenarioData.scenarios || []).filter(s => s.active !== false);
                    currentCharacters = (characterData.characters || []).filter(c => c.active !== false);
                    
                    console.log('Filtered scenarios:', currentScenarios.length);
                    console.log('Filtered characters:', currentCharacters.length);
                    
                    displayChatRooms();
                } else {
                    // Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
                    console.warn('No data found, creating defaults...');
                    await createDefaultData();
                }
            } catch (error) {
                console.error('Failed to load scenarios and characters:', error);
                document.getElementById('chat-rooms').innerHTML = 
                    `<p style="padding: 20px; text-align: center; color: red;">Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.<br><small>Ïò§Î•ò: ${error.message}</small></p>`;
            }
        }

        // Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
        async function createDefaultData() {
            try {
                // Í∏∞Î≥∏ ÏãúÎÇòÎ¶¨Ïò§ ÏÉùÏÑ±
                await fetch('/api/scenario', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'create',
                        type: 'scenario',
                        id: 'hangover_soup',
                        title: 'Ìï¥Ïû•Íµ≠ ÏãúÎÇòÎ¶¨Ïò§',
                        description: 'Ïú§ÏïÑÍ∞Ä Ìï¥Ïû•Íµ≠ÏùÑ ÎÅìÏó¨Ï£ºÎü¨ Ïò® ÏÉÅÌô©',
                        setting: 'Ïò§Îπ†Ïùò Ïßë, ÏàôÏ∑® ÏÉÅÌô©',
                        mood: 'ÏºÄÏñ¥ÎßÅ, Îã¨ÏΩ§Ìï®',
                        active: true
                    })
                });

                // Í∏∞Î≥∏ Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±
                await fetch('/api/scenario', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'create',
                        type: 'character',
                        id: 'yuna_infp',
                        name: 'Ïú§ÏïÑ',
                        age: 20,
                        mbti: 'INFP',
                        relationship: 'Ï∞ΩÏö© Ïò§Îπ†Î•º 1ÎÖÑ ÎÑòÍ≤å Ï¢ãÏïÑÌïòÎäî ÌõÑÎ∞∞',
                        background: 'ÏòàÏà†ÏùÑ Ï†ÑÍ≥µÌïòÎäî ÎåÄÌïôÏÉù, Í∞êÏàòÏÑ±Ïù¥ ÌíçÎ∂ÄÌï®',
                        active: true
                    })
                });

                // Ïû¨Î°úÎìú
                setTimeout(() => loadScenariosAndCharacters(), 1000);
            } catch (error) {
                console.error('Failed to create default data:', error);
            }
        }

        // Ï±ÑÌåÖÎ∞© Î™©Î°ù ÌëúÏãú
        function displayChatRooms() {
            const chatRooms = document.getElementById('chat-rooms');
            
            if (currentScenarios.length === 0) {
                chatRooms.innerHTML = '<p style="padding: 20px; text-align: center;">ÏÇ¨Ïö© Í∞ÄÎä•Ìïú ÏãúÎÇòÎ¶¨Ïò§Í∞Ä ÏóÜÏäµÎãàÎã§.</p>';
                return;
            }

            const roomsHTML = currentScenarios.map(scenario => {
                const availableCharacters = currentCharacters.filter(char => 
                    !char.scenarios.length || char.scenarios.includes(scenario.id)
                );

                return `
                    <div class="chat-room-item" onclick="selectChatRoom('${scenario.id}')">
                        <div class="room-avatar">
                            ${scenario.title.charAt(0)}
                        </div>
                        <div class="room-info">
                            <div class="room-title">${scenario.title}</div>
                            <div class="room-preview">
                                <span>${scenario.description}</span>
                                <span class="character-badge">${availableCharacters.length}Î™Ö</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            chatRooms.innerHTML = roomsHTML;
        }

        // Ï±ÑÌåÖÎ∞© ÏÑ†ÌÉù
        async function selectChatRoom(scenarioId) {
            selectedScenario = currentScenarios.find(s => s.id === scenarioId);
            
            // Ìï¥Îãπ ÏãúÎÇòÎ¶¨Ïò§Ïùò Ï≤´ Î≤àÏß∏ ÌôúÏÑ± Ï∫êÎ¶≠ÌÑ∞Î•º ÏûêÎèô ÏÑ†ÌÉù
            const availableCharacters = currentCharacters.filter(char => 
                !char.scenarios.length || char.scenarios.includes(scenarioId)
            );

            if (availableCharacters.length === 0) {
                alert('Ïù¥ ÏãúÎÇòÎ¶¨Ïò§Ïóê ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
                return;
            }

            selectedCharacter = availableCharacters[0]; // Ï≤´ Î≤àÏß∏ Ï∫êÎ¶≠ÌÑ∞ ÏûêÎèô ÏÑ†ÌÉù

            // ÏÑ†ÌÉùÎêú Î∞© ÌïòÏù¥ÎùºÏù¥Ìä∏
            document.querySelectorAll('.chat-room-item').forEach(item => item.classList.remove('active'));
            event.target.closest('.chat-room-item').classList.add('active');

            // Ï±ÑÌåÖ ÏòÅÏó≠ ÌëúÏãú
            showChatArea();
        }

        // Ï±ÑÌåÖ ÏòÅÏó≠ ÌëúÏãú
        function showChatArea() {
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('chat-area').classList.add('active');

            // Ìó§Îçî Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('chat-title').textContent = selectedScenario.title;
            document.getElementById('character-info').textContent = `${selectedCharacter.name} (${selectedCharacter.mbti})`;
            document.getElementById('chat-avatar').textContent = selectedCharacter.name.charAt(0);

            // ÏûÖÎ†• ÌôúÏÑ±Ìôî
            document.getElementById('message-input').disabled = false;
            document.getElementById('send-btn').disabled = false;

            // Í≤åÏûÑ ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
            gameState = {
                affection: 75,
                choiceCount: 0,
                messageCount: 0,
                waitingForSubjective: false,
                currentChoices: []
            };

            // Î©îÏãúÏßÄ Ïª®ÌÖåÏù¥ÎÑà Ï¥àÍ∏∞Ìôî
            document.getElementById('messages-container').innerHTML = '';

            // Ï¥àÍ∏∞ Î©îÏãúÏßÄ ÏãúÏûë
            startScenario();

            // Î™®Î∞îÏùºÏóêÏÑú Ï±ÑÌåÖÎ∞© Î™©Î°ù Ïà®Í∏∞Í∏∞
            if (window.innerWidth <= 768) {
                document.getElementById('chat-list').classList.add('hidden');
                document.querySelector('.back-btn').style.display = 'block';
            }
        }

        // ÏãúÎÇòÎ¶¨Ïò§ ÏãúÏûë
        async function startScenario() {
            showNarration(`üìñ ${selectedScenario.title} ÏãúÎÇòÎ¶¨Ïò§Í∞Ä ÏãúÏûëÎê©ÎãàÎã§.`);
            
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            showNarration(`üé≠ ${selectedScenario.setting || 'ÌäπÎ≥ÑÌïú Í≥µÍ∞Ñ'}ÏóêÏÑú ${selectedCharacter.name}ÏôÄÏùò Ïù¥ÏïºÍ∏∞Í∞Ä ÌéºÏ≥êÏßëÎãàÎã§.`);
            
            await new Promise(resolve => setTimeout(resolve, 2000));

            // Ï≤´ Î≤àÏß∏ ÏÑ†ÌÉùÏßÄ ÏÉùÏÑ±
            generateChoices("ÏãúÎÇòÎ¶¨Ïò§ ÏãúÏûë");
        }

        // ÏÑ†ÌÉùÏßÄ ÏÉùÏÑ±
        async function generateChoices(situation) {
            showTypingIndicator();

            try {
                const response = await fetch('/api/scenario', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'generate',
                        character_id: selectedCharacter.id,
                        scenario_id: selectedScenario.id,
                        situation: `${selectedScenario.setting}ÏóêÏÑú ${situation}. ÏÑ†ÌÉùÏßÄÏôÄ ÎåÄÏÇ¨Î•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.`,
                        gpt_config: getGPTConfig()
                    })
                });

                const data = await response.json();
                hideTypingIndicator();

                if (data.success) {
                    const generated = data.generated;
                    
                    // ÏßÄÎ¨∏ ÌëúÏãú (ÏûàÎäî Í≤ΩÏö∞)
                    if (generated.narration) {
                        showNarration(generated.narration);
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }

                    // Ï∫êÎ¶≠ÌÑ∞ ÎåÄÏÇ¨ ÌëúÏãú
                    displayCharacterMessage(generated.dialogue, getEmotionEmoji(generated.emotion));
                    
                    await new Promise(resolve => setTimeout(resolve, 1500));

                    // ÏÑ†ÌÉùÏßÄ ÌëúÏãú
                    if (generated.choices && generated.choices.length > 0) {
                        gameState.currentChoices = generated.choices;
                        displayChoices(generated.choices);
                    }
                } else {
                    displayCharacterMessage("Ïùå... Î≠îÍ∞Ä Î¨∏Ï†úÍ∞Ä ÏÉùÍ∏¥ Í≤É Í∞ôÏïÑÏöî üòÖ", "üòÖ");
                }
            } catch (error) {
                hideTypingIndicator();
                displayCharacterMessage("ÏÑúÎ≤Ñ Ïó∞Í≤∞Ïóê Î¨∏Ï†úÍ∞Ä ÏûàÏñ¥Ïöî „Ö†„Ö†", "üò∞");
                console.error('Generate choices error:', error);
            }
        }

        // ÏÑ†ÌÉùÏßÄ ÌëúÏãú
        function displayChoices(choices) {
            const container = document.getElementById('messages-container');
            const choicesDiv = document.createElement('div');
            choicesDiv.className = 'choices-container';
            
            choices.forEach((choice, index) => {
                const choiceBtn = document.createElement('div');
                choiceBtn.className = 'choice-btn';
                choiceBtn.textContent = choice.text;
                choiceBtn.onclick = () => selectChoice(index, choice);
                choicesDiv.appendChild(choiceBtn);
            });

            container.appendChild(choicesDiv);
            container.scrollTop = container.scrollHeight;
        }

        // ÏÑ†ÌÉùÏßÄ ÏÑ†ÌÉù
        async function selectChoice(index, choice) {
            // ÏÑ†ÌÉùÎêú ÎÇ¥Ïö©ÏùÑ ÏÇ¨Ïö©Ïûê Î©îÏãúÏßÄÎ°ú ÌëúÏãú
            displayUserMessage(choice.text);
            
            // ÏÑ†ÌÉùÏßÄ Ï†úÍ±∞
            const choicesContainer = document.querySelector('.choices-container');
            if (choicesContainer) {
                choicesContainer.remove();
            }

            // Ìò∏Í∞êÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
            updateAffection(choice.affection_impact);

            gameState.choiceCount++;

            // 3Î≤àÏùò ÏÑ†ÌÉù ÌõÑ Ï£ºÍ¥ÄÏãù Î™®ÎìúÎ°ú Ï†ÑÌôò
            if (gameState.choiceCount % 3 === 0) {
                await new Promise(resolve => setTimeout(resolve, 1000));
                startSubjectiveMode();
            } else {
                // Îã§Ïùå ÏÑ†ÌÉùÏßÄ ÏÉùÏÑ±
                await new Promise(resolve => setTimeout(resolve, 1500));
                generateChoices(`ÏÇ¨Ïö©ÏûêÍ∞Ä "${choice.text}"Î•º ÏÑ†ÌÉùÌñàÏäµÎãàÎã§`);
            }
        }

        // Ï£ºÍ¥ÄÏãù Î™®Îìú ÏãúÏûë
        function startSubjectiveMode() {
            gameState.waitingForSubjective = true;
            
            // ÏûÖÎ†•Ï∞Ω Ïä§ÌÉÄÏùº Î≥ÄÍ≤Ω
            const inputGroup = document.getElementById('input-group');
            inputGroup.classList.add('subjective-mode');
            
            const messageInput = document.getElementById('message-input');
            messageInput.placeholder = "ÏûêÏú†Î°≠Í≤å ÎåÄÌôîÌï¥Î≥¥ÏÑ∏Ïöî... (Ï£ºÍ¥ÄÏãù Î™®Îìú)";
            
            displayCharacterMessage("Ïù¥Ï†ú ÏûêÏú†Î°≠Í≤å ÏñòÍ∏∞Ìï¥Î¥êÏöî! üòä", "üòä");
        }

        // Î©îÏãúÏßÄ Ï†ÑÏÜ°
        async function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            
            if (!message) return;

            displayUserMessage(message);
            messageInput.value = '';
            gameState.messageCount++;

            showTypingIndicator();

            try {
                if (gameState.waitingForSubjective) {
                    // Ï£ºÍ¥ÄÏãù ÏùëÎãµ Ï≤òÎ¶¨
                    await handleSubjectiveResponse(message);
                    
                    // Ï£ºÍ¥ÄÏãù Î™®Îìú Ï¢ÖÎ£å ÌõÑ Îã§Ïãú ÏÑ†ÌÉùÏßÄ Î™®ÎìúÎ°ú
                    gameState.waitingForSubjective = false;
                    document.getElementById('input-group').classList.remove('subjective-mode');
                    document.getElementById('message-input').placeholder = "Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî...";
                    
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    generateChoices(`ÏÇ¨Ïö©ÏûêÏôÄ Ï£ºÍ¥ÄÏãù ÎåÄÌôî ÌõÑ Í≥ÑÏÜç ÏßÑÌñâ`);
                } else {
                    // ÏùºÎ∞ò Î©îÏãúÏßÄ Ï≤òÎ¶¨ (ÏùºÎ∞òÏ†ÅÏúºÎ°úÎäî ÏÑ†ÌÉùÏßÄ Î™®ÎìúÏóêÏÑú ÏßÅÏ†ë ÏûÖÎ†•ÌïòÏßÄ ÏïäÏùå)
                    await handleGeneralMessage(message);
                }
            } catch (error) {
                hideTypingIndicator();
                displayCharacterMessage("Î≠îÍ∞Ä Î¨∏Ï†úÍ∞Ä ÏÉùÍ∏¥ Í≤É Í∞ôÏïÑÏöî üòÖ", "üòÖ");
                console.error('Send message error:', error);
            }
        }

        // Ï£ºÍ¥ÄÏãù ÏùëÎãµ Ï≤òÎ¶¨
        async function handleSubjectiveResponse(message) {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: message,
                    affection: gameState.affection,
                    intimacy: 0,
                    context: `${selectedScenario.title} ÏãúÎÇòÎ¶¨Ïò§, ${selectedCharacter.name}(${selectedCharacter.mbti})ÏôÄÏùò Ï£ºÍ¥ÄÏãù ÎåÄÌôî`,
                    use_gpt: true
                })
            });

            const data = await response.json();
            hideTypingIndicator();

            if (data.success) {
                displayCharacterMessage(data.response, data.emotion_display);
                updateAffection(data.affection_change);
            } else {
                displayCharacterMessage("Ïùå... Î≠îÍ∞Ä Ïù¥ÏÉÅÌï¥Ïöî üòÖ", "üòÖ");
            }
        }

        // ÏùºÎ∞ò Î©îÏãúÏßÄ Ï≤òÎ¶¨
        async function handleGeneralMessage(message) {
            // ÏùºÎ∞òÏ†ÅÏù∏ GPT ÏùëÎãµ
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: message,
                    affection: gameState.affection,
                    intimacy: 0,
                    context: `${selectedScenario.title} ÏãúÎÇòÎ¶¨Ïò§, ${selectedCharacter.name}(${selectedCharacter.mbti})ÏôÄÏùò ÎåÄÌôî`,
                    use_gpt: true
                })
            });

            const data = await response.json();
            hideTypingIndicator();

            if (data.success) {
                displayCharacterMessage(data.response, data.emotion_display);
                updateAffection(data.affection_change);
            } else {
                displayCharacterMessage("Ïùå... Î≠îÍ∞Ä Ïù¥ÏÉÅÌï¥Ïöî üòÖ", "üòÖ");
            }
        }

        // ÏÇ¨Ïö©Ïûê Î©îÏãúÏßÄ ÌëúÏãú
        function displayUserMessage(message) {
            const container = document.getElementById('messages-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message sent';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';
            bubbleDiv.textContent = message;
            
            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
            
            contentDiv.appendChild(bubbleDiv);
            contentDiv.appendChild(timeDiv);
            messageDiv.appendChild(contentDiv);
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // Ï∫êÎ¶≠ÌÑ∞ Î©îÏãúÏßÄ ÌëúÏãú
        function displayCharacterMessage(message, emotion) {
            const container = document.getElementById('messages-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message received';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';
            
            if (emotion) {
                bubbleDiv.innerHTML = `<span style="margin-right: 8px; font-size: 16px;">${emotion}</span>${message}`;
            } else {
                bubbleDiv.textContent = message;
            }
            
            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
            
            contentDiv.appendChild(bubbleDiv);
            contentDiv.appendChild(timeDiv);
            messageDiv.appendChild(contentDiv);
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // ÏßÄÎ¨∏ ÌëúÏãú
        function showNarration(text) {
            const container = document.getElementById('messages-container');
            const narrationDiv = document.createElement('div');
            narrationDiv.className = 'narration';
            narrationDiv.textContent = text;
            container.appendChild(narrationDiv);
            container.scrollTop = container.scrollHeight;
        }

        // ÌÉÄÏù¥Ìïë ÌëúÏãú
        function showTypingIndicator() {
            const container = document.getElementById('messages-container');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'typing-indicator';
            typingDiv.innerHTML = `
                <span style="font-size: 12px; color: #999;">${selectedCharacter.name} ÏûÖÎ†• Ï§ë</span>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            
            container.appendChild(typingDiv);
            container.scrollTop = container.scrollHeight;
        }

        // ÌÉÄÏù¥Ìïë ÌëúÏãú Ïà®Í∏∞Í∏∞
        function hideTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // Ìò∏Í∞êÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
        function updateAffection(change) {
            const oldAffection = gameState.affection;
            gameState.affection = Math.max(0, Math.min(100, gameState.affection + change));
            
            document.getElementById('affection-display').textContent = gameState.affection;

            // Ìò∏Í∞êÎèÑ Î≥ÄÌôî Î©îÏãúÏßÄ
            if (gameState.affection >= 90 && oldAffection < 90) {
                setTimeout(() => {
                    displayCharacterMessage("Ï†ïÎßê ÌñâÎ≥µÌï¥Ïöî! üíï", "üíï");
                }, 2000);
            } else if (gameState.affection <= 20 && oldAffection > 20) {
                setTimeout(() => {
                    displayCharacterMessage("Ï¢Ä ÏÜçÏÉÅÌï¥Ïöî... „Ö†„Ö†", "üò¢");
                }, 2000);
            }
        }

        // Í∞êÏ†ï Ïù¥Î™®ÏßÄ Î≥ÄÌôò
        function getEmotionEmoji(emotion) {
            const emotions = {
                'happy': 'üòä',
                'shy': 'üò≥', 
                'love': 'üíï',
                'excited': 'ü§ó',
                'curious': 'ü§î',
                'sad': 'üò¢',
                'neutral': 'üòê'
            };
            return emotions[emotion] || 'üòä';
        }

        // GPT ÏÑ§Ï†ï Í∞ÄÏ†∏Ïò§Í∏∞
        function getGPTConfig() {
            return {
                api_key: localStorage.getItem('gpt_api_key') || '',
                model: 'gpt-3.5-turbo',
                temperature: 0.8,
                enabled: !!localStorage.getItem('gpt_api_key')
            };
        }

        // Î∞òÏùëÌòï Ï≤òÎ¶¨
        function handleResize() {
            if (window.innerWidth > 768) {
                document.getElementById('chat-list').classList.remove('hidden');
                document.querySelector('.back-btn').style.display = 'none';
            }
        }

        // Î™®Î∞îÏùºÏóêÏÑú Ï±ÑÌåÖÎ∞© Î™©Î°ù ÌëúÏãú
        function showChatList() {
            document.getElementById('chat-list').classList.remove('hidden');
            document.getElementById('chat-area').classList.remove('active');
            document.getElementById('welcome-screen').style.display = 'flex';
        }
    </script>
</body>
</html>