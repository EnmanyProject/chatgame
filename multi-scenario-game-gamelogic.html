<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ® MBTI ë©”ì‹ ì € ê²Œì„ - GameLogic í†µí•© v3.0.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .chat-container {
            width: min(100vw, 400px);
            height: min(100vh, 800px);
            max-width: 400px;
            max-height: 800px;
            background: #000;
            border: 2px solid #333;
            border-radius: 25px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.1);
        }
        
        /* ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ í™”ë©´ */
        .scenario-selection {
            flex: 1;
            padding: 40px 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .scenario-title {
            font-size: 24px;
            margin-bottom: 30px;
            text-align: center;
            color: #ff69b4;
        }
        .scenario-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 300px;
        }
        .scenario-button {
            background: #333;
            border: 2px solid #555;
            color: #fff;
            padding: 20px;
            border-radius: 15px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        .scenario-button:hover {
            background: #444;
            border-color: #ff69b4;
            transform: translateY(-2px);
        }
        
        /* ì±„íŒ… í™”ë©´ */
        .chat-header {
            background: #111;
            padding: 15px 20px;
            border-bottom: 1px solid #333;
            display: none;
            justify-content: space-between;
            align-items: center;
        }
        .contact-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .profile-pic {
            position: relative;
        }
        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid #ff69b4;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        .contact-name {
            font-size: 16px;
            font-weight: 600;
        }
        
        /* ìƒˆë¡œìš´ í†µê³„ ë°” */
        .enhanced-stats {
            background: rgba(255, 105, 180, 0.1);
            padding: 10px;
            display: flex;
            justify-content: space-between;
            font-size: 12px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-label {
            display: block;
            opacity: 0.7;
        }
        .stat-value {
            font-weight: bold;
            color: #ff69b4;
        }
        .progress-mini {
            width: 40px;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            margin-top: 2px;
        }
        .progress-fill-mini {
            height: 100%;
            background: #ff69b4;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        /* ë©”ì‹œì§€ ì˜ì—­ */
        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #000;
        }
        .message {
            margin-bottom: 15px;
            animation: messageSlideIn 0.3s ease;
        }
        @keyframes messageSlideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .character-message {
            background: #1a1a1a;
            color: #fff;
            padding: 15px;
            border-radius: 15px 15px 15px 5px;
            border: 1px solid #333;
            max-width: 85%;
        }
        .user-message {
            background: #ff69b4;
            color: #fff;
            padding: 15px;
            border-radius: 15px 15px 5px 15px;
            margin-left: auto;
            max-width: 85%;
            text-align: right;
        }
        
        .narration {
            font-style: italic;
            color: #888;
            font-size: 13px;
            margin-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-top: 8px;
        }
        
        /* íŠ¹ë³„ ì´ë²¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .special-event {
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            color: #333;
            padding: 15px;
            border-radius: 15px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
            animation: specialEventGlow 1s ease infinite alternate;
        }
        @keyframes specialEventGlow {
            from { box-shadow: 0 0 15px rgba(255, 107, 107, 0.5); }
            to { box-shadow: 0 0 25px rgba(255, 107, 107, 0.8); }
        }
        
        /* ì„ íƒì§€ ì˜ì—­ */
        .choices {
            padding: 20px;
            background: #111;
            border-top: 1px solid #333;
            display: none;
        }
        .choice-btn {
            width: 100%;
            padding: 15px;
            margin: 8px 0;
            background: #222;
            border: 2px solid #444;
            color: #fff;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-size: 14px;
        }
        .choice-btn:hover:not(:disabled) {
            background: #333;
            border-color: #ff69b4;
            transform: translateX(5px);
        }
        .choice-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* ììœ ì…ë ¥ ì˜ì—­ */
        .input-container {
            padding: 20px;
            background: #111;
            border-top: 1px solid #333;
            display: none;
        }
        .free-input {
            width: 100%;
            padding: 15px;
            background: #222;
            border: 2px solid #444;
            color: #fff;
            border-radius: 10px;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }
        .input-btn {
            background: #48bb78;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px 5px 0 0;
            transition: all 0.3s ease;
        }
        .input-btn:hover:not(:disabled) {
            background: #38a169;
            transform: translateY(-1px);
        }
        .input-btn.cancel {
            background: #e53e3e;
        }
        .input-btn.cancel:hover {
            background: #c53030;
        }
        
        /* íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° */
        .typing-indicator {
            padding: 15px 20px;
            color: #888;
            font-style: italic;
            display: none;
            align-items: center;
            gap: 10px;
        }
        .typing-dots {
            display: flex;
            gap: 3px;
        }
        .typing-dot {
            width: 6px;
            height: 6px;
            background: #ff69b4;
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        .typing-dot:nth-child(3) { animation-delay: 0s; }
        
        @keyframes typingBounce {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        /* ë””ë²„ê·¸ íŒ¨ë„ */
        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.9);
            color: #00ff00;
            padding: 15px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 11px;
            display: none;
            z-index: 9999;
            border: 1px solid #333;
            min-width: 200px;
        }
        .debug-section {
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #333;
        }
        .debug-title {
            color: #ff69b4;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        /* ì§„í–‰ë„ ë°” */
        .progress-container {
            background: #111;
            padding: 10px 20px;
            border-top: 1px solid #333;
            display: none;
        }
        .progress-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff69b4, #667eea);
            transition: width 0.5s ease;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ í™”ë©´ -->
        <div id="scenarioSelection" class="scenario-selection">
            <div class="scenario-title">ğŸ’• ë¡œë§¨ìŠ¤ ë©”ì‹ ì € ê²Œì„</div>
            <div class="scenario-buttons">
                <button class="scenario-button" onclick="startScenario('hangover_confession')">
                    ğŸ· ì–´ì œ ë°¤ì˜ ê¸°ì–µ<br>
                    <small style="color: #888;">ìˆ  ë¨¹ê³  ê³ ë°±í•œ í›„ ë¶€ë„ëŸ¬ì›Œí•˜ëŠ” ìƒí™©</small>
                </button>
                <button class="scenario-button" onclick="startScenario('study_together')">
                    ğŸ“š í•¨ê»˜ ê³µë¶€í•˜ê¸°<br>
                    <small style="color: #888;">ë„ì„œê´€ì—ì„œ ê°™ì´ ê³µë¶€í•˜ëŠ” ìƒí™©</small>
                </button>
            </div>
        </div>
        
        <!-- ì±„íŒ… í—¤ë” -->
        <div id="chatHeader" class="chat-header">
            <div class="contact-info">
                <div class="profile-pic">
                    <div class="avatar" id="characterAvatar">ğŸ­</div>
                </div>
                <div>
                    <div class="contact-name" id="characterName">ìœ¤ì•„</div>
                    <div style="font-size: 12px; color: #888;" id="characterStatus">INFP â€¢ ì˜¨ë¼ì¸</div>
                </div>
            </div>
            <div style="font-size: 12px; color: #888;">
                <span id="progressText">1/36</span>
            </div>
        </div>
        
        <!-- í–¥ìƒëœ í†µê³„ ë°” (GameLogic í†µí•©) -->
        <div id="enhancedStats" class="enhanced-stats" style="display: none;">
            <div class="stat-item">
                <span class="stat-label">í˜¸ê°ë„</span>
                <span class="stat-value" id="affectionStat">75</span>
                <div class="progress-mini">
                    <div class="progress-fill-mini" id="affectionProgress" style="width: 75%;"></div>
                </div>
            </div>
            <div class="stat-item">
                <span class="stat-label">ì¹œë°€ë„</span>
                <span class="stat-value" id="intimacyStat">20</span>
                <div class="progress-mini">
                    <div class="progress-fill-mini" id="intimacyProgress" style="width: 20%;"></div>
                </div>
            </div>
            <div class="stat-item">
                <span class="stat-label">ì—°ì†</span>
                <span class="stat-value" id="streakStat">0</span>
                <div class="progress-mini">
                    <div class="progress-fill-mini" id="streakProgress" style="width: 0%;"></div>
                </div>
            </div>
            <div class="stat-item">
                <span class="stat-label">ë‹¨ê³„</span>
                <span class="stat-value" id="phaseStat">ì‹œì‘</span>
            </div>
        </div>
        
        <!-- ë©”ì‹œì§€ ì˜ì—­ -->
        <div id="messagesContainer" class="messages" style="display: none;"></div>
        
        <!-- íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° -->
        <div id="typingIndicator" class="typing-indicator">
            <span id="typingText">ìœ¤ì•„ë‹˜ì´ ì…ë ¥ì¤‘</span>
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
        
        <!-- ì„ íƒì§€ ì˜ì—­ -->
        <div id="choicesContainer" class="choices"></div>
        
        <!-- ììœ ì…ë ¥ ì˜ì—­ -->
        <div id="inputContainer" class="input-container">
            <div style="margin-bottom: 10px; color: #888; font-size: 14px;">
                ğŸ’¬ ììœ ë¡­ê²Œ ë§ˆìŒì„ í‘œí˜„í•´ë³´ì„¸ìš” (4ë²ˆì§¸ë§ˆë‹¤ ë“±ì¥)
            </div>
            <textarea id="freeInput" class="free-input" placeholder="ìœ¤ì•„ì—ê²Œ í•˜ê³  ì‹¶ì€ ë§ì„ ììœ ë¡­ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”..."></textarea>
            <div style="margin-top: 10px;">
                <button class="input-btn" onclick="handleFreeInput()">ğŸ’Œ ì „ì†¡</button>
                <button class="input-btn cancel" onclick="cancelFreeInput()">âŒ ì·¨ì†Œ</button>
            </div>
        </div>
        
        <!-- ì§„í–‰ë„ ë°” -->
        <div id="progressContainer" class="progress-container">
            <div class="progress-label">ê²Œì„ ì§„í–‰ë„</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
            </div>
        </div>
    </div>
    
    <!-- ë””ë²„ê·¸ íŒ¨ë„ (GameLogic í†µí•©) -->
    <div id="debugPanel" class="debug-panel">
        <div class="debug-section">
            <div class="debug-title">ğŸ® GameLogic v3.0.0</div>
            <div>í˜¸ê°ë„: <span id="debugAffection">75</span>/100</div>
            <div>ì¹œë°€ë„: <span id="debugIntimacy">20</span>/100</div>
            <div>ì§„í–‰ë„: <span id="debugProgress">1</span>/36</div>
        </div>
        <div class="debug-section">
            <div class="debug-title">ğŸ¯ ë³´ë„ˆìŠ¤ ì‹œìŠ¤í…œ</div>
            <div>ì—°ì† ì„ íƒ: <span id="debugStreak">0</span>íšŒ</div>
            <div>í˜„ì¬ ë‹¨ê³„: <span id="debugPhase">introduction</span></div>
            <div>ì´ ìƒí˜¸ì‘ìš©: <span id="debugInteractions">0</span>íšŒ</div>
        </div>
        <div class="debug-section">
            <div class="debug-title">âœ¨ íŠ¹ë³„ ì´ë²¤íŠ¸</div>
            <div id="debugEvents">ì—†ìŒ</div>
        </div>
        <div style="margin-top: 10px; font-size: 10px; color: #666;">
            Ctrl+Shift+D: íŒ¨ë„ í† ê¸€<br>
            Ctrl+Enter: ììœ ì…ë ¥ ì „ì†¡
        </div>
    </div>

    <script>
        // ğŸ® GameLogic ëª¨ë“ˆ ì„ë² ë“œ (modules/GameLogic.js ë‚´ìš©)
        class GameLogic {
            constructor() {
                this.version = 'v3.0.0';
                
                this.affectionWeights = {
                    choice: 1.0,
                    freeInput: 1.5,
                    timeBonus: 0.1,
                    streakBonus: 0.2,
                    phaseMultiplier: {
                        introduction: 0.8,
                        development: 1.0,
                        deepening: 1.2,
                        conclusion: 1.5
                    }
                };
                
                this.emotionKeywords = {
                    positive: ['ì¢‹ì•„', 'ì‚¬ë‘', 'ì˜ˆì˜', 'ë©‹ì ¸', 'ì™„ë²½', 'ìµœê³ ', 'í–‰ë³µ', 'ê¸°ë»', 'ê°ë™', 'ê³ ë§ˆì›Œ', 'í›Œë¥­', 'ëŒ€ë‹¨'],
                    romantic: ['ì„¤ë ˆ', 'ë‘ê·¼', 'ì‚¬ë‘í•´', 'ì¢‹ì•„í•´', 'ì˜ˆì˜ë‹¤', 'ê·€ì—¬ì›Œ', 'ë§¤ë ¥ì ', 'ìš´ëª…', 'ì†Œì¤‘í•´', 'íŠ¹ë³„í•´'],
                    caring: ['ê±±ì •', 'ì±™ê²¨', 'ë³´ì‚´í´', 'ë„ì™€ì¤„ê²Œ', 'í•¨ê»˜', 'ê³ì—', 'ì§€ì¼œì¤„ê²Œ', 'ì‘ì›', 'í˜ë‚´', 'ê´œì°®'],
                    negative: ['ì‹«ì–´', 'ì§œì¦', 'í™”ë‚˜', 'ë³„ë¡œ', 'ê·€ì°®', 'í”¼ê³¤', 'ìŠ¤íŠ¸ë ˆìŠ¤', 'ì‹¤ë§', 'ì†ìƒ', 'í™”ê°€'],
                    neutral: ['ê·¸ë˜', 'ì•Œê² ì–´', 'ìŒ', 'ê·¸ëƒ¥', 'ëª¨ë¥´ê² ì–´', 'ìƒê´€ì—†ì–´', 'ê´œì°®ì•„', 'ë­', 'ì•„ë¬´ë˜ë„']
                };
                
                this.streakCount = 0;
                this.lastChoiceTime = null;
                this.totalInteractions = 0;
                this.specialEventCooldown = new Set();
                
                console.log('ğŸ® GameLogic v3.0.0 ì´ˆê¸°í™” ì™„ë£Œ');
            }

            processChoice(choice, gameState) {
                const result = {
                    success: true,
                    affectionChange: 0,
                    intimacyChange: 0,
                    specialEvent: null,
                    message: '',
                    bonusDetails: {},
                    gameState: { ...gameState }
                };

                try {
                    const oldAffection = gameState.affection;
                    let baseAffectionChange = choice.affection_impact || 0;
                    
                    const currentPhase = this.getCurrentPhase(gameState.choiceNumber || 0);
                    const phaseMultiplier = this.affectionWeights.phaseMultiplier[currentPhase];
                    const timeBonus = this.calculateTimeBonus();
                    const streakBonus = this.calculateStreakBonus(baseAffectionChange);
                    
                    const adjustedBase = Math.round(baseAffectionChange * phaseMultiplier);
                    const totalAffectionChange = Math.round(
                        (adjustedBase * this.affectionWeights.choice) + 
                        timeBonus + 
                        streakBonus
                    );
                    
                    let intimacyChange = 0;
                    if (baseAffectionChange > 0) {
                        const intimacyChance = Math.min(0.5, 0.2 + (gameState.intimacy / 200));
                        intimacyChange = Math.random() < intimacyChance ? Math.floor(Math.random() * 2) + 1 : 0;
                    }
                    
                    result.gameState.affection = Math.max(-100, Math.min(100, 
                        gameState.affection + totalAffectionChange));
                    result.gameState.intimacy = Math.max(0, Math.min(100, 
                        gameState.intimacy + intimacyChange));
                    result.gameState.choiceNumber = (gameState.choiceNumber || 0) + 1;
                    
                    if (!result.gameState.choiceHistory) result.gameState.choiceHistory = [];
                    result.gameState.choiceHistory.push({
                        choice: choice.text,
                        baseImpact: choice.affection_impact,
                        finalChange: totalAffectionChange,
                        intimacyChange: intimacyChange,
                        bonuses: { time: timeBonus, streak: streakBonus, phase: phaseMultiplier },
                        phase: currentPhase,
                        timestamp: new Date().toISOString()
                    });
                    
                    result.affectionChange = totalAffectionChange;
                    result.intimacyChange = intimacyChange;
                    result.bonusDetails = {
                        base: adjustedBase,
                        time: timeBonus,
                        streak: streakBonus,
                        phase: currentPhase,
                        multiplier: phaseMultiplier
                    };
                    result.message = this.generateChoiceResultMessage(totalAffectionChange, intimacyChange);
                    result.specialEvent = this.checkSpecialEvents(result.gameState);
                    
                    this.totalInteractions++;
                    
                    console.log(`[GameLogic] ${oldAffection} â†’ ${result.gameState.affection} (${totalAffectionChange > 0 ? '+' : ''}${totalAffectionChange}) | ë³´ë„ˆìŠ¤: ì‹œê°„${timeBonus}, ì—°ì†${streakBonus}`);
                    
                } catch (error) {
                    console.error('[GameLogic] ì„ íƒì§€ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                    result.success = false;
                    result.message = 'ì„ íƒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                }
                
                return result;
            }

            analyzeFreeInput(input, gameState) {
                const result = {
                    success: true,
                    affectionChange: 0,
                    intimacyChange: 0,
                    emotionType: 'neutral',
                    confidence: 0,
                    keywords: [],
                    message: '',
                    gameState: { ...gameState }
                };

                try {
                    const cleanInput = input.trim().toLowerCase();
                    const emotionAnalysis = this.analyzeEmotion(cleanInput);
                    
                    result.emotionType = emotionAnalysis.type;
                    result.confidence = emotionAnalysis.confidence;
                    result.keywords = emotionAnalysis.keywords;
                    
                    let affectionChange = this.calculateFreeInputAffection(emotionAnalysis);
                    const currentPhase = this.getCurrentPhase(gameState.choiceNumber || 0);
                    const phaseMultiplier = this.affectionWeights.phaseMultiplier[currentPhase];
                    
                    affectionChange = Math.round(affectionChange * this.affectionWeights.freeInput * phaseMultiplier);
                    
                    let intimacyChange = 0;
                    if (emotionAnalysis.confidence > 0.6) {
                        if (emotionAnalysis.type === 'romantic' || emotionAnalysis.type === 'caring') {
                            intimacyChange = Math.floor(Math.random() * 4) + 2;
                        } else if (emotionAnalysis.type === 'positive') {
                            intimacyChange = Math.floor(Math.random() * 2) + 1;
                        }
                    }
                    
                    result.gameState.affection = Math.max(-100, Math.min(100, 
                        gameState.affection + affectionChange));
                    result.gameState.intimacy = Math.max(0, Math.min(100, 
                        gameState.intimacy + intimacyChange));
                    
                    if (!result.gameState.freeInputHistory) result.gameState.freeInputHistory = [];
                    result.gameState.freeInputHistory.push({
                        input: input,
                        emotionType: emotionAnalysis.type,
                        confidence: emotionAnalysis.confidence,
                        affectionChange: affectionChange,
                        intimacyChange: intimacyChange,
                        timestamp: new Date().toISOString()
                    });
                    
                    result.affectionChange = affectionChange;
                    result.intimacyChange = intimacyChange;
                    result.message = this.generateInputResultMessage(emotionAnalysis, affectionChange, intimacyChange);
                    
                    console.log(`[GameLogic] ììœ ì…ë ¥: ${emotionAnalysis.type} (${(emotionAnalysis.confidence * 100).toFixed(1)}%) â†’ í˜¸ê°ë„ ${affectionChange > 0 ? '+' : ''}${affectionChange}, ì¹œë°€ë„ +${intimacyChange}`);
                    
                } catch (error) {
                    console.error('[GameLogic] ììœ ì…ë ¥ ë¶„ì„ ì˜¤ë¥˜:', error);
                    result.success = false;
                    result.message = 'ì…ë ¥ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                }
                
                return result;
            }

            analyzeEmotion(text) {
                const emotions = { positive: 0, romantic: 0, caring: 0, negative: 0, neutral: 0 };
                const foundKeywords = [];
                let totalScore = 0;
                
                for (const [emotionType, keywords] of Object.entries(this.emotionKeywords)) {
                    for (const keyword of keywords) {
                        const keywordCount = (text.match(new RegExp(keyword, 'g')) || []).length;
                        if (keywordCount > 0) {
                            emotions[emotionType] += keywordCount;
                            totalScore += keywordCount;
                            foundKeywords.push({ word: keyword, type: emotionType, count: keywordCount });
                        }
                    }
                }
                
                const maxEmotion = Object.keys(emotions).reduce((a, b) => 
                    emotions[a] > emotions[b] ? a : b
                );
                
                const textLength = text.length;
                const keywordDensity = totalScore / Math.max(textLength / 10, 1);
                const confidence = Math.min(1.0, keywordDensity + (foundKeywords.length * 0.2));
                
                return { type: maxEmotion, confidence, keywords: foundKeywords, scores: emotions };
            }

            calculateFreeInputAffection(emotionAnalysis) {
                const baseValues = { romantic: 12, caring: 8, positive: 5, neutral: 0, negative: -4 };
                const baseValue = baseValues[emotionAnalysis.type] || 0;
                const confidenceMultiplier = Math.max(0.3, emotionAnalysis.confidence);
                const densityBonus = emotionAnalysis.keywordDensity > 0.5 ? 1.2 : 1.0;
                return Math.round(baseValue * confidenceMultiplier * densityBonus);
            }

            calculateTimeBonus() {
                if (!this.lastChoiceTime) {
                    this.lastChoiceTime = Date.now();
                    return 0;
                }
                
                const timeDiff = Date.now() - this.lastChoiceTime;
                this.lastChoiceTime = Date.now();
                
                if (timeDiff < 3000) return 2;
                if (timeDiff < 5000) return 1;
                if (timeDiff > 30000) return -1;
                return 0;
            }

            calculateStreakBonus(affectionChange) {
                if (affectionChange > 0) {
                    this.streakCount += 1;
                } else if (affectionChange < 0) {
                    this.streakCount = 0;
                }
                
                if (this.streakCount >= 5) return 3;
                if (this.streakCount >= 3) return 2;
                if (this.streakCount >= 2) return 1;
                return 0;
            }

            checkSpecialEvents(gameState) {
                if (!gameState.specialEvents) gameState.specialEvents = [];
                
                if (gameState.affection >= 90 && !this.specialEventCooldown.has('perfect_chemistry')) {
                    this.specialEventCooldown.add('perfect_chemistry');
                    gameState.specialEvents.push('perfect_chemistry');
                    return {
                        type: 'perfect_chemistry',
                        message: 'ğŸ’– ì™„ë²½í•œ ì¼€ë¯¸ìŠ¤íŠ¸ë¦¬! ë§ˆìŒì´ ì™„ì „íˆ í†µí–ˆì–´ìš”!',
                        bonus: { affection: 5, intimacy: 15 }
                    };
                } else if (gameState.affection >= 80 && !this.specialEventCooldown.has('high_affection')) {
                    this.specialEventCooldown.add('high_affection');
                    gameState.specialEvents.push('high_affection');
                    return {
                        type: 'high_affection',
                        message: 'ğŸ’• íŠ¹ë³„í•œ ìˆœê°„ì´ ì‹œì‘ë©ë‹ˆë‹¤...',
                        bonus: { affection: 3, intimacy: 8 }
                    };
                }
                
                if (gameState.intimacy >= 85 && !this.specialEventCooldown.has('deep_bond')) {
                    this.specialEventCooldown.add('deep_bond');
                    gameState.specialEvents.push('deep_bond');
                    return {
                        type: 'deep_bond',
                        message: 'ğŸ¤— ê¹Šì€ ìœ ëŒ€ê°ì´ í˜•ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!',
                        bonus: { affection: 5, intimacy: 10 }
                    };
                }
                
                return null;
            }

            getCurrentPhase(choiceNumber) {
                if (choiceNumber <= 9) return 'introduction';
                if (choiceNumber <= 18) return 'development';
                if (choiceNumber <= 27) return 'deepening';
                return 'conclusion';
            }

            determineEnding(gameState) {
                const { affection, intimacy } = gameState;
                if (affection >= 90 && intimacy >= 85) return 'perfect_ending';
                if (affection >= 80 && intimacy >= 70) return 'romantic_ending';
                if (affection >= 70 && intimacy >= 50) return 'good_ending';
                if (affection >= 50) return 'normal_ending';
                if (affection >= 20) return 'friend_ending';
                return 'bad_ending';
            }

            generateChoiceResultMessage(affectionChange, intimacyChange) {
                if (affectionChange >= 8) return 'ğŸ’ ë§ˆìŒì´ ì™„ì „íˆ ë…¹ì•˜ì–´ìš”!';
                if (affectionChange >= 5) return 'ğŸ’— ë§ˆìŒì´ ë§ì´ ë”°ëœ»í•´ì¡Œì–´ìš”!';
                if (affectionChange >= 3) return 'ğŸ˜Š ì •ë§ ì¢‹ì€ ë°˜ì‘ì´ì—ìš”!';
                if (affectionChange >= 1) return 'ğŸ˜Œ í˜¸ê°ë„ê°€ ì˜¬ëì–´ìš”.';
                if (affectionChange === 0) return 'ğŸ˜ í‰ë²”í•œ ë°˜ì‘ì´ì—ìš”.';
                if (affectionChange >= -2) return 'ğŸ˜… ì¡°ê¸ˆ ì•„ì‰¬ìš´ ì„ íƒì´ì—ˆì–´ìš”.';
                return 'ğŸ˜” ë§ˆìŒì´ ì¢€ ë©€ì–´ì§„ ê²ƒ ê°™ì•„ìš”...';
            }

            generateInputResultMessage(emotionAnalysis, affectionChange, intimacyChange) {
                const messages = {
                    romantic: ['ğŸ’• ë¡œë§¨í‹±í•œ ë§ì— ë§ˆìŒì´ ì™„ì „íˆ ì„¤ë ˆë„¤ìš”!', 'ğŸ’– ê·¸ëŸ° ë§ ë“¤ìœ¼ë‹ˆê¹Œ ì •ë§ í–‰ë³µí•´ìš”!'],
                    caring: ['ğŸ¤— ë”°ëœ»í•œ ë§ˆìŒì´ ì •ë§ ê°ë™ì´ì—ìš”!', 'ğŸ˜Š ì˜¤ë¹ ì˜ ë°°ë ¤ê°€ ëŠê»´ì ¸ì„œ ê³ ë§ˆì›Œìš”!'],
                    positive: ['ğŸ˜Š ê¸ì •ì ì¸ ì—ë„ˆì§€ê°€ ì „í•´ì ¸ìš”!', 'âœ¨ ë°ì€ ë§ˆìŒì´ ì¢‹ì•„ìš”!'],
                    neutral: ['ğŸ˜Œ ì°¨ë¶„í•œ ëŒ€í™”ê°€ í¸ì•ˆí•´ìš”.', 'ğŸ™‚ ì§„ì†”í•œ ë§ˆìŒì´ ëŠê»´ì ¸ìš”.'],
                    negative: ['ğŸ˜” ì¡°ê¸ˆ ì•„ì‰¬ìš´ ê¸°ë¶„ì´ì—ìš”...', 'ğŸ˜• ë¬´ì–¸ê°€ ì„œìš´í•œ ëŠë‚Œì´ ë“¤ì–´ìš”.']
                };
                
                const emotionMessages = messages[emotionAnalysis.type] || messages.neutral;
                return emotionMessages[Math.floor(Math.random() * emotionMessages.length)];
            }

            validateInput(input) {
                if (!input || typeof input !== 'string') return { valid: false, reason: 'ì˜¬ë°”ë¥¸ ì…ë ¥ì´ ì•„ë‹™ë‹ˆë‹¤.' };
                const trimmedInput = input.trim();
                if (trimmedInput.length === 0) return { valid: false, reason: 'ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.' };
                if (trimmedInput.length > 500) return { valid: false, reason: 'ì…ë ¥ì´ ë„ˆë¬´ ê¹ë‹ˆë‹¤. (ìµœëŒ€ 500ì)' };
                if (trimmedInput.length < 2) return { valid: false, reason: 'ì¢€ ë” ìì„¸íˆ ë§í•´ì£¼ì„¸ìš”.' };
                return { valid: true };
            }

            getDebugInfo(gameState) {
                return {
                    version: this.version,
                    affection: gameState.affection || 0,
                    intimacy: gameState.intimacy || 0,
                    choiceNumber: gameState.choiceNumber || 0,
                    streakCount: this.streakCount,
                    currentPhase: this.getCurrentPhase(gameState.choiceNumber || 0),
                    totalInteractions: this.totalInteractions,
                    specialEvents: gameState.specialEvents || [],
                    expectedEnding: this.determineEnding(gameState)
                };
            }
        }

        // ğŸ¯ ê²Œì„ ìƒíƒœ ë° ì´ˆê¸°í™”
        const gameLogic = new GameLogic();
        let gameState = {
            currentScenario: null,
            currentCharacter: null,
            affection: 75,
            intimacy: 20,
            choiceNumber: 0,
            messageCount: 0,
            choiceHistory: [],
            freeInputHistory: [],
            specialEvents: [],
            isProcessing: false,
            isFreeChatMode: false
        };

        // ì‹œë‚˜ë¦¬ì˜¤ ë°ì´í„° (ê¸°ì¡´ í”„ë¡œì íŠ¸ í˜¸í™˜)
        const scenarios = {
            hangover_confession: {
                id: "hangover_confession",
                title: "ì–´ì œ ë°¤ì˜ ê¸°ì–µ",
                description: "ìˆ  ë¨¹ê³  ê³ ë°±í•œ í›„ ë¶€ë„ëŸ¬ì›Œí•˜ëŠ” ìƒí™©",
                character: { name: "ìœ¤ì•„", mbti: "INFP", avatar: "ğŸ­" },
                dialogues: [
                    {
                        dialogue: "ì˜¤ë¹ ... ì–´ì œëŠ” ì •ë§ ë¯¸ì•ˆí•´ ğŸ˜³ ì·¨í•´ì„œ ê·¸ëŸ° ë§ê¹Œì§€ í–ˆëŠ”ë°...",
                        narration: "ìœ¤ì•„ê°€ ì–¼êµ´ì„ ë¶‰íˆë©° ì†ìœ¼ë¡œ ì–¼êµ´ì„ ê°€ë¦°ë‹¤.",
                        choices: [
                            {text: "ê´œì°®ë‹¤ê³  ë‹¤ì •í•˜ê²Œ ë§í•´ì¤€ë‹¤", affection_impact: 3},
                            {text: "ì–´ë–¤ ë§ì„ í–ˆëŠ”ì§€ ê¶ê¸ˆí•˜ë‹¤ê³  í•œë‹¤", affection_impact: 1},
                            {text: "ì˜ ê¸°ì–µ ì•ˆ ë‚˜ë„¤...", affection_impact: -1}
                        ]
                    },
                    {
                        dialogue: "ê·¸ë˜ë„... ì§„ì‹¬ì´ì—ˆì–´ ğŸ˜Š ì˜¤ë¹ í•œí…Œë§Œ ë§í•  ìˆ˜ ìˆëŠ” ê±°ì•¼",
                        narration: "ìœ¤ì•„ê°€ ìˆ˜ì¤ê²Œ ë¯¸ì†Œì§€ìœ¼ë©° ê³ ê°œë¥¼ ë„ë•ì¸ë‹¤.",
                        choices: [
                            {text: "ë‚˜ë„ í•­ìƒ ë„ˆë¥¼ ìƒê°í•´ì™”ì–´", affection_impact: 4},
                            {text: "ê·¸ëŸ° ë§ˆìŒ ë°›ì•„ì¤„ê²Œ", affection_impact: 2},
                            {text: "ê³ ë§ˆì›Œ, ì˜ ìƒê°í•´ë³¼ê²Œ", affection_impact: 0}
                        ]
                    },
                    {
                        dialogue: "ì‚¬ì‹¤... ì˜¤ë¹ ë¥¼ ì¢‹ì•„í•œ ì§€ 1ë…„ì´ ë„˜ì—ˆì–´ ğŸ’—",
                        narration: "ìœ¤ì•„ê°€ ìš©ê¸°ë¥¼ ë‚´ì–´ ìì‹ ì˜ ë§ˆìŒì„ í„¸ì–´ë†“ëŠ”ë‹¤.",
                        choices: [
                            {text: "ì™œ ì§„ì‘ ë§í•˜ì§€ ì•Šì•˜ì–´?", affection_impact: 2},
                            {text: "ë‚˜ë„ ëˆˆì¹˜ì±„ê³  ìˆì—ˆì–´", affection_impact: 3},
                            {text: "ê·¸ë¬êµ¬ë‚˜...", affection_impact: 0}
                        ]
                    },
                    {
                        dialogue: "ì´ì œì•¼ í›„ë ¨í•´ ğŸ˜Œ ê³„ì† ìˆ¨ê¸°ê¸°ë§Œ í–ˆëŠ”ë°...",
                        narration: "ìœ¤ì•„ì˜ í‘œì •ì´ ë°ì•„ì§€ë©° ì•ˆë„ì˜ í•œìˆ¨ì„ ì‰°ë‹¤.",
                        choices: [
                            {text: "ì•ìœ¼ë¡œ ë” ê°€ê¹Œì›Œì§€ì", affection_impact: 3},
                            {text: "ìš©ê¸°ë‚´ì¤˜ì„œ ê³ ë§ˆì›Œ", affection_impact: 2},
                            {text: "ì¢‹ì€ ì¹œêµ¬ë¡œ ì§€ë‚´ì", affection_impact: -1}
                        ]
                    }
                ]
            },
            study_together: {
                id: "study_together",
                title: "í•¨ê»˜ ê³µë¶€í•˜ê¸°",
                description: "ë„ì„œê´€ì—ì„œ ê°™ì´ ê³µë¶€í•˜ëŠ” ìƒí™©",
                character: { name: "ìœ¤ì•„", mbti: "INFP", avatar: "ğŸ“š" },
                dialogues: [
                    {
                        dialogue: "ì˜¤ë¹ , ì—¬ê¸° ì•‰ì•„ë„ ë ê¹Œìš”? ğŸ˜Š",
                        narration: "ìœ¤ì•„ê°€ ì±…ì„ ë“¤ê³  ì¡°ì‹¬ìŠ¤ëŸ½ê²Œ ë‹¤ê°€ì˜¨ë‹¤.",
                        choices: [
                            {text: "ë¬¼ë¡ ì´ì§€, ê°™ì´ ê³µë¶€í•˜ì", affection_impact: 2},
                            {text: "ë„¤, ì•‰ìœ¼ì„¸ìš”", affection_impact: 1},
                            {text: "ë‹¤ë¥¸ ìë¦¬ëŠ” ì—†ë‚˜ìš”?", affection_impact: -1}
                        ]
                    }
                ]
            }
        };

        // ğŸ® ê²Œì„ í•µì‹¬ í•¨ìˆ˜ë“¤ (GameLogic í†µí•©)
        function startScenario(scenarioId) {
            const scenario = scenarios[scenarioId];
            if (!scenario) {
                console.error('ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', scenarioId);
                return;
            }
            
            gameState.currentScenario = scenario;
            gameState.currentCharacter = scenario.character;
            gameState.choiceNumber = 0;
            gameState.messageCount = 0;
            
            // UI ì „í™˜
            document.getElementById('scenarioSelection').style.display = 'none';
            document.getElementById('chatHeader').style.display = 'flex';
            document.getElementById('enhancedStats').style.display = 'flex';
            document.getElementById('messagesContainer').style.display = 'block';
            document.getElementById('progressContainer').style.display = 'block';
            
            // ìºë¦­í„° ì •ë³´ ì—…ë°ì´íŠ¸
            document.getElementById('characterName').textContent = scenario.character.name;
            document.getElementById('characterAvatar').textContent = scenario.character.avatar;
            
            updateUI();
            
            // ì²« ë²ˆì§¸ ëŒ€í™” ì‹œì‘
            setTimeout(() => {
                startNextDialogue();
            }, 1000);
            
            console.log(`ğŸ¬ ì‹œë‚˜ë¦¬ì˜¤ ì‹œì‘: ${scenario.title}`);
        }

        function startNextDialogue() {
            if (gameState.choiceNumber >= 36) {
                endGame();
                return;
            }
            
            const scenario = gameState.currentScenario;
            const dialogueIndex = gameState.messageCount % scenario.dialogues.length;
            const dialogue = scenario.dialogues[dialogueIndex];
            
            showTypingIndicator();
            
            setTimeout(() => {
                hideTypingIndicator();
                addCharacterMessage(dialogue.dialogue, dialogue.narration);
                
                // 4ë²ˆì§¸ë§ˆë‹¤ ììœ ì…ë ¥ ëª¨ë“œ
                if ((gameState.choiceNumber + 1) % 4 === 0) {
                    showFreeInputMode();
                } else {
                    showChoices(dialogue.choices);
                }
                
                gameState.messageCount++;
            }, Math.random() * 1500 + 1000);
        }

        function handleChoice(choice) {
            if (gameState.isProcessing) return;
            
            gameState.isProcessing = true;
            disableAllButtons();
            
            // ì‚¬ìš©ì ì„ íƒ í‘œì‹œ
            addUserMessage(choice.text);
            
            // GameLogic ëª¨ë“ˆë¡œ ì„ íƒ ì²˜ë¦¬
            const result = gameLogic.processChoice(choice, gameState);
            
            if (result.success) {
                gameState = result.gameState;
                
                // íŠ¹ë³„ ì´ë²¤íŠ¸ ì²˜ë¦¬
                if (result.specialEvent) {
                    setTimeout(() => {
                        showSpecialEvent(result.specialEvent);
                        
                        // ë³´ë„ˆìŠ¤ ì ìš©
                        if (result.specialEvent.bonus) {
                            if (result.specialEvent.bonus.affection) {
                                gameState.affection = Math.min(100, gameState.affection + result.specialEvent.bonus.affection);
                            }
                            if (result.specialEvent.bonus.intimacy) {
                                gameState.intimacy = Math.min(100, gameState.intimacy + result.specialEvent.bonus.intimacy);
                            }
                        }
                        updateUI();
                    }, 1500);
                }
                
                updateUI();
                updateDebugPanel();
                
                // ë‹¤ìŒ ëŒ€í™”ë¡œ ì§„í–‰
                setTimeout(() => {
                    startNextDialogue();
                    gameState.isProcessing = false;
                }, 2000);
                
            } else {
                console.error('ì„ íƒ ì²˜ë¦¬ ì‹¤íŒ¨:', result.message);
                gameState.isProcessing = false;
                enableAllButtons();
            }
        }

        function handleFreeInput() {
            const input = document.getElementById('freeInput').value;
            const validation = gameLogic.validateInput(input);
            
            if (!validation.valid) {
                alert(validation.reason);
                return;
            }
            
            if (gameState.isProcessing) return;
            gameState.isProcessing = true;
            
            // ì‚¬ìš©ì ì…ë ¥ í‘œì‹œ
            addUserMessage(input);
            
            // GameLogic ëª¨ë“ˆë¡œ ììœ ì…ë ¥ ë¶„ì„
            const result = gameLogic.analyzeFreeInput(input, gameState);
            
            if (result.success) {
                gameState = result.gameState;
                updateUI();
                updateDebugPanel();
                
                // ë¶„ì„ ê²°ê³¼ í‘œì‹œ
                showTypingIndicator();
                setTimeout(() => {
                    hideTypingIndicator();
                    
                    const analysisMessage = `${result.message}`;
                    const detailMessage = `
                        <div style="font-size: 11px; color: #666; margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 5px;">
                            ğŸ§  ê°ì •ë¶„ì„: ${result.emotionType.toUpperCase()} (${(result.confidence * 100).toFixed(1)}%)
                            ${result.affectionChange !== 0 ? ` | í˜¸ê°ë„ ${result.affectionChange > 0 ? '+' : ''}${result.affectionChange}` : ''}
                            ${result.intimacyChange !== 0 ? ` | ì¹œë°€ë„ +${result.intimacyChange}` : ''}
                            ${result.keywords.length > 0 ? ` | í‚¤ì›Œë“œ: ${result.keywords.map(k => k.word).join(', ')}` : ''}
                        </div>
                    `;
                    
                    addCharacterMessage(analysisMessage + detailMessage);
                    
                    // ë‹¤ìŒ ëŒ€í™”ë¡œ ì§„í–‰
                    setTimeout(() => {
                        startNextDialogue();
                        gameState.isProcessing = false;
                        hideFreeInputMode();
                    }, 2000);
                }, 2000);
                
            } else {
                console.error('ììœ ì…ë ¥ ë¶„ì„ ì‹¤íŒ¨:', result.message);
                gameState.isProcessing = false;
            }
        }

        // ğŸ¨ UI ê´€ë¦¬ í•¨ìˆ˜ë“¤
        function updateUI() {
            // í˜¸ê°ë„ ì—…ë°ì´íŠ¸ (ìŒìˆ˜ í¬í•¨ ê³„ì‚°)
            const affectionPercent = Math.max(0, (gameState.affection + 100) / 2);
            document.getElementById('affectionStat').textContent = gameState.affection;
            document.getElementById('affectionProgress').style.width = `${affectionPercent}%`;
            
            // ì¹œë°€ë„ ì—…ë°ì´íŠ¸
            document.getElementById('intimacyStat').textContent = gameState.intimacy;
            document.getElementById('intimacyProgress').style.width = `${gameState.intimacy}%`;
            
            // ì—°ì† ë³´ë„ˆìŠ¤ ì—…ë°ì´íŠ¸
            const streakPercent = Math.min(100, (gameLogic.streakCount / 5) * 100);
            document.getElementById('streakStat').textContent = gameLogic.streakCount;
            document.getElementById('streakProgress').style.width = `${streakPercent}%`;
            
            // ê²Œì„ ë‹¨ê³„ ì—…ë°ì´íŠ¸
            const phaseNames = {
                introduction: 'ì‹œì‘',
                development: 'ë°œì „',
                deepening: 'ì‹¬í™”',
                conclusion: 'ê²°ë§'
            };
            document.getElementById('phaseStat').textContent = phaseNames[gameLogic.getCurrentPhase(gameState.choiceNumber)];
            
            // ì§„í–‰ë„ ì—…ë°ì´íŠ¸
            const progressPercent = (gameState.choiceNumber / 36) * 100;
            document.getElementById('progressFill').style.width = `${progressPercent}%`;
            document.getElementById('progressText').textContent = `${gameState.choiceNumber}/36`;
        }

        function updateDebugPanel() {
            const debugInfo = gameLogic.getDebugInfo(gameState);
            
            document.getElementById('debugAffection').textContent = debugInfo.affection;
            document.getElementById('debugIntimacy').textContent = debugInfo.intimacy;
            document.getElementById('debugProgress').textContent = debugInfo.choiceNumber;
            document.getElementById('debugStreak').textContent = debugInfo.streakCount;
            document.getElementById('debugPhase').textContent = debugInfo.currentPhase;
            document.getElementById('debugInteractions').textContent = debugInfo.totalInteractions;
            
            const eventsText = debugInfo.specialEvents.length > 0 ? 
                debugInfo.specialEvents.join(', ') : 'ì—†ìŒ';
            document.getElementById('debugEvents').textContent = eventsText;
        }

        function addCharacterMessage(dialogue, narration = '') {
            const messagesContainer = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.innerHTML = `
                <div class="character-message">
                    ${dialogue}
                    ${narration ? `<div class="narration">${narration}</div>` : ''}
                </div>
            `;
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        function addUserMessage(text) {
            const messagesContainer = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.innerHTML = `<div class="user-message">${text}</div>`;
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        function showSpecialEvent(event) {
            const messagesContainer = document.getElementById('messagesContainer');
            const eventDiv = document.createElement('div');
            eventDiv.innerHTML = `
                <div class="special-event">
                    <div style="font-size: 16px; margin-bottom: 8px;">${event.message}</div>
                    <div style="font-size: 12px;">
                        ${event.bonus.affection ? `í˜¸ê°ë„ +${event.bonus.affection}` : ''}
                        ${event.bonus.intimacy ? ` ì¹œë°€ë„ +${event.bonus.intimacy}` : ''}
                    </div>
                </div>
            `;
            messagesContainer.appendChild(eventDiv);
            scrollToBottom();
        }

        function showChoices(choices) {
            const container = document.getElementById('choicesContainer');
            container.innerHTML = '';
            container.style.display = 'block';
            
            choices.forEach((choice, index) => {
                const button = document.createElement('button');
                button.className = 'choice-btn';
                button.onclick = () => handleChoice(choice);
                
                const emojis = ['ğŸ’•', 'ğŸ˜Š', 'ğŸ¤”', 'ğŸ˜”'];
                const impactText = choice.affection_impact > 0 ? ` (+${choice.affection_impact})` : 
                                  choice.affection_impact < 0 ? ` (${choice.affection_impact})` : '';
                
                button.innerHTML = `${emojis[index] || 'ğŸ’¬'} ${choice.text}${impactText}`;
                container.appendChild(button);
            });
        }

        function showFreeInputMode() {
            document.getElementById('choicesContainer').style.display = 'none';
            document.getElementById('inputContainer').style.display = 'block';
            document.getElementById('freeInput').value = '';
            document.getElementById('freeInput').focus();
            gameState.isFreeChatMode = true;
        }

        function hideFreeInputMode() {
            document.getElementById('choicesContainer').style.display = 'block';
            document.getElementById('inputContainer').style.display = 'none';
            gameState.isFreeChatMode = false;
        }

        function cancelFreeInput() {
            hideFreeInputMode();
            // ë‹¤ìŒ ëŒ€í™”ë¡œ ë°”ë¡œ ì§„í–‰
            setTimeout(() => {
                startNextDialogue();
            }, 500);
        }

        function showTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'flex';
            scrollToBottom();
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            container.scrollTop = container.scrollHeight;
        }

        function disableAllButtons() {
            const buttons = document.querySelectorAll('.choice-btn, .input-btn');
            buttons.forEach(btn => btn.disabled = true);
        }

        function enableAllButtons() {
            const buttons = document.querySelectorAll('.choice-btn, .input-btn');
            buttons.forEach(btn => btn.disabled = false);
        }

        function endGame() {
            const ending = gameLogic.determineEnding(gameState);
            const debugInfo = gameLogic.getDebugInfo(gameState);
            
            const endingMessages = {
                perfect_ending: 'ğŸ’– ì™„ë²½í•œ ì—”ë”©! ì§„ì •í•œ ì‚¬ë‘ì´ ì‹œì‘ë©ë‹ˆë‹¤! âœ¨',
                romantic_ending: 'ğŸ’• ë¡œë§¨í‹± ì—”ë”©! ì•„ë¦„ë‹¤ìš´ ë¡œë§¨ìŠ¤ê°€ í”¼ì–´ë‚¬ì–´ìš”!',
                good_ending: 'ğŸ˜Š ì¢‹ì€ ì—”ë”©! ì†Œì¤‘í•œ ê´€ê³„ê°€ ë˜ì—ˆë„¤ìš”!',
                normal_ending: 'ğŸ™‚ í‰ë²”í•œ ì—”ë”©. ì¢‹ì€ ì¶”ì–µì´ ë˜ì—ˆì–´ìš”.',
                friend_ending: 'ğŸ˜Œ ì¹œêµ¬ ì—”ë”©. ì†Œì¤‘í•œ ìš°ì •ì´ ìƒê²¼ì–´ìš”!',
                bad_ending: 'ğŸ˜” ì•„ì‰¬ìš´ ì—”ë”©... ë‹¤ì‹œ ë„ì „í•´ë³´ì‹œê² ì–´ìš”?'
            };
            
            showTypingIndicator();
            setTimeout(() => {
                hideTypingIndicator();
                
                const endingMessage = endingMessages[ending] || 'ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
                const statsMessage = `
                    <div style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                        <div style="font-weight: bold; margin-bottom: 10px;">ğŸ“Š ìµœì¢… ê²°ê³¼</div>
                        <div>ìµœì¢… í˜¸ê°ë„: ${gameState.affection}/100</div>
                        <div>ìµœì¢… ì¹œë°€ë„: ${gameState.intimacy}/100</div>
                        <div>ìµœëŒ€ ì—°ì†ë³´ë„ˆìŠ¤: ${gameLogic.streakCount}íšŒ</div>
                        <div>ì´ ìƒí˜¸ì‘ìš©: ${debugInfo.totalInteractions}íšŒ</div>
                        <div>íŠ¹ë³„ ì´ë²¤íŠ¸: ${gameState.specialEvents.length}ê°œ</div>
                    </div>
                `;
                
                addCharacterMessage(endingMessage + statsMessage);
                
                // ì¬ì‹œì‘ ë²„íŠ¼
                setTimeout(() => {
                    const container = document.getElementById('choicesContainer');
                    container.innerHTML = `
                        <button class="choice-btn" onclick="location.reload()" style="background: #48bb78; border-color: #48bb78;">
                            ğŸ”„ ìƒˆ ê²Œì„ ì‹œì‘
                        </button>
                        <button class="choice-btn" onclick="showGameReport()" style="background: #667eea; border-color: #667eea;">
                            ğŸ“Š ìƒì„¸ ë¦¬í¬íŠ¸ ë³´ê¸°
                        </button>
                    `;
                    container.style.display = 'block';
                }, 2000);
            }, 1500);
        }

        function showGameReport() {
            const report = generateGameReport();
            addCharacterMessage(`
                <div style="font-size: 14px;">
                    <div style="font-weight: bold; margin-bottom: 10px;">ğŸ“ˆ ê²Œì„ ë¦¬í¬íŠ¸</div>
                    ${report}
                </div>
            `);
        }

        function generateGameReport() {
            const choiceHistory = gameState.choiceHistory || [];
            const freeInputHistory = gameState.freeInputHistory || [];
            
            const totalChoices = choiceHistory.length;
            const totalFreeInputs = freeInputHistory.length;
            const averageAffectionChange = totalChoices > 0 ? 
                (choiceHistory.reduce((sum, c) => sum + (c.finalChange || 0), 0) / totalChoices).toFixed(1) : 0;
            
            const emotionCounts = {};
            freeInputHistory.forEach(input => {
                emotionCounts[input.emotionType] = (emotionCounts[input.emotionType] || 0) + 1;
            });
            const mostUsedEmotion = Object.keys(emotionCounts).reduce((a, b) => 
                emotionCounts[a] > emotionCounts[b] ? a : b, 'none');
            
            return `
                <div style="line-height: 1.5;">
                    <div>â€¢ ì´ ì„ íƒ: ${totalChoices}íšŒ</div>
                    <div>â€¢ ììœ ì…ë ¥: ${totalFreeInputs}íšŒ</div>
                    <div>â€¢ í‰ê·  í˜¸ê°ë„ ë³€í™”: ${averageAffectionChange}</div>
                    <div>â€¢ ì£¼ìš” ê°ì • í‘œí˜„: ${mostUsedEmotion.toUpperCase()}</div>
                    <div>â€¢ ìµœëŒ€ ì—°ì† ë³´ë„ˆìŠ¤: ${gameLogic.streakCount}íšŒ</div>
                    <div>â€¢ ë‹¬ì„± íŠ¹ë³„ ì´ë²¤íŠ¸: ${gameState.specialEvents.length}ê°œ</div>
                </div>
            `;
        }

        // ğŸ› ï¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë° ì´ˆê¸°í™”
        document.addEventListener('keydown', function(e) {
            // ë””ë²„ê·¸ íŒ¨ë„ í† ê¸€ (Ctrl+Shift+D)
            if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                const debugPanel = document.getElementById('debugPanel');
                debugPanel.style.display = debugPanel.style.display === 'none' ? 'block' : 'none';
            }
            
            // ììœ ì…ë ¥ ëª¨ë“œì—ì„œ Ctrl+Enterë¡œ ì „ì†¡
            if (e.key === 'Enter' && e.ctrlKey && gameState.isFreeChatMode) {
                handleFreeInput();
            }
        });

        // ì´ˆê¸°í™”
        updateUI();
        updateDebugPanel();
        
        console.log(`
ğŸ® GameLogic í†µí•© ì™„ë£Œ! v3.0.0

âœ¨ ìƒˆë¡œìš´ ê¸°ëŠ¥:
- â±ï¸ ì‹œê°„ ë³´ë„ˆìŠ¤ (3ì´ˆ ì´ë‚´ +2, 5ì´ˆ ì´ë‚´ +1)
- ğŸ”„ ì—°ì† ë³´ë„ˆìŠ¤ (2ì—°ì† +1, 3ì—°ì† +2, 5ì—°ì† +3)
- ğŸ’¬ ê°ì • ë¶„ì„ ììœ ì…ë ¥ (ë¡œë§¨í‹±, ë°°ë ¤, ê¸ì •, ì¤‘ë¦½, ë¶€ì •)
- ğŸ’ ì¹œë°€ë„ ì‹œìŠ¤í…œ (í˜¸ê°ë„ì™€ ë³„ê°œ)
- âœ¨ íŠ¹ë³„ ì´ë²¤íŠ¸ (í˜¸ê°ë„ 80+, ì¹œë°€ë„ 85+)
- ğŸ¯ ë‹¨ê³„ë³„ ê°€ì¤‘ì¹˜ (ì´ˆê¸°â†’ë°œì „â†’ì‹¬í™”â†’ê²°ë§)

ğŸ› ï¸ ë‹¨ì¶•í‚¤:
- Ctrl+Shift+D: ë””ë²„ê·¸ íŒ¨ë„ í† ê¸€
- Ctrl+Enter: ììœ ì…ë ¥ ì „ì†¡

ğŸ¯ ì‹œì‘: ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì„ íƒí•˜ì„¸ìš”!
        `);
    </script>
</body>
</html>