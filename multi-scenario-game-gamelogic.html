<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÆ MBTI Î©îÏã†Ï†Ä Í≤åÏûÑ - GameLogic ÌÜµÌï© v3.0.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .chat-container {
            width: min(100vw, 400px);
            height: min(100vh, 800px);
            max-width: 400px;
            max-height: 800px;
            background: #000;
            border: 2px solid #333;
            border-radius: 25px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.1);
        }
        
        /* ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉù ÌôîÎ©¥ */
        .scenario-selection {
            flex: 1;
            padding: 40px 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .scenario-title {
            font-size: 24px;
            margin-bottom: 30px;
            text-align: center;
            color: #ff69b4;
        }
        .scenario-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 300px;
        }
        .scenario-button {
            background: #333;
            border: 2px solid #555;
            color: #fff;
            padding: 20px;
            border-radius: 15px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        .scenario-button:hover {
            background: #444;
            border-color: #ff69b4;
            transform: translateY(-2px);
        }
        
        /* Ï±ÑÌåÖ ÌôîÎ©¥ */
        .chat-header {
            background: #111;
            padding: 15px 20px;
            border-bottom: 1px solid #333;
            display: none;
            justify-content: space-between;
            align-items: center;
        }
        .contact-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .profile-pic {
            position: relative;
        }
        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid #ff69b4;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        .contact-name {
            font-size: 16px;
            font-weight: 600;
        }
        
        /* ÏÉàÎ°úÏö¥ ÌÜµÍ≥Ñ Î∞î */
        .enhanced-stats {
            background: rgba(255, 105, 180, 0.1);
            padding: 10px;
            display: flex;
            justify-content: space-between;
            font-size: 12px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-label {
            display: block;
            opacity: 0.7;
        }
        .stat-value {
            font-weight: bold;
            color: #ff69b4;
        }
        .progress-mini {
            width: 40px;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            margin-top: 2px;
        }
        .progress-fill-mini {
            height: 100%;
            background: #ff69b4;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        /* Î©îÏãúÏßÄ ÏòÅÏó≠ */
        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #000;
        }
        .message {
            margin-bottom: 15px;
            animation: messageSlideIn 0.3s ease;
        }
        @keyframes messageSlideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .character-message {
            background: #1a1a1a;
            color: #fff;
            padding: 15px;
            border-radius: 15px 15px 15px 5px;
            border: 1px solid #333;
            max-width: 85%;
        }
        .user-message {
            background: #ff69b4;
            color: #fff;
            padding: 15px;
            border-radius: 15px 15px 5px 15px;
            margin-left: auto;
            max-width: 85%;
            text-align: right;
        }
        
        .narration {
            font-style: italic;
            color: #888;
            font-size: 13px;
            margin-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-top: 8px;
        }
        
        /* ÌäπÎ≥Ñ Ïù¥Î≤§Ìä∏ Ïä§ÌÉÄÏùº */
        .special-event {
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            color: #333;
            padding: 15px;
            border-radius: 15px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
            animation: specialEventGlow 1s ease infinite alternate;
        }
        @keyframes specialEventGlow {
            from { box-shadow: 0 0 15px rgba(255, 107, 107, 0.5); }
            to { box-shadow: 0 0 25px rgba(255, 107, 107, 0.8); }
        }
        
        /* ÏÑ†ÌÉùÏßÄ ÏòÅÏó≠ */
        .choices {
            padding: 20px;
            background: #111;
            border-top: 1px solid #333;
            display: none;
        }
        .choice-btn {
            width: 100%;
            padding: 15px;
            margin: 8px 0;
            background: #222;
            border: 2px solid #444;
            color: #fff;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-size: 14px;
        }
        .choice-btn:hover:not(:disabled) {
            background: #333;
            border-color: #ff69b4;
            transform: translateX(5px);
        }
        .choice-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* ÏûêÏú†ÏûÖÎ†• ÏòÅÏó≠ */
        .input-container {
            padding: 20px;
            background: #111;
            border-top: 1px solid #333;
            display: none;
        }
        .free-input {
            width: 100%;
            padding: 15px;
            background: #222;
            border: 2px solid #444;
            color: #fff;
            border-radius: 10px;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }
        .input-btn {
            background: #48bb78;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px 5px 0 0;
            transition: all 0.3s ease;
        }
        .input-btn:hover:not(:disabled) {
            background: #38a169;
            transform: translateY(-1px);
        }
        .input-btn.cancel {
            background: #e53e3e;
        }
        .input-btn.cancel:hover {
            background: #c53030;
        }
        
        /* ÌÉÄÏù¥Ìïë Ïù∏ÎîîÏºÄÏù¥ÌÑ∞ */
        .typing-indicator {
            padding: 15px 20px;
            color: #888;
            font-style: italic;
            display: none;
            align-items: center;
            gap: 10px;
        }
        .typing-dots {
            display: flex;
            gap: 3px;
        }
        .typing-dot {
            width: 6px;
            height: 6px;
            background: #ff69b4;
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        .typing-dot:nth-child(3) { animation-delay: 0s; }
        
        @keyframes typingBounce {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        /* ÎîîÎ≤ÑÍ∑∏ Ìå®ÎÑê */
        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.9);
            color: #00ff00;
            padding: 15px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 11px;
            display: none;
            z-index: 9999;
            border: 1px solid #333;
            min-width: 200px;
        }
        .debug-section {
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #333;
        }
        .debug-title {
            color: #ff69b4;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        /* ÏßÑÌñâÎèÑ Î∞î */
        .progress-container {
            background: #111;
            padding: 10px 20px;
            border-top: 1px solid #333;
            display: none;
        }
        .progress-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff69b4, #667eea);
            transition: width 0.5s ease;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- ÏãúÎÇòÎ¶¨Ïò§ ÏÑ†ÌÉù ÌôîÎ©¥ -->
        <div id="scenarioSelection" class="scenario-selection">
            <div class="scenario-title">üíï Î°úÎß®Ïä§ Î©îÏã†Ï†Ä Í≤åÏûÑ</div>
            <div class="scenario-buttons">
                <button class="scenario-button" onclick="startScenario('hangover_confession')">
                    üç∑ Ïñ¥Ï†ú Î∞§Ïùò Í∏∞Ïñµ<br>
                    <small style="color: #888;">Ïà† Î®πÍ≥† Í≥†Î∞±Ìïú ÌõÑ Î∂ÄÎÅÑÎü¨ÏõåÌïòÎäî ÏÉÅÌô©</small>
                </button>
                <button class="scenario-button" onclick="startScenario('study_together')">
                    üìö Ìï®Íªò Í≥µÎ∂ÄÌïòÍ∏∞<br>
                    <small style="color: #888;">ÎèÑÏÑúÍ¥ÄÏóêÏÑú Í∞ôÏù¥ Í≥µÎ∂ÄÌïòÎäî ÏÉÅÌô©</small>
                </button>
            </div>
        </div>
        
        <!-- Ï±ÑÌåÖ Ìó§Îçî -->
        <div id="chatHeader" class="chat-header">
            <div class="contact-info">
                <div class="profile-pic">
                    <div class="avatar" id="characterAvatar">üé≠</div>
                </div>
                <div>
                    <div class="contact-name" id="characterName">Ïú§ÏïÑ</div>
                    <div style="font-size: 12px; color: #888;" id="characterStatus">INFP ‚Ä¢ Ïò®ÎùºÏù∏</div>
                </div>
            </div>
            <div style="font-size: 12px; color: #888;">
                <span id="progressText">1/36</span>
            </div>
        </div>
        
        <!-- Ìñ•ÏÉÅÎêú ÌÜµÍ≥Ñ Î∞î (GameLogic ÌÜµÌï©) -->
        <div id="enhancedStats" class="enhanced-stats" style="display: none;">
            <div class="stat-item">
                <span class="stat-label">Ìò∏Í∞êÎèÑ</span>
                <span class="stat-value" id="affectionStat">75</span>
                <div class="progress-mini">
                    <div class="progress-fill-mini" id="affectionProgress" style="width: 75%;"></div>
                </div>
            </div>
            <div class="stat-item">
                <span class="stat-label">ÏπúÎ∞ÄÎèÑ</span>
                <span class="stat-value" id="intimacyStat">20</span>
                <div class="progress-mini">
                    <div class="progress-fill-mini" id="intimacyProgress" style="width: 20%;"></div>
                </div>
            </div>
            <div class="stat-item">
                <span class="stat-label">Ïó∞ÏÜç</span>
                <span class="stat-value" id="streakStat">0</span>
                <div class="progress-mini">
                    <div class="progress-fill-mini" id="streakProgress" style="width: 0%;"></div>
                </div>
            </div>
            <div class="stat-item">
                <span class="stat-label">Îã®Í≥Ñ</span>
                <span class="stat-value" id="phaseStat">ÏãúÏûë</span>
            </div>
        </div>
        
        <!-- Î©îÏãúÏßÄ ÏòÅÏó≠ -->
        <div id="messagesContainer" class="messages" style="display: none;"></div>
        
        <!-- ÌÉÄÏù¥Ìïë Ïù∏ÎîîÏºÄÏù¥ÌÑ∞ -->
        <div id="typingIndicator" class="typing-indicator">
            <span id="typingText">Ïú§ÏïÑÎãòÏù¥ ÏûÖÎ†•Ï§ë</span>
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
        
        <!-- ÏÑ†ÌÉùÏßÄ ÏòÅÏó≠ -->
        <div id="choicesContainer" class="choices"></div>
        
        <!-- ÏûêÏú†ÏûÖÎ†• ÏòÅÏó≠ -->
        <div id="inputContainer" class="input-container">
            <div style="margin-bottom: 10px; color: #888; font-size: 14px;">
                üí¨ ÏûêÏú†Î°≠Í≤å ÎßàÏùåÏùÑ ÌëúÌòÑÌï¥Î≥¥ÏÑ∏Ïöî (4Î≤àÏß∏ÎßàÎã§ Îì±Ïû•)
            </div>
            <textarea id="freeInput" class="free-input" placeholder="Ïú§ÏïÑÏóêÍ≤å ÌïòÍ≥† Ïã∂ÏùÄ ÎßêÏùÑ ÏûêÏú†Î°≠Í≤å ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî..."></textarea>
            <div style="margin-top: 10px;">
                <button class="input-btn" onclick="handleFreeInput()">üíå Ï†ÑÏÜ°</button>
                <button class="input-btn cancel" onclick="cancelFreeInput()">‚ùå Ï∑®ÏÜå</button>
            </div>
        </div>
        
        <!-- ÏßÑÌñâÎèÑ Î∞î -->
        <div id="progressContainer" class="progress-container">
            <div class="progress-label">Í≤åÏûÑ ÏßÑÌñâÎèÑ</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
            </div>
        </div>
    </div>
    
    <!-- ÎîîÎ≤ÑÍ∑∏ Ìå®ÎÑê (GameLogic ÌÜµÌï©) -->
    <div id="debugPanel" class="debug-panel">
        <div class="debug-section">
            <div class="debug-title">üéÆ GameLogic v3.0.0</div>
            <div>Ìò∏Í∞êÎèÑ: <span id="debugAffection">75</span>/100</div>
            <div>ÏπúÎ∞ÄÎèÑ: <span id="debugIntimacy">20</span>/100</div>
            <div>ÏßÑÌñâÎèÑ: <span id="debugProgress">1</span>/36</div>
        </div>
        <div class="debug-section">
            <div class="debug-title">üéØ Î≥¥ÎÑàÏä§ ÏãúÏä§ÌÖú</div>
            <div>Ïó∞ÏÜç ÏÑ†ÌÉù: <span id="debugStreak">0</span>Ìöå</div>
            <div>ÌòÑÏû¨ Îã®Í≥Ñ: <span id="debugPhase">introduction</span></div>
            <div>Ï¥ù ÏÉÅÌò∏ÏûëÏö©: <span id="debugInteractions">0</span>Ìöå</div>
        </div>
        <div class="debug-section">
            <div class="debug-title">‚ú® ÌäπÎ≥Ñ Ïù¥Î≤§Ìä∏</div>
            <div id="debugEvents">ÏóÜÏùå</div>
        </div>
        <div style="margin-top: 10px; font-size: 10px; color: #666;">
            Ctrl+Shift+D: Ìå®ÎÑê ÌÜ†Í∏Ä<br>
            Ctrl+Enter: ÏûêÏú†ÏûÖÎ†• Ï†ÑÏÜ°
        </div>
    </div>

    <script>
        // üéÆ GameLogic Î™®Îìà ÏûÑÎ≤†Îìú (modules/GameLogic.js ÎÇ¥Ïö©)
        class GameLogic {
            constructor() {
                this.version = 'v3.0.0';
                
                this.affectionWeights = {
                    choice: 1.0,
                    freeInput: 1.5,
                    timeBonus: 0.1,
                    streakBonus: 0.2,
                    phaseMultiplier: {
                        introduction: 0.8,
                        development: 1.0,
                        deepening: 1.2,
                        conclusion: 1.5
                    }
                };
                
                this.emotionKeywords = {
                    positive: ['Ï¢ãÏïÑ', 'ÏÇ¨Îûë', 'ÏòàÏÅò', 'Î©ãÏ†∏', 'ÏôÑÎ≤Ω', 'ÏµúÍ≥†', 'ÌñâÎ≥µ', 'Í∏∞Îªê', 'Í∞êÎèô', 'Í≥†ÎßàÏõå', 'ÌõåÎ•≠', 'ÎåÄÎã®'],
                    romantic: ['ÏÑ§Î†à', 'ÎëêÍ∑º', 'ÏÇ¨ÎûëÌï¥', 'Ï¢ãÏïÑÌï¥', 'ÏòàÏÅòÎã§', 'Í∑ÄÏó¨Ïõå', 'Îß§Î†•Ï†Å', 'Ïö¥Î™Ö', 'ÏÜåÏ§ëÌï¥', 'ÌäπÎ≥ÑÌï¥'],
                    caring: ['Í±±Ï†ï', 'Ï±ôÍ≤®', 'Î≥¥ÏÇ¥Ìé¥', 'ÎèÑÏôÄÏ§ÑÍ≤å', 'Ìï®Íªò', 'Í≥ÅÏóê', 'ÏßÄÏºúÏ§ÑÍ≤å', 'ÏùëÏõê', 'ÌûòÎÇ¥', 'Í¥úÏ∞Æ'],
                    negative: ['Ïã´Ïñ¥', 'ÏßúÏ¶ù', 'ÌôîÎÇò', 'Î≥ÑÎ°ú', 'Í∑ÄÏ∞Æ', 'ÌîºÍ≥§', 'Ïä§Ìä∏Î†àÏä§', 'Ïã§Îßù', 'ÏÜçÏÉÅ', 'ÌôîÍ∞Ä'],
                    neutral: ['Í∑∏Îûò', 'ÏïåÍ≤†Ïñ¥', 'Ïùå', 'Í∑∏ÎÉ•', 'Î™®Î•¥Í≤†Ïñ¥', 'ÏÉÅÍ¥ÄÏóÜÏñ¥', 'Í¥úÏ∞ÆÏïÑ', 'Î≠ê', 'ÏïÑÎ¨¥ÎûòÎèÑ']
                };
                
                this.streakCount = 0;
                this.lastChoiceTime = null;
                this.totalInteractions = 0;
                this.specialEventCooldown = new Set();
                
                console.log('üéÆ GameLogic v3.0.0 Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
            }

            processChoice(choice, gameState) {
                const result = {
                    success: true,
                    affectionChange: 0,
                    intimacyChange: 0,
                    specialEvent: null,
                    message: '',
                    bonusDetails: {},
                    gameState: { ...gameState }
                };

                try {
                    const oldAffection = gameState.affection;
                    let baseAffectionChange = choice.affection_impact || 0;
                    
                    const currentPhase = this.getCurrentPhase(gameState.choiceNumber || 0);
                    const phaseMultiplier = this.affectionWeights.phaseMultiplier[currentPhase];
                    const timeBonus = this.calculateTimeBonus();
                    const streakBonus = this.calculateStreakBonus(baseAffectionChange);
                    
                    const adjustedBase = Math.round(baseAffectionChange * phaseMultiplier);
                    const totalAffectionChange = Math.round(
                        (adjustedBase * this.affectionWeights.choice) + 
                        timeBonus + 
                        streakBonus
                    );
                    
                    let intimacyChange = 0;
                    if (baseAffectionChange > 0) {
                        const intimacyChance = Math.min(0.5, 0.2 + (gameState.intimacy / 200));
                        intimacyChange = Math.random() < intimacyChance ? Math.floor(Math.random() * 2) + 1 : 0;
                    }
                    
                    result.gameState.affection = Math.max(-100, Math.min(100, 
                        gameState.affection + totalAffectionChange));
                    result.gameState.intimacy = Math.max(0, Math.min(100, 
                        gameState.intimacy + intimacyChange));
                    result.gameState.choiceNumber = (gameState.choiceNumber || 0) + 1;
                    
                    if (!result.gameState.choiceHistory) result.gameState.choiceHistory = [];
                    result.gameState.choiceHistory.push({
                        choice: choice.text,
                        baseImpact: choice.affection_impact,
                        finalChange: totalAffectionChange,
                        intimacyChange: intimacyChange,
                        bonuses: { time: timeBonus, streak: streakBonus, phase: phaseMultiplier },
                        phase: currentPhase,
                        timestamp: new Date().toISOString()
                    });
                    
                    result.affectionChange = totalAffectionChange;
                    result.intimacyChange = intimacyChange;
                    result.bonusDetails = {
                        base: adjustedBase,
                        time: timeBonus,
                        streak: streakBonus,
                        phase: currentPhase,
                        multiplier: phaseMultiplier
                    };
                    result.message = this.generateChoiceResultMessage(totalAffectionChange, intimacyChange);
                    result.specialEvent = this.checkSpecialEvents(result.gameState);
                    
                    this.totalInteractions++;
                    
                    console.log(`[GameLogic] ${oldAffection} ‚Üí ${result.gameState.affection} (${totalAffectionChange > 0 ? '+' : ''}${totalAffectionChange}) | Î≥¥ÎÑàÏä§: ÏãúÍ∞Ñ${timeBonus}, Ïó∞ÏÜç${streakBonus}`);
                    
                } catch (error) {
                    console.error('[GameLogic] ÏÑ†ÌÉùÏßÄ Ï≤òÎ¶¨ Ïò§Î•ò:', error);
                    result.success = false;
                    result.message = 'ÏÑ†ÌÉù Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
                }
                
                return result;
            }

            analyzeFreeInput(input, gameState) {
                const result = {
                    success: true,
                    affectionChange: 0,
                    intimacyChange: 0,
                    emotionType: 'neutral',
                    confidence: 0,
                    keywords: [],
                    message: '',
                    gameState: { ...gameState }
                };

                try {
                    const cleanInput = input.trim().toLowerCase();
                    const emotionAnalysis = this.analyzeEmotion(cleanInput);
                    
                    result.emotionType = emotionAnalysis.type;
                    result.confidence = emotionAnalysis.confidence;
                    result.keywords = emotionAnalysis.keywords;
                    
                    let affectionChange = this.calculateFreeInputAffection(emotionAnalysis);
                    const currentPhase = this.getCurrentPhase(gameState.choiceNumber || 0);
                    const phaseMultiplier = this.affectionWeights.phaseMultiplier[currentPhase];
                    
                    affectionChange = Math.round(affectionChange * this.affectionWeights.freeInput * phaseMultiplier);
                    
                    let intimacyChange = 0;
                    if (emotionAnalysis.confidence > 0.6) {
                        if (emotionAnalysis.type === 'romantic' || emotionAnalysis.type === 'caring') {
                            intimacyChange = Math.floor(Math.random() * 4) + 2;
                        } else if (emotionAnalysis.type === 'positive') {
                            intimacyChange = Math.floor(Math.random() * 2) + 1;
                        }
                    }
                    
                    result.gameState.affection = Math.max(-100, Math.min(100, 
                        gameState.affection + affectionChange));
                    result.gameState.intimacy = Math.max(0, Math.min(100, 
                        gameState.intimacy + intimacyChange));
                    
                    if (!result.gameState.freeInputHistory) result.gameState.freeInputHistory = [];
                    result.gameState.freeInputHistory.push({
                        input: input,
                        emotionType: emotionAnalysis.type,
                        confidence: emotionAnalysis.confidence,
                        affectionChange: affectionChange,
                        intimacyChange: intimacyChange,
                        timestamp: new Date().toISOString()
                    });
                    
                    result.affectionChange = affectionChange;
                    result.intimacyChange = intimacyChange;
                    result.message = this.generateInputResultMessage(emotionAnalysis, affectionChange, intimacyChange);
                    
                    console.log(`[GameLogic] ÏûêÏú†ÏûÖÎ†•: ${emotionAnalysis.type} (${(emotionAnalysis.confidence * 100).toFixed(1)}%) ‚Üí Ìò∏Í∞êÎèÑ ${affectionChange > 0 ? '+' : ''}${affectionChange}, ÏπúÎ∞ÄÎèÑ +${intimacyChange}`);
                    
                } catch (error) {
                    console.error('[GameLogic] ÏûêÏú†ÏûÖÎ†• Î∂ÑÏÑù Ïò§Î•ò:', error);
                    result.success = false;
                    result.message = 'ÏûÖÎ†• Î∂ÑÏÑù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
                }
                
                return result;
            }

            analyzeEmotion(text) {
                const emotions = { positive: 0, romantic: 0, caring: 0, negative: 0, neutral: 0 };
                const foundKeywords = [];
                let totalScore = 0;
                
                for (const [emotionType, keywords] of Object.entries(this.emotionKeywords)) {
                    for (const keyword of keywords) {
                        const keywordCount = (text.match(new RegExp(keyword, 'g')) || []).length;
                        if (keywordCount > 0) {
                            emotions[emotionType] += keywordCount;
                            totalScore += keywordCount;
                            foundKeywords.push({ word: keyword, type: emotionType, count: keywordCount });
                        }
                    }
                }
                
                const maxEmotion = Object.keys(emotions).reduce((a, b) => 
                    emotions[a] > emotions[b] ? a : b
                );
                
                const textLength = text.length;
                const keywordDensity = totalScore / Math.max(textLength / 10, 1);
                const confidence = Math.min(1.0, keywordDensity + (foundKeywords.length * 0.2));
                
                return { type: maxEmotion, confidence, keywords: foundKeywords, scores: emotions };
            }

            calculateFreeInputAffection(emotionAnalysis) {
                const baseValues = { romantic: 12, caring: 8, positive: 5, neutral: 0, negative: -4 };
                const baseValue = baseValues[emotionAnalysis.type] || 0;
                const confidenceMultiplier = Math.max(0.3, emotionAnalysis.confidence);
                const densityBonus = emotionAnalysis.keywordDensity > 0.5 ? 1.2 : 1.0;
                return Math.round(baseValue * confidenceMultiplier * densityBonus);
            }

            calculateTimeBonus() {
                if (!this.lastChoiceTime) {
                    this.lastChoiceTime = Date.now();
                    return 0;
                }
                
                const timeDiff = Date.now() - this.lastChoiceTime;
                this.lastChoiceTime = Date.now();
                
                if (timeDiff < 3000) return 2;
                if (timeDiff < 5000) return 1;
                if (timeDiff > 30000) return -1;
                return 0;
            }

            calculateStreakBonus(affectionChange) {
                if (affectionChange > 0) {
                    this.streakCount += 1;
                } else if (affectionChange < 0) {
                    this.streakCount = 0;
                }
                
                if (this.streakCount >= 5) return 3;
                if (this.streakCount >= 3) return 2;
                if (this.streakCount >= 2) return 1;
                return 0;
            }

            checkSpecialEvents(gameState) {
                if (!gameState.specialEvents) gameState.specialEvents = [];
                
                if (gameState.affection >= 90 && !this.specialEventCooldown.has('perfect_chemistry')) {
                    this.specialEventCooldown.add('perfect_chemistry');
                    gameState.specialEvents.push('perfect_chemistry');
                    return {
                        type: 'perfect_chemistry',
                        message: 'üíñ ÏôÑÎ≤ΩÌïú ÏºÄÎØ∏Ïä§Ìä∏Î¶¨! ÎßàÏùåÏù¥ ÏôÑÏ†ÑÌûà ÌÜµÌñàÏñ¥Ïöî!',
                        bonus: { affection: 5, intimacy: 15 }
                    };
                } else if (gameState.affection >= 80 && !this.specialEventCooldown.has('high_affection')) {
                    this.specialEventCooldown.add('high_affection');
                    gameState.specialEvents.push('high_affection');
                    return {
                        type: 'high_affection',
                        message: 'üíï ÌäπÎ≥ÑÌïú ÏàúÍ∞ÑÏù¥ ÏãúÏûëÎê©ÎãàÎã§...',
                        bonus: { affection: 3, intimacy: 8 }
                    };
                }
                
                if (gameState.intimacy >= 85 && !this.specialEventCooldown.has('deep_bond')) {
                    this.specialEventCooldown.add('deep_bond');
                    gameState.specialEvents.push('deep_bond');
                    return {
                        type: 'deep_bond',
                        message: 'ü§ó ÍπäÏùÄ Ïú†ÎåÄÍ∞êÏù¥ ÌòïÏÑ±ÎêòÏóàÏäµÎãàÎã§!',
                        bonus: { affection: 5, intimacy: 10 }
                    };
                }
                
                return null;
            }

            getCurrentPhase(choiceNumber) {
                if (choiceNumber <= 9) return 'introduction';
                if (choiceNumber <= 18) return 'development';
                if (choiceNumber <= 27) return 'deepening';
                return 'conclusion';
            }

            determineEnding(gameState) {
                const { affection, intimacy } = gameState;
                if (affection >= 90 && intimacy >= 85) return 'perfect_ending';
                if (affection >= 80 && intimacy >= 70) return 'romantic_ending';
                if (affection >= 70 && intimacy >= 50) return 'good_ending';
                if (affection >= 50) return 'normal_ending';
                if (affection >= 20) return 'friend_ending';
                return 'bad_ending';
            }

            generateChoiceResultMessage(affectionChange, intimacyChange) {
                if (affectionChange >= 8) return 'üíù ÎßàÏùåÏù¥ ÏôÑÏ†ÑÌûà ÎÖπÏïòÏñ¥Ïöî!';
                if (affectionChange >= 5) return 'üíó ÎßàÏùåÏù¥ ÎßéÏù¥ Îî∞ÎúªÌï¥Ï°åÏñ¥Ïöî!';
                if (affectionChange >= 3) return 'üòä Ï†ïÎßê Ï¢ãÏùÄ Î∞òÏùëÏù¥ÏóêÏöî!';
                if (affectionChange >= 1) return 'üòå Ìò∏Í∞êÎèÑÍ∞Ä Ïò¨ÎûêÏñ¥Ïöî.';
                if (affectionChange === 0) return 'üòê ÌèâÎ≤îÌïú Î∞òÏùëÏù¥ÏóêÏöî.';
                if (affectionChange >= -2) return 'üòÖ Ï°∞Í∏à ÏïÑÏâ¨Ïö¥ ÏÑ†ÌÉùÏù¥ÏóàÏñ¥Ïöî.';
                return 'üòî ÎßàÏùåÏù¥ Ï¢Ä Î©ÄÏñ¥ÏßÑ Í≤É Í∞ôÏïÑÏöî...';
            }

            generateInputResultMessage(emotionAnalysis, affectionChange, intimacyChange) {
                const messages = {
                    romantic: ['üíï Î°úÎß®Ìã±Ìïú ÎßêÏóê ÎßàÏùåÏù¥ ÏôÑÏ†ÑÌûà ÏÑ§Î†àÎÑ§Ïöî!', 'üíñ Í∑∏Îü∞ Îßê Îì§ÏúºÎãàÍπå Ï†ïÎßê ÌñâÎ≥µÌï¥Ïöî!'],
                    caring: ['ü§ó Îî∞ÎúªÌïú ÎßàÏùåÏù¥ Ï†ïÎßê Í∞êÎèôÏù¥ÏóêÏöî!', 'üòä Ïò§Îπ†Ïùò Î∞∞Î†§Í∞Ä ÎäêÍª¥Ï†∏ÏÑú Í≥†ÎßàÏõåÏöî!'],
                    positive: ['üòä Í∏çÏ†ïÏ†ÅÏù∏ ÏóêÎÑàÏßÄÍ∞Ä Ï†ÑÌï¥Ï†∏Ïöî!', '‚ú® Î∞ùÏùÄ ÎßàÏùåÏù¥ Ï¢ãÏïÑÏöî!'],
                    neutral: ['üòå Ï∞®Î∂ÑÌïú ÎåÄÌôîÍ∞Ä Ìé∏ÏïàÌï¥Ïöî.', 'üôÇ ÏßÑÏÜîÌïú ÎßàÏùåÏù¥ ÎäêÍª¥Ï†∏Ïöî.'],
                    negative: ['üòî Ï°∞Í∏à ÏïÑÏâ¨Ïö¥ Í∏∞Î∂ÑÏù¥ÏóêÏöî...', 'üòï Î¨¥Ïñ∏Í∞Ä ÏÑúÏö¥Ìïú ÎäêÎÇåÏù¥ Îì§Ïñ¥Ïöî.']
                };
                
                const emotionMessages = messages[emotionAnalysis.type] || messages.neutral;
                return emotionMessages[Math.floor(Math.random() * emotionMessages.length)];
            }

            validateInput(input) {
                if (!input || typeof input !== 'string') return { valid: false, reason: 'Ïò¨Î∞îÎ•∏ ÏûÖÎ†•Ïù¥ ÏïÑÎãôÎãàÎã§.' };
                const trimmedInput = input.trim();
                if (trimmedInput.length === 0) return { valid: false, reason: 'ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.' };
                if (trimmedInput.length > 500) return { valid: false, reason: 'ÏûÖÎ†•Ïù¥ ÎÑàÎ¨¥ ÍπÅÎãàÎã§. (ÏµúÎåÄ 500Ïûê)' };
                if (trimmedInput.length < 2) return { valid: false, reason: 'Ï¢Ä Îçî ÏûêÏÑ∏Ìûà ÎßêÌï¥Ï£ºÏÑ∏Ïöî.' };
                return { valid: true };
            }

            getDebugInfo(gameState) {
                return {
                    version: this.version,
                    affection: gameState.affection || 0,
                    intimacy: gameState.intimacy || 0,
                    choiceNumber: gameState.choiceNumber || 0,
                    streakCount: this.streakCount,
                    currentPhase: this.getCurrentPhase(gameState.choiceNumber || 0),
                    totalInteractions: this.totalInteractions,
                    specialEvents: gameState.specialEvents || [],
                    expectedEnding: this.determineEnding(gameState)
                };
            }
        }

        // üéØ Í≤åÏûÑ ÏÉÅÌÉú Î∞è Ï¥àÍ∏∞Ìôî
        const gameLogic = new GameLogic();
        let gameState = {
            currentScenario: null,
            currentCharacter: null,
            affection: 75,
            intimacy: 20,
            choiceNumber: 0,
            messageCount: 0,
            choiceHistory: [],
            freeInputHistory: [],
            specialEvents: [],
            isProcessing: false,
            isFreeChatMode: false
        };

        // ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞ (Í∏∞Ï°¥ ÌîÑÎ°úÏ†ùÌä∏ Ìò∏Ìôò)
        const scenarios = {
            hangover_confession: {
                id: "hangover_confession",
                title: "Ïñ¥Ï†ú Î∞§Ïùò Í∏∞Ïñµ",
                description: "Ïà† Î®πÍ≥† Í≥†Î∞±Ìïú ÌõÑ Î∂ÄÎÅÑÎü¨ÏõåÌïòÎäî ÏÉÅÌô©",
                character: { name: "Ïú§ÏïÑ", mbti: "INFP", avatar: "üé≠" },
                dialogues: [
                    {
                        dialogue: "Ïò§Îπ†... Ïñ¥Ï†úÎäî Ï†ïÎßê ÎØ∏ÏïàÌï¥ üò≥ Ï∑®Ìï¥ÏÑú Í∑∏Îü∞ ÎßêÍπåÏßÄ ÌñàÎäîÎç∞...",
                        narration: "Ïú§ÏïÑÍ∞Ä ÏñºÍµ¥ÏùÑ Î∂âÌûàÎ©∞ ÏÜêÏúºÎ°ú ÏñºÍµ¥ÏùÑ Í∞ÄÎ¶∞Îã§.",
                        choices: [
                            {text: "Í¥úÏ∞ÆÎã§Í≥† Îã§Ï†ïÌïòÍ≤å ÎßêÌï¥Ï§ÄÎã§", affection_impact: 3},
                            {text: "Ïñ¥Îñ§ ÎßêÏùÑ ÌñàÎäîÏßÄ Í∂ÅÍ∏àÌïòÎã§Í≥† ÌïúÎã§", affection_impact: 1},
                            {text: "Ïûò Í∏∞Ïñµ Ïïà ÎÇòÎÑ§...", affection_impact: -1}
                        ]
                    },
                    {
                        dialogue: "Í∑∏ÎûòÎèÑ... ÏßÑÏã¨Ïù¥ÏóàÏñ¥ üòä Ïò§Îπ†ÌïúÌÖåÎßå ÎßêÌï† Ïàò ÏûàÎäî Í±∞Ïïº",
                        narration: "Ïú§ÏïÑÍ∞Ä ÏàòÏ§çÍ≤å ÎØ∏ÏÜåÏßÄÏúºÎ©∞ Í≥†Í∞úÎ•º ÎÅÑÎçïÏù∏Îã§.",
                        choices: [
                            {text: "ÎÇòÎèÑ Ìï≠ÏÉÅ ÎÑàÎ•º ÏÉùÍ∞ÅÌï¥ÏôîÏñ¥", affection_impact: 4},
                            {text: "Í∑∏Îü∞ ÎßàÏùå Î∞õÏïÑÏ§ÑÍ≤å", affection_impact: 2},
                            {text: "Í≥†ÎßàÏõå, Ïûò ÏÉùÍ∞ÅÌï¥Î≥ºÍ≤å", affection_impact: 0}
                        ]
                    },
                    {
                        dialogue: "ÏÇ¨Ïã§... Ïò§Îπ†Î•º Ï¢ãÏïÑÌïú ÏßÄ 1ÎÖÑÏù¥ ÎÑòÏóàÏñ¥ üíó",
                        narration: "Ïú§ÏïÑÍ∞Ä Ïö©Í∏∞Î•º ÎÇ¥Ïñ¥ ÏûêÏã†Ïùò ÎßàÏùåÏùÑ ÌÑ∏Ïñ¥ÎÜìÎäîÎã§.",
                        choices: [
                            {text: "Ïôú ÏßÑÏûë ÎßêÌïòÏßÄ ÏïäÏïòÏñ¥?", affection_impact: 2},
                            {text: "ÎÇòÎèÑ ÎààÏπòÏ±ÑÍ≥† ÏûàÏóàÏñ¥", affection_impact: 3},
                            {text: "Í∑∏Îû¨Íµ¨ÎÇò...", affection_impact: 0}
                        ]
                    },
                    {
                        dialogue: "Ïù¥Ï†úÏïº ÌõÑÎ†®Ìï¥ üòå Í≥ÑÏÜç Ïà®Í∏∞Í∏∞Îßå ÌñàÎäîÎç∞...",
                        narration: "Ïú§ÏïÑÏùò ÌëúÏ†ïÏù¥ Î∞ùÏïÑÏßÄÎ©∞ ÏïàÎèÑÏùò ÌïúÏà®ÏùÑ Ïâ∞Îã§.",
                        choices: [
                            {text: "ÏïûÏúºÎ°ú Îçî Í∞ÄÍπåÏõåÏßÄÏûê", affection_impact: 3},
                            {text: "Ïö©Í∏∞ÎÇ¥Ï§òÏÑú Í≥†ÎßàÏõå", affection_impact: 2},
                            {text: "Ï¢ãÏùÄ ÏπúÍµ¨Î°ú ÏßÄÎÇ¥Ïûê", affection_impact: -1}
                        ]
                    }
                ]
            },
            study_together: {
                id: "study_together",
                title: "Ìï®Íªò Í≥µÎ∂ÄÌïòÍ∏∞",
                description: "ÎèÑÏÑúÍ¥ÄÏóêÏÑú Í∞ôÏù¥ Í≥µÎ∂ÄÌïòÎäî ÏÉÅÌô©",
                character: { name: "Ïú§ÏïÑ", mbti: "INFP", avatar: "üìö" },
                dialogues: [
                    {
                        dialogue: "Ïò§Îπ†, Ïó¨Í∏∞ ÏïâÏïÑÎèÑ Îê†ÍπåÏöî? üòä",
                        narration: "Ïú§ÏïÑÍ∞Ä Ï±ÖÏùÑ Îì§Í≥† Ï°∞Ïã¨Ïä§ÎüΩÍ≤å Îã§Í∞ÄÏò®Îã§.",
                        choices: [
                            {text: "Î¨ºÎ°†Ïù¥ÏßÄ, Í∞ôÏù¥ Í≥µÎ∂ÄÌïòÏûê", affection_impact: 2},
                            {text: "ÎÑ§, ÏïâÏúºÏÑ∏Ïöî", affection_impact: 1},
                            {text: "Îã§Î•∏ ÏûêÎ¶¨Îäî ÏóÜÎÇòÏöî?", affection_impact: -1}
                        ]
                    }
                ]
            }
        };

        // üéÆ Í≤åÏûÑ ÌïµÏã¨ Ìï®ÏàòÎì§ (GameLogic ÌÜµÌï©)
        function startScenario(scenarioId) {
            const scenario = scenarios[scenarioId];
            if (!scenario) {
                console.error('ÏãúÎÇòÎ¶¨Ïò§Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§:', scenarioId);
                return;
            }
            
            gameState.currentScenario = scenario;
            gameState.currentCharacter = scenario.character;
            gameState.choiceNumber = 0;
            gameState.messageCount = 0;
            
            // UI Ï†ÑÌôò
            document.getElementById('scenarioSelection').style.display = 'none';
            document.getElementById('chatHeader').style.display = 'flex';
            document.getElementById('enhancedStats').style.display = 'flex';
            document.getElementById('messagesContainer').style.display = 'block';
            document.getElementById('progressContainer').style.display = 'block';
            
            // Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('characterName').textContent = scenario.character.name;
            document.getElementById('characterAvatar').textContent = scenario.character.avatar;
            
            updateUI();
            
            // Ï≤´ Î≤àÏß∏ ÎåÄÌôî ÏãúÏûë
            setTimeout(() => {
                startNextDialogue();
            }, 1000);
            
            console.log(`üé¨ ÏãúÎÇòÎ¶¨Ïò§ ÏãúÏûë: ${scenario.title}`);
        }

        function startNextDialogue() {
            if (gameState.choiceNumber >= 36) {
                endGame();
                return;
            }
            
            const scenario = gameState.currentScenario;
            const dialogueIndex = gameState.messageCount % scenario.dialogues.length;
            const dialogue = scenario.dialogues[dialogueIndex];
            
            showTypingIndicator();
            
            setTimeout(() => {
                hideTypingIndicator();
                addCharacterMessage(dialogue.dialogue, dialogue.narration);
                
                // 4Î≤àÏß∏ÎßàÎã§ ÏûêÏú†ÏûÖÎ†• Î™®Îìú
                if ((gameState.choiceNumber + 1) % 4 === 0) {
                    showFreeInputMode();
                } else {
                    showChoices(dialogue.choices);
                }
                
                gameState.messageCount++;
            }, Math.random() * 1500 + 1000);
        }

        function handleChoice(choice) {
            if (gameState.isProcessing) return;
            
            gameState.isProcessing = true;
            disableAllButtons();
            
            // ÏÇ¨Ïö©Ïûê ÏÑ†ÌÉù ÌëúÏãú
            addUserMessage(choice.text);
            
            // GameLogic Î™®ÎìàÎ°ú ÏÑ†ÌÉù Ï≤òÎ¶¨
            const result = gameLogic.processChoice(choice, gameState);
            
            if (result.success) {
                gameState = result.gameState;
                
                // ÌäπÎ≥Ñ Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨
                if (result.specialEvent) {
                    setTimeout(() => {
                        showSpecialEvent(result.specialEvent);
                        
                        // Î≥¥ÎÑàÏä§ Ï†ÅÏö©
                        if (result.specialEvent.bonus) {
                            if (result.specialEvent.bonus.affection) {
                                gameState.affection = Math.min(100, gameState.affection + result.specialEvent.bonus.affection);
                            }
                            if (result.specialEvent.bonus.intimacy) {
                                gameState.intimacy = Math.min(100, gameState.intimacy + result.specialEvent.bonus.intimacy);
                            }
                        }
                        updateUI();
                    }, 1500);
                }
                
                updateUI();
                updateDebugPanel();
                
                // Îã§Ïùå ÎåÄÌôîÎ°ú ÏßÑÌñâ
                setTimeout(() => {
                    startNextDialogue();
                    gameState.isProcessing = false;
                }, 2000);
                
            } else {
                console.error('ÏÑ†ÌÉù Ï≤òÎ¶¨ Ïã§Ìå®:', result.message);
                gameState.isProcessing = false;
                enableAllButtons();
            }
        }

        function handleFreeInput() {
            const input = document.getElementById('freeInput').value;
            const validation = gameLogic.validateInput(input);
            
            if (!validation.valid) {
                alert(validation.reason);
                return;
            }
            
            if (gameState.isProcessing) return;
            gameState.isProcessing = true;
            
            // ÏÇ¨Ïö©Ïûê ÏûÖÎ†• ÌëúÏãú
            addUserMessage(input);
            
            // GameLogic Î™®ÎìàÎ°ú ÏûêÏú†ÏûÖÎ†• Î∂ÑÏÑù
            const result = gameLogic.analyzeFreeInput(input, gameState);
            
            if (result.success) {
                gameState = result.gameState;
                updateUI();
                updateDebugPanel();
                
                // Î∂ÑÏÑù Í≤∞Í≥º ÌëúÏãú
                showTypingIndicator();
                setTimeout(() => {
                    hideTypingIndicator();
                    
                    const analysisMessage = `${result.message}`;
                    const detailMessage = `
                        <div style="font-size: 11px; color: #666; margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 5px;">
                            üß† Í∞êÏ†ïÎ∂ÑÏÑù: ${result.emotionType.toUpperCase()} (${(result.confidence * 100).toFixed(1)}%)
                            ${result.affectionChange !== 0 ? ` | Ìò∏Í∞êÎèÑ ${result.affectionChange > 0 ? '+' : ''}${result.affectionChange}` : ''}
                            ${result.intimacyChange !== 0 ? ` | ÏπúÎ∞ÄÎèÑ +${result.intimacyChange}` : ''}
                            ${result.keywords.length > 0 ? ` | ÌÇ§ÏõåÎìú: ${result.keywords.map(k => k.word).join(', ')}` : ''}
                        </div>
                    `;
                    
                    addCharacterMessage(analysisMessage + detailMessage);
                    
                    // Îã§Ïùå ÎåÄÌôîÎ°ú ÏßÑÌñâ
                    setTimeout(() => {
                        startNextDialogue();
                        gameState.isProcessing = false;
                        hideFreeInputMode();
                    }, 2000);
                }, 2000);
                
            } else {
                console.error('ÏûêÏú†ÏûÖÎ†• Î∂ÑÏÑù Ïã§Ìå®:', result.message);
                gameState.isProcessing = false;
            }
        }

        // üé® UI Í¥ÄÎ¶¨ Ìï®ÏàòÎì§
        function updateUI() {
            // Ìò∏Í∞êÎèÑ ÏóÖÎç∞Ïù¥Ìä∏ (ÏùåÏàò Ìè¨Ìï® Í≥ÑÏÇ∞)
            const affectionPercent = Math.max(0, (gameState.affection + 100) / 2);
            document.getElementById('affectionStat').textContent = gameState.affection;
            document.getElementById('affectionProgress').style.width = `${affectionPercent}%`;
            
            // ÏπúÎ∞ÄÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('intimacyStat').textContent = gameState.intimacy;
            document.getElementById('intimacyProgress').style.width = `${gameState.intimacy}%`;
            
            // Ïó∞ÏÜç Î≥¥ÎÑàÏä§ ÏóÖÎç∞Ïù¥Ìä∏
            const streakPercent = Math.min(100, (gameLogic.streakCount / 5) * 100);
            document.getElementById('streakStat').textContent = gameLogic.streakCount;
            document.getElementById('streakProgress').style.width = `${streakPercent}%`;
            
            // Í≤åÏûÑ Îã®Í≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
            const phaseNames = {
                introduction: 'ÏãúÏûë',
                development: 'Î∞úÏ†Ñ',
                deepening: 'Ïã¨Ìôî',
                conclusion: 'Í≤∞Îßê'
            };
            document.getElementById('phaseStat').textContent = phaseNames[gameLogic.getCurrentPhase(gameState.choiceNumber)];
            
            // ÏßÑÌñâÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
            const progressPercent = (gameState.choiceNumber / 36) * 100;
            document.getElementById('progressFill').style.width = `${progressPercent}%`;
            document.getElementById('progressText').textContent = `${gameState.choiceNumber}/36`;
        }

        function updateDebugPanel() {
            const debugInfo = gameLogic.getDebugInfo(gameState);
            
            document.getElementById('debugAffection').textContent = debugInfo.affection;
            document.getElementById('debugIntimacy').textContent = debugInfo.intimacy;
            document.getElementById('debugProgress').textContent = debugInfo.choiceNumber;
            document.getElementById('debugStreak').textContent = debugInfo.streakCount;
            document.getElementById('debugPhase').textContent = debugInfo.currentPhase;
            document.getElementById('debugInteractions').textContent = debugInfo.totalInteractions;
            
            const eventsText = debugInfo.specialEvents.length > 0 ? 
                debugInfo.specialEvents.join(', ') : 'ÏóÜÏùå';
            document.getElementById('debugEvents').textContent = eventsText;
        }

        function addCharacterMessage(dialogue, narration = '') {
            const messagesContainer = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.innerHTML = `
                <div class="character-message">
                    ${dialogue}
                    ${narration ? `<div class="narration">${narration}</div>` : ''}
                </div>
            `;
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        function addUserMessage(text) {
            const messagesContainer = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.innerHTML = `<div class="user-message">${text}</div>`;
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        function showSpecialEvent(event) {
            const messagesContainer = document.getElementById('messagesContainer');
            const eventDiv = document.createElement('div');
            eventDiv.innerHTML = `
                <div class="special-event">
                    <div style="font-size: 16px; margin-bottom: 8px;">${event.message}</div>
                    <div style="font-size: 12px;">
                        ${event.bonus.affection ? `Ìò∏Í∞êÎèÑ +${event.bonus.affection}` : ''}
                        ${event.bonus.intimacy ? ` ÏπúÎ∞ÄÎèÑ +${event.bonus.intimacy}` : ''}
                    </div>
                </div>
            `;
            messagesContainer.appendChild(eventDiv);
            scrollToBottom();
        }

        function showChoices(choices) {
            const container = document.getElementById('choicesContainer');
            container.innerHTML = '';
            container.style.display = 'block';
            
            choices.forEach((choice, index) => {
                const button = document.createElement('button');
                button.className = 'choice-btn';
                button.onclick = () => handleChoice(choice);
                
                const emojis = ['üíï', 'üòä', 'ü§î', 'üòî'];
                const impactText = choice.affection_impact > 0 ? ` (+${choice.affection_impact})` : 
                                  choice.affection_impact < 0 ? ` (${choice.affection_impact})` : '';
                
                button.innerHTML = `${emojis[index] || 'üí¨'} ${choice.text}${impactText}`;
                container.appendChild(button);
            });
        }

        function showFreeInputMode() {
            document.getElementById('choicesContainer').style.display = 'none';
            document.getElementById('inputContainer').style.display = 'block';
            document.getElementById('freeInput').value = '';
            document.getElementById('freeInput').focus();
            gameState.isFreeChatMode = true;
        }

        function hideFreeInputMode() {
            document.getElementById('choicesContainer').style.display = 'block';
            document.getElementById('inputContainer').style.display = 'none';
            gameState.isFreeChatMode = false;
        }

        function cancelFreeInput() {
            hideFreeInputMode();
            // Îã§Ïùå ÎåÄÌôîÎ°ú Î∞îÎ°ú ÏßÑÌñâ
            setTimeout(() => {
                startNextDialogue();
            }, 500);
        }

        function showTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'flex';
            scrollToBottom();
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            container.scrollTop = container.scrollHeight;
        }

        function disableAllButtons() {
            const buttons = document.querySelectorAll('.choice-btn, .input-btn');
            buttons.forEach(btn => btn.disabled = true);
        }

        function enableAllButtons() {
            const buttons = document.querySelectorAll('.choice-btn, .input-btn');
            buttons.forEach(btn => btn.disabled = false);
        }

        function endGame() {
            const ending = gameLogic.determineEnding(gameState);
            const debugInfo = gameLogic.getDebugInfo(gameState);
            
            const endingMessages = {
                perfect_ending: 'üíñ ÏôÑÎ≤ΩÌïú ÏóîÎî©! ÏßÑÏ†ïÌïú ÏÇ¨ÎûëÏù¥ ÏãúÏûëÎê©ÎãàÎã§! ‚ú®',
                romantic_ending: 'üíï Î°úÎß®Ìã± ÏóîÎî©! ÏïÑÎ¶ÑÎã§Ïö¥ Î°úÎß®Ïä§Í∞Ä ÌîºÏñ¥ÎÇ¨Ïñ¥Ïöî!',
                good_ending: 'üòä Ï¢ãÏùÄ ÏóîÎî©! ÏÜåÏ§ëÌïú Í¥ÄÍ≥ÑÍ∞Ä ÎêòÏóàÎÑ§Ïöî!',
                normal_ending: 'üôÇ ÌèâÎ≤îÌïú ÏóîÎî©. Ï¢ãÏùÄ Ï∂îÏñµÏù¥ ÎêòÏóàÏñ¥Ïöî.',
                friend_ending: 'üòå ÏπúÍµ¨ ÏóîÎî©. ÏÜåÏ§ëÌïú Ïö∞Ï†ïÏù¥ ÏÉùÍ≤ºÏñ¥Ïöî!',
                bad_ending: 'üòî ÏïÑÏâ¨Ïö¥ ÏóîÎî©... Îã§Ïãú ÎèÑÏ†ÑÌï¥Î≥¥ÏãúÍ≤†Ïñ¥Ïöî?'
            };
            
            showTypingIndicator();
            setTimeout(() => {
                hideTypingIndicator();
                
                const endingMessage = endingMessages[ending] || 'Í≤åÏûÑÏù¥ Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§.';
                const statsMessage = `
                    <div style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                        <div style="font-weight: bold; margin-bottom: 10px;">üìä ÏµúÏ¢Ö Í≤∞Í≥º</div>
                        <div>ÏµúÏ¢Ö Ìò∏Í∞êÎèÑ: ${gameState.affection}/100</div>
                        <div>ÏµúÏ¢Ö ÏπúÎ∞ÄÎèÑ: ${gameState.intimacy}/100</div>
                        <div>ÏµúÎåÄ Ïó∞ÏÜçÎ≥¥ÎÑàÏä§: ${gameLogic.streakCount}Ìöå</div>
                        <div>Ï¥ù ÏÉÅÌò∏ÏûëÏö©: ${debugInfo.totalInteractions}Ìöå</div>
                        <div>ÌäπÎ≥Ñ Ïù¥Î≤§Ìä∏: ${gameState.specialEvents.length}Í∞ú</div>
                    </div>
                `;
                
                addCharacterMessage(endingMessage + statsMessage);
                
                // Ïû¨ÏãúÏûë Î≤ÑÌäº
                setTimeout(() => {
                    const container = document.getElementById('choicesContainer');
                    container.innerHTML = `
                        <button class="choice-btn" onclick="location.reload()" style="background: #48bb78; border-color: #48bb78;">
                            üîÑ ÏÉà Í≤åÏûÑ ÏãúÏûë
                        </button>
                        <button class="choice-btn" onclick="showGameReport()" style="background: #667eea; border-color: #667eea;">
                            üìä ÏÉÅÏÑ∏ Î¶¨Ìè¨Ìä∏ Î≥¥Í∏∞
                        </button>
                    `;
                    container.style.display = 'block';
                }, 2000);
            }, 1500);
        }

        function showGameReport() {
            const report = generateGameReport();
            addCharacterMessage(`
                <div style="font-size: 14px;">
                    <div style="font-weight: bold; margin-bottom: 10px;">üìà Í≤åÏûÑ Î¶¨Ìè¨Ìä∏</div>
                    ${report}
                </div>
            `);
        }

        function generateGameReport() {
            const choiceHistory = gameState.choiceHistory || [];
            const freeInputHistory = gameState.freeInputHistory || [];
            
            const totalChoices = choiceHistory.length;
            const totalFreeInputs = freeInputHistory.length;
            const averageAffectionChange = totalChoices > 0 ? 
                (choiceHistory.reduce((sum, c) => sum + (c.finalChange || 0), 0) / totalChoices).toFixed(1) : 0;
            
            const emotionCounts = {};
            freeInputHistory.forEach(input => {
                emotionCounts[input.emotionType] = (emotionCounts[input.emotionType] || 0) + 1;
            });
            const mostUsedEmotion = Object.keys(emotionCounts).reduce((a, b) => 
                emotionCounts[a] > emotionCounts[b] ? a : b, 'none');
            
            return `
                <div style="line-height: 1.5;">
                    <div>‚Ä¢ Ï¥ù ÏÑ†ÌÉù: ${totalChoices}Ìöå</div>
                    <div>‚Ä¢ ÏûêÏú†ÏûÖÎ†•: ${totalFreeInputs}Ìöå</div>
                    <div>‚Ä¢ ÌèâÍ∑† Ìò∏Í∞êÎèÑ Î≥ÄÌôî: ${averageAffectionChange}</div>
                    <div>‚Ä¢ Ï£ºÏöî Í∞êÏ†ï ÌëúÌòÑ: ${mostUsedEmotion.toUpperCase()}</div>
                    <div>‚Ä¢ ÏµúÎåÄ Ïó∞ÏÜç Î≥¥ÎÑàÏä§: ${gameLogic.streakCount}Ìöå</div>
                    <div>‚Ä¢ Îã¨ÏÑ± ÌäπÎ≥Ñ Ïù¥Î≤§Ìä∏: ${gameState.specialEvents.length}Í∞ú</div>
                </div>
            `;
        }

        // üõ†Ô∏è Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Î∞è Ï¥àÍ∏∞Ìôî
        document.addEventListener('keydown', function(e) {
            // ÎîîÎ≤ÑÍ∑∏ Ìå®ÎÑê ÌÜ†Í∏Ä (Ctrl+Shift+D)
            if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                const debugPanel = document.getElementById('debugPanel');
                debugPanel.style.display = debugPanel.style.display === 'none' ? 'block' : 'none';
            }
            
            // ÏûêÏú†ÏûÖÎ†• Î™®ÎìúÏóêÏÑú Ctrl+EnterÎ°ú Ï†ÑÏÜ°
            if (e.key === 'Enter' && e.ctrlKey && gameState.isFreeChatMode) {
                handleFreeInput();
            }
        });

        // Ï¥àÍ∏∞Ìôî
        updateUI();
        updateDebugPanel();
        
        console.log(`
üéÆ GameLogic ÌÜµÌï© ÏôÑÎ£å! v3.0.0

‚ú® ÏÉàÎ°úÏö¥ Í∏∞Îä•:
- ‚è±Ô∏è ÏãúÍ∞Ñ Î≥¥ÎÑàÏä§ (3Ï¥à Ïù¥ÎÇ¥ +2, 5Ï¥à Ïù¥ÎÇ¥ +1)
- üîÑ Ïó∞ÏÜç Î≥¥ÎÑàÏä§ (2Ïó∞ÏÜç +1, 3Ïó∞ÏÜç +2, 5Ïó∞ÏÜç +3)
- üí¨ Í∞êÏ†ï Î∂ÑÏÑù ÏûêÏú†ÏûÖÎ†• (Î°úÎß®Ìã±, Î∞∞Î†§, Í∏çÏ†ï, Ï§ëÎ¶Ω, Î∂ÄÏ†ï)
- üíù ÏπúÎ∞ÄÎèÑ ÏãúÏä§ÌÖú (Ìò∏Í∞êÎèÑÏôÄ Î≥ÑÍ∞ú)
- ‚ú® ÌäπÎ≥Ñ Ïù¥Î≤§Ìä∏ (Ìò∏Í∞êÎèÑ 80+, ÏπúÎ∞ÄÎèÑ 85+)
- üéØ Îã®Í≥ÑÎ≥Ñ Í∞ÄÏ§ëÏπò (Ï¥àÍ∏∞‚ÜíÎ∞úÏ†Ñ‚ÜíÏã¨Ìôî‚ÜíÍ≤∞Îßê)

üõ†Ô∏è Îã®Ï∂ïÌÇ§:
- Ctrl+Shift+D: ÎîîÎ≤ÑÍ∑∏ Ìå®ÎÑê ÌÜ†Í∏Ä
- Ctrl+Enter: ÏûêÏú†ÏûÖÎ†• Ï†ÑÏÜ°

üéØ ÏãúÏûë: ÏãúÎÇòÎ¶¨Ïò§Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî!
        `);
    </script>
</body>
</html>