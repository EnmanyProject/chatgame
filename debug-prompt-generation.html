<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI í”„ë¡¬í”„íŠ¸ ìƒì„± ê²€ì¦ ë„êµ¬</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .section {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .character-data {
            background: #e8f4fd;
            border-left-color: #1976d2;
        }
        .generated-prompt {
            background: #f3e5f5;
            border-left-color: #8e24aa;
        }
        .analysis {
            background: #fff3e0;
            border-left-color: #f57c00;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        pre {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .field-match {
            background: #d4edda;
            padding: 8px;
            margin: 4px 0;
            border-radius: 4px;
            border-left: 3px solid #28a745;
        }
        .field-missing {
            background: #f8d7da;
            padding: 8px;
            margin: 4px 0;
            border-radius: 4px;
            border-left: 3px solid #dc3545;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #667eea;
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .comparison-table th, .comparison-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
            vertical-align: top;
        }
        .comparison-table th {
            background: #667eea;
            color: white;
        }
        .comparison-table tr:nth-child(even) {
            background: #f9f9f9;
        }
        .match-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .match-yes { background: #d4edda; color: #155724; }
        .match-partial { background: #fff3cd; color: #856404; }
        .match-no { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” AI í”„ë¡¬í”„íŠ¸ ìƒì„± ì •í™•ë„ ê²€ì¦ ë„êµ¬</h1>
        <p>ìºë¦­í„° ë°ì´í„°ì™€ ìƒì„±ëœ AI í”„ë¡¬í”„íŠ¸ ê°„ì˜ ì¼ì¹˜ë„ë¥¼ ìƒì„¸ ë¶„ì„í•©ë‹ˆë‹¤.</p>

        <div class="section">
            <h3>ğŸ¯ í…ŒìŠ¤íŠ¸ ì„¤ì •</h3>
            <label for="characterSelect">ìºë¦­í„° ì„ íƒ:</label>
            <select id="characterSelect">
                <option value="">ìºë¦­í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
            </select>

            <label for="promptStyle">í”„ë¡¬í”„íŠ¸ ìŠ¤íƒ€ì¼:</label>
            <select id="promptStyle">
                <option value="comprehensive">ì¢…í•©í˜•</option>
                <option value="roleplay">ë¡¤í”Œë ˆì´í˜•</option>
                <option value="psychological">ì‹¬ë¦¬ë¶„ì„í˜•</option>
            </select>

            <button onclick="runAccuracyTest()">ğŸ” ì •í™•ë„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
            <button onclick="loadCharacterList()">ğŸ”„ ìºë¦­í„° ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
        </div>

        <div id="results" style="display: none;">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="accuracyScore">-</div>
                    <div>ì •í™•ë„ ì ìˆ˜</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="fieldsMatched">-</div>
                    <div>ë§¤ì¹­ëœ í•„ë“œ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalFields">-</div>
                    <div>ì „ì²´ í•„ë“œ</div>
                </div>
            </div>

            <div class="section character-data">
                <h3>ğŸ“‹ ì›ë³¸ ìºë¦­í„° ë°ì´í„°</h3>
                <pre id="originalData"></pre>
            </div>

            <div class="section generated-prompt">
                <h3>ğŸ¤– ìƒì„±ëœ AI í”„ë¡¬í”„íŠ¸</h3>
                <pre id="generatedPrompt"></pre>
            </div>

            <div class="section analysis">
                <h3>ğŸ“Š ìƒì„¸ ë¶„ì„ ê²°ê³¼</h3>
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>í•„ë“œ</th>
                            <th>ì›ë³¸ ë°ì´í„°</th>
                            <th>í”„ë¡¬í”„íŠ¸ ë°˜ì˜</th>
                            <th>ë§¤ì¹­ ìƒíƒœ</th>
                        </tr>
                    </thead>
                    <tbody id="analysisTable">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let characters = {};

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìºë¦­í„° ëª©ë¡ ë¡œë“œ
        window.addEventListener('load', loadCharacterList);

        async function loadCharacterList() {
            try {
                console.log('ğŸ“‹ ìºë¦­í„° ëª©ë¡ ë¡œë“œ ì¤‘...');
                const response = await fetch('/api/character-ai-generator?action=list_characters&_t=' + Date.now());
                const result = await response.json();

                console.log('ğŸ“¥ API ì‘ë‹µ:', result);

                if (result.success) {
                    characters = result.characters || result.data?.characters || {};

                    const select = document.getElementById('characterSelect');
                    select.innerHTML = '<option value="">ìºë¦­í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';

                    Object.entries(characters).forEach(([id, character]) => {
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = `${character.basic_info?.name || id} (${character.basic_info?.mbti || 'MBTIë¯¸ì •'})`;
                        select.appendChild(option);
                    });

                    console.log(`âœ… ${Object.keys(characters).length}ê°œ ìºë¦­í„° ë¡œë“œ ì™„ë£Œ`);
                } else {
                    throw new Error(result.message || 'ìºë¦­í„° ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('âŒ ìºë¦­í„° ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ìºë¦­í„° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }

        async function runAccuracyTest() {
            const selectedCharacterId = document.getElementById('characterSelect').value;
            const promptStyle = document.getElementById('promptStyle').value;

            if (!selectedCharacterId) {
                alert('ìºë¦­í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const character = characters[selectedCharacterId];
            if (!character) {
                alert('ì„ íƒí•œ ìºë¦­í„° ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            try {
                console.log('ğŸ” ì •í™•ë„ í…ŒìŠ¤íŠ¸ ì‹œì‘...');

                // ë²„íŠ¼ ë¹„í™œì„±í™”
                const testButton = document.querySelector('button[onclick="runAccuracyTest()"]');
                testButton.disabled = true;
                testButton.innerHTML = '<span class="loading"></span> ë¶„ì„ ì¤‘...';

                // AI í”„ë¡¬í”„íŠ¸ ìƒì„±
                const generatedPrompt = await generatePromptForTest(character, promptStyle);

                // ê²°ê³¼ ë¶„ì„
                const analysis = analyzePromptAccuracy(character, generatedPrompt);

                // ê²°ê³¼ í‘œì‹œ
                displayResults(character, generatedPrompt, analysis);

                console.log('âœ… ì •í™•ë„ í…ŒìŠ¤íŠ¸ ì™„ë£Œ');

            } catch (error) {
                console.error('âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
                alert('í…ŒìŠ¤íŠ¸ ì‹¤í–‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                // ë²„íŠ¼ ë³µì›
                const testButton = document.querySelector('button[onclick="runAccuracyTest()"]');
                testButton.disabled = false;
                testButton.innerHTML = 'ğŸ” ì •í™•ë„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰';
            }
        }

        async function generatePromptForTest(character, style) {
            const response = await fetch('/api/character-ai-generator', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'generate_character_prompt',
                    character_data: character,
                    model: 'gpt-4',
                    style: style,
                    length: 'medium',
                    system_prompt: `ìºë¦­í„° ì •ë³´ë¥¼ ì •í™•íˆ ë°˜ì˜í•˜ì—¬ í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.`
                })
            });

            const result = await response.json();

            if (result.success && result.prompt) {
                return result.prompt;
            } else {
                throw new Error(result.error || 'í”„ë¡¬í”„íŠ¸ ìƒì„± ì‹¤íŒ¨');
            }
        }

        function analyzePromptAccuracy(character, prompt) {
            const analysis = {
                matches: [],
                misses: [],
                accuracyScore: 0
            };

            // ë¶„ì„í•  í•„ë“œë“¤ ì •ì˜ - ì „ì²´ 55ê°œ í•„ë“œ
            const fieldsToCheck = [
                // ğŸ“‹ ê¸°ë³¸ ì •ë³´ (5ê°œ)
                { path: 'basic_info.name', label: 'ì´ë¦„', getValue: (c) => c.basic_info?.name },
                { path: 'basic_info.age', label: 'ë‚˜ì´', getValue: (c) => c.basic_info?.age },
                { path: 'basic_info.mbti', label: 'MBTI', getValue: (c) => c.basic_info?.mbti },
                { path: 'basic_info.occupation', label: 'ì§ì—…', getValue: (c) => c.basic_info?.occupation },
                { path: 'basic_info.gender', label: 'ì„±ë³„', getValue: (c) => c.basic_info?.gender },

                // âœ¨ ë§¤ë ¥ í”„ë¡œí•„ (8ê°œ)
                { path: 'appeal_profile.seduction_style', label: 'ë§¤ë ¥ ìŠ¤íƒ€ì¼', getValue: (c) => c.appeal_profile?.seduction_style },
                { path: 'appeal_profile.charm_points', label: 'ë§¤ë ¥ í¬ì¸íŠ¸', getValue: (c) => c.appeal_profile?.charm_points?.join(', ') },
                { path: 'appeal_profile.emotional_intelligence', label: 'ê°ì •ì§€ëŠ¥', getValue: (c) => c.appeal_profile?.emotional_intelligence },
                { path: 'appeal_profile.confidence_level', label: 'ìì‹ ê°', getValue: (c) => c.appeal_profile?.confidence_level },
                { path: 'appeal_profile.mystery_factor', label: 'ì‹ ë¹„ë¡œì›€', getValue: (c) => c.appeal_profile?.mystery_factor },
                { path: 'appeal_profile.sexual_curiosity', label: 'ì„±ì  í˜¸ê¸°ì‹¬', getValue: (c) => c.appeal_profile?.sexual_curiosity },
                { path: 'appeal_profile.sexual_comfort', label: 'ì„±ì  í¸ì•ˆí•¨', getValue: (c) => c.appeal_profile?.sexual_comfort },
                { path: 'appeal_profile.hobbies', label: 'ì·¨ë¯¸', getValue: (c) => c.appeal_profile?.hobbies?.join(', ') },

                // ğŸ‘„ ì™¸ëª¨ì  ë§¤ë ¥ (9ê°œ)
                { path: 'physical_allure.appearance.hair', label: 'í—¤ì–´ìŠ¤íƒ€ì¼', getValue: (c) => c.physical_allure?.appearance?.hair },
                { path: 'physical_allure.appearance.eyes', label: 'ëˆˆ', getValue: (c) => c.physical_allure?.appearance?.eyes },
                { path: 'physical_allure.appearance.body', label: 'ì²´í˜•', getValue: (c) => c.physical_allure?.appearance?.body },
                { path: 'physical_allure.appearance.bust', label: 'ê°€ìŠ´ ì‚¬ì´ì¦ˆ', getValue: (c) => c.physical_allure?.appearance?.bust },
                { path: 'physical_allure.appearance.waist_hip', label: 'í—ˆë¦¬/í™', getValue: (c) => c.physical_allure?.appearance?.waist_hip },
                { path: 'physical_allure.appearance.style', label: 'ìŠ¤íƒ€ì¼', getValue: (c) => c.physical_allure?.appearance?.style },
                { path: 'physical_allure.feature_elements', label: 'íŠ¹ì§•ì  ìš”ì†Œ', getValue: (c) => c.physical_allure?.feature_elements?.join(', ') },
                { path: 'physical_allure.sensual_habits', label: 'ê°ê°ì  ìŠµê´€', getValue: (c) => c.physical_allure?.sensual_habits?.join(', ') },
                { path: 'physical_allure.body_language', label: 'ë°”ë””ë­ê·€ì§€', getValue: (c) => c.physical_allure?.body_language?.join(', ') },

                // ğŸ§  ì‹¬ë¦¬ì  ê¹Šì´ (6ê°œ)
                { path: 'psychological_depth.core_desires', label: 'í•µì‹¬ ìš•êµ¬', getValue: (c) => c.psychological_depth?.core_desires?.join(', ') },
                { path: 'psychological_depth.vulnerabilities', label: 'ì·¨ì•½ì ', getValue: (c) => c.psychological_depth?.vulnerabilities?.join(', ') },
                { path: 'psychological_depth.values', label: 'ê°€ì¹˜ê´€', getValue: (c) => c.psychological_depth?.values },
                { path: 'psychological_depth.sexual_freedom', label: 'ì„±ì  ììœ ë„', getValue: (c) => c.psychological_depth?.sexual_freedom },
                { path: 'psychological_depth.boundaries.comfort_level', label: 'í¸ì•ˆí•¨ ìˆ˜ì¤€', getValue: (c) => c.psychological_depth?.boundaries?.comfort_level },
                { path: 'psychological_depth.boundaries.escalation_pace', label: 'ë°œì „ ì†ë„', getValue: (c) => c.psychological_depth?.boundaries?.escalation_pace },
                { path: 'psychological_depth.boundaries.sexual_tone_band', label: 'ì„±ì  í†¤', getValue: (c) => c.psychological_depth?.boundaries?.sexual_tone_band },

                // ğŸ’¬ ëŒ€í™” ì—­í•™ (9ê°œ)
                { path: 'conversation_dynamics.speech_style', label: 'ë§íˆ¬', getValue: (c) => c.conversation_dynamics?.speech_style },
                { path: 'conversation_dynamics.flirting_patterns', label: 'í”ŒëŸ¬íŒ… íŒ¨í„´', getValue: (c) => c.conversation_dynamics?.flirting_patterns?.join(', ') },
                { path: 'conversation_dynamics.conversation_hooks', label: 'ëŒ€í™” ì£¼ì œ', getValue: (c) => c.conversation_dynamics?.conversation_hooks?.join(', ') },
                { path: 'conversation_dynamics.speech_habits', label: 'ë§ ìŠµê´€', getValue: (c) => c.conversation_dynamics?.speech_habits?.join(', ') },
                { path: 'conversation_dynamics.vocabulary_register', label: 'ì–´íœ˜ ìˆ˜ì¤€', getValue: (c) => c.conversation_dynamics?.vocabulary_register },
                { path: 'conversation_dynamics.allowed_motifs', label: 'í—ˆìš© ëª¨í‹°í”„', getValue: (c) => c.conversation_dynamics?.allowed_motifs?.join(', ') },
                { path: 'conversation_dynamics.forbidden_terms', label: 'ê¸ˆê¸° ë‹¨ì–´', getValue: (c) => c.conversation_dynamics?.forbidden_terms?.join(', ') },
                { path: 'conversation_dynamics.reaction_tendencies.humor', label: 'ìœ ë¨¸ ë°˜ì‘', getValue: (c) => c.conversation_dynamics?.reaction_tendencies?.humor },
                { path: 'conversation_dynamics.reaction_tendencies.compliment', label: 'ì¹­ì°¬ ë°˜ì‘', getValue: (c) => c.conversation_dynamics?.reaction_tendencies?.compliment },
                { path: 'conversation_dynamics.reaction_tendencies.interest_expression', label: 'ê´€ì‹¬ í‘œí˜„', getValue: (c) => c.conversation_dynamics?.reaction_tendencies?.interest_expression },

                // ğŸ’• ê³¼ê±° ê²½í—˜ (4ê°œ)
                { path: 'past_history.boyfriend_count', label: 'ë‚¨ìì¹œêµ¬ ìˆ˜', getValue: (c) => c.past_history?.boyfriend_count },
                { path: 'past_history.preferred_skinship', label: 'ì„ í˜¸ ìŠ¤í‚¨ì‹­', getValue: (c) => c.past_history?.preferred_skinship?.join(', ') },
                { path: 'past_history.relationship_experience', label: 'ì—°ì•  ê²½í—˜', getValue: (c) => c.past_history?.relationship_experience },
                { path: 'past_history.first_experience_age', label: 'ì²« ê²½í—˜ ë‚˜ì´', getValue: (c) => c.past_history?.first_experience_age },

                // ğŸ ê¸°íƒ€ ì •ë³´ (4ê°œ)
                { path: 'favorite_gifts', label: 'ì¢‹ì•„í•˜ëŠ” ì„ ë¬¼', getValue: (c) => c.favorite_gifts?.join(', ') },
                { path: 'male_priorities', label: 'ë‚¨ì„± ìš°ì„ ìˆœìœ„', getValue: (c) => c.male_priorities?.join(', ') },
                { path: 'future_goals.asset_goal', label: 'ìì‚° ëª©í‘œ', getValue: (c) => c.future_goals?.asset_goal },
                { path: 'future_goals.future_careers', label: 'ë¯¸ë˜ ì§ì—…', getValue: (c) => c.future_goals?.future_careers?.join(', ') || 'ì—†ìŒ' }
            ];

            let totalMatches = 0;
            const promptLower = prompt.toLowerCase();

            fieldsToCheck.forEach(field => {
                const value = field.getValue(character);
                if (value) {
                    const valueStr = String(value).toLowerCase();
                    let matchStatus = 'no';

                    if (promptLower.includes(valueStr)) {
                        matchStatus = 'yes';
                        totalMatches++;
                    } else {
                        // ë¶€ë¶„ ë§¤ì¹­ ê²€ì‚¬ (ë²ˆì—­ëœ ë‚´ìš©ì´ë‚˜ ìœ ì‚¬ í‘œí˜„)
                        const words = valueStr.split(/[,\s]+/).filter(w => w.length > 1);
                        const partialMatches = words.filter(word => promptLower.includes(word));
                        if (partialMatches.length > 0) {
                            matchStatus = 'partial';
                            totalMatches += 0.5;
                        }
                    }

                    analysis[matchStatus === 'no' ? 'misses' : 'matches'].push({
                        field: field.label,
                        originalValue: value,
                        matchStatus: matchStatus,
                        inPrompt: matchStatus !== 'no'
                    });
                }
            });

            analysis.accuracyScore = Math.round((totalMatches / fieldsToCheck.length) * 100);
            return analysis;
        }

        function displayResults(character, prompt, analysis) {
            // í†µê³„ í‘œì‹œ
            document.getElementById('accuracyScore').textContent = analysis.accuracyScore + '%';
            document.getElementById('fieldsMatched').textContent = Math.floor(analysis.accuracyScore * 41 / 100);
            document.getElementById('totalFields').textContent = '41';

            // ì›ë³¸ ë°ì´í„° í‘œì‹œ
            document.getElementById('originalData').textContent = JSON.stringify(character, null, 2);

            // ìƒì„±ëœ í”„ë¡¬í”„íŠ¸ í‘œì‹œ
            document.getElementById('generatedPrompt').textContent = prompt;

            // ë¶„ì„ í…Œì´ë¸” í‘œì‹œ
            const tableBody = document.getElementById('analysisTable');
            tableBody.innerHTML = '';

            [...analysis.matches, ...analysis.misses].forEach(item => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${item.field}</td>
                    <td>${item.originalValue}</td>
                    <td>${item.inPrompt ? 'âœ… ë°˜ì˜ë¨' : 'âŒ ë°˜ì˜ì•ˆë¨'}</td>
                    <td><span class="match-status match-${item.matchStatus}">${
                        item.matchStatus === 'yes' ? 'ì™„ì „ë§¤ì¹­' :
                        item.matchStatus === 'partial' ? 'ë¶€ë¶„ë§¤ì¹­' : 'ë§¤ì¹­ì•ˆë¨'
                    }</span></td>
                `;
            });

            // ê²°ê³¼ ì„¹ì…˜ í‘œì‹œ
            document.getElementById('results').style.display = 'block';
        }
    </script>
</body>
</html>