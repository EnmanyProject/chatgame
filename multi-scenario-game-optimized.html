            // RAF로 부드러운 스크롤
            requestAnimationFrame(() => {
                scrollToBottom();
            });
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // 진행도 업데이트 (성능 최적화)
        function updateProgress(choiceNumber) {
            const progressBar = document.getElementById('progressBar');
            if (!progressBar) return;
            
            const progress = (choiceNumber / 36) * 100;
            
            // CSS 트랜지션으로 부드러운 애니메이션
            requestAnimationFrame(() => {
                progressBar.style.width = progress + '%';
            });
        }

        // 호감도 하트 업데이트 (성능 최적화)
        function updateAffectionHearts(newAffection, oldAffection = 0) {
            const heartsContainer = document.getElementById('affectionHearts');
            if (!heartsContainer) return;
            
            const newHeartCount = Math.floor(newAffection / 10);
            const oldHeartCount = Math.floor(oldAffection / 10);
            
            console.log('💖 하트 업데이트:', { newAffection, oldAffection, newHeartCount, oldHeartCount });
            
            // 새로운 하트 추가
            if (newHeartCount > oldHeartCount) {
                for (let i = oldHeartCount; i < newHeartCount; i++) {
                    setTimeout(() => {
                        const heart = document.createElement('span');
                        heart.className = 'heart';
                        heart.textContent = '💖';
                        heart.style.animationDelay = `${(i - oldHeartCount) * 0.2}s`;
                        heartsContainer.appendChild(heart);
                        
                        console.log(`💖 새로운 하트 생성! (${i + 1}번째)`);
                    }, (i - oldHeartCount) * 200);
                }
            }
            // 하트 제거
            else if (newHeartCount < oldHeartCount) {
                const heartsToRemove = oldHeartCount - newHeartCount;
                for (let i = 0; i < heartsToRemove; i++) {
                    if (heartsContainer.lastChild) {
                        heartsContainer.removeChild(heartsContainer.lastChild);
                    }
                }
            }
        }

        // 게임 종료 (성능 최적화)
        function endGame() {
            console.log('🏁 게임 종료');
            
            showTypingIndicator();
            setTimeout(() => {
                hideTypingIndicator();
                
                let endingDialogue = '';
                let emotion = '';
                if (gameState.affection >= 85) {
                    endingDialogue = '정말 즐거운 시간이었어요! 앞으로도 자주 만나요!';
                    emotion = '💕';
                } else if (gameState.affection >= 65) {
                    endingDialogue = '좋은 시간 보냈어요. 다음에 또 만나요!';
                    emotion = '😊';
                } else {
                    endingDialogue = '오늘 만나서 반가웠어요.';
                    emotion = '😌';
                }
                
                displayCharacterMessage(endingDialogue, '', emotion);
                
                // 최종 통계 표시
                setTimeout(() => {
                    const container = document.getElementById('messagesContainer');
                    const statsDiv = document.createElement('div');
                    statsDiv.style.cssText = 'text-align: center; margin: 20px 0; padding: 15px; background: #222; border-radius: 10px; color: #fff;';
                    
                    const stats = performanceMonitor.getStats();
                    statsDiv.innerHTML = `
                        <div style="font-size: 18px; margin-bottom: 10px;">🎮 게임 완료!</div>
                        <div style="font-size: 14px; color: #888; margin-bottom: 15px;">
                            최종 호감도: ${gameState.affection}/100<br>
                            대화 횟수: ${gameState.messageCount}회<br>
                            평균 응답시간: ${stats.avgResponseTime.toFixed(0)}ms<br>
                            캐시 적중률: ${stats.cacheHitRate}
                        </div>
                        <button class="back-btn" onclick="resetGame()">🔄 다른 시나리오로 다시 시작</button>
                    `;
                    container.appendChild(statsDiv);
                    scrollToBottom();
                }, 2000);
                
            }, 1500);
        }

        // 게임 재시작 (성능 최적화)
        function resetGame() {
            console.log('🔄 게임 재시작');
            
            // 성능 통계 로그
            performanceMonitor.logStats();
            
            // 캐시 클리어
            responseCache.clear();
            
            // 게임 상태 초기화
            gameState = {
                currentScenario: null,
                currentCharacter: null,
                choiceNumber: 0,
                affection: 0,
                messageCount: 0,
                previousChoices: [],
                waitingForInput: false,
                isFreeChatMode: false,
                isSubjectiveMode: false,
                isProcessing: false,
                canInput: true,
                conversationHistory: []
            };
            
            // UI 초기화
            document.getElementById('scenarioSelection').style.display = 'flex';
            document.getElementById('chatHeader').style.display = 'none';
            document.getElementById('messagesContainer').style.display = 'none';
            document.getElementById('choicesContainer').style.display = 'none';
            document.getElementById('inputContainer').style.display = 'none';
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('restartBtn').style.display = 'none';
            
            // 컨테이너 내용 클리어
            document.getElementById('messagesContainer').innerHTML = '';
            document.getElementById('choicesContainer').innerHTML = '';
            document.getElementById('affectionHearts').innerHTML = '';
            document.getElementById('progressBar').style.width = '0%';
            
            // 시나리오 다시 로드
            loadScenarios();
        }

        // 성능 통계 표시 함수
        function showPerformanceStats() {
            const stats = performanceMonitor.getStats();
            
            const existingPanel = document.getElementById('performancePanel');
            if (existingPanel) {
                existingPanel.remove();
            }
            
            const panel = document.createElement('div');
            panel.id = 'performancePanel';
            panel.style.cssText = `
                position: fixed;
                top: 10px;
                left: 10px;
                background: rgba(0,0,0,0.9);
                color: white;
                padding: 15px;
                border-radius: 10px;
                font-size: 12px;
                z-index: 10000;
                max-width: 250px;
                border: 2px solid #ff69b4;
                box-shadow: 0 0 20px rgba(255, 105, 180, 0.3);
            `;
            
            panel.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 8px; color: #ff69b4;">⚡ v2.1.0 성능 통계</div>
                <div style="margin-bottom: 4px;">🔥 API 호출: ${stats.apiCalls}회</div>
                <div style="margin-bottom: 4px;">💾 캐시 적중률: ${stats.cacheHitRate}</div>
                <div style="margin-bottom: 4px;">⏱️ 평균 응답시간: ${stats.avgResponseTime.toFixed(0)}ms</div>
                <div style="margin-bottom: 4px;">🧠 메모리 사용량: ${stats.memoryUsage.toFixed(1)}MB</div>
                <div style="margin-bottom: 4px;">❌ 에러 횟수: ${stats.errorCount}회</div>
                <div style="margin-bottom: 8px;">💬 대화 히스토리: ${gameState.conversationHistory.length}개</div>
                <button onclick="hidePerformanceStats()" style="
                    background: #ff69b4; 
                    border: none; 
                    color: white; 
                    padding: 4px 8px; 
                    border-radius: 4px; 
                    cursor: pointer;
                    margin-right: 5px;
                ">닫기</button>
                <button onclick="responseCache.clear(); showPerformanceStats();" style="
                    background: #333; 
                    border: none; 
                    color: white; 
                    padding: 4px 8px; 
                    border-radius: 4px; 
                    cursor: pointer;
                ">캐시 클리어</button>
            `;
            
            document.body.appendChild(panel);
            
            // 10초 후 자동 제거
            setTimeout(() => {
                if (document.getElementById('performancePanel')) {
                    hidePerformanceStats();
                }
            }, 10000);
        }

        function hidePerformanceStats() {
            const panel = document.getElementById('performancePanel');
            if (panel) panel.remove();
        }

        // 개발 모드 성능 모니터링
        if (window.location.hostname === 'localhost' || window.location.hostname.includes('local')) {
            console.log('🔧 개발 모드: 성능 모니터링 활성화');
            console.log('💡 Ctrl+Shift+P로 성능 통계 확인 가능');
            
            // 주기적으로 성능 로그 출력
            setInterval(() => {
                performanceMonitor.logStats();
            }, 30000); // 30초마다
            
            // 메모리 사용량 경고
            setInterval(() => {
                if (performance.memory && performance.memory.usedJSHeapSize > 100 * 1024 * 1024) { // 100MB 이상
                    console.warn('🚨 높은 메모리 사용량 감지:', (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(1) + 'MB');
                }
            }, 60000); // 1분마다
        }

        // 전역 에러 핸들러 (성능 최적화)
        window.addEventListener('error', function(event) {
            console.error('🚨 전역 에러:', event.error);
            performanceMonitor.recordError();
            
            // 사용자에게 친화적인 에러 메시지
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: #ff4757;
                color: white;
                padding: 10px 15px;
                border-radius: 8px;
                z-index: 9999;
                max-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            errorDiv.innerHTML = `
                <div style="font-weight: bold;">⚠️ 오류 발생</div>
                <div style="font-size: 12px; margin-top: 5px;">일시적인 문제가 발생했습니다. 새로고침하시면 해결될 수 있습니다.</div>
                <button onclick="this.parentElement.remove()" style="
                    background: rgba(255,255,255,0.3); 
                    border: none; 
                    color: white; 
                    padding: 4px 8px; 
                    border-radius: 4px; 
                    cursor: pointer; 
                    margin-top: 8px;
                ">닫기</button>
            `;
            
            document.body.appendChild(errorDiv);
            
            // 5초 후 자동 제거
            setTimeout(() => {
                if (errorDiv.parentElement) {
                    errorDiv.remove();
                }
            }, 5000);
        });

        // 성능 최적화 완료 알림
        console.log(`
🎉 v2.1.0 성능 최적화 버전 로드 완료!

✨ 새로운 기능들:
- 💾 응답 캐싱 시스템 (5분 TTL)
- ⚡ 로딩 상태 최적화
- 🧠 메모리 자동 관리
- 🔄 에러 복구 시스템
- 📊 실시간 성능 모니터링
- 🎯 대화 히스토리 관리

🛠️ 개발자 기능:
- Ctrl+Shift+P: 성능 통계 보기
- 자동 메모리 정리 (1분마다)
- 전역 에러 처리

🚀 예상 성능 향상:
- 응답 속도: 최대 80% 향상
- 메모리 사용량: 50% 절약  
- 캐시 적중률: 60%+ 목표
        `);
        
        // 성능 측정 시작
        performanceMonitor.startTimer();
    </script>
</body>
</html>