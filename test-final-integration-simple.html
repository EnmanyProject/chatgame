<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>🧪 최종 통합 테스트 v2.2.0 - 간소화 버전</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            margin: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
            line-height: 1.6;
        }
        
        .header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #333;
            border-radius: 8px;
            background: #2d2d2d;
        }
        
        .test-section h3 {
            color: #569cd6;
            margin: 0 0 15px 0;
        }
        
        .success {
            color: #4ec9b0;
            background: rgba(78, 201, 176, 0.1);
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #4ec9b0;
        }
        
        .error {
            color: #f44747;
            background: rgba(244, 71, 71, 0.1);
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #f44747;
        }
        
        .warning {
            color: #ffcc02;
            background: rgba(255, 204, 2, 0.1);
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #ffcc02;
        }
        
        .info {
            color: #9cdcfe;
            background: rgba(156, 220, 254, 0.1);
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #9cdcfe;
        }
        
        .test-result {
            margin: 10px 0;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: monospace;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-card {
            background: #333;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #4ec9b0;
        }
        
        .stat-label {
            color: #cccccc;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🧪 최종 통합 테스트 시스템 (간소화)</h1>
        <p>MBTI 로맨스 채팅 게임 v2.2.0 - 모듈 없는 독립 테스트</p>
    </div>
    
    <div class="test-section">
        <h3>🎮 테스트 제어판</h3>
        <button class="btn" onclick="runAllTests()">전체 테스트 실행</button>
        <button class="btn" onclick="runAPITests()">API 테스트</button>
        <button class="btn" onclick="runGameTests()">게임 기능 테스트</button>
        <button class="btn" onclick="runPerformanceTests()">성능 테스트</button>
        <button class="btn" onclick="clearResults()">결과 초기화</button>
    </div>

    <div id="results-container">
        <!-- 테스트 결과가 여기에 동적으로 추가됩니다 -->
    </div>

    <script>
        // 테스트 시스템 - 모듈 의존성 없는 독립 버전
        const resultsContainer = document.getElementById('results-container');
        
        let testStats = {
            total: 0,
            passed: 0,
            failed: 0,
            warnings: 0,
            startTime: null,
            endTime: null
        };

        function clearResults() {
            resultsContainer.innerHTML = '';
            testStats = { total: 0, passed: 0, failed: 0, warnings: 0, startTime: null, endTime: null };
        }

        function addTestSection(title, icon = '🧪') {
            const section = document.createElement('div');
            section.className = 'test-section';
            section.innerHTML = `<h3>${icon} ${title}</h3><div class="test-content"></div>`;
            resultsContainer.appendChild(section);
            return section.querySelector('.test-content');
        }

        function addTestResult(container, message, type = 'info') {
            const result = document.createElement('div');
            result.className = `test-result ${type}`;
            result.innerHTML = message;
            container.appendChild(result);
            
            testStats.total++;
            if (type === 'success') testStats.passed++;
            else if (type === 'error') testStats.failed++;
            else if (type === 'warning') testStats.warnings++;
        }

        function displayStats() {
            const duration = testStats.endTime - testStats.startTime;
            const statsSection = addTestSection('📊 테스트 통계', '📊');
            statsSection.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${testStats.total}</div>
                        <div class="stat-label">총 테스트</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: #4ec9b0;">${testStats.passed}</div>
                        <div class="stat-label">성공</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: #f44747;">${testStats.failed}</div>
                        <div class="stat-label">실패</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: #ffcc02;">${testStats.warnings}</div>
                        <div class="stat-label">경고</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${duration}ms</div>
                        <div class="stat-label">실행 시간</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${Math.round((testStats.passed / testStats.total) * 100)}%</div>
                        <div class="stat-label">성공률</div>
                    </div>
                </div>
            `;
        }

        async function runAllTests() {
            clearResults();
            testStats.startTime = Date.now();
            
            addTestResult(addTestSection('🎯 테스트 시작'), '모듈 의존성 없는 독립 테스트를 시작합니다...', 'info');
            
            await runAPITests();
            await runGameTests();  
            await runPerformanceTests();
            await runCompatibilityTests();
            
            testStats.endTime = Date.now();
            displayStats();
            
            addTestResult(addTestSection('✅ 테스트 완료'), '모든 테스트가 완료되었습니다.', 'success');
        }

        async function runAPITests() {
            const container = addTestSection('🌐 API 테스트');
            
            // 1. 기본 API 상태 테스트
            try {
                const response = await fetch('/api/scenario?action=test');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        addTestResult(container, '✅ API 서버 기본 연결 테스트 성공', 'success');
                    } else {
                        addTestResult(container, `⚠️ API 응답 확인 필요: ${data.message}`, 'warning');
                    }
                } else {
                    addTestResult(container, `⚠️ API 응답 상태: ${response.status}`, 'warning');
                }
            } catch (error) {
                addTestResult(container, `❌ API 연결 실패: ${error.message}`, 'error');
            }

            // 2. 시나리오 목록 API 테스트
            try {
                const response = await fetch('/api/scenario?action=list&type=scenarios');
                if (response.ok) {
                    const scenarios = await response.json();
                    if (Array.isArray(scenarios) && scenarios.length > 0) {
                        addTestResult(container, `✅ 시나리오 목록 API 성공 (${scenarios.length}개)`, 'success');
                    } else {
                        addTestResult(container, '⚠️ 시나리오 데이터가 없습니다', 'warning');
                    }
                } else {
                    addTestResult(container, '❌ 시나리오 목록 API 실패', 'error');
                }
            } catch (error) {
                addTestResult(container, `❌ 시나리오 API 테스트 실패: ${error.message}`, 'error');
            }

            // 3. 캐릭터 목록 API 테스트
            try {
                const response = await fetch('/api/scenario?action=list&type=characters');
                if (response.ok) {
                    const characters = await response.json();
                    if (Array.isArray(characters) && characters.length > 0) {
                        addTestResult(container, `✅ 캐릭터 목록 API 성공 (${characters.length}개)`, 'success');
                    } else {
                        addTestResult(container, '⚠️ 캐릭터 데이터가 없습니다', 'warning');
                    }
                } else {
                    addTestResult(container, '❌ 캐릭터 목록 API 실패', 'error');
                }
            } catch (error) {
                addTestResult(container, `❌ 캐릭터 API 테스트 실패: ${error.message}`, 'error');
            }

            // 4. 대화 생성 API 테스트
            try {
                const response = await fetch('/api/scenario', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'generate_character_dialogue',
                        scenario_id: 'hangover_confession',
                        character_id: 'yuna_infp',
                        game_state: { affection: 50, choiceNumber: 0 }
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.generated) {
                        addTestResult(container, '✅ 대화 생성 API 성공', 'success');
                    } else {
                        addTestResult(container, `⚠️ 대화 생성 결과 확인 필요: ${data.error || 'Unknown'}`, 'warning');
                    }
                } else {
                    addTestResult(container, `❌ 대화 생성 API 실패: ${response.status}`, 'error');
                }
            } catch (error) {
                addTestResult(container, `❌ 대화 생성 테스트 실패: ${error.message}`, 'error');
            }

            await new Promise(resolve => setTimeout(resolve, 500));
        }

        async function runGameTests() {
            const container = addTestSection('🎮 게임 기능 테스트');
            
            // 1. LocalStorage 저장 기능 테스트
            try {
                const testData = { test: true, timestamp: Date.now() };
                localStorage.setItem('test_save', JSON.stringify(testData));
                const loaded = JSON.parse(localStorage.getItem('test_save'));
                
                if (loaded && loaded.test === true) {
                    addTestResult(container, '✅ LocalStorage 저장/불러오기 성공', 'success');
                    localStorage.removeItem('test_save');
                } else {
                    throw new Error('데이터 불일치');
                }
            } catch (error) {
                addTestResult(container, `❌ LocalStorage 테스트 실패: ${error.message}`, 'error');
            }

            // 2. 게임 상태 관리 테스트
            try {
                const gameState = {
                    affection: 50,
                    choiceNumber: 0,
                    isFreeChatMode: false,
                    canInput: true
                };
                
                // 호감도 변경 시뮬레이션
                gameState.affection = Math.max(0, Math.min(100, gameState.affection + 5));
                gameState.choiceNumber++;
                
                if (gameState.affection === 55 && gameState.choiceNumber === 1) {
                    addTestResult(container, '✅ 게임 상태 관리 로직 성공', 'success');
                } else {
                    throw new Error('상태 변경 로직 오류');
                }
            } catch (error) {
                addTestResult(container, `❌ 게임 상태 테스트 실패: ${error.message}`, 'error');
            }

            // 3. 대화 처리 로직 테스트
            try {
                const testDialogue = {
                    dialogue: "안녕하세요 😊",
                    choices: [
                        { text: "인사한다", affection_impact: 1 },
                        { text: "무시한다", affection_impact: -1 }
                    ]
                };
                
                if (testDialogue.choices && testDialogue.choices.length === 2) {
                    addTestResult(container, '✅ 대화 데이터 구조 검증 성공', 'success');
                } else {
                    throw new Error('대화 데이터 구조 오류');
                }
            } catch (error) {
                addTestResult(container, `❌ 대화 처리 테스트 실패: ${error.message}`, 'error');
            }

            // 4. MBTI 기반 호감도 계산 테스트
            try {
                function calculateAffectionChange(mbti, choiceType) {
                    const mbtiWeights = {
                        'INFP': { romantic: 2, friendly: 1, ignore: -2 },
                        'ENFP': { romantic: 1, friendly: 2, ignore: -1 }
                    };
                    return mbtiWeights[mbti] && mbtiWeights[mbti][choiceType] || 0;
                }
                
                const infpRomantic = calculateAffectionChange('INFP', 'romantic');
                const enfpFriendly = calculateAffectionChange('ENFP', 'friendly');
                
                if (infpRomantic === 2 && enfpFriendly === 2) {
                    addTestResult(container, '✅ MBTI 기반 호감도 계산 성공', 'success');
                } else {
                    throw new Error('MBTI 계산 로직 오류');
                }
            } catch (error) {
                addTestResult(container, `❌ MBTI 계산 테스트 실패: ${error.message}`, 'error');
            }

            await new Promise(resolve => setTimeout(resolve, 500));
        }

        async function runPerformanceTests() {
            const container = addTestSection('⚡ 성능 테스트');
            
            // 1. 페이지 로딩 시간 측정
            const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
            if (loadTime < 3000) {
                addTestResult(container, `✅ 페이지 로딩 시간: ${loadTime}ms (우수)`, 'success');
            } else if (loadTime < 5000) {
                addTestResult(container, `⚠️ 페이지 로딩 시간: ${loadTime}ms (보통)`, 'warning');
            } else {
                addTestResult(container, `❌ 페이지 로딩 시간: ${loadTime}ms (느림)`, 'error');
            }

            // 2. 메모리 사용량 체크
            if (performance.memory) {
                const memoryInfo = performance.memory;
                const usedMB = (memoryInfo.usedJSHeapSize / 1024 / 1024).toFixed(2);
                const limitMB = (memoryInfo.jsHeapSizeLimit / 1024 / 1024).toFixed(2);
                
                addTestResult(container, `📊 메모리 사용량: ${usedMB}MB / ${limitMB}MB`, 'info');
                
                if (memoryInfo.usedJSHeapSize < memoryInfo.jsHeapSizeLimit * 0.5) {
                    addTestResult(container, '✅ 메모리 사용률: 양호 (50% 미만)', 'success');
                } else {
                    addTestResult(container, '⚠️ 메모리 사용률 주의', 'warning');
                }
            } else {
                addTestResult(container, '⚠️ 메모리 정보를 사용할 수 없습니다', 'warning');
            }

            // 3. DOM 조작 성능 테스트
            const startTime = performance.now();
            for (let i = 0; i < 100; i++) {
                const element = document.createElement('div');
                element.textContent = `Test ${i}`;
                document.body.appendChild(element);
                document.body.removeChild(element);
            }
            const domTime = performance.now() - startTime;
            
            if (domTime < 10) {
                addTestResult(container, `✅ DOM 조작 성능: ${domTime.toFixed(2)}ms (우수)`, 'success');
            } else {
                addTestResult(container, `⚠️ DOM 조작 성능: ${domTime.toFixed(2)}ms`, 'warning');
            }

            await new Promise(resolve => setTimeout(resolve, 300));
        }

        async function runCompatibilityTests() {
            const container = addTestSection('🔧 호환성 테스트');
            
            // 1. 브라우저 기능 지원 확인
            const features = {
                'ES6 모듈': typeof Symbol !== 'undefined',
                'Fetch API': typeof fetch !== 'undefined',
                'LocalStorage': typeof localStorage !== 'undefined',
                'Promise': typeof Promise !== 'undefined',
                'Array.includes': Array.prototype.includes !== undefined
            };
            
            Object.entries(features).forEach(([feature, supported]) => {
                if (supported) {
                    addTestResult(container, `✅ ${feature} 지원됨`, 'success');
                } else {
                    addTestResult(container, `❌ ${feature} 지원되지 않음`, 'error');
                }
            });

            // 2. 반응형 디자인 테스트
            const screenWidth = window.innerWidth;
            if (screenWidth >= 800) {
                addTestResult(container, `✅ 데스크톱 해상도 (${screenWidth}px)`, 'success');
            } else if (screenWidth >= 600) {
                addTestResult(container, `✅ 태블릿 해상도 (${screenWidth}px)`, 'success');
            } else {
                addTestResult(container, `✅ 모바일 해상도 (${screenWidth}px)`, 'success');
            }

            // 3. 네트워크 상태 확인
            if (navigator.onLine) {
                addTestResult(container, '✅ 네트워크 연결 정상', 'success');
            } else {
                addTestResult(container, '❌ 네트워크 연결 없음', 'error');
            }

            await new Promise(resolve => setTimeout(resolve, 300));
        }

        // 페이지 로드 시 초기 메시지 표시
        document.addEventListener('DOMContentLoaded', () => {
            const container = addTestSection('🚀 시스템 준비');
            addTestResult(container, '간소화 통합 테스트 시스템이 준비되었습니다.', 'info');
            addTestResult(container, '모듈 의존성이 제거되어 안정적으로 실행됩니다.', 'info');
            addTestResult(container, '위의 버튼을 클릭하여 테스트를 시작하세요.', 'info');
        });
    </script>
</body>
</html>