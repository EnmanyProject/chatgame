<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì˜†ì§‘ ëˆ„ë‚˜ ì–´ë“œë²¤ì²˜ - ê°œì„ íŒ</title>
<style>
  :root{
    --bg-primary: #0a0b0e;
    --bg-secondary: #1a1d25;
    --bg-card: rgba(26, 29, 37, 0.8);
    --bg-card-hover: rgba(26, 29, 37, 0.95);
    --text-primary: #f8faff;
    --text-secondary: #b8c2e8;
    --text-muted: #7c8db5;
    --accent-primary: #4f46e5;
    --accent-secondary: #06b6d4;
    --accent-success: #10b981;
    --accent-warning: #f59e0b;
    --border-subtle: rgba(248, 250, 255, 0.08);
    --border-strong: rgba(248, 250, 255, 0.15);
    --shadow-soft: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
    --shadow-strong: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.3);
    --gradient-primary: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
    --gradient-bg: linear-gradient(135deg, #0a0b0e 0%, #1a1d25 50%, #0f1115 100%);
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, 'Helvetica Neue', 'Segoe UI', 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
    background: var(--gradient-bg);
    color: var(--text-primary);
    min-height: 100vh;
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 24px;
    display: grid;
    grid-template-columns: 1fr 360px;
    gap: 24px;
    min-height: calc(100vh - 48px);
  }

  @media (max-width: 1024px) {
    .container {
      grid-template-columns: 1fr;
      gap: 20px;
    }
  }

  @media (max-width: 768px) {
    .container {
      padding: 16px;
    }
  }

  .card {
    background: var(--bg-card);
    border: 1px solid var(--border-subtle);
    border-radius: 16px;
    padding: 24px;
    backdrop-filter: blur(20px) saturate(180%);
    box-shadow: var(--shadow-strong);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .card:hover {
    background: var(--bg-card-hover);
    border-color: var(--border-strong);
    transform: translateY(-2px);
  }

  .main-panel {
    display: flex;
    flex-direction: column;
    height: fit-content;
  }

  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 12px;
  }

  .title {
    font-size: 28px;
    font-weight: 800;
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .badges {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .badge {
    padding: 6px 12px;
    font-size: 12px;
    font-weight: 600;
    border-radius: 20px;
    background: rgba(79, 70, 229, 0.15);
    color: var(--accent-primary);
    border: 1px solid rgba(79, 70, 229, 0.3);
  }

  .hint-badge {
    background: rgba(124, 141, 181, 0.15);
    color: var(--text-muted);
    border-color: rgba(124, 141, 181, 0.3);
  }

  #log {
    min-height: 450px;
    max-height: 70vh;
    overflow-y: auto;
    padding: 20px;
    margin: 16px -4px;
    background: rgba(10, 11, 14, 0.6);
    border-radius: 12px;
    border: 1px solid var(--border-subtle);
    scroll-behavior: smooth;
  }

  #log::-webkit-scrollbar {
    width: 6px;
  }

  #log::-webkit-scrollbar-track {
    background: transparent;
  }

  #log::-webkit-scrollbar-thumb {
    background: var(--border-strong);
    border-radius: 3px;
  }

  .line {
    margin: 16px 0;
    display: flex;
    gap: 12px;
    align-items: flex-start;
    animation: fadeInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .speaker {
    font-weight: 700;
    color: var(--accent-secondary);
    min-width: 80px;
    font-size: 14px;
    margin-top: 2px;
  }

  .content {
    white-space: pre-wrap;
    line-height: 1.7;
    flex: 1;
    font-size: 15px;
  }

  .narr {
    color: var(--text-muted);
    font-style: italic;
    background: rgba(124, 141, 181, 0.05);
    padding: 12px;
    border-radius: 8px;
    border-left: 3px solid var(--text-muted);
  }

  .choices {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin: 20px 0;
    padding: 16px;
    background: rgba(26, 29, 37, 0.4);
    border-radius: 12px;
    border: 1px solid var(--border-subtle);
  }

  .choice {
    background: linear-gradient(135deg, rgba(79, 70, 229, 0.1), rgba(6, 182, 212, 0.1));
    border: 1px solid var(--border-subtle);
    color: var(--text-primary);
    padding: 16px 20px;
    border-radius: 12px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
  }

  .choice::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: var(--gradient-primary);
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: -1;
  }

  .choice:hover {
    transform: translateY(-2px);
    border-color: var(--accent-primary);
    box-shadow: var(--shadow-soft);
  }

  .choice:hover::before {
    left: 0;
    opacity: 0.1;
  }

  .choice:active {
    transform: translateY(0);
  }

  .toolbar {
    display: flex;
    gap: 12px;
    margin-top: 24px;
    flex-wrap: wrap;
  }

  .btn {
    padding: 12px 18px;
    border: 1px solid var(--border-subtle);
    border-radius: 10px;
    background: var(--bg-secondary);
    color: var(--text-primary);
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .btn:hover {
    border-color: var(--accent-primary);
    background: rgba(79, 70, 229, 0.1);
    transform: translateY(-1px);
  }

  .btn-primary {
    background: var(--gradient-primary);
    border: none;
    color: white;
  }

  .btn-primary:hover {
    box-shadow: var(--shadow-soft);
    transform: translateY(-2px);
  }

  .side-panel {
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .affection-card {
    padding: 20px;
  }

  .level-title {
    font-weight: 700;
    color: var(--accent-success);
    margin-bottom: 16px;
    font-size: 16px;
  }

  .affection-bar-container {
    position: relative;
    width: 100%;
    height: 16px;
    background: var(--bg-primary);
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid var(--border-subtle);
    margin-bottom: 16px;
  }

  .affection-bar {
    display: block;
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, var(--accent-success), var(--accent-secondary));
    transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
  }

  .affection-bar::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    animation: shimmer 2s infinite;
  }

  @keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .level-description {
    color: var(--text-secondary);
    font-size: 14px;
    line-height: 1.5;
    padding: 12px;
    background: rgba(16, 185, 129, 0.05);
    border-radius: 8px;
    border: 1px solid rgba(16, 185, 129, 0.2);
  }

  .hint {
    color: var(--text-muted);
    font-size: 12px;
    margin-top: 12px;
    line-height: 1.4;
  }

  .footer-info {
    color: var(--text-muted);
    font-size: 12px;
    margin-top: 16px;
    padding: 12px;
    background: rgba(124, 141, 181, 0.05);
    border-radius: 8px;
    border: 1px solid var(--border-subtle);
  }

  input[type="file"] {
    display: none;
  }

  label[for="file"] {
    cursor: pointer;
  }

  /* ìŠ¤í¬ë¡¤ë°” ì „ì—­ ìŠ¤íƒ€ì¼ë§ */
  ::-webkit-scrollbar {
    width: 8px;
  }

  ::-webkit-scrollbar-track {
    background: var(--bg-primary);
  }

  ::-webkit-scrollbar-thumb {
    background: var(--border-strong);
    border-radius: 4px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: var(--text-muted);
  }

  /* ëª¨ë°”ì¼ ìµœì í™” */
  @media (max-width: 480px) {
    .title {
      font-size: 24px;
    }
    
    .card {
      padding: 20px;
    }
    
    #log {
      min-height: 350px;
      padding: 16px;
    }
    
    .toolbar {
      gap: 8px;
    }
    
    .btn {
      padding: 10px 14px;
      font-size: 12px;
    }
  }
</style>
</head>
<body>
<div class="container">
  <!-- ë©”ì¸ íŒ¨ë„ -->
  <section class="card main-panel">
    <div class="header">
      <h1 class="title">ì˜†ì§‘ ëˆ„ë‚˜ ì–´ë“œë²¤ì²˜</h1>
      <div class="badges">
        <span class="badge">âœ¨ íƒ€ìê¸° íš¨ê³¼</span>
        <span class="badge hint-badge">ğŸ’¡ í…ìŠ¤íŠ¸ í´ë¦­í•˜ì—¬ ìŠ¤í‚µ</span>
      </div>
    </div>

    <div id="log" aria-live="polite"></div>

    <div class="toolbar">
      <button id="restart" class="btn btn-primary">ğŸ”„ ì²˜ìŒë¶€í„°</button>
      <button id="fast" class="btn">âš¡ íƒ€ì ì†ë„ í† ê¸€</button>
      <input id="file" type="file" accept="application/json" />
      <label for="file" class="btn">ğŸ“ ì‹œë‚˜ë¦¬ì˜¤ ë¶ˆëŸ¬ì˜¤ê¸°</label>
    </div>
    
    <div class="footer-info">
      ğŸ’¾ ì‹œë‚˜ë¦¬ì˜¤ëŠ” ë³„ë„ <code>scenario.json</code>ìœ¼ë¡œ ê´€ë¦¬ë©ë‹ˆë‹¤. 
      (ë™ì¼ í´ë” ìë™ ë¡œë”© ë˜ëŠ” ë²„íŠ¼ìœ¼ë¡œ ìˆ˜ë™ ë¡œë”©)
    </div>
  </section>

  <!-- ì‚¬ì´ë“œ íŒ¨ë„ -->
  <aside class="side-panel">
    <div class="card affection-card">
      <div class="level-title">ğŸ’• í—ˆìš© ìŠ¤í‚¨ì‹­ ë ˆë²¨ (0~10)</div>
      <div class="affection-bar-container" aria-label="í˜¸ê°ë„ ê²Œì´ì§€">
        <span id="affBar" class="affection-bar"></span>
      </div>
      <div id="levelText" class="level-description">í˜„ì¬ ë‹¨ê³„ ê³„ì‚° ì¤‘...</div>
      <div class="hint">â­ ì¥ë©´ê³¼ ì„ íƒì— ë”°ë¼ ë ˆë²¨ì´ ë³€í™”í•©ë‹ˆë‹¤</div>
    </div>
  </aside>
</div>

<!-- =====================
  ENGINE (UI/ë¡œì§) â€” ì‹œë‚˜ë¦¬ì˜¤(JSON)ëŠ” ë³„ë„
====================== -->
<script>
const Engine = (()=> {
  const state = { aff:0, speed:24, isTyping:false, skipTyping:false, currentLabel:'', script:null };
  const $log = document.getElementById('log');
  const $aff = document.getElementById('affBar');
  const $levelText = document.getElementById('levelText');

  function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }
  function scrollBottom(){ $log.scrollTop = $log.scrollHeight; }

  // ìŠ¤í‚¨ì‹­ ë ˆë²¨ ê³„ì‚°(0~10) & ì„¤ëª… ë¬¸êµ¬
  function skinshipLevel(aff){
    const lvl = Math.max(0, Math.min(10, Math.floor((aff + 10) / 3))); // ëŒ€ëµ aff 20ëŒ€ â†’ 10ë ˆë²¨
    const table = {
      0: "ê±°ë¦¬ ìœ ì§€ë§Œ í—ˆìš©",
      1: "ëŒ€í™”ë§Œ í—ˆìš©",
      2: "ê°€ë²¼ìš´ ì•„ì´ì»¨íƒê¹Œì§€",
      3: "ì§§ì€ ì¸ì‚¬/í•˜ì´íŒŒì´ë¸Œê¹Œì§€",
      4: "ì ê¹ ì†ë“± ìŠ¤ì¹¨ê¹Œì§€",
      5: "ì†ì¡ê¸° í—ˆìš©",
      6: "íŒ”ì§±ê¹Œì§€ í—ˆìš©",
      7: "ì–´ê¹¨ ê¸°ëŒ€ê¸°ê¹Œì§€ í—ˆìš©",
      8: "ê°€ë²¼ìš´ í¬ì˜¹ í—ˆìš©",
      9: "í¬ì˜¹ + ì´ë§ˆ í‚¤ìŠ¤ê¹Œì§€",
      10:"ì„œë¡œ í•©ì˜ëœ í‚¤ìŠ¤ê¹Œì§€"
    };
    return { lvl, desc: table[lvl] };
  }

  function renderAff(){
    const pct = Math.max(0, Math.min(100, state.aff));
    $aff.style.width = pct + '%';
    const { lvl, desc } = skinshipLevel(state.aff);
    $levelText.innerHTML = `<strong>ë ˆë²¨ ${lvl}</strong><br>${desc}`;
  }

  async function typeText(text, el){
    state.isTyping = true; el.textContent = '';
    for(let i=0;i<text.length;i++){
      if(state.skipTyping){ el.textContent = text; break; }
      el.textContent += text[i];
      if(state.speed>0) await sleep(state.speed);
    }
    state.isTyping = false; state.skipTyping = false;
  }

  function addLine(who, isNarr=false){
    const line = document.createElement('div'); line.className = 'line';
    const sp = document.createElement('div'); sp.className = 'speaker'; sp.textContent = isNarr ? '' : (who || '');
    const ct = document.createElement('div'); ct.className = 'content' + (isNarr ? ' narr' : '');
    line.appendChild(sp); line.appendChild(ct); $log.appendChild(line); scrollBottom();
    return ct;
  }

  // ëŒ€ì‚¬ ì¶œë ¥ + (ì§€ë¬¸)ì€ ë³„ë„ ë‚´ë ˆì´ì…˜ ë¼ì¸ìœ¼ë¡œ ê´„í˜¸ ì²˜ë¦¬
  async function showLine(who, text, psych){
    const ct = addLine(who);
    await typeText(text, ct);
    if (psych){
      const narr = addLine('', true);
      await typeText(`${psych}`, narr);
    }
    // â–¶ ë‹¤ìŒ ë²„íŠ¼ ì œê±°: 1ì´ˆ ëŒ€ê¸° í›„ ìë™ ì§„í–‰
    await sleep(1000);
  }

  // ìƒˆë¡œ ì¶”ê°€: ì†Œì„¤ì‹ ë°°ê²½ ì„¤ëª… ì „ìš© ìŠ¤í…
  async function showNarration(text){
    const narr = addLine('', true);
    await typeText(text, narr);
    await sleep(800); // ë°°ê²½ë¬¸ì€ ì‚´ì§ ë¹ ë¥´ê²Œ ë„˜ì–´ê°
  }

  // ì„ íƒì§€: í˜¸ê°ë„ íŒíŠ¸/í† ìŠ¤íŠ¸ ì—†ì´, ì„ íƒ í›„ ê°ì •ë³€í™” ì§€ë¬¸ ì¶œë ¥
  function showChoices(options){
    return new Promise(resolve=>{
      const wrap = document.createElement('div'); wrap.className = 'choices';
      options.forEach(opt=>{
        const b = document.createElement('button'); b.className='choice';
        b.textContent = opt.text; // íŒíŠ¸ ì œê±°
        b.addEventListener('click', async ()=>{
          wrap.querySelectorAll('button').forEach(x=>x.disabled=true);

          let delta = 0;
          if (typeof opt.affDelta === 'number'){
            delta = opt.affDelta;
            state.aff += delta;
            renderAff();
          }

          // ì„ íƒ ì§í›„ ê°ì • ë³€í™” ì§€ë¬¸
          const narr = addLine('', true);
          const emo =
            delta >= 2 ? "ìˆ˜ì—°ì˜ ëˆˆë¹›ì´ í™•ì—°íˆ ë¶€ë“œëŸ¬ì›Œì§„ë‹¤." :
            delta === 1 ? "ìˆ˜ì—°ì˜ í‘œì •ì´ ì‚´ì§ í’€ë¦°ë‹¤." :
            delta === 0 ? "ìˆ˜ì—°ì˜ í‘œì •ì—” ëšœë ·í•œ ë³€í™”ê°€ ì—†ë‹¤." :
            delta <= -2 ? "ìˆ˜ì—°ì˜ í‘œì •ì´ ì ì‹œ êµ³ëŠ”ë‹¤." :
                          "ìˆ˜ì—°ì˜ ë¯¸ê°„ì´ ì‚´ì§ ì¢í˜€ì§„ë‹¤.";
          await typeText(`${emo}`, narr);

          // ì•½ê°„ì˜ í…€ í›„ ë‹¤ìŒ ë¼ë²¨ë¡œ ì´ë™
          await sleep(400);
          resolve(opt.next);
          wrap.remove();
        });
        wrap.appendChild(b);
      });
      $log.appendChild(wrap); scrollBottom();
    });
  }

  async function runLabel(label){
    state.currentLabel = label;
    // í˜¸í™˜: {label:[...]} ë˜ëŠ” {label:{steps:[...]}}
    const node = state.script?.[label];
    const seq = Array.isArray(node) ? node : node?.steps;
    if(!seq){ info(`ë¼ë²¨ì´ ì—†ì–´ìš”: ${label}`); return; }

    for(let i=0;i<seq.length;i++){
      const step = seq[i];
      if(step.type==='line'){
        await showLine(step.who||'', step.text||'', step.psych||'');
      }else if(step.type==='narration' || step.type==='narr'){
        await showNarration(step.text||'');
      }else if(step.type==='choice'){
        const next = await showChoices(step.options||[]);
        if(next){ await runLabel(next); return; }
      }else if(step.type==='branch'){
        const pass = (state.aff >= (step.cond?.affGTE ?? 0));
        const dest = pass ? step.then : step.else;
        await runLabel(dest); return;
      }else if(step.type==='goto'){
        await runLabel(step.next); return;
      }
    }
  }

  function info(msg){
    const ct = addLine('', true); ct.textContent = msg;
  }

  function detectStartLabel(script){
    if(script['E1'] || script?.E1?.steps) return 'E1';
    if(script['START'] || script?.START?.steps) return 'START';
    const keys = Object.keys(script||{});
    return keys.length ? keys[0] : null;
  }

  function replaceScenario(newScript){
    state.script = newScript || {};
    $log.innerHTML = '';
    state.aff = 0; renderAff();
    const start = detectStartLabel(state.script);
    if(start){
      runLabel(start);
    }else{
      info('ğŸ¯ ì‹œë‚˜ë¦¬ì˜¤ ì‹œì‘ ë¼ë²¨ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. "E1" ë˜ëŠ” "START"ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.');
    }
  }

  function hook(){
    document.getElementById('fast').addEventListener('click',()=>{
      state.speed = state.speed===0?24:0;
      const btn = document.getElementById('fast');
      btn.textContent = state.speed===0 ? 'ğŸš€ ê³ ì† ëª¨ë“œ ON' : 'âš¡ íƒ€ì ì†ë„ í† ê¸€';
    });
    document.getElementById('restart').addEventListener('click',()=>{
      $log.innerHTML=''; state.aff=0; renderAff();
      const start = detectStartLabel(state.script); if(start) runLabel(start); else info('ğŸ¯ ì‹œì‘ ë¼ë²¨ì´ ì—†ìŠµë‹ˆë‹¤.');
    });
    document.getElementById('log').addEventListener('click',()=>{
      if(state.isTyping) state.skipTyping = true; // í´ë¦­ ì‹œ íƒ€ìê¸° ì¦‰ì‹œ ìŠ¤í‚µ
    });

    // íŒŒì¼ ì—…ë¡œë“œ JSON
    const fileInput = document.getElementById('file');
    fileInput.addEventListener('change', (e)=>{
      const f=e.target.files?.[0]; if(!f) return;
      const reader=new FileReader();
      reader.onload=()=>{
        try{ const data=JSON.parse(reader.result); replaceScenario(data); }
        catch(err){ alert('âŒ JSON íŒŒì‹± ì‹¤íŒ¨: '+err.message); }
      };
      reader.readAsText(f,'utf-8');
    });
  }

  return {replaceScenario, hook, info, renderAff};
})();
</script>

<!-- =====================
  BOOTSTRAP â€” ì™¸ë¶€ JSON ì‹œë„ â†’ ì‹¤íŒ¨ ì‹œ ì—…ë¡œë“œ ì•ˆë‚´
====================== -->
<script>
(async function boot(){
  Engine.hook();
  Engine.renderAff();

  // ê°™ì€ í´ë”ì˜ scenario.json ìë™ ë¡œë”© ì‹œë„
  try{
    const resp = await fetch('scenario.json', {cache:'no-store'});
    if(resp.ok){
      const data = await resp.json();
      Engine.replaceScenario(data);
      return;
    }else{
      Engine.info('ğŸ“ ê°™ì€ í´ë”ì— <scenario.json>ì´ ì—†ìŠµë‹ˆë‹¤. ìƒë‹¨ ë²„íŠ¼ìœ¼ë¡œ JSONì„ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.');
    }
  }catch(e){
    Engine.info('âš ï¸ ìë™ ë¡œë”© ì‹¤íŒ¨. ìƒë‹¨ ë²„íŠ¼ìœ¼ë¡œ JSONì„ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.');
  }
})();
</script>
</body>
</html>