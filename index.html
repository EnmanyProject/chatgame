<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>옆집 누나 어드벤처 - 개선판</title>
<style>
  :root{
    --bg-primary: #0a0b0e;
    --bg-secondary: #1a1d25;
    --bg-card: rgba(26, 29, 37, 0.8);
    --bg-card-hover: rgba(26, 29, 37, 0.95);
    --text-primary: #f8faff;
    --text-secondary: #b8c2e8;
    --text-muted: #7c8db5;
    --accent-primary: #4f46e5;
    --accent-secondary: #06b6d4;
    --accent-success: #10b981;
    --accent-warning: #f59e0b;
    --border-subtle: rgba(248, 250, 255, 0.08);
    --border-strong: rgba(248, 250, 255, 0.15);
    --shadow-soft: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
    --shadow-strong: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.3);
    --gradient-primary: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
    --gradient-bg: linear-gradient(135deg, #0a0b0e 0%, #1a1d25 50%, #0f1115 100%);
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, 'Helvetica Neue', 'Segoe UI', 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
    background: var(--gradient-bg);
    color: var(--text-primary);
    min-height: 100vh;
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 24px;
    display: grid;
    grid-template-columns: 1fr 360px;
    gap: 24px;
    min-height: calc(100vh - 48px);
  }

  @media (max-width: 1024px) {
    .container {
      grid-template-columns: 1fr;
      gap: 20px;
    }
  }

  @media (max-width: 768px) {
    .container {
      padding: 16px;
    }
  }

  .card {
    background: var(--bg-card);
    border: 1px solid var(--border-subtle);
    border-radius: 16px;
    padding: 24px;
    backdrop-filter: blur(20px) saturate(180%);
    box-shadow: var(--shadow-strong);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .card:hover {
    background: var(--bg-card-hover);
    border-color: var(--border-strong);
    transform: translateY(-2px);
  }

  .main-panel {
    display: flex;
    flex-direction: column;
    height: fit-content;
  }

  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 12px;
  }

  .title {
    font-size: 28px;
    font-weight: 800;
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .badges {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .badge {
    padding: 6px 12px;
    font-size: 12px;
    font-weight: 600;
    border-radius: 20px;
    background: rgba(79, 70, 229, 0.15);
    color: var(--accent-primary);
    border: 1px solid rgba(79, 70, 229, 0.3);
  }

  .hint-badge {
    background: rgba(124, 141, 181, 0.15);
    color: var(--text-muted);
    border-color: rgba(124, 141, 181, 0.3);
  }

  #log {
    min-height: 450px;
    max-height: 70vh;
    overflow-y: auto;
    padding: 20px;
    margin: 16px -4px;
    background: rgba(10, 11, 14, 0.6);
    border-radius: 12px;
    border: 1px solid var(--border-subtle);
    scroll-behavior: smooth;
  }

  #log::-webkit-scrollbar {
    width: 6px;
  }

  #log::-webkit-scrollbar-track {
    background: transparent;
  }

  #log::-webkit-scrollbar-thumb {
    background: var(--border-strong);
    border-radius: 3px;
  }

  .line {
    margin: 16px 0;
    display: flex;
    gap: 12px;
    align-items: flex-start;
    animation: fadeInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .speaker {
    font-weight: 700;
    color: var(--accent-secondary);
    min-width: 80px;
    font-size: 14px;
    margin-top: 2px;
  }

  .content {
    white-space: pre-wrap;
    line-height: 1.7;
    flex: 1;
    font-size: 15px;
  }

  .narr {
    color: var(--text-muted);
    font-style: italic;
    background: rgba(124, 141, 181, 0.05);
    padding: 12px;
    border-radius: 8px;
    border-left: 3px solid var(--text-muted);
  }

  .choices {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin: 20px 0;
    padding: 16px;
    background: rgba(26, 29, 37, 0.4);
    border-radius: 12px;
    border: 1px solid var(--border-subtle);
  }

  .choice {
    background: linear-gradient(135deg, rgba(79, 70, 229, 0.1), rgba(6, 182, 212, 0.1));
    border: 1px solid var(--border-subtle);
    color: var(--text-primary);
    padding: 16px 20px;
    border-radius: 12px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
  }

  .choice::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: var(--gradient-primary);
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: -1;
  }

  .choice:hover {
    transform: translateY(-2px);
    border-color: var(--accent-primary);
    box-shadow: var(--shadow-soft);
  }

  .choice:hover::before {
    left: 0;
    opacity: 0.1;
  }

  .choice:active {
    transform: translateY(0);
  }

  .toolbar {
    display: flex;
    gap: 12px;
    margin-top: 24px;
    flex-wrap: wrap;
  }

  .btn {
    padding: 12px 18px;
    border: 1px solid var(--border-subtle);
    border-radius: 10px;
    background: var(--bg-secondary);
    color: var(--text-primary);
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .btn:hover {
    border-color: var(--accent-primary);
    background: rgba(79, 70, 229, 0.1);
    transform: translateY(-1px);
  }

  .btn-primary {
    background: var(--gradient-primary);
    border: none;
    color: white;
  }

  .btn-primary:hover {
    box-shadow: var(--shadow-soft);
    transform: translateY(-2px);
  }

  .side-panel {
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .affection-card {
    padding: 20px;
  }

  .level-title {
    font-weight: 700;
    color: var(--accent-success);
    margin-bottom: 16px;
    font-size: 16px;
  }

  .affection-bar-container {
    position: relative;
    width: 100%;
    height: 16px;
    background: var(--bg-primary);
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid var(--border-subtle);
    margin-bottom: 16px;
  }

  .affection-bar {
    display: block;
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, var(--accent-success), var(--accent-secondary));
    transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
  }

  .affection-bar::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    animation: shimmer 2s infinite;
  }

  @keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .level-description {
    color: var(--text-secondary);
    font-size: 14px;
    line-height: 1.5;
    padding: 12px;
    background: rgba(16, 185, 129, 0.05);
    border-radius: 8px;
    border: 1px solid rgba(16, 185, 129, 0.2);
  }

  .hint {
    color: var(--text-muted);
    font-size: 12px;
    margin-top: 12px;
    line-height: 1.4;
  }

  .footer-info {
    color: var(--text-muted);
    font-size: 12px;
    margin-top: 16px;
    padding: 12px;
    background: rgba(124, 141, 181, 0.05);
    border-radius: 8px;
    border: 1px solid var(--border-subtle);
  }

  input[type="file"] {
    display: none;
  }

  label[for="file"] {
    cursor: pointer;
  }

  /* 스크롤바 전역 스타일링 */
  ::-webkit-scrollbar {
    width: 8px;
  }

  ::-webkit-scrollbar-track {
    background: var(--bg-primary);
  }

  ::-webkit-scrollbar-thumb {
    background: var(--border-strong);
    border-radius: 4px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: var(--text-muted);
  }

  /* 모바일 최적화 */
  @media (max-width: 480px) {
    .title {
      font-size: 24px;
    }
    
    .card {
      padding: 20px;
    }
    
    #log {
      min-height: 350px;
      padding: 16px;
    }
    
    .toolbar {
      gap: 8px;
    }
    
    .btn {
      padding: 10px 14px;
      font-size: 12px;
    }
  }
</style>
</head>
<body>
<div class="container">
  <!-- 메인 패널 -->
  <section class="card main-panel">
    <div class="header">
      <h1 class="title">옆집 누나 어드벤처</h1>
      <div class="badges">
        <span class="badge">✨ 타자기 효과</span>
        <span class="badge hint-badge">💡 텍스트 클릭하여 스킵</span>
      </div>
    </div>

    <div id="log" aria-live="polite"></div>

    <div class="toolbar">
      <button id="restart" class="btn btn-primary">🔄 처음부터</button>
      <button id="fast" class="btn">⚡ 타자 속도 토글</button>
      <input id="file" type="file" accept="application/json" />
      <label for="file" class="btn">📁 시나리오 불러오기</label>
    </div>
    
    <div class="footer-info">
      💾 시나리오는 별도 <code>scenario.json</code>으로 관리됩니다. 
      (동일 폴더 자동 로딩 또는 버튼으로 수동 로딩)
    </div>
  </section>

  <!-- 사이드 패널 -->
  <aside class="side-panel">
    <div class="card affection-card">
      <div class="level-title">💕 허용 스킨십 레벨 (0~10)</div>
      <div class="affection-bar-container" aria-label="호감도 게이지">
        <span id="affBar" class="affection-bar"></span>
      </div>
      <div id="levelText" class="level-description">현재 단계 계산 중...</div>
      <div class="hint">⭐ 장면과 선택에 따라 레벨이 변화합니다</div>
    </div>
  </aside>
</div>

<!-- =====================
  ENGINE (UI/로직) — 시나리오(JSON)는 별도
====================== -->
<script>
const Engine = (()=> {
  const state = { aff:0, speed:24, isTyping:false, skipTyping:false, currentLabel:'', script:null };
  const $log = document.getElementById('log');
  const $aff = document.getElementById('affBar');
  const $levelText = document.getElementById('levelText');

  function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }
  function scrollBottom(){ $log.scrollTop = $log.scrollHeight; }

  // 스킨십 레벨 계산(0~10) & 설명 문구
  function skinshipLevel(aff){
    const lvl = Math.max(0, Math.min(10, Math.floor((aff + 10) / 3))); // 대략 aff 20대 → 10레벨
    const table = {
      0: "거리 유지만 허용",
      1: "대화만 허용",
      2: "가벼운 아이컨택까지",
      3: "짧은 인사/하이파이브까지",
      4: "잠깐 손등 스침까지",
      5: "손잡기 허용",
      6: "팔짱까지 허용",
      7: "어깨 기대기까지 허용",
      8: "가벼운 포옹 허용",
      9: "포옹 + 이마 키스까지",
      10:"서로 합의된 키스까지"
    };
    return { lvl, desc: table[lvl] };
  }

  function renderAff(){
    const pct = Math.max(0, Math.min(100, state.aff));
    $aff.style.width = pct + '%';
    const { lvl, desc } = skinshipLevel(state.aff);
    $levelText.innerHTML = `<strong>레벨 ${lvl}</strong><br>${desc}`;
  }

  async function typeText(text, el){
    state.isTyping = true; el.textContent = '';
    for(let i=0;i<text.length;i++){
      if(state.skipTyping){ el.textContent = text; break; }
      el.textContent += text[i];
      if(state.speed>0) await sleep(state.speed);
    }
    state.isTyping = false; state.skipTyping = false;
  }

  function addLine(who, isNarr=false){
    const line = document.createElement('div'); line.className = 'line';
    const sp = document.createElement('div'); sp.className = 'speaker'; sp.textContent = isNarr ? '' : (who || '');
    const ct = document.createElement('div'); ct.className = 'content' + (isNarr ? ' narr' : '');
    line.appendChild(sp); line.appendChild(ct); $log.appendChild(line); scrollBottom();
    return ct;
  }

  // 대사 출력 + (지문)은 별도 내레이션 라인으로 괄호 처리
  async function showLine(who, text, psych){
    const ct = addLine(who);
    await typeText(text, ct);
    if (psych){
      const narr = addLine('', true);
      await typeText(`${psych}`, narr);
    }
    // ▶ 다음 버튼 제거: 1초 대기 후 자동 진행
    await sleep(1000);
  }

  // 새로 추가: 소설식 배경 설명 전용 스텝
  async function showNarration(text){
    const narr = addLine('', true);
    await typeText(text, narr);
    await sleep(800); // 배경문은 살짝 빠르게 넘어감
  }

  // 선택지: 호감도 힌트/토스트 없이, 선택 후 감정변화 지문 출력
  function showChoices(options){
    return new Promise(resolve=>{
      const wrap = document.createElement('div'); wrap.className = 'choices';
      options.forEach(opt=>{
        const b = document.createElement('button'); b.className='choice';
        b.textContent = opt.text; // 힌트 제거
        b.addEventListener('click', async ()=>{
          wrap.querySelectorAll('button').forEach(x=>x.disabled=true);

          let delta = 0;
          if (typeof opt.affDelta === 'number'){
            delta = opt.affDelta;
            state.aff += delta;
            renderAff();
          }

          // 선택 직후 감정 변화 지문
          const narr = addLine('', true);
          const emo =
            delta >= 2 ? "수연의 눈빛이 확연히 부드러워진다." :
            delta === 1 ? "수연의 표정이 살짝 풀린다." :
            delta === 0 ? "수연의 표정엔 뚜렷한 변화가 없다." :
            delta <= -2 ? "수연의 표정이 잠시 굳는다." :
                          "수연의 미간이 살짝 좁혀진다.";
          await typeText(`${emo}`, narr);

          // 약간의 텀 후 다음 라벨로 이동
          await sleep(400);
          resolve(opt.next);
          wrap.remove();
        });
        wrap.appendChild(b);
      });
      $log.appendChild(wrap); scrollBottom();
    });
  }

  async function runLabel(label){
    state.currentLabel = label;
    // 호환: {label:[...]} 또는 {label:{steps:[...]}}
    const node = state.script?.[label];
    const seq = Array.isArray(node) ? node : node?.steps;
    if(!seq){ info(`라벨이 없어요: ${label}`); return; }

    for(let i=0;i<seq.length;i++){
      const step = seq[i];
      if(step.type==='line'){
        await showLine(step.who||'', step.text||'', step.psych||'');
      }else if(step.type==='narration' || step.type==='narr'){
        await showNarration(step.text||'');
      }else if(step.type==='choice'){
        const next = await showChoices(step.options||[]);
        if(next){ await runLabel(next); return; }
      }else if(step.type==='branch'){
        const pass = (state.aff >= (step.cond?.affGTE ?? 0));
        const dest = pass ? step.then : step.else;
        await runLabel(dest); return;
      }else if(step.type==='goto'){
        await runLabel(step.next); return;
      }
    }
  }

  function info(msg){
    const ct = addLine('', true); ct.textContent = msg;
  }

  function detectStartLabel(script){
    if(script['E1'] || script?.E1?.steps) return 'E1';
    if(script['START'] || script?.START?.steps) return 'START';
    const keys = Object.keys(script||{});
    return keys.length ? keys[0] : null;
  }

  function replaceScenario(newScript){
    state.script = newScript || {};
    $log.innerHTML = '';
    state.aff = 0; renderAff();
    const start = detectStartLabel(state.script);
    if(start){
      runLabel(start);
    }else{
      info('🎯 시나리오 시작 라벨을 찾지 못했습니다. "E1" 또는 "START"를 추가하세요.');
    }
  }

  function hook(){
    document.getElementById('fast').addEventListener('click',()=>{
      state.speed = state.speed===0?24:0;
      const btn = document.getElementById('fast');
      btn.textContent = state.speed===0 ? '🚀 고속 모드 ON' : '⚡ 타자 속도 토글';
    });
    document.getElementById('restart').addEventListener('click',()=>{
      $log.innerHTML=''; state.aff=0; renderAff();
      const start = detectStartLabel(state.script); if(start) runLabel(start); else info('🎯 시작 라벨이 없습니다.');
    });
    document.getElementById('log').addEventListener('click',()=>{
      if(state.isTyping) state.skipTyping = true; // 클릭 시 타자기 즉시 스킵
    });

    // 파일 업로드 JSON
    const fileInput = document.getElementById('file');
    fileInput.addEventListener('change', (e)=>{
      const f=e.target.files?.[0]; if(!f) return;
      const reader=new FileReader();
      reader.onload=()=>{
        try{ const data=JSON.parse(reader.result); replaceScenario(data); }
        catch(err){ alert('❌ JSON 파싱 실패: '+err.message); }
      };
      reader.readAsText(f,'utf-8');
    });
  }

  return {replaceScenario, hook, info, renderAff};
})();
</script>

<!-- =====================
  BOOTSTRAP — 외부 JSON 시도 → 실패 시 업로드 안내
====================== -->
<script>
(async function boot(){
  Engine.hook();
  Engine.renderAff();

  // 같은 폴더의 scenario.json 자동 로딩 시도
  try{
    const resp = await fetch('scenario.json', {cache:'no-store'});
    if(resp.ok){
      const data = await resp.json();
      Engine.replaceScenario(data);
      return;
    }else{
      Engine.info('📁 같은 폴더에 <scenario.json>이 없습니다. 상단 버튼으로 JSON을 불러오세요.');
    }
  }catch(e){
    Engine.info('⚠️ 자동 로딩 실패. 상단 버튼으로 JSON을 불러오세요.');
  }
})();
</script>
</body>
</html>