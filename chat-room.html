<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ï±ÑÌåÖÎ∞©</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background-color: #b2c7d9;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Ìó§Îçî */
        .chat-header {
            background-color: #ffffff;
            border-bottom: 1px solid #e0e0e0;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .back-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            color: #333;
        }

        .back-btn:hover {
            color: #666;
        }

        .character-info {
            flex: 1;
        }

        .character-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mbti-badge {
            font-size: 11px;
            font-weight: 500;
            padding: 2px 6px;
            border-radius: 8px;
            background-color: #f0f0f0;
            color: #666;
        }

        .character-status {
            font-size: 13px;
            color: #999;
            margin-top: 2px;
        }

        .menu-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            color: #333;
        }

        /* Î©îÏãúÏßÄ ÏòÅÏó≠ */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Î©îÏãúÏßÄ Î≤ÑÎ∏î */
        .message {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            max-width: 70%;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.sent {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message.received {
            align-self: flex-start;
        }

        .message-bubble {
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 15px;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .message.sent .message-bubble {
            background-color: #ffeb33;
            color: #333;
        }

        .message.received .message-bubble {
            background-color: #ffffff;
            color: #333;
        }

        .message-time {
            font-size: 11px;
            color: #666;
            white-space: nowrap;
        }

        /* ÏÑ†ÌÉùÏßÄ ÏòÅÏó≠ */
        .choices-container {
            background-color: #ffffff;
            padding: 15px 20px;
            border-top: 1px solid #e0e0e0;
            display: none;
        }

        .choices-container.visible {
            display: block;
        }

        .choice-btn {
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 10px;
            background-color: #f8f8f8;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            font-size: 14px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
        }

        .choice-btn:hover {
            background-color: #e8e8e8;
            border-color: #d0d0d0;
        }

        .choice-btn:active {
            transform: scale(0.98);
        }

        .choice-btn:last-child {
            margin-bottom: 0;
        }

        .choice-btn.positive {
            border-left: 3px solid #4caf50;
        }

        .choice-btn.negative {
            border-left: 3px solid #f44336;
        }

        .choice-btn.neutral {
            border-left: 3px solid #2196f3;
        }

        /* ÏûÖÎ†• ÏòÅÏó≠ */
        .input-container {
            background-color: #ffffff;
            border-top: 1px solid #e0e0e0;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .plus-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            padding: 5px;
        }

        .message-input {
            flex: 1;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            padding: 10px 15px;
            font-size: 14px;
            outline: none;
            resize: none;
            max-height: 100px;
            min-height: 40px;
        }

        .message-input:focus {
            border-color: #c0c0c0;
        }

        .send-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #ffeb33;
            padding: 5px;
            transition: transform 0.2s;
        }

        .send-btn:hover {
            transform: scale(1.1);
        }

        .send-btn:active {
            transform: scale(0.95);
        }

        .send-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Îπà ÏÉÅÌÉú */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #ffffff;
            text-align: center;
            opacity: 0.7;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .empty-message {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .empty-description {
            font-size: 14px;
        }

        /* Î°úÎî© */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .loading-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Ïä§ÌÅ¨Î°§Î∞î */
        .messages-container::-webkit-scrollbar {
            width: 6px;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }

        .messages-container::-webkit-scrollbar-thumb:hover {
            background-color: rgba(0, 0, 0, 0.3);
        }

        /* ÏãúÏä§ÌÖú Î©îÏãúÏßÄ */
        .system-message {
            align-self: center;
            background-color: rgba(255, 255, 255, 0.8);
            color: #666;
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 13px;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Ìó§Îçî -->
    <div class="chat-header">
        <button class="back-btn" onclick="goBack()">‚Üê</button>
        <div class="character-info">
            <div class="character-name">
                <span id="characterName">Î°úÎî© Ï§ë...</span>
                <span class="mbti-badge" id="characterMbti">MBTI</span>
            </div>
            <div class="character-status" id="characterStatus"></div>
        </div>
        <button class="menu-btn" onclick="openMenu()">‚ò∞</button>
    </div>

    <!-- Î©îÏãúÏßÄ ÏòÅÏó≠ -->
    <div class="messages-container" id="messagesContainer">
        <div class="empty-state">
            <div class="empty-icon">üí¨</div>
            <div class="empty-message">ÎåÄÌôîÎ•º ÏãúÏûëÌï¥Î≥¥ÏÑ∏Ïöî!</div>
            <div class="empty-description">Ï≤´ Î©îÏãúÏßÄÎ•º Í∏∞Îã§Î¶¨Í≥† ÏûàÏñ¥Ïöî</div>
        </div>
    </div>

    <!-- ÏÑ†ÌÉùÏßÄ ÏòÅÏó≠ -->
    <div class="choices-container" id="choicesContainer">
        <!-- ÏÑ†ÌÉùÏßÄÍ∞Ä Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
    </div>

    <!-- ÏûÖÎ†• ÏòÅÏó≠ -->
    <div class="input-container">
        <button class="plus-btn" onclick="openPlus()">+</button>
        <textarea class="message-input" id="messageInput" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." rows="1"></textarea>
        <button class="send-btn" id="sendBtn" onclick="sendMessage()">üì§</button>
    </div>

    <!-- Phase 3 ÏãúÏä§ÌÖú Ïä§ÌÅ¨Î¶ΩÌä∏ -->
    <script src="js/statistics-manager.js"></script>
    <script src="js/achievement-system.js"></script>
    <script src="js/emotion-state-system.js"></script>
    <script src="js/special-event-system.js"></script>
    <script src="js/memory-keywords.js"></script>
    <script src="js/conversation-memory-system.js"></script>
    <script src="js/ending-system.js"></script>
    <script src="js/multi-character-state.js"></script>
    <script src="js/game-integration-manager.js"></script>

    <script>
        // Ï†ÑÏó≠ Î≥ÄÏàò
        let currentCharacterId = null;
        let currentCharacter = null;
        let chatRoom = null;
        let multiCharacterState = null;
        let currentEpisode = null;
        let episodeIndex = 0;

        // URLÏóêÏÑú Ï∫êÎ¶≠ÌÑ∞ ID Ï∂îÏ∂ú
        function getCharacterIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('characterId');
        }

        // Ï¥àÍ∏∞Ìôî
        async function init() {
            currentCharacterId = getCharacterIdFromUrl();
            if (!currentCharacterId) {
                alert('Ï∫êÎ¶≠ÌÑ∞ IDÍ∞Ä ÏóÜÏäµÎãàÎã§.');
                goBack();
                return;
            }

            // Phase 3 ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî
            initPhase3Systems();

            // Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥ Î°úÎìú
            await loadCharacter();

            // ÎåÄÌôîÎ∞© Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            await loadChatRoom();

            // Î©îÏãúÏßÄ Î†åÎçîÎßÅ
            renderMessages();

            // Îã§Ïùå ÏóêÌîºÏÜåÎìú ÌôïÏù∏
            checkNextEpisode();
        }

        // Phase 3 ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî
        function initPhase3Systems() {
            try {
                if (typeof MultiCharacterState === 'undefined') {
                    console.warn('‚ö†Ô∏è Phase 3 ÏãúÏä§ÌÖúÏù¥ Î°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§');
                    return false;
                }
                multiCharacterState = new MultiCharacterState();
                console.log('‚úÖ Phase 3 ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');

                const health = multiCharacterState.integrationManager.checkSystemHealth();
                console.log('üè• ÏãúÏä§ÌÖú ÏÉÅÌÉú:', health);
                return true;
            } catch (error) {
                console.error('‚ùå Phase 3 ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî Ïã§Ìå®:', error);
                return false;
            }
        }

        // Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥ Î°úÎìú
        async function loadCharacter() {
            try {
                const response = await fetch('data/characters.json');
                const data = await response.json();

                if (data.characters && data.characters[currentCharacterId]) {
                    currentCharacter = data.characters[currentCharacterId];

                    // Ìó§Îçî ÏóÖÎç∞Ïù¥Ìä∏
                    document.getElementById('characterName').textContent = currentCharacter.basic_info.name;
                    document.getElementById('characterMbti').textContent = currentCharacter.basic_info.mbti;
                    document.getElementById('characterStatus').textContent =
                        `${currentCharacter.basic_info.age}ÏÑ∏ ¬∑ ${translateOccupation(currentCharacter.basic_info.occupation)}`;

                    // Phase 3 Ï∫êÎ¶≠ÌÑ∞ ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
                    if (multiCharacterState) {
                        multiCharacterState.initCharacterState(
                            currentCharacterId,
                            currentCharacter.basic_info.mbti
                        );
                        console.log('‚úÖ Phase 3 Ï∫êÎ¶≠ÌÑ∞ ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî:', currentCharacterId);
                    }
                } else {
                    throw new Error('Ï∫êÎ¶≠ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                }
            } catch (error) {
                console.error('‚ùå Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
                alert('Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
                goBack();
            }
        }

        // ÎåÄÌôîÎ∞© Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        async function loadChatRoom() {
            const stored = localStorage.getItem('chatRooms');
            if (stored) {
                const chatRooms = JSON.parse(stored);
                chatRoom = chatRooms.find(room => room.characterId === currentCharacterId);

                if (!chatRoom) {
                    // ÎåÄÌôîÎ∞©Ïù¥ ÏóÜÏúºÎ©¥ ÏÉàÎ°ú ÏÉùÏÑ±
                    chatRoom = {
                        characterId: currentCharacterId,
                        characterName: currentCharacter.basic_info.name,
                        characterMbti: currentCharacter.basic_info.mbti,
                        lastMessage: null,
                        lastMessageTime: null,
                        unreadCount: 0,
                        messages: []
                    };
                }
            }
        }

        // ÎåÄÌôîÎ∞© Ï†ÄÏû•
        function saveChatRoom() {
            const stored = localStorage.getItem('chatRooms');
            let chatRooms = stored ? JSON.parse(stored) : [];

            const index = chatRooms.findIndex(room => room.characterId === currentCharacterId);
            if (index >= 0) {
                chatRooms[index] = chatRoom;
            } else {
                chatRooms.push(chatRoom);
            }

            localStorage.setItem('chatRooms', JSON.stringify(chatRooms));
        }

        // Î©îÏãúÏßÄ Î†åÎçîÎßÅ
        function renderMessages() {
            const container = document.getElementById('messagesContainer');

            if (!chatRoom || chatRoom.messages.length === 0) {
                return;
            }

            container.innerHTML = chatRoom.messages.map(msg => {
                if (msg.type === 'system') {
                    return `<div class="system-message">${msg.text}</div>`;
                } else if (msg.type === 'sent') {
                    return `
                        <div class="message sent">
                            <div class="message-time">${formatTime(msg.timestamp)}</div>
                            <div class="message-bubble">${msg.text}</div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="message received">
                            <div class="message-bubble">${msg.text}</div>
                            <div class="message-time">${formatTime(msg.timestamp)}</div>
                        </div>
                    `;
                }
            }).join('');

            // Ïä§ÌÅ¨Î°§ Îß® ÏïÑÎûòÎ°ú
            scrollToBottom();
        }

        // Î©îÏãúÏßÄ Ï∂îÍ∞Ä
        function addMessage(type, text) {
            const message = {
                type: type,
                text: text,
                timestamp: new Date().toISOString()
            };

            chatRoom.messages.push(message);
            chatRoom.lastMessage = text;
            chatRoom.lastMessageTime = message.timestamp;

            saveChatRoom();
            renderMessages();

            // Phase 3 ÏãúÏä§ÌÖú ÏïåÎ¶º
            if (multiCharacterState) {
                if (type === 'sent') {
                    multiCharacterState.notifyUserResponse(currentCharacterId, text);
                } else if (type === 'received') {
                    multiCharacterState.notifyCharacterMessage(currentCharacterId, text);
                }
            }
        }

        // ÏÑ†ÌÉùÏßÄ ÌëúÏãú
        function showChoices(choices) {
            const container = document.getElementById('choicesContainer');

            if (!choices || choices.length === 0) {
                container.classList.remove('visible');
                return;
            }

            container.innerHTML = choices.map((choice, index) => {
                const impact = choice.affection_impact || 0;
                const className = impact > 0 ? 'positive' : impact < 0 ? 'negative' : 'neutral';

                return `
                    <button class="choice-btn ${className}" onclick="selectChoice(${index})">
                        ${choice.text}
                    </button>
                `;
            }).join('');

            container.classList.add('visible');
        }

        // ÏÑ†ÌÉùÏßÄ ÏÑ†ÌÉù
        function selectChoice(index) {
            if (!currentEpisode || !currentEpisode.choices) return;

            const choice = currentEpisode.choices[index];

            // ÏÇ¨Ïö©Ïûê Î©îÏãúÏßÄ Ï∂îÍ∞Ä
            addMessage('sent', choice.text);

            // Ìò∏Í∞êÎèÑ Î≥ÄÌôî
            const affectionChange = choice.affection_impact || 0;
            if (multiCharacterState && affectionChange !== 0) {
                multiCharacterState.changeAffection(currentCharacterId, affectionChange);
                console.log(`üíï Ìò∏Í∞êÎèÑ Î≥ÄÌôî: ${affectionChange > 0 ? '+' : ''}${affectionChange}`);
            }

            // ÏÑ†ÌÉùÏßÄ Ïà®Í∏∞Í∏∞
            document.getElementById('choicesContainer').classList.remove('visible');

            // Îã§Ïùå ÏóêÌîºÏÜåÎìú Î°úÎìú
            setTimeout(() => {
                checkNextEpisode();
            }, 1000);
        }

        // Îã§Ïùå ÏóêÌîºÏÜåÎìú ÌôïÏù∏
        async function checkNextEpisode() {
            // TODO: ÏóêÌîºÏÜåÎìú Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ÏóêÏÑú Îã§Ïùå ÏóêÌîºÏÜåÎìú Î°úÎìú
            // ÌòÑÏû¨Îäî ÏûÑÏãúÎ°ú Îπà ÏÉÅÌÉú Ïú†ÏßÄ
            console.log('üìã Îã§Ïùå ÏóêÌîºÏÜåÎìú ÌôïÏù∏ Ï§ë...');
        }

        // Î©îÏãúÏßÄ Ï†ÑÏÜ°
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();

            if (!text) return;

            // Î©îÏãúÏßÄ Ï∂îÍ∞Ä
            addMessage('sent', text);
            input.value = '';

            // TODO: AI ÏùëÎãµ ÏÉùÏÑ±
            // ÌòÑÏû¨Îäî ÏûÑÏãú ÏùëÎãµ
            setTimeout(() => {
                addMessage('received', 'Î©îÏãúÏßÄÎ•º Ïûò Î∞õÏïòÏñ¥Ïöî! üòä');
            }, 1500);
        }

        // Ïú†Ìã∏Î¶¨Ìã∞ Ìï®Ïàò
        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            container.scrollTop = container.scrollHeight;
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const hours = date.getHours();
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const ampm = hours < 12 ? 'Ïò§Ï†Ñ' : 'Ïò§ÌõÑ';
            const displayHours = hours % 12 || 12;
            return `${ampm} ${displayHours}:${minutes}`;
        }

        function translateOccupation(occupation) {
            const translations = {
                'art': 'ÏòàÏà†Í∞Ä',
                'pharmacist': 'ÏïΩÏÇ¨',
                'singer': 'Í∞ÄÏàò',
                'housewife': 'Ï£ºÎ∂Ä',
                'youtuber': 'Ïú†ÌäúÎ≤Ñ',
                'secretary': 'ÎπÑÏÑú'
            };
            return translations[occupation] || occupation;
        }

        function goBack() {
            window.location.href = 'messenger-ui.html';
        }

        function openMenu() {
            alert('‚öôÔ∏è Î©îÎâ¥ Í∏∞Îä•ÏùÄ Ï∂îÌõÑ Íµ¨ÌòÑ ÏòàÏ†ïÏûÖÎãàÎã§.');
        }

        function openPlus() {
            alert('‚ûï Ï∂îÍ∞Ä Í∏∞Îä•ÏùÄ Ï∂îÌõÑ Íµ¨ÌòÑ ÏòàÏ†ïÏûÖÎãàÎã§.');
        }

        // ÏûÖÎ†•Ï∞Ω ÏûêÎèô ÎÜíÏù¥ Ï°∞Ï†à
        const messageInput = document.getElementById('messageInput');
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 100) + 'px';
        });

        // Enter ÌÇ§Î°ú Ï†ÑÏÜ° (Shift+EnterÎäî Ï§ÑÎ∞îÍøà)
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
        init();
    </script>
</body>
</html>
