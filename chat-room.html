<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„íŒ…ë°©</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background-color: #b2c7d9;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* í—¤ë” */
        .chat-header {
            background-color: #ffffff;
            border-bottom: 1px solid #e0e0e0;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .back-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            color: #333;
        }

        .back-btn:hover {
            color: #666;
        }

        .character-info {
            flex: 1;
        }

        .character-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mbti-badge {
            font-size: 11px;
            font-weight: 500;
            padding: 2px 6px;
            border-radius: 8px;
            background-color: #f0f0f0;
            color: #666;
        }

        .character-status {
            font-size: 13px;
            color: #999;
            margin-top: 2px;
        }

        .menu-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            color: #333;
        }

        /* ë©”ì‹œì§€ ì˜ì—­ */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* ë©”ì‹œì§€ ë²„ë¸” */
        .message {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            max-width: 70%;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.sent {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message.received {
            align-self: flex-start;
        }

        .message-bubble {
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 15px;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .message.sent .message-bubble {
            background-color: #ffeb33;
            color: #333;
        }

        .message.received .message-bubble {
            background-color: #ffffff;
            color: #333;
        }

        .message-time {
            font-size: 11px;
            color: #666;
            white-space: nowrap;
        }

        /* ì„ íƒì§€ ì˜ì—­ */
        .choices-container {
            background-color: #ffffff;
            padding: 15px 20px;
            border-top: 1px solid #e0e0e0;
            display: none;
        }

        .choices-container.visible {
            display: block;
        }

        .choice-btn {
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 10px;
            background-color: #f8f8f8;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            font-size: 14px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
        }

        .choice-btn:hover {
            background-color: #e8e8e8;
            border-color: #d0d0d0;
        }

        .choice-btn:active {
            transform: scale(0.98);
        }

        .choice-btn:last-child {
            margin-bottom: 0;
        }

        .choice-btn.positive {
            border-left: 3px solid #4caf50;
        }

        .choice-btn.negative {
            border-left: 3px solid #f44336;
        }

        .choice-btn.neutral {
            border-left: 3px solid #2196f3;
        }

        /* ì…ë ¥ ì˜ì—­ */
        .input-container {
            background-color: #ffffff;
            border-top: 1px solid #e0e0e0;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .plus-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            padding: 5px;
        }

        .message-input {
            flex: 1;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            padding: 10px 15px;
            font-size: 14px;
            outline: none;
            resize: none;
            max-height: 100px;
            min-height: 40px;
        }

        .message-input:focus {
            border-color: #c0c0c0;
        }

        .send-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #ffeb33;
            padding: 5px;
            transition: transform 0.2s;
        }

        .send-btn:hover {
            transform: scale(1.1);
        }

        .send-btn:active {
            transform: scale(0.95);
        }

        .send-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* ë¹ˆ ìƒíƒœ */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #ffffff;
            text-align: center;
            opacity: 0.7;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .empty-message {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .empty-description {
            font-size: 14px;
        }

        /* ë¡œë”© */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .loading-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ìŠ¤í¬ë¡¤ë°” */
        .messages-container::-webkit-scrollbar {
            width: 6px;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }

        .messages-container::-webkit-scrollbar-thumb:hover {
            background-color: rgba(0, 0, 0, 0.3);
        }

        /* ì‹œìŠ¤í…œ ë©”ì‹œì§€ */
        .system-message {
            align-self: center;
            background-color: rgba(255, 255, 255, 0.8);
            color: #666;
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 13px;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- í—¤ë” -->
    <div class="chat-header">
        <button class="back-btn" onclick="goBack()">â†</button>
        <div class="character-info">
            <div class="character-name">
                <span id="characterName">ë¡œë”© ì¤‘...</span>
                <span class="mbti-badge" id="characterMbti">MBTI</span>
            </div>
            <div class="character-status" id="characterStatus"></div>
        </div>
        <button class="menu-btn" onclick="openMenu()">â˜°</button>
    </div>

    <!-- ë©”ì‹œì§€ ì˜ì—­ -->
    <div class="messages-container" id="messagesContainer">
        <div class="empty-state">
            <div class="empty-icon">ğŸ’¬</div>
            <div class="empty-message">ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”!</div>
            <div class="empty-description">ì²« ë©”ì‹œì§€ë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆì–´ìš”</div>
        </div>
    </div>

    <!-- ì„ íƒì§€ ì˜ì—­ -->
    <div class="choices-container" id="choicesContainer">
        <!-- ì„ íƒì§€ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
    </div>

    <!-- ì…ë ¥ ì˜ì—­ -->
    <div class="input-container">
        <button class="plus-btn" onclick="openPlus()">+</button>
        <textarea class="message-input" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." rows="1"></textarea>
        <button class="send-btn" id="sendBtn" onclick="sendMessage()">ğŸ“¤</button>
    </div>

    <!-- Phase 3 ì‹œìŠ¤í…œ ìŠ¤í¬ë¦½íŠ¸ -->
    <script src="js/statistics-manager.js"></script>
    <script src="js/achievement-system.js"></script>
    <script src="js/emotion-state-system.js"></script>
    <script src="js/special-event-system.js"></script>
    <script src="js/memory-keywords.js"></script>
    <script src="js/conversation-memory-system.js"></script>
    <script src="js/ending-system.js"></script>
    <script src="js/multi-character-state.js"></script>
    <script src="js/game-integration-manager.js"></script>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentCharacterId = null;
        let currentCharacter = null;
        let chatRoom = null;
        let multiCharacterState = null;
        let currentEpisode = null;
        let episodeIndex = 0;

        // URLì—ì„œ ìºë¦­í„° ID ì¶”ì¶œ
        function getCharacterIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('characterId');
        }

        // ì´ˆê¸°í™”
        async function init() {
            currentCharacterId = getCharacterIdFromUrl();
            if (!currentCharacterId) {
                alert('ìºë¦­í„° IDê°€ ì—†ìŠµë‹ˆë‹¤.');
                goBack();
                return;
            }

            // Phase 3 ì‹œìŠ¤í…œ ì´ˆê¸°í™”
            initPhase3Systems();

            // ìºë¦­í„° ì •ë³´ ë¡œë“œ
            await loadCharacter();

            // ëŒ€í™”ë°© ë°ì´í„° ë¡œë“œ
            await loadChatRoom();

            // ë©”ì‹œì§€ ë Œë”ë§
            renderMessages();

            // ë‹¤ìŒ ì—í”¼ì†Œë“œ í™•ì¸
            checkNextEpisode();
        }

        // Phase 3 ì‹œìŠ¤í…œ ì´ˆê¸°í™”
        function initPhase3Systems() {
            try {
                if (typeof MultiCharacterState === 'undefined') {
                    console.warn('âš ï¸ Phase 3 ì‹œìŠ¤í…œì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                    return false;
                }
                multiCharacterState = new MultiCharacterState();
                console.log('âœ… Phase 3 ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ');

                const health = multiCharacterState.integrationManager.checkSystemHealth();
                console.log('ğŸ¥ ì‹œìŠ¤í…œ ìƒíƒœ:', health);
                return true;
            } catch (error) {
                console.error('âŒ Phase 3 ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                return false;
            }
        }

        // ìºë¦­í„° ì •ë³´ ë¡œë“œ
        async function loadCharacter() {
            try {
                const response = await fetch('data/characters.json');
                const data = await response.json();

                if (data.characters && data.characters[currentCharacterId]) {
                    currentCharacter = data.characters[currentCharacterId];

                    // í—¤ë” ì—…ë°ì´íŠ¸
                    document.getElementById('characterName').textContent = currentCharacter.basic_info.name;
                    document.getElementById('characterMbti').textContent = currentCharacter.basic_info.mbti;
                    document.getElementById('characterStatus').textContent =
                        `${currentCharacter.basic_info.age}ì„¸ Â· ${translateOccupation(currentCharacter.basic_info.occupation)}`;

                    // Phase 3 ìºë¦­í„° ìƒíƒœ ì´ˆê¸°í™”
                    if (multiCharacterState) {
                        multiCharacterState.initCharacterState(
                            currentCharacterId,
                            currentCharacter.basic_info.mbti
                        );
                        console.log('âœ… Phase 3 ìºë¦­í„° ìƒíƒœ ì´ˆê¸°í™”:', currentCharacterId);
                    }
                } else {
                    throw new Error('ìºë¦­í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('âŒ ìºë¦­í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ìºë¦­í„° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                goBack();
            }
        }

        // ëŒ€í™”ë°© ë°ì´í„° ë¡œë“œ
        async function loadChatRoom() {
            const stored = localStorage.getItem('chatRooms');
            if (stored) {
                const chatRooms = JSON.parse(stored);
                chatRoom = chatRooms.find(room => room.characterId === currentCharacterId);

                if (!chatRoom) {
                    // ëŒ€í™”ë°©ì´ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
                    chatRoom = {
                        characterId: currentCharacterId,
                        characterName: currentCharacter.basic_info.name,
                        characterMbti: currentCharacter.basic_info.mbti,
                        lastMessage: null,
                        lastMessageTime: null,
                        unreadCount: 0,
                        messages: []
                    };
                }
            }
        }

        // ëŒ€í™”ë°© ì €ì¥
        function saveChatRoom() {
            const stored = localStorage.getItem('chatRooms');
            let chatRooms = stored ? JSON.parse(stored) : [];

            const index = chatRooms.findIndex(room => room.characterId === currentCharacterId);
            if (index >= 0) {
                chatRooms[index] = chatRoom;
            } else {
                chatRooms.push(chatRoom);
            }

            localStorage.setItem('chatRooms', JSON.stringify(chatRooms));
        }

        // ë©”ì‹œì§€ ë Œë”ë§
        function renderMessages() {
            const container = document.getElementById('messagesContainer');

            if (!chatRoom || chatRoom.messages.length === 0) {
                return;
            }

            container.innerHTML = chatRoom.messages.map(msg => {
                if (msg.type === 'system') {
                    return `<div class="system-message">${msg.text}</div>`;
                } else if (msg.type === 'sent') {
                    return `
                        <div class="message sent">
                            <div class="message-time">${formatTime(msg.timestamp)}</div>
                            <div class="message-bubble">${msg.text}</div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="message received">
                            <div class="message-bubble">${msg.text}</div>
                            <div class="message-time">${formatTime(msg.timestamp)}</div>
                        </div>
                    `;
                }
            }).join('');

            // ìŠ¤í¬ë¡¤ ë§¨ ì•„ë˜ë¡œ
            scrollToBottom();
        }

        // ë©”ì‹œì§€ ì¶”ê°€
        function addMessage(type, text) {
            const message = {
                type: type,
                text: text,
                timestamp: new Date().toISOString()
            };

            chatRoom.messages.push(message);
            chatRoom.lastMessage = text;
            chatRoom.lastMessageTime = message.timestamp;

            saveChatRoom();
            renderMessages();

            // Phase 3 ì‹œìŠ¤í…œ ì•Œë¦¼
            if (multiCharacterState) {
                if (type === 'sent') {
                    multiCharacterState.notifyUserResponse(currentCharacterId, text);
                } else if (type === 'received') {
                    multiCharacterState.notifyCharacterMessage(currentCharacterId, text);
                }
            }
        }

        // ì„ íƒì§€ í‘œì‹œ
        function showChoices(choices) {
            const container = document.getElementById('choicesContainer');

            if (!choices || choices.length === 0) {
                container.classList.remove('visible');
                return;
            }

            container.innerHTML = choices.map((choice, index) => {
                const impact = choice.affection_impact || 0;
                const className = impact > 0 ? 'positive' : impact < 0 ? 'negative' : 'neutral';

                return `
                    <button class="choice-btn ${className}" onclick="selectChoice(${index})">
                        ${choice.text}
                    </button>
                `;
            }).join('');

            container.classList.add('visible');
        }

        // ì„ íƒì§€ ì„ íƒ
        function selectChoice(index) {
            if (!currentEpisode || !currentEpisode.choices) return;

            const choice = currentEpisode.choices[index];

            // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
            addMessage('sent', choice.text);

            // í˜¸ê°ë„ ë³€í™”
            const affectionChange = choice.affection_impact || 0;
            if (multiCharacterState && affectionChange !== 0) {
                multiCharacterState.changeAffection(currentCharacterId, affectionChange);
                console.log(`ğŸ’• í˜¸ê°ë„ ë³€í™”: ${affectionChange > 0 ? '+' : ''}${affectionChange}`);
            }

            // ì„ íƒì§€ ìˆ¨ê¸°ê¸°
            document.getElementById('choicesContainer').classList.remove('visible');

            // ë‹¤ìŒ ì—í”¼ì†Œë“œ ë¡œë“œ
            setTimeout(() => {
                checkNextEpisode();
            }, 1000);
        }

        // ë‹¤ìŒ ì—í”¼ì†Œë“œ í™•ì¸
        async function checkNextEpisode() {
            // TODO: ì—í”¼ì†Œë“œ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë‹¤ìŒ ì—í”¼ì†Œë“œ ë¡œë“œ
            // í˜„ì¬ëŠ” ì„ì‹œë¡œ ë¹ˆ ìƒíƒœ ìœ ì§€
            console.log('ğŸ“‹ ë‹¤ìŒ ì—í”¼ì†Œë“œ í™•ì¸ ì¤‘...');
        }

        // ë©”ì‹œì§€ ì „ì†¡
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();

            if (!text) return;

            // ë©”ì‹œì§€ ì¶”ê°€
            addMessage('sent', text);
            input.value = '';

            // TODO: AI ì‘ë‹µ ìƒì„±
            // í˜„ì¬ëŠ” ì„ì‹œ ì‘ë‹µ
            setTimeout(() => {
                addMessage('received', 'ë©”ì‹œì§€ë¥¼ ì˜ ë°›ì•˜ì–´ìš”! ğŸ˜Š');
            }, 1500);
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            container.scrollTop = container.scrollHeight;
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const hours = date.getHours();
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const ampm = hours < 12 ? 'ì˜¤ì „' : 'ì˜¤í›„';
            const displayHours = hours % 12 || 12;
            return `${ampm} ${displayHours}:${minutes}`;
        }

        function translateOccupation(occupation) {
            const translations = {
                'art': 'ì˜ˆìˆ ê°€',
                'pharmacist': 'ì•½ì‚¬',
                'singer': 'ê°€ìˆ˜',
                'housewife': 'ì£¼ë¶€',
                'youtuber': 'ìœ íŠœë²„',
                'secretary': 'ë¹„ì„œ'
            };
            return translations[occupation] || occupation;
        }

        function goBack() {
            window.location.href = 'messenger-ui.html';
        }

        function openMenu() {
            alert('âš™ï¸ ë©”ë‰´ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.');
        }

        function openPlus() {
            alert('â• ì¶”ê°€ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.');
        }

        // ì…ë ¥ì°½ ìë™ ë†’ì´ ì¡°ì ˆ
        const messageInput = document.getElementById('messageInput');
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 100) + 'px';
        });

        // Enter í‚¤ë¡œ ì „ì†¡ (Shift+EnterëŠ” ì¤„ë°”ê¿ˆ)
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        init();
    </script>
</body>
</html>
