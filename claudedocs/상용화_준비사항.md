# 📋 상용 서비스 전환을 위한 필수 작업 목록

> **작성일**: 2025-10-01
> **현재 상태**: 프로토타입/테스트 단계
> **목적**: 실제 서비스 런칭 전 필수 개선사항 정리

## 🎯 **현재 시스템 분석**

### ✅ **잘 작동하는 부분**
- 캐릭터 생성 및 관리 시스템
- 사진 업로드 및 표시 기능
- 개별 파일 기반 사진 저장 시스템
- AI 기반 캐릭터 분석 기능
- 시나리오 관리 시스템

### ⚠️ **상용화 시 문제가 될 부분**
- 다중 유저 지원 없음 (현재 단일 프로젝트용)
- GitHub API 의존성 (코드 저장소를 데이터 저장용으로 사용)
- Base64 이미지 저장 방식의 비효율성
- 확장성 부족 (유저 증가 시 성능 저하)

---

## 🔴 **1순위: 필수 인프라 변경**

### 1.1 **클라우드 스토리지 전환**
**현재 문제**: GitHub API로 이미지 저장 (비효율적, 제한적)
**해결 방안**: 전용 클라우드 스토리지 도입

#### 권장 옵션:
```javascript
// Option 1: AWS S3 (가장 안정적)
const awsConfig = {
  bucket: 'chatgame-photos',
  region: 'ap-northeast-2', // 서울 리전
  accessKeyId: process.env.AWS_ACCESS_KEY,
  secretAccessKey: process.env.AWS_SECRET_KEY
};

// Option 2: Cloudinary (이미지 특화, 자동 최적화)
const cloudinaryConfig = {
  cloud_name: 'chatgame',
  api_key: process.env.CLOUDINARY_API_KEY,
  api_secret: process.env.CLOUDINARY_SECRET
};

// Option 3: Google Cloud Storage (가성비 좋음)
const gcsConfig = {
  projectId: 'chatgame-project',
  bucketName: 'chatgame-photos',
  keyFilename: 'path/to/service-account-key.json'
};
```

#### 예상 비용 (월 1,000명 유저 기준):
- **AWS S3**: $20-50/월
- **Cloudinary**: $89/월 (25GB, 자동 최적화 포함)
- **Google Cloud**: $15-40/월

### 1.2 **데이터베이스 시스템 구축**
**현재 문제**: JSON 파일 기반 데이터 관리 (확장성 없음)
**해결 방안**: 전용 데이터베이스 도입

#### 권장 구조:
```sql
-- 유저 테이블
CREATE TABLE users (
  id VARCHAR(36) PRIMARY KEY,
  username VARCHAR(50) UNIQUE NOT NULL,
  email VARCHAR(100) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 캐릭터 테이블
CREATE TABLE characters (
  id VARCHAR(36) PRIMARY KEY,
  user_id VARCHAR(36) NOT NULL,
  name VARCHAR(100) NOT NULL,
  mbti VARCHAR(4) NOT NULL,
  occupation VARCHAR(50),
  age INT,
  character_data JSON, -- 기존 캐릭터 상세 정보
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- 사진 테이블
CREATE TABLE character_photos (
  id VARCHAR(36) PRIMARY KEY,
  character_id VARCHAR(36) NOT NULL,
  category ENUM('profile', 'casual', 'romantic', 'emotional', 'special') NOT NULL,
  file_url VARCHAR(500) NOT NULL, -- 클라우드 스토리지 URL
  thumbnail_url VARCHAR(500), -- 썸네일 URL
  file_size INT,
  uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (character_id) REFERENCES characters(id) ON DELETE CASCADE
);
```

---

## 🟡 **2순위: 보안 및 인증 시스템**

### 2.1 **유저 인증 시스템**
```javascript
// JWT 기반 인증 시스템
const authSystem = {
  // 회원가입
  register: async (userData) => {
    const hashedPassword = await bcrypt.hash(userData.password, 12);
    const user = await db.users.create({
      id: uuidv4(),
      username: userData.username,
      email: userData.email,
      password_hash: hashedPassword
    });
    return generateJWT(user.id);
  },

  // 로그인
  login: async (username, password) => {
    const user = await db.users.findByUsername(username);
    const isValid = await bcrypt.compare(password, user.password_hash);
    if (isValid) {
      return generateJWT(user.id);
    }
    throw new Error('Invalid credentials');
  },

  // 토큰 검증 미들웨어
  authenticate: (req, res, next) => {
    const token = req.headers.authorization?.split(' ')[1];
    try {
      const decoded = jwt.verify(token, process.env.JWT_SECRET);
      req.user = decoded;
      next();
    } catch (error) {
      res.status(401).json({ error: 'Unauthorized' });
    }
  }
};
```

### 2.2 **데이터 접근 권한 관리**
```javascript
// 유저별 데이터 접근 제어
const dataAccess = {
  // 캐릭터 조회 (본인 것만)
  getUserCharacters: async (userId) => {
    return await db.characters.find({ user_id: userId });
  },

  // 캐릭터 수정 권한 확인
  checkCharacterOwnership: async (characterId, userId) => {
    const character = await db.characters.findById(characterId);
    return character && character.user_id === userId;
  },

  // 사진 업로드 권한 확인
  canUploadPhoto: async (characterId, userId) => {
    return await dataAccess.checkCharacterOwnership(characterId, userId);
  }
};
```

---

## 🟢 **3순위: 성능 최적화**

### 3.1 **이미지 최적화 시스템**
```javascript
// 다중 해상도 이미지 생성
const imageOptimization = {
  processUpload: async (file, characterId, category) => {
    // 1. 이미지 압축 및 최적화
    const optimized = await sharp(file.buffer)
      .resize(800, 800, { fit: 'inside', withoutEnlargement: true })
      .jpeg({ quality: 80 })
      .toBuffer();

    // 2. 썸네일 생성
    const thumbnail = await sharp(file.buffer)
      .resize(150, 150, { fit: 'cover' })
      .jpeg({ quality: 70 })
      .toBuffer();

    // 3. 클라우드 업로드
    const mainUrl = await uploadToCloud(optimized, `${characterId}/${category}/main.jpg`);
    const thumbUrl = await uploadToCloud(thumbnail, `${characterId}/${category}/thumb.jpg`);

    return { mainUrl, thumbUrl };
  }
};
```

### 3.2 **CDN 및 캐싱 시스템**
```javascript
// Redis 캐싱
const cacheSystem = {
  // 캐릭터 데이터 캐싱 (15분)
  cacheCharacter: async (characterId, data) => {
    await redis.setex(`character:${characterId}`, 900, JSON.stringify(data));
  },

  // 캐시에서 조회
  getCachedCharacter: async (characterId) => {
    const cached = await redis.get(`character:${characterId}`);
    return cached ? JSON.parse(cached) : null;
  },

  // 이미지 URL 캐싱 (1시간)
  cacheImageUrls: async (characterId, urls) => {
    await redis.setex(`images:${characterId}`, 3600, JSON.stringify(urls));
  }
};
```

---

## 🛠️ **4순위: 개발 및 운영 환경**

### 4.1 **환경 분리**
```bash
# 개발 환경 (.env.development)
NODE_ENV=development
DATABASE_URL=postgresql://localhost:5432/chatgame_dev
REDIS_URL=redis://localhost:6379
AWS_S3_BUCKET=chatgame-dev
CLOUDINARY_CLOUD_NAME=chatgame-dev

# 스테이징 환경 (.env.staging)
NODE_ENV=staging
DATABASE_URL=postgresql://staging-db:5432/chatgame_staging
REDIS_URL=redis://staging-redis:6379
AWS_S3_BUCKET=chatgame-staging

# 프로덕션 환경 (.env.production)
NODE_ENV=production
DATABASE_URL=postgresql://prod-db:5432/chatgame
REDIS_URL=redis://prod-redis:6379
AWS_S3_BUCKET=chatgame-production
```

### 4.2 **모니터링 및 로깅**
```javascript
// 에러 추적 및 성능 모니터링
const monitoring = {
  // Sentry 에러 추적
  setupErrorTracking: () => {
    Sentry.init({
      dsn: process.env.SENTRY_DSN,
      environment: process.env.NODE_ENV
    });
  },

  // 성능 메트릭
  trackPerformance: (operation, duration) => {
    console.log(`[PERF] ${operation}: ${duration}ms`);
    // CloudWatch, DataDog 등으로 전송
  },

  // API 호출 로깅
  logApiCall: (req, res, next) => {
    const start = Date.now();
    res.on('finish', () => {
      const duration = Date.now() - start;
      console.log(`${req.method} ${req.path} - ${res.statusCode} (${duration}ms)`);
    });
    next();
  }
};
```

---

## 📊 **예상 비용 및 일정**

### 비용 추정 (월 1,000명 유저 기준)
- **클라우드 스토리지**: $20-89/월
- **데이터베이스 (PostgreSQL)**: $20-50/월
- **서버 호스팅**: $50-200/월
- **CDN**: $10-30/월
- **모니터링 도구**: $0-50/월
- **총 예상 비용**: $100-419/월

### 개발 일정 추정
- **1단계 (인프라)**: 2-3주
- **2단계 (인증)**: 1-2주
- **3단계 (최적화)**: 1-2주
- **4단계 (운영환경)**: 1주
- **총 예상 기간**: 5-8주

---

## 📝 **우선순위별 실행 계획**

### Phase 1: 기본 인프라 (필수)
1. **AWS S3 또는 Cloudinary 계정 생성**
2. **PostgreSQL 데이터베이스 설정**
3. **기본 유저 인증 시스템 구현**
4. **데이터 마이그레이션 스크립트 작성**

### Phase 2: 보안 강화
1. **JWT 기반 인증 완성**
2. **API 권한 체크 미들웨어**
3. **비밀번호 암호화 시스템**
4. **HTTPS 적용**

### Phase 3: 성능 최적화
1. **이미지 자동 압축 시스템**
2. **Redis 캐싱 도입**
3. **CDN 설정**
4. **DB 인덱스 최적화**

### Phase 4: 운영 준비
1. **모니터링 시스템 구축**
2. **자동 백업 시스템**
3. **에러 추적 시스템**
4. **성능 모니터링**

---

## 🚨 **주의사항**

1. **데이터 마이그레이션**: 기존 데이터 손실 방지를 위한 백업 필수
2. **점진적 전환**: 한 번에 모든 것을 바꾸지 말고 단계별 적용
3. **테스트 환경**: 프로덕션 적용 전 반드시 스테이징 환경에서 테스트
4. **사용자 알림**: 서비스 중단이 필요한 경우 사전 공지

---

---

## 📝 **개발 중 발견된 추가 개선사항**

> **이 섹션은 실제 개발 과정에서 발견되는 상용화 관련 이슈들을 지속적으로 기록합니다.**

### 🔧 **2025-10-01 발견사항**

#### 1. **사진 카테고리 제한 시스템**
**현재**: 하드코딩된 카테고리별 사진 수 제한
```javascript
const PHOTO_CATEGORIES = {
    'profile': { max: 1 },
    'casual': { max: 5 },
    'romantic': { max: 5 },
    'emotional': { max: 5 },
    'special': { max: 4 }
};
```

**상용화 시 개선 필요**:
- 유저별 구독 등급에 따른 차등 제한
- 관리자가 동적으로 제한 수정 가능
- 프리미엄 유저는 제한 해제 옵션

#### 2. **Base64 저장 방식의 성능 이슈**
**현재 문제**:
- 2-3MB 이미지가 Base64로 4-5MB가 됨
- GitHub API 용량 제한 (100MB)
- 브라우저 메모리 과부하

**상용화 시 해결책**:
```javascript
// 클라이언트 압축 + 클라우드 직접 업로드
const optimizedUpload = {
  compress: async (file) => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    // 600x600 이하로 리사이즈, JPEG 80% 품질
    return compressedBlob;
  },

  uploadDirect: async (blob) => {
    // S3/Cloudinary 직접 업로드
    const formData = new FormData();
    formData.append('file', blob);
    return await fetch('/api/upload-direct', {
      method: 'POST',
      body: formData
    });
  }
};
```

#### 3. **다중 유저 지원 부재**
**현재**: 전역 캐릭터만 관리
**상용화 필요**:
```javascript
// 유저별 캐릭터 분리 시스템
const userBasedCharacters = {
  createCharacter: async (userId, characterData) => {
    return await db.characters.create({
      ...characterData,
      user_id: userId,
      id: `${userId}_${characterData.name}_${Date.now()}`
    });
  },

  getUserCharacters: async (userId) => {
    return await db.characters.find({ user_id: userId });
  }
};
```

#### 4. **API 엔드포인트 보안 부재**
**현재**: 모든 API가 public 접근 가능
**상용화 필요**:
```javascript
// JWT 인증 미들웨어
const authMiddleware = async (req, res, next) => {
  const token = req.headers.authorization?.split(' ')[1];
  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    req.user = decoded;
    next();
  } catch (error) {
    res.status(401).json({ error: 'Unauthorized' });
  }
};

// 보호된 라우트
app.post('/api/character-ai-generator', authMiddleware, handler);
```

#### 5. **에러 처리 및 사용자 피드백 부족**
**현재**: 콘솔 로그 위주의 에러 처리
**상용화 필요**:
```javascript
// 사용자 친화적 에러 처리
const errorHandler = {
  handleUploadError: (error, res) => {
    if (error.code === 'LIMIT_FILE_SIZE') {
      return res.status(400).json({
        success: false,
        message: '파일 크기는 5MB 이하로 제한됩니다.',
        errorCode: 'FILE_TOO_LARGE'
      });
    }

    if (error.code === 'INVALID_FILE_TYPE') {
      return res.status(400).json({
        success: false,
        message: 'JPG, PNG 파일만 업로드 가능합니다.',
        errorCode: 'INVALID_FILE_TYPE'
      });
    }
  }
};
```

---

### 📋 **계속 추가될 개선사항 목록**

- [ ] **실시간 알림 시스템** (사진 업로드 완료, 캐릭터 생성 등)
- [ ] **이미지 메타데이터 관리** (업로드 시간, 파일 크기, 해상도 등)
- [ ] **백업 및 복구 시스템** (사용자 데이터 보호)
- [ ] **API 버전 관리** (하위 호환성 유지)
- [ ] **캐시 무효화 전략** (이미지 업데이트 시)
- [ ] **로그 관리 시스템** (사용자 활동, API 호출 추적)
- [ ] **성능 모니터링** (응답 시간, 에러율 추적)

---

**💡 이 문서는 상용 서비스 런칭 전 참고용입니다. 실제 적용 시 각 단계별로 상세 계획을 수립하여 진행하시기 바랍니다.**

**🔄 이 문서는 개발 과정에서 지속적으로 업데이트됩니다.**