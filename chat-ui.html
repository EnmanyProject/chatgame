<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ï±ÑÌåÖ - Ïó∞Ïï† Ïñ¥ÎìúÎ≤§Ï≤ò</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí¨</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Malgun Gothic', 'ÎßëÏùÄ Í≥†Îîï', 'Segoe UI', Roboto, sans-serif;
            background: #ABC1D1;
            height: 100vh;
            overflow: hidden;
        }

        /* ÎåÄÌôîÎ∞© Î¶¨Ïä§Ìä∏ ÌôîÎ©¥ */
        .chat-list-container {
            background: white;
            height: 100vh;
            max-width: 480px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        .chat-list-header {
            background: #3B5998;
            color: white;
            padding: 14px 20px;
            font-size: 20px;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .user-mbti {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .chat-rooms {
            flex: 1;
            overflow-y: auto;
        }

        .chat-room-item {
            display: flex;
            padding: 14px 16px;
            border-bottom: 1px solid #F0F0F0;
            cursor: pointer;
            transition: background 0.15s;
            position: relative;
        }

        .chat-room-item:hover {
            background: #F7F7F7;
        }

        .chat-room-item:active {
            background: #EEEEEE;
        }

        .character-avatar {
            width: 52px;
            height: 52px;
            border-radius: 30%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin-right: 12px;
            flex-shrink: 0;
            overflow: hidden;
            border: 2px solid #F0F0F0;
        }

        .character-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .chat-room-content {
            flex: 1;
            min-width: 0;
        }

        .chat-room-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .character-name {
            font-size: 16px;
            font-weight: 600;
            color: #212529;
        }

        .last-message-time {
            font-size: 12px;
            color: #868e96;
        }

        .chat-room-bottom {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .last-message {
            font-size: 14px;
            color: #868e96;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
        }

        .unread-badge {
            background: #ff6b6b;
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 12px;
            margin-left: 8px;
        }

        /* Ï±ÑÌåÖ ÌôîÎ©¥ */
        .chat-container {
            background: #ABC1D1;
            height: 100vh;
            max-width: 480px;
            margin: 0 auto;
            display: none;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        .chat-container.active {
            display: flex;
        }

        .chat-header {
            background: #3B5998;
            color: white;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .back-button {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-header-info {
            flex: 1;
        }

        .chat-header-name {
            font-size: 16px;
            font-weight: 600;
        }

        .chat-header-status {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 2px;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .message {
            display: flex;
            gap: 8px;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: #dee2e6;
            flex-shrink: 0;
            overflow: hidden;
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message.user .message-avatar {
            display: none;
        }

        .message-bubble {
            max-width: 70%;
            padding: 9px 13px;
            border-radius: 16px;
            background: white;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
        }

        .message.user .message-bubble {
            background: #FEE500;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .message-text {
            font-size: 15px;
            line-height: 1.4;
            color: #212529;
        }

        .message-time {
            font-size: 11px;
            color: #868e96;
            margin-top: 4px;
        }

        .message-narration {
            text-align: center;
            padding: 12px;
            color: #495057;
            font-size: 13px;
            font-style: italic;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            margin: 8px 0;
        }

        .message-photo {
            max-width: 200px;
            border-radius: 12px;
            margin-top: 6px;
            cursor: pointer;
        }

        .choices-container {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .choice-button {
            background: white;
            border: 1px solid #E5E5E5;
            padding: 13px 16px;
            border-radius: 10px;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.15s;
            text-align: left;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
        }

        .choice-button:hover {
            background: #F9F9F9;
            border-color: #3B5998;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .choice-button:active {
            transform: scale(0.98);
            background: #F0F0F0;
        }

        .input-container {
            background: white;
            padding: 10px 16px 10px 16px;
            display: flex;
            gap: 8px;
            align-items: center;
            border-top: 1px solid #E5E5E5;
        }

        .input-field {
            flex: 1;
            border: 1px solid #D0D0D0;
            border-radius: 22px;
            padding: 10px 18px;
            font-size: 15px;
            outline: none;
            background: #F6F6F6;
            transition: all 0.2s;
        }

        .input-field:focus {
            border-color: #3B5998;
            background: white;
        }

        .send-button {
            background: #3B5998;
            color: white;
            border: none;
            border-radius: 50%;
            width: 42px;
            height: 42px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .send-button:hover {
            background: #2E4A7C;
            transform: scale(1.05);
        }

        .send-button:active {
            transform: scale(0.95);
        }

        .send-button:disabled {
            background: #CCC;
            cursor: not-allowed;
            transform: none;
        }

        .typing-indicator {
            display: none;
            padding: 8px 16px;
            color: #868e96;
            font-size: 13px;
        }

        .typing-indicator.active {
            display: block;
        }

        .typing-dots {
            display: inline-block;
        }

        .typing-dots span {
            animation: blink 1.4s infinite;
            animation-fill-mode: both;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes blink {
            0%, 80%, 100% { opacity: 0; }
            40% { opacity: 1; }
        }

        .loading-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .loading-screen.active {
            display: flex;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Ïä§ÌÅ¨Î°§Î∞î Ïä§ÌÉÄÏùº */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #ced4da;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #adb5bd;
        }
    </style>
</head>
<body>
    <!-- ÎåÄÌôîÎ∞© Î¶¨Ïä§Ìä∏ ÌôîÎ©¥ -->
    <div class="chat-list-container" id="chatListView">
        <div class="chat-list-header">
            <div>Ï±ÑÌåÖ</div>
            <div class="user-info">
                <span id="userName">ÏÇ¨Ïö©Ïûê</span>
                <span class="user-mbti" id="userMBTI">ENFP</span>
            </div>
        </div>
        <div class="chat-rooms" id="chatRoomsList">
            <!-- ÎåÄÌôîÎ∞© Î™©Î°ùÏù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
        </div>
    </div>

    <!-- Ï±ÑÌåÖ ÌôîÎ©¥ -->
    <div class="chat-container" id="chatView">
        <div class="chat-header">
            <button class="back-button" onclick="backToList()">‚Üê</button>
            <div class="chat-header-info">
                <div class="chat-header-name" id="currentCharacterName">Ïú§ÏïÑ</div>
                <div class="chat-header-status" id="currentCharacterStatus">Ïò®ÎùºÏù∏</div>
            </div>
        </div>
        <div class="messages-container" id="messagesContainer">
            <!-- Î©îÏãúÏßÄÍ∞Ä Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
        </div>
        <div class="typing-indicator" id="typingIndicator">
            <span id="typingCharacterName">Ïú§ÏïÑ</span>ÎãòÏù¥ ÏûÖÎ†• Ï§ë<span class="typing-dots"><span>.</span><span>.</span><span>.</span></span>
        </div>
        <div class="choices-container" id="choicesContainer">
            <!-- ÏÑ†ÌÉùÏßÄÍ∞Ä Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
        </div>
        <div class="input-container">
            <input type="text" class="input-field" id="messageInput" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." />
            <button class="send-button" id="sendButton" onclick="sendMessage()">‚û§</button>
        </div>
    </div>

    <!-- Î°úÎî© ÌôîÎ©¥ -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
    </div>

    <script src="/js/character-state-manager.js"></script>
    <script src="/js/chat-room-manager.js"></script>
    <script src="/js/multi-character-state.js"></script>
    <script src="/js/episode-delivery-system.js"></script>
    <script src="/js/episode-trigger-engine.js"></script>
    <script src="/js/tone-variation-engine.js"></script>
    <script>
        // Ï†ÑÏó≠ Î≥ÄÏàò
        let currentCharacterId = null;
        let currentTriggerEngine = null;  // Ìä∏Î¶¨Í±∞ ÏóîÏßÑ Ïù∏Ïä§ÌÑ¥Ïä§
        let chatRoomManager = null;       // ÎåÄÌôîÎ∞© Í¥ÄÎ¶¨Ïûê
        let multiCharacterState = null;   // Î©ÄÌã∞ Ï∫êÎ¶≠ÌÑ∞ ÏÉÅÌÉú Í¥ÄÎ¶¨Ïûê
        let characters = [];
        let userName = 'ÏÇ¨Ïö©Ïûê';
        let userMBTI = 'ENFP';

        // Ï¥àÍ∏∞Ìôî
        async function init() {
            // URL ÌååÎùºÎØ∏ÌÑ∞ÏóêÏÑú Ï∫êÎ¶≠ÌÑ∞ ID ÌôïÏù∏
            const urlParams = new URLSearchParams(window.location.search);
            const characterId = urlParams.get('character');

            // ChatRoomManagerÏôÄ MultiCharacterState Ï¥àÍ∏∞Ìôî
            chatRoomManager = new ChatRoomManager();
            multiCharacterState = new MultiCharacterState();

            // Ïú†Ï†Ä Ï†ïÎ≥¥ Î°úÎìú
            loadUserInfo();

            // Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù Î°úÎìú
            await loadCharacters();

            // ÌäπÏ†ï Ï∫êÎ¶≠ÌÑ∞ÏôÄÏùò ÎåÄÌôîÏù∏ Í≤ΩÏö∞
            if (characterId) {
                console.log(`üéØ ÌäπÏ†ï Ï∫êÎ¶≠ÌÑ∞ÏôÄ ÎåÄÌôî ÏãúÏûë: ${characterId}`);
                currentCharacterId = characterId;

                // ÎåÄÌôîÎ∞© ÏÉùÏÑ±/Î∂àÎü¨Ïò§Í∏∞
                if (!chatRoomManager.getRoom(characterId)) {
                    chatRoomManager.createRoom(characterId);
                }

                // ÏïàÏùΩÏùÄ Î©îÏãúÏßÄ Ï¥àÍ∏∞Ìôî
                chatRoomManager.clearUnread(characterId);

                // Ï∫êÎ¶≠ÌÑ∞ ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
                if (!multiCharacterState.getState(characterId)) {
                    multiCharacterState.initializeCharacter(characterId);
                }

                // ÎåÄÌôîÎ∞© Î¶¨Ïä§Ìä∏ Ïà®Í∏∞Í≥† Ï±ÑÌåÖ ÌôîÎ©¥ ÌëúÏãú
                showChatScreen(characterId);
            } else {
                // ÎåÄÌôîÎ∞© Î¶¨Ïä§Ìä∏ Î†åÎçîÎßÅ
                renderChatRooms();
            }
        }

        // Ïú†Ï†Ä Ï†ïÎ≥¥ Î°úÎìú
        function loadUserInfo() {
            const savedUser = localStorage.getItem('user_info');
            if (savedUser) {
                const user = JSON.parse(savedUser);
                userName = user.name || 'ÏÇ¨Ïö©Ïûê';
                userMBTI = user.mbti || 'ENFP';
            }
            
            document.getElementById('userName').textContent = userName;
            document.getElementById('userMBTI').textContent = userMBTI;
        }

        // Ï∫êÎ¶≠ÌÑ∞ Î™©Î°ù Î°úÎìú (GitHub)
        async function loadCharacters() {
            try {
                const response = await fetch('/api/character-ai-generator?action=list_characters');
                const result = await response.json();

                if (result.success && result.data) {
                    // Î∞∞Ïó¥ ÌôïÏù∏
                    if (Array.isArray(result.data.characters)) {
                        characters = result.data.characters;
                    } else if (Array.isArray(result.data)) {
                        characters = result.data;
                    } else {
                        console.warn('Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞Í∞Ä Î∞∞Ïó¥Ïù¥ ÏïÑÎãôÎãàÎã§:', result.data);
                        characters = getDummyCharacters();
                    }
                    console.log('Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú ÏôÑÎ£å:', characters.length + 'Î™Ö');
                } else {
                    console.error('Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú Ïã§Ìå®:', result.error);
                    characters = getDummyCharacters();
                }
            } catch (error) {
                console.error('Ï∫êÎ¶≠ÌÑ∞ Î°úÎìú ÏóêÎü¨:', error);
                characters = getDummyCharacters();
            }
        }

        // ÌÖåÏä§Ìä∏Ïö© ÎçîÎØ∏ Ï∫êÎ¶≠ÌÑ∞
        function getDummyCharacters() {
            return [
                {
                    id: 'yuna_infp',
                    basic_info: {
                        name: 'Ïú§ÏïÑ',
                        age: 22,
                        mbti: 'INFP'
                    },
                    photo: '/assets/default-avatar.png'
                },
                {
                    id: 'mina_enfp',
                    basic_info: {
                        name: 'ÎØ∏ÎÇò',
                        age: 24,
                        mbti: 'ENFP'
                    },
                    photo: '/assets/default-avatar.png'
                },
                {
                    id: 'seoyeon_intj',
                    basic_info: {
                        name: 'ÏÑúÏó∞',
                        age: 26,
                        mbti: 'INTJ'
                    },
                    photo: '/assets/default-avatar.png'
                }
            ];
        }

        // ÎåÄÌôîÎ∞© Î¶¨Ïä§Ìä∏ Î†åÎçîÎßÅ
        function renderChatRooms() {
            const container = document.getElementById('chatRoomsList');
            container.innerHTML = '';

            characters.forEach(character => {
                const characterName = character.basic_info?.name || character.name || 'Ï∫êÎ¶≠ÌÑ∞';
                const characterId = character.id;
                const characterPhoto = character.photo || '/assets/default-avatar.png';
                
                // ÎßàÏßÄÎßâ Î©îÏãúÏßÄ Í∞ÄÏ†∏Ïò§Í∏∞
                const lastMessage = getLastMessage(characterId);
                const unreadCount = getUnreadCount(characterId);

                const roomDiv = document.createElement('div');
                roomDiv.className = 'chat-room-item';
                roomDiv.onclick = () => openChat(characterId);
                
                roomDiv.innerHTML = `
                    <div class="character-avatar">
                        <img src="${characterPhoto}" alt="${characterName}" onerror="this.src='/assets/default-avatar.png'">
                    </div>
                    <div class="chat-room-content">
                        <div class="chat-room-top">
                            <span class="character-name">${characterName}</span>
                            <span class="last-message-time">${lastMessage.time}</span>
                        </div>
                        <div class="chat-room-bottom">
                            <span class="last-message">${lastMessage.text}</span>
                            ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : ''}
                        </div>
                    </div>
                `;
                
                container.appendChild(roomDiv);
            });
        }

        // ÎßàÏßÄÎßâ Î©îÏãúÏßÄ Í∞ÄÏ†∏Ïò§Í∏∞
        function getLastMessage(characterId) {
            const saved = localStorage.getItem(`chat_${characterId}`);
            if (saved) {
                const chatData = JSON.parse(saved);
                const messages = chatData.messages || [];
                if (messages.length > 0) {
                    const lastMsg = messages[messages.length - 1];
                    return {
                        text: lastMsg.text.substring(0, 30) + (lastMsg.text.length > 30 ? '...' : ''),
                        time: formatTime(lastMsg.timestamp)
                    };
                }
            }
            return {
                text: 'ÏÉàÎ°úÏö¥ ÎåÄÌôîÎ•º ÏãúÏûëÌï¥Î≥¥ÏÑ∏Ïöî!',
                time: ''
            };
        }

        // ÏùΩÏßÄ ÏïäÏùÄ Î©îÏãúÏßÄ Ïàò
        function getUnreadCount(characterId) {
            const saved = localStorage.getItem(`chat_${characterId}`);
            if (saved) {
                const chatData = JSON.parse(saved);
                return chatData.unreadCount || 0;
            }
            return 0;
        }

        // ÏãúÍ∞Ñ Ìè¨Îß∑
        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'Î∞©Í∏à';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'Î∂Ñ Ï†Ñ';
            if (diff < 86400000) return date.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'});
            return date.toLocaleDateString('ko-KR', {month: 'long', day: 'numeric'});
        }

        // Ï±ÑÌåÖÎ∞© Ïó¥Í∏∞
        async function openChat(characterId) {
            currentCharacterId = characterId;
            const character = characters.find(c => c.id === characterId);

            if (!character) {
                alert('Ï∫êÎ¶≠ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }

            const characterName = character.basic_info?.name || character.name || 'Ï∫êÎ¶≠ÌÑ∞';

            // UI Ï†ÑÌôò
            document.getElementById('chatListView').style.display = 'none';
            document.getElementById('chatView').classList.add('active');

            // Ìó§Îçî Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('currentCharacterName').textContent = characterName;
            document.getElementById('currentCharacterStatus').textContent = 'Ïò®ÎùºÏù∏';
            document.getElementById('typingCharacterName').textContent = characterName;

            // Î©îÏãúÏßÄ Î°úÎìú
            loadMessages(characterId);

            // ÏùΩÏùå Ï≤òÎ¶¨
            markAsRead(characterId);

            // Ìä∏Î¶¨Í±∞ ÏóîÏßÑ ÏãúÏûë
            startTriggerEngine(characterId);

            // Ï≤´ Î©îÏãúÏßÄÍ∞Ä ÏóÜÏúºÎ©¥ ÌôòÏòÅ Î©îÏãúÏßÄ Ï†ÑÏÜ°
            const saved = localStorage.getItem(`chat_${characterId}`);
            if (!saved || JSON.parse(saved).messages.length === 0) {
                setTimeout(() => {
                    sendWelcomeMessage(character);
                }, 500);
            }
        }

        // Î©îÏãúÏßÄ Î°úÎìú
        function loadMessages(characterId) {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';
            
            const saved = localStorage.getItem(`chat_${characterId}`);
            if (saved) {
                const chatData = JSON.parse(saved);
                const messages = chatData.messages || [];
                
                messages.forEach(msg => {
                    displayMessage(msg);
                });
            }
            
            scrollToBottom();
        }

        // Î©îÏãúÏßÄ ÌëúÏãú
        function displayMessage(message) {
            const container = document.getElementById('messagesContainer');
            const msgDiv = document.createElement('div');
            
            if (message.type === 'narration') {
                msgDiv.className = 'message-narration';
                msgDiv.textContent = message.text;
            } else {
                msgDiv.className = `message ${message.type}`;
                const character = characters.find(c => c.id === currentCharacterId);
                const characterPhoto = character?.photo || '/assets/default-avatar.png';
                
                msgDiv.innerHTML = `
                    ${message.type === 'character' ? `
                        <div class="message-avatar">
                            <img src="${characterPhoto}" alt="Ï∫êÎ¶≠ÌÑ∞" onerror="this.src='/assets/default-avatar.png'">
                        </div>
                    ` : ''}
                    <div class="message-bubble">
                        <div class="message-text">${message.text}</div>
                        ${message.photo ? `<img src="${message.photo}" class="message-photo" onclick="openPhoto('${message.photo}')">` : ''}
                        <div class="message-time">${new Date(message.timestamp).toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'})}</div>
                    </div>
                `;
            }
            
            container.appendChild(msgDiv);
            scrollToBottom();
        }

        // ÌôòÏòÅ Î©îÏãúÏßÄ
        async function sendWelcomeMessage(character) {
            const characterName = character.basic_info?.name || character.name || 'Ï∫êÎ¶≠ÌÑ∞';

            showTyping(true);
            await delay(1000);

            // Í∏∞Î≥∏ ÌôòÏòÅ Î©îÏãúÏßÄ
            let baseMessage = `ÏïàÎÖïÌïòÏÑ∏Ïöî! ${characterName}ÏûÖÎãàÎã§ üòä\nÏò§Îäò ÌïòÎ£® Ïñ¥Îñ†ÏÖ®Ïñ¥Ïöî?`;

            // ÌÜ§ Ï†ÅÏö©
            const state = multiCharacterState.getState(currentCharacterId);
            const mbti = character.mbti || 'INFP';
            const tonedMessage = await applyToneToMessage(
                currentCharacterId,
                baseMessage,
                state.affection,
                mbti
            );

            const welcomeMsg = {
                type: 'character',
                text: tonedMessage,
                timestamp: new Date().toISOString()
            };

            saveMessage(currentCharacterId, welcomeMsg);
            displayMessage(welcomeMsg);
            showTyping(false);

            // ÏÑ†ÌÉùÏßÄ ÌëúÏãú
            setTimeout(() => {
                showChoices([
                    {text: 'Ï¢ãÏïòÏñ¥Ïöî!', value: 'good'},
                    {text: 'Í∑∏ÎÉ• Í∑∏Îû¨Ïñ¥Ïöî', value: 'normal'},
                    {text: 'ÌûòÎì† ÌïòÎ£®ÏòÄÏñ¥Ïöî', value: 'tired'}
                ]);
            }, 500);
        }

        // ÏÑ†ÌÉùÏßÄ ÌëúÏãú
        function showChoices(choices) {
            const container = document.getElementById('choicesContainer');
            container.innerHTML = '';
            
            choices.forEach(choice => {
                const button = document.createElement('button');
                button.className = 'choice-button';
                button.textContent = choice.text;
                button.onclick = () => handleChoice(choice);
                container.appendChild(button);
            });
        }

        // ÏÑ†ÌÉùÏßÄ Ï≤òÎ¶¨
        async function handleChoice(choice) {
            // ÏÑ†ÌÉùÏßÄ Ïà®Í∏∞Í∏∞
            document.getElementById('choicesContainer').innerHTML = '';

            // Ïú†Ï†Ä Î©îÏãúÏßÄ ÌëúÏãú
            const userMsg = {
                type: 'user',
                text: choice.text,
                timestamp: new Date().toISOString()
            };

            saveMessage(currentCharacterId, userMsg);
            displayMessage(userMsg);

            // Ïú†Ï†Ä ÏùëÎãµ Ïãú ÌñâÎèô ÌîåÎûòÍ∑∏ Ï¥àÍ∏∞Ìôî
            resetBehaviorFlagsOnUserMessage();

            // AI ÏùëÎãµ ÏÉùÏÑ±
            await generateAIResponse(choice);
        }

        // Î©îÏãúÏßÄ Ï†ÑÏÜ°
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();

            if (!text) return;

            input.value = '';

            const userMsg = {
                type: 'user',
                text: text,
                timestamp: new Date().toISOString()
            };

            saveMessage(currentCharacterId, userMsg);
            displayMessage(userMsg);

            // Ïú†Ï†Ä ÏùëÎãµ Ïãú ÌñâÎèô ÌîåÎûòÍ∑∏ Ï¥àÍ∏∞Ìôî
            resetBehaviorFlagsOnUserMessage();

            // AI ÏùëÎãµ ÏÉùÏÑ±
            await generateAIResponse({text: text, value: 'text_input'});
        }

        // AI ÏùëÎãµ ÏÉùÏÑ±
        async function generateAIResponse(userChoice) {
            const character = characters.find(c => c.id === currentCharacterId);
            if (!character) return;

            showTyping(true);
            await delay(1500);

            try {
                const response = await fetch('/api/ai-response-engine', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        character_id: currentCharacterId,
                        user_input: userChoice.text,
                        choice_value: userChoice.value,
                        engine: 'gpt4'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // AI ÏùëÎãµÏóê ÌÜ§ Ï†ÅÏö©
                    const state = multiCharacterState.getState(currentCharacterId);
                    const mbti = character.mbti || 'INFP';
                    const tonedResponse = await applyToneToMessage(
                        currentCharacterId,
                        result.response,
                        state.affection,
                        mbti
                    );

                    const aiMsg = {
                        type: 'character',
                        text: tonedResponse,
                        timestamp: new Date().toISOString()
                    };

                    saveMessage(currentCharacterId, aiMsg);
                    displayMessage(aiMsg);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('AI ÏùëÎãµ ÏÉùÏÑ± Ïã§Ìå®:', error);
                // Ìè¥Î∞± ÏùëÎãµÏóêÎèÑ ÌÜ§ Ï†ÅÏö©
                const state = multiCharacterState.getState(currentCharacterId);
                const mbti = character.mbti || 'INFP';
                const baseFallback = getFallbackResponse(userChoice.value);
                const tonedFallback = await applyToneToMessage(
                    currentCharacterId,
                    baseFallback,
                    state.affection,
                    mbti
                );

                const fallbackMsg = {
                    type: 'character',
                    text: tonedFallback,
                    timestamp: new Date().toISOString()
                };

                saveMessage(currentCharacterId, fallbackMsg);
                displayMessage(fallbackMsg);
            }

            showTyping(false);
        }

        // Ìè¥Î∞± ÏùëÎãµ
        function getFallbackResponse(value) {
            const responses = {
                good: 'Í∑∏Î†áÍµ¨ÎÇò! Ï¢ãÏùÄ ÌïòÎ£® Î≥¥ÎÇ¥ÏÖ®Îã§Îãà Ï†ÄÎèÑ Í∏∞Î∂ÑÏù¥ Ï¢ãÏïÑÏöî üòä',
                normal: 'Í∑∏ÎûòÎèÑ Î¨¥ÏÇ¨Ìûà ÌïòÎ£® ÎßàÎ¨¥Î¶¨ÌïòÏÖ®ÎÑ§Ïöî! Í≥†ÏÉùÌïòÏÖ®Ïñ¥Ïöî~',
                tired: 'Ïò§Îäò ÎßéÏù¥ ÌûòÎìúÏÖ®ÎÇòÎ¥êÏöî„Ö†„Ö† Í¥úÏ∞ÆÏúºÏÑ∏Ïöî? Ìëπ Ïâ¨ÏÑ∏Ïöî!',
                text_input: 'Í∑∏Î†áÍµ∞Ïöî! Ïû¨ÎØ∏ÏûàÎäî ÏñòÍ∏∞ Îçî Îì§Î†§Ï£ºÏÑ∏Ïöî~'
            };
            
            return responses[value] || responses.text_input;
        }

        // Î©îÏãúÏßÄ Ï†ÄÏû•
        function saveMessage(characterId, message) {
            const key = `chat_${characterId}`;
            let chatData = {messages: [], unreadCount: 0};
            
            const saved = localStorage.getItem(key);
            if (saved) {
                chatData = JSON.parse(saved);
            }
            
            chatData.messages.push(message);
            localStorage.setItem(key, JSON.stringify(chatData));
        }

        // ÏùΩÏùå Ï≤òÎ¶¨
        function markAsRead(characterId) {
            const key = `chat_${characterId}`;
            const saved = localStorage.getItem(key);
            if (saved) {
                const chatData = JSON.parse(saved);
                chatData.unreadCount = 0;
                localStorage.setItem(key, JSON.stringify(chatData));
            }
        }

        // ÌÉÄÏù¥Ìïë ÌëúÏãú
        function showTyping(show) {
            const indicator = document.getElementById('typingIndicator');
            if (show) {
                indicator.classList.add('active');
            } else {
                indicator.classList.remove('active');
            }
        }

        // Î¶¨Ïä§Ìä∏Î°ú ÎèåÏïÑÍ∞ÄÍ∏∞
        function backToList() {
            // Ìä∏Î¶¨Í±∞ ÏóîÏßÑ Ï§ëÏßÄ
            stopTriggerEngine();

            document.getElementById('chatView').classList.remove('active');
            document.getElementById('chatListView').style.display = 'flex';
            renderChatRooms();
        }

        // Ïä§ÌÅ¨Î°§ ÌïòÎã®ÏúºÎ°ú
        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            container.scrollTop = container.scrollHeight;
        }

        // ÎîúÎ†àÏù¥
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ÏÇ¨ÏßÑ Ïó¥Í∏∞
        function openPhoto(url) {
            window.open(url, '_blank');
        }

        // Ìä∏Î¶¨Í±∞ ÏóîÏßÑ ÏãúÏûë
        function startTriggerEngine(characterId) {
            // Í∏∞Ï°¥ ÏóîÏßÑ Ï§ëÏßÄ
            stopTriggerEngine();

            // ÏÉà ÏóîÏßÑ ÏãúÏûë
            currentTriggerEngine = new EpisodeTriggerEngine(characterId);
            currentTriggerEngine.start();

            console.log('[Ï±ÑÌåÖ UI] Ìä∏Î¶¨Í±∞ ÏóîÏßÑ ÏãúÏûëÎê®');
        }

        // Ìä∏Î¶¨Í±∞ ÏóîÏßÑ Ï§ëÏßÄ
        function stopTriggerEngine() {
            if (currentTriggerEngine) {
                currentTriggerEngine.stop();
                currentTriggerEngine = null;
                console.log('[Ï±ÑÌåÖ UI] Ìä∏Î¶¨Í±∞ ÏóîÏßÑ Ï§ëÏßÄÎê®');
            }
        }

        // Ïú†Ï†Ä ÏùëÎãµ Ïãú ÌñâÎèô ÌîåÎûòÍ∑∏ Ï¥àÍ∏∞Ìôî
        function resetBehaviorFlagsOnUserMessage() {
            if (currentTriggerEngine && currentCharacterId) {
                currentTriggerEngine.resetBehaviorFlags();
            }
        }

        // Enter ÌÇ§Î°ú Ï†ÑÏÜ°
        document.getElementById('messageInput')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Ï¥àÍ∏∞Ìôî Ïã§Ìñâ
        init();
    </script>
</body>
</html>
