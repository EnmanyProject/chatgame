<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Episode Player Test - 에피소드 테스트</title>
  <link rel="stylesheet" href="css/episode-player.css">
</head>
<body>
  <!-- Player Container -->
  <div class="player-container">

    <!-- Header -->
    <div class="player-header">
      <div class="character-info">
        <img id="character-photo" src="/assets/default-avatar.png" alt="Character">
        <div>
          <h2 id="character-name">캐릭터 이름</h2>
          <span id="scenario-title">시나리오 제목</span>
        </div>
        <button class="menu-btn" onclick="showMenu()">⋮</button>
      </div>

      <div class="progress-info">
        <div class="affection-bar-container">
          <label>호감도: <span id="affection-value">0</span></label>
          <div class="affection-bar">
            <div class="affection-fill" id="affection-fill" style="width: 50%;"></div>
          </div>
        </div>
        <div class="progress-bar-container">
          <label>진행도: <span id="progress-percentage">0%</span></label>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill" style="width: 0%;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Messages Container -->
    <div class="messages-container" id="messages-container">
      <!-- Messages will be dynamically added here -->
    </div>

    <!-- Choices Container -->
    <div class="choices-container" id="choices-container">
      <!-- Choices will be dynamically added here -->
    </div>

    <!-- Footer -->
    <div class="player-footer">
      <button onclick="saveProgress()">💾 저장</button>
      <button onclick="restartScenario()">🔄 재시작</button>
      <button onclick="goToScenarioList()">📋 돌아가기</button>
    </div>

  </div>

  <!-- Loading Indicator -->
  <div id="loading-indicator" class="loading-indicator" style="display: none;">
    AI가 응답을 생성하는 중입니다
  </div>

  <!-- Complete Modal -->
  <div id="complete-modal" class="modal">
    <div class="modal-content">
      <h2>🎉 시나리오 완료!</h2>
      <div class="complete-stats">
        <p>최종 호감도: <strong id="final-affection">0</strong></p>
        <p>총 대화 수: <strong id="total-messages">0</strong></p>
        <p>플레이 시간: <strong id="play-time">0분</strong></p>
      </div>
      <div class="complete-actions">
        <button onclick="restartScenario()">다시 플레이</button>
        <button onclick="goToScenarioList()">돌아가기</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <!-- Episode System -->
  <script src="lib/episode-flow-manager.js"></script>
  <script src="js/episode-effects.js"></script>
  <script src="js/episode-player.js"></script>

  <!-- Initialize -->
  <script>
    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const scenarioId = urlParams.get('scenario');
    const characterId = urlParams.get('character');
    const model = urlParams.get('model') || 'claude'; // 'claude' or 'openai'

    // Load scenario and character from localStorage
    const testScenario = JSON.parse(localStorage.getItem('test-scenario'));
    const testCharacter = JSON.parse(localStorage.getItem('test-character'));

    // Auto-start episode when page loads
    window.addEventListener('DOMContentLoaded', () => {
      if (testScenario && testCharacter) {
        console.log('🎮 테스트 모드로 에피소드 시작:', model);
        console.log('시나리오:', testScenario);
        console.log('캐릭터:', testCharacter);

        // Display AI model info
        const modelInfo = model === 'claude' ? 'Claude 3.5 Sonnet' : 'OpenAI GPT-4 Turbo';
        const messagesContainer = document.getElementById('messages-container');
        const infoDiv = document.createElement('div');
        infoDiv.className = 'message-narration';
        infoDiv.textContent = `🤖 ${modelInfo} 모델로 테스트 중`;
        messagesContainer.appendChild(infoDiv);

        // Start episode with test data
        startEpisode(scenarioId, characterId, model);
      } else {
        alert('테스트 데이터를 찾을 수 없습니다. Scenario Builder에서 다시 시도해주세요.');
        window.close();
      }
    });

    // Override goToScenarioList to close test window
    function goToScenarioList() {
      if (confirm('테스트를 종료하고 Scenario Builder로 돌아가시겠습니까?')) {
        window.close();
      }
    }

    // Override restartScenario to reload test
    function restartScenario() {
      if (confirm('처음부터 다시 테스트하시겠습니까?')) {
        location.reload();
      }
    }
  </script>
</body>
</html>
