<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Episode Player Test - ì—í”¼ì†Œë“œ í…ŒìŠ¤íŠ¸</title>
  <link rel="stylesheet" href="css/episode-player.css">
</head>
<body>
  <!-- Player Container -->
  <div class="player-container">

    <!-- Header -->
    <div class="player-header">
      <div class="character-info">
        <img id="character-photo" src="/assets/default-avatar.png" alt="Character">
        <div>
          <h2 id="character-name">ìºë¦­í„° ì´ë¦„</h2>
          <span id="scenario-title">ì‹œë‚˜ë¦¬ì˜¤ ì œëª©</span>
        </div>
        <button class="menu-btn" onclick="showMenu()">â‹®</button>
      </div>

      <div class="progress-info">
        <div class="affection-bar-container">
          <label>í˜¸ê°ë„: <span id="affection-value">0</span></label>
          <div class="affection-bar">
            <div class="affection-fill" id="affection-fill" style="width: 50%;"></div>
          </div>
        </div>
        <div class="progress-bar-container">
          <label>ì§„í–‰ë„: <span id="progress-percentage">0%</span></label>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill" style="width: 0%;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Messages Container -->
    <div class="messages-container" id="messages-container">
      <!-- Messages will be dynamically added here -->
    </div>

    <!-- Choices Container -->
    <div class="choices-container" id="choices-container">
      <!-- Choices will be dynamically added here -->
    </div>

    <!-- Footer -->
    <div class="player-footer">
      <button onclick="saveProgress()">ğŸ’¾ ì €ì¥</button>
      <button onclick="restartScenario()">ğŸ”„ ì¬ì‹œì‘</button>
      <button onclick="goToScenarioList()">ğŸ“‹ ëŒì•„ê°€ê¸°</button>
    </div>

  </div>

  <!-- Loading Indicator -->
  <div id="loading-indicator" class="loading-indicator" style="display: none;">
    AIê°€ ì‘ë‹µì„ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤
  </div>

  <!-- Complete Modal -->
  <div id="complete-modal" class="modal">
    <div class="modal-content">
      <h2>ğŸ‰ ì‹œë‚˜ë¦¬ì˜¤ ì™„ë£Œ!</h2>
      <div class="complete-stats">
        <p>ìµœì¢… í˜¸ê°ë„: <strong id="final-affection">0</strong></p>
        <p>ì´ ëŒ€í™” ìˆ˜: <strong id="total-messages">0</strong></p>
        <p>í”Œë ˆì´ ì‹œê°„: <strong id="play-time">0ë¶„</strong></p>
      </div>
      <div class="complete-actions">
        <button onclick="restartScenario()">ë‹¤ì‹œ í”Œë ˆì´</button>
        <button onclick="goToScenarioList()">ëŒì•„ê°€ê¸°</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <!-- Episode System -->
  <script src="lib/episode-flow-manager.js"></script>
  <script src="js/episode-effects.js"></script>
  <script src="js/episode-player.js"></script>

  <!-- Initialize -->
  <script>
    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const scenarioId = urlParams.get('scenario');
    const characterId = urlParams.get('character');
    const model = urlParams.get('model') || 'claude'; // 'claude' or 'openai'

    // Load scenario and character from localStorage
    const testScenario = JSON.parse(localStorage.getItem('test-scenario'));
    const testCharacter = JSON.parse(localStorage.getItem('test-character'));

    // Auto-start episode when page loads
    window.addEventListener('DOMContentLoaded', () => {
      if (testScenario && testCharacter) {
        console.log('ğŸ® í…ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì—í”¼ì†Œë“œ ì‹œì‘:', model);
        console.log('ì‹œë‚˜ë¦¬ì˜¤:', testScenario);
        console.log('ìºë¦­í„°:', testCharacter);

        // Display AI model info
        const modelInfo = model === 'claude' ? 'Claude 3.5 Sonnet' : 'OpenAI GPT-4 Turbo';
        const messagesContainer = document.getElementById('messages-container');
        const infoDiv = document.createElement('div');
        infoDiv.className = 'message-narration';
        infoDiv.textContent = `ğŸ¤– ${modelInfo} ëª¨ë¸ë¡œ í…ŒìŠ¤íŠ¸ ì¤‘`;
        messagesContainer.appendChild(infoDiv);

        // Start episode with test data
        startEpisode(scenarioId, characterId, model);
      } else {
        alert('í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Scenario Builderì—ì„œ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        window.close();
      }
    });

    // Override goToScenarioList to close test window
    function goToScenarioList() {
      if (confirm('í…ŒìŠ¤íŠ¸ë¥¼ ì¢…ë£Œí•˜ê³  Scenario Builderë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        window.close();
      }
    }

    // Override restartScenario to reload test
    function restartScenario() {
      if (confirm('ì²˜ìŒë¶€í„° ë‹¤ì‹œ í…ŒìŠ¤íŠ¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        location.reload();
      }
    }
  </script>
</body>
</html>
